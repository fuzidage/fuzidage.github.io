<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>字符设备驱动-1-GPIO驱动LED示例 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 GPIO 寄存器的 2 种操作方法 2 GPIO 寄存器配置流程 2.1 CCM时钟设置 2.2 引脚模式电器属性设置 2.2.1 IOMUX功能 2.2.2 电器属性功能 2.2.2.1 GPIO驱动LED的4种方式   2.2.3 GPIO方向 2.2.4 GPIO值     3 字符设备驱动程序框架 3.1 实现通用性驱动模板 3.1.1 led_drv.c   3.2 具体单">
<meta property="og:type" content="article">
<meta property="og:title" content="字符设备驱动-1-GPIO驱动LED示例">
<meta property="og:url" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 GPIO 寄存器的 2 种操作方法 2 GPIO 寄存器配置流程 2.1 CCM时钟设置 2.2 引脚模式电器属性设置 2.2.1 IOMUX功能 2.2.2 电器属性功能 2.2.2.1 GPIO驱动LED的4种方式   2.2.3 GPIO方向 2.2.4 GPIO值     3 字符设备驱动程序框架 3.1 实现通用性驱动模板 3.1.1 led_drv.c   3.2 具体单">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/1.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/2.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/3.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/4.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/5.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/6.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/7.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/8.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/9.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/10.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/11.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/12.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/13.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/14.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/15.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/16.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/17.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/18.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/19.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/20.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/21.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/22.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/23.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/24.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/25.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/26.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/27.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/28.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/29.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/30.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/31.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/32.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/33.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/34.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/35.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/36.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/37.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/38.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/39.png">
<meta property="og:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/40.png">
<meta property="article:published_time" content="2024-07-23T16:21:50.000Z">
<meta property="article:modified_time" content="2024-07-27T08:36:11.198Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-字符设备驱动-1-GPIO驱动LED示例" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/" class="article-date">
  <time class="dt-published" datetime="2024-07-23T16:21:50.000Z" itemprop="datePublished">2024-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      字符设备驱动-1-GPIO驱动LED示例
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-gpio-ji-cun-qi-de-2-chong-cao-zuo-fang-fa">1 GPIO 寄存器的 2 种操作方法</a></li>
<li><a href="#2-gpio-ji-cun-qi-pei-zhi-liu-cheng">2 GPIO 寄存器配置流程</a><ul>
<li><a href="#2-1-ccm-shi-zhong-she-zhi">2.1 CCM时钟设置</a></li>
<li><a href="#2-2-yin-jiao-mo-shi-dian-qi-shu-xing-she-zhi">2.2 引脚模式电器属性设置</a><ul>
<li><a href="#2-2-1-iomux-gong-neng">2.2.1 IOMUX功能</a></li>
<li><a href="#2-2-2-dian-qi-shu-xing-gong-neng">2.2.2 电器属性功能</a><ul>
<li><a href="#2-2-2-1-gpio-qu-dong-led-de-4-chong-fang-shi">2.2.2.1 GPIO驱动LED的4种方式</a></li>
</ul>
</li>
<li><a href="#2-2-3-gpio-fang-xiang">2.2.3 GPIO方向</a></li>
<li><a href="#2-2-4-gpio-zhi">2.2.4 GPIO值</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-zi-fu-she-bei-qu-dong-cheng-xu-kuang-jia">3 字符设备驱动程序框架</a><ul>
<li><a href="#3-1-shi-xian-tong-yong-xing-qu-dong-mo-ban">3.1 实现通用性驱动模板</a><ul>
<li><a href="#3-1-1-led-drv-c">3.1.1 <code>led_drv.c</code></a></li>
</ul>
</li>
<li><a href="#3-2-ju-ti-dan-ban-led-qu-dong">3.2 具体单板led驱动</a><ul>
<li><a href="#3-2-1-led-opr-h">3.2.1 <code>led_opr.h</code></a></li>
<li><a href="#3-2-2-board-100ask-imx6ull-qemu-c-fen-xi">3.2.2 <code>board_100ask_imx6ull-qemu.c分析</code></a><ul>
<li><a href="#3-2-2-1-ccm-shi-zhong-pei-zhi">3.2.2.1 CCM时钟配置</a></li>
<li><a href="#3-2-2-2-iomux-cheng-gpio">3.2.2.2 IOMUX成gpio</a><ul>
<li><a href="#3-2-2-2-1-gpio5-3-jin-xing-iomux">3.2.2.2.1 gpio5_3 进行iomux</a></li>
<li><a href="#3-2-2-2-2-gpio1-3-gpio1-5-gpio1-6-jin-xing-iomux">3.2.2.2.2 gpio1_3&#x2F;gpio1_5&#x2F;gpio1_6 进行iomux</a></li>
</ul>
</li>
<li><a href="#3-2-2-3-gpio-pei-cheng-shu-chu">3.2.2.3 gpio配成输出</a></li>
<li><a href="#3-2-2-4-gpio-zhi-she-zhi">3.2.2.4 gpio值设置</a></li>
<li><a href="#3-2-2-5-board-100ask-imx6ull-qemu-c">3.2.2.5 <code>board_100ask_imx6ull-qemu.c</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-zi-fu-she-bei-qu-dong-ji-chu-gai-nian">4 字符设备驱动基础概念</a><ul>
<li><a href="#4-1-export-symbol">4.1 EXPORT_SYMBOL</a></li>
<li><a href="#4-2-module-info">4.2 MODULE_INFO</a></li>
<li><a href="#4-2-module-param">4.2 module_param</a><ul>
<li><a href="#4-2-1-type">4.2.1 type</a></li>
<li><a href="#4-2-2-perm">4.2.2 perm</a></li>
</ul>
</li>
<li><a href="#4-3-she-bei-jie-dian">4.3 设备节点</a><ul>
<li><a href="#4-3-1-shou-dong-jian-li-she-bei-jie-dian">4.3.1 手动建立设备节点</a></li>
<li><a href="#4-3-2-zi-dong-chuang-jian-she-bei-jie-dian">4.3.2 自动创建设备节点</a><ul>
<li><a href="#4-3-2-1-mdev-ji-zhi">4.3.2.1 mdev机制</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-4-she-zhi-wen-jian-si-you-shu-ju">4.4 设置文件私有数据</a></li>
<li><a href="#4-5-she-bei-hao">4.5 设备号</a><ul>
<li><a href="#4-5-1-jing-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao">4.5.1 静态分配和释放一个设备号</a></li>
<li><a href="#4-5-2-dong-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao">4.5.2 动态分配和释放一个设备号</a></li>
</ul>
</li>
<li><a href="#4-6-tian-jia-she-bei-he-lei">4.6 添加设备和类</a></li>
</ul>
</li>
<li><a href="#5-nei-he-yuan-ma-shu-tian-jia-yi-ge-zi-fu-she-bei-qu-dong">5 内核源码树添加一个字符设备驱动</a><ul>
<li><a href="#5-1-zhun-bei-qu-dong-yuan-ma">5.1 准备驱动源码</a></li>
<li><a href="#5-2-makefile">5.2 MakeFile</a></li>
<li><a href="#5-3-kconfig">5.3 Kconfig</a></li>
<li><a href="#5-4-xiu-gai-shang-yi-ji-makefile-he-kconfig">5.4 修改上一级Makefile和Kconfig</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<p>GPIO: <code>General-purpose input/output</code>，通用输入输出接口。下面以<code>IMX6ULL</code>芯片的GPIO寄存器来展开介绍。</p>
<h1><span id="1-gpio-ji-cun-qi-de-2-chong-cao-zuo-fang-fa">1 GPIO 寄存器的 2 种操作方法</span><a href="#1-gpio-ji-cun-qi-de-2-chong-cao-zuo-fang-fa" class="header-anchor">#</a></h1><ol>
<li><strong>直接读写</strong>：读出、修改对应位、写入。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">a) 要设置 bit n：</span><br><span class="line">　　val = data_reg;</span><br><span class="line">　　val = val | (<span class="number">1</span>&lt;&lt;n);</span><br><span class="line">　　data_reg = val;</span><br><span class="line">b) 要清除 bit n：</span><br><span class="line">　　val = data_reg;</span><br><span class="line">　　val = val &amp; ~(<span class="number">1</span>&lt;&lt;n);</span><br><span class="line">　　data_reg = val;</span><br></pre></td></tr></table></figure></li>
<li><strong>set-and-clear protocol</strong>：(芯片不一定支持）</li>
</ol>
<p>　　<code>set_reg, clr_reg, data_reg </code>三个寄存器对应的是同一个物理寄存器:</p>
<p>　　a) 要设置 bit n：<code>set_reg = (1&lt;&lt;n);</code></p>
<p>　　b) 要清除 bit n：<code>clr_reg = (1&lt;&lt;n);</code></p>
<h1><span id="2-gpio-ji-cun-qi-pei-zhi-liu-cheng">2 GPIO 寄存器配置流程</span><a href="#2-gpio-ji-cun-qi-pei-zhi-liu-cheng" class="header-anchor">#</a></h1><h2><span id="2-1-ccm-shi-zhong-she-zhi">2.1 CCM时钟设置</span><a href="#2-1-ccm-shi-zhong-she-zhi" class="header-anchor">#</a></h2><p>CCM寄存器为GPIO 模块提供时钟：</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/1.png" alt="img"></p>
<p>以IMX6ULL 芯片为列，<code>GPIOn </code>要用 <code>CCM_CCGRx</code> 寄存器中的 2 位来决定该组 GPIO 是否使能。将对应的<code>clk gating enable</code>。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/2.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>：该 GPIO 模块全程被关闭</span><br><span class="line"><span class="number">01</span>：该 GPIO 模块在 CPU run mode 情况下是使能的；在 WAIT 或 STOP 模式下，关闭</span><br><span class="line"><span class="number">10</span>：保留</span><br><span class="line"><span class="number">11</span>：该 GPIO 模块全程使能</span><br></pre></td></tr></table></figure>

<p>例如：用<code>CCM_CCGR0[bit31:30]</code>使能GPIO2 的时钟：</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/3.png" alt="img"></p>
<p>例如：用<code>CCM_CCGR1[bit31:30]</code>使能GPIO5 的时钟:</p>
<p>例如：用<code>CCM_CCGR1[bit27:26]</code>使能GPIO1 的时钟:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/4.png" alt="img"></p>
<p>例如：用<code>CCM_CCGR2[bit27:26]</code>使能GPIO3的时钟:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/5.png" alt="img"></p>
<p>例如：用<code>CCM_CCGR3[bit13:12]</code>使能GPIO4的时钟:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/6.png" alt="img"></p>
<h2><span id="2-2-yin-jiao-mo-shi-dian-qi-shu-xing-she-zhi">2.2 引脚模式电器属性设置</span><a href="#2-2-yin-jiao-mo-shi-dian-qi-shu-xing-she-zhi" class="header-anchor">#</a></h2><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/7.png" alt="img"></p>
<p><code>MUX seting</code>用来配置pin的模式，比如GPIO。<code>Pad setting</code>用来设置GPIO的电器属性，比如电平，上下拉情况。</p>
<p>对于某个&#x2F;某组引脚，<code>IOMUXC </code>中有 2 个寄存器用来设置它：</p>
<h3><span id="2-2-1-iomux-gong-neng">2.2.1 IOMUX功能</span><a href="#2-2-1-iomux-gong-neng" class="header-anchor">#</a></h3><pre><code> a) `IOMUXC_SW_MUX_CTL_PAD_ &lt;PAD_NAME&gt;`：`Mux pad xxx`，选择某个引脚的功能
</code></pre>
<p> 　b) <code>IOMUXC_SW_MUX_CTL_GRP_&lt;GROUP_NAME&gt;</code>：<code>Mux grp xxx</code>，选择某组引脚的功能</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/8.png" alt="img"></p>
<p>某个引脚，或是某组预设的引脚，都有 8 个可选的模式(<code>alternate (ALT) MUX_MODE</code>)，设成<code>ALT5</code>表示选择GPIO。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/9.png" alt="img"></p>
<h3><span id="2-2-2-dian-qi-shu-xing-gong-neng">2.2.2 电器属性功能</span><a href="#2-2-2-dian-qi-shu-xing-gong-neng" class="header-anchor">#</a></h3><p>a) <code>IOMUXC_SW_PAD_CTL_PAD_&lt;PAD_NAME</code>&gt;：<code>pad pad xxx</code>，设置某个引脚的电器属性</p>
<p>b) <code>IOMUXC_SW_PAD_CTL_GRP_&lt;GROUP_NAME&gt;</code>：<code>pad grp xxx</code>，设 置某组引脚的电器属性</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/10.png" alt="img"></p>
<p>pad参数有很多不只是上下拉，还有很多属性如IO驱动能力。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/11.png" alt="img"></p>
<h4><span id="2-2-2-1-gpio-qu-dong-led-de-4-chong-fang-shi">2.2.2.1 GPIO驱动LED的4种方式</span><a href="#2-2-2-1-gpio-qu-dong-led-de-4-chong-fang-shi" class="header-anchor">#</a></h4><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/12.png" alt="img"></p>
<p>① 使用引脚输出 3.3V 点亮 LED，输出 0V 熄灭 LED。</p>
<p>② 使用引脚拉低到 0V 点亮 LED，输出 3.3V 熄灭 LED。</p>
<p>③有的芯片为了省电等原因，其引脚驱动能力不足，这时可以使用三极管驱动。 使用引脚输出 1.2V 点亮 LED，输出 0V 熄灭 LED。</p>
<p>④使用引脚输出 0V 点亮 LED，输出 1.2V 熄灭 LED</p>
<h3><span id="2-2-3-gpio-fang-xiang">2.2.3 GPIO方向</span><a href="#2-2-3-gpio-fang-xiang" class="header-anchor">#</a></h3><p>当iomux成gpio模式后，就需要配置成gpio输出。</p>
<p><code>GPIOx_GDIR</code>：设置引脚方向，每位对应一个引脚，<code>1-output</code>，<code>0-input</code>.</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/13.png" alt="img"></p>
<p>确定每组gpio基地址如下：加4就对应方向寄存器。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/14.png" alt="img"></p>
<h3><span id="2-2-4-gpio-zhi">2.2.4 GPIO值</span><a href="#2-2-4-gpio-zhi" class="header-anchor">#</a></h3><p><code>GPIOx_DR</code>：(<code>GPIOx的data register</code>)。设置输出引脚的电平，每位对应一个引脚，1-高电平，0-低电平。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/15.png" alt="img"></p>
<p>如果是配成了输入引脚，<code>GPIOx_PSR</code>：读取引脚的电平，每位对应一个引脚，1-高电平，0-低电平:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/16.png" alt="img"></p>
<h1><span id="3-zi-fu-she-bei-qu-dong-cheng-xu-kuang-jia">3 字符设备驱动程序框架</span><a href="#3-zi-fu-she-bei-qu-dong-cheng-xu-kuang-jia" class="header-anchor">#</a></h1><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/17.png" alt="img"></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/18.png" alt="img"></p>
<p>字符驱动编写流程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. 确定主设备号，也可以让内核动态分配.</span></span><br><span class="line"><span class="comment">2. 定义自己的 file_operations 结构体 实现对应的 drv_open/drv_read/drv_write 等函数</span></span><br><span class="line"><span class="comment">填入 file_operations 结构体，把 file_operations 结构体告诉内核。</span></span><br><span class="line"><span class="comment">3. register_chrdev/unregister_chrdev</span></span><br><span class="line"><span class="comment">4. 其他完善：提供设备信息，自动创建设备节点：class_create, device_create</span></span><br><span class="line"><span class="comment">5. 操作硬件：通过 ioremap 映射寄存器的物理地址得到虚拟地址，读写虚拟地址</span></span><br><span class="line"><span class="comment">6. 驱动怎么和 APP 传输数据：通过 copy_to_user、copy_from_user 等操作函数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">if</span> (newchrled.major) &#123; <span class="comment">/* 定义了设备号，静态分配 */</span> </span><br><span class="line">    newchrled.devid = MKDEV(newchrled.major, <span class="number">0</span>); </span><br><span class="line">    register_chrdev_region(newchrled.devid, NEWCHRLED_CNT, NEWCHRLED_NAME); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">/* 没有定义设备号，动态分配 */</span> </span><br><span class="line">    alloc_chrdev_region(&amp;newchrled.devid, <span class="number">0</span>, NEWCHRLED_CNT, NEWCHRLED_NAME); <span class="comment">/* 申请设备号 */</span> </span><br><span class="line">    newchrled.major = MAJOR(newchrled.devid); <span class="comment">/* 获取主设备号 */</span> </span><br><span class="line">    newchrled.minor = MINOR(newchrled.devid); <span class="comment">/* 获取次设备号 */</span> </span><br><span class="line">&#125; </span><br><span class="line">printk(<span class="string">&quot;newcheled major=%d,minor=%d\r\n&quot;</span>,newchrled.major, newchrled.minor); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 2、初始化cdev */</span> </span><br><span class="line">newchrled.cdev.owner = THIS_MODULE; </span><br><span class="line">cdev_init(&amp;newchrled.cdev, &amp;newchrled_fops); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3、添加一个cdev */</span> </span><br><span class="line">cdev_add(&amp;newchrled.cdev, newchrled.devid, NEWCHRLED_CNT); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4、创建类 */</span> </span><br><span class="line">newchrled.class = class_create(THIS_MODULE, NEWCHRLED_NAME); </span><br><span class="line"><span class="keyword">if</span> (IS_ERR(newchrled.class)) </span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(newchrled.class); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5、创建设备 */</span></span><br><span class="line">newchrled.device = device_create(newchrled.class, <span class="literal">NULL</span>, newchrled.devid, <span class="literal">NULL</span>, NEWCHRLED_NAME);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(newchrled.device))</span><br><span class="line">    <span class="keyword">return</span> PTR_ERR(newchrled.device);</span><br></pre></td></tr></table></figure>

<h2><span id="3-1-shi-xian-tong-yong-xing-qu-dong-mo-ban">3.1 实现通用性驱动模板</span><a href="#3-1-shi-xian-tong-yong-xing-qu-dong-mo-ban" class="header-anchor">#</a></h2><h3><span id="3-1-1-led-drv-c">3.1.1 <code>led_drv.c</code></span><a href="#3-1-1-led-drv-c" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/major.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kmod.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gfp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led_opr.h&quot;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="comment">/* 确定主设备号 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">led_class</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">led_operations</span> *<span class="title">p_led_opr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN(a, b) (a &lt; b ? a : b)</span></span><br><span class="line"><span class="comment">/* 实现对应的open/read/write等函数，填入file_operations结构体 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_drv_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* write(fd, &amp;val, 1); */</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_drv_write</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        <span class="type">char</span> status;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> =</span> file_inode(file);</span><br><span class="line">        <span class="type">int</span> minor = iminor(inode);</span><br><span class="line"> </span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        err = copy_from_user(&amp;status, buf, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">/* 根据次设备号和status控制LED */</span></span><br><span class="line">        p_led_opr-&gt;ctl(minor, status);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_drv_open</span><span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> minor = iminor(node);</span><br><span class="line">         </span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="comment">/* 根据次设备号初始化LED */</span></span><br><span class="line">        p_led_opr-&gt;init(minor);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_drv_close</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span></span><br><span class="line">&#123;</span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* 定义自己的file_operations结构体  */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">led_drv</span> =</span> &#123;</span><br><span class="line">        .owner         = THIS_MODULE,</span><br><span class="line">        .open    = led_drv_open,</span><br><span class="line">        .read    = led_drv_read,</span><br><span class="line">        .write   = led_drv_write,</span><br><span class="line">        .release = led_drv_close,</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* 把file_operations结构体告诉内核：注册驱动程序  */</span></span><br><span class="line"><span class="comment">/* 入口函数：安装驱动程序时，就会去调用这个入口函数 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> err;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">         </span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        major = register_chrdev(<span class="number">0</span>, <span class="string">&quot;100ask_led&quot;</span>, &amp;led_drv);</span><br><span class="line">        led_class = class_create(THIS_MODULE, <span class="string">&quot;100ask_led_class&quot;</span>);</span><br><span class="line">        err = PTR_ERR(led_class);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(led_class)) &#123;</span><br><span class="line">                printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">                unregister_chrdev(major, <span class="string">&quot;led&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p_led_opr = get_board_led_opr();</span><br><span class="line">        <span class="comment">/* creat device node, eg: /dev/100ask_led0,1,... */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; p_led_opr-&gt;num; i++)</span><br><span class="line">                device_create(led_class, <span class="literal">NULL</span>, MKDEV(major, i), <span class="literal">NULL</span>, <span class="string">&quot;100ask_led%d&quot;</span>, i); </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 有入口函数就应该有出口函数：卸载驱动程序时，就会去调用这个出口函数 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">  </span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; p_led_opr-&gt;num; i++)</span><br><span class="line">                device_destroy(led_class, MKDEV(major, i)); <span class="comment">/* /dev/100ask_led0,1,... */</span></span><br><span class="line">        class_destroy(led_class);</span><br><span class="line">        unregister_chrdev(major, <span class="string">&quot;100ask_led&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

<ol>
<li><code>register_chrdev</code>， 如果传入主设备号，则静态注册，传入0则动态注册返回主设备号。</li>
<li><code>class_create</code>创建类<code>/sys/class/100ask_led_class</code>。</li>
<li><code>get_board_led_opr</code>获取具体单板的操作operation函数,后面具体单板实现。</li>
<li>获取到具体单板的led数量后，<code>device_create</code>为每一个led灯都建立设备节点。</li>
</ol>
<p>再来看<code>file_operations中</code>的操作：</p>
<ol>
<li><code>led_drv_open</code>根据次设备号，调用具体单板的<code>init</code>函数，比如gpio 引脚复用，电器属性设置等。</li>
<li><code>led_drv_write</code>就可以根据次设备号, 控制具体单板的led引脚，设置高低电平，从而控制亮灭。</li>
</ol>
<h2><span id="3-2-ju-ti-dan-ban-led-qu-dong">3.2 具体单板led驱动</span><a href="#3-2-ju-ti-dan-ban-led-qu-dong" class="header-anchor">#</a></h2><h3><span id="3-2-1-led-opr-h">3.2.1 <code>led_opr.h</code></span><a href="#3-2-1-led-opr-h" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _LED_OPR_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _LED_OPR_H</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">led_operations</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        <span class="type">int</span> (*init) (<span class="type">int</span> which); <span class="comment">/* 初始化LED, which-哪个LED */</span>       </span><br><span class="line">        <span class="type">int</span> (*ctl) (<span class="type">int</span> which, <span class="type">char</span> status); <span class="comment">/* 控制LED, which-哪个LED, status:1-亮,0-灭 */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> led_operations *<span class="title function_">get_board_led_opr</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>定义一个<code>led_operations</code>，<code>num</code>表示有几个led, <code> init</code>表示初始化led(<code>drv_open</code>的时候调用，配置<code>pinmux</code>，<code>io mode</code>, <code>enable pin clk</code>等)。</p>
<h3><span id="3-2-2-board-100ask-imx6ull-qemu-c-fen-xi">3.2.2 <code>board_100ask_imx6ull-qemu.c分析</code></span><a href="#3-2-2-board-100ask-imx6ull-qemu-c-fen-xi" class="header-anchor">#</a></h3><p>现在有一块<code>board_100ask_imx6ull-qemu</code>板子有4个LED，占2组GPIO，分别是<code>GPIO5_3</code>和<code>GPIO1_3, GPIO1_5, GPIO1_6</code>。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/19.png" alt="img"></p>
<h4><span id="3-2-2-1-ccm-shi-zhong-pei-zhi">3.2.2.1 CCM时钟配置</span><a href="#3-2-2-1-ccm-shi-zhong-pei-zhi" class="header-anchor">#</a></h4><p>寄存器配置参考2.1。使能时钟gpio5和gpio1的时钟，<code>CCM_CCGR1[CG13]</code>和<code>CCM_CCGR1[CG15]</code>配置成0x11。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1. enable GPIO1</span></span><br><span class="line"><span class="comment"> * CG13, b[27:26] = 0b11 */</span></span><br><span class="line"> </span><br><span class="line">*CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">26</span>);</span><br><span class="line">       </span><br><span class="line"><span class="comment">/* 1. enable GPIO5</span></span><br><span class="line"><span class="comment"> * CG15, b[31:30] = 0b11 */</span></span><br><span class="line"> *CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">30</span>);</span><br></pre></td></tr></table></figure>

<h4><span id="3-2-2-2-iomux-cheng-gpio">3.2.2.2 IOMUX成gpio</span><a href="#3-2-2-2-iomux-cheng-gpio" class="header-anchor">#</a></h4><p>iomux配置4个引脚复用成gpio功能。</p>
<h5><span id="3-2-2-2-1-gpio5-3-jin-xing-iomux">3.2.2.2.1 gpio5_3 进行iomux</span><a href="#3-2-2-2-1-gpio5-3-jin-xing-iomux" class="header-anchor">#</a></h5><p>基地址为<code>0x2290014</code>。用ioremap进行映射到虚拟地址，就可以直接操作寄存器地址了。但是一般建议用<code>writel, writeb</code>等函数族。配成5表示gpio模式。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/20.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IOMUXC_SNVS_SW_MUX_CTL_PAD_SNVS_TAMPER3=ioremap(<span class="number">0x2290014</span>, <span class="number">4</span>);        </span><br><span class="line"><span class="comment">/* 2. set GPIO5_IO03 as GPIO</span></span><br><span class="line"><span class="comment"> * MUX_MODE, b[3:0] = 0b101 */</span></span><br><span class="line"></span><br><span class="line">*IOMUXC_SNVS_SW_MUX_CTL_PAD_SNVS_TAMPER3 = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h5><span id="3-2-2-2-2-gpio1-3-x2f-gpio1-5-x2f-gpio1-6-jin-xing-iomux">3.2.2.2.2 gpio1_3&#x2F;gpio1_5&#x2F;gpio1_6 进行iomux</span><a href="#3-2-2-2-2-gpio1-3-x2f-gpio1-5-x2f-gpio1-6-jin-xing-iomux" class="header-anchor">#</a></h5><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/21.png" alt="img"></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/22.png" alt="img"></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/23.png" alt="img"></p>
<p>每次映射4个字节太繁琐，干脆对整个gpio的iomux地址进行映射。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iomux</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> unnames[<span class="number">23</span>];</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO00;  <span class="comment">/* offset 0x5c*/</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO01;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO02;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO04;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO05;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO06;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO07;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO08;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO09;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">iomux = ioremap(<span class="number">0x20e0000</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iomux));</span><br></pre></td></tr></table></figure>

<p>这里偷懒用了一个技巧，<code>unnames[23] </code>占<code>92(0x5c)</code>字节,刚好<code>IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO00</code>地址就是<code>0x20e0000+0x5c</code>，就不用把所有寄存器都搬进来到<code>struct iomux</code>。</p>
<p>同理<code>IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03</code>地址就是<code>0x20e0000+0x68</code>, 因此：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* MUX_MODE, b[3:0] = 0b101 */</span></span><br><span class="line">iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03 = <span class="number">5</span>;</span><br><span class="line">iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO05 = <span class="number">5</span>;</span><br><span class="line">iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO06 = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<h4><span id="3-2-2-3-gpio-pei-cheng-shu-chu">3.2.2.3 gpio配成输出</span><a href="#3-2-2-3-gpio-pei-cheng-shu-chu" class="header-anchor">#</a></h4><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/24.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx6ull_gpio</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> dr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> gdir;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> psr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> icr1;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> icr2;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> imr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> isr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> edge_sel;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* GPIO1 GDIR, b[5] = 0b1*/</span></span><br><span class="line"> gpio1 = ioremap(<span class="number">0x209C000</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> imx6ull_gpio));</span><br><span class="line"> gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line"> gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line"> gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br></pre></td></tr></table></figure>

<p>offset为0表示data register, offset为4表示方向寄存器。以<code>gpio1_3/gpio1_5/gpio1_6</code>举例，<code>gdir</code>的<code>bit_n</code>置1就表示哪个gpio配成输出。</p>
<h4><span id="3-2-2-4-gpio-zhi-she-zhi">3.2.2.4 gpio值设置</span><a href="#3-2-2-4-gpio-zhi-she-zhi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (which == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status)  <span class="comment">/* on : output 0 */</span></span><br><span class="line">        gpio5-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">else</span>         <span class="comment">/* on : output 1 */</span></span><br><span class="line">        gpio5-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status)  <span class="comment">/* on : output 0 */</span></span><br><span class="line">        gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">else</span>         <span class="comment">/* on : output 1 */</span></span><br><span class="line">        gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status)  <span class="comment">/* on : output 0 */</span></span><br><span class="line">        gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">else</span>         <span class="comment">/* on : output 1 */</span></span><br><span class="line">        gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (status)  <span class="comment">/* on : output 0 */</span></span><br><span class="line">        gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line">    <span class="keyword">else</span>         <span class="comment">/* on : output 1 */</span></span><br><span class="line">        gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理<code>dr</code>就表示数据寄存器。一共4个led：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">which等于0表示gpio5_3</span><br><span class="line">which等于1示gpio1_3</span><br><span class="line">which等于2示gpio1_5</span><br><span class="line">which等于3示gpio1_6</span><br></pre></td></tr></table></figure>

<h4><span id="3-2-2-5-board-100ask-imx6ull-qemu-c">3.2.2.5 <code>board_100ask_imx6ull-qemu.c</code></span><a href="#3-2-2-5-board-100ask-imx6ull-qemu-c" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/major.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kmod.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gfp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;led_opr.h&quot;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iomux</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> unnames[<span class="number">23</span>];</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO00;  <span class="comment">/* offset 0x5c*/</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO01;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO02;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO04;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO05;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO06;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO07;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO08;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO09;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">imx6ull_gpio</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> dr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> gdir;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> psr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> icr1;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> icr2;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> imr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> isr;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> edge_sel;</span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/* enable GPIO1,GPIO5 */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *CCM_CCGR1;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">volatile</span> <span class="type">unsigned</span> <span class="type">int</span> *IOMUXC_SNVS_SW_MUX_CTL_PAD_SNVS_TAMPER3;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">iomux</span> *<span class="title">iomux</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">imx6ull_gpio</span> *<span class="title">gpio1</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">imx6ull_gpio</span> *<span class="title">gpio5</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">led_operations</span> <span class="title">board_demo_led_opr</span> =</span> &#123;</span><br><span class="line">    .num  = <span class="number">4</span>,</span><br><span class="line">    .init = board_demo_led_init,</span><br><span class="line">    .ctl  = board_demo_led_ctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">board_demo_led_init</span><span class="params">(<span class="type">int</span> which)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!CCM_CCGR1) &#123;</span><br><span class="line">        CCM_CCGR1 = ioremap(<span class="number">0x20C406C</span>, <span class="number">4</span>);</span><br><span class="line">        IOMUXC_SNVS_SW_MUX_CTL_PAD_SNVS_TAMPER3 = ioremap(<span class="number">0x2290014</span>, <span class="number">4</span>);</span><br><span class="line">        iomux = ioremap(<span class="number">0x20e0000</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> iomux));</span><br><span class="line">        gpio1 = ioremap(<span class="number">0x209C000</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> imx6ull_gpio));</span><br><span class="line">        gpio5 = ioremap(<span class="number">0x20AC000</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> imx6ull_gpio));</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (which == <span class="number">0</span>) &#123;</span><br><span class="line">        *CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">30</span>);</span><br><span class="line">        *IOMUXC_SNVS_SW_MUX_CTL_PAD_SNVS_TAMPER3 = <span class="number">5</span>;</span><br><span class="line">        gpio5-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(which == <span class="number">1</span>) &#123;</span><br><span class="line">        *CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">26</span>);</span><br><span class="line">        iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO03 = <span class="number">5</span>;</span><br><span class="line">        gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(which == <span class="number">2</span>) &#123;</span><br><span class="line">        *CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">26</span>);</span><br><span class="line">        iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO05 = <span class="number">5</span>;</span><br><span class="line">        gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(which == <span class="number">3</span>) &#123;</span><br><span class="line">        *CCM_CCGR1 |= (<span class="number">3</span>&lt;&lt;<span class="number">26</span>);</span><br><span class="line">        iomux-&gt;IOMUXC_SW_MUX_CTL_PAD_GPIO1_IO06 = <span class="number">5</span>;</span><br><span class="line">        gpio1-&gt;gdir |= (<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">board_demo_led_ctl</span><span class="params">(<span class="type">int</span> which, <span class="type">char</span> status)</span> <span class="comment">/* 控制LED, which-哪个LED, status:1-亮,0-灭 */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (which == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status)</span><br><span class="line">            gpio5-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            gpio5-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status)</span><br><span class="line">            gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status)</span><br><span class="line">            gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (which == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (status)</span><br><span class="line">            gpio1-&gt;dr &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            gpio1-&gt;dr |= (<span class="number">1</span>&lt;&lt;<span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> led_operations *<span class="title function_">get_board_led_opr</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;board_demo_led_opr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>open的时候调用<code>get_board_led_opr</code>得到具体单板的操作函数集。进一步调用<code>board_demo_led_init</code>初始化led。</p>
<p>write的时候调用具体单板的操作函数集，进一步调用<code>board_demo_led_ctl</code>操控led。</p>
<h1><span id="4-zi-fu-she-bei-qu-dong-ji-chu-gai-nian">4 字符设备驱动基础概念</span><a href="#4-zi-fu-she-bei-qu-dong-ji-chu-gai-nian" class="header-anchor">#</a></h1><h2><span id="4-1-export-symbol">4.1 EXPORT_SYMBOL</span><a href="#4-1-export-symbol" class="header-anchor">#</a></h2><p><code>EXPORT_SYMBOL</code>:导出函数，让别的module也能使用。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/25.png" alt="image-20240725202519779"></p>
<p><code>EXPORT_SYMBOL_GPL</code>:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/26.png" alt="image-20240725211903017"></p>
<h2><span id="4-2-module-info">4.2 MODULE_INFO</span><a href="#4-2-module-info" class="header-anchor">#</a></h2><p><code>MODULE_INFO(intree, &quot;Y&quot;);</code>的作用是将可加载内核模块标记为<code> in-tree</code>。</p>
<p>加载树外 LKM 会导致内核打印警告:这是从<code>module.c</code>中的检查引起的:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/27.png" alt="img"></p>
<p><code>module: loading out-of-tree module taints kernel.</code></p>
<h2><span id="4-2-module-param">4.2 module_param</span><a href="#4-2-module-param" class="header-anchor">#</a></h2><p><code>module_param(name,type,perm);</code></p>
<p>功能：指定模块参数，用于在加载模块时或者模块加载以后传递参数给模块。</p>
<p><code>module_param_array( name, type, nump, perm);</code></p>
<p>可用sysfs进行查看修改：</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/28.png" alt="img"></p>
<p>讲到<code>module_param</code>,把其他的也一笔带入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Freescale PM rpmsg driver&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Anson Huang &lt;Anson.Huang@nxp.com&gt;&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_VERSION(<span class="string">&quot;v2.0&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3><span id="4-2-1-type">4.2.1 type</span><a href="#4-2-1-type" class="header-anchor">#</a></h3><p>type: 数据类型:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bool : 布尔型</span><br><span class="line">   inbool : 布尔反值</span><br><span class="line">   charp: 字符指针（相当于char *,不超过1024字节的字符串）</span><br><span class="line">   short: 短整型</span><br><span class="line">   ushort : 无符号短整型</span><br><span class="line">   int : 整型</span><br><span class="line">   uint : 无符号整型</span><br><span class="line">   long : 长整型</span><br><span class="line">   ulong: 无符号长整型</span><br></pre></td></tr></table></figure>

<h3><span id="4-2-2-perm">4.2.2 perm</span><a href="#4-2-2-perm" class="header-anchor">#</a></h3><p>perm表示此参数在sysfs文件系统中所对应的文件节点的属性，其权限在<code>include/linux/stat.h</code>中有定义:</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/29.png" alt="image-20240725205237500"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRUSR 00400 <span class="comment">//文件所有者可读</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWUSR 00200 <span class="comment">//文件所有者可写</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXUSR 00100 <span class="comment">//文件所有者可执行</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IRGRP 00040 <span class="comment">//与文件所有者同组的用户可读</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWGRP 00020</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXGRP 00010</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IROTH 00004 <span class="comment">//与文件所有者不同组的用户可读</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IWOTH 00002</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> S_IXOTH 00001</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/30.png" alt="image-20240725205907528"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *alg = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> u32 type;</span><br><span class="line"><span class="type">static</span> u32 mask;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> mode;</span><br><span class="line"></span><br><span class="line">module_param(alg, charp, <span class="number">0</span>);</span><br><span class="line">module_param(type, uint, <span class="number">0</span>);</span><br><span class="line">module_param(mask, uint, <span class="number">0</span>);</span><br><span class="line">module_param(mode, <span class="type">int</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> fish[<span class="number">10</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> nr_fish;</span><br><span class="line">module_param_array(fish, <span class="type">int</span>, &amp;nr_fish, <span class="number">0664</span>);</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> media[<span class="number">8</span>];</span><br><span class="line">module_param_string(media, media, <span class="keyword">sizeof</span>(media), <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>可以用sysfs设置<code>fish</code>数组，或者insmod时伴随设置。</p>
<h2><span id="4-3-she-bei-jie-dian">4.3 设备节点</span><a href="#4-3-she-bei-jie-dian" class="header-anchor">#</a></h2><p><code>cat /proc/devices</code></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/31.png" alt="img"></p>
<h3><span id="4-3-1-shou-dong-jian-li-she-bei-jie-dian">4.3.1 手动建立设备节点</span><a href="#4-3-1-shou-dong-jian-li-she-bei-jie-dian" class="header-anchor">#</a></h3><p>手动建立设备节点命令是<code>mknod</code>, 由于这里的字符设备都是用的misc杂项设备方式，因此主设备号都为10：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">/mnt/Athena2_FPGA_SDK_Veriry/demo/workspace/ko <span class="comment"># ls -l /dev/mmcblk0p1</span></span><br><span class="line">brw-rw----    1 root     root      179,   1 Jan  1 00:05 /dev/mmcblk0p1</span><br><span class="line">/mnt/Athena2_FPGA_SDK_Veriry/demo/workspace/ko <span class="comment"># ls -l /dev/mmcblk0</span></span><br><span class="line">brw-rw----    1 root     root      179,   0 Jan  1 00:05 /dev/mmcblk0</span><br><span class="line"></span><br><span class="line">/dev <span class="comment"># ls -l cvi-*</span></span><br><span class="line">crw-rw----    1 root     root       10,   0 Jan  1 00:05 /dev/cvi-base</span><br><span class="line">crw-rw----    1 root     root       10,  61 Jan  1 00:05 /dev/cvi-dwa</span><br><span class="line">crw-rw----    1 root     root       10,  58 Jan  1 00:30 /dev/cvi-ldc</span><br><span class="line">crw-rw----    1 root     root       10,  60 Jan  1 00:04 /dev/cvi-stitch</span><br><span class="line">crw-rw----    1 root     root       10,  62 Jan  1 00:05 /dev/cvi-sys</span><br><span class="line">crw-rw----    1 root     root       10,  59 Jan  1 00:04 /dev/cvi-vpss</span><br><span class="line"></span><br><span class="line"><span class="built_in">mknod</span> /dev/mmcblk0 b 179 0</span><br><span class="line"><span class="built_in">mknod</span> /dev/mmcblk0p1 b 179 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-base c 10 0</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-sys c 10 62</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-dwa c 10 61</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-ldc c 10 58</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-stitch c 10 60</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-vpss c 10 59</span><br><span class="line">crw-rw---- 1 root root 10, 0 Jan 1 00:08 /dev/cvi-base</span><br><span class="line">crw-rw---- 1 root root 10, 61 Jan 1 00:08 /dev/cvi-dwa</span><br><span class="line">crw-rw---- 1 root root 10, 59 Jan 1 00:07 /dev/cvi-ldc</span><br><span class="line">crw-rw---- 1 root root 10, 60 Jan 1 00:07 /dev/cvi-stitch</span><br><span class="line">crw-rw---- 1 root root 10, 62 Jan 1 00:08 /dev/cvi-sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-base c 10 0</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-sys c 10 62</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-dwa c 10 61</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-ldc c 10 59</span><br><span class="line"><span class="built_in">mknod</span> /dev/cvi-stitch c 10 60</span><br></pre></td></tr></table></figure>

<h3><span id="4-3-2-zi-dong-chuang-jian-she-bei-jie-dian">4.3.2 自动创建设备节点</span><a href="#4-3-2-zi-dong-chuang-jian-she-bei-jie-dian" class="header-anchor">#</a></h3><h4><span id="4-3-2-1-mdev-ji-zhi">4.3.2.1 mdev机制</span><a href="#4-3-2-1-mdev-ji-zhi" class="header-anchor">#</a></h4><p><code>udev</code>是一个用户程序，在 Linux下通过 <code>udev</code>来实现设备文件的创建与删除， <code>udev</code>可以检测系统中硬件设备状态，可以根据系统中硬件设备状态来创建或者删除设备文件。比如使用<code>modprobe</code>命令成功加载驱动模块以后就自动在<code> /dev目录</code>下创建对应的设备节点文件 ,使用<code>rmmod</code>命令卸载驱动模块以后就 删除掉<code> /dev目录</code>下的设备节点文件。 使用<code> busybox</code>构建根文件系统的时候， busybox会创建一个 <code>udev</code>的简化版本<code> mdev</code>，所以在嵌入式 Linux中我们使用<code>mdev</code>来实现设备节点文件的自动创建与删除， Linux系统中的热插拔事件也由 <code>mdev</code>管理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo /sbin/mdev &gt; /proc/sys/kernel/hotplug</span><br></pre></td></tr></table></figure>

<h2><span id="4-4-she-zhi-wen-jian-si-you-shu-ju">4.4 设置文件私有数据</span><a href="#4-4-she-zhi-wen-jian-si-you-shu-ju" class="header-anchor">#</a></h2><p>一般<code>open</code>函数里面设置好私有数据以后，在<code> write、 read、 close</code>等函数中直接读取<code> private_data</code>即可得到设备结构体。</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/32.png" alt="img"></p>
<h2><span id="4-5-she-bei-hao">4.5 设备号</span><a href="#4-5-she-bei-hao" class="header-anchor">#</a></h2><p><code>include\linux\kdev_t.h</code></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/33.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MINORBITS 表示次设备号位数，一共是 20 位;</span><br><span class="line">MINORMASK 表示次设备号掩码;</span><br><span class="line">MAJOR 用于从 dev_t 中获取主设备号，将 dev_t 右移 20 位即可</span><br><span class="line">MINOR 用于从 dev_t 中获取次设备号，取 dev_t 的低 20 位的值即可</span><br><span class="line">MKDEV 用于将给定的主设备号和次设备号的值组合成 dev_t 类型的设备号</span><br></pre></td></tr></table></figure>

<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/34.png" alt="img"></p>
<p>定义了major主设备就用静态注册，否则动态分配设备号注册字符设备。</p>
<h3><span id="4-5-1-jing-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao">4.5.1 静态分配和释放一个设备号</span><a href="#4-5-1-jing-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line">register_chrdev_region()</span><br><span class="line">unregister_chrdev_region()</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_MAJOR_NUM 202 <span class="comment">//主设备号</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_dev_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = my_dev_open,</span><br><span class="line">    .release = my_dev_close,</span><br><span class="line">    .unlocked_ioctl = my_dev_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">dev_t</span> dev = MKDEV(MY_MAJOR_NUM, <span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">/* Allocate device numbers */</span></span><br><span class="line">    ret = register_chrdev_region(dev, <span class="number">1</span>, <span class="string">&quot;my_char_device&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;Unable to allocate mayor number %d\n&quot;</span>, MY_MAJOR_NUM);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Initialize the cdev structure and add it to the kernel space */</span></span><br><span class="line">    cdev_init(&amp;my_dev, &amp;my_dev_fops);</span><br><span class="line">    ret= cdev_add(&amp;my_dev, dev, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;Unable to add cdev\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    cdev_del(&amp;my_dev);</span><br><span class="line">    unregister_chrdev_region(MKDEV(MY_MAJOR_NUM, <span class="number">0</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="4-5-2-dong-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao">4.5.2 动态分配和释放一个设备号</span><a href="#4-5-2-dong-tai-fen-pei-he-shi-fang-yi-ge-she-bei-hao" class="header-anchor">#</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/fs.h&gt;</span><br><span class="line">alloc_chrdev_region()</span><br><span class="line">unregister_chrdev_region()</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span>*  <span class="title">helloClass</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">my_dev</span>;</span></span><br><span class="line"><span class="type">dev_t</span> dev;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">dev_t</span> dev_no;</span><br><span class="line">    <span class="type">int</span> Major;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span>* <span class="title">helloDevice</span>;</span></span><br><span class="line">    ret = alloc_chrdev_region(&amp;dev_no, <span class="number">0</span>, <span class="number">1</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        pr_info(<span class="string">&quot;Unable to allocate Mayor number \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    Major = MAJOR(dev_no);</span><br><span class="line">    dev = MKDEV(Major,<span class="number">0</span>);</span><br><span class="line">    cdev_init(&amp;my_dev, &amp;my_dev_fops);</span><br><span class="line">    ret = cdev_add(&amp;my_dev, dev, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;Unable to add cdev\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    helloClass = class_create(THIS_MODULE, CLASS_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(helloClass))&#123;</span><br><span class="line">        unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">        cdev_del(&amp;my_dev);</span><br><span class="line">        pr_info(<span class="string">&quot;Failed to register device class\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(helloClass);</span><br><span class="line">    &#125;</span><br><span class="line">    helloDevice = device_create(helloClass, <span class="literal">NULL</span>, dev, <span class="literal">NULL</span>, DEVICE_NAME);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(helloDevice))&#123;</span><br><span class="line">        class_destroy(helloClass);</span><br><span class="line">        cdev_del(&amp;my_dev);</span><br><span class="line">        unregister_chrdev_region(dev, <span class="number">1</span>);</span><br><span class="line">        pr_info(<span class="string">&quot;Failed to create the device\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(helloDevice);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    device_destroy(helloClass, dev);     <span class="comment">/* remove the device */</span></span><br><span class="line">    class_destroy(helloClass);           <span class="comment">/* remove the device class */</span></span><br><span class="line">    cdev_del(&amp;my_dev);</span><br><span class="line">    unregister_chrdev_region(dev, <span class="number">1</span>);    <span class="comment">/* unregister the device numbers */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2><span id="4-6-tian-jia-she-bei-he-lei">4.6 添加设备和类</span><a href="#4-6-tian-jia-she-bei-he-lei" class="header-anchor">#</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">struct class *class; /* 类 */ </span><br><span class="line">struct device *device; /* 设备 */ </span><br><span class="line">dev_t devid; /* 设备号 */</span><br><span class="line">static int __init led_init(void) &#123; </span><br><span class="line">    class = class_create(THIS_MODULE, &quot;xxx&quot;); </span><br><span class="line">    device = device_create(class, NULL, devid, NULL, &quot;xxx&quot;); </span><br><span class="line">    return 0; </span><br><span class="line">&#125; </span><br><span class="line">static void __exit led_exit(void) &#123; </span><br><span class="line">	device_destroy(newchrled.class, newchrled.devid); </span><br><span class="line">    class_destroy(newchrled.class); </span><br><span class="line">&#125; </span><br><span class="line">module_init(led_init); </span><br><span class="line">module_exit(led_exit);</span><br></pre></td></tr></table></figure>

<h1><span id="5-nei-he-yuan-ma-shu-tian-jia-yi-ge-zi-fu-she-bei-qu-dong">5 内核源码树添加一个字符设备驱动</span><a href="#5-nei-he-yuan-ma-shu-tian-jia-yi-ge-zi-fu-she-bei-qu-dong" class="header-anchor">#</a></h1><h2><span id="5-1-zhun-bei-qu-dong-yuan-ma">5.1 准备驱动源码</span><a href="#5-1-zhun-bei-qu-dong-yuan-ma" class="header-anchor">#</a></h2><p>这里以<code>misc device</code>为例， 进入<code>drivers/misc目录</code>，新建目录<code>hello_drv</code>。放入<code>驱动源码</code>和<code>Makefile</code>和<code>Kconfig</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/miscdevice.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/major.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/seq_file.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/tty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kmod.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gfp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">hello_cdev</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> kernel_buf[<span class="number">1024</span>];</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">hello_class</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">hello_drv_read</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span>&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    err = copy_to_user(buf, kernel_buf, min(<span class="number">1024</span>, size));</span><br><span class="line">    <span class="keyword">return</span> min(<span class="number">1024</span>, size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">hello_drv_write</span> <span class="params">(<span class="keyword">struct</span> file *file, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> size, <span class="type">loff_t</span> *offset)</span>&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    err = copy_from_user(kernel_buf, buf, min(<span class="number">1024</span>, size));</span><br><span class="line">    <span class="keyword">return</span> min(<span class="number">1024</span>, size);</span><br><span class="line">&#125; </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_drv_open</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">hello_drv_close</span> <span class="params">(<span class="keyword">struct</span> inode *node, <span class="keyword">struct</span> file *file)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">hello_drv</span> =</span> &#123;</span><br><span class="line">    .owner     = THIS_MODULE,</span><br><span class="line">    .open    = hello_drv_open,</span><br><span class="line">    .read    = hello_drv_read,</span><br><span class="line">    .write   = hello_drv_write,</span><br><span class="line">    .release = hello_drv_close,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">hello_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line">    <span class="type">int</span> rc;</span><br><span class="line">    <span class="type">dev_t</span> devid;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">//major = register_chrdev(0, &quot;hello&quot;, &amp;hello_drv);  /* /dev/hello */</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    rc = alloc_chrdev_region(&amp;devid, <span class="number">0</span>, <span class="number">1</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    major = MAJOR(devid);</span><br><span class="line">    cdev_init(&amp;hello_cdev, &amp;hello_drv);</span><br><span class="line">    cdev_add(&amp;hello_cdev, devid, <span class="number">1</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    hello_class = class_create(THIS_MODULE, <span class="string">&quot;hello_class&quot;</span>);</span><br><span class="line">    err = PTR_ERR(hello_class);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(hello_class)) &#123;</span><br><span class="line">        printk(<span class="string">&quot;%s %s line %d\n&quot;</span>, __FILE__, __FUNCTION__, __LINE__);</span><br><span class="line">        unregister_chrdev(major, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    device_create(hello_class, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">&quot;hello&quot;</span>); <span class="comment">/* /dev/hello */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">hello_exit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    device_destroy(hello_class, MKDEV(major, <span class="number">0</span>));</span><br><span class="line">    class_destroy(hello_class);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="comment">//unregister_chrdev(major, &quot;hello&quot;);</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    cdev_del(&amp;hello_cdev);</span><br><span class="line">    unregister_chrdev_region(MKDEV(major,<span class="number">0</span>), <span class="number">1</span>);   </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2><span id="5-2-makefile">5.2 MakeFile</span><a href="#5-2-makefile" class="header-anchor">#</a></h2><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/35.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">userprogs-always-y += hello_test</span><br><span class="line">userccflags += -I usr/include</span><br></pre></td></tr></table></figure>

<p>这里表示用userspace方式去编译应用程序，hello_test就是用户程序。</p>
<p>假如我们多个文件<code>hello1.c hello2.c</code>, 如何得到<code>hello.o</code>和<code>hello.ko</code>呢？如下参考：</p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/36.png" alt="image-20240725223651990"></p>
<h2><span id="5-3-kconfig">5.3 Kconfig</span><a href="#5-3-kconfig" class="header-anchor">#</a></h2><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/37.png" alt="img"></p>
<h2><span id="5-4-xiu-gai-shang-yi-ji-makefile-he-kconfig">5.4 修改上一级Makefile和Kconfig</span><a href="#5-4-xiu-gai-shang-yi-ji-makefile-he-kconfig" class="header-anchor">#</a></h2><p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/38.png" alt="img"></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/39.png" alt="img"></p>
<p>让<code>hello_drv</code>目录中的<code>Kconfig</code>也能被内核识别，输入<code>make menuconfig</code>，即可选择将其编译成内核模块还是直接编译进内核镜像，默认<code>default n</code>,也就是<code>CONFIG_HELLO</code>等于n, <code>hello_drv</code>目录是<code>obj-n</code>, 不编译；选择y则表示编译进内核镜像，选择m表示编译成内核模块。</p>
<p> 编译成内核模块，则会在<code>.config</code>中产生<code>CONFIG_HELLO=m</code>的一项配置，编译产生<code>hello.ko</code></p>
<p><img src="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/40.png" alt="img"></p>
<p>编译成内核镜像，则会在<code>.config</code>中产生<code>CONFIG_HELLO=y</code>的一项配置，编译产生<code>built-in.a</code>,最终该 <code>built-in.a</code>会合入vmlinux。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/" data-id="clz1eaynq0000hsuf9fug0k0r" data-title="字符设备驱动-1-GPIO驱动LED示例" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/07/26/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-2-%E6%80%BB%E7%BA%BF%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%B9%B3%E5%8F%B0%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          字符设备驱动-2-总线模型和平台设备驱动
        
      </div>
    </a>
  
  
    <a href="/2024/07/23/Linux%E5%86%85%E6%A0%B8-%E5%BC%82%E5%B8%B8%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E6%A0%88calltrace%E5%88%86%E6%9E%90/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Linux内核-异常输出函数调用栈calltrace分析</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 19.09px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 17.27px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 18.18px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 20px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 11.82px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 12.73px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 17.27px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 13.64px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/04/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-8-%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8/">字符设备驱动-8-内核定时器</a>
          </li>
        
          <li>
            <a href="/2024/08/04/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-7-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/">字符设备驱动-7-异步通知</a>
          </li>
        
          <li>
            <a href="/2024/07/30/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-6-poll%E5%BA%95%E5%B1%82%E9%A9%B1%E5%8A%A8%E6%9C%BA%E5%88%B6/">字符设备驱动-6-poll底层驱动机制</a>
          </li>
        
          <li>
            <a href="/2024/07/30/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-6-pre-%E4%BC%91%E7%9C%A0%E5%94%A4%E9%86%92%E6%9C%BA%E5%88%B6/">字符设备驱动-6-pre-休眠唤醒机制</a>
          </li>
        
          <li>
            <a href="/2024/07/28/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-5-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%87%BD%E6%95%B0/">字符设备驱动-5-设备树函数</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
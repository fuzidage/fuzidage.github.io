<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Linux下sysfs-procfs-debugfs使用 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 Linux下sysfs-procfs-debugfs使用 1.1 sysfs 1.1.1 sysfs举例 1.1.2 sysfs使用 1.1.2.0 syfs下的platform设备和驱动信息 1.1.2.1 syfs下的misc设备信息 1.1.2.2 syfs API 1.1.2.3 给驱动模块添加sysfs参数举例   1.1.3 DEVICE_ATTR宏 1.1.3.0 DE">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux下sysfs-procfs-debugfs使用">
<meta property="og:url" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 Linux下sysfs-procfs-debugfs使用 1.1 sysfs 1.1.1 sysfs举例 1.1.2 sysfs使用 1.1.2.0 syfs下的platform设备和驱动信息 1.1.2.1 syfs下的misc设备信息 1.1.2.2 syfs API 1.1.2.3 给驱动模块添加sysfs参数举例   1.1.3 DEVICE_ATTR宏 1.1.3.0 DE">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/0.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/0-1.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/1.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/2.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/3.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/4.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/5.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/6.jpeg">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/7.png">
<meta property="og:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/8.png">
<meta property="article:published_time" content="2024-07-23T15:46:34.000Z">
<meta property="article:modified_time" content="2024-09-12T14:44:47.775Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="linux系统构建">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/0.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Linux下sysfs-procfs-debugfs使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2024-07-23T15:46:34.000Z" itemprop="datePublished">2024-07-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      Linux下sysfs-procfs-debugfs使用
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-linux-xia-sysfs-procfs-debugfs-shi-yong">1 Linux下sysfs-procfs-debugfs使用</a><ul>
<li><a href="#1-1-sysfs">1.1 sysfs</a><ul>
<li><a href="#1-1-1-sysfs-ju-li">1.1.1 sysfs举例</a></li>
<li><a href="#1-1-2-sysfs-shi-yong">1.1.2 sysfs使用</a><ul>
<li><a href="#1-1-2-0-syfs-xia-de-platform-she-bei-he-qu-dong-xin-xi">1.1.2.0 syfs下的platform设备和驱动信息</a></li>
<li><a href="#1-1-2-1-syfs-xia-de-misc-she-bei-xin-xi">1.1.2.1 syfs下的misc设备信息</a></li>
<li><a href="#1-1-2-2-syfs-api">1.1.2.2 syfs API</a></li>
<li><a href="#1-1-2-3-gei-qu-dong-mo-kuai-tian-jia-sysfs-can-shu-ju-li">1.1.2.3 给驱动模块添加sysfs参数举例</a></li>
</ul>
</li>
<li><a href="#1-1-3-device-attr-hong">1.1.3 DEVICE_ATTR宏</a><ul>
<li><a href="#1-1-3-0-device-attr-shi-li">1.1.3.0 DEVICE_ATTR示例</a></li>
<li><a href="#1-1-3-1-device-create-file">1.1.3.1 device_create_file</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-2-procfs">1.2 procfs</a><ul>
<li><a href="#1-2-1-procfs-api">1.2.1 procfs API</a></li>
<li><a href="#1-2-2-shi-yong-ju-li">1.2.2 使用举例</a><ul>
<li><a href="#1-2-2-1-seq-ji-zhi">1.2.2.1 seq机制</a><ul>
<li><a href="#1-2-2-1-0-sigle-open">1.2.2.1.0 sigle_open</a></li>
<li><a href="#1-2-2-1-1-seq-file-ji-chu">1.2.2.1.1 seq_file基础</a></li>
<li><a href="#1-2-2-1-2-seq-read">1.2.2.1.2 seq_read</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-debugfs">1.3 debugfs</a><ul>
<li><a href="#1-3-1-debugfs-api">1.3.1 debugfs API</a></li>
<li><a href="#1-3-2-debugfs-shi-li">1.3.2 debugfs 示例</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-linux-xia-sysfs-procfs-debugfs-shi-yong">1 Linux下sysfs-procfs-debugfs使用</span><a href="#1-linux-xia-sysfs-procfs-debugfs-shi-yong" class="header-anchor">#</a></h1><p>Linux内核空间与用户空间的交互如何能透过文件系统这层关系，把需要参数写入文件中呢？</p>
<p>当然有办法，linux内核提供了3种 <code>“内存文件系统”</code>，分别是<code>sysfs</code>、<code>debugfs</code>、<code>procfs</code>，驱动工程师可以通过任意的一种文件系统向用户空间传递信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sysfs的挂载点为/sys</span><br><span class="line">Debugfs的挂载点为/sys/kernel/debug</span><br><span class="line">Procfs的挂载点为/proc</span><br></pre></td></tr></table></figure>

<p><code>内存文件系统</code>: 一种临时文件系统，一般会利用脚本挂载到rootfs，但是这些目录都是使用RAM空间，他们中的信息只存在于内存中，下电后即消失。他们的出现旨在提供一种与用户空间交互信息的方式。</p>
<p>脚本如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx]/etc<span class="comment"># cat fstab</span></span><br><span class="line"><span class="comment"># &lt;file system&gt; &lt;mount pt&gt;      &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span></span><br><span class="line">/dev/root       /               ext2    rw,noauto       0       1</span><br><span class="line">proc            /proc           proc    defaults        0       0</span><br><span class="line">devpts          /dev/pts        devpts  defaults,gid=5,mode=620,ptmxmode=0666 0 0</span><br><span class="line">tmpfs           /dev/shm        tmpfs   mode=0777       0       0</span><br><span class="line">tmpfs           /tmp            tmpfs   mode=1777       0       0</span><br><span class="line">sysfs           /sys            sysfs   defaults        0       0</span><br><span class="line">nodev           /sys/kernel/debug debugfs   defaults    0       0</span><br></pre></td></tr></table></figure>

<p>输入<code>mount</code>查看挂载信息：可以看到有挂载<code>procfs, sysfs，以及debugfs</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx]~<span class="comment"># mount</span></span><br><span class="line">/dev/root on / <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,relatime,size=1381884k,nr_inodes=345471,mode=755)</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)    <span class="comment">#procfs</span></span><br><span class="line">sysfs on /sys <span class="built_in">type</span> sysfs (rw,relatime)   <span class="comment">#sysfs</span></span><br><span class="line">nodev on /sys/kernel/debug <span class="built_in">type</span> debugfs (rw,relatime)   <span class="comment">#debugfs</span></span><br><span class="line">/dev/mmcblk0p6 on /mnt/cfg <span class="built_in">type</span> ext4 (rw,<span class="built_in">sync</span>,relatime)</span><br><span class="line">/dev/mmcblk0p7 on /mnt/data <span class="built_in">type</span> ext4 (rw,<span class="built_in">sync</span>,relatime)</span><br><span class="line">/dev/mmcblk0p7 on /var/log <span class="built_in">type</span> ext4 (rw,<span class="built_in">sync</span>,relatime)</span><br></pre></td></tr></table></figure>

<h2><span id="1-1-sysfs">1.1 sysfs</span><a href="#1-1-sysfs" class="header-anchor">#</a></h2><p>设备驱动模型中诞生了sys这个新的虚拟文件系统。</p>
<h3><span id="1-1-1-sysfs-ju-li">1.1.1 sysfs举例</span><a href="#1-1-1-sysfs-ju-li" class="header-anchor">#</a></h3><p>sysfs在linux驱动开发过程使用非常常见，比如<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18085417">gpio子系统</a> <a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18114131">led子系统</a>     <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E5%86%85%E6%A0%B8led%E5%AD%90%E7%B3%BB%E7%BB%9F/">led子系统-hexo</a> <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/">gpio子系统-hexo</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/class/gpio/export  <span class="comment">#/sys/class/gpio会生成gpio256目录</span></span><br><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/class/gpio/unexport</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 255 &gt; /sys/class/leds/led1/brightness</span><br><span class="line"><span class="built_in">cat</span> /sys/class/leds/led1/brightness</span><br><span class="line"><span class="built_in">cat</span> /sys/class/leds/led1/max_brightness</span><br></pre></td></tr></table></figure>

<p>这就是利用sysfs写入文件，这个文件是用户态和内核态共享的。方便驱动动态读取用户配置和对驱动的控制。</p>
<h3><span id="1-1-2-sysfs-shi-yong">1.1.2 sysfs使用</span><a href="#1-1-2-sysfs-shi-yong" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@xxx]/sys/module/soph_stitch/drivers<span class="comment"># ls -l</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx  1 root root  0 Jan  1 10:00 platform:stitch -&gt; ../../../bus/platform/drivers/stitch</span><br><span class="line"></span><br><span class="line">[root@cvitek]/sys/module/soph_stitch/parameters<span class="comment"># ls -l   </span></span><br><span class="line"><span class="comment">#对应驱动模块的模块参数，比如module_param(clk_sys_freq, int, 0644);module_param(gStitchDumpReg, int, 0644);</span></span><br><span class="line">-rw-r--r--    1 root     root          4096 Jan  1 10:01 clk_sys_freq</span><br><span class="line">-rw-r--r--    1 root     root          4096 Jan  1 10:01 gStitchDumpDmaCfg</span><br><span class="line">-rw-r--r--    1 root     root          4096 Jan  1 10:01 gStitchDumpReg</span><br><span class="line">-rw-r--r--    1 root     root          4096 Jan  1 10:01 stitch_log_lv</span><br></pre></td></tr></table></figure>

<p><code>/sys/module/xxx/parameters</code>下定义了驱动xxx模块的模块参数。</p>
<h4><span id="1-1-2-0-syfs-xia-de-platform-she-bei-he-qu-dong-xin-xi">1.1.2.0 syfs下的platform设备和驱动信息</span><a href="#1-1-2-0-syfs-xia-de-platform-she-bei-he-qu-dong-xin-xi" class="header-anchor">#</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]/sys/bus/platform/devices<span class="comment"># ls -l</span></span><br><span class="line">...</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 680b8000.stitch -&gt; ../../../devices/platform/680b8000.stitch</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 680ba000.dpu -&gt; ../../../devices/platform/680ba000.dpu</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 680be000.sys -&gt; ../../../devices/platform/680be000.sys</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 68100000.cif -&gt; ../../../devices/platform/68100000.cif</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 68100000.cif_v4l2 -&gt; ../../../devices/platform/68100000.cif_v4l2</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 Fixed MDIO bus.0 -&gt; ../../../devices/platform/Fixed MDIO bus.0</span><br><span class="line">lrwxrwxrwx 1 root  root    0 Jan  1 10:06 base -&gt; ../../../devices/platform/base</span><br><span class="line">...</span><br><span class="line">[root@cvitek]/sys/bus/platform/drivers<span class="comment"># ls -l</span></span><br><span class="line">...</span><br><span class="line">drwxr-xr-x    2 root     root             0 Jan  1 10:15 cif</span><br><span class="line">drwxr-xr-x    2 root     root             0 Jan  1 10:00 stitch</span><br><span class="line">...</span><br><span class="line"><span class="comment"># cd /sys/bus/platform/drivers/stitch进来瞅瞅</span></span><br><span class="line">[root@cvitek]/sys/bus/platform/drivers/stitch<span class="comment"># ls -l</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root     root   0 Jan  1 10:00 680b8000.stitch -&gt; ../../../../devices/platform/680b8000.stitch</span><br><span class="line">lrwxrwxrwx 1 root     root   0 Jan  1 10:00 module -&gt; ../../../../module/soph_stitch</span><br><span class="line">--w------- 1 root     root   4096 Jan  1 10:00 uevent</span><br></pre></td></tr></table></figure>

<p>可以看到只要用<code>platform_driver_register</code>、<code>platform_device_register</code>注册的驱动和设备就会建立如上的<code>sysfs</code>关系链。</p>
<h4><span id="1-1-2-1-syfs-xia-de-misc-she-bei-xin-xi">1.1.2.1 syfs下的misc设备信息</span><a href="#1-1-2-1-syfs-xia-de-misc-she-bei-xin-xi" class="header-anchor">#</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]/sys/class/misc<span class="comment"># ls</span></span><br><span class="line">misccvitekadc_0  soph-dpu         soph-stitch      watchdog</span><br><span class="line">misccvitekadc_1  soph-ldc         soph-sys</span><br><span class="line">misccvitekdac_0  soph-mipi-rx     soph-vpss</span><br><span class="line">[root@cvitek]/sys/class/misc<span class="comment"># ls -l soph-stitch</span></span><br><span class="line">lrwxrwxrwx    1 root  root    0 Jan  1 13:57 soph-stitch -&gt; ../../devices/virtual/misc/soph-stitch</span><br><span class="line"></span><br><span class="line">[root@cvitek]/sys/class/soph-vi<span class="comment"># ls -l</span></span><br><span class="line">lrwxrwxrwx    1 root  root    0 Jan  1 08:02 soph-vi -&gt; ../../devices/platform/68000000.vi/soph-vi/soph-vi</span><br></pre></td></tr></table></figure>

<p>可以看到只要是misc设备注册的字符设备，都会在<code>/sys/class/misc</code>下。<code>device_create</code>函数内部会调用到<code>device_add</code>函数，会在<code>/sys/device</code>目录下生成相应的sys文件，同时会判断device结构中的devt变量是否可用，如果可用才会调用<code>devtmpfs_create_node(dev);</code>在&#x2F;dev目录下生成对应的设备文件。所以说device_add是否会生成设备文件需要根据device结构体中是否传入了设备号来决定的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">device_create(dev-&gt;vi_class, dev-&gt;dev, dev-&gt;cdev_id, <span class="literal">NULL</span>, <span class="string">&quot;%s&quot;</span>, VI_DEV_NAME);</span><br></pre></td></tr></table></figure>

<h4><span id="1-1-2-2-syfs-api">1.1.2.2 syfs API</span><a href="#1-1-2-2-syfs-api" class="header-anchor">#</a></h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> inline <span class="built_in">int</span> __<span class="function">must_check <span class="title">sysfs_create_file</span>(<span class="params"><span class="keyword">struct</span> kobject *kobj,</span></span></span><br><span class="line"><span class="params"><span class="function">	<span class="keyword">const</span> <span class="keyword">struct</span> attribute *attr</span>)<span class="comment">//生成sysfs属性文件，此接口用于生成单个属性文件</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">//在参数kobj目录下面创建一个属性集合，并且显示该集合的文件。</span></span></span><br><span class="line"><span class="function"><span class="comment">//attribute_group *grp 中描述的是一组属性类型</span></span></span><br><span class="line"><span class="function"><span class="built_in">int</span> __must_check <span class="title">sysfs_create_group</span>(<span class="params"><span class="keyword">struct</span> kobject *kobj,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="keyword">const</span> <span class="keyword">struct</span> attribute_group *grp</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> __<span class="function">must_check <span class="title">sysfs_create_groups</span>(<span class="params"><span class="keyword">struct</span> kobject *kobj,</span></span></span><br><span class="line"><span class="params"><span class="function">				     <span class="keyword">const</span> <span class="keyword">struct</span> attribute_group **groups</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//动态生成一个struct kobject数据结构，然后将其注册到sysfs文件系统</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">name就是要创建的文件或者目录的名称，</span></span><br><span class="line"><span class="comment">parent指向父目录的kobject数据结构，若parent为NULL，说明父目录就是/sys目录，</span></span><br><span class="line"><span class="comment">比如：kobject_create_and_add()在/sys 目录下建立一个名为“kernel”的目录，</span></span><br><span class="line"><span class="comment">然后sysfs_create_group()函数在该目录下面创建一些属性集合</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">struct</span> kobject *kobject_create_and_add(<span class="keyword">const</span> <span class="built_in">char</span> *name, <span class="keyword">struct</span> kobject*parent);</span><br><span class="line"></span><br><span class="line"><span class="comment">//会调用到sysfs_create_file函数来生成sysfs属性文件，此接口用于生成单个属性文件</span></span><br><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">device_create_file</span> (<span class="params"> <span class="keyword">struct</span> device * dev, <span class="keyword">const</span> <span class="keyword">struct</span> device_attribute * attr</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//移除组属性</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sysfs_remove_group</span>(<span class="params"><span class="keyword">struct</span> kobject *kobj,</span></span></span><br><span class="line"><span class="params"><span class="function">			<span class="keyword">const</span> <span class="keyword">struct</span> attribute_group *grp</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Y:\linux_5.10\include\linux\sysfs.h</span></span><br></pre></td></tr></table></figure>

<h4><span id="1-1-2-3-gei-qu-dong-mo-kuai-tian-jia-sysfs-can-shu-ju-li">1.1.2.3 给驱动模块添加sysfs参数举例</span><a href="#1-1-2-3-gei-qu-dong-mo-kuai-tian-jia-sysfs-can-shu-ju-li" class="header-anchor">#</a></h4><ol>
<li>使用<code>DEVICE_ATTR</code>声明一个sys节点, 这里是一个<code>led_status</code>节点，申明了<code>led_status_show</code>，<code>led_status_store</code>函数。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">led_status：在sys接口中显示的节点名字</span></span><br><span class="line"><span class="comment">0600：表示操作这个led_status节点的权限</span></span><br><span class="line"><span class="comment">led_status_show：使用cat命令查看sys接口时调用的函数</span></span><br><span class="line"><span class="comment">led_status_store：使用echo命令往sys接口写入内容时调用的函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEVICE_ATTR</span><span class="params">(led_status, <span class="number">0600</span>, led_status_show, led_status_store)</span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>完成sys节点的读写函数,执行<code> cat /sys/devices/platform/leds/led_status</code>时会调用<code>led_status_show</code>,把buf内容显示出来。用echo命令往sys节点写入内容时调用<code>led_status_store</code>。<code>led_status_show()</code>函数和<code>led_status_store()</code>函数的作用分为打印led变量的值和修改led变量的值.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> led = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_status_show</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="type">char</span> *buf)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s:%d.\n&quot;</span>, <span class="string">&quot;led&quot;</span>, led);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_status_store</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span><br><span class="line"><span class="params">            <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span>&#123;</span><br><span class="line">	<span class="comment">//写入的内容会存放到buf中，这里将buf内容赋值给led变量</span></span><br><span class="line"> 	<span class="built_in">sscanf</span>(buf, <span class="string">&quot;%d&quot;</span>, &amp;led);</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>定义<code>struct attribute</code>和<code>struct attribute_group</code>数组</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> *<span class="title">led_attributes</span>[]=</span>&#123;</span><br><span class="line">  <span class="comment">/*上述使用了DEVICE_ATTR声明节点名字为led_status，</span></span><br><span class="line"><span class="comment">  * 则struct attribute名字应为：</span></span><br><span class="line"><span class="comment">  *  dev_attr_ + (节点名) + .attr</span></span><br><span class="line"><span class="comment">  * 所以名字为dev_attr_led_status.attr</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  &amp;dev_attr_led_status.attr,</span><br><span class="line"> <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span> <span class="title">led_attrs</span>=</span>&#123;</span><br><span class="line"> .attrs = led_attributes,<span class="comment">//引用上述struct attribute数组</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>调用<code>sysfs_create_group()</code>注册sysfs接口, 完整驱动实例如下：<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">int</span> led = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title">led_status_show</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="type">char</span> *buf)</span></span>&#123;</span><br><span class="line"> 	<span class="keyword">return</span> <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s:%d.\n&quot;</span>, <span class="string">&quot;led&quot;</span>, led);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title">led_status_store</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span></span><br><span class="line"><span class="params"><span class="function">       <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span></span>&#123;</span><br><span class="line"> 	<span class="built_in">sscanf</span>(buf, <span class="string">&quot;%d&quot;</span>, &amp;led);</span><br><span class="line"> 	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">static</span> <span class="title">DEVICE_ATTR</span><span class="params">(led_status, <span class="number">0600</span>, led_status_show, led_status_store)</span></span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">attribute</span> *led_attributes[]=&#123;</span><br><span class="line">     &amp;dev_attr_led_status.attr,</span><br><span class="line">     <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">attribute_group</span> led_attrs=&#123;</span><br><span class="line"> 	.attrs = led_attributes,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">xx_led_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span>&#123;</span><br><span class="line"> 	<span class="built_in">sysfs_create_group</span>(&amp;pdev-&gt;dev.kobj, &amp;led_attrs);</span><br><span class="line"> 	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">xx_led_remove</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span>&#123;</span><br><span class="line">     <span class="built_in">sysfs_remove_group</span>(&amp;pdev-&gt;dev.kobj, &amp;led_attrs);</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title class_">of_device_id</span> xx_led_of_match[] = &#123;</span><br><span class="line">     &#123;.compatible = <span class="string">&quot;xx,xx-led&quot;</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> <span class="title class_">platform_driver</span> xx_led_driver = &#123;</span><br><span class="line">     .probe = xx_led_probe,</span><br><span class="line">     .remove = xx_led_remove,</span><br><span class="line">     .driver = &#123;</span><br><span class="line">      .name = <span class="string">&quot;xx-led&quot;</span>,</span><br><span class="line">      .owner = THIS_MODULE,</span><br><span class="line">      .of_match_table = xx_led_of_match,</span><br><span class="line">     &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> __init <span class="title">xx_led_init</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	 <span class="keyword">return</span> <span class="built_in">platform_driver_register</span>(&amp;xx_led_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> __exit <span class="title">xx_led_exit</span><span class="params">(<span class="type">void</span>)</span></span>&#123;</span><br><span class="line">	 <span class="built_in">platform_driver_unregister</span>(&amp;xx_led_driver);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module_init</span>(xx_led_init);</span><br><span class="line"><span class="built_in">module_exit</span>(xx_led_exit);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3><span id="1-1-3-device-attr-hong">1.1.3 DEVICE_ATTR宏</span><a href="#1-1-3-device-attr-hong" class="header-anchor">#</a></h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEVICE_ATTR(_name, _mode, _show, _store) \</span></span><br><span class="line">	<span class="keyword">struct</span> device_attribute dev_attr_<span class="meta">##_name = __ATTR(_name, _mode, _show, _store)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ATTR(_name, _mode, _show, _store) &#123;				\</span></span><br><span class="line">	.attr = &#123;.name = __stringify(_name),				\</span><br><span class="line">		 .mode = VERIFY_OCTAL_PERMISSIONS(_mode) &#125;,		\</span><br><span class="line">	.show	= _show,						\</span><br><span class="line">	.store	= _store,						\</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> device_attribute &#123;</span><br><span class="line">	<span class="keyword">struct</span> attribute	attr;</span><br><span class="line">	ssize_t (*show)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">			<span class="built_in">char</span> *buf);</span><br><span class="line">	ssize_t (*store)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">			 <span class="keyword">const</span> <span class="built_in">char</span> *buf, size_t count);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>DEVICE_ATTR</code>宏会定义一个<code>struct device_attribute</code>结构体实例<code>dev_attr_##_name</code>和初始化。一般用<code>device_create_file</code>生成sysfs属性文件。</p>
<p>注意：属性文件的权限<code>mode</code>不可以随便定义，是有限制的，mode不合理会报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: negative width in bit-field anonymous</span><br></pre></td></tr></table></figure>

<h4><span id="1-1-3-0-device-attr-shi-li">1.1.3.0 DEVICE_ATTR示例</span><a href="#1-1-3-0-device-attr-shi-li" class="header-anchor">#</a></h4><p>以<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18182054">Linux下Framebuffer子系统(cnblogs.com-fuzidage)</a> <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统 | Hexo (fuzidage.github.io)</a> 为例，打开<code>linux_5.10/drivers/video/fbdev/core/fbsysfs.c</code>:</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/0.png" alt="image-20240912223158978"></p>
<p>可以看到很多属性文件，都调用<code>device_create_file</code>建立了sysfs属性文件。</p>
<h4><span id="1-1-3-1-device-create-file">1.1.3.1 device_create_file</span><a href="#1-1-3-1-device-create-file" class="header-anchor">#</a></h4><p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/0-1.png" alt="image-20240912223254045"></p>
<p>可以看到本质还是用<code>sysfs_creat_file</code>创建sysfs属性文件。</p>
<h2><span id="1-2-procfs">1.2 procfs</span><a href="#1-2-procfs" class="header-anchor">#</a></h2><p>procfs是用户获取进程的有用信息、系统的有用信息等。可以查看某个进程的相关信息，也可以查看系统的信息，比如&#x2F;proc&#x2F;meminfo 用来查看内存的管理信息，&#x2F;proc&#x2F;cpuinfo用来观察CPU的信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]~<span class="comment"># ls -l /proc/</span></span><br><span class="line">total 0</span><br><span class="line">dr-xr-xr-x    8 root     root             0 Jan  1 08:00 1</span><br><span class="line">dr-xr-xr-x    8 root     root             0 Jan  1 08:00 234</span><br><span class="line">dr-xr-xr-x    8 root     root             0 Jan  1 08:00 273</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 cmdline</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 cpuinfo</span><br><span class="line">dr-xr-xr-x    3 root     root             0 Jan  1 08:02 dynamic_debug</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 fb</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 filesystems</span><br><span class="line">dr-xr-xr-x    8 root     root             0 Jan  1 08:02 fs</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 interrupts</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 iomem</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 ioports</span><br><span class="line">dr-xr-xr-x   92 root     root             0 Jan  1 08:02 irq</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 meminfo</span><br><span class="line">-r--------    1 root     root             0 Jan  1 08:02 pagetypeinfo</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 partitions</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 sched_debug</span><br><span class="line">lrwxrwxrwx    1 root     root             0 Jan  1 08:00 self -&gt; 291</span><br><span class="line">lrwxrwxrwx    1 root     root             0 Jan  1 08:00 thread-self -&gt; 291/task/291</span><br><span class="line">-r--------    1 root     root             0 Jan  1 08:02 vmallocinfo</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 vmstat</span><br><span class="line">-r--r--r--    1 root     root             0 Jan  1 08:02 zoneinfo</span><br></pre></td></tr></table></figure>

<p>可以看到很多信息，我们敲的命令ps、top等很多shell命令正是从proc系统中读取信息，且更具可读性。又例如free命令就是解析&#x2F;proc&#x2F;meminifo。</p>
<h3><span id="1-2-1-procfs-api">1.2.1 procfs API</span><a href="#1-2-1-procfs-api" class="header-anchor">#</a></h3><p>procfs文件系统提供了一些常用的API，这些API函数定义在<code>fs/proc/internal.h</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> proc_dir_entry *<span class="title function_">proc_mkdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params">      <span class="keyword">struct</span> proc_dir_entry *parent)</span>;<span class="comment">// 如果传入的名字是null, 那么就在/proc/下创建一个目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//添加一个proc条目, linux5.10后file_operations换成了proc_ops</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (LINUX_VERSION_CODE &gt;= KERNEL_VERSION(5, 10, 0))</span></span><br><span class="line"><span class="keyword">struct</span> proc_dir_entry *<span class="title function_">proc_create_data</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">umode_t</span> mode,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> proc_dir_entry *parent,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="keyword">struct</span> proc_ops *proc_ops, <span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">struct</span> proc_dir_entry *<span class="title function_">proc_create_data</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">umode_t</span> mode,</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> proc_dir_entry *parent,</span></span><br><span class="line"><span class="params">					<span class="type">const</span> <span class="keyword">struct</span> file_operations *proc_fops,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//也可以直接用这种添加条目，支持多级目录如/proc/aaa/bbb/ccc条目</span></span><br><span class="line"><span class="keyword">struct</span> proc_dir_entry *<span class="title function_">proc_create_data</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">umode_t</span> mode,</span></span><br><span class="line"><span class="params">					<span class="keyword">struct</span> proc_dir_entry *parent,</span></span><br><span class="line"><span class="params">					<span class="type">const</span> <span class="keyword">struct</span> file_operations *proc_fops,</span></span><br><span class="line"><span class="params">					<span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="comment">//删除条目</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">remove_proc_entry</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="keyword">struct</span> proc_dir_entry *parent)</span>;</span><br><span class="line"><span class="comment">//删除目录</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">proc_remove</span><span class="params">(<span class="keyword">struct</span> proc_dir_entry *de)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// procfs的实现见Y:\linux_5.10\fs\proc\generic.c</span></span><br><span class="line"><span class="comment">// 头文件见Y:\linux_5.10\include\linux\proc_fs.h</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-2-2-shi-yong-ju-li">1.2.2 使用举例</span><a href="#1-2-2-shi-yong-ju-li" class="header-anchor">#</a></h3><p>举个例子：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17638448.html">misc杂项设备</a>  <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-misc%E6%9D%82%E9%A1%B9%E8%AE%BE%E5%A4%87/">misc杂项设备-Hexo</a>子系统初始化时:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">misc_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PROC_FS</span></span><br><span class="line">	proc_create(<span class="string">&quot;misc&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;misc_proc_fops);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	misc_class = class_create(THIS_MODULE, <span class="string">&quot;misc&quot;</span>);</span><br><span class="line">	err = PTR_ERR(misc_class);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(misc_class))</span><br><span class="line">		<span class="keyword">goto</span> fail_remove;</span><br><span class="line">	err = -EIO;</span><br><span class="line">	<span class="keyword">if</span> (register_chrdev(MISC_MAJOR,<span class="string">&quot;misc&quot;</span>,&amp;misc_fops))</span><br><span class="line">		<span class="keyword">goto</span> fail_printk;</span><br><span class="line">	misc_class-&gt;devnode = misc_devnode;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail_printk:</span><br><span class="line">	printk(<span class="string">&quot;unable to get major %d for misc devices\n&quot;</span>, MISC_MAJOR);</span><br><span class="line">	class_destroy(misc_class);</span><br><span class="line">fail_remove:</span><br><span class="line">	remove_proc_entry(<span class="string">&quot;misc&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就创建了<code>/proc/misc</code>条目和<code>/sys/class/misc</code>目录。<code>/proc/misc</code>条目统计了包含的misc杂项字符设备：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@xxxx]/proc<span class="comment"># cat misc</span></span><br><span class="line"> 48 soph-stitch</span><br><span class="line"> 49 soph-dpu</span><br><span class="line"> 50 soph-mipi-tx1</span><br><span class="line"> 51 soph-mipi-tx0</span><br><span class="line"> 52 soph-rgn</span><br></pre></td></tr></table></figure>

<p>再举一个例子：透过<code>procfs</code>进行<code>cif驱动</code>的状态显示到用户，以及用户配置参数，动态调用cif驱动的流程控制。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CIF_PROC_NAME &quot;v4l2/mipi-rx&quot;</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">struct</span> proc_dir_entry *cif_proc_entry;</span><br><span class="line"><span class="comment">//根据txt_buff做一些驱动流程控制，复位处理，时钟配置等等</span></span><br><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">dbg_hdler</span>(<span class="params"><span class="keyword">struct</span> cvi_cif_dev *dev, <span class="built_in">char</span> <span class="keyword">const</span> *input</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> cvi_link *link = &amp;dev-&gt;link[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">struct</span> cif_ctx *ctx;</span><br><span class="line">	<span class="comment">//int reset;</span></span><br><span class="line">	u32 num;</span><br><span class="line">	u8 str[<span class="number">80</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	u8 t = <span class="number">0</span>;</span><br><span class="line">	u32 a, v, v2;</span><br><span class="line">	u8 i, n;</span><br><span class="line">	u8 *p;</span><br><span class="line"></span><br><span class="line">	num = sscanf(input, <span class="string">&quot;%s %d %d %d&quot;</span>, str, &amp;a, &amp;v, &amp;v2);</span><br><span class="line">	<span class="keyword">if</span> (num &gt; <span class="number">4</span>) &#123;</span><br><span class="line">		dbg_print_usage(link-&gt;dev);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	dev_info(link-&gt;dev, <span class="string">&quot;input = %s %d\n&quot;</span>, str, num);</span><br><span class="line">	<span class="comment">/* convert to lower case for following type compare */</span></span><br><span class="line">	p = str;</span><br><span class="line">	<span class="keyword">for</span> (; *p; ++p)</span><br><span class="line">		*p = tolower(*p);</span><br><span class="line">	n = ARRAY_SIZE(dbg_type);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!strcmp(str, dbg_type[i])) &#123;</span><br><span class="line">			t = i;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (i == n) &#123;</span><br><span class="line">		dev_info(link-&gt;dev, <span class="string">&quot;unknown type(%s)!\n&quot;</span>, str);</span><br><span class="line">		dbg_print_usage(link-&gt;dev);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span> (t) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		<span class="comment">/* reset */</span></span><br><span class="line">		<span class="keyword">if</span> (a &gt; MAX_LINK_NUM)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		link = &amp;dev-&gt;link[a];</span><br><span class="line">		ctx = &amp;link-&gt;cif_ctx;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (link-&gt;is_on) &#123;</span><br><span class="line">			link-&gt;sts_csi.errcnt_ecc = <span class="number">0</span>;</span><br><span class="line">			link-&gt;sts_csi.errcnt_crc = <span class="number">0</span>;</span><br><span class="line">			link-&gt;sts_csi.errcnt_wc = <span class="number">0</span>;</span><br><span class="line">			link-&gt;sts_csi.errcnt_hdr = <span class="number">0</span>;</span><br><span class="line">			link-&gt;sts_csi.fifo_full = <span class="number">0</span>;</span><br><span class="line">			cif_clear_csi_int_sts(ctx);</span><br><span class="line">			cif_unmask_csi_int_sts(ctx, <span class="number">0x0F</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="comment">/* hs-settle */</span></span><br><span class="line">		<span class="keyword">if</span> (a &gt; MAX_LINK_NUM)</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">		link = &amp;dev-&gt;link[a];</span><br><span class="line">		ctx = &amp;link-&gt;cif_ctx;</span><br><span class="line">		cif_set_hs_settle(ctx, v);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//cat /proc/v4l2/mipi-rx会调用进行proc输出cif驱动状态信息</span></span><br><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">proc_cif_show</span>(<span class="params"><span class="keyword">struct</span> seq_file *m, <span class="keyword">void</span> *v</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> cvi_cif_dev *dev = (<span class="keyword">struct</span> cvi_cif_dev *)m-&gt;<span class="keyword">private</span>;</span><br><span class="line">	<span class="built_in">int</span> i;</span><br><span class="line"></span><br><span class="line">	seq_printf(m, <span class="string">&quot;\nModule: [MIPI_RX], Build Time[%s]\n&quot;</span>,</span><br><span class="line">			UTS_VERSION);</span><br><span class="line">	seq_puts(m, <span class="string">&quot;\n------------Combo DEV ATTR--------------\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_LINK_NUM; i++)</span><br><span class="line">		<span class="keyword">if</span> (dev-&gt;link[i].is_on)</span><br><span class="line">			cif_show_dev_attr(m, &amp;dev-&gt;link[i].attr);</span><br><span class="line"></span><br><span class="line">	seq_puts(m, <span class="string">&quot;\n------------MIPI info-------------------\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_LINK_NUM; i++)</span><br><span class="line">		<span class="keyword">if</span> (dev-&gt;link[i].is_on</span><br><span class="line">			&amp;&amp; (dev-&gt;link[i].attr.input_mode == INPUT_MODE_MIPI)) &#123;</span><br><span class="line">			cif_show_mipi_sts(m, &amp;dev-&gt;link[i]);</span><br><span class="line">			cif_show_phy_sts(m, &amp;dev-&gt;link[i]);</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> ssize_t <span class="title">cif_proc_write</span>(<span class="params"><span class="keyword">struct</span> file *file, <span class="keyword">const</span> <span class="built_in">char</span> __user *user_buf,</span></span></span><br><span class="line"><span class="params"><span class="function">          size_t count, loff_t *ppos</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> cvi_cif_dev *dev = PDE_DATA(file_inode(file));</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (KERNEL_VERSION(5, 10, 0) &lt;= LINUX_VERSION_CODE)</span></span><br><span class="line">	<span class="built_in">char</span> txt_buff[MAX_CIF_PROC_BUF];</span><br><span class="line"></span><br><span class="line">	count = simple_write_to_buffer(txt_buff, MAX_CIF_PROC_BUF, ppos,</span><br><span class="line">					user_buf, count);</span><br><span class="line"></span><br><span class="line">	dbg_hdler(dev, txt_buff);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	dbg_hdler(dev, user_buf);<span class="comment">//根据txt_buff做一些驱动流程控制，复位处理，时钟配置等等</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="built_in">int</span> <span class="title">proc_cif_open</span>(<span class="params"><span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *file</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">struct</span> cvi_cif_dev *dev = PDE_DATA(inode);</span><br><span class="line">	<span class="keyword">return</span> single_open(file, proc_cif_show, dev);<span class="comment">//proc_cif_show 输出cif驱动状态信息</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (KERNEL_VERSION(5, 10, 0) &lt;= LINUX_VERSION_CODE)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> proc_ops cif_proc_fops = &#123;</span><br><span class="line">	.proc_open		= proc_cif_open,</span><br><span class="line">	.proc_read		= seq_read,</span><br><span class="line">	.proc_write		= cif_proc_write,</span><br><span class="line">	.proc_lseek		= seq_lseek,</span><br><span class="line">	.proc_release	= single_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct</span> file_operations cif_proc_fops = &#123;</span><br><span class="line">	.owner		= THIS_MODULE,</span><br><span class="line">	.open		= proc_cif_open,</span><br><span class="line">	.read		= seq_read,</span><br><span class="line">	.write		= cif_proc_write,</span><br><span class="line">	.llseek		= seq_lseek,</span><br><span class="line">	.release	= single_release,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#ifdef CONFIG_PROC_FS</span></span><br><span class="line">		cif_proc_entry = proc_create_data(CIF_PROC_NAME, <span class="number">0</span>, NULL,</span><br><span class="line">						&amp;cif_proc_fops, dev);</span><br><span class="line">		<span class="keyword">if</span> (!cif_proc_entry)</span><br><span class="line">			dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;cif: can&#x27;t init procfs.\n&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>1.先创建proc条目:</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/1.png" alt="image-20240910223622694"></p>
<p>2.实现<code>proc_ops</code>中的成员函数，主要是<code>.proc_open</code>和<code>.proc_write</code>。注意这里当我们Linux内核版本超过5.10，叫做<code>proc_ops</code>, 否则还是叫做<code>file_operations</code>.</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/2.png" alt="image-20240910224117513"></p>
<p><code>procfs</code>通常会和<code>seq_file</code>接口一起使用。<code>seq_file</code>是一个序列文件接口，当我们创建的proc数据内容由一系列数据顺序组合而成或者是比较大的proc文件系统时，都建议使用<code>seq_file</code>接口，例如<code>cat /proc/meminfo</code>就会显示很多内容。</p>
<p><code>seq_file</code>接口主要就是解决proc接口编程存在的问题，推荐在proc接口编程时使用<code>seq_file</code>接口，另外<code>.read、.llseek、.release</code>成员函数也可以直接用<code>seq_read、seq_lseek和seq_release</code>。</p>
<h4><span id="1-2-2-1-seq-ji-zhi">1.2.2.1 seq机制</span><a href="#1-2-2-1-seq-ji-zhi" class="header-anchor">#</a></h4><p>当用户顺序读取<code>proc</code>接口时, 比如<code>cat /proc/v4l2/mipi-rx</code>, <code>proc_cif_open</code>被调用，然后调用<code>seq_read</code>。和应用程序一样，操作一个文件就是<code>open, read, close</code>操作…</p>
<h5><span id="1-2-2-1-0-sigle-open">1.2.2.1.0 sigle_open</span><a href="#1-2-2-1-0-sigle-open" class="header-anchor">#</a></h5><p><code>proc_cif_open</code>调用<code>sigle_open</code>，<code>sigle_open</code>直接调用了<code>seq_open(file, op)</code>，该函数会创建个<code>seq_file</code>实例，并添加到<code>file-&gt;private_data</code>。</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/3.png" alt="image-20240910233011578"></p>
<p>还会创建一个<code>seq_operations *op</code>, 可以看到驱动设置的show函数<code>cif_proc_show</code>被给到op的成员函数show,其余几个成员函数赋值为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">op-&gt;start = single_start;</span><br><span class="line">op-&gt;next = single_next;</span><br><span class="line">op-&gt;stop = single_stop;</span><br><span class="line">op-&gt;show = show;</span><br></pre></td></tr></table></figure>

<p>继续看<code>seq_open</code>，把前面的<code>seq_operations *op</code>实例给到<code>seq_file *p-&gt;op</code>。</p>
<h5><span id="1-2-2-1-1-seq-file-ji-chu">1.2.2.1.1 seq_file基础</span><a href="#1-2-2-1-1-seq-file-ji-chu" class="header-anchor">#</a></h5><p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/4.png" alt="image-20240910232328785"></p>
<p>open完后，好接着调用<code>seq_read</code>。seq机制实现见：</p>
<p><code>Y:\linux_5.10\fs\seq_file.c</code></p>
<p><code>Y:\linux_5.10\include\linux\seq_file.h</code></p>
<h5><span id="1-2-2-1-2-seq-read">1.2.2.1.2 seq_read</span><a href="#1-2-2-1-2-seq-read" class="header-anchor">#</a></h5><p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/5.png" alt="image-20240910234459044"></p>
<p>可以看到不就是调用<code>sigle_open</code>时注册的<code>single_start, single_next</code>函数嘛，包括驱动自己注册的show函数，我这里是<code>cif_proc_show</code>.</p>
<p>网上找了一份图总结了seq机制：</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/6.jpeg" alt="img"></p>
<h2><span id="1-3-debugfs">1.3 debugfs</span><a href="#1-3-debugfs" class="header-anchor">#</a></h2><p>debugfs也是一种用来调试内核的内存文件系统，内核开发者可以通过debugfs和用户空间交换数据，有点类似于前文提到的procfs和sysfs。</p>
<p>procfs是为了反映系统以及进程的状态信息<strong>，</strong>sysfs用于Linux设备驱动模型：</p>
<p>把私有的调试信息加入这两个虚拟文件系统不太合适，<strong>因此内核多添加了一个虚拟文件系统，也就是debugfs。</strong></p>
<p>最常见的就是linux内核的<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/14785734.html">dynamic debug</a>  <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/">dynamic_debug-hexo</a> 可以在程序运行后动态开关模块的打印，甚至是具体某个文件，某个函数的打印。</p>
<h3><span id="1-3-1-debugfs-api">1.3.1 debugfs API</span><a href="#1-3-1-debugfs-api" class="header-anchor">#</a></h3><p>debufs文件系统中有不少API函数可以使用，它们定义在<code>include/linux/debugfs.h</code>头文件中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">debugfs_create_dir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name,<span class="keyword">struct</span> dentry *parent)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">debugfs_remove</span><span class="params">(<span class="keyword">struct</span> dentry *dentry)</span></span><br><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">debugfs_create_blob</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">umode_t</span> mode,<span class="keyword">struct</span> dentry *parent,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> debugfs_blob_wrapper *blob)</span></span><br><span class="line"><span class="keyword">struct</span> dentry *<span class="title function_">debugfs_create_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">umode_t</span> mode,<span class="keyword">struct</span> dentry *parent,</span></span><br><span class="line"><span class="params">              <span class="type">void</span> *data,<span class="type">const</span> <span class="keyword">struct</span> file_operations *fops)</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-3-2-debugfs-shi-li">1.3.2 debugfs 示例</span><a href="#1-3-2-debugfs-shi-li" class="header-anchor">#</a></h3><p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/7.png" alt="image-20240911203637060"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_FS</span></span><br><span class="line">	<span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">vpu_debug_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *user_buf,</span></span><br><span class="line"><span class="params">					  <span class="type">size_t</span> count, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">char</span> buf[<span class="number">256</span>];</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> len;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> running, pc, vpu_to_host, host_to_vpu, wdt;</span><br><span class="line">		<span class="type">int</span> ret;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> file-&gt;private_data;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">mtk_vpu</span> *<span class="title">vpu</span> =</span> dev_get_drvdata(dev);</span><br><span class="line">	</span><br><span class="line">		ret = vpu_clock_enable(vpu);</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			dev_err(vpu-&gt;dev, <span class="string">&quot;[VPU] enable clock failed %d\n&quot;</span>, ret);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">/* vpu register status */</span></span><br><span class="line">		running = vpu_running(vpu);</span><br><span class="line">		pc = vpu_cfg_readl(vpu, VPU_PC_REG);</span><br><span class="line">		wdt = vpu_cfg_readl(vpu, VPU_WDT_REG);</span><br><span class="line">		host_to_vpu = vpu_cfg_readl(vpu, HOST_TO_VPU);</span><br><span class="line">		vpu_to_host = vpu_cfg_readl(vpu, VPU_TO_HOST);</span><br><span class="line">		vpu_clock_disable(vpu);</span><br><span class="line">	</span><br><span class="line">		<span class="keyword">if</span> (running) &#123;</span><br><span class="line">			len = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;VPU is running\n\n&quot;</span></span><br><span class="line">			<span class="string">&quot;FW Version: %s\n&quot;</span></span><br><span class="line">			<span class="string">&quot;PC: 0x%x\n&quot;</span></span><br><span class="line">			<span class="string">&quot;WDT: 0x%x\n&quot;</span></span><br><span class="line">			<span class="string">&quot;Host to VPU: 0x%x\n&quot;</span></span><br><span class="line">			<span class="string">&quot;VPU to Host: 0x%x\n&quot;</span>,</span><br><span class="line">			vpu-&gt;run.fw_ver, pc, wdt,</span><br><span class="line">			host_to_vpu, vpu_to_host);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			len = <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;VPU not running\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> simple_read_from_buffer(user_buf, count, ppos, buf, len);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">vpu_debugfs</span>;</span></span><br><span class="line">	<span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">vpu_debug_fops</span> =</span> &#123;</span><br><span class="line">		.open = simple_open,</span><br><span class="line">		.read = vpu_debug_read,</span><br><span class="line">	&#125;;</span><br><span class="line">	vpu_debugfs = debugfs_create_file(<span class="string">&quot;mtk_vpu&quot;</span>, S_IRUGO, <span class="literal">NULL</span>, (<span class="type">void</span> *)dev,</span><br><span class="line">					  &amp;vpu_debug_fops);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>很简单，就是调用<code>debugfs_create_file</code>后会在<code>debugfs</code>挂载目录下也就是<code>/sys/kernel/debug/</code>建立一个<code>mtk_vpu</code>文件。</p>
<p>当<code>cat /sys/kernel/debug/mtk_vpu</code>会打开该文件，也就是调用<code>simple_open</code>，然后调用<code>vpu_debug_read</code>，进一步调用<code>simple_read_from_buffer</code>：</p>
<p><img src="/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/8.png" alt="image-20240911204546367"></p>
<p>你可以规定<code>/sys/kernel/debug/mtk_vpu</code>文件的格式和信息，这里它是dump了一些寄存器信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">VPU_PC_REG</span><br><span class="line">VPU_WDT_REG</span><br><span class="line">HOST_TO_VPU</span><br><span class="line">VPU_TO_HOST</span><br></pre></td></tr></table></figure>

<p>当然你也可以不用<code>simple_open</code>这一套机制，那就要你自己去实现<code>vpu_debug_fops</code>中的成员函数,自己去调用<code>copy_to_user</code>。这里是利用<code>simple_open, simple_read</code>机制帮忙简化了，不需要去调用<code>copy_to_user</code>。</p>
<p><code>simple_open,simple_read</code>机制见：<code>Y:linux_5.10\fs\libfs.c</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/07/23/Linux%E4%B8%8Bsysfs-procfs-debugfs%E4%BD%BF%E7%94%A8/" data-id="cm0xxvjfx0000wwuffceacspj" data-title="Linux下sysfs-procfs-debugfs使用" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/07/24/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-1-GPIO%E9%A9%B1%E5%8A%A8LED%E7%A4%BA%E4%BE%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          字符设备驱动-1-GPIO驱动LED示例
        
      </div>
    </a>
  
  
    <a href="/2024/07/23/buildroot%E6%95%99%E7%A8%8B/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">buildroot教程</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 15.45px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-IIO子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-regmap%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-regmap子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-UART%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-UART子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-RTC%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-RTC子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
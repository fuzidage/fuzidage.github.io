<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>字符设备驱动-gpio子系统 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 gpio 子系统引入 2 gpio子系统架构 2.0 gpio控制器源码分析 2.0.1 probe分析 2.0.1.0 mxc_gpio_get_hw 2.0.1.1 get resource and ioremap 2.0.1.2 bgpio_init 2.0.1.3 devm_gpiochip_add_data     2.1 gpio子系统数据结构 2.1.1 gpio_de">
<meta property="og:type" content="article">
<meta property="og:title" content="字符设备驱动-gpio子系统">
<meta property="og:url" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 gpio 子系统引入 2 gpio子系统架构 2.0 gpio控制器源码分析 2.0.1 probe分析 2.0.1.0 mxc_gpio_get_hw 2.0.1.1 get resource and ioremap 2.0.1.2 bgpio_init 2.0.1.3 devm_gpiochip_add_data     2.1 gpio子系统数据结构 2.1.1 gpio_de">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png">
<meta property="og:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png">
<meta property="article:published_time" content="2024-08-17T12:14:37.000Z">
<meta property="article:modified_time" content="2024-08-31T06:49:48.920Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-字符设备驱动-gpio子系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2024-08-17T12:14:37.000Z" itemprop="datePublished">2024-08-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      字符设备驱动-gpio子系统
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-gpio-zi-xi-tong-yin-ru">1 gpio 子系统引入</a></li>
<li><a href="#2-gpio-zi-xi-tong-jia-gou">2 gpio子系统架构</a><ul>
<li><a href="#2-0-gpio-kong-zhi-qi-yuan-ma-fen-xi">2.0 gpio控制器源码分析</a><ul>
<li><a href="#2-0-1-probe-fen-xi">2.0.1 probe分析</a><ul>
<li><a href="#2-0-1-0-mxc-gpio-get-hw">2.0.1.0 mxc_gpio_get_hw</a></li>
<li><a href="#2-0-1-1-get-resource-and-ioremap">2.0.1.1 get resource and ioremap</a></li>
<li><a href="#2-0-1-2-bgpio-init">2.0.1.2 bgpio_init</a></li>
<li><a href="#2-0-1-3-devm-gpiochip-add-data">2.0.1.3 devm_gpiochip_add_data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-1-gpio-zi-xi-tong-shu-ju-jie-gou">2.1 gpio子系统数据结构</a><ul>
<li><a href="#2-1-1-gpio-device">2.1.1 gpio_device</a></li>
<li><a href="#2-1-2-gpio-chip">2.1.2 gpio_chip</a></li>
<li><a href="#2-1-3-gpio-desc">2.1.3 gpio_desc</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-gpio-zi-xi-tong-api">3 gpio子系统api</a><ul>
<li><a href="#3-1-shi-yong-zheng-shu-de-gpio-chuan-tong-fang-shi">3.1使用整数的GPIO传统方式</a><ul>
<li><a href="#3-1-1-qing-qiu-he-pei-zhi">3.1.1 请求和配置</a></li>
<li><a href="#3-1-2-du-qu-he-she-zhi-zhi">3.1.2 读取和设置值</a></li>
<li><a href="#3-1-3-gpiochip-cao-zuo">3.1.3 gpiochip操作</a></li>
</ul>
</li>
<li><a href="#3-2-ji-yu-miao-shu-fu-de-gpio-fang-shi">3.2 基于描述符的GPIO方式</a></li>
<li><a href="#3-3-he-she-bei-shu-xiang-guan-gpio-jie-kou">3.3 和设备树相关GPIO接口</a></li>
</ul>
</li>
<li><a href="#4-ji-yu-sysfs-cao-zuo-gpio">4 基于sysfs操作gpio</a></li>
<li><a href="#5-gpio-zi-xi-tong-shi-li">5 gpio子系统示例</a><ul>
<li><a href="#5-1-gpio-kong-zhi-qi-dts-miao-shu">5.1 gpio控制器dts描述</a></li>
<li><a href="#5-2-gpio-kong-zhi-qi-shi-yong-zhe">5.2 gpio控制器使用者</a><ul>
<li><a href="#5-2-1-shi-yong-zhe-cao-zuo-liu-cheng">5.2.1 使用者操作流程</a><ul>
<li><a href="#5-2-1-1-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo1-gpio-led">5.2.1.1 dts自定义gpio控制器使用者（demo1,gpio_led）</a></li>
<li><a href="#5-2-1-2-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo2-beep">5.2.1.2 dts自定义gpio控制器使用者（demo2,beep）</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-gpio-zi-xi-tong-yin-ru">1 gpio 子系统引入</span><a href="#1-gpio-zi-xi-tong-yin-ru" class="header-anchor">#</a></h1><p>如果 <code>pinctrl </code>子系统将一个 PIN 复用为 GPIO 的话，那么接下来要用到 gpio 子系统了。gpio 子系统顾名思义，就是用于初始化 GPIO 并且提供相应的 API 函数，比如设置 GPIO为输入输出，设置读取 GPIO 的值等。</p>
<p>gpio 子系统的主要目的就是方便驱动开发者使用 gpio，驱动开发者在设备树中添加 gpio 相关信息，然后就可以在驱动程序中使用 gpio 子系统提供的 API函数来操作 GPIO，Linux 内核向驱动开发者屏蔽掉了 GPIO 的设置过程，极大的方便了驱动开发者使用 GPIO。</p>
<h1><span id="2-gpio-zi-xi-tong-jia-gou">2 gpio子系统架构</span><a href="#2-gpio-zi-xi-tong-jia-gou" class="header-anchor">#</a></h1><p>Linux的GPIO子系统驱动框架由三个主要部分组成：① GPIO控制器驱动程序、②gpio lib驱动程序 ③GPIO字符设备驱动程序：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png" alt="image-20240817202346143"><br>使用<code>gpiochip_add/gpiochip_add_data</code>向系统<code>注册gpio_chip</code>, 这些都是半导体原厂要做的，设备商只需要使用即可。</p>
<h2><span id="2-0-gpio-kong-zhi-qi-yuan-ma-fen-xi">2.0 gpio控制器源码分析</span><a href="#2-0-gpio-kong-zhi-qi-yuan-ma-fen-xi" class="header-anchor">#</a></h2><p><code>drivers/gpio/gpio-mxc.c</code> 就是 I.MX6ULL的 GPIO 控制器驱动文件，在此文件中有如下所示<code>of_device_id</code> 匹配表:<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png" alt="image"><br>对照<code>imx6ull.dtsi</code>的gpio控制器可以看到能匹配：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png" alt="image"></p>
<p>打开<code>drivers/gpio/gpio-mxc.c</code>：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png" alt="image"><br>probe函数内容如下：</p>
<details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">mxc_gpio_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> pdev-&gt;dev.of_node;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mxc_gpio_port</span> *<span class="title">port</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">resource</span> *<span class="title">iores</span>;</span></span><br><span class="line">	<span class="type">int</span> irq_base = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">	mxc_gpio_get_hw(pdev);</span><br><span class="line"></span><br><span class="line">	port = devm_kzalloc(&amp;pdev-&gt;dev, <span class="keyword">sizeof</span>(*port), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!port)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	iores = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line">	port-&gt;base = devm_ioremap_resource(&amp;pdev-&gt;dev, iores);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(port-&gt;base))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(port-&gt;base);</span><br><span class="line"></span><br><span class="line">	port-&gt;irq_high = platform_get_irq(pdev, <span class="number">1</span>);</span><br><span class="line">	port-&gt;irq = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (port-&gt;irq &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> port-&gt;irq;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* the controller clock is optional */</span></span><br><span class="line">	port-&gt;clk = devm_clk_get(&amp;pdev-&gt;dev, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(port-&gt;clk))</span><br><span class="line">		port-&gt;clk = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	err = clk_prepare_enable(port-&gt;clk);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;Unable to enable clock.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pm_runtime_set_active(&amp;pdev-&gt;dev);</span><br><span class="line">	pm_runtime_enable(&amp;pdev-&gt;dev);</span><br><span class="line">	err = pm_runtime_get_sync(&amp;pdev-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_pm_dis;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* disable the interrupt and clear the status */</span></span><br><span class="line">	writel(<span class="number">0</span>, port-&gt;base + GPIO_IMR);</span><br><span class="line">	writel(~<span class="number">0</span>, port-&gt;base + GPIO_ISR);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mxc_gpio_hwtype == IMX21_GPIO) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Setup one handler for all GPIO interrupts. Actually setting</span></span><br><span class="line"><span class="comment">		 * the handler is needed only once, but doing it for every port</span></span><br><span class="line"><span class="comment">		 * is more robust and easier.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		irq_set_chained_handler(port-&gt;irq, mx2_gpio_irq_handler);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">/* setup one handler for each entry */</span></span><br><span class="line">		irq_set_chained_handler_and_data(port-&gt;irq,</span><br><span class="line">						 mx3_gpio_irq_handler, port);</span><br><span class="line">		<span class="keyword">if</span> (port-&gt;irq_high &gt; <span class="number">0</span>)</span><br><span class="line">			<span class="comment">/* setup handler for GPIO 16 to 31 */</span></span><br><span class="line">			irq_set_chained_handler_and_data(port-&gt;irq_high,</span><br><span class="line">							 mx3_gpio_irq_handler,</span><br><span class="line">							 port);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = bgpio_init(&amp;port-&gt;gc, &amp;pdev-&gt;dev, <span class="number">4</span>,</span><br><span class="line">			 port-&gt;base + GPIO_PSR,</span><br><span class="line">			 port-&gt;base + GPIO_DR, <span class="literal">NULL</span>,</span><br><span class="line">			 port-&gt;base + GPIO_GDIR, <span class="literal">NULL</span>,</span><br><span class="line">			 BGPIOF_READ_OUTPUT_REG_SET);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_bgio;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_property_read_bool(np, <span class="string">&quot;gpio_ranges&quot;</span>))</span><br><span class="line">		port-&gt;gpio_ranges = <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		port-&gt;gpio_ranges = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	port-&gt;gc.request = mxc_gpio_request;</span><br><span class="line">	port-&gt;gc.<span class="built_in">free</span> = mxc_gpio_free;</span><br><span class="line">	port-&gt;gc.parent = &amp;pdev-&gt;dev;</span><br><span class="line">	port-&gt;gc.to_irq = mxc_gpio_to_irq;</span><br><span class="line">	port-&gt;gc.base = (pdev-&gt;id &lt; <span class="number">0</span>) ? of_alias_get_id(np, <span class="string">&quot;gpio&quot;</span>) * <span class="number">32</span> :</span><br><span class="line">					     pdev-&gt;id * <span class="number">32</span>;</span><br><span class="line"></span><br><span class="line">	err = devm_gpiochip_add_data(&amp;pdev-&gt;dev, &amp;port-&gt;gc, port);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_bgio;</span><br><span class="line"></span><br><span class="line">	irq_base = irq_alloc_descs(<span class="number">-1</span>, <span class="number">0</span>, <span class="number">32</span>, numa_node_id());</span><br><span class="line">	<span class="keyword">if</span> (irq_base &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		err = irq_base;</span><br><span class="line">		<span class="keyword">goto</span> out_bgio;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	port-&gt;domain = irq_domain_add_legacy(np, <span class="number">32</span>, irq_base, <span class="number">0</span>,</span><br><span class="line">					     &amp;irq_domain_simple_ops, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!port-&gt;domain) &#123;</span><br><span class="line">		err = -ENODEV;</span><br><span class="line">		<span class="keyword">goto</span> out_irqdesc_free;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* gpio-mxc can be a generic irq chip */</span></span><br><span class="line">	err = mxc_gpio_init_gc(port, irq_base, &amp;pdev-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_irqdomain_remove;</span><br><span class="line"></span><br><span class="line">	list_add_tail(&amp;port-&gt;node, &amp;mxc_gpio_ports);</span><br><span class="line"></span><br><span class="line">	platform_set_drvdata(pdev, port);</span><br><span class="line">	pm_runtime_put(&amp;pdev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_pm_dis:</span><br><span class="line">	pm_runtime_disable(&amp;pdev-&gt;dev);</span><br><span class="line">	clk_disable_unprepare(port-&gt;clk);</span><br><span class="line">out_irqdomain_remove:</span><br><span class="line">	irq_domain_remove(port-&gt;domain);</span><br><span class="line">out_irqdesc_free:</span><br><span class="line">	irq_free_descs(irq_base, <span class="number">32</span>);</span><br><span class="line">out_bgio:</span><br><span class="line">	dev_info(&amp;pdev-&gt;dev, <span class="string">&quot;%s failed with errno %d\n&quot;</span>, __func__, err);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</details>

<h3><span id="2-0-1-probe-fen-xi">2.0.1 probe分析</span><a href="#2-0-1-probe-fen-xi" class="header-anchor">#</a></h3><p>里面定义了一个很重要的结构体<code>mxc_gpio_port</code> 就是对<code> I.MX6ULL GPIO</code> 的抽象。<code>mxc_gpio_port </code>结构体定义如下：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png" alt="image"><br><code>mxc_gpio_probe</code>又会继续调用<code>mxc_gpio_get_hw</code>获取gpio的硬件相关数据，也就是gpio组，gpio1.gpio2等。</p>
<h4><span id="2-0-1-0-mxc-gpio-get-hw">2.0.1.0 mxc_gpio_get_hw</span><a href="#2-0-1-0-mxc-gpio-get-hw" class="header-anchor">#</a></h4><p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png" alt="image"></p>
<p>我们imx6ull gpio<code>控制器类型</code>就是<code>imx35系列</code>。因此选用<code>imx35_gpio_hwdata</code>，如下：可以看出这些成员不就是对应寄存器的偏移量吗？</p>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png" alt="image"><br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png" alt="image"></p>
<h4><span id="2-0-1-1-get-resource-and-ioremap">2.0.1.1 get resource and ioremap</span><a href="#2-0-1-1-get-resource-and-ioremap" class="header-anchor">#</a></h4><p>比如我们probe中通过<code>platform_get_resource</code> 获取<code>gpio1</code>的<code>基地址为0X0209,C000</code>，那么就可以通过配置<code>mxc_gpio_hwdata</code>结构体成员来配置寄存器。</p>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png" alt="image"></p>
<p>然后调用 <code>devm_ioremap_resource</code> 函数进行内存映射，得到 <code>0x0209C000</code> 在 Linux 内核中的虚拟地址。<br>然后<code>platform_get_irq</code> 函数获取中断号，分为获取高 16 位 GPIO 的中断号，和获取低 16 位 GPIO 中断号。</p>
<p>操作 GPIO1 的 <code>IMR</code> 和 <code>ISR</code> 这两个寄存器，关闭 GPIO1 所有 IO 中断，并且清除状态寄存器:<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png" alt="image"></p>
<p>设置对应 GPIO 的中断服务函数，不管是高 16 位还是低 16 位，中断服务函数都是 <code>mx3_gpio_irq_handler</code>:<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png" alt="image"></p>
<h4><span id="2-0-1-2-bgpio-init">2.0.1.2 bgpio_init</span><a href="#2-0-1-2-bgpio-init" class="header-anchor">#</a></h4><p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png" alt="image"></p>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png" alt="image-20240817211118974"></p>
<p>调用<code>bgpio_init</code> 函数主 要 任 务 就 是 初 始 化<code> port-&gt;gc, (gc就是gpio_chip)</code>。顾名思义<code>bgpio_init</code>就是<code>basic gpio init</code>，里 面 有 三 个 <code>setup</code> 函 数 :</p>
<ol>
<li><code>bgpio_setup_io</code> </li>
<li><code>bgpio_setup_accessors</code> </li>
<li><code>bgpio_setup_direction</code>。这三个函数就是初始化 <code>port-&gt;gc</code> 中的各种有关GPIO 的操作，比如输出，输入等等。</li>
</ol>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png" alt="image-20240817213544044"></p>
<h4><span id="2-0-1-3-devm-gpiochip-add-data">2.0.1.3 devm_gpiochip_add_data</span><a href="#2-0-1-3-devm-gpiochip-add-data" class="header-anchor">#</a></h4><p>调用<code>devm_gpiochip_add_data</code>注册这个port。gpio控制器就成功注册给了gpio子系统。<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png" alt="image"></p>
<p>至此，<code>port-&gt;gc</code>既有了对 GPIO 的操作函数，又有了 I.MX6ULL 有关 GPIO的寄存器，那么只要得到 port 就可以对 I.MX6ULL 的 GPIO 进行操作。</p>
<h2><span id="2-1-gpio-zi-xi-tong-shu-ju-jie-gou">2.1 gpio子系统数据结构</span><a href="#2-1-gpio-zi-xi-tong-shu-ju-jie-gou" class="header-anchor">#</a></h2><h3><span id="2-1-1-gpio-device">2.1.1 gpio_device</span><a href="#2-1-1-gpio-device" class="header-anchor">#</a></h3><p>每个<code>GPIO Controller</code>用一个<code>gpio_device</code>来表示:</p>
<ol>
<li>每组gpio引脚对应一个<code>gpio_desc</code>和一个<code>gpio_chip</code></li>
<li>gpio引脚的操作函数，都放在<code>gpio_chip</code>成员函数中。</li>
</ol>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png" alt="image-20240818143429583"></p>
<h3><span id="2-1-2-gpio-chip">2.1.2 gpio_chip</span><a href="#2-1-2-gpio-chip" class="header-anchor">#</a></h3><p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png" alt="image-20240818140515596"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_chip</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*label;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_device</span>	*<span class="title">gpiodev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		*<span class="title">parent</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>		*<span class="title">owner</span>;</span></span><br><span class="line">	<span class="type">int</span>			(*request)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);<span class="comment">//请求一个 GPIO 引脚</span></span><br><span class="line">	<span class="type">void</span>			(*<span class="built_in">free</span>)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);<span class="comment">//释放一个之前请求的 GPIO 引脚</span></span><br><span class="line">	<span class="type">int</span>			(*get_direction)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);<span class="comment">//获取方向</span></span><br><span class="line">	<span class="type">int</span>			(*direction_input)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);<span class="comment">//输入模式</span></span><br><span class="line">	<span class="type">int</span>			(*direction_output)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset, <span class="type">int</span> value);<span class="comment">//输出模式，并且set gpio val</span></span><br><span class="line">	<span class="type">int</span>			(*get)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);<span class="comment">//读取 GPIO 引脚的值</span></span><br><span class="line">	<span class="type">void</span>			(*<span class="built_in">set</span>)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset, <span class="type">int</span> value);<span class="comment">//设置gpio 引脚值</span></span><br><span class="line">	<span class="type">void</span>			(*set_multiple)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *mask,</span><br><span class="line">						<span class="type">unsigned</span> <span class="type">long</span> *bits);</span><br><span class="line">	<span class="type">int</span>			(*set_debounce)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset,</span><br><span class="line">						<span class="type">unsigned</span> debounce);<span class="comment">//设置 GPIO 引脚的去抖动时间</span></span><br><span class="line">	<span class="type">int</span>			(*set_single_ended)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset,</span><br><span class="line">						<span class="keyword">enum</span> single_ended_mode mode);</span><br><span class="line">	<span class="type">int</span>			(*to_irq)(<span class="keyword">struct</span> gpio_chip *chip,</span><br><span class="line">						<span class="type">unsigned</span> offset);</span><br><span class="line">	<span class="type">void</span>			(*dbg_show)(<span class="keyword">struct</span> seq_file *s,</span><br><span class="line">						<span class="keyword">struct</span> gpio_chip *chip);<span class="comment">//调试目的，显示 GPIO 引脚的状态</span></span><br><span class="line">	<span class="type">int</span>			base;<span class="comment">//chip的基地址</span></span><br><span class="line">	u16			ngpio;<span class="comment">//GPIO 引脚数量</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*<span class="type">const</span> *names;</span><br><span class="line">	<span class="type">bool</span>			can_sleep;</span><br><span class="line">	<span class="type">bool</span>			irq_not_threaded;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> IS_ENABLED(CONFIG_GPIO_GENERIC)<span class="comment">// bgpio使能</span></span></span><br><span class="line">	<span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*read_reg)</span><span class="params">(<span class="type">void</span> __iomem *reg)</span>;</span><br><span class="line">	<span class="type">void</span> (*write_reg)(<span class="type">void</span> __iomem *reg, <span class="type">unsigned</span> <span class="type">long</span> data);</span><br><span class="line">	<span class="type">unsigned</span> <span class="title function_">long</span> <span class="params">(*pin2mask)</span><span class="params">(<span class="keyword">struct</span> gpio_chip *gc, <span class="type">unsigned</span> <span class="type">int</span> pin)</span>;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_dat;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_set;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_clr;</span><br><span class="line">	<span class="type">void</span> __iomem *reg_dir;</span><br><span class="line">	<span class="type">int</span> bgpio_bits;</span><br><span class="line">	<span class="type">spinlock_t</span> bgpio_lock;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bgpio_data;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bgpio_dir;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_GPIOLIB_IRQCHIP</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>		*<span class="title">irqchip</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_domain</span>	*<span class="title">irqdomain</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		irq_base;</span><br><span class="line">	<span class="type">irq_flow_handler_t</span>	irq_handler;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		irq_default_type;</span><br><span class="line">	<span class="type">int</span>			irq_parent;</span><br><span class="line">	<span class="type">bool</span>			irq_need_valid_mask;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		*irq_valid_mask;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">lock_class_key</span>	*<span class="title">lock_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_OF_GPIO)</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">of_node</span>;</span></span><br><span class="line">	<span class="type">int</span> of_gpio_n_cells;<span class="comment">//dts描述几个cells构成</span></span><br><span class="line">	<span class="type">int</span> (*of_xlate)(<span class="keyword">struct</span> gpio_chip *gc,</span><br><span class="line">			<span class="type">const</span> <span class="keyword">struct</span> of_phandle_args *gpiospec, u32 *flags);<span class="comment">//设备树中 GPIO 引脚的转换</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3><span id="2-1-3-gpio-desc">2.1.3 gpio_desc</span><a href="#2-1-3-gpio-desc" class="header-anchor">#</a></h3><p>在<code>gpio_device</code>中有一个<code>gpio_desc</code>数组，每一引脚有一项<code>gpio_desc</code>。</p>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png" alt="image-20240818145531275"></p>
<h1><span id="3-gpio-zi-xi-tong-api">3 gpio子系统api</span><a href="#3-gpio-zi-xi-tong-api" class="header-anchor">#</a></h1><h2><span id="3-1-shi-yong-zheng-shu-de-gpio-chuan-tong-fang-shi">3.1使用整数的GPIO传统方式</span><a href="#3-1-shi-yong-zheng-shu-de-gpio-chuan-tong-fang-shi" class="header-anchor">#</a></h2><h3><span id="3-1-1-qing-qiu-he-pei-zhi">3.1.1 请求和配置</span><a href="#3-1-1-qing-qiu-he-pei-zhi" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求和释放GPIO</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_request</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">const</span> <span class="type">char</span>* label)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_free</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断gpio释放可用</span></span><br><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">gpio_is_valid</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置gpio为输入还是输出</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_direction_input</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_direction_output</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">int</span> value)</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置gpio的去抖动时间，其中debounce以ms为单位</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_set_debounce</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">unsigned</span> debounce)</span>;</span><br></pre></td></tr></table></figure>

<h3><span id="3-1-2-du-qu-he-she-zhi-zhi">3.1.2 读取和设置值</span><a href="#3-1-2-du-qu-he-she-zhi-zhi" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当gpio没有连接到I2C或SPI等慢速总线上，不会导致睡眠，可以在原子上下文中使用</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_get_value</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_set_value</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">int</span> value)</span>; <span class="comment">// value为bool值，0表示低电平，非0高电平</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以用gpio_can_sleep()判断gpio线是否可能睡眠</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">gpio_cansleep</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当gpio没有连接到I2C或SPI等慢速总线上，不会导致睡眠，可以在原子上下文中使用</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">gpio_get_value_cansleep</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpio_set_value_cansleep</span><span class="params">(<span class="type">unsigned</span> gpio, <span class="type">int</span> value)</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 当gpio映射到irq时，使用方式如下gpio_to_irq，返回irq号，接下来可以使用request_irq申请irq</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpio_to_irq</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">irq_to_gpio</span><span class="params">(<span class="type">int</span> irq)</span></span><br></pre></td></tr></table></figure>
<h3><span id="3-1-3-gpiochip-cao-zuo">3.1.3 gpiochip操作</span><a href="#3-1-3-gpiochip-cao-zuo" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">gpiochip_add</span><span class="params">(<span class="keyword">struct</span> gpio_chip *chip)</span><span class="comment">//注册一个gpio_chip结构体，它描述了一组GPIO引脚及其操作函数。</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpiochip_remove</span><span class="params">(<span class="keyword">struct</span> gpio_chip *chip)</span><span class="comment">//移除之前注册的gpio_chip。</span></span><br><span class="line"></span><br><span class="line">gpiochip_line_config<span class="comment">//配置gpio_chip中的特定引脚。</span></span><br><span class="line">gpiochip_request_own<span class="comment">//请求对gpio_chip中的引脚的所有权。</span></span><br><span class="line">gpiochip_request_unown<span class="comment">//释放对gpio_chip中的引脚的所有权。</span></span><br><span class="line">gpiochip_set<span class="comment">//为gpio_chip中的多个引脚设置值。</span></span><br><span class="line">gpiochip_clear<span class="comment">//清除gpio_chip中的多个引脚的值。</span></span><br><span class="line"></span><br><span class="line">gpiochip_set_direction<span class="comment">//为gpio_chip中的多个引脚设置方向。</span></span><br><span class="line">gpiochip_get_direction<span class="comment">//获取gpio_chip中引脚的方向。</span></span><br></pre></td></tr></table></figure>

<h2><span id="3-2-ji-yu-miao-shu-fu-de-gpio-fang-shi">3.2 基于描述符的GPIO方式</span><a href="#3-2-ji-yu-miao-shu-fu-de-gpio-fang-shi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">foo_device &#123;</span><br><span class="line">	compatible = <span class="string">&quot;acme,foo&quot;</span>;</span><br><span class="line">	[...];</span><br><span class="line">	led-gpios = &lt;&amp;gpio <span class="number">15</span> GPIO_ACTIVE_HIGH&gt; <span class="comment">//红色</span></span><br><span class="line">				&lt;&amp;gpio <span class="number">16</span> GPIO_ACTIVE_HIGH&gt; <span class="comment">//绿色</span></span><br><span class="line">				&lt;&amp;gpio <span class="number">17</span> GPIO_ACTIVE_HIGH&gt; <span class="comment">//蓝色</span></span><br><span class="line">				;</span><br><span class="line">	power-gpios = &lt;&amp;gpio <span class="number">1</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">	reset-gpios = &lt;&amp;gpio <span class="number">1</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在代码中获取GPIO的方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取gpio的代码</span></span><br><span class="line">sruct gpio_desc * <span class="title function_">gpiod_get_index</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">								<span class="keyword">enum</span> gpiod_flags flags)</span>;</span><br><span class="line">sruct gpio_desc * <span class="title function_">gpiod_get</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">char</span> *con_id,</span></span><br><span class="line"><span class="params">								<span class="keyword">enum</span> gpiod_flags flags)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">gpiod_put</span><span class="params">(sruct gpio_desc *desc)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用示例：</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">red</span>, *<span class="title">green</span>, *<span class="title">blue</span>, *<span class="title">power</span>, *<span class="title">reset</span>;</span></span><br><span class="line">red = gpiod_get_index(dev, <span class="string">&quot;led&quot;</span>, <span class="number">0</span>, GPIO_OUT_HIGH);</span><br><span class="line">green = gpiod_get_index(dev, <span class="string">&quot;led&quot;</span>, <span class="number">1</span>, GPIO_OUT_HIGH);</span><br><span class="line">blue = gpiod_get_index(dev, <span class="string">&quot;led&quot;</span>, <span class="number">2</span>, GPIO_OUT_HIGH);</span><br><span class="line"></span><br><span class="line">power = gpiod_get(dev, <span class="string">&quot;power&quot;</span>, GPIO_OUT_HIGH);</span><br><span class="line">reset = gpiod_get(dev, <span class="string">&quot;reset&quot;</span>, GPIO_OUT_HIGH);</span><br></pre></td></tr></table></figure>

<p>其他类似的功能函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gpiod_direction_input</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">gpiod_direction_output</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">int</span> value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpiod_set_debounce</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">unsigned</span> debounce)</span>;</span><br><span class="line"><span class="comment">// 输出逻辑1</span></span><br><span class="line"><span class="comment">// 在Active-High的情况下它会输出高电平</span></span><br><span class="line"><span class="comment">// 在Active-Low的情况下它会输出低电平</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpiod_set_value</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">gpiod_set_value_cansleep</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc, <span class="type">int</span> val)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gpiod_get_value</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">gpiod_get_value_cansleep</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 二者之间相互转换</span></span><br><span class="line"><span class="keyword">struct</span> gpio_desc *<span class="title function_">gpio_to_desc</span><span class="params">(<span class="type">unsigned</span> gpio)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">desc_to_gpio</span><span class="params">(<span class="keyword">struct</span> gpio_desc *desc)</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png" alt="image-20240818143109206"></p>
<p>无论是传统GPIO控制还是基于描述符的gpio方式，都是调用底层控制器gpio_chip的操作函数。</p>
<h2><span id="3-3-he-she-bei-shu-xiang-guan-gpio-jie-kou">3.3 和设备树相关GPIO接口</span><a href="#3-3-he-she-bei-shu-xiang-guan-gpio-jie-kou" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">gpio1: gpio1 &#123;</span><br><span class="line">	gpio-controller;</span><br><span class="line">	<span class="meta">#gpio-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">gpio2 : gpio2 &#123;</span><br><span class="line">	gpio-controller;</span><br><span class="line">	<span class="meta">#gpio-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line">foo-device &#123;</span><br><span class="line">	cs-gpios = &lt;&amp;gpio1 <span class="number">17</span> <span class="number">0</span>&gt;</span><br><span class="line">				&lt;&amp;gpio1 <span class="number">2</span>&gt;</span><br><span class="line">				&lt;&amp;gpio1 <span class="number">17</span> <span class="number">0</span>&gt;;</span><br><span class="line">	reset-gpio = &lt;&amp;gpio1 <span class="number">30</span> <span class="number">0</span>&gt;;</span><br><span class="line">	cs-gpios = &lt;&amp;gpio2 <span class="number">10</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在传统使用gpio的方式中，需要获取gpio编号，获取方式如下：</span></span><br><span class="line"><span class="type">int</span> n_gpios = of_get_named_gpio_count(dev.of_node, <span class="string">&quot;cs-gpios&quot;</span>);</span><br><span class="line"><span class="type">int</span> first_gpio = of_get_named_gpio(dev.of_node, <span class="string">&quot;cs-gpios&quot;</span>);</span><br></pre></td></tr></table></figure>
<h1><span id="4-ji-yu-sysfs-cao-zuo-gpio">4 基于sysfs操作gpio</span><a href="#4-ji-yu-sysfs-cao-zuo-gpio" class="header-anchor">#</a></h1><p><strong>声明GPIO口:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/class/gpio/export  <span class="comment">#/sys/class/gpio会生成gpio256目录</span></span><br><span class="line"><span class="built_in">echo</span> 256 &gt; /sys/class/gpio/unexport</span><br></pre></td></tr></table></figure>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png" alt="image"><br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png" alt="image"></p>
<p><strong>方向：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;in&quot;</span> &gt; direction    <span class="comment">#输入方向</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;out&quot;</span> &gt; direction   <span class="comment">#输出方向</span></span><br><span class="line"><span class="built_in">cat</span> direction</span><br></pre></td></tr></table></figure>
<p><strong>val:</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; value</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; value</span><br><span class="line"><span class="built_in">cat</span> value</span><br></pre></td></tr></table></figure>

<p><strong>edge:</strong><br>表示中断的触发方式，edge文件有如下四个值：<code>&quot;none&quot;, &quot;rising&quot;,&quot;falling&quot;，&quot;both&quot;</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">none：<span class="comment">#表示引脚为输入，不是中断引脚</span></span><br><span class="line">rising：<span class="comment">#表示引脚为中断输入，上升沿触发</span></span><br><span class="line">falling：<span class="comment">#表示引脚为中断输入，下降沿触发</span></span><br><span class="line">both：<span class="comment">#表示引脚为中断输入，边沿触发</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;both&quot;</span> &gt; /sys/class/gpio/gpioN/edge</span><br></pre></td></tr></table></figure>
<h1><span id="5-gpio-zi-xi-tong-shi-li">5 gpio子系统示例</span><a href="#5-gpio-zi-xi-tong-shi-li" class="header-anchor">#</a></h1><p>以<code>nxp</code>官方<code>evk</code>公板<code>imx6ull-14x14-evk.dts</code>为例：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png" alt="image"><br>重新定义了<code>iomuxc</code>引脚控制器，<code>evk</code>设备默认default状态对应的pins为<code>pinctrl_hog_1</code>, 配置3个引脚（<code>UART1_RTS_B, GPIO1_IO05, GPIO1_IO09</code>)信息。看起来是要做成sd卡的热插拔功能。<br>我们再找到描述sd的设备树节点：<code>usdhc1</code>和<code>usdhc2</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&amp;usdhc1 &#123;</span><br><span class="line">         pinctrl-names = <span class="string">&quot;default&quot;</span>, <span class="string">&quot;state_100mhz&quot;</span>, <span class="string">&quot;state_200mhz&quot;</span>;</span><br><span class="line">         pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_usdhc1&gt;;</span><br><span class="line">         pinctrl<span class="number">-1</span> = &lt;&amp;pinctrl_usdhc1_100mhz&gt;;</span><br><span class="line">         pinctrl<span class="number">-2</span> = &lt;&amp;pinctrl_usdhc1_200mhz&gt;;</span><br><span class="line">         cd-gpios = &lt;&amp;gpio1 <span class="number">19</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">         keep-power-in-suspend;</span><br><span class="line">         enable-sdio-wakeup;</span><br><span class="line">         vmmc-supply = &lt;&amp;reg_sd1_vmmc&gt;;</span><br><span class="line">         status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>iomuxc</code>控制器节点下有<code>usdhc1</code>要用的<code>pins</code>信息，包括<code>pinctrl_hog_1</code>，<code>pinctrl_usdhc1</code>，<code>pinctrl_usdhc1_100mhz</code>节点。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&amp;iomuxc &#123;</span><br><span class="line">     pinctrl_usdhc1: usdhc1grp &#123;</span><br><span class="line">             fsl,pins = &lt;</span><br><span class="line">                     MX6UL_PAD_SD1_CMD__USDHC1_CMD     <span class="number">0x17059</span></span><br><span class="line">                     MX6UL_PAD_SD1_CLK__USDHC1_CLK     <span class="number">0x10071</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA0__USDHC1_DATA0 <span class="number">0x17059</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA1__USDHC1_DATA1 <span class="number">0x17059</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA2__USDHC1_DATA2 <span class="number">0x17059</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA3__USDHC1_DATA3 <span class="number">0x17059</span></span><br><span class="line">             &gt;;</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     pinctrl_usdhc1_100mhz: usdhc1grp100mhz &#123;</span><br><span class="line">             fsl,pins = &lt;</span><br><span class="line">                     MX6UL_PAD_SD1_CMD__USDHC1_CMD     <span class="number">0x170b9</span></span><br><span class="line">                     MX6UL_PAD_SD1_CLK__USDHC1_CLK     <span class="number">0x100b9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA0__USDHC1_DATA0 <span class="number">0x170b9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA1__USDHC1_DATA1 <span class="number">0x170b9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA2__USDHC1_DATA2 <span class="number">0x170b9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA3__USDHC1_DATA3 <span class="number">0x170b9</span></span><br><span class="line">             &gt;;</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     pinctrl_usdhc1_200mhz: usdhc1grp200mhz &#123;</span><br><span class="line">             fsl,pins = &lt;</span><br><span class="line">                     MX6UL_PAD_SD1_CMD__USDHC1_CMD     <span class="number">0x170f9</span></span><br><span class="line">                     MX6UL_PAD_SD1_CLK__USDHC1_CLK     <span class="number">0x100f9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA0__USDHC1_DATA0 <span class="number">0x170f9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA1__USDHC1_DATA1 <span class="number">0x170f9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA2__USDHC1_DATA2 <span class="number">0x170f9</span></span><br><span class="line">                     MX6UL_PAD_SD1_DATA3__USDHC1_DATA3 <span class="number">0x170f9</span></span><br><span class="line">             &gt;;</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2><span id="5-1-gpio-kong-zhi-qi-dts-miao-shu">5.1 gpio控制器dts描述</span><a href="#5-1-gpio-kong-zhi-qi-dts-miao-shu" class="header-anchor">#</a></h2><p>前面讲的其实都还是<code>pinctrl</code>的内容，<code>usdhc1</code>有一个属性<code>cd-gpios</code>。这时就需要用到gpio控制器了，以<code>imx6ull</code>为例，gpio控制器描述如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">Linux<span class="number">-4.9</span><span class="number">.88</span>/Documentation/devicetree/bindings/gpio$ ls -l fsl-imx-gpio.txt</span><br><span class="line"></span><br><span class="line">   * Freescale i.MX/MXC GPIO controller</span><br><span class="line">  </span><br><span class="line">   Required properties:</span><br><span class="line">   - compatible : Should be <span class="string">&quot;fsl,&lt;soc&gt;-gpio&quot;</span></span><br><span class="line">   - reg : Address and length of the <span class="keyword">register</span> <span class="built_in">set</span> <span class="keyword">for</span> the device</span><br><span class="line">   - interrupts : Should be the port interrupt shared by all <span class="number">32</span> pins, <span class="keyword">if</span></span><br><span class="line">     one number.  If two numbers, the first one is the interrupt shared</span><br><span class="line">     by low <span class="number">16</span> pins and the second one is <span class="keyword">for</span> high <span class="number">16</span> pins.</span><br><span class="line">   - gpio-controller : Marks the device node as a gpio controller.</span><br><span class="line">  - <span class="meta">#gpio-cells : Should be two.  The first cell is the pin number and</span></span><br><span class="line">    the second cell is used to specify the gpio polarity:</span><br><span class="line">        <span class="number">0</span> = active high</span><br><span class="line">        <span class="number">1</span> = active low</span><br><span class="line">  - interrupt-controller: Marks the device node as an interrupt controller.</span><br><span class="line">  - <span class="meta">#interrupt-cells : Should be 2.  The first cell is the GPIO number.</span></span><br><span class="line">    The second cell bits[<span class="number">3</span>:<span class="number">0</span>] is used to specify trigger type and level flags:</span><br><span class="line">        <span class="number">1</span> = low-to-high edge triggered.</span><br><span class="line">        <span class="number">2</span> = high-to-low edge triggered.</span><br><span class="line">        <span class="number">4</span> = active high level-sensitive.</span><br><span class="line">        <span class="number">8</span> = active low level-sensitive.</span><br><span class="line"> </span><br><span class="line">  Example:</span><br><span class="line"> </span><br><span class="line">gpio0: gpio@<span class="number">73f</span>84000 &#123;</span><br><span class="line">        compatible = <span class="string">&quot;fsl,imx51-gpio&quot;</span>, <span class="string">&quot;fsl,imx35-gpio&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x73f84000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">        interrupts = &lt;<span class="number">50</span> <span class="number">51</span>&gt;;</span><br><span class="line">        gpio-controller;</span><br><span class="line">        <span class="meta">#gpio-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line">        interrupt-controller;</span><br><span class="line">        <span class="meta">#interrupt-cells = <span class="string">&lt;2&gt;</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>打开具体的<code>imx6ull.dtsi</code>:<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png" alt="image"><br>打开芯片参考书册，刚好对应gpio1控制器：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png" alt="image"></p>
<h2><span id="5-2-gpio-kong-zhi-qi-shi-yong-zhe">5.2 gpio控制器使用者</span><a href="#5-2-gpio-kong-zhi-qi-shi-yong-zhe" class="header-anchor">#</a></h2><p>回到<code>usdhc1</code>的属性<code>cd-gpios</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd-gpios = &lt;&amp;gpio1 <span class="number">19</span> GPIO_ACTIVE_LOW&gt;;</span><br></pre></td></tr></table></figure>

<p>表述使用gpio1控制器，由于该控制器的gpio-cells为2， 根据描述：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gpio-cells : Should be two.  The first cell is the pin number and</span></span><br><span class="line">the second cell is used to specify the gpio polarity:</span><br><span class="line">    0 = active high</span><br><span class="line">    1 = active low</span><br></pre></td></tr></table></figure>
<p>19表示<code>pin number</code>， <code>GPIO_ACTIVE_LOW</code>是一个宏定义：可以看到为1，也就是低电平有效<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png" alt="image"></p>
<h3><span id="5-2-1-shi-yong-zhe-cao-zuo-liu-cheng">5.2.1 使用者操作流程</span><a href="#5-2-1-shi-yong-zhe-cao-zuo-liu-cheng" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> of_find_node_by_path获取使用该gpio的节点</span><br><span class="line"><span class="number">2.</span> of_get_named_gpio，获取gpio编号</span><br><span class="line"><span class="number">3.</span> gpio_request,申请gpio</span><br><span class="line"><span class="number">4.</span> gpio_direction_set/gpio_direction_get</span><br><span class="line"><span class="number">5.</span> gpio_val_set</span><br></pre></td></tr></table></figure>

<h4><span id="5-2-1-1-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo1-gpio-led">5.2.1.1 dts自定义gpio控制器使用者（demo1,gpio_led）</span><a href="#5-2-1-1-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo1-gpio-led" class="header-anchor">#</a></h4><p>编写一个gpioled节点：</p>
<p><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png" alt="image"><br>同时修改<code>iomuxc</code>节点，因为用到了<code>GPIO1_IO03</code>，要设置该pin脚为<code>gpio</code>：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png" alt="image"></p>
<details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOLED_CNT			1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GPIOLED_NAME		<span class="string">&quot;gpioled&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDOFF 				0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEDON 				1</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span>&#123;</span></span><br><span class="line">	<span class="type">dev_t</span> devid;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span></span><br><span class="line">	<span class="type">int</span> major;</span><br><span class="line">	<span class="type">int</span> minor;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">nd</span>;</span></span><br><span class="line">	<span class="type">int</span> led_gpio;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span> <span class="title">gpioled</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">	filp-&gt;private_data = &amp;gpioled;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">led_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> retvalue;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> ledstat;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpioled_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">	retvalue = copy_from_user(databuf, buf, cnt);</span><br><span class="line">	<span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;kernel write failed!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ledstat = databuf[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(ledstat == LEDON) &#123;	</span><br><span class="line">		gpio_set_value(dev-&gt;led_gpio, <span class="number">0</span>);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(ledstat == LEDOFF) &#123;</span><br><span class="line">		gpio_set_value(dev-&gt;led_gpio, <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">led_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">gpioled_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = led_open,</span><br><span class="line">	.read = led_read,</span><br><span class="line">	.write = led_write,</span><br><span class="line">	.release = 	led_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">led_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	gpioled.nd = of_find_node_by_path(<span class="string">&quot;/gpioled&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(gpioled.nd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;gpioled node not find!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		printk(<span class="string">&quot;gpioled node find!\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gpioled.led_gpio = of_get_named_gpio(gpioled.nd, <span class="string">&quot;led-gpio&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(gpioled.led_gpio &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;can&#x27;t get led-gpio&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;led-gpio num = %d\r\n&quot;</span>, gpioled.led_gpio);</span><br><span class="line"></span><br><span class="line">	ret = gpio_direction_output(gpioled.led_gpio, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;can&#x27;t set gpio!\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (gpioled.major) &#123;</span><br><span class="line">		gpioled.devid = MKDEV(gpioled.major, <span class="number">0</span>);</span><br><span class="line">		register_chrdev_region(gpioled.devid, GPIOLED_CNT, GPIOLED_NAME);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		alloc_chrdev_region(&amp;gpioled.devid, <span class="number">0</span>, GPIOLED_CNT, GPIOLED_NAME);</span><br><span class="line">		gpioled.major = MAJOR(gpioled.devid);</span><br><span class="line">		gpioled.minor = MINOR(gpioled.devid);</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;gpioled major=%d,minor=%d\r\n&quot;</span>,gpioled.major, gpioled.minor);	</span><br><span class="line">	</span><br><span class="line">	gpioled.cdev.owner = THIS_MODULE;</span><br><span class="line">	cdev_init(&amp;gpioled.cdev, &amp;gpioled_fops);</span><br><span class="line">	</span><br><span class="line">	cdev_add(&amp;gpioled.cdev, gpioled.devid, GPIOLED_CNT);</span><br><span class="line"></span><br><span class="line">	gpioled.class = class_create(THIS_MODULE, GPIOLED_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(gpioled.class)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(gpioled.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	gpioled.device = device_create(gpioled.class, <span class="literal">NULL</span>, gpioled.devid, <span class="literal">NULL</span>, GPIOLED_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(gpioled.device)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(gpioled.device);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">led_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	cdev_del(&amp;gpioled.cdev);</span><br><span class="line">	unregister_chrdev_region(gpioled.devid, GPIOLED_CNT);</span><br><span class="line"></span><br><span class="line">	device_destroy(gpioled.class, gpioled.devid);</span><br><span class="line">	class_destroy(gpioled.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(led_init);</span><br><span class="line">module_exit(led_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>
</details>


<h4><span id="5-2-1-2-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo2-beep">5.2.1.2 dts自定义gpio控制器使用者（demo2,beep）</span><a href="#5-2-1-2-dts-zi-ding-yi-gpio-kong-zhi-qi-shi-yong-zhe-demo2-beep" class="header-anchor">#</a></h4><p>evk公板的蜂鸣器。<code>BEEP</code>使用了<code>SNVS_TAMPER1</code>这个PIN，打开<code>imx6ull-alientek-emmc.dts</code>，<code>SNVS_TAMPER1</code>属于<code>iomuxc_snvs</code>这个<code>pin controller</code>。<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png" alt="image"><br>在<code>iomuxc</code>节点的<code>imx6ul-evk</code>子节点下创建一个名为<code>“pinctrl_beep”</code>的子节点:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_beep: beepgrp &#123;</span><br><span class="line">	fsl,pins = &lt;</span><br><span class="line">		MX6ULL_PAD_SNVS_TAMPER1__GPIO5_IO01 <span class="number">0x10B0</span> <span class="comment">/* beep */</span></span><br><span class="line">	&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>根节点<code>“/”</code>下创建<code>BEEP</code>节点：可以看到用到了引脚控制器的<code>pinctrl_beep</code>节点。同时使用gpio子系统，<code>beep-gpio</code>属性用到<code>gpio5</code>控制器。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">beep &#123;</span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	compatible = <span class="string">&quot;evk-beep&quot;</span>;</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_beep&gt;;</span><br><span class="line">	beep-gpio = &lt;&amp;gpio5 <span class="number">1</span> GPIO_ACTIVE_HIGH&gt;;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>蜂鸣器使用的 PIN 为<code> SNVS_TAMPER1</code>，因此先检查 PIN 为<code>SNVS_TAMPER1 </code>这个 PIN 有没有被其他的 pinctrl 节点使用，如果有使用的话就要屏蔽掉，然后再检查 <code>GPIO5_IO01</code> 这个 GPIO 有没有被其他外设使用，如果有的话也要屏蔽掉。</p>
<p>输入<code>“make dtbs”</code>命令重新编译设备树，然后使用新编译出来的 <code>imx6ull-alientek-emmc.dtb</code> 文件启动 Linux 系统，进入<code>“/proc/device-tree”</code>目录中 查看<code>“beep”</code>节点是否存在：<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png" alt="image"></p>
<details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEP_CNT			1		<span class="comment">/* 设备号个数 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEP_NAME			<span class="string">&quot;beep&quot;</span>	<span class="comment">/* 名字 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEPOFF 			0		<span class="comment">/* 关蜂鸣器 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BEEPON 				1		<span class="comment">/* 开蜂鸣器 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">beep_dev</span>&#123;</span></span><br><span class="line">	<span class="type">dev_t</span> devid;			<span class="comment">/* 设备号 	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>		<span class="comment">/* cdev 	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>	<span class="comment">/* 类 		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>	<span class="comment">/* 设备 	 */</span></span><br><span class="line">	<span class="type">int</span> major;				<span class="comment">/* 主设备号	  */</span></span><br><span class="line">	<span class="type">int</span> minor;				<span class="comment">/* 次设备号   */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">nd</span>;</span> <span class="comment">/* 设备节点 */</span></span><br><span class="line">	<span class="type">int</span> beep_gpio;			<span class="comment">/* beep所使用的GPIO编号		*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">beep_dev</span> <span class="title">beep</span>;</span>		<span class="comment">/* beep设备 */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">beep_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">	filp-&gt;private_data = &amp;beep; <span class="comment">/* 设置私有数据 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">beep_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *offt)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> retvalue;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> databuf[<span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> beepstat;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">beep_dev</span> *<span class="title">dev</span> =</span> filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">	retvalue = copy_from_user(databuf, buf, cnt);</span><br><span class="line">	<span class="keyword">if</span>(retvalue &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;kernel write failed!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	beepstat = databuf[<span class="number">0</span>];		<span class="comment">/* 获取状态值 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(beepstat == BEEPON) &#123;	</span><br><span class="line">		gpio_set_value(dev-&gt;beep_gpio, <span class="number">0</span>);	<span class="comment">/* 打开蜂鸣器 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(beepstat == BEEPOFF) &#123;</span><br><span class="line">		gpio_set_value(dev-&gt;beep_gpio, <span class="number">1</span>);	<span class="comment">/* 关闭蜂鸣器 */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">beep_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">beep_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = beep_open,</span><br><span class="line">	.write = beep_write,</span><br><span class="line">	.release = 	beep_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">beep_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1、获取设备节点：beep */</span></span><br><span class="line">	beep.nd = of_find_node_by_path(<span class="string">&quot;/beep&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span>(beep.nd == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;beep node not find!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		printk(<span class="string">&quot;beep node find!\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 2、 获取设备树中的gpio属性，得到BEEP所使用的BEEP编号 */</span></span><br><span class="line">	beep.beep_gpio = of_get_named_gpio(beep.nd, <span class="string">&quot;beep-gpio&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(beep.beep_gpio &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;can&#x27;t get beep-gpio&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;led-gpio num = %d\r\n&quot;</span>, beep.beep_gpio);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 3、设置GPIO5_IO01为输出，并且输出高电平，默认关闭BEEP */</span></span><br><span class="line">	ret = gpio_direction_output(beep.beep_gpio, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		printk(<span class="string">&quot;can&#x27;t set gpio!\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1、创建设备号 */</span></span><br><span class="line">	<span class="keyword">if</span> (beep.major) &#123;		<span class="comment">/*  定义了设备号 */</span></span><br><span class="line">		beep.devid = MKDEV(beep.major, <span class="number">0</span>);</span><br><span class="line">		register_chrdev_region(beep.devid, BEEP_CNT, BEEP_NAME);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;						<span class="comment">/* 没有定义设备号 */</span></span><br><span class="line">		alloc_chrdev_region(&amp;beep.devid, <span class="number">0</span>, BEEP_CNT, BEEP_NAME);	<span class="comment">/* 申请设备号 */</span></span><br><span class="line">		beep.major = MAJOR(beep.devid);	<span class="comment">/* 获取分配号的主设备号 */</span></span><br><span class="line">		beep.minor = MINOR(beep.devid);	<span class="comment">/* 获取分配号的次设备号 */</span></span><br><span class="line">	&#125;</span><br><span class="line">	printk(<span class="string">&quot;beep major=%d,minor=%d\r\n&quot;</span>,beep.major, beep.minor);	</span><br><span class="line">	</span><br><span class="line">	beep.cdev.owner = THIS_MODULE;</span><br><span class="line">	cdev_init(&amp;beep.cdev, &amp;beep_fops);</span><br><span class="line">	cdev_add(&amp;beep.cdev, beep.devid, BEEP_CNT);</span><br><span class="line"></span><br><span class="line">	beep.class = class_create(THIS_MODULE, BEEP_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(beep.class)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(beep.class);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	beep.device = device_create(beep.class, <span class="literal">NULL</span>, beep.devid, <span class="literal">NULL</span>, BEEP_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(beep.device)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(beep.device);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">beep_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	cdev_del(&amp;beep.cdev);<span class="comment">/*  删除cdev */</span></span><br><span class="line">	unregister_chrdev_region(beep.devid, BEEP_CNT); <span class="comment">/* 注销设备号 */</span></span><br><span class="line"></span><br><span class="line">	device_destroy(beep.class, beep.devid);</span><br><span class="line">	class_destroy(beep.class);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(beep_init);</span><br><span class="line">module_exit(beep_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>
</details>

<p>核心代码分析：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> of_find_node_by_path(<span class="string">&quot;/beep&quot;</span>);<span class="comment">//找到设备节点</span></span><br><span class="line"><span class="number">2.</span> of_get_named_gpio(beep.nd, <span class="string">&quot;beep-gpio&quot;</span>, <span class="number">0</span>);<span class="comment">//获取beep-gpio这个引脚编号</span></span><br><span class="line"><span class="number">3.</span> gpio_direction_output(beep.beep_gpio, <span class="number">1</span>);<span class="comment">//请求gpio并且配成输出</span></span><br><span class="line"><span class="number">4.</span> gpio_set_value(dev-&gt;beep_gpio, <span class="number">0</span>);<span class="comment">//设置高低电平</span></span><br></pre></td></tr></table></figure>

<p>注意这里并没有使用<code>pinctrl</code>, <code>pinctrl子系统</code>是内核启动时就对<code>pinctrl(也叫iomuxc)控制器</code>进行了配置，进行了IOMUX配置。因此<code>SNVS_TAMPER1</code>会复用成gpio模式。<br><img src="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png" alt="image"></p>
<p>按键作为输入时：</p>
<pre><code>static int keyio_init(void)
&#123;
    keydev.nd = of_find_node_by_path(&quot;/key&quot;);
    if (keydev.nd== NULL) &#123;
        return -EINVAL;
    &#125;

    keydev.key_gpio = of_get_named_gpio(keydev.nd ,&quot;key-gpio&quot;, 0);
    if (keydev.key_gpio &lt; 0) &#123;
        printk(&quot;can&#39;t get key0\r\n&quot;);
        return -EINVAL;
    &#125;
    printk(&quot;key_gpio=%d\r\n&quot;, keydev.key_gpio);

    /* 初始化key所使用的IO */
    gpio_request(keydev.key_gpio, &quot;key0&quot;);	/* 请求IO */
    gpio_direction_input(keydev.key_gpio);	/* 设置为输入 */
    return 0;
&#125;
</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/" data-id="cm0dxg14m004ddsufdjffa5et" data-title="字符设备驱动-gpio子系统" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          字符设备驱动-pinctrl子系统
        
      </div>
    </a>
  
  
    <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E7%94%A8%E6%88%B7%E6%80%81%E6%9E%84%E9%80%A0IP%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E4%BD%93%E5%92%8C%E8%AF%BB%E5%86%99%E5%AF%84%E5%AD%98%E5%99%A8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">字符设备驱动-用户态构造IP寄存器结构体和读写寄存器</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 14.55px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-input子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-SPI子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-I2C子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E5%86%85%E6%A0%B8led%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-内核led子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-pinctrl子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
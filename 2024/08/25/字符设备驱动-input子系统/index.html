<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>字符设备驱动-input子系统 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 input 子系统介绍 1.0 数据结构 1.0.1 input_dev   1.1 input 驱动编写流程 1.1.0 input类的建立和proc建立 1.1.1 注册 input_dev 1.1.1.1 input_dev 注册过程   1.1.2 中断上报输入事件 1.1.3 input_event 结构体     2 input子系统示例 2.1 定义input_dev">
<meta property="og:type" content="article">
<meta property="og:title" content="字符设备驱动-input子系统">
<meta property="og:url" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 input 子系统介绍 1.0 数据结构 1.0.1 input_dev   1.1 input 驱动编写流程 1.1.0 input类的建立和proc建立 1.1.1 注册 input_dev 1.1.1.1 input_dev 注册过程   1.1.2 中断上报输入事件 1.1.3 input_event 结构体     2 input子系统示例 2.1 定义input_dev">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/23.1.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/31.1.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/33.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/34.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/35.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/36.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/37.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/38.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/39.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/40.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/41.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/42.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/43.png">
<meta property="article:published_time" content="2024-08-25T12:02:38.000Z">
<meta property="article:modified_time" content="2024-08-31T06:45:50.394Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-字符设备驱动-input子系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2024-08-25T12:02:38.000Z" itemprop="datePublished">2024-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      字符设备驱动-input子系统
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-input-zi-xi-tong-jie-shao">1 input 子系统介绍</a><ul>
<li><a href="#1-0-shu-ju-jie-gou">1.0 数据结构</a><ul>
<li><a href="#1-0-1-input-dev">1.0.1 input_dev</a></li>
</ul>
</li>
<li><a href="#1-1-input-qu-dong-bian-xie-liu-cheng">1.1 input 驱动编写流程</a><ul>
<li><a href="#1-1-0-input-lei-de-jian-li-he-proc-jian-li">1.1.0 input类的建立和proc建立</a></li>
<li><a href="#1-1-1-zhu-ce-input-dev">1.1.1 注册 input_dev</a><ul>
<li><a href="#1-1-1-1-input-dev-zhu-ce-guo-cheng">1.1.1.1 input_dev 注册过程</a></li>
</ul>
</li>
<li><a href="#1-1-2-zhong-duan-shang-bao-shu-ru-shi-jian">1.1.2 中断上报输入事件</a></li>
<li><a href="#1-1-3-input-event-jie-gou-ti">1.1.3 input_event 结构体</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-input-zi-xi-tong-shi-li">2 input子系统示例</a><ul>
<li><a href="#2-1-ding-yi-input-dev">2.1 定义input_dev</a></li>
<li><a href="#2-2-chu-shi-hua-input-dev">2.2 初始话input_dev</a></li>
<li><a href="#2-3-zhong-duan-shang-bao-shu-ru-shi-jian">2.3 中断上报输入事件</a></li>
<li><a href="#2-4-shi-fang-input-dev">2.4 释放input_dev</a></li>
</ul>
</li>
<li><a href="#3-app-ce-shi">3 APP测试</a></li>
<li><a href="#4-linux-input-zi-xi-tong-bu-chong-linux-zi-dai-an-jian-qu-dong">4 Linux input子系统补充-Linux 自带按键驱动</a><ul>
<li><a href="#4-1-gpio-keys-yuan-ma-fen-xi">4.1 gpio_keys源码分析</a><ul>
<li><a href="#4-1-1-gpio-keys-probe-fen-xi">4.1.1 gpio_keys_probe分析</a><ul>
<li><a href="#4-1-1-1-gpio-keys-setup-key">4.1.1.1 gpio_keys_setup_key</a></li>
<li><a href="#4-1-1-2-gpio-keys-irq-isr">4.1.1.2 gpio_keys_irq_isr</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-2-ce-shi-yan-zheng">4.2 测试验证</a></li>
</ul>
</li>
<li><a href="#5-linux-input-zi-xi-tong-dian-rong-hong-mo-ping-ying-yong">5 Linux input子系统-电容触摸屏应用</a><ul>
<li><a href="#5-1-ft5426-dian-rong-hong-mo-ping-jian-jie">5.1 FT5426电容触摸屏简介</a><ul>
<li><a href="#5-1-1-te-xing">5.1.1 特性</a></li>
<li><a href="#5-1-2-i2c-chuan-shu-ge-shi">5.1.2 i2c传输格式</a></li>
<li><a href="#5-1-3-shang-dian-ji-fu-wei-shi-xu">5.1.3 上电及复位时序</a></li>
<li><a href="#5-1-4-ji-cun-qi-miao-shu">5.1.4 寄存器描述</a></li>
</ul>
</li>
<li><a href="#5-2-duo-dian-hong-mo-mt-xie-yi">5.2 多点触摸(MT)协议</a><ul>
<li><a href="#5-2-1-abs-mt-shi-jian">5.2.1 ABS_MT 事件</a><ul>
<li><a href="#5-2-1-1-input-mt-sync-ge-chi-typea-lei-de-bu-tong-hong-mo-dian">5.2.1.1 input_mt_sync-隔离typeA类的不同触摸点</a></li>
<li><a href="#5-2-1-2-input-mt-slot-qu-fen-typeb-lei-de-bu-tong-hong-mo-dian">5.2.1.2 input_mt_slot-区分typeB类的不同触摸点</a></li>
<li><a href="#5-2-1-3-input-sync-jie-shu-shang-bao">5.2.1.3 input_sync-结束上报</a></li>
<li><a href="#5-2-1-4-input-report-abs-shang-bao-zuo-biao">5.2.1.4 input_report_abs-上报坐标</a></li>
</ul>
</li>
<li><a href="#5-2-2-type-a-hong-mo-dian-xin-xi-shang-bao-liu-cheng">5.2.2 Type A 触摸点信息上报流程</a></li>
<li><a href="#5-2-3-type-b-hong-mo-dian-xin-xi-shang-bao-liu-cheng">5.2.3 Type B 触摸点信息上报流程</a></li>
<li><a href="#5-2-4-abs-mt-qi-ta-shi-jian">5.2.4 ABS_MT其他事件</a><ul>
<li><a href="#5-2-4-1-abs-mt-tool-type">5.2.4.1 ABS_MT_TOOL_TYPE</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-3-duo-dian-hong-mo-api">5.3 多点触摸API</a><ul>
<li><a href="#5-3-1-input-mt-init-slots">5.3.1 input_mt_init_slots</a></li>
<li><a href="#5-3-2-input-mt-slot">5.3.2 input_mt_slot</a></li>
<li><a href="#5-3-3-input-mt-report-slot-state">5.3.3 input_mt_report_slot_state</a></li>
<li><a href="#5-3-4-input-report-abs">5.3.4 input_report_abs</a></li>
<li><a href="#5-3-5-input-mt-report-pointer-emulation">5.3.5 input_mt_report_pointer_emulation</a></li>
</ul>
</li>
<li><a href="#5-4-linux-hong-mo-ping-qu-dong-shi-li-ft5426">5.4 Linux触摸屏驱动示例-FT5426</a><ul>
<li><a href="#5-4-1-she-bei-shu-tian-jia">5.4.1 设备树添加</a><ul>
<li><a href="#5-4-1-1-iomux-yin-jiao-pei-zhi">5.4.1.1 iomux引脚配置</a></li>
<li><a href="#5-4-1-2-ft5426-jie-dian">5.4.1.2 ft5426节点</a></li>
</ul>
</li>
<li><a href="#5-4-2-ft5426-qu-dong-yuan-ma-jie-xi">5.4.2 FT5426驱动源码解析</a><ul>
<li><a href="#5-4-2-1-probe-guo-cheng">5.4.2.1 probe过程</a></li>
<li><a href="#5-4-2-2-i2c-shu-ju-chuan-shu">5.4.2.2 I2C数据传输</a></li>
<li><a href="#5-4-2-3-zhong-duan-hong-mo-shu-ju-shang-bao">5.4.2.3 中断触摸数据上报</a></li>
</ul>
</li>
<li><a href="#5-4-3-yong-hu-tai-ying-yong-ce-shi">5.4.3 用户态应用测试</a><ul>
<li><a href="#5-4-3-1-hong-mo-ping-yuan-shi-shu-ju-jie-xi">5.4.3.1 触摸屏原始数据解析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-5-linux-nei-he-zi-dai-de-hong-mo-qu-dong">5.5 Linux内核自带的触摸驱动</a></li>
</ul>
</li>
<li><a href="#6-is-enabled-zai-qu-dong-zhong-pan-duan-mou-config-shi-fou-ding-yi">6 IS_ENABLED-在驱动中判断某CONFIG是否定义</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-input-zi-xi-tong-jie-shao">1 input 子系统介绍</span><a href="#1-input-zi-xi-tong-jie-shao" class="header-anchor">#</a></h1><p>按键、鼠标、键盘、触摸屏等都属于输入(<code>input</code>)设备，Linux 内核为此专门做了一个叫做 input子系统的框架来处理输入事件。<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png" alt="image"><br>input 子系统分为 input 驱动层、input 核心层、input 事件处理层，最终给用户空间提供可访问的设备节点。<br>驱动层：输入设备的具体驱动程序，比如按键驱动程序，向内核层报告输入内容。<br>核心层：承上启下，为驱动层提供输入设备注册和操作接口。通知事件层对输入事件进行处理。<br>事件层：主要和用户空间进行交互。</p>
<h2><span id="1-0-shu-ju-jie-gou">1.0  数据结构</span><a href="#1-0-shu-ju-jie-gou" class="header-anchor">#</a></h2><h3><span id="1-0-1-input-dev">1.0.1 input_dev</span><a href="#1-0-1-input-dev" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>:  <span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span></span><br><span class="line">   <span class="number">2</span>:      <span class="type">const</span> <span class="type">char</span> *name;      <span class="comment">//设备名</span></span><br><span class="line">   <span class="number">3</span>:      <span class="type">const</span> <span class="type">char</span> *phys;     <span class="comment">// 设备在系统中路径</span></span><br><span class="line">   <span class="number">4</span>:      <span class="type">const</span> <span class="type">char</span> *uniq;</span><br><span class="line">   <span class="number">5</span>:      <span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span>    <span class="comment">//与input_handler匹配用的id;</span></span><br><span class="line"></span><br><span class="line">   <span class="number">9</span>:      <span class="type">unsigned</span> <span class="type">long</span> evbit[BITS_TO_LONGS(EV_CNT)]; <span class="comment">//设备所支持事件类型主要有EV_SYNC,EV_KEY,EV_REL,EV_ABS</span></span><br><span class="line">  <span class="number">10</span>:      <span class="type">unsigned</span> <span class="type">long</span> keybit[BITS_TO_LONGS(KEY_CNT)];<span class="comment">// 按键所对应的位图</span></span><br><span class="line">  <span class="number">11</span>:      <span class="type">unsigned</span> <span class="type">long</span> relbit[BITS_TO_LONGS(REL_CNT)];<span class="comment">//  相对坐标对应位图</span></span><br><span class="line">  <span class="number">12</span>:      <span class="type">unsigned</span> <span class="type">long</span> absbit[BITS_TO_LONGS(ABS_CNT)];<span class="comment">// 绝对坐标对应位图</span></span><br><span class="line">  <span class="number">13</span>:      <span class="type">unsigned</span> <span class="type">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)];<span class="comment">//支持其它事件</span></span><br><span class="line">  <span class="number">14</span>:      <span class="type">unsigned</span> <span class="type">long</span> ledbit[BITS_TO_LONGS(LED_CNT)];<span class="comment">//支持led事件</span></span><br><span class="line">  <span class="number">15</span>:      <span class="type">unsigned</span> <span class="type">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];<span class="comment">//支持声音事件</span></span><br><span class="line">  <span class="number">16</span>:      <span class="type">unsigned</span> <span class="type">long</span> ffbit[BITS_TO_LONGS(FF_CNT)];<span class="comment">//支持受力事件</span></span><br><span class="line">  <span class="number">17</span>:      <span class="type">unsigned</span> <span class="type">long</span> swbit[BITS_TO_LONGS(SW_CNT)];<span class="comment">//支持开关机事件</span></span><br><span class="line">  <span class="number">18</span>:   </span><br><span class="line">  <span class="number">19</span>:      <span class="type">unsigned</span> <span class="type">int</span> hint_events_per_packet;</span><br><span class="line">  <span class="number">21</span>:      <span class="type">unsigned</span> <span class="type">int</span> keycodemax;</span><br><span class="line">  <span class="number">22</span>:      <span class="type">unsigned</span> <span class="type">int</span> keycodesize;</span><br><span class="line">  <span class="number">23</span>:      <span class="type">void</span> *keycode;</span><br><span class="line">  <span class="number">24</span>:   </span><br><span class="line">  <span class="number">25</span>:      <span class="type">int</span> (*setkeycode)(<span class="keyword">struct</span> input_dev *dev,</span><br><span class="line">  <span class="number">26</span>:                <span class="type">const</span> <span class="keyword">struct</span> input_keymap_entry *ke,</span><br><span class="line">  <span class="number">27</span>:                <span class="type">unsigned</span> <span class="type">int</span> *old_keycode);</span><br><span class="line">  <span class="number">28</span>:      <span class="type">int</span> (*getkeycode)(<span class="keyword">struct</span> input_dev *dev,</span><br><span class="line">  <span class="number">29</span>:                <span class="keyword">struct</span> input_keymap_entry *ke);</span><br><span class="line">  <span class="number">30</span>:   </span><br><span class="line">  <span class="number">31</span>:      <span class="class"><span class="keyword">struct</span> <span class="title">ff_device</span> *<span class="title">ff</span>;</span></span><br><span class="line">  <span class="number">33</span>:      <span class="type">unsigned</span> <span class="type">int</span> repeat_key;<span class="comment">//最近一次的按键值</span></span><br></pre></td></tr></table></figure>



<h2><span id="1-1-input-qu-dong-bian-xie-liu-cheng">1.1 input 驱动编写流程</span><a href="#1-1-input-qu-dong-bian-xie-liu-cheng" class="header-anchor">#</a></h2><h3><span id="1-1-0-input-lei-de-jian-li-he-proc-jian-li">1.1.0 input类的建立和proc建立</span><a href="#1-1-0-input-lei-de-jian-li-he-proc-jian-li" class="header-anchor">#</a></h3><p><code>drivers/input/input.c</code>就是input子系统的核心层，此文件里面有如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> <span class="title">input_class</span> =</span> &#123;</span><br><span class="line">	.name = <span class="string">&quot;input&quot;</span>,</span><br><span class="line">	.devnode = input_devnode,</span><br><span class="line">&#125;;</span><br><span class="line">.....</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">input_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">	err = class_register(&amp;input_class);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;unable to register input_dev class\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = input_proc_init();</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> fail1;</span><br><span class="line"></span><br><span class="line">	err = register_chrdev_region(MKDEV(INPUT_MAJOR, <span class="number">0</span>),</span><br><span class="line">		INPUT_MAX_CHAR_DEVICES, <span class="string">&quot;input&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (err) &#123;</span><br><span class="line">		pr_err(<span class="string">&quot;unable to register char major %d&quot;</span>, INPUT_MAJOR);</span><br><span class="line">		<span class="keyword">goto</span> fail2;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail2: input_proc_exit();</span><br><span class="line">fail1: class_unregister(&amp;input_class);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册一个 input 类，这样系统启动以后就会在&#x2F;sys&#x2F;class 目录下有一个 input 子目录:<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png" alt="image"><br>创建<code>proc/input</code>信息，申请主设备号为<code> INPUT_MAJOR, INPUT_MAJOR</code> 定义在 <code>include/uapi/linux/major.h</code>:<br><code>#define INPUT_MAJOR 13</code><br>因此，input 子系统的所有设备主设备号都为 <code>13</code>，我们在使用 input 子系统处理输入设备的时候就不需要去注册字符设备了，我们只需要向系统注册一个 <code>input_device </code>即可。</p>
<h3><span id="1-1-1-zhu-ce-input-dev">1.1.1 注册 input_dev</span><a href="#1-1-1-zhu-ce-input-dev" class="header-anchor">#</a></h3><p>使用 input 子系统的时候我们只需要注册一个 input 设备即可，<code>input_dev</code> 结构体表示<code> input设备</code>，此结构体定义在 <code>include/linux/input.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *phys;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *uniq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input_id</span> <span class="title">id</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> propbit[BITS_TO_LONGS(INPUT_PROP_CNT)];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> evbit[BITS_TO_LONGS(EV_CNT)]; <span class="comment">/* 事件类型的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> keybit[BITS_TO_LONGS(KEY_CNT)]; <span class="comment">/* 按键值的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> relbit[BITS_TO_LONGS(REL_CNT)]; <span class="comment">/* 相对坐标的位图 */</span> </span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> absbit[BITS_TO_LONGS(ABS_CNT)]; <span class="comment">/* 绝对坐标的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)]; <span class="comment">/* 杂项事件的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ledbit[BITS_TO_LONGS(LED_CNT)]; <span class="comment">/*LED 相关的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];<span class="comment">/* sound 有关的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ffbit[BITS_TO_LONGS(FF_CNT)]; <span class="comment">/* 压力反馈的位图 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> swbit[BITS_TO_LONGS(SW_CNT)]; <span class="comment">/*开关状态的位图 */</span></span><br><span class="line">	.....</span><br><span class="line">	<span class="type">bool</span> devres_managed;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>evbit </code>表示输入事件类型:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SYN 0x00 <span class="comment">/* 同步事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_KEY 0x01 <span class="comment">/* 按键事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_REL 0x02 <span class="comment">/* 相对坐标事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_ABS 0x03 <span class="comment">/* 绝对坐标事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_MSC 0x04 <span class="comment">/* 杂项(其他)事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SW 0x05 <span class="comment">/* 开关事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_LED 0x11 <span class="comment">/* LED */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_SND 0x12 <span class="comment">/* sound(声音) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_REP 0x14 <span class="comment">/* 重复事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_FF 0x15 <span class="comment">/* 压力事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_PWR 0x16 <span class="comment">/* 电源事件 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EV_FF_STATUS 0x17 <span class="comment">/* 压力状态事件 */</span></span></span><br></pre></td></tr></table></figure>

<p><code>evbit、keybit、relbit </code>等等都是存放不同事件对应的值。比如我们本章要使用按键事件，因此要用到 keybit，keybit 就是按键事件使用的位图，Linux 内核定义了很多按键值:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_RESERVED 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_ESC 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_1 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_2 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_3 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_4 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_5 6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_6 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_7 8</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_8 9</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_9 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_0 11</span></span><br><span class="line">......</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BTN_TRIGGER_HAPPY39 0x2e6</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BTN_TRIGGER_HAPPY40 0x2e7</span></span><br></pre></td></tr></table></figure>

<p>我们可以将开发板上的按键值设置为任意一个，比如就叫<code>KEY_0</code>。</p>
<p><strong>申请input内存：</strong><br><code>struct input_dev *input_allocate_device(void);</code></p>
<p><strong>释放input内存：</strong><br><code>void input_free_device(struct input_dev *dev);</code></p>
<p><strong>注册input设备：</strong><br><code>int input_register_device(struct input_dev *dev);</code></p>
<p><strong>注销input设备：</strong><br><code>void input_unregister_device(struct input_dev *dev);</code></p>
<h4><span id="1-1-1-1-input-dev-zhu-ce-guo-cheng">1.1.1.1 input_dev 注册过程</span><a href="#1-1-1-1-input-dev-zhu-ce-guo-cheng" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">inputdev</span>;</span> <span class="comment">/* input 结构体变量 */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">xxx_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	inputdev = input_allocate_device(); <span class="comment">/* 申请 input_dev */</span></span><br><span class="line">	inputdev-&gt;name = <span class="string">&quot;test_inputdev&quot;</span>; <span class="comment">/* 设置 input_dev 名字 */</span></span><br><span class="line"></span><br><span class="line">	 <span class="comment">/*********第一种设置事件和事件值的方法***********/</span></span><br><span class="line">	 __set_bit(EV_KEY, inputdev-&gt;evbit); <span class="comment">/* 设置产生按键事件 */</span></span><br><span class="line">	 __set_bit(EV_REP, inputdev-&gt;evbit); <span class="comment">/* 重复事件 */</span></span><br><span class="line">	 __set_bit(KEY_0, inputdev-&gt;keybit); <span class="comment">/*设置产生哪些按键值 */</span></span><br><span class="line">	 <span class="comment">/************************************************/</span></span><br><span class="line">	 </span><br><span class="line">	 <span class="comment">/*********第二种设置事件和事件值的方法***********/</span></span><br><span class="line">	 keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY) |</span><br><span class="line">	T_MASK(EV_REP);</span><br><span class="line">	 keyinputdev.inputdev-&gt;keybit[BIT_WORD(KEY_0)] |=</span><br><span class="line">	T_MASK(KEY_0);</span><br><span class="line">	 <span class="comment">/************************************************/</span></span><br><span class="line">   </span><br><span class="line">	 <span class="comment">/*********第三种设置事件和事件值的方法***********/</span></span><br><span class="line">	 keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY) |</span><br><span class="line">	T_MASK(EV_REP);</span><br><span class="line">	 input_set_capability(keyinputdev.inputdev, EV_KEY, KEY_0);</span><br><span class="line">	 <span class="comment">/************************************************/</span></span><br><span class="line">	 input_register_device(inputdev);</span><br><span class="line">	 <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">xxx_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line"> &#123;</span><br><span class="line">	 input_unregister_device(inputdev); <span class="comment">/* 注销 input_dev */</span></span><br><span class="line">	 input_free_device(inputdev); <span class="comment">/* 删除 input_dev */</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-2-zhong-duan-shang-bao-shu-ru-shi-jian">1.1.2 中断上报输入事件</span><a href="#1-1-2-zhong-duan-shang-bao-shu-ru-shi-jian" class="header-anchor">#</a></h3><p>当输入设备中断到来，我们需要上报input输入事件给linux内核的input核心层，比如按键：我们需要在按键中断处理函数，或者消抖定时器中断函数中将按键值上报给 Linux 内核，这样 Linux 内核才能获取到正确的输入值。<br>不同的事件，上报事件的 API 函数不一样:<br><strong>input_event:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_event</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> type, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	dev：需要上报的 input_dev。</span></span><br><span class="line"><span class="comment">	type: 上报的事件类型，比如 EV_KEY。</span></span><br><span class="line"><span class="comment">	code：事件码，也就是我们注册的按键值，比如 KEY_0、KEY_1 等等。</span></span><br><span class="line"><span class="comment">	value：事件值，比如 1 表示按键按下，0 表示按键松开。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>当然linux系统帮我们也封装了一层api去使用：<br><strong>input_report_key：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">input_report_key</span><span class="params">(<span class="keyword">struct</span> input_dev *dev,<span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span>&#123;</span><br><span class="line">	input_event(dev, EV_KEY, code, !!value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的还有一些其他的事件上报函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">input_report_rel</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_abs</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_ff_status</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_report_switch</span><span class="params">(<span class="keyword">struct</span> input_dev *dev, <span class="type">unsigned</span> <span class="type">int</span> code, <span class="type">int</span> value)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">input_mt_sync</span><span class="params">(<span class="keyword">struct</span> input_dev *dev)</span></span><br></pre></td></tr></table></figure>
<p>我们上报事件以后还需要使用<code>input_sync</code>函数来告诉 Linux 内核 input 子系统上报结束，<code>input_sync </code>函数本质是上报一个同步事件:<br><code>void input_sync(struct input_dev *dev);</code><br>举个例子，按键中断服务函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 用于按键消抖的定时器服务函数 */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_function</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> value;</span><br><span class="line">	value = gpio_get_value(keydesc-&gt;gpio); <span class="comment">/* 读取 IO 值 */</span></span><br><span class="line">	<span class="keyword">if</span>(value == <span class="number">0</span>)&#123; <span class="comment">/* 按下按键 */</span></span><br><span class="line">		<span class="comment">/* 上报按键值 */</span></span><br><span class="line">		input_report_key(inputdev, KEY_0, <span class="number">1</span>); <span class="comment">/* 最后一个参数 1，按下 */</span></span><br><span class="line">		input_sync(inputdev); <span class="comment">/* 同步事件 */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">/* 按键松开 */</span></span><br><span class="line">		input_report_key(inputdev, KEY_0, <span class="number">0</span>); <span class="comment">/* 最后一个参数 0，松开 */</span></span><br><span class="line">		input_sync(inputdev); <span class="comment">/* 同步事件 */</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3><span id="1-1-3-input-event-jie-gou-ti">1.1.3 input_event 结构体</span><a href="#1-1-3-input-event-jie-gou-ti" class="header-anchor">#</a></h3><p><code>include/uapi/linux/input.h</code> 文件中:<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png" alt="image"></p>
<p><code>type</code>：事件类型，比如 EV_KEY，表示此次事件为<code>按键事件</code>，此成员变量为 16 位。<br><code>code</code>：事件码，比如在 EV_KEY 事件中 code 就表示具体的<code>按键码</code>，如：<code>KEY_0、KEY_1</code>等等这些按键。此成员变量为 16 位。<br><code>value</code>：值，比如 EV_KEY 事件中 value 就是<code>按键值</code>，表示按键有没有被按下，如果为 1 的话说明按键按下，如果为 0 的话说明按键没有被按下或者按键松开了</p>
<p><code>input_envent </code>这个结构体非常重要,用户态的应用程序也是通过 <code>input_event </code>来获取到具体的输入事件或相关的值，比如按键值等。</p>
<h1><span id="2-input-zi-xi-tong-shi-li">2 input子系统示例</span><a href="#2-input-zi-xi-tong-shi-li" class="header-anchor">#</a></h1><p>还是以之前的按键来举例，利用input子系统来做一个按键驱动程序：</p>
<details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/irq.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEYINPUT_CNT		1			<span class="comment">/* 设备号个数 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEYINPUT_NAME		<span class="string">&quot;keyinput&quot;</span>	<span class="comment">/* 名字 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY0VALUE			0X01		<span class="comment">/* KEY0按键值 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INVAKEY				0XFF		<span class="comment">/* 无效的按键值 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KEY_NUM				1			<span class="comment">/* 按键数量 	*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_keydesc</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> gpio;								<span class="comment">/* gpio */</span></span><br><span class="line">	<span class="type">int</span> irqnum;								<span class="comment">/* 中断号     */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> value;					<span class="comment">/* 按键对应的键值 */</span></span><br><span class="line">	<span class="type">char</span> name[<span class="number">10</span>];							<span class="comment">/* 名字 */</span></span><br><span class="line">	<span class="type">irqreturn_t</span> (*handler)(<span class="type">int</span>, <span class="type">void</span> *);	<span class="comment">/* 中断服务函数 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">keyinput_dev</span>&#123;</span></span><br><span class="line">	<span class="type">dev_t</span> devid;			<span class="comment">/* 设备号 	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>		<span class="comment">/* cdev 	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>	<span class="comment">/* 类 		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>	<span class="comment">/* 设备 	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">nd</span>;</span> <span class="comment">/* 设备节点 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timer_list</span> <span class="title">timer</span>;</span><span class="comment">/* 定义一个定时器*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_keydesc</span> <span class="title">irqkeydesc</span>[<span class="title">KEY_NUM</span>];</span>	<span class="comment">/* 按键描述数组 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> curkeynum;				<span class="comment">/* 当前的按键号 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">inputdev</span>;</span>		<span class="comment">/* input结构体 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">keyinput_dev</span> <span class="title">keyinputdev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">key0_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">keyinput_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> keyinput_dev *)dev_id;</span><br><span class="line"></span><br><span class="line">	dev-&gt;curkeynum = <span class="number">0</span>;</span><br><span class="line">	dev-&gt;timer.data = (<span class="keyword">volatile</span> <span class="type">long</span>)dev_id;</span><br><span class="line">	mod_timer(&amp;dev-&gt;timer, jiffies + msecs_to_jiffies(<span class="number">10</span>));	<span class="comment">/* 10ms定时 */</span></span><br><span class="line">	<span class="keyword">return</span> IRQ_RETVAL(IRQ_HANDLED);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">timer_function</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> value;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> num;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_keydesc</span> *<span class="title">keydesc</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">keyinput_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> keyinput_dev *)arg;</span><br><span class="line"></span><br><span class="line">	num = dev-&gt;curkeynum;</span><br><span class="line">	keydesc = &amp;dev-&gt;irqkeydesc[num];</span><br><span class="line">	value = gpio_get_value(keydesc-&gt;gpio); 	<span class="comment">/* 读取IO值 */</span></span><br><span class="line">	<span class="keyword">if</span>(value == <span class="number">0</span>)&#123;<span class="comment">/* 按下按键 */</span></span><br><span class="line">		<span class="comment">/* 上报按键值 */</span></span><br><span class="line">		<span class="comment">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 1);</span></span><br><span class="line">        <span class="comment">/* 最后一个参数表示按下还是松开，1为按下，0为松开 */</span></span><br><span class="line">		input_report_key(dev-&gt;inputdev, keydesc-&gt;value, <span class="number">1</span>);</span><br><span class="line">		input_sync(dev-&gt;inputdev);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;<span class="comment">/* 按键松开 */</span></span><br><span class="line">		<span class="comment">//input_event(dev-&gt;inputdev, EV_KEY, keydesc-&gt;value, 0);</span></span><br><span class="line">		input_report_key(dev-&gt;inputdev, keydesc-&gt;value, <span class="number">0</span>);</span><br><span class="line">		input_sync(dev-&gt;inputdev);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"> <span class="type">int</span> <span class="title function_">keyio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> name[<span class="number">10</span>];</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	keyinputdev.nd = of_find_node_by_path(<span class="string">&quot;/key&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (keyinputdev.nd== <span class="literal">NULL</span>)&#123;</span><br><span class="line">		printk(<span class="string">&quot;key node not find!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125; </span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 提取GPIO */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">		keyinputdev.irqkeydesc[i].gpio = of_get_named_gpio(keyinputdev.nd ,<span class="string">&quot;key-gpio&quot;</span>, i);</span><br><span class="line">		<span class="keyword">if</span> (keyinputdev.irqkeydesc[i].gpio &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			printk(<span class="string">&quot;can&#x27;t get key%d\r\n&quot;</span>, i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 初始化key所使用的IO，并且设置成中断模式 */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(keyinputdev.irqkeydesc[i].name, <span class="number">0</span>, <span class="keyword">sizeof</span>(name));	<span class="comment">/* 缓冲区清零 */</span></span><br><span class="line">		<span class="built_in">sprintf</span>(keyinputdev.irqkeydesc[i].name, <span class="string">&quot;KEY%d&quot;</span>, i);		<span class="comment">/* 组合名字 */</span></span><br><span class="line">		gpio_request(keyinputdev.irqkeydesc[i].gpio, name);</span><br><span class="line">		gpio_direction_input(keyinputdev.irqkeydesc[i].gpio);	</span><br><span class="line">		keyinputdev.irqkeydesc[i].irqnum = irq_of_parse_and_map(keyinputdev.nd, i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* 申请中断 */</span></span><br><span class="line">	keyinputdev.irqkeydesc[<span class="number">0</span>].handler = key0_handler;</span><br><span class="line">	keyinputdev.irqkeydesc[<span class="number">0</span>].value = KEY_0;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">		ret = request_irq(keyinputdev.irqkeydesc[i].irqnum, keyinputdev.irqkeydesc[i].handler, </span><br><span class="line">		                 IRQF_TRIGGER_FALLING|IRQF_TRIGGER_RISING,</span><br><span class="line">                         keyinputdev.irqkeydesc[i].name, &amp;keyinputdev);</span><br><span class="line">		<span class="keyword">if</span>(ret &lt; <span class="number">0</span>)&#123;</span><br><span class="line">			printk(<span class="string">&quot;irq %d request failed!\r\n&quot;</span>, keyinputdev.irqkeydesc[i].irqnum);</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建定时器 */</span></span><br><span class="line">	init_timer(&amp;keyinputdev.timer);</span><br><span class="line">	keyinputdev.timer.function = timer_function;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 申请input_dev */</span></span><br><span class="line">	keyinputdev.inputdev = input_allocate_device();</span><br><span class="line">	keyinputdev.inputdev-&gt;name = KEYINPUT_NAME;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 初始化input_dev，设置产生哪些事件 */</span></span><br><span class="line">	__set_bit(EV_KEY, keyinputdev.inputdev-&gt;evbit);	<span class="comment">/* 设置产生按键事件          */</span></span><br><span class="line">	__set_bit(EV_REP, keyinputdev.inputdev-&gt;evbit);	<span class="comment">/* 重复事件，比如按下去不放开，就会一直输出信息*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 初始化input_dev，设置产生哪些按键 */</span></span><br><span class="line">	__set_bit(KEY_0, keyinputdev.inputdev-&gt;keybit);	</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);</span><br><span class="line">	keyinputdev.inputdev-&gt;keybit[BIT_WORD(KEY_0)] |= BIT_MASK(KEY_0);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	keyinputdev.inputdev-&gt;evbit[<span class="number">0</span>] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);</span><br><span class="line">	input_set_capability(keyinputdev.inputdev, EV_KEY, KEY_0);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 注册输入设备 */</span></span><br><span class="line">	ret = input_register_device(keyinputdev.inputdev);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		printk(<span class="string">&quot;register input device failed!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">keyinput_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	keyio_init();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">keyinput_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	del_timer_sync(&amp;keyinputdev.timer);	<span class="comment">/* 删除定时器 */</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; KEY_NUM; i++) &#123;</span><br><span class="line">		free_irq(keyinputdev.irqkeydesc[i].irqnum, &amp;keyinputdev);</span><br><span class="line">	&#125;</span><br><span class="line">	input_unregister_device(keyinputdev.inputdev);</span><br><span class="line">	input_free_device(keyinputdev.inputdev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(keyinput_init);</span><br><span class="line">module_exit(keyinput_exit);</span><br></pre></td></tr></table></figure>
</details>

<h2><span id="2-1-ding-yi-input-dev">2.1 定义input_dev</span><a href="#2-1-ding-yi-input-dev" class="header-anchor">#</a></h2><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png" alt="image"></p>
<h2><span id="2-2-chu-shi-hua-input-dev">2.2 初始话input_dev</span><a href="#2-2-chu-shi-hua-input-dev" class="header-anchor">#</a></h2><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png" alt="image"></p>
<ol>
<li><code>input_allocate_device</code>分配内存</li>
<li>设置事件和事件值，<code>input_event</code>类型是<code>EV_KEY</code>,键值<code>KEY_0</code>,<code> evbit</code>为<code>EV_KEY | EV_REP</code></li>
<li>注册input设备</li>
</ol>
<h2><span id="2-3-zhong-duan-shang-bao-shu-ru-shi-jian">2.3 中断上报输入事件</span><a href="#2-3-zhong-duan-shang-bao-shu-ru-shi-jian" class="header-anchor">#</a></h2><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png" alt="image"></p>
<h2><span id="2-4-shi-fang-input-dev">2.4 释放input_dev</span><a href="#2-4-shi-fang-input-dev" class="header-anchor">#</a></h2><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png" alt="image"></p>
<h1><span id="3-app-ce-shi">3 APP测试</span><a href="#3-app-ce-shi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/ioctl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">input_event</span> <span class="title">inputevent</span>;</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> err = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> *filename;</span><br><span class="line">	filename = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error Usage!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fd = open(filename, O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t open file %s\r\n&quot;</span>, filename);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		err = read(fd, &amp;inputevent, <span class="keyword">sizeof</span>(inputevent));</span><br><span class="line">		<span class="keyword">if</span> (err &gt; <span class="number">0</span>) &#123; <span class="comment">/* 读取数据成功 */</span></span><br><span class="line">			<span class="keyword">switch</span> (inputevent.type) &#123;</span><br><span class="line">				<span class="keyword">case</span> EV_KEY:</span><br><span class="line">					<span class="keyword">if</span> (inputevent.code &lt; BTN_MISC) &#123; <span class="comment">/* 键盘键值 */</span></span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">&quot;key %d %s\r\n&quot;</span>, inputevent.code,</span><br><span class="line">                               inputevent.value ? <span class="string">&quot;press&quot;</span> : <span class="string">&quot;release&quot;</span>);</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="built_in">printf</span>(<span class="string">&quot;button %d %s\r\n&quot;</span>, inputevent.code,</span><br><span class="line">                               inputevent.value ? <span class="string">&quot;press&quot;</span> : <span class="string">&quot;release&quot;</span>);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="comment">/* 其他类型的事件，自行处理 */</span></span><br><span class="line">				<span class="keyword">case</span> EV_REL:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">case</span> EV_ABS:</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;读取数据失败\r\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们向 Linux 内核成功注册 input_dev 设备以后，会在<code>/dev/input </code>目录下生成一个名为<code>“eventX(X=0….n)”</code>的文件，这个<code>/dev/input/eventX </code>就是对应的 input 设备文件。</p>
<p>测试：<br>在加载<code>keyinput.ko</code>驱动模块之前，先看一下<code>/dev/input </code>目录下都有哪些文件：<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png" alt="image"><br><code>modprobe keyinput.ko</code> 可以看到多一个<code>input1</code>,就是我们刚创建的设备节点：<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png" alt="image"><br>运行app:<br><code>./keyinputApp /dev/input/event1</code><br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png" alt="image"><br>可以看出，当我们按下或者释放开发板上的按键以后都会在终端上输出相应的内容，提示我们哪个按键按下或释放了，在 Linux 内核中 <code>KEY_0</code> 为 <code>11</code>。<br>另外，我们也可以不用<code>keyinputApp</code>来测试驱动，可以直接使用<code>hexdump</code>命令来查看<code>/dev/input/event1 </code>文件内容，输入如下命令：<br><code>hexdump /dev/input/event1</code><br>这就是<code>input_event</code> 类型的原始事件数据值：<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png" alt="image"><br>含义如下：<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png" alt="image"><br><code>type </code>为事件类型，<code>EV_KEY </code>事件值为 1，<code>EV_SYN </code>事件值为0。因此第 1 行表示 <code>EV_KEY </code>事件，第 2 行表示 <code>EV_SYN </code>事件。code 为事件编码，也就是按键号，<code>KEY_0</code> 这个按键编号为 11，对应的十六进制为 <code>0xb</code>，因此第1 行表示 <code>KEY_0 </code>这个按键事件，最后的 value 就是按键值，为 1 表示按下，为 0 的话表示松开。<br>综上所述，上述原始事件值含义如下：<br>第 1 行，按键<code>(KEY_0)</code>按下事件。<br>第 2 行，<code>EV_SYN</code> 同步事件，因为每次上报按键事件以后都要同步的上报一个 <code>EV_SYN</code> 事件。<br>第 3 行，按键<code>(KEY_0)</code>松开事件。<br>第 4 行，<code>EV_SYN </code>同步事件，和第 2 行一样。</p>
<h1><span id="4-linux-input-zi-xi-tong-bu-chong-linux-zi-dai-an-jian-qu-dong">4 Linux input子系统补充-Linux 自带按键驱动</span><a href="#4-linux-input-zi-xi-tong-bu-chong-linux-zi-dai-an-jian-qu-dong" class="header-anchor">#</a></h1><p>Linux 内核也自带了 KEY 驱动，如果要使用内核自带的 KEY 驱动的话需要配置 Linux 内核，不过 Linux 内核一般默认已经使能了 KEY 驱动。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line">	-&gt; Input device support</span><br><span class="line">		-&gt; Generic input <span class="title function_">layer</span> <span class="params">(needed <span class="keyword">for</span> keyboard, mouse, ...)</span> <span class="params">(INPUT [=y])</span></span><br><span class="line">			-&gt; <span class="title function_">Keyboards</span> <span class="params">(INPUT_KEYBOARD [=y])</span></span><br><span class="line">				-&gt;GPIO Buttons</span><br></pre></td></tr></table></figure>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png" alt="image"></p>
<p>选中以后就会在<code>.config</code> 文件中出现<code>“CONFIG_KEYBOARD_GPIO=y”</code>这一行，Linux 内核<br>就会根据这一行来将 KEY 驱动文件编译进 Linux 内核。Linux 内核自带的 KEY 驱动文件为<br><code>drivers/input/keyboard/gpio_keys.c</code>，<code>gpio_keys.c </code>采用了 platform 驱动框架，在 KEY 驱动上使用<br>了 input 子系统实现。</p>
<h2><span id="4-1-gpio-keys-yuan-ma-fen-xi">4.1 gpio_keys源码分析</span><a href="#4-1-gpio-keys-yuan-ma-fen-xi" class="header-anchor">#</a></h2><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png" alt="image"><br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png" alt="image"></p>
<p>要使用 Linux 内 核 自 带 的 按 键 驱 动 程 序 很 简 单 ， 只 需 要 根 据<code>Documentation/devicetree/bindings/input/gpio-keys.txt </code>这个文件在设备树中添加指定的设备节点即可，节点要求如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">①、节点名字为“gpio-keys”。</span><br><span class="line">②、gpio-keys 节点的 compatible 属性值一定要设置为“gpio-keys”。</span><br><span class="line">③、所有的 KEY 都是 gpio-keys 的子节点，每个子节点可以用如下属性描述自己：</span><br><span class="line">	gpios：KEY 所连接的 GPIO 信息。</span><br><span class="line">	interrupts：KEY 所使用 GPIO 中断信息，不是必须的，可以不写。</span><br><span class="line">	label：KEY 名字</span><br><span class="line">	linux,code：KEY 要模拟的按键，也就是示例代码</span><br><span class="line">④、如果按键要支持连按的话要加入 autorepeat。</span><br></pre></td></tr></table></figure>
<p>打开<code> imx6ull-alientek-emmc.dts</code>定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gpio-keys &#123;</span><br><span class="line">	compatible = <span class="string">&quot;gpio-keys&quot;</span>;</span><br><span class="line">	<span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">	<span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">	autorepeat;</span><br><span class="line">	key0 &#123;</span><br><span class="line">		label = <span class="string">&quot;GPIO Key Enter&quot;</span>;</span><br><span class="line">		linux,code = &lt;KEY_ENTER&gt;;</span><br><span class="line">		gpios = &lt;&amp;gpio1 <span class="number">18</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ALPHA 开发板 KEY 按键信息，名字设置为<code>“GPIO Key Enter”</code>，这里我们将开发板上的 KEY 按键设置为<code>“EKY_ENTER”</code>这个按键，也就是回车键，效果和键盘上的回车键一样。</p>
<h3><span id="4-1-1-gpio-keys-probe-fen-xi">4.1.1 gpio_keys_probe分析</span><a href="#4-1-1-gpio-keys-probe-fen-xi" class="header-anchor">#</a></h3><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png" alt="image"><br>可以看到就是对<code>input</code>子系统的调用封装，实例化了一个利用input子系统写的驱动程序。<br>调用<code> gpio_keys_get_devtree_pdata</code> 函数从设备树中获取到 KEY 相关的设备节点信息。<br>使用 <code>devm_input_allocate_device</code> 函数申请 input_dev。<br>初始化<code> input_dev</code>。<br>设置<code> input_dev 事件</code>，这里设置了<code> EV_REP</code> 事件.<br><strong>调用 <code>gpio_keys_setup_key</code> 函数继续设置 KEY，此函数会设置 input_dev 的EV_KEY 事件已经事件码(也就是 KEY 模拟为哪个按键)</strong><br>调用 <code>input_register_device</code> 函数向 Linux 系统注册<code> input_dev</code>。</p>
<h4><span id="4-1-1-1-gpio-keys-setup-key">4.1.1.1 gpio_keys_setup_key</span><a href="#4-1-1-1-gpio-keys-setup-key" class="header-anchor">#</a></h4><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png" alt="image"></p>
<p>调用<code> input_set_capability</code> 函数设置<code> EV_KEY</code> 事件以及 KEY 的按键类型，也就是 KEY 作为哪个按键？我们会在设备树里面设置指定的 KEY 作为哪个按键.</p>
<h4><span id="4-1-1-2-gpio-keys-irq-isr">4.1.1.2 gpio_keys_irq_isr</span><a href="#4-1-1-2-gpio-keys-irq-isr" class="header-anchor">#</a></h4><p>当dts对应的按键按下后，中断进行响应，函数如下：<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png" alt="image"><br>可以看到同理还是调用input_event， input_sync进行上报事件。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png" alt="image-20240825144156414"></p>
<h2><span id="4-2-ce-shi-yan-zheng">4.2 测试验证</span><a href="#4-2-ce-shi-yan-zheng" class="header-anchor">#</a></h2><p>烧录新的dtb和kernel进去，可以看出存在 event1 这个文件，这个文件就是 KEY 对应的设备文件，使用<br>hexdump 命令来查看<code>/dev/input/event1 </code>文件：<br><code>hexdump /dev/input/event1</code><br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png" alt="image"><br>大家如果发现按下 KEY 按键以后没有反应，那么请检查一下三方面：<br>①、是否使能 Linux 内核 KEY 驱动。<br>②、设备树中 <code>gpio-keys</code> 节点是否创建成功。<br>③、在设备树中是否有其他外设也使用了 KEY 按键对应的 GPIO，但是我们并没有删除掉这些外设信息。检查 Linux 启动 log 信息，看看是否有类似下面这条信息:<br><code>gpio-keys gpio_keys：Failed to request GPIO 18, error -16</code></p>
<h1><span id="5-linux-input-zi-xi-tong-dian-rong-hong-mo-ping-ying-yong">5 Linux input子系统-电容触摸屏应用</span><a href="#5-linux-input-zi-xi-tong-dian-rong-hong-mo-ping-ying-yong" class="header-anchor">#</a></h1><h2><span id="5-1-ft5426-dian-rong-hong-mo-ping-jian-jie">5.1 FT5426电容触摸屏简介</span><a href="#5-1-ft5426-dian-rong-hong-mo-ping-jian-jie" class="header-anchor">#</a></h2><h3><span id="5-1-1-te-xing">5.1.1 特性</span><a href="#5-1-1-te-xing" class="header-anchor">#</a></h3><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png" alt="image"></p>
<p>特性如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 自动模式切换。</span><br><span class="line"><span class="number">2.</span> <span class="number">100</span>hz采样率</span><br><span class="line"><span class="number">3.</span> 自动校准</span><br><span class="line"><span class="number">4.</span> i2c接口，速率高达<span class="number">400</span>k</span><br><span class="line"><span class="number">5.</span> <span class="number">12</span>位ADC精度转换</span><br></pre></td></tr></table></figure>

<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png" alt="image"></p>
<p>触摸 IC 提供了中断信号引脚(INT)，可以通过中断来获取触摸信息。电容触摸屏得到的是触摸位置绝对信息以及触摸屏是否有按下。</p>
<h3><span id="5-1-2-i2c-chuan-shu-ge-shi">5.1.2 i2c传输格式</span><a href="#5-1-2-i2c-chuan-shu-ge-shi" class="header-anchor">#</a></h3><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/23.1.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png" alt="image"></p>
<p>可以看到slave addr是7位，第8位表示方向。数据是每次传输1byte。</p>
<h3><span id="5-1-3-shang-dian-ji-fu-wei-shi-xu">5.1.3 上电及复位时序</span><a href="#5-1-3-shang-dian-ji-fu-wei-shi-xu" class="header-anchor">#</a></h3><p><a name="power_on_sequence"></a></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png" alt="image"></p>
<h3><span id="5-1-4-ji-cun-qi-miao-shu">5.1.4 寄存器描述</span><a href="#5-1-4-ji-cun-qi-miao-shu" class="header-anchor">#</a></h3><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png" alt="image"></p>
<h2><span id="5-2-duo-dian-hong-mo-mt-xie-yi">5.2 多点触摸(MT)协议</span><a href="#5-2-duo-dian-hong-mo-mt-xie-yi" class="header-anchor">#</a></h2><p>多点电容触摸屏协议，文档路径为：<code>Documentation/input/multitouch-protocol.txt。</code></p>
<p>老版本的 2.x 版本 linux 内核是不支持多点电容触摸的(<code>Multi-touch，简称 MT</code>)，MT 协议是后面加入 的。</p>
<p>MT 协议被分为两种类型，<code>Type A</code> 和 <code>TypeB</code>，这两种类型的区别如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Type A：适用于触摸点不能被区分或者追踪，此类型的设备上报原始数据(此类型在实际使用中非常少)。</span><br><span class="line">Type B：适用于有硬件追踪并能区分触摸点的触摸设备，此类型设备通过 slot 更新某一个 触摸点的信息，FT5426 就属于此类型，一般的多点电容触摸屏 IC 都有此能力。</span><br></pre></td></tr></table></figure>

<h3><span id="5-2-1-abs-mt-shi-jian">5.2.1 ABS_MT 事件</span><a href="#5-2-1-abs-mt-shi-jian" class="header-anchor">#</a></h3><p>ABS_MT 事件是用于多点触摸的，ABS_MT 事件定义在文件 <code>include/uapi/linux/input.h</code> 中,  上报给 linux 内核。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_SLOT 0x2f <span class="comment">/* MT slot being modified */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOUCH_MAJOR 0x30 <span class="comment">/* Major axis of touching ellipse */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOUCH_MINOR 0x31 <span class="comment">/* Minor axis (omit if circular) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_WIDTH_MAJOR 0x32 <span class="comment">/* Major axis of approaching ellipse */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_WIDTH_MINOR 0x33 <span class="comment">/* Minor axis (omit if circular) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_ORIENTATION 0x34 <span class="comment">/* Ellipse orientation */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_POSITION_X 0x35 <span class="comment">/* Center X touch position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_POSITION_Y 0x36 <span class="comment">/* Center Y touch position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_TYPE 0x37 <span class="comment">/* Type of touching device */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_BLOB_ID 0x38 <span class="comment">/* Group a set of packets as a blob */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TRACKING_ID 0x39 <span class="comment">/* Unique ID of initiated contact */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_PRESSURE 0x3a <span class="comment">/* Pressure on contact area */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_DISTANCE 0x3b <span class="comment">/* Contact hover distance */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_X 0x3c <span class="comment">/* Center X tool position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ABS_MT_TOOL_Y 0x3d <span class="comment">/* Center Y tool position */</span></span></span><br></pre></td></tr></table></figure>

<p><code>ABS_MT_POSITION_X 和 ABS_MT_POSITION_Y </code>用来上 报触摸 点的 (X,Y) 坐标 信息。<code>ABS_MT_SLOT </code>用来上 报触摸点 ID ， 对 于 Type B 类型的设备，需要用到 <code>ABS_MT_TRACKING_ID </code>事件来区分触摸点。</p>
<h4><span id="5-2-1-1-input-mt-sync-ge-chi-typea-lei-de-bu-tong-hong-mo-dian">5.2.1.1 input_mt_sync-隔离typeA类的不同触摸点</span><a href="#5-2-1-1-input-mt-sync-ge-chi-typea-lei-de-bu-tong-hong-mo-dian" class="header-anchor">#</a></h4><p>对于<code> Type A</code> 类型的设备，通过<code> input_mt_sync()</code>函数来隔离不同的触摸点数据信息。<code>nput_mt_sync() </code>函数会触发 <code>SYN_MT_REPORT </code>事件，此事件会通知接收者获取当前触摸数据，并且准备接收 下一个触摸点数据。</p>
<p><code>void input_mt_sync(struct input_dev *dev);</code></p>
<h4><span id="5-2-1-2-input-mt-slot-qu-fen-typeb-lei-de-bu-tong-hong-mo-dian">5.2.1.2 input_mt_slot-区分typeB类的不同触摸点</span><a href="#5-2-1-2-input-mt-slot-qu-fen-typeb-lei-de-bu-tong-hong-mo-dian" class="header-anchor">#</a></h4><p>对于<code>Type B</code>类型的设备，上报触摸点信息的时候需要通过<code> input_mt_slot()</code>函数区分是哪一 个触摸点。</p>
<p><code>void input_mt_slot(struct input_dev *dev, int slot);</code></p>
<p>第一个参数是 input_dev 设备，第二个参数 slot 用于指定当前上报的是 哪个触摸点信息。<code>input_mt_slot()</code>函数会触发 <code>ABS_MT_SLOT </code>事件，此事件会告诉接收者当前 正在更新的是哪个触摸点(slot)的数据。</p>
<h4><span id="5-2-1-3-input-sync-jie-shu-shang-bao">5.2.1.3 input_sync-结束上报</span><a href="#5-2-1-3-input-sync-jie-shu-shang-bao" class="header-anchor">#</a></h4><p>不管是哪个类型的设备，最终都要调用<code> input_sync()</code>函数来标识多点触摸信息传输完成，告 诉接收者处理之前累计的所有消息，并且准备好下一次接收。</p>
<p>可以通过 slot 的 <code>ABS_MT_TRACKING_ID </code>来新增、替换或删除触摸点。一个非负数 的 ID 表示一个有效的触摸点，-1 这个 ID 表示未使用 slot。一个以前不存在的 ID 表示这是一个 新加的触摸点，一个 ID 如果再也不存在了就表示删除了。上报 <code>SYN_REPORT </code>事件。</p>
<h4><span id="5-2-1-4-input-report-abs-shang-bao-zuo-biao">5.2.1.4 input_report_abs-上报坐标</span><a href="#5-2-1-4-input-report-abs-shang-bao-zuo-biao" class="header-anchor">#</a></h4><p>上报触摸屏原始数据。</p>
<p><code>void input_report_abs(struct input_dev *dev, unsigned int code, int value);</code></p>
<h3><span id="5-2-2-type-a-hong-mo-dian-xin-xi-shang-bao-liu-cheng">5.2.2 Type A 触摸点信息上报流程</span><a href="#5-2-2-type-a-hong-mo-dian-xin-xi-shang-bao-liu-cheng" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>]<span class="comment">//通过 ABS_MT_POSITION_X 事件上报第一个触摸点的 X 坐标数据，通过input_report_abs 函数实现，下面同理</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>]<span class="comment">//上报第一个触摸点的 Y 坐标数据</span></span><br><span class="line">SYN_MT_REPORT <span class="comment">//上报 SYN_MT_REPORT 事件，通过调用 input_mt_sync 函数来实现。</span></span><br><span class="line"></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>]<span class="comment">//通过 ABS_MT_POSITION_X 事件上报第二个触摸点的 X 坐标数据</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>]<span class="comment">//上报第二个触摸点的 Y 坐标数据</span></span><br><span class="line">SYN_MT_REPORT <span class="comment">//上报 SYN_MT_REPORT 事件,通知接收者获取坐标</span></span><br><span class="line">SYN_REPORT <span class="comment">//最后，上报 SYN_REPORT 事件，通过调用 input_sync 函数实现。</span></span><br></pre></td></tr></table></figure>

<p>Linux 内核里面也有<code> Type A</code> 类型的多点触摸驱动，如<code> st2332.c</code>。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png" alt="image-20240825151728439"></p>
<h3><span id="5-2-3-type-b-hong-mo-dian-xin-xi-shang-bao-liu-cheng">5.2.3 Type B 触摸点信息上报流程</span><a href="#5-2-3-type-b-hong-mo-dian-xin-xi-shang-bao-liu-cheng" class="header-anchor">#</a></h3><p>对于<code>Type B</code>类型的设备，发送触摸点信息的时序如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_SLOT <span class="number">0</span> <span class="comment">/* 上报 ABS_MT_SLOT 事件。</span></span><br><span class="line"><span class="comment">    每次上报一个触摸点坐标之前要先使用input_mt_slot函数上报当前触摸点SLOT，触摸点的SLOT其实就是触摸点ID，需要由触摸 IC 提供</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">45</span> <span class="comment">/*根据 Type B 的要求，每个 SLOT 必须关联一个 ABS_MT_TRACKING_ID，通过</span></span><br><span class="line"><span class="comment">	修改 SLOT 关联的 ABS_MT_TRACKING_ID 来完成对触摸点的添加、替换或删除。具体用到</span></span><br><span class="line"><span class="comment">	的函数就是 input_mt_report_slot_state，如果是添加一个新的触摸点，那么此函数的第三个参数</span></span><br><span class="line"><span class="comment">	active 要设置为 true，linux 内核会自动分配一个 ABS_MT_TRACKING_ID 值，不需要用户去指</span></span><br><span class="line"><span class="comment">	定具体的 ABS_MT_TRACKING_ID 值。</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">0</span>] <span class="comment">//上报触摸点 0 的 X 轴坐标，使用函数 input_report_abs 来完成</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">0</span>] <span class="comment">//上报触摸点 0 的 y 轴坐标</span></span><br><span class="line"></span><br><span class="line">ABS_MT_SLOT <span class="number">1</span> <span class="comment">//同理， 上报 ABS_MT_SLOT 事件。</span></span><br><span class="line">ABS_MT_TRACKING_ID <span class="number">46</span></span><br><span class="line">ABS_MT_POSITION_X x[<span class="number">1</span>] <span class="comment">//坐标1的x</span></span><br><span class="line">ABS_MT_POSITION_Y y[<span class="number">1</span>] <span class="comment">//坐标1的y</span></span><br><span class="line">SYN_REPORT <span class="comment">//最后，上报 SYN_REPORT 事件，通过调用 input_sync 函数实现。</span></span><br></pre></td></tr></table></figure>

<p>当一个触摸点移除以后，同样需要通过 SLOT 关联的<code>ABS_MT_TRACKING_ID</code>来处理:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ABS_MT_TRACKING_ID <span class="number">-1</span> <span class="comment">/*当一个触摸点(SLOT)移除以后，需要通过 ABS_MT_TRACKING_ID 事件发送一</span></span><br><span class="line"><span class="comment">个-1 给内核。方法很简单，同样使用 input_mt_report_slot_state 函数来完成，只需要将此函数的</span></span><br><span class="line"><span class="comment">第三个参数 active 设置为 false 即可，不需要用户手动去设置-1。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">SYN_REPORT</span><br></pre></td></tr></table></figure>

<p>Linux 内核里面有大量的 <code>Type B</code> 类型的多点触摸驱动程序,<code>drivers/input/touchscreen/ili210x.c </code>上报示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ili210x_report_events</span><span class="params">(<span class="keyword">struct</span> input_dev *input, <span class="type">const</span> <span class="keyword">struct</span> touchdata *touchdata)</span> &#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">bool</span> touch;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> x, y;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">finger</span> *<span class="title">finger</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_TOUCHES; i++) &#123;</span><br><span class="line">		input_mt_slot(input, i);<span class="comment">//上报ABS_MT_SLOT事件</span></span><br><span class="line">		finger = &amp;touchdata-&gt;finger[i];</span><br><span class="line">		touch = touchdata-&gt;status &amp; (<span class="number">1</span> &lt;&lt; i);</span><br><span class="line">        <span class="comment">//上报ABS_MT_TRACKING_ID和ABS_MT_TOOL_TYPE事件</span></span><br><span class="line">		input_mt_report_slot_state(input, MT_TOOL_FINGER, touch);</span><br><span class="line">		<span class="keyword">if</span> (touch) &#123;</span><br><span class="line">			x = finger-&gt;x_low | (finger-&gt;x_high &lt;&lt; <span class="number">8</span>);</span><br><span class="line">			y = finger-&gt;y_low | (finger-&gt;y_high &lt;&lt; <span class="number">8</span>);</span><br><span class="line">			input_report_abs(input, ABS_MT_POSITION_X, x);</span><br><span class="line">			input_report_abs(input, ABS_MT_POSITION_Y, y);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	input_mt_report_pointer_emulation(input, <span class="literal">false</span>);</span><br><span class="line">	input_sync(input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="5-2-4-abs-mt-qi-ta-shi-jian">5.2.4 ABS_MT其他事件</span><a href="#5-2-4-abs-mt-qi-ta-shi-jian" class="header-anchor">#</a></h3><p>如果设备支持的话，还可以使用 <code>ABS_MT_TOUCH_MAJOR</code> 和 <code>ABS_MT_WIDTH_MAJOR</code> 这两个消息上报触摸面积信息，关于 其他 ABS_MT 事件的具体含义大家可以查看 Linux 内核中的 <code>multi-touch-protocol.txt</code> 文档。</p>
<h4><span id="5-2-4-1-abs-mt-tool-type">5.2.4.1 ABS_MT_TOOL_TYPE</span><a href="#5-2-4-1-abs-mt-tool-type" class="header-anchor">#</a></h4><p>上报触摸工具类型。</p>
<p>很多内核驱动都不能区分出触摸设备类型 ，是手指还是触摸 笔？ 这种情况下， 这个事件可以忽略掉 。目前的协议支持 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MT_TOOL_FINGER(手指)</span><br><span class="line">MT_TOOL_PEN(笔)</span><br><span class="line">MT_TOOL_PALM(手掌)这三种触摸设备类型</span><br></pre></td></tr></table></figure>

<p>要 上 报 ABS_MT_TOOL_TYPE 事件，那么可以使用<code> input_mt_report_slot_state</code> 函数来完成此工作。</p>
<h2><span id="5-3-duo-dian-hong-mo-api">5.3 多点触摸API</span><a href="#5-3-duo-dian-hong-mo-api" class="header-anchor">#</a></h2><h3><span id="5-3-1-input-mt-init-slots">5.3.1 input_mt_init_slots</span><a href="#5-3-1-input-mt-init-slots" class="header-anchor">#</a></h3><p>初始化 MT 的输入 slots槽，<code>drivers/input/input-mt.c</code>。</p>
<p><code>int input_mt_init_slots( struct input_dev *dev, unsigned int num_slots, unsigned int flags);</code></p>
<p>num_slots: 要使用的 SLOT 数量，也就是触摸点的数量。</p>
<p>flags：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_POINTER 0x0001 <span class="comment">/* pointer device, e.g. trackpad */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_DIRECT 0x0002 <span class="comment">/* direct device, e.g. touchscreen */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_DROP_UNUSED0x0004 <span class="comment">/* drop contacts not seen in frame */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_TRACK 0x0008 <span class="comment">/* use in-kernel tracking */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INPUT_MT_SEMI_MT 0x0010 <span class="comment">/* semi-mt device, finger count handled manually */</span></span></span><br></pre></td></tr></table></figure>

<h3><span id="5-3-2-input-mt-slot">5.3.2 input_mt_slot</span><a href="#5-3-2-input-mt-slot" class="header-anchor">#</a></h3><p> Type B类型，此函数用于产生 <code>ABS_MT_SLOT </code>事件，告诉内核当前上报的是哪个触摸点的坐标数据，定义在文件<code> include/linux/input/mt.h</code>。</p>
<p><code>void input_mt_slot(struct input_dev *dev, int slot);</code></p>
<p>slot：当前发送的是哪个 slot 的坐标信息，也就是哪个触摸点。</p>
<h3><span id="5-3-3-input-mt-report-slot-state">5.3.3 input_mt_report_slot_state</span><a href="#5-3-3-input-mt-report-slot-state" class="header-anchor">#</a></h3><p>Type B类型，用于产生<code>ABS_MT_TRACKING_ID和ABS_MT_TOOL_TYPE </code>事件 ，<code>ABS_MT_TRACKING_ID</code>事件给slot关联一个<code>ABS_MT_TRACKING_ID </code>，<code> ABS_MT_TOOL_TYPE</code>事件指定触摸类型（是笔还是手指等 ）。此函数定义在文件<code>drivers/input/input-mt.c</code></p>
<p><code>void input_mt_report_slot_state( struct input_dev *dev, unsigned int tool_type, bool active);</code></p>
<p>tool_type：触摸类型，可以选择 MT_TOOL_FINGER(手指)、MT_TOOL_PEN(笔)或 MT_TOOL_PALM(手掌)，对于多点电容触摸屏来说一般都是手指。 </p>
<p>active：true，连续触摸，input 子系统内核会自动分配一个 ABS_MT_TRACKING_ID 给 slot。 false，触摸点抬起，表示某个触摸点无效了，input 子系统内核会分配一个-1 给 slot，表示触摸 点溢出。</p>
<h3><span id="5-3-4-input-report-abs">5.3.4 input_report_abs</span><a href="#5-3-4-input-report-abs" class="header-anchor">#</a></h3><p>上报<code>ABS_MT_POSITION_X 和 ABS_MT_POSITION_Y </code>事件，上报坐标。include&#x2F;linux&#x2F;input.h。</p>
<p><code>void input_report_abs( struct input_dev *dev, unsigned int code, int value);</code></p>
<p><code>code</code>：要上报的是什么数据，设置为<code> ABS_MT_POSITION_X</code> 或 <code>ABS_MT_POSITION_Y</code></p>
<p><code>value</code>：具体的 X 轴或 Y 轴坐标数据值。</p>
<h3><span id="5-3-5-input-mt-report-pointer-emulation">5.3.5 input_mt_report_pointer_emulation</span><a href="#5-3-5-input-mt-report-pointer-emulation" class="header-anchor">#</a></h3><p>如果追踪到的触摸点数量多于当前上报的数量，驱动程序使用 <code>BTN_TOOL_TAP</code> 事件来通 知用户空间当前追踪到的触摸点总数量，然后调用<code>input_mt_report_pointer_emulation</code>函数将 <code>use_count</code> 参数设置为 false。否则的话将 use_count 参数设置为 true，表示当前的触摸点数量(此函数会获取到具体的触摸点数量，不需要用户给出)，<code>drivers/input/input-mt.c</code></p>
<p><code>void input_mt_report_pointer_emulation(struct input_dev *dev, bool use_count);</code></p>
<p><code>use_count</code>：true，有效的触摸点数量；false，追踪到的触摸点数量多于当前上报的数量.</p>
<h2><span id="5-4-linux-hong-mo-ping-qu-dong-shi-li-ft5426">5.4 Linux触摸屏驱动示例-FT5426</span><a href="#5-4-linux-hong-mo-ping-qu-dong-shi-li-ft5426" class="header-anchor">#</a></h2><h3><span id="5-4-1-she-bei-shu-tian-jia">5.4.1 设备树添加</span><a href="#5-4-1-she-bei-shu-tian-jia" class="header-anchor">#</a></h3><h4><span id="5-4-1-1-iomux-yin-jiao-pei-zhi">5.4.1.1 iomux引脚配置</span><a href="#5-4-1-1-iomux-yin-jiao-pei-zhi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_tsc: tscgrp &#123;</span><br><span class="line">	fsl,pins = &lt;</span><br><span class="line">		MX6UL_PAD_GPIO1_IO09__GPIO1_IO09 <span class="number">0xF080</span> <span class="comment">/* TSC_INT */</span></span><br><span class="line">	&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">pinctrl_tsc_reset: tsc_reset &#123;</span><br><span class="line">	fsl,pins = &lt;</span><br><span class="line">		MX6ULL_PAD_SNVS_TAMPER9__GPIO5_IO09 <span class="number">0x10B0</span> <span class="comment">/* TSC_RST */</span></span><br><span class="line">	&gt;;</span><br><span class="line">&#125;</span><br><span class="line">pinctrl_i2c2: i2c2grp &#123;</span><br><span class="line">	fsl,pins = &lt;</span><br><span class="line">		MX6UL_PAD_UART5_TX_DATA__I2C2_SCL <span class="number">0x4001b8b0</span></span><br><span class="line">		MX6UL_PAD_UART5_RX_DATA__I2C2_SDA <span class="number">0x4001b8b0</span></span><br><span class="line">	&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>触摸屏要用到4个IO, i2c 2个引脚和1个<code>RST</code>, 1个<code>INT</code>引脚。</p>
<h4><span id="5-4-1-2-ft5426-jie-dian">5.4.1.2 ft5426节点</span><a href="#5-4-1-2-ft5426-jie-dian" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&amp;i2c2 &#123;</span><br><span class="line">	clock_frequency = &lt;<span class="number">100000</span>&gt;;</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_i2c2&gt;;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">	......</span><br><span class="line">	ft5426: ft5426@<span class="number">38</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;edt,edt-ft5426&quot;</span>;</span><br><span class="line">		reg = &lt;<span class="number">0x38</span>&gt;;</span><br><span class="line">		pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">		pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_tsc</span><br><span class="line">			&amp;pinctrl_tsc_reset&gt;;</span><br><span class="line">		interrupt-parent = &lt;&amp;gpio1&gt;;</span><br><span class="line">		interrupts = &lt;<span class="number">9</span> <span class="number">0</span>&gt;;</span><br><span class="line">		reset-gpios = &lt;&amp;gpio5 <span class="number">9</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">		interrupt-gpios = &lt;&amp;gpio1 <span class="number">9</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>找到<code>i2c2</code>节点，引用<code>pinctrl_i2c2</code>，设置好I2c的iomux。设置时钟100k, status开启okay。</p>
<p>添加子节点<code>ft5426</code>，器件地址为 <code>0X38</code>，引用<code>pinctrl_tsc</code>， <code>pinctrl_tsc_reset</code>设置<code>rst</code>和<code>int</code>引脚的iomux。</p>
<p><code>interrupt-parent</code> 属性描述中断 IO 对应的 GPIO 组为<code> GPIO1</code>。</p>
<p><code>interrupts</code> 属性描述中断 IO 对应的是 GPIO1 组的<code> IOI09</code>。</p>
<p><code>reset-gpios </code>属性描述复位 IO 对应的 GPIO 为 <code>GPIO5_IO09</code>。</p>
<p><code>interrupt-gpios </code>属性描述中断 IO 对应的 GPIO 为 <code>GPIO1_IO09</code>。</p>
<h3><span id="5-4-2-ft5426-qu-dong-yuan-ma-jie-xi">5.4.2 FT5426驱动源码解析</span><a href="#5-4-2-ft5426-qu-dong-yuan-ma-jie-xi" class="header-anchor">#</a></h3><details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ft5x06.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ratelimit.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/interrupt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/debugfs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input/mt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input/touchscreen.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/input/edt-ft5x06.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SUPPORT_POINTS		5			<span class="comment">/* 5点触摸 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_EVENT_DOWN		0x00		<span class="comment">/* 按下 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_EVENT_UP			0x01		<span class="comment">/* 抬起 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_EVENT_ON			0x02		<span class="comment">/* 接触 	*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TOUCH_EVENT_RESERVED	0x03		<span class="comment">/* 保留 	*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* FT5X06寄存器相关宏定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5X06_TD_STATUS_REG	0X02		<span class="comment">/*	状态寄存器地址 		*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5x06_DEVICE_MODE_REG	0X00 		<span class="comment">/* 模式寄存器 			*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5426_IDG_MODE_REG		0XA4		<span class="comment">/* 中断模式				*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FT5X06_READLEN			29			<span class="comment">/* 要读取的寄存器个数 	*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ft5x06_dev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">nd</span>;</span> 				<span class="comment">/* 设备节点 		*/</span></span><br><span class="line">	<span class="type">int</span> irq_pin,reset_pin;					<span class="comment">/* 中断和复位IO		*/</span></span><br><span class="line">	<span class="type">int</span> irqnum;								<span class="comment">/* 中断号    		*/</span></span><br><span class="line">	<span class="type">void</span> *private_data;						<span class="comment">/* 私有数据 		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">input_dev</span> *<span class="title">input</span>;</span>				<span class="comment">/* input结构体 		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span>;</span>				<span class="comment">/* I2C客户端 		*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">ft5x06_dev</span> <span class="title">ft5x06</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ft5x06_ts_reset</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="keyword">struct</span> ft5x06_dev *dev)</span>&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (gpio_is_valid(dev-&gt;reset_pin)) &#123;</span><br><span class="line">		<span class="comment">/* 申请复位IO，并且默认输出低电平 */</span></span><br><span class="line">		ret = devm_gpio_request_one(&amp;client-&gt;dev,	</span><br><span class="line">					dev-&gt;reset_pin, GPIOF_OUT_INIT_LOW,</span><br><span class="line">					<span class="string">&quot;edt-ft5x06 reset&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">		msleep(<span class="number">5</span>);</span><br><span class="line">		gpio_set_value(dev-&gt;reset_pin, <span class="number">1</span>);<span class="comment">/* 输出高电平，停止复位 */</span></span><br><span class="line">		msleep(<span class="number">300</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ft5x06_read_regs</span><span class="params">(<span class="keyword">struct</span> ft5x06_dev *dev, u8 reg, <span class="type">void</span> *val, <span class="type">int</span> len)</span>&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>[2];</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;client;</span><br><span class="line">	<span class="comment">/* msg[0]为发送要读取的首地址 */</span></span><br><span class="line">	msg[<span class="number">0</span>].addr = client-&gt;addr;			<span class="comment">/* ft5x06地址 */</span></span><br><span class="line">	msg[<span class="number">0</span>].flags = <span class="number">0</span>;					<span class="comment">/* 标记为发送数据 */</span></span><br><span class="line">	msg[<span class="number">0</span>].buf = &amp;reg;					<span class="comment">/* 读取的首地址 */</span></span><br><span class="line">	msg[<span class="number">0</span>].len = <span class="number">1</span>;						<span class="comment">/* reg长度*/</span></span><br><span class="line">	<span class="comment">/* msg[1]读取数据 */</span></span><br><span class="line">	msg[<span class="number">1</span>].addr = client-&gt;addr;			<span class="comment">/* ft5x06地址 */</span></span><br><span class="line">	msg[<span class="number">1</span>].flags = I2C_M_RD;			<span class="comment">/* 标记为读取数据*/</span></span><br><span class="line">	msg[<span class="number">1</span>].buf = val;					<span class="comment">/* 读取数据缓冲区 */</span></span><br><span class="line">	msg[<span class="number">1</span>].len = len;					<span class="comment">/* 要读取的数据长度*/</span></span><br><span class="line">	ret = i2c_transfer(client-&gt;adapter, msg, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span>(ret == <span class="number">2</span>) &#123;</span><br><span class="line">		ret = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ret = -EREMOTEIO;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> s32 <span class="title function_">ft5x06_write_regs</span><span class="params">(<span class="keyword">struct</span> ft5x06_dev *dev, u8 reg, u8 *buf, u8 len)</span> &#123;</span><br><span class="line">	u8 b[<span class="number">256</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">i2c_client</span> *<span class="title">client</span> =</span> (<span class="keyword">struct</span> i2c_client *)dev-&gt;client;</span><br><span class="line">	b[<span class="number">0</span>] = reg;					<span class="comment">/* 寄存器首地址 */</span></span><br><span class="line">	<span class="built_in">memcpy</span>(&amp;b[<span class="number">1</span>],buf,len);		<span class="comment">/* 将要写入的数据拷贝到数组b里面 */</span></span><br><span class="line">	msg.addr = client-&gt;addr;	<span class="comment">/* ft5x06地址 */</span></span><br><span class="line">	msg.flags = <span class="number">0</span>;				<span class="comment">/* 标记为写数据 */</span></span><br><span class="line"></span><br><span class="line">	msg.buf = b;				<span class="comment">/* 要写入的数据缓冲区 */</span></span><br><span class="line">	msg.len = len + <span class="number">1</span>;			<span class="comment">/* 要写入的数据长度 */</span></span><br><span class="line">	<span class="keyword">return</span> i2c_transfer(client-&gt;adapter, &amp;msg, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">ft5x06_write_reg</span><span class="params">(<span class="keyword">struct</span> ft5x06_dev *dev, u8 reg, u8 data)</span> &#123;</span><br><span class="line">	u8 buf = <span class="number">0</span>;</span><br><span class="line">	buf = data;</span><br><span class="line">	ft5x06_write_regs(dev, reg, &amp;buf, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">irqreturn_t</span> <span class="title function_">ft5x06_handler</span><span class="params">(<span class="type">int</span> irq, <span class="type">void</span> *dev_id)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ft5x06_dev</span> *<span class="title">multidata</span> =</span> dev_id;</span><br><span class="line"></span><br><span class="line">	u8 rdbuf[<span class="number">29</span>];</span><br><span class="line">	<span class="type">int</span> i, type, x, y, id;</span><br><span class="line">	<span class="type">int</span> offset, tplen;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="type">bool</span> down;</span><br><span class="line"></span><br><span class="line">	offset = <span class="number">1</span>; 	<span class="comment">/* 偏移1，也就是0X02+1=0x03,从0X03开始是触摸值 */</span></span><br><span class="line">	tplen = <span class="number">6</span>;		<span class="comment">/* 一个触摸点有6个寄存器来保存触摸值 */</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(rdbuf, <span class="number">0</span>, <span class="keyword">sizeof</span>(rdbuf));		<span class="comment">/* 清除 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 读取FT5X06触摸点坐标从0X02寄存器开始，连续读取29个寄存器 */</span></span><br><span class="line">	ret = ft5x06_read_regs(multidata, FT5X06_TD_STATUS_REG, rdbuf, FT5X06_READLEN);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 上报每一个触摸点坐标 */</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_SUPPORT_POINTS; i++) &#123;</span><br><span class="line">		u8 *buf = &amp;rdbuf[i * tplen + offset];</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* 以第一个触摸点为例，寄存器TOUCH1_XH(地址0X03),各位描述如下：</span></span><br><span class="line"><span class="comment">		 * bit7:6  Event flag  0:按下 1:释放 2：接触 3：没有事件</span></span><br><span class="line"><span class="comment">		 * bit5:4  保留</span></span><br><span class="line"><span class="comment">		 * bit3:0  X轴触摸点的11~8位。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		type = buf[<span class="number">0</span>] &gt;&gt; <span class="number">6</span>;     <span class="comment">/* 获取触摸类型 */</span></span><br><span class="line">		<span class="keyword">if</span> (type == TOUCH_EVENT_RESERVED)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"> </span><br><span class="line">		<span class="comment">/* 我们所使用的触摸屏和FT5X06是反过来的 */</span></span><br><span class="line">		x = ((buf[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">3</span>]) &amp; <span class="number">0x0fff</span>;</span><br><span class="line">		y = ((buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">1</span>]) &amp; <span class="number">0x0fff</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">/* 以第一个触摸点为例，寄存器TOUCH1_YH(地址0X05),各位描述如下：</span></span><br><span class="line"><span class="comment">		 * bit7:4  Touch ID  触摸ID，表示是哪个触摸点</span></span><br><span class="line"><span class="comment">		 * bit3:0  Y轴触摸点的11~8位。</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		id = (buf[<span class="number">2</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0x0f</span>;</span><br><span class="line">		down = type != TOUCH_EVENT_UP;</span><br><span class="line"></span><br><span class="line">		input_mt_slot(multidata-&gt;input, id);</span><br><span class="line">		input_mt_report_slot_state(multidata-&gt;input, MT_TOOL_FINGER, down);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!down)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">		input_report_abs(multidata-&gt;input, ABS_MT_POSITION_X, x);</span><br><span class="line">		input_report_abs(multidata-&gt;input, ABS_MT_POSITION_Y, y);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	input_mt_report_pointer_emulation(multidata-&gt;input, <span class="literal">true</span>);</span><br><span class="line">	input_sync(multidata-&gt;input);</span><br><span class="line">fail:</span><br><span class="line">	<span class="keyword">return</span> IRQ_HANDLED;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ft5x06_ts_irq</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="keyword">struct</span> ft5x06_dev *dev)</span> &#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (gpio_is_valid(dev-&gt;irq_pin)) &#123;</span><br><span class="line">		ret = devm_gpio_request_one(&amp;client-&gt;dev, dev-&gt;irq_pin,</span><br><span class="line">					GPIOF_IN, <span class="string">&quot;edt-ft5x06 irq&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">			dev_err(&amp;client-&gt;dev,</span><br><span class="line">				<span class="string">&quot;Failed to request GPIO %d, error %d\n&quot;</span>,</span><br><span class="line">				dev-&gt;irq_pin, ret);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = devm_request_threaded_irq(&amp;client-&gt;dev, client-&gt;irq, <span class="literal">NULL</span>,</span><br><span class="line">					ft5x06_handler, IRQF_TRIGGER_FALLING | IRQF_ONESHOT,</span><br><span class="line">					client-&gt;name, &amp;ft5x06);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		dev_err(&amp;client-&gt;dev, <span class="string">&quot;Unable to request touchscreen IRQ.\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ft5x06_ts_probe</span><span class="params">(<span class="keyword">struct</span> i2c_client *client, <span class="type">const</span> <span class="keyword">struct</span> i2c_device_id *id)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ft5x06.client = client;</span><br><span class="line"></span><br><span class="line">	ft5x06.irq_pin = of_get_named_gpio(client-&gt;dev.of_node, <span class="string">&quot;interrupt-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	ft5x06.reset_pin = of_get_named_gpio(client-&gt;dev.of_node, <span class="string">&quot;reset-gpios&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	ret = ft5x06_ts_reset(client, &amp;ft5x06);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = ft5x06_ts_irq(client, &amp;ft5x06);</span><br><span class="line">	<span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 4，初始化FT5X06 */</span></span><br><span class="line">	ft5x06_write_reg(&amp;ft5x06, FT5x06_DEVICE_MODE_REG, <span class="number">0</span>); 	<span class="comment">/* 进入正常模式 	*/</span></span><br><span class="line">	ft5x06_write_reg(&amp;ft5x06, FT5426_IDG_MODE_REG, <span class="number">1</span>); 		<span class="comment">/* FT5426中断模式	*/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 5，input设备注册 */</span></span><br><span class="line">	ft5x06.input = devm_input_allocate_device(&amp;client-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (!ft5x06.input) &#123;</span><br><span class="line">		ret = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line">	ft5x06.input-&gt;name = client-&gt;name;</span><br><span class="line">	ft5x06.input-&gt;id.bustype = BUS_I2C;</span><br><span class="line">	ft5x06.input-&gt;dev.parent = &amp;client-&gt;dev;</span><br><span class="line">	__set_bit(EV_KEY, ft5x06.input-&gt;evbit);</span><br><span class="line">	__set_bit(EV_ABS, ft5x06.input-&gt;evbit);</span><br><span class="line">	__set_bit(BTN_TOUCH, ft5x06.input-&gt;keybit);</span><br><span class="line"></span><br><span class="line">	input_set_abs_params(ft5x06.input, ABS_X, <span class="number">0</span>, <span class="number">1024</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(ft5x06.input, ABS_Y, <span class="number">0</span>, <span class="number">600</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(ft5x06.input, ABS_MT_POSITION_X,<span class="number">0</span>, <span class="number">1024</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	input_set_abs_params(ft5x06.input, ABS_MT_POSITION_Y,<span class="number">0</span>, <span class="number">600</span>, <span class="number">0</span>, <span class="number">0</span>);	     </span><br><span class="line">	ret = input_mt_init_slots(ft5x06.input, MAX_SUPPORT_POINTS, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = input_register_device(ft5x06.input);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		<span class="keyword">goto</span> fail;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">fail:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ft5x06_ts_remove</span><span class="params">(<span class="keyword">struct</span> i2c_client *client)</span>&#123;</span><br><span class="line">	input_unregister_device(ft5x06.input);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> <span class="title">ft5x06_ts_id</span>[] =</span> &#123;</span><br><span class="line">	&#123; <span class="string">&quot;edt-ft5206&quot;</span>, <span class="number">0</span>, &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;edt-ft5426&quot;</span>, <span class="number">0</span>, &#125;,</span><br><span class="line">	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">ft5x06_of_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;edt,edt-ft5206&quot;</span>, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;edt,edt-ft5426&quot;</span>, &#125;,</span><br><span class="line">	&#123; <span class="comment">/* sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> <span class="title">ft5x06_ts_driver</span> =</span> &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		.name = <span class="string">&quot;edt_ft5x06&quot;</span>,</span><br><span class="line">		.of_match_table = of_match_ptr(ft5x06_of_match),</span><br><span class="line">	&#125;,</span><br><span class="line">	.id_table = ft5x06_ts_id,</span><br><span class="line">	.probe    = ft5x06_ts_probe,</span><br><span class="line">	.remove   = ft5x06_ts_remove,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">ft5x06_init</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	ret = i2c_add_driver(&amp;ft5x06_ts_driver);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">ft5x06_exit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	i2c_del_driver(&amp;ft5x06_ts_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(ft5x06_init);</span><br><span class="line">module_exit(ft5x06_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

</details>

<h4><span id="5-4-2-1-probe-guo-cheng">5.4.2.1 probe过程</span><a href="#5-4-2-1-probe-guo-cheng" class="header-anchor">#</a></h4><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png" alt="image"></p>
<p>dts中的<code>compatible</code>和驱动匹配，<code>of_match_table</code>匹配，因此触发probe函数。可以看到FT5426使用的标准I2C从设备驱动框架<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18183047">Linux I2C子系统驱动</a></p>
<p><a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-I2C子系统 | Hexo (fuzidage.github.io)</a>。因为使用的I2c2。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png" alt="image"></p>
<p>由于<code>i2c_client</code>描述i2c从设备的i2c相关硬件信息。 一个<code>i2c_driver</code>可以支持多个同类型的<code>i2c_client</code>。<code>i2c_client</code>一般描述在设备树中, 这里<code>对应i2c2的ft5426子节点</code>。</p>
<ol>
<li><p>当驱动和设备匹配，<code>ft5x06_ts_probe</code>执行。首先获取dts中的属性<code>reset-gpios</code>,<code>interrupt-gpios</code>。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/31.1.png" alt="image"></p>
</li>
<li><p>对复位引脚进行复位。（参考<a href="#power_on_sequence">5.1.3上电复位时序</a>）</p>
</li>
</ol>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png" alt="image"></p>
<ol start="3">
<li>注册中断服务</li>
</ol>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/33.png" alt="image"></p>
<ol start="4">
<li><p>初始化ft5426内部寄存器</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/34.png" alt="image"></p>
</li>
<li><p>利用input子系统设置MT协议参数，并且注册input设备。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/35.png" alt="image"></p>
</li>
</ol>
<p>需要上报的事件为 <code>EV_KEY 和 EV_ABS</code>，需要上报的按键码为<code> BTN_TOUCH</code>(<code>BTN_TOUCH见include\uapi\linux\input-event-codes.h</code>)。<code>EV_KEY </code>是按键事件，用于上报触摸屏是否被按下，相当于把触摸屏当做一个按键。<code>EV_ABS </code>是触摸点坐标数据，<code>BTN_TOUCH </code>表示将触摸屏的按下和抬起用作 <code>BTN_TOUCH </code>按键。</p>
<p><code>input_set_abs_params </code>函数设置 EV_ABS 事件需要上报 <code>ABS_X、ABS_Y、ABS_MT_POSITION_X 和 ABS_MT_POSITION_Y</code>。单点触摸需要上报<code>ABS_X</code> 和<code> ABS_Y</code>，对于多点触摸需要上报 <code>ABS_MT_POSITION_X </code>和<code> ABS_MT_POSITION_Y</code>。</p>
<p><code>input_mt_init_slots</code> 函数初始 化 slots，也就是最大触摸点数量，FT5426 是个 5 点电容触摸芯片，因此一共 5 个 slot。</p>
<h4><span id="5-4-2-2-i2c-shu-ju-chuan-shu">5.4.2.2 I2C数据传输</span><a href="#5-4-2-2-i2c-shu-ju-chuan-shu" class="header-anchor">#</a></h4><p>其实就是i2c数据传输的应用。参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18183047">Linux I2C子系统驱动</a></p>
<p><a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-I2C子系统 | Hexo (fuzidage.github.io)</a>。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/36.png" alt="image"></p>
<p>读过程：</p>
<p>构造<code>i2c_msg[0]</code>，flag&#x3D;0表示写，先发送i2c从设备器件地址0x38。然后发送要读哪个寄存器地址。</p>
<p>构造<code>i2c_msg[1]</code>，flag&#x3D;1表示读，先发送i2c从设备器件地址0x38。然后传入要读的buf。</p>
<p>写过程：</p>
<p>构造<code>i2c_msg</code>，flag&#x3D;0表示写，先发送i2c从设备器件地址0x38。然后发送要写哪个寄存器地址和写入的内容。</p>
<h4><span id="5-4-2-3-zhong-duan-hong-mo-shu-ju-shang-bao">5.4.2.3 中断触摸数据上报</span><a href="#5-4-2-3-zhong-duan-hong-mo-shu-ju-shang-bao" class="header-anchor">#</a></h4><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/37.png" alt="image"></p>
<ol>
<li>通过<code>I2c_read</code>获取寄存器值。一共29个寄存器，读出29 byte。从0X02寄存器开始读。</li>
<li>for循环内部用来拆解坐标信息，上报每一个点的坐标。</li>
<li>最后调用<code>input_sync</code>上传上报<code>SYN_REPORT</code>事件。</li>
</ol>
<h3><span id="5-4-3-yong-hu-tai-ying-yong-ce-shi">5.4.3 用户态应用测试</span><a href="#5-4-3-yong-hu-tai-ying-yong-ce-shi" class="header-anchor">#</a></h3><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/38.png" alt="image"></p>
<p>驱动加载成功以后就会生成<code>/dev/input/eventX</code>(X&#x3D;1,2,3…)</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/39.png" alt="image"></p>
<h4><span id="5-4-3-1-hong-mo-ping-yuan-shi-shu-ju-jie-xi">5.4.3.1 触摸屏原始数据解析</span><a href="#5-4-3-1-hong-mo-ping-yuan-shi-shu-ju-jie-xi" class="header-anchor">#</a></h4><p><code>hexdump /dev/input/event2</code>可以查看原始数据。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/40.png" alt="image"></p>
<p>第1行，type为0x3，说明是一个<code>EV_ABS</code>事件，<code>code为0x2f</code>，为<code>ABS_MT_SLOT</code>，因此这一行就是<code>input_mt_slot</code>函数上报的<code>ABS_MT_SLOT</code>事件。value&#x3D;0，说明接下来上报的是第一个触摸点坐标。</p>
<p>第2行，type为0x3，说明是一个<code>EV_ABS</code>事件，<code>code为0x39</code>，也就是<code>ABS_MT_TRACKING_ID</code>，这一行就是<code>input_mt_report_slot_state</code>函数上报<code>ABS_MT_TRACKING_ID</code>事件。<code>value=5</code>说明给<code>SLOT0</code>分配的ID为5。</p>
<p>​		第3行，type为0x3，是一个<code>EV_ABS</code>事件，<code>code为0x35</code>，为<code>ABS_MT_POSITION_X</code>，这一行就是<code>input_report_abs</code>函数上报的<code>ABS_MT_POSITION_X</code>事件，也就是触摸点的X轴坐标。<code>value=0x03ec=1004</code>，说明触摸点X轴坐标为1004，属于屏幕右上角区域。</p>
<p>​		第4行，type为0x3，是一个<code>EV_ABS</code>事件，<code>code为0x36</code>，为<code>ABS_MT_POSITION_Y</code>，这一行就是<code>input_report_abs</code>函数上报的<code>ABS_MT_POSITION_Y</code>事件，也就是触摸点的Y轴坐标。<code>value=0x17=23</code>，说明Y轴坐标为23，由此可以看出本次触摸的坐标为(1004,23)，处于屏幕右上角区域。</p>
<p>​		第5行，type为0x1，是一个<code>EV_KEY</code>事件，<code>code=0x14a</code>，为<code>BTN_TOUCH</code>，<code>value=0x1</code>表示触摸屏被按下。</p>
<p>​		第6行，type为0x3，是一个<code>EV_ABS</code>事件，<code>code为0x0</code>，为<code>ABS_X</code>，用于单点触摸的时候上报X轴坐标。在这里和<code>ABS_MT_POSITION_X</code>相同，<code>value也为0x3f0=1008</code>。ABS_X是由<code>input_mt_report_pointer_emulation</code>函数上报的。</p>
<p>​		第7行，type为0x3，是一个<code>EV_ABS</code>事件，<code>code为0x1</code>，为<code>ABS_Y</code>，用于单点触摸的时候上报Y轴坐标。在这里和<code>ABS_MT_POSITION_Y</code>相同，<code>value也为0x17=23</code>。ABS_Y是由<code>input_mt_report_pointer_emulation</code>函数上报的。</p>
<p>第8行，type为0x0，是一个<code>EV_SYN</code>事件，由<code>input_sync</code>函数上报。</p>
<p>第9行，type为0x3，是一个<code>EV_ABS</code>事件，<code>code为0x39</code>，也就是<code>ABS_MT_TRACKING_ID</code>，<code>value=0xffffffff=-1</code>，说明触摸点离开了屏幕。</p>
<p>第10行，type为0x1，是一个<code>EV_KEY</code>事件，<code>code=0x14a</code>，为<code>BTN_TOUCH</code>，<code>value=0x0</code>表示手指离开触摸屏，也就是触摸屏没有被按下了。</p>
<p>第11行，type为0x0，是一个<code>EV_SYN</code>事件，由<code>input_sync</code>函数上报。</p>
<p>以上就是一个触摸点的坐标上报过程。</p>
<h2><span id="5-5-linux-nei-he-zi-dai-de-hong-mo-qu-dong">5.5 Linux内核自带的触摸驱动</span><a href="#5-5-linux-nei-he-zi-dai-de-hong-mo-qu-dong" class="header-anchor">#</a></h2><p>打开<code>driver/input/touchscreen/Makefile</code>。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/41.png" alt="image"></p>
<p>linux内核默认已经帮我们实现了这款<code>edt-ft5x06.c</code>触摸屏驱动。此驱动文件不仅仅 能够驱动 <code>FT5426，FT5206、FT5406 </code>这些都可以驱动。</p>
<p><code>make menuconfig</code>,选中这款触摸屏即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Location:</span><br><span class="line"> -&gt; Device Drivers</span><br><span class="line"> 	-&gt; Input device support</span><br><span class="line"> 		-&gt; Generic input layer (needed <span class="keyword">for</span> keyboard, mouse, ...) (INPUT [=y])</span><br><span class="line">			-&gt; Touchscreens (INPUT_TOUCHSCREEN [=y])</span><br><span class="line">				-&gt; &lt;*&gt; EDT FocalTech FT5x06 I2C Touchscreen support</span><br></pre></td></tr></table></figure>

<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/42.png" alt="image"></p>
<p>编译后开机如下打印：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/43.png" alt="image"></p>
<p>直接运行 ts_test_mt 来测试触摸屏是否可以使用。</p>
<h1><span id="6-is-enabled-zai-qu-dong-zhong-pan-duan-mou-config-shi-fou-ding-yi">6 IS_ENABLED-在驱动中判断某CONFIG是否定义</span><a href="#6-is-enabled-zai-qu-dong-zhong-pan-duan-mou-config-shi-fou-ding-yi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">linux/kconfig.h:<span class="number">73</span>:<span class="meta">#<span class="keyword">define</span> IS_ENABLED(option) __or(IS_BUILTIN(option), IS_MODULE(option))</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/" data-id="cm0xxogeb004oqsuf7aku34qn" data-title="字符设备驱动-input子系统" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-PWM%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          字符设备驱动-PWM子系统
        
      </div>
    </a>
  
  
    <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">字符设备驱动-SPI子系统</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 14.55px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-PWM%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-PWM子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-input子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-SPI子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-I2C子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>字符设备驱动-SPI子系统 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 Linux SPI驱动框架 1.1 spi核心层 1.1.1 核心层初始化 1.1.1.1 spi_init 1.1.1.2 spi从设备和驱动的匹配   1.1.2 核心层API 1.1.2.1 spi_register_master-(供适配层调用) 1.1.2.1.1 spi_controller_initialize_queue&#x2F;spi_master_initial">
<meta property="og:type" content="article">
<meta property="og:title" content="字符设备驱动-SPI子系统">
<meta property="og:url" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 Linux SPI驱动框架 1.1 spi核心层 1.1.1 核心层初始化 1.1.1.1 spi_init 1.1.1.2 spi从设备和驱动的匹配   1.1.2 核心层API 1.1.2.1 spi_register_master-(供适配层调用) 1.1.2.1.1 spi_controller_initialize_queue&#x2F;spi_master_initial">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/9-1.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png">
<meta property="og:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png">
<meta property="article:published_time" content="2024-08-25T11:02:38.000Z">
<meta property="article:modified_time" content="2024-08-31T11:28:36.730Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="通信协议">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-字符设备驱动-SPI子系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2024-08-25T11:02:38.000Z" itemprop="datePublished">2024-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      字符设备驱动-SPI子系统
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-linux-spi-qu-dong-kuang-jia">1 Linux SPI驱动框架</a><ul>
<li><a href="#1-1-spi-he-xin-ceng">1.1 spi核心层</a><ul>
<li><a href="#1-1-1-he-xin-ceng-chu-shi-hua">1.1.1 核心层初始化</a><ul>
<li><a href="#1-1-1-1-spi-init">1.1.1.1 spi_init</a></li>
<li><a href="#1-1-1-2-spi-cong-she-bei-he-qu-dong-de-pi-pei">1.1.1.2 spi从设备和驱动的匹配</a></li>
</ul>
</li>
<li><a href="#1-1-2-he-xin-ceng-api">1.1.2 核心层API</a><ul>
<li><a href="#1-1-2-1-spi-register-master-gong-gua-pei-ceng-diao-yong">1.1.2.1 spi_register_master-(供适配层调用)</a><ul>
<li><a href="#1-1-2-1-1-spi-controller-initialize-queue-spi-master-initialize-queue">1.1.2.1.1 spi_controller_initialize_queue&#x2F;spi_master_initialize_queue</a></li>
</ul>
</li>
<li><a href="#1-1-2-2-spi-message-init-gong-cong-she-bei-diao-yong">1.1.2.2 spi_message_init-(供从设备调用)</a></li>
<li><a href="#1-1-2-3-spi-message-add-tail-gong-cong-she-bei-diao-yong">1.1.2.3 spi_message_add_tail-(供从设备调用)</a></li>
<li><a href="#1-1-2-4-spi-async-gong-cong-she-bei-diao-yong">1.1.2.4 spi_async-(供从设备调用)</a><ul>
<li><a href="#1-1-2-4-1-spi-queued-transfer">1.1.2.4.1 spi_queued_transfer</a></li>
</ul>
</li>
<li><a href="#1-1-2-4-spi-sync-gong-cong-she-bei-diao-yong">1.1.2.4 spi_sync-(供从设备调用)</a></li>
<li><a href="#1-1-2-5-spi-bitbang-start-gong-gua-pei-ceng-diao-yong">1.1.2.5 spi_bitbang_start-(供适配层调用)</a><ul>
<li><a href="#1-1-2-5-1-spi-register-master">1.1.2.5.1 spi_register_master</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-2-spi-kong-zhi-qi-qu-dong-ceng">1.2 SPI控制器驱动层</a><ul>
<li><a href="#1-2-1-spi-kong-zhi-qi-api">1.2.1 SPI控制器API</a><ul>
<li><a href="#1-2-1-1-spi-alloc-master">1.2.1.1 spi_alloc_master</a></li>
<li><a href="#1-2-1-2-spi-master-put">1.2.1.2 spi_master_put</a></li>
<li><a href="#1-2-1-3-spi-register-master-spi-register-controller">1.2.1.3 spi_register_master&#x2F;spi_register_controller</a></li>
<li><a href="#1-2-1-4-spi-unregister-master-spi-unregister-controller">1.2.1.4 spi_unregister_master&#x2F;spi_unregister_controller</a></li>
</ul>
</li>
<li><a href="#1-2-2-spi-kong-zhi-qi-shi-li">1.2.2 SPI控制器示例</a><ul>
<li><a href="#1-2-2-1-spi-kong-zhi-qi-she-bei-shu-miao-shu">1.2.2.1 spi控制器设备树描述</a></li>
<li><a href="#1-2-2-2-imx6ul-spi-kong-zhi-qi-qu-dong">1.2.2.2 imx6ul spi控制器驱动</a><ul>
<li><a href="#1-2-2-2-1-probe-chu-shi-hua-spi-master">1.2.2.2.1 probe-(初始化spi_master)</a></li>
<li><a href="#1-2-2-2-2-spi-imx-setupxfer-she-zhi-wei-kuan-he-pei-zhi-kong-zhi-qi">1.2.2.2.2 spi_imx_setupxfer-(设置位宽和配置控制器)</a></li>
<li><a href="#1-2-2-2-3-spi-imx-transfer-shu-ju-shou-fa">1.2.2.2.3 spi_imx_transfer-(数据收发)</a></li>
<li><a href="#1-2-2-2-4-spi-imx-isr">1.2.2.2.4 spi_imx_isr</a></li>
<li><a href="#1-2-2-2-5-spi-imx-chipselect-pian-xuan">1.2.2.2.5 spi_imx_chipselect-(片选)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-spi-cong-she-bei-qu-dong-ceng">1.3 SPI从设备驱动层</a><ul>
<li><a href="#1-3-1-spi-cong-she-bei-api">1.3.1 SPI从设备API</a><ul>
<li><a href="#1-3-1-1-spi-message-init">1.3.1.1 spi_message_init</a></li>
<li><a href="#1-3-1-2-spi-message-add-tail">1.3.1.2 spi_message_add_tail</a></li>
<li><a href="#1-3-1-3-spi-async">1.3.1.3 spi_async</a></li>
<li><a href="#1-3-1-4-spi-sync">1.3.1.4 spi_sync</a></li>
<li><a href="#1-3-1-5-spi-register-driver">1.3.1.5 spi_register_driver</a></li>
<li><a href="#1-3-1-6-spi-unregister-driver">1.3.1.6 spi_unregister_driver</a></li>
<li><a href="#1-3-1-7-spi-read-spi-write">1.3.1.7 spi_read&#x2F;spi_write</a></li>
</ul>
</li>
<li><a href="#1-3-2-spi-cong-she-bei-shi-li-icm-20608-g">1.3.2 SPI从设备示例-ICM-20608-G</a><ul>
<li><a href="#1-3-2-1-dts-miao-shu">1.3.2.1 dts描述</a><ul>
<li><a href="#1-3-2-1-1-spi-cong-she-bei-dts-miao-shu-gui-ze">1.3.2.1.1 spi从设备dts描述规则</a></li>
</ul>
</li>
<li><a href="#1-3-2-2-icm20608-qu-dong">1.3.2.2 ICM20608驱动</a><ul>
<li><a href="#1-3-2-2-1-icm20608reg-h">1.3.2.2.1 icm20608reg.h</a></li>
<li><a href="#1-3-2-2-2-icm20608-c">1.3.2.2.2 icm20608.c</a><ul>
<li><a href="#1-3-2-2-2-1-qu-dong-guo-cheng-fen-xi">1.3.2.2.2.1 驱动过程分析</a></li>
</ul>
</li>
<li><a href="#1-3-2-2-3-icm20608app-c">1.3.2.2.3 icm20608App.c</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-3-spi-wan-neng-cong-she-bei-qu-dong-spidev-c">1.3.3 SPI万能从设备驱动-spidev.c</a><ul>
<li><a href="#1-3-3-1-spidev-init">1.3.3.1 spidev_init</a></li>
<li><a href="#1-3-3-2-spidev-de-probe">1.3.3.2 spidev的probe</a></li>
<li><a href="#1-3-3-3-spidev-fops">1.3.3.3 spidev_fops</a><ul>
<li><a href="#1-3-3-3-1-spidev-read">1.3.3.3.1 spidev_read</a></li>
<li><a href="#1-3-3-3-2-spidev-write">1.3.3.3.2 spidev_write</a></li>
<li><a href="#1-3-3-3-3-spidev-ioctl">1.3.3.3.3 spidev_ioctl</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-4-shi-yong-spi-wan-neng-qu-dong-oled-ju-li">1.3.4 使用SPI万能驱动oled举例</a><ul>
<li><a href="#1-3-4-1-spi-oled-yuan-li">1.3.4.1 spi oled原理</a></li>
<li><a href="#1-3-4-2-spi-oled-c">1.3.4.2 spi_oled.c</a><ul>
<li><a href="#1-3-4-2-1-yong-hu-tai-qu-dong-fen-xi">1.3.4.2.1 用户态驱动分析</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-5-bu-shi-yong-spi-wan-neng-qu-dong-oled-ju-li">1.3.5 不使用SPI万能驱动oled举例</a><ul>
<li><a href="#1-3-5-1-dts-miao-shu">1.3.5.1 dts描述</a></li>
<li><a href="#1-3-5-2-oled-drv-c">1.3.5.2 oled_drv.c</a><ul>
<li><a href="#1-3-5-2-1-qu-dong-fen-xi">1.3.5.2.1 驱动分析</a></li>
</ul>
</li>
<li><a href="#1-3-5-3-spi-oled-c-ying-yong-ce-shi">1.3.5.3 spi_oled.c应用测试</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-shu-ju-jie-gou">2 数据结构</a><ul>
<li><a href="#2-1-spi-master-spi-controller">2.1 spi_master&#x2F;spi_controller</a></li>
<li><a href="#2-2-spi-driver">2.2 spi_driver</a></li>
<li><a href="#2-3-spi-device">2.3 spi_device</a></li>
<li><a href="#2-4-spi-message-spi-transfer">2.4 spi_message&#x2F;spi_transfer</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>



<h1><span id="1-linux-spi-qu-dong-kuang-jia">1 Linux SPI驱动框架</span><a href="#1-linux-spi-qu-dong-kuang-jia" class="header-anchor">#</a></h1><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png" alt="image"></p>
<p>linux SPI驱动框架层次如上图：</p>
<p>除开硬件和用户态应用程序，由上到下分成3层：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">设备驱动层: spi框架使用者</span><br><span class="line">核心层：spi框架搭建者</span><br><span class="line">控制器驱动层： spi框架适配者</span><br></pre></td></tr></table></figure>

<h2><span id="1-1-spi-he-xin-ceng">1.1 spi核心层</span><a href="#1-1-spi-he-xin-ceng" class="header-anchor">#</a></h2><p>SPI核心层代码位于<code>linux_5.10\drivers\spi</code>目录:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SPDX-License-Identifier: GPL-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Makefile for kernel SPI drivers.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">ccflags-<span class="variable">$(CONFIG_SPI_DEBUG)</span> := -DDEBUG</span><br><span class="line"><span class="comment"># small core, mostly translating board-specific</span></span><br><span class="line"><span class="comment"># config declarations into driver model code</span></span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_MASTER)</span>		+= spi.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_MEM)</span>			+= spi-mem.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_MUX)</span>			+= spi-mux.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_SPIDEV)</span>		+= spidev.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_LOOPBACK_TEST)</span>		+= spi-loopback-test.o</span><br><span class="line"><span class="comment"># SPI master controller drivers (bus)</span></span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_ALTERA)</span>		+= spi-altera.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_AR934X)</span>		+= spi-ar934x.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_ARMADA_3700)</span>		+= spi-armada-3700.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_ATMEL)</span>			+= spi-atmel.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_ATMEL_QUADSPI)</span>		+= atmel-quadspi.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_AT91_USART)</span>		+= spi-at91-usart.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_ATH79)</span>			+= spi-ath79.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_AU1550)</span>		+= spi-au1550.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_AXI_SPI_ENGINE)</span>	+= spi-axi-spi-engine.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_SPI_BCM2835)</span>		+= spi-bcm2835.o</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">drivers/spi/spi.c spi-mem.c spi-mux.c</span><br><span class="line">include/linux/spi/spi.h</span><br><span class="line">spi.c：</span><br><span class="line">    一方面对SPI子系统进行初始化工作，注册spi bus，注册spi_master <span class="class"><span class="keyword">class</span>，</span></span><br><span class="line"><span class="class">    同时提供<span class="title">spi</span>设备驱动对<span class="title">spi</span>总线进行操作的<span class="title">API</span>。</span></span><br><span class="line"><span class="class">    另一方面<span class="title">SPI</span>子系统对<span class="title">spi</span>控制器层，提供注册控制器的<span class="title">api</span>和回调操作函数。</span></span><br><span class="line"><span class="class"><span class="title">spi</span>.<span class="title">h</span>包含了<span class="title">spi</span>核心层的一些重要数据结构，<span class="keyword">struct</span> <span class="title">spi_master</span>;</span> </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span>;</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span>，以及一些实现比较简单的函数等。</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">spi</span>-<span class="title">gpio</span>.<span class="title">c</span>：<span class="title">SPI</span> <span class="title">GPIO</span>框架：<span class="title">SPI</span>子系统提供了一个名为<span class="title">spi</span>-<span class="title">gpio</span>的框架，</span></span><br><span class="line"><span class="class">        可使用<span class="title">GPIO</span>引脚模拟<span class="title">SPI</span>总线，<span class="title">gpio</span>模拟<span class="title">spi</span>代码在<span class="title">drivers</span>/<span class="title">spi</span>/<span class="title">spi</span>-<span class="title">gpio</span>.<span class="title">c</span>中。</span></span><br><span class="line"><span class="class">        这个框架允许将<span class="title">GPIO</span>引脚配置为<span class="title">SPI</span>总线的时钟、片选、输入和输出信号，</span></span><br><span class="line"><span class="class">        并提供了对应的接口函数供驱动程序使用。</span></span><br><span class="line"><span class="class"><span class="title">spi</span>-<span class="title">bitbang</span>：<span class="title">spi</span>-<span class="title">bitbang</span>是<span class="title">Linux</span>内核中提供的一个通用框架，用于在没有硬件<span class="title">SPI</span>控制器</span></span><br><span class="line"><span class="class">        或需要灵活控制<span class="title">SPI</span>时序和配置的系统中模拟<span class="title">SPI</span>总线的通信。代码在<span class="title">spi</span>-<span class="title">bitbang</span>.<span class="title">c</span>中</span></span><br></pre></td></tr></table></figure>

<p>核心层的作用:</p>
<p>对上层的使用者，也就是SPI设备驱动：提供标准的spi收发API，以及设备注册函数。<br>对底下的适配者，也就是控制器驱动层：提供注册控制器接口，并提供一些需要控制器驱动实现的回调函数。</p>
<h3><span id="1-1-1-he-xin-ceng-chu-shi-hua">1.1.1 核心层初始化</span><a href="#1-1-1-he-xin-ceng-chu-shi-hua" class="header-anchor">#</a></h3><h4><span id="1-1-1-1-spi-init">1.1.1.1 spi_init</span><a href="#1-1-1-1-spi-init" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">spi_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">int</span>	status;</span><br><span class="line">	buf = kmalloc(SPI_BUFSIZ, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!buf) &#123;</span><br><span class="line">		status = -ENOMEM;</span><br><span class="line">		<span class="keyword">goto</span> err0;</span><br><span class="line">	&#125;</span><br><span class="line">	status = bus_register(&amp;spi_bus_type);</span><br><span class="line">	<span class="keyword">if</span> (status &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err1;</span><br><span class="line">	status = class_register(&amp;spi_master_class);</span><br><span class="line">	<span class="keyword">if</span> (status &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> err2;</span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_SPI_SLAVE)) &#123;</span><br><span class="line">		status = class_register(&amp;spi_slave_class);</span><br><span class="line">		<span class="keyword">if</span> (status &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> err3;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_OF_DYNAMIC))</span><br><span class="line">		WARN_ON(of_reconfig_notifier_register(&amp;spi_of_notifier));</span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_ACPI))</span><br><span class="line">		WARN_ON(acpi_reconfig_notifier_register(&amp;spi_acpi_notifier));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">err3:</span><br><span class="line">	class_unregister(&amp;spi_master_class);</span><br><span class="line">err2:</span><br><span class="line">	bus_unregister(&amp;spi_bus_type);</span><br><span class="line">err1:</span><br><span class="line">	kfree(buf);</span><br><span class="line">	buf = <span class="literal">NULL</span>;</span><br><span class="line">err0:</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>spi子系统初始化函数，仅仅是注册了<code>spi bus</code>，以及<code>spi_master class</code>。</p>
<p>成功注册后，在<code>/sys/bus </code>下即可找到spi 文件目录，在<code>/sys/class</code>下可以看到spi_master目录:</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png" alt="image"></p>
<h4><span id="1-1-1-2-spi-cong-she-bei-he-qu-dong-de-pi-pei">1.1.1.2 spi从设备和驱动的匹配</span><a href="#1-1-1-2-spi-cong-she-bei-he-qu-dong-de-pi-pei" class="header-anchor">#</a></h4><p>当spi总线和类注册后，当有驱动和设备匹配上就会调用<code>spi_match_device</code>，也就是<code>spi_bus_type.match</code>函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_match_device</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span> &#123;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span>	*<span class="title">spi</span> =</span> to_spi_device(dev);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span>	*<span class="title">sdrv</span> =</span> to_spi_driver(drv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check override first, and if set, only use the named driver */</span></span><br><span class="line">	<span class="keyword">if</span> (spi-&gt;driver_override)</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">strcmp</span>(spi-&gt;driver_override, drv-&gt;name) == <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Attempt an OF style match */</span></span><br><span class="line">	<span class="keyword">if</span> (of_driver_match_device(dev, drv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Then try ACPI */</span></span><br><span class="line">	<span class="keyword">if</span> (acpi_driver_match_device(dev, drv))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sdrv-&gt;id_table)</span><br><span class="line">		<span class="keyword">return</span> !!spi_match_id(sdrv-&gt;id_table, spi);</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">strcmp</span>(spi-&gt;modalias, drv-&gt;name) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>通过<code>of_match_table</code>的<code>compatible</code>和设备树匹配；</li>
<li>通过<code>acpi_match_table</code>的<code>compatible</code>和<code>device</code>的<code>of_node</code>的<code>compatible</code>匹配；</li>
<li>通过驱动和设备的<code>id_table</code>去匹配。</li>
<li>最后通过驱动和设备的<code>名字</code>去匹配。</li>
</ol>
<p>匹配过程参考[<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17031328.html">字符设备驱动-2.总线&#x2F;平台设备&#x2F;平台驱动模型</a></p>
<p> <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/07/26/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-2-%E6%80%BB%E7%BA%BF%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%B9%B3%E5%8F%B0%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/">字符设备驱动-2-总线模型和平台设备驱动 | Hexo (fuzidage.github.io)</a>。</p>
<h3><span id="1-1-2-he-xin-ceng-api">1.1.2 核心层API</span><a href="#1-1-2-he-xin-ceng-api" class="header-anchor">#</a></h3><h4><span id="1-1-2-1-spi-register-master-gong-gua-pei-ceng-diao-yong">1.1.2.1 spi_register_master-(供适配层调用)</span><a href="#1-1-2-1-spi-register-master-gong-gua-pei-ceng-diao-yong" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">spi_register_master</span><span class="params">(<span class="keyword">struct</span> spi_master *master)</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	status = of_spi_register_master(master);</span><br><span class="line">	<span class="keyword">if</span> (status)</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	...</span><br><span class="line">	dev_set_name(&amp;master-&gt;dev, <span class="string">&quot;spi%u&quot;</span>, master-&gt;bus_num);</span><br><span class="line">	status = device_add(&amp;master-&gt;dev);</span><br><span class="line">	<span class="keyword">if</span> (status &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> done;</span><br><span class="line">	dev_dbg(dev, <span class="string">&quot;registered master %s%s\n&quot;</span>, dev_name(&amp;master-&gt;dev),</span><br><span class="line">			dynamic ? <span class="string">&quot; (dynamic)&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (master-&gt;transfer)</span><br><span class="line">		dev_info(dev, <span class="string">&quot;master is unqueued, this is deprecated\n&quot;</span>);</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		status = spi_master_initialize_queue(master);</span><br><span class="line">		<span class="keyword">if</span> (status) &#123;</span><br><span class="line">			device_del(&amp;master-&gt;dev);</span><br><span class="line">			<span class="keyword">goto</span> done;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	mutex_lock(&amp;board_lock);</span><br><span class="line">	list_add_tail(&amp;master-&gt;<span class="built_in">list</span>, &amp;spi_master_list);</span><br><span class="line">	list_for_each_entry(bi, &amp;board_list, <span class="built_in">list</span>)</span><br><span class="line">		spi_match_master_to_boardinfo(master, &amp;bi-&gt;board_info);</span><br><span class="line">	mutex_unlock(&amp;board_lock);</span><br><span class="line">	...</span><br><span class="line">	of_register_spi_devices(master);</span><br><span class="line">	...</span><br><span class="line">done:</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p><code>of_spi_register_master</code>，根据设备树节点中的<code>&quot;cs-gpios&quot;</code>，向<code>struct spi_master</code>添加gpio cs引脚。</p>
</li>
<li><p><code>device_add</code>将device注册到设备模型中。</p>
</li>
<li><p>如果控制器驱动没有自己实现<code>transfer</code>函数，则初始化发送队列<code>spi_master_initialize_queue</code>。（核心层填充默认transfer函数)</p>
</li>
<li><p><code>spi_match_master_to_boardinfo</code>老的方式，遍历所有<code>spi_board_info</code>数据结构，并注册<code>spi_device</code></p>
</li>
<li><p><code>of_register_spi_devices</code>新的设备树方式，遍历spi控制器节点下所有子节点，并注册成对应的<code>spi_device</code>设备</p>
</li>
</ol>
<h5><span id="1-1-2-1-1-spi-controller-initialize-queue-x2f-spi-master-initialize-queue">1.1.2.1.1 spi_controller_initialize_queue&#x2F;spi_master_initialize_queue</span><a href="#1-1-2-1-1-spi-controller-initialize-queue-x2f-spi-master-initialize-queue" class="header-anchor">#</a></h5><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png" alt="image"></p>
<p>可以看到是对控制器<code>spi_master（或者叫做spi_controller）</code>成员函数赋值。<code>transfer_one_message</code>或者<code>transfer</code>赋值成默认的函数。然后调用<code>spi_init_queue</code>和<code>spi_start_queue</code>函数初始化队列并启动工作线程。<code>spi_init_queue</code>函数最主要的作用就是建立一个内核工作线程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_init_queue</span><span class="params">(<span class="keyword">struct</span> spi_master *master)</span></span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	kthread_init_worker(&amp;master-&gt;kworker);</span><br><span class="line">	master-&gt;kworker_task = kthread_run(kthread_worker_fn,</span><br><span class="line">            &amp;master-&gt;kworker, <span class="string">&quot;%s&quot;</span>, dev_name(&amp;master-&gt;dev));</span><br><span class="line">	......</span><br><span class="line">	kthread_init_work(&amp;master-&gt;pump_messages, spi_pump_messages);</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spi_start_queue</span><span class="params">(<span class="keyword">struct</span> spi_master *master)</span></span><br><span class="line">&#123;</span><br><span class="line">	......</span><br><span class="line">	master-&gt;running = <span class="literal">true</span>;</span><br><span class="line">	master-&gt;cur_msg = <span class="literal">NULL</span>;</span><br><span class="line">	......</span><br><span class="line">	kthread_queue_work(&amp;master-&gt;kworker, &amp;master-&gt;pump_messages);</span><br><span class="line">	......</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* spi_init_queue函数先初始化kthread_worker，为kthread_worker创建一个内核线程来处理work，</span></span><br><span class="line"><span class="comment">		随后初始化kthread_work,设置work执行函数，work执行函数为spi_pump_messages</span></span><br><span class="line"><span class="comment">spi_start_queue就相对简单了，只是唤醒该工作线程而已；自此，队列化的相关工作已经完成，</span></span><br><span class="line"><span class="comment">		系统等待message请求被发起，然后在工作线程中处理message的传送工作。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4><span id="1-1-2-2-spi-message-init-gong-cong-she-bei-diao-yong">1.1.2.2 spi_message_init-(供从设备调用)</span><a href="#1-1-2-2-spi-message-init-gong-cong-she-bei-diao-yong" class="header-anchor">#</a></h4><p>对<code>spi_massage</code>进行初始化.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">spi_message_init_no_memset</span><span class="params">(<span class="keyword">struct</span> spi_message *m)</span></span><br><span class="line">&#123;</span><br><span class="line">	INIT_LIST_HEAD(&amp;m-&gt;transfers);</span><br><span class="line">	INIT_LIST_HEAD(&amp;m-&gt;resources);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">spi_message_init</span><span class="params">(<span class="keyword">struct</span> spi_message *m)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">memset</span>(m, <span class="number">0</span>, <span class="keyword">sizeof</span> *m);</span><br><span class="line">	spi_message_init_no_memset(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4><span id="1-1-2-3-spi-message-add-tail-gong-cong-she-bei-diao-yong">1.1.2.3 spi_message_add_tail-(供从设备调用)</span><a href="#1-1-2-3-spi-message-add-tail-gong-cong-she-bei-diao-yong" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">spi_message_add_tail</span><span class="params">(<span class="keyword">struct</span> spi_transfer *t, <span class="keyword">struct</span> spi_message *m)</span> &#123;</span><br><span class="line">	list_add_tail(&amp;t-&gt;transfer_list, &amp;m-&gt;transfers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到就是把<code>spi_transfer</code>这个<code>buffer</code>添加到<code>spi_message</code>传输链表中。</p>
<h4><span id="1-1-2-4-spi-async-gong-cong-she-bei-diao-yong">1.1.2.4 spi_async-(供从设备调用)</span><a href="#1-1-2-4-spi-async-gong-cong-she-bei-diao-yong" class="header-anchor">#</a></h4><p>发起数据传输。可以看到就是调用控制器内部的<code>master-&gt;transfer</code>。既然是<code>async</code>那就是异步执行的，不会等待传输是否完成，就直接返回。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spi_async-&gt;</span><br><span class="line">		__spi_async-&gt;</span><br><span class="line">				master-&gt;transfer</span><br></pre></td></tr></table></figure>

<p>那假如<code>master-&gt;transfer</code>控制器这边没有去实现。内核会自己填充默认的transfer函数<code>spi_queued_transfer</code>.</p>
<h5><span id="1-1-2-4-1-spi-queued-transfer">1.1.2.4.1 spi_queued_transfer</span><a href="#1-1-2-4-1-spi-queued-transfer" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">spi_queued_transfer(<span class="keyword">struct</span> spi_device *spi, <span class="keyword">struct</span> spi_message *msg) &#123;</span><br><span class="line">		__spi_queued_transfer(spi, msg, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __spi_queued_transfer(<span class="keyword">struct</span> spi_device *spi,</span><br><span class="line">				 <span class="keyword">struct</span> spi_message *msg,</span><br><span class="line">				 <span class="type">bool</span> need_pump) &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_master</span> *<span class="title">master</span> =</span> spi-&gt;master;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">	spin_lock_irqsave(&amp;master-&gt;queue_lock, flags);</span><br><span class="line">	...</span><br><span class="line">	list_add_tail(&amp;msg-&gt;<span class="built_in">queue</span>, &amp;master-&gt;<span class="built_in">queue</span>);</span><br><span class="line">	<span class="keyword">if</span> (!master-&gt;busy &amp;&amp; need_pump)</span><br><span class="line">		kthread_queue_work(&amp;master-&gt;kworker, &amp;master-&gt;pump_messages);</span><br><span class="line">	spin_unlock_irqrestore(&amp;master-&gt;queue_lock, flags);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到默认的<code>spi_queued_transfer</code>就是去把<code>message</code>添加到<code>master</code>的发送链表中。接下来就交给工作服务线程<code>__spi_pump_messages</code>去处理<code>message</code>。</p>
<h4><span id="1-1-2-4-spi-sync-gong-cong-she-bei-diao-yong">1.1.2.4 spi_sync-(供从设备调用)</span><a href="#1-1-2-4-spi-sync-gong-cong-she-bei-diao-yong" class="header-anchor">#</a></h4><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png" alt="image"></p>
<p>同理，<code>spi_sync</code>就是用来同步传输 <code>spi_message</code>, 完成传输后会调用<code>spi_comlete</code>唤醒等待的线程。</p>
<p>那假如<code>master-&gt;transfer</code>控制器这边没有去实现。内核也会自己填充默认的transfer函数<code>spi_queued_transfer</code>.可以看到<code>need_pump=false</code>,因此还是一样就是去把message添加到master的发送链表中。</p>
<p>然后调用<code>__spi_pump_messages</code>，也就是工作线程服务，交给工作服务线程去处理message。</p>
<p>最后调用<code>wait_for_completion</code>去等待传输完成。</p>
<h4><span id="1-1-2-5-spi-bitbang-start-gong-gua-pei-ceng-diao-yong">1.1.2.5 spi_bitbang_start-(供适配层调用)</span><a href="#1-1-2-5-spi-bitbang-start-gong-gua-pei-ceng-diao-yong" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">spi_bitbang_start</span><span class="params">(<span class="keyword">struct</span> spi_bitbang *bitbang)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">spi_master</span> *<span class="title">master</span> =</span> bitbang-&gt;master;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!master || !bitbang-&gt;chipselect)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    mutex_init(&amp;bitbang-&gt;lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!master-&gt;mode_bits)</span><br><span class="line">        master-&gt;mode_bits = SPI_CPOL | SPI_CPHA | bitbang-&gt;flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (master-&gt;transfer || master-&gt;transfer_one_message)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    master-&gt;prepare_transfer_hardware = spi_bitbang_prepare_hardware;</span><br><span class="line">    master-&gt;unprepare_transfer_hardware = spi_bitbang_unprepare_hardware;</span><br><span class="line">    master-&gt;transfer_one = spi_bitbang_transfer_one;</span><br><span class="line">    master-&gt;set_cs = spi_bitbang_set_cs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bitbang-&gt;txrx_bufs) &#123;</span><br><span class="line">        bitbang-&gt;use_dma = <span class="number">0</span>;</span><br><span class="line">        bitbang-&gt;txrx_bufs = spi_bitbang_bufs;</span><br><span class="line">        <span class="keyword">if</span> (!master-&gt;setup) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!bitbang-&gt;setup_transfer)</span><br><span class="line">                bitbang-&gt;setup_transfer =</span><br><span class="line">                     spi_bitbang_setup_transfer;</span><br><span class="line">            master-&gt;setup = spi_bitbang_setup;</span><br><span class="line">            master-&gt;cleanup = spi_bitbang_cleanup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* driver may get busy before register() returns, especially</span></span><br><span class="line"><span class="comment">     * if someone registered boardinfo for devices</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ret = spi_register_master(spi_master_get(master));</span><br><span class="line">    <span class="keyword">if</span> (ret)</span><br><span class="line">        spi_master_put(master);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>如果主设备结构体中的传输模式位字段 <code>mode_bits</code> 未设置，则设置为默认的模式位，包括 <code>SPI_CPOL</code>、<code>SPI_CPHA </code>和<code>位移传输控制</code>结构体中的标志位。</p>
</li>
<li><p>检查主设备结构体中的传输函数是否已经定义，如果已定义则返回错误码<code> -EINVAL</code>。</p>
</li>
<li><p>设置主设备结构体中的准备硬件传输函数、释放硬件传输函数、单次传输函数和片选信号控制函数，分别对应位移传输控制结构体中的对应函数。</p>
</li>
<li><p>如果位移传输控制结构体中的数据缓冲区传输函数未定义，则设置使用 DMA 标志为 0，并将数据缓冲区传输函数设置为默认的位移传输函数 <code>spi_bitbang_bufs</code>。如果主设备结构体中的设置函数未定义，则设置使用默认的设置函数 <code>spi_bitbang_setup</code> 和清理函数 <code>spi_bitbang_cleanup</code>。</p>
</li>
<li><p>注册 SPI 主设备，将其添加到系统中。</p>
</li>
</ol>
<h5><span id="1-1-2-5-1-spi-register-master">1.1.2.5.1 spi_register_master</span><a href="#1-1-2-5-1-spi-register-master" class="header-anchor">#</a></h5><h2><span id="1-2-spi-kong-zhi-qi-qu-dong-ceng">1.2 SPI控制器驱动层</span><a href="#1-2-spi-kong-zhi-qi-qu-dong-ceng" class="header-anchor">#</a></h2><p>控制器驱动就是用来实现<code>spi_master</code>中的成员函数。如<code>transfer, transfer_one_message</code>。基本流程是：申请 <code>spi_master</code>，然后初始化<code> spi_master</code>，最后向 Linux 内核注册 <code>spi_master</code>。</p>
<h3><span id="1-2-1-spi-kong-zhi-qi-api">1.2.1 SPI控制器API</span><a href="#1-2-1-spi-kong-zhi-qi-api" class="header-anchor">#</a></h3><h4><span id="1-2-1-1-spi-alloc-master">1.2.1.1 spi_alloc_master</span><a href="#1-2-1-1-spi-alloc-master" class="header-anchor">#</a></h4><p>申请spi控制器内存。</p>
<p><code>struct spi_master *spi_alloc_master(struct device *dev, unsigned size);</code></p>
<p>dev：设备，一般是 platform_device 中的 dev 成员变量。 </p>
<p>size：私有数据大小，可以通过<code> spi_master_get_devdata</code> 函数获取到这些私有数据。</p>
<p> 返回值：申请到的 spi_master。</p>
<h4><span id="1-2-1-2-spi-master-put">1.2.1.2 spi_master_put</span><a href="#1-2-1-2-spi-master-put" class="header-anchor">#</a></h4><p> <code>spi_master </code>的释放通过 <code>spi_master_put</code>函数来完成，当我们删除一个 SPI 主机驱动的时候就 需要释放掉前面申请的 spi_master，<code>spi_master_put </code>函数原型如下： </p>
<p><code>void spi_master_put(struct spi_master *master);</code></p>
<p>释放spi控制器内存。</p>
<h4><span id="1-2-1-3-spi-register-master-x2f-spi-register-controller">1.2.1.3 spi_register_master&#x2F;spi_register_controller</span><a href="#1-2-1-3-spi-register-master-x2f-spi-register-controller" class="header-anchor">#</a></h4><p>当 spi_master 初始化完成以后就需要将其注册到 Linux 内核，<code>spi_register_master</code>注册spi控制器。</p>
<p><code>int spi_register_master(struct spi_master *master);</code></p>
<h4><span id="1-2-1-4-spi-unregister-master-x2f-spi-unregister-controller">1.2.1.4 spi_unregister_master&#x2F;spi_unregister_controller</span><a href="#1-2-1-4-spi-unregister-master-x2f-spi-unregister-controller" class="header-anchor">#</a></h4><p>spi控制器卸载。</p>
<p><code>void spi_unregister_master(struct spi_master *master);</code></p>
<h3><span id="1-2-2-spi-kong-zhi-qi-shi-li">1.2.2 SPI控制器示例</span><a href="#1-2-2-spi-kong-zhi-qi-shi-li" class="header-anchor">#</a></h3><p>以飞思卡尔nxp官方spi驱动为例，文件位于<code>linux\drivers\spi\spi-imx.c</code></p>
<h4><span id="1-2-2-1-spi-kong-zhi-qi-she-bei-shu-miao-shu">1.2.2.1 spi控制器设备树描述</span><a href="#1-2-2-1-spi-kong-zhi-qi-she-bei-shu-miao-shu" class="header-anchor">#</a></h4><p>打开设备树文件<code>imx6ul.dtsi</code>：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png" alt="image"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ecspi3: spi@<span class="number">2010000</span> &#123;</span><br><span class="line">        <span class="meta">#address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">        <span class="meta">#size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line">        compatible = <span class="string">&quot;fsl,imx6ul-ecspi&quot;</span>, <span class="string">&quot;fsl,imx51-ecspi&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x02010000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">        interrupts = &lt;GIC_SPI <span class="number">33</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">        clocks = &lt;&amp;clks IMX6UL_CLK_ECSPI3&gt;,</span><br><span class="line">                 &lt;&amp;clks IMX6UL_CLK_ECSPI3&gt;;</span><br><span class="line">        clock-names = <span class="string">&quot;ipg&quot;</span>, <span class="string">&quot;per&quot;</span>;</span><br><span class="line">        dmas = &lt;&amp;sdma <span class="number">7</span> <span class="number">7</span> <span class="number">1</span>&gt;, &lt;&amp;sdma <span class="number">8</span> <span class="number">7</span> <span class="number">2</span>&gt;;</span><br><span class="line">        dma-names = <span class="string">&quot;rx&quot;</span>, <span class="string">&quot;tx&quot;</span>;</span><br><span class="line">        status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4><span id="1-2-2-2-imx6ul-spi-kong-zhi-qi-qu-dong">1.2.2.2 imx6ul spi控制器驱动</span><a href="#1-2-2-2-imx6ul-spi-kong-zhi-qi-qu-dong" class="header-anchor">#</a></h4><h5><span id="1-2-2-2-1-probe-chu-shi-hua-spi-master">1.2.2.2.1 probe-(初始化spi_master)</span><a href="#1-2-2-2-1-probe-chu-shi-hua-spi-master" class="header-anchor">#</a></h5><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png" alt="image"></p>
<ol>
<li><p>解析设备树，初始化控制器</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png" alt="image"></p>
<p>配置master和spi_imx。包括传输函数，片选函数，片选引脚。<code>master</code>作为平台设备的dev的driver_data, <code>spi_imx</code>作为master的dev的driver_data。</p>
<p>获取irq, res等信息，进行ioremap和注册irq。</p>
<p>设置时钟，开启时钟。</p>
<p>初始话dma寄存器。进行控制器初始化和复位。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/9-1.png" alt="image"></p>
</li>
<li><p>申请并初始化 spi_master， 调用 <code>spi_bitbang_start</code> 函数(<code>spi_bitbang_start 会调用 spi_register_master 函数</code>)向 Linux 内核注册 spi_master。</p>
</li>
</ol>
<h5><span id="1-2-2-2-2-spi-imx-setupxfer-she-zhi-wei-kuan-he-pei-zhi-kong-zhi-qi">1.2.2.2.2 spi_imx_setupxfer-(设置位宽和配置控制器)</span><a href="#1-2-2-2-2-spi-imx-setupxfer-she-zhi-wei-kuan-he-pei-zhi-kong-zhi-qi" class="header-anchor">#</a></h5><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png" alt="image"></p>
<p>设置 <code>spi_imx</code> 的 tx 和 rx 传输函数。根据要发送的数据数据位宽的不 同，分别有 8 位、16 位和 32 位的发送函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spi_imx_buf_tx_u8</span><br><span class="line">spi_imx_buf_tx_u16</span><br><span class="line">spi_imx_buf_tx_u32</span><br><span class="line">spi_imx_buf_rx_u8</span><br><span class="line">spi_imx_buf_rx_u16</span><br><span class="line">spi_imx_buf_rx_u32</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MXC_SPI_BUF_RX(type)						\</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> spi_imx_buf_rx_<span class="meta">##type(struct spi_imx_data *spi_imx)		\</span></span><br><span class="line">&#123;	    <span class="comment">//将要接收的数据值读到 ECSPI 的 MXC_CSPIRXDATA 寄存器里面去	\</span></span><br><span class="line">	unsigned <span class="built_in">int</span> val = readl(spi_imx-&gt;<span class="keyword">base</span> + MXC_CSPIRXDATA);	\</span><br><span class="line">									\</span><br><span class="line">	<span class="keyword">if</span> (spi_imx-&gt;rx_buf) &#123;						\</span><br><span class="line">		*(type *)spi_imx-&gt;rx_buf = val;				\</span><br><span class="line">		spi_imx-&gt;rx_buf += <span class="keyword">sizeof</span>(type);			\</span><br><span class="line">	&#125;								\</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MXC_SPI_BUF_TX(type)						\</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> spi_imx_buf_tx_<span class="meta">##type(struct spi_imx_data *spi_imx)		\</span></span><br><span class="line">&#123;									\</span><br><span class="line">	type val = <span class="number">0</span>;							\</span><br><span class="line">									\</span><br><span class="line">	<span class="keyword">if</span> (spi_imx-&gt;tx_buf) &#123;						\</span><br><span class="line">		val = *(type *)spi_imx-&gt;tx_buf;				\</span><br><span class="line">		spi_imx-&gt;tx_buf += <span class="keyword">sizeof</span>(type);			\</span><br><span class="line">	&#125;								\</span><br><span class="line">									\</span><br><span class="line">	spi_imx-&gt;count -= <span class="keyword">sizeof</span>(type);					\</span><br><span class="line"><span class="comment">//将要发送的数据值写入到 ECSPI 的 TXDATA 寄存器里面去		\</span></span><br><span class="line">	writel(val, spi_imx-&gt;<span class="keyword">base</span> + MXC_CSPITXDATA);	\</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MXC_SPI_BUF_RX(u8)</span><br><span class="line">MXC_SPI_BUF_TX(u8)</span><br><span class="line">MXC_SPI_BUF_RX(u16)</span><br><span class="line">MXC_SPI_BUF_TX(u16)</span><br><span class="line">MXC_SPI_BUF_RX(u32)</span><br><span class="line">MXC_SPI_BUF_TX(u32)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png" alt="image"></p>
<p>调用关系如下：<code>mx51_ecspi_config</code>就是最底层<code>SPI controller</code>的寄存器配置，这里不做分析。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spi_imx-&gt;bitbang.setup_transfer = spi_imx_setupxfer</span><br><span class="line">	spi_imx-&gt;devtype_data-&gt;config = mx51_ecspi_config</span><br></pre></td></tr></table></figure>

<h5><span id="1-2-2-2-3-spi-imx-transfer-shu-ju-shou-fa">1.2.2.2.3 spi_imx_transfer-(数据收发)</span><a href="#1-2-2-2-3-spi-imx-transfer-shu-ju-shou-fa" class="header-anchor">#</a></h5><p>数据收发函数为<code> spi_imx_transfer</code>:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spi_imx_transfer</span><br><span class="line">    -&gt; spi_imx_pio_transfer</span><br><span class="line">        -&gt; spi_imx_push</span><br><span class="line">        	-&gt; spi_imx-&gt;tx</span><br></pre></td></tr></table></figure>

<p><code>spi_imx</code> 是个 <code>spi_imx_data </code>类型的机构指针变量，其中 tx 和 rx 这两个成员变量分别为 SPI 数据发送和接收函数。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spi_bitbang_start中</span><br><span class="line">    -&gt;master-&gt;transfer_one = spi_bitbang_transfer_one;</span><br><span class="line">当spi_bitbang_transfer_on时</span><br><span class="line">    bitbang-&gt;txrx_bufs(spi,t) = spi_imx_transfer</span><br><span class="line">    也就是spi_imx-&gt;tx就可以spi_imx_buf_tx_u8</span><br></pre></td></tr></table></figure>

<h5><span id="1-2-2-2-4-spi-imx-isr">1.2.2.2.4 spi_imx_isr</span><a href="#1-2-2-2-4-spi-imx-isr" class="header-anchor">#</a></h5><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png" alt="image"></p>
<p>中断服务程序，只要rx_available,启用spi_imx-&gt;rx。从<code>MXC_CSPIRXDATA</code> 寄存器读出数据。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">int</span> __<span class="function">maybe_unused <span class="title">mx51_ecspi_rx_available</span>(<span class="params"><span class="keyword">struct</span> spi_imx_data *spi_imx</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> readl(spi_imx-&gt;<span class="keyword">base</span> + MX51_ECSPI_STAT) &amp; MX51_ECSPI_STAT_RR;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MXC_SPI_BUF_RX(type)						\</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> spi_imx_buf_rx_<span class="meta">##type(struct spi_imx_data *spi_imx)		\</span></span><br><span class="line">&#123;									\</span><br><span class="line">	unsigned <span class="built_in">int</span> val = readl(spi_imx-&gt;<span class="keyword">base</span> + MXC_CSPIRXDATA);	\</span><br><span class="line">									\</span><br><span class="line">	<span class="keyword">if</span> (spi_imx-&gt;rx_buf) &#123;						\</span><br><span class="line">		*(type *)spi_imx-&gt;rx_buf = val;				\</span><br><span class="line">		spi_imx-&gt;rx_buf += <span class="keyword">sizeof</span>(type);			\</span><br><span class="line">	&#125;								\</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5><span id="1-2-2-2-5-spi-imx-chipselect-pian-xuan">1.2.2.2.5 spi_imx_chipselect-(片选)</span><a href="#1-2-2-2-5-spi-imx-chipselect-pian-xuan" class="header-anchor">#</a></h5><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png" alt="image"></p>
<p>设置片选gpio电平。</p>
<h2><span id="1-3-spi-cong-she-bei-qu-dong-ceng">1.3 SPI从设备驱动层</span><a href="#1-3-spi-cong-she-bei-qu-dong-ceng" class="header-anchor">#</a></h2><h3><span id="1-3-1-spi-cong-she-bei-api">1.3.1 SPI从设备API</span><a href="#1-3-1-spi-cong-she-bei-api" class="header-anchor">#</a></h3><h4><span id="1-3-1-1-spi-message-init">1.3.1.1 spi_message_init</span><a href="#1-3-1-1-spi-message-init" class="header-anchor">#</a></h4><p><code>void spi_message_init(struct spi_message *m);</code></p>
<p>在使用<code>spi_message</code>之前需要对其进行初始化。</p>
<h4><span id="1-3-1-2-spi-message-add-tail">1.3.1.2 spi_message_add_tail</span><a href="#1-3-1-2-spi-message-add-tail" class="header-anchor">#</a></h4><p><code>void spi_message_add_tail(struct spi_transfer *t, struct spi_message *m);</code></p>
<p><code>spi_message </code>初始化完成以后需要将 <code>spi_transfer</code> 添加到 <code>spi_message</code> 队列中。</p>
<h4><span id="1-3-1-3-spi-async">1.3.1.3 spi_async</span><a href="#1-3-1-3-spi-async" class="header-anchor">#</a></h4><p>参考核心层api有介绍。</p>
<h4><span id="1-3-1-4-spi-sync">1.3.1.4 spi_sync</span><a href="#1-3-1-4-spi-sync" class="header-anchor">#</a></h4><p>参考核心层api有介绍。</p>
<h4><span id="1-3-1-5-spi-register-driver">1.3.1.5 spi_register_driver</span><a href="#1-3-1-5-spi-register-driver" class="header-anchor">#</a></h4><h4><span id="1-3-1-6-spi-unregister-driver">1.3.1.6 spi_unregister_driver</span><a href="#1-3-1-6-spi-unregister-driver" class="header-anchor">#</a></h4><h4><span id="1-3-1-7-spi-read-x2f-spi-write">1.3.1.7 spi_read&#x2F;spi_write</span><a href="#1-3-1-7-spi-read-x2f-spi-write" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">spi_message_init_with_transfers</span><span class="params">(<span class="keyword">struct</span> spi_message *m,</span></span><br><span class="line"><span class="params">             <span class="keyword">struct</span> spi_transfer *xfers, <span class="type">unsigned</span> <span class="type">int</span> num_xfers)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> i;</span><br><span class="line">	spi_message_init(m);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_xfers; ++i)</span><br><span class="line">		spi_message_add_tail(&amp;xfers[i], m);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">spi_sync_transfer</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="keyword">struct</span> spi_transfer *xfers,</span></span><br><span class="line"><span class="params">             <span class="type">unsigned</span> <span class="type">int</span> num_xfers)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">msg</span>;</span></span><br><span class="line">	spi_message_init_with_transfers(&amp;msg, xfers, num_xfers);</span><br><span class="line">	<span class="keyword">return</span> spi_sync(spi, &amp;msg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">spi_read</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span>	<span class="title">t</span> =</span> &#123;</span><br><span class="line">			.rx_buf		= buf,</span><br><span class="line">			.len		= len,</span><br><span class="line">		&#125;;</span><br><span class="line">	<span class="keyword">return</span> spi_sync_transfer(spi, &amp;t, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">spi_write</span><span class="params">(<span class="keyword">struct</span> spi_device *spi, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span>	<span class="title">t</span> =</span> &#123;</span><br><span class="line">			.tx_buf		= buf,</span><br><span class="line">			.len		= len,</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> spi_sync_transfer(spi, &amp;t, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>spi_read, spi_write</code>本质还是调用<code>spi_sync</code>传输函数，做了一层封装把<code>spi_transfrer</code>和<code>spi_message</code>包装好了。</p>
<h3><span id="1-3-2-spi-cong-she-bei-shi-li-icm-20608-g">1.3.2 SPI从设备示例-ICM-20608-G</span><a href="#1-3-2-spi-cong-she-bei-shi-li-icm-20608-g" class="header-anchor">#</a></h3><p>该传感器详细介绍：<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/05/02/imx6ull%E8%A3%B8%E6%9C%BA-SPI/#2-1-6-zhou-tuo-luo-yi-jia-su-du-chuan-gan-qi-icm-20608-g">6轴陀螺仪加速度传感器ICM-20608-G</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17780817.html">IMX6ULL SPI应用-6轴陀螺仪加速度传感器ICM-20608-G - fuzidage - 博客园 (cnblogs.com)</a></p>
<h4><span id="1-3-2-1-dts-miao-shu">1.3.2.1 dts描述</span><a href="#1-3-2-1-dts-miao-shu" class="header-anchor">#</a></h4><p>打开自己board对应的dts,我这里是<code>imx6ull-alientek-emmc.dts</code>。我们修改<code>ecspi3 spi控制器</code>。我的spi3接了一个<code>ICM-20608</code>。资源定义如下：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png" alt="image"></p>
<p>根据原理图接线先配置<code>iomux</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_ecspi3: icm20608 &#123;</span><br><span class="line">	fsl,pins = &lt;</span><br><span class="line">		MX6UL_PAD_UART2_TX_DATA__GPIO1_IO20 <span class="number">0x10b0</span> <span class="comment">/* CS */</span></span><br><span class="line">		MX6UL_PAD_UART2_RX_DATA__ECSPI3_SCLK <span class="number">0x10b1</span> <span class="comment">/* SCLK */</span></span><br><span class="line">		MX6UL_PAD_UART2_RTS_B__ECSPI3_MISO <span class="number">0x10b1</span> <span class="comment">/* MISO */</span></span><br><span class="line">		MX6UL_PAD_UART2_CTS_B__ECSPI3_MOSI <span class="number">0x10b1</span> <span class="comment">/* MOSI */</span></span><br><span class="line">	&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>UART2_TX_DATA </code>这个 IO 是<code> ICM20608</code> 的片选信号，这里我们并没有将其复用为 ECSPI3 的<code>SS0</code>信号，而是将其复用为了普通的 GPIO。因为我们需要自己控制片选信号，所以将其复 用为普通的 GPIO。</p>
<p><code>imx6ull-alientek-emmc.dts</code>重新修改<code>ecspi3</code>节点，追加从设备描述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&amp;ecspi3 &#123;</span><br><span class="line">	fsl,spi-num-chipselects = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">	cs-gpios = &lt;&amp;gpio1 <span class="number">20</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_ecspi3&gt;;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"></span><br><span class="line">	spidev: icm20608@<span class="number">0</span> &#123;</span><br><span class="line">		compatible = <span class="string">&quot;alientek,icm20608&quot;</span>;</span><br><span class="line">		spi-max-frequency = &lt;<span class="number">8000000</span>&gt;;</span><br><span class="line">		reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>设置当前片选数量为 1，因为就只接了一个<code> ICM20608</code>。</li>
<li>一定要使用 <code>“cs-gpios”</code>属性来描述片选引脚，SPI 主机驱动就会控制片选引脚。 </li>
<li><code>imx6ull.dtsi</code> 文件中默认将 <code>ecspi3</code> 节点状态(status)设置为<code>“disable”</code>，这里我们要将 其改为<code>“okay”</code>。 </li>
<li><code>icm20608</code> 设备子节点，因为 <code>icm20608 </code>连接在<code>ECSPI3</code>的第 0 个通道上，因此 @后面为 0。<ol>
<li>设置节点属性兼容值为<code>“alientek,icm20608”</code>。</li>
<li>设置 SPI 最大时钟频 率为 <code>8MHz</code>，这是 ICM20608 的 SPI 接口所能支持的最大的时钟频率。</li>
<li>icm20608 连接 在<code>通道 0 </code>上，因此 reg 为 0。</li>
</ol>
</li>
</ol>
<h5><span id="1-3-2-1-1-spi-cong-she-bei-dts-miao-shu-gui-ze">1.3.2.1.1 spi从设备dts描述规则</span><a href="#1-3-2-1-1-spi-cong-she-bei-dts-miao-shu-gui-ze" class="header-anchor">#</a></h5><p>打开<code>linux\Documentation\devicetree\bindings\spi\spi-bus.txt</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SPI slave nodes must be children of the SPI master node and can</span><br><span class="line">contain the following properties.</span><br><span class="line">- reg             - (required) chip select address of device.</span><br><span class="line">- compatible      - (required) name of SPI device following generic names</span><br><span class="line">    		recommended practice</span><br><span class="line">- spi-max-frequency - (required) Maximum SPI clocking speed of device in Hz</span><br><span class="line">- spi-cpol        - (optional) Empty property indicating device requires</span><br><span class="line">    		inverse clock <span class="title function_">polarity</span> <span class="params">(CPOL)</span> mode</span><br><span class="line">- spi-cpha        - <span class="params">(optional)</span> Empty property indicating device requires</span><br><span class="line">    		shifted clock <span class="title function_">phase</span> <span class="params">(CPHA)</span> mode</span><br><span class="line">- spi-cs-high     - <span class="params">(optional)</span> Empty property indicating device requires</span><br><span class="line">    		chip select active high</span><br><span class="line">- spi-3wire       - <span class="params">(optional)</span> Empty property indicating device requires</span><br><span class="line">    		    3-wire mode.</span><br><span class="line">- spi-lsb-first   - <span class="params">(optional)</span> Empty property indicating device requires</span><br><span class="line">		LSB first mode.</span><br><span class="line">- spi-tx-bus-width - <span class="params">(optional)</span> The bus <span class="title function_">width</span><span class="params">(number of data wires)</span> that</span><br><span class="line">                      used <span class="keyword">for</span> MOSI. Defaults to 1 <span class="keyword">if</span> not present.</span><br><span class="line">- spi-rx-bus-width - <span class="params">(optional)</span> The bus <span class="title function_">width</span><span class="params">(number of data wires)</span> that</span><br><span class="line">                      used <span class="keyword">for</span> MISO. Defaults to 1 <span class="keyword">if</span> not present.</span><br></pre></td></tr></table></figure>

<h4><span id="1-3-2-2-icm20608-qu-dong">1.3.2.2 ICM20608驱动</span><a href="#1-3-2-2-icm20608-qu-dong" class="header-anchor">#</a></h4><h5><span id="1-3-2-2-1-icm20608reg-h">1.3.2.2.1 icm20608reg.h</span><a href="#1-3-2-2-1-icm20608reg-h" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ICM20608_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_H</span></span><br><span class="line"><span class="comment">/***************************************************************</span></span><br><span class="line"><span class="comment">文件名		: icm20608reg.h</span></span><br><span class="line"><span class="comment">***************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608G_ID			0XAF	<span class="comment">/* ID值 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608D_ID			0XAE	<span class="comment">/* ID值 */</span></span></span><br><span class="line"><span class="comment">/* ICM20608寄存器 </span></span><br><span class="line"><span class="comment"> *复位后所有寄存器地址都为0，除了</span></span><br><span class="line"><span class="comment"> *Register 107(0X6B) Power Management 1 	= 0x40</span></span><br><span class="line"><span class="comment"> *Register 117(0X75) WHO_AM_I 				= 0xAF或0xAE</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* 陀螺仪和加速度自测(出产时设置，用于与用户的自检输出值比较） */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_X_GYRO		0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_Y_GYRO		0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_Z_GYRO		0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_X_ACCEL		0x0D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_Y_ACCEL		0x0E</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SELF_TEST_Z_ACCEL		0x0F</span></span><br><span class="line"><span class="comment">/* 陀螺仪静态偏移 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_XG_OFFS_USRH			0x13</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_XG_OFFS_USRL			0x14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_YG_OFFS_USRH			0x15</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_YG_OFFS_USRL			0x16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ZG_OFFS_USRH			0x17</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ZG_OFFS_USRL			0x18</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SMPLRT_DIV			0x19</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_CONFIG				0x1A</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_CONFIG			0x1B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_CONFIG			0x1C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_CONFIG2			0x1D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_LP_MODE_CFG			0x1E</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_WOM_THR			0x1F</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_FIFO_EN				0x23</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_FSYNC_INT				0x36</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_INT_PIN_CFG			0x37</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_INT_ENABLE			0x38</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_INT_STATUS			0x3A</span></span><br><span class="line"><span class="comment">/* 加速度输出 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_XOUT_H			0x3B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_XOUT_L			0x3C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_YOUT_H			0x3D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_YOUT_L			0x3E</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_ZOUT_H			0x3F</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_ZOUT_L			0x40</span></span><br><span class="line"><span class="comment">/* 温度输出 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_TEMP_OUT_H			0x41</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_TEMP_OUT_L			0x42</span></span><br><span class="line"><span class="comment">/* 陀螺仪输出 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_XOUT_H			0x43</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_XOUT_L			0x44</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_YOUT_H			0x45</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_YOUT_L			0x46</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_ZOUT_H			0x47</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_GYRO_ZOUT_L			0x48</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_SIGNAL_PATH_RESET		0x68</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ACCEL_INTEL_CTRL 		0x69</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_USER_CTRL				0x6A</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_PWR_MGMT_1			0x6B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_PWR_MGMT_2			0x6C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_FIFO_COUNTH			0x72</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_FIFO_COUNTL			0x73</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_FIFO_R_W				0x74</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_WHO_AM_I 				0x75</span></span><br><span class="line"><span class="comment">/* 加速度静态偏移 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_XA_OFFSET_H			0x77</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_XA_OFFSET_L			0x78</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_YA_OFFSET_H			0x7A</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_YA_OFFSET_L			0x7B</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ZA_OFFSET_H			0x7D</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	ICM20_ZA_OFFSET_L 			0x7E</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h5><span id="1-3-2-2-2-icm20608-c">1.3.2.2.2 icm20608.c</span><a href="#1-3-2-2-2-icm20608-c" class="header-anchor">#</a></h5><details>
<summary>点击查看代码</summary>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/timer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/i2c.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_address.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/mach/map.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;icm20608reg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_CNT	1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_NAME	<span class="string">&quot;icm20608&quot;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> &#123;</span></span><br><span class="line">	<span class="type">dev_t</span> devid;				<span class="comment">/* 设备号 	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span>			<span class="comment">/* cdev 	*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="keyword">class</span>;</span>		<span class="comment">/* 类 		*/</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">device</span>;</span>		<span class="comment">/* 设备 	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span>	*<span class="title">nd</span>;</span> 	<span class="comment">/* 设备节点 */</span></span><br><span class="line">	<span class="type">int</span> major;					<span class="comment">/* 主设备号 */</span></span><br><span class="line">	<span class="type">void</span> *private_data;			<span class="comment">/* 私有数据 		*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> gyro_x_adc;		<span class="comment">/* 陀螺仪X轴原始值 	 */</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> gyro_y_adc;		<span class="comment">/* 陀螺仪Y轴原始值		*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> gyro_z_adc;		<span class="comment">/* 陀螺仪Z轴原始值 		*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> accel_x_adc;		<span class="comment">/* 加速度计X轴原始值 	*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> accel_y_adc;		<span class="comment">/* 加速度计Y轴原始值	*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> accel_z_adc;		<span class="comment">/* 加速度计Z轴原始值 	*/</span></span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> temp_adc;		<span class="comment">/* 温度原始值 			*/</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> <span class="title">icm20608dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 从icm20608读取多个寄存器数据</span></span><br><span class="line"><span class="comment"> * @param - dev:  icm20608设备</span></span><br><span class="line"><span class="comment"> * @param - reg:  要读取的寄存器首地址</span></span><br><span class="line"><span class="comment"> * @param - val:  读取到的数据</span></span><br><span class="line"><span class="comment"> * @param - len:  要读取的数据长度</span></span><br><span class="line"><span class="comment"> * @return 		: 操作结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_read_regs</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg, <span class="type">void</span> *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> txdata[<span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> * rxdata;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">m</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line">    </span><br><span class="line">	t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);	<span class="comment">/* 申请内存 */</span></span><br><span class="line">	<span class="keyword">if</span>(!t) &#123;</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rxdata = kzalloc(<span class="keyword">sizeof</span>(<span class="type">char</span>) * len, GFP_KERNEL);	<span class="comment">/* 申请内存 */</span></span><br><span class="line">	<span class="keyword">if</span>(!rxdata) &#123;</span><br><span class="line">		<span class="keyword">goto</span> out1;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">	<span class="comment">/* 一共发送len+1个字节的数据，第一个字节为</span></span><br><span class="line"><span class="comment">	寄存器首地址，一共要读取len个字节长度的数据，*/</span></span><br><span class="line">	txdata[<span class="number">0</span>] = reg | <span class="number">0x80</span>;		<span class="comment">/* 写数据的时候首寄存器地址bit8要置1 */</span>			</span><br><span class="line">	t-&gt;tx_buf = txdata;			<span class="comment">/* 要发送的数据 */</span></span><br><span class="line">    t-&gt;rx_buf = rxdata;			<span class="comment">/* 要读取的数据 */</span></span><br><span class="line">	t-&gt;len = len+<span class="number">1</span>;				<span class="comment">/* t-&gt;len=发送的长度+读取的长度 */</span></span><br><span class="line">	spi_message_init(&amp;m);		<span class="comment">/* 初始化spi_message */</span></span><br><span class="line">	spi_message_add_tail(t, &amp;m);<span class="comment">/* 将spi_transfer添加到spi_message队列 */</span></span><br><span class="line">	ret = spi_sync(spi, &amp;m);	<span class="comment">/* 同步发送 */</span></span><br><span class="line">	<span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//第一步，发送寄存器地址</span></span><br><span class="line">    txdata[<span class="number">0</span>] = reg | <span class="number">0x80</span>;</span><br><span class="line">    t-&gt;tx_buf = txdata;</span><br><span class="line">    t-&gt;len = <span class="number">1</span>;</span><br><span class="line">    spi_message_init(&amp;m);</span><br><span class="line">	spi_message_add_tail(t, &amp;m);</span><br><span class="line">	ret = spi_sync(spi, &amp;m);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//第二步，读取数据</span></span><br><span class="line">    txdata[<span class="number">0</span>] = <span class="number">0xff</span>;</span><br><span class="line">    t-&gt;rx_buf = buf;</span><br><span class="line">    t-&gt;len = len;</span><br><span class="line">    spi_message_init(&amp;m);</span><br><span class="line">	spi_message_add_tail(t, &amp;m);</span><br><span class="line">	ret = spi_sync(spi, &amp;m);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(ret) &#123;</span><br><span class="line">		<span class="keyword">goto</span> out2;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf , rxdata+<span class="number">1</span>, len);  <span class="comment">/* 只需要读取的数据 */</span></span><br><span class="line">out2:</span><br><span class="line">	kfree(rxdata);					<span class="comment">/* 释放内存 */</span></span><br><span class="line">out1:	</span><br><span class="line">	kfree(t);						<span class="comment">/* 释放内存 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 向icm20608多个寄存器写入数据</span></span><br><span class="line"><span class="comment"> * @param - dev:  icm20608设备</span></span><br><span class="line"><span class="comment"> * @param - reg:  要写入的寄存器首地址</span></span><br><span class="line"><span class="comment"> * @param - val:  要写入的数据缓冲区</span></span><br><span class="line"><span class="comment"> * @param - len:  要写入的数据长度</span></span><br><span class="line"><span class="comment"> * @return 	  :   操作结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> s32 <span class="title function_">icm20608_write_regs</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg, u8 *buf, u8 len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">-1</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *txdata;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> <span class="title">m</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> *<span class="title">t</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span> =</span> (<span class="keyword">struct</span> spi_device *)dev-&gt;private_data;</span><br><span class="line">	</span><br><span class="line">	t = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> spi_transfer), GFP_KERNEL);	<span class="comment">/* 申请内存 */</span></span><br><span class="line">	<span class="keyword">if</span>(!t) &#123;</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	txdata = kzalloc(<span class="keyword">sizeof</span>(<span class="type">char</span>)+len, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span>(!txdata) &#123;</span><br><span class="line">		<span class="keyword">goto</span> out1;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* 一共发送len+1个字节的数据，第一个字节为</span></span><br><span class="line"><span class="comment">	寄存器首地址，len为要写入的寄存器的集合，*/</span></span><br><span class="line">    <span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">	*txdata = reg &amp; ~<span class="number">0x80</span>;	<span class="comment">/* 写数据的时候首寄存器地址bit8要清零 */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(txdata+<span class="number">1</span>, buf, len);	<span class="comment">/* 把len个寄存器拷贝到txdata里，等待发送 */</span></span><br><span class="line">	t-&gt;tx_buf = txdata;			<span class="comment">/* 要发送的数据 */</span></span><br><span class="line">	t-&gt;len = len+<span class="number">1</span>;				<span class="comment">/* t-&gt;len=发送的长度+读取的长度 */</span></span><br><span class="line">	spi_message_init(&amp;m);		<span class="comment">/* 初始化spi_message */</span></span><br><span class="line">	spi_message_add_tail(t, &amp;m);<span class="comment">/* 将spi_transfer添加到spi_message队列 */</span></span><br><span class="line">	ret = spi_sync(spi, &amp;m);	<span class="comment">/* 同步发送 */</span></span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">//第一步，发送寄存器地址</span></span><br><span class="line">    txdata[<span class="number">0</span>] = reg &amp; ~<span class="number">0x80</span>;</span><br><span class="line">    t-&gt;tx_buf = txdata;</span><br><span class="line">    t-&gt;len = <span class="number">1</span>;</span><br><span class="line">    spi_message_init(&amp;m);</span><br><span class="line">	spi_message_add_tail(t, &amp;m);</span><br><span class="line">	ret = spi_sync(spi, &amp;m);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//第二步，写入数据</span></span><br><span class="line">    t-&gt;tx_buf = buf;</span><br><span class="line">    t-&gt;len = len;</span><br><span class="line">    spi_message_init(&amp;m);</span><br><span class="line">	spi_message_add_tail(t, &amp;m);</span><br><span class="line">	ret = spi_sync(spi, &amp;m);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span>(ret) &#123;</span><br><span class="line">        <span class="keyword">goto</span> out2;</span><br><span class="line">    &#125;</span><br><span class="line">out2:</span><br><span class="line">	kfree(txdata);				<span class="comment">/* 释放内存 */</span></span><br><span class="line">out1:</span><br><span class="line">	kfree(t);					<span class="comment">/* 释放内存 */</span></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 读取icm20608指定寄存器值，读取一个寄存器</span></span><br><span class="line"><span class="comment"> * @param - dev:  icm20608设备</span></span><br><span class="line"><span class="comment"> * @param - reg:  要读取的寄存器</span></span><br><span class="line"><span class="comment"> * @return 	  :   读取到的寄存器值</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">icm20608_read_onereg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg)</span> &#123;</span><br><span class="line">	u8 data = <span class="number">0</span>;</span><br><span class="line">	icm20608_read_regs(dev, reg, &amp;data, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 向icm20608指定寄存器写入指定的值，写一个寄存器</span></span><br><span class="line"><span class="comment"> * @param - dev:  icm20608设备</span></span><br><span class="line"><span class="comment"> * @param - reg:  要写的寄存器</span></span><br><span class="line"><span class="comment"> * @param - data: 要写入的值</span></span><br><span class="line"><span class="comment"> * @return   :    无</span></span><br><span class="line"><span class="comment"> */</span>	</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">icm20608_write_onereg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg, u8 value)</span> &#123;</span><br><span class="line">	u8 buf = value;</span><br><span class="line">	icm20608_write_regs(dev, reg, &amp;buf, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">icm20608_readdata</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev)</span> &#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">14</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	icm20608_read_regs(dev, ICM20_ACCEL_XOUT_H, data, <span class="number">14</span>);</span><br><span class="line"></span><br><span class="line">	dev-&gt;accel_x_adc = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">1</span>]); </span><br><span class="line">	dev-&gt;accel_y_adc = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">3</span>]); </span><br><span class="line">	dev-&gt;accel_z_adc = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">4</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">5</span>]); </span><br><span class="line">	dev-&gt;temp_adc    = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">6</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">7</span>]); </span><br><span class="line">	dev-&gt;gyro_x_adc  = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">8</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">9</span>]); </span><br><span class="line">	dev-&gt;gyro_y_adc  = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">10</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">11</span>]);</span><br><span class="line">	dev-&gt;gyro_z_adc  = (<span class="type">signed</span> <span class="type">short</span>)((data[<span class="number">12</span>] &lt;&lt; <span class="number">8</span>) | data[<span class="number">13</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_open</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span>&#123;</span><br><span class="line">	filp-&gt;private_data = &amp;icm20608dev; <span class="comment">/* 设置私有数据 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">icm20608_read</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf, <span class="type">size_t</span> cnt, <span class="type">loff_t</span> *off)</span>&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> data[<span class="number">7</span>];</span><br><span class="line">	<span class="type">long</span> err = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span> =</span> (<span class="keyword">struct</span> icm20608_dev *)filp-&gt;private_data;</span><br><span class="line"></span><br><span class="line">	icm20608_readdata(dev);</span><br><span class="line">	data[<span class="number">0</span>] = dev-&gt;gyro_x_adc;</span><br><span class="line">	data[<span class="number">1</span>] = dev-&gt;gyro_y_adc;</span><br><span class="line">	data[<span class="number">2</span>] = dev-&gt;gyro_z_adc;</span><br><span class="line">	data[<span class="number">3</span>] = dev-&gt;accel_x_adc;</span><br><span class="line">	data[<span class="number">4</span>] = dev-&gt;accel_y_adc;</span><br><span class="line">	data[<span class="number">5</span>] = dev-&gt;accel_z_adc;</span><br><span class="line">	data[<span class="number">6</span>] = dev-&gt;temp_adc;</span><br><span class="line">	err = copy_to_user(buf, data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_release</span><span class="params">(<span class="keyword">struct</span> inode *inode, <span class="keyword">struct</span> file *filp)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">icm20608_ops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line">	.open = icm20608_open,</span><br><span class="line">	.read = icm20608_read,</span><br><span class="line">	.release = icm20608_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">icm20608_reginit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	u8 value = <span class="number">0</span>;</span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_PWR_MGMT_1, <span class="number">0x80</span>);</span><br><span class="line">	mdelay(<span class="number">50</span>);</span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_PWR_MGMT_1, <span class="number">0x01</span>);</span><br><span class="line">	mdelay(<span class="number">50</span>);</span><br><span class="line">	value = icm20608_read_onereg(&amp;icm20608dev, ICM20_WHO_AM_I);</span><br><span class="line">	printk(<span class="string">&quot;ICM20608 ID = %#X\r\n&quot;</span>, value);	</span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_SMPLRT_DIV, <span class="number">0x00</span>); 	<span class="comment">/* 输出速率是内部采样率					*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_GYRO_CONFIG, <span class="number">0x18</span>); 	<span class="comment">/* 陀螺仪±2000dps量程 				*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_ACCEL_CONFIG, <span class="number">0x18</span>); 	<span class="comment">/* 加速度计±16G量程 					*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_CONFIG, <span class="number">0x04</span>); 		<span class="comment">/* 陀螺仪低通滤波BW=20Hz 				*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_ACCEL_CONFIG2, <span class="number">0x04</span>); <span class="comment">/* 加速度计低通滤波BW=21.2Hz 			*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_PWR_MGMT_2, <span class="number">0x00</span>); 	<span class="comment">/* 打开加速度计和陀螺仪所有轴 				*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_LP_MODE_CFG, <span class="number">0x00</span>); 	<span class="comment">/* 关闭低功耗 						*/</span></span><br><span class="line">	icm20608_write_onereg(&amp;icm20608dev, ICM20_FIFO_EN, <span class="number">0x00</span>);		<span class="comment">/* 关闭FIFO						*/</span></span><br><span class="line">&#125;	</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (icm20608dev.major) &#123;</span><br><span class="line">		icm20608dev.devid = MKDEV(icm20608dev.major, <span class="number">0</span>);</span><br><span class="line">		register_chrdev_region(icm20608dev.devid, ICM20608_CNT, ICM20608_NAME);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		alloc_chrdev_region(&amp;icm20608dev.devid, <span class="number">0</span>, ICM20608_CNT, ICM20608_NAME);</span><br><span class="line">		icm20608dev.major = MAJOR(icm20608dev.devid);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	cdev_init(&amp;icm20608dev.cdev, &amp;icm20608_ops);</span><br><span class="line">	cdev_add(&amp;icm20608dev.cdev, icm20608dev.devid, ICM20608_CNT);</span><br><span class="line"></span><br><span class="line">	icm20608dev.class = class_create(THIS_MODULE, ICM20608_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(icm20608dev.class)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(icm20608dev.class);</span><br><span class="line">	&#125;</span><br><span class="line">	icm20608dev.device = device_create(icm20608dev.class, <span class="literal">NULL</span>, icm20608dev.devid, <span class="literal">NULL</span>, ICM20608_NAME);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(icm20608dev.device)) &#123;</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(icm20608dev.device);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*初始化spi_device */</span></span><br><span class="line">	spi-&gt;mode = SPI_MODE_0;	<span class="comment">/*MODE0，CPOL=0，CPHA=0*/</span></span><br><span class="line">	spi_setup(spi);</span><br><span class="line">	icm20608dev.private_data = spi; <span class="comment">/* 设置私有数据 */</span></span><br><span class="line">	<span class="comment">/* 初始化ICM20608内部寄存器 */</span></span><br><span class="line">	icm20608_reginit();		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span> &#123;</span><br><span class="line">	cdev_del(&amp;icm20608dev.cdev);</span><br><span class="line">	unregister_chrdev_region(icm20608dev.devid, ICM20608_CNT);</span><br><span class="line">	device_destroy(icm20608dev.class, icm20608dev.devid);</span><br><span class="line">	class_destroy(icm20608dev.class);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 传统匹配方式ID列表 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> <span class="title">icm20608_id</span>[] =</span> &#123;</span><br><span class="line">	&#123;<span class="string">&quot;alientek,icm20608&quot;</span>, <span class="number">0</span>&#125;,  </span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 设备树匹配列表 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">icm20608_of_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;alientek,icm20608&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SPI驱动结构体 */</span>	</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">icm20608_driver</span> =</span> &#123;</span><br><span class="line">	.probe = icm20608_probe,</span><br><span class="line">	.remove = icm20608_remove,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">			.owner = THIS_MODULE,</span><br><span class="line">		   	.name = <span class="string">&quot;icm20608&quot;</span>,</span><br><span class="line">		   	.of_match_table = icm20608_of_match, </span><br><span class="line">		   &#125;,</span><br><span class="line">	.id_table = icm20608_id,</span><br><span class="line">&#125;;</span><br><span class="line">		   </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">icm20608_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> spi_register_driver(&amp;icm20608_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">icm20608_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	spi_unregister_driver(&amp;icm20608_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(icm20608_init);</span><br><span class="line">module_exit(icm20608_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure>

</details>

<h6><span id="1-3-2-2-2-1-qu-dong-guo-cheng-fen-xi">1.3.2.2.2.1 驱动过程分析</span><a href="#1-3-2-2-2-1-qu-dong-guo-cheng-fen-xi" class="header-anchor">#</a></h6><ol>
<li><p>作为一个spi从设备驱动，需要定义一个<code>spi_driver</code> <code>icm20608_driver</code>。通过<code>spi_register_driver</code>、<code>spi_unregister_driver</code>注册卸载。</p>
</li>
<li><p><code>compatible</code>匹配执行probe。</p>
<ol>
<li>定一个<code>icm20608_dev</code>，按照字符设备框架，注册字符设备。</li>
<li><code>spi_setup</code>设置<code>spi_device</code>从设备, 设置spi设备的模式和速率。<br><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png" alt="image-20240831182608432"></li>
<li>初始化<code>ICM20608</code>内部寄存器（发起spi传输）。<ol>
<li>设置启动时序，使能读写。</li>
<li>读id。</li>
<li>设置量程，速率。</li>
</ol>
</li>
</ol>
</li>
<li><p><code>ICM20608</code>的读写</p>
</li>
<li><p><code>icm20608_read</code>调用<code>icm20608_readdata</code>，调用<code>icm20608_read_regs</code></p>
</li>
<li><p><code>icm20608_write_regs</code>， <code>icm20608_read_regs</code>用来spi协议让主控去读写spi从设备，都是通过<code>spi_sync</code>进行数据传输。</p>
</li>
</ol>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png" alt="image"></p>
<pre><code>  将函数精简话一下：
</code></pre>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png" alt="image"></p>
<p>注意精简后有个bug, 就是调用spi_write后，又继续调用spi_read。这时imx6ul spi控制器驱动内部会帮忙控制cs片选信号。又会重新拉高，再拉低cs片选。因此导致数据传输异常。nxp官方也是用的gpio作为cs片选，软件手动去控制的。因此优化如下：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png" alt="image"></p>
<p>probe读出icm20608 <code>id</code>为：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png" alt="image"></p>
<h5><span id="1-3-2-2-3-icm20608app-c">1.3.2.2.3 icm20608App.c</span><a href="#1-3-2-2-3-icm20608app-c" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/ioctl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">char</span> *filename;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> databuf[<span class="number">7</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> data[<span class="number">14</span>];</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> gyro_x_adc, gyro_y_adc, gyro_z_adc;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> accel_x_adc, accel_y_adc, accel_z_adc;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> temp_adc;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> gyro_x_act, gyro_y_act, gyro_z_act;</span><br><span class="line">	<span class="type">float</span> accel_x_act, accel_y_act, accel_z_act;</span><br><span class="line">	<span class="type">float</span> temp_act;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error Usage!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	filename = argv[<span class="number">1</span>];</span><br><span class="line">	fd = open(filename, O_RDWR);</span><br><span class="line">	<span class="keyword">if</span>(fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s\r\n&quot;</span>, filename);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		ret = read(fd, databuf, <span class="keyword">sizeof</span>(databuf));</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123; 			<span class="comment">/* 数据读取成功 */</span></span><br><span class="line">			gyro_x_adc = databuf[<span class="number">0</span>];</span><br><span class="line">			gyro_y_adc = databuf[<span class="number">1</span>];</span><br><span class="line">			gyro_z_adc = databuf[<span class="number">2</span>];</span><br><span class="line">			accel_x_adc = databuf[<span class="number">3</span>];</span><br><span class="line">			accel_y_adc = databuf[<span class="number">4</span>];</span><br><span class="line">			accel_z_adc = databuf[<span class="number">5</span>];</span><br><span class="line">			temp_adc = databuf[<span class="number">6</span>];</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* 计算实际值 */</span></span><br><span class="line">			gyro_x_act = (<span class="type">float</span>)(gyro_x_adc)  / <span class="number">16.4</span>;</span><br><span class="line">			gyro_y_act = (<span class="type">float</span>)(gyro_y_adc)  / <span class="number">16.4</span>;</span><br><span class="line">			gyro_z_act = (<span class="type">float</span>)(gyro_z_adc)  / <span class="number">16.4</span>;</span><br><span class="line">			accel_x_act = (<span class="type">float</span>)(accel_x_adc) / <span class="number">2048</span>;</span><br><span class="line">			accel_y_act = (<span class="type">float</span>)(accel_y_adc) / <span class="number">2048</span>;</span><br><span class="line">			accel_z_act = (<span class="type">float</span>)(accel_z_adc) / <span class="number">2048</span>;</span><br><span class="line">			temp_act = ((<span class="type">float</span>)(temp_adc) - <span class="number">25</span> ) / <span class="number">326.8</span> + <span class="number">25</span>;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\r\n原始值:\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;gx = %d, gy = %d, gz = %d\r\n&quot;</span>, gyro_x_adc, gyro_y_adc, gyro_z_adc);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ax = %d, ay = %d, az = %d\r\n&quot;</span>, accel_x_adc, accel_y_adc, accel_z_adc);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;temp = %d\r\n&quot;</span>, temp_adc);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;实际值:&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act gx = %.2f°/S, act gy = %.2f°/S, act gz = %.2f°/S\r\n&quot;</span>, gyro_x_act, gyro_y_act, gyro_z_act);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act ax = %.2fg, act ay = %.2fg, act az = %.2fg\r\n&quot;</span>, accel_x_act, accel_y_act, accel_z_act);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act temp = %.2f°C\r\n&quot;</span>, temp_act);</span><br><span class="line">		&#125;</span><br><span class="line">		usleep(<span class="number">100000</span>); <span class="comment">/*100ms */</span></span><br><span class="line">	&#125;</span><br><span class="line">	close(fd);	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png" alt="image"></p>
<h3><span id="1-3-3-spi-wan-neng-cong-she-bei-qu-dong-spidev-c">1.3.3 SPI万能从设备驱动-spidev.c</span><a href="#1-3-3-spi-wan-neng-cong-she-bei-qu-dong-spidev-c" class="header-anchor">#</a></h3><p>万能SPI从设备驱动对应spidev， 驱动代码位于<code>/drivers/spi/spidev.c</code>。不用为每个spi从设备去写一个驱动，linux内核有一个万能通用的从设备驱动。</p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png" alt="image"></p>
<p>为什么说<code>spidev.c</code>是一个通用的从设备驱动。</p>
<p>spidev不是专门针对某一SPI硬件设备做的驱动，只是简单的注册字符设备，用户空间通过<code>read、write、ioctl</code>，直接对spi进行操作，相当于是用户空间和spi设备的桥梁。用户空间操作时，打开设备节点，然后通过IOCTL设置模式、速度等参数，然后就可以调用<code>read write</code>进行操作了。</p>
<h4><span id="1-3-3-1-spidev-init">1.3.3.1 spidev_init</span><a href="#1-3-3-1-spidev-init" class="header-anchor">#</a></h4><p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png" alt="image"></p>
<p>注册了字符设备，主设备号<code>SPIDEV_MAJOR= 153</code>，绑定<code>spidev_fops</code>。</p>
<p>创建了spidev的class，创建完成后在用户空间<code>/sys/class/</code>下可以看到spidev目录结构。</p>
<p><code>spi_register_driver</code>按照标准流程注册spidev从设备驱动。</p>
<h4><span id="1-3-3-2-spidev-de-probe">1.3.3.2 spidev的probe</span><a href="#1-3-3-2-spidev-de-probe" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">spidev_dt_ids</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;rohm,dh2228fv&quot;</span> &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;lineartechnology,ltc2488&quot;</span> &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;ge,achc&quot;</span> &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;nanopi,spidev&quot;</span> &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;semtech,sx1301&quot;</span> &#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">spidev_spi_driver</span> =</span> &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name =		<span class="string">&quot;spidev&quot;</span>,</span><br><span class="line">		.of_match_table = of_match_ptr(spidev_dt_ids),</span><br><span class="line">		.acpi_match_table = ACPI_PTR(spidev_acpi_ids),</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe =	spidev_probe,</span><br><span class="line">	.remove =	spidev_remove,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spidev_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spidev_data</span>	*<span class="title">spidev</span>;</span></span><br><span class="line">	<span class="type">int</span>			status;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		minor;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (spi-&gt;dev.of_node &amp;&amp; !of_match_device(spidev_dt_ids, &amp;spi-&gt;dev)) &#123;</span><br><span class="line">		dev_err(&amp;spi-&gt;dev, <span class="string">&quot;buggy DT: spidev listed directly in DT\n&quot;</span>);</span><br><span class="line">		WARN_ON(spi-&gt;dev.of_node &amp;&amp;</span><br><span class="line">			!of_match_device(spidev_dt_ids, &amp;spi-&gt;dev));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spidev_probe_acpi(spi);</span><br><span class="line">	<span class="comment">/* Allocate driver data */</span></span><br><span class="line">	spidev = kzalloc(<span class="keyword">sizeof</span>(*spidev), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!spidev)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">	<span class="comment">/* Initialize the driver data */</span></span><br><span class="line">	spidev-&gt;spi = spi;</span><br><span class="line">	spin_lock_init(&amp;spidev-&gt;spi_lock);</span><br><span class="line">	mutex_init(&amp;spidev-&gt;buf_lock);</span><br><span class="line">	INIT_LIST_HEAD(&amp;spidev-&gt;device_entry);</span><br><span class="line">	<span class="comment">/* If we can allocate a minor number, hook up this device.</span></span><br><span class="line"><span class="comment">	 * Reusing minors is fine so long as udev or mdev is working.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mutex_lock(&amp;device_list_lock);</span><br><span class="line">	minor = find_first_zero_bit(minors, N_SPI_MINORS);</span><br><span class="line">	<span class="keyword">if</span> (minor &lt; N_SPI_MINORS) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">		spidev-&gt;devt = MKDEV(SPIDEV_MAJOR, minor);</span><br><span class="line">		dev = device_create(spidev_class, &amp;spi-&gt;dev, spidev-&gt;devt,</span><br><span class="line">				    spidev, <span class="string">&quot;spidev%d.%d&quot;</span>,</span><br><span class="line">				    spi-&gt;master-&gt;bus_num, spi-&gt;chip_select);</span><br><span class="line">		status = PTR_ERR_OR_ZERO(dev);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		dev_dbg(&amp;spi-&gt;dev, <span class="string">&quot;no minor number available!\n&quot;</span>);</span><br><span class="line">		status = -ENODEV;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (status == <span class="number">0</span>) &#123;</span><br><span class="line">		set_bit(minor, minors);</span><br><span class="line">		list_add(&amp;spidev-&gt;device_entry, &amp;device_list);</span><br><span class="line">	&#125;</span><br><span class="line">	mutex_unlock(&amp;device_list_lock);</span><br><span class="line">	spidev-&gt;speed_hz = spi-&gt;max_speed_hz;</span><br><span class="line">	<span class="keyword">if</span> (status == <span class="number">0</span>)</span><br><span class="line">		spi_set_drvdata(spi, spidev);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		kfree(spidev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>device_create</code>创建了<code>/dev/</code>下的<code>spidev</code>节点,主设备号<code>SPIDEV_MAJOR= 153</code>，如<code>spi总线0</code>上<code>cs1</code>设备，则设备名为<code>/dev/spidev0.1</code>，其他以此类推。</p>
<h4><span id="1-3-3-3-spidev-fops">1.3.3.3 spidev_fops</span><a href="#1-3-3-3-spidev-fops" class="header-anchor">#</a></h4><h5><span id="1-3-3-3-1-spidev-read">1.3.3.3.1 spidev_read</span><a href="#1-3-3-3-1-spidev-read" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spidev_read</span><br><span class="line">	-&gt;spidev_sync_read</span><br><span class="line">		-&gt;spidev_sync</span><br><span class="line">			-&gt;spi_sync</span><br></pre></td></tr></table></figure>

<h5><span id="1-3-3-3-2-spidev-write">1.3.3.3.2 spidev_write</span><a href="#1-3-3-3-2-spidev-write" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spidev_write</span><br><span class="line">	-&gt;spidev_sync_write</span><br><span class="line">		-&gt;spidev_sync</span><br><span class="line">			-&gt;spi_sync</span><br></pre></td></tr></table></figure>

<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png" alt="image"></p>
<p>构造<code>spi_message</code>,<code>spi_transfer</code>调用<code>spi_sync</code>进行数据传输。</p>
<h5><span id="1-3-3-3-3-spidev-ioctl">1.3.3.3.3 spidev_ioctl</span><a href="#1-3-3-3-3-spidev-ioctl" class="header-anchor">#</a></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">spidev_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">	<span class="type">int</span>			retval = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spidev_data</span>	*<span class="title">spidev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span>	*<span class="title">spi</span>;</span></span><br><span class="line">	u32			tmp;</span><br><span class="line">	<span class="type">unsigned</span>		n_ioc;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_ioc_transfer</span>	*<span class="title">ioc</span>;</span></span><br><span class="line">    <span class="comment">/* Check type and command number */</span></span><br><span class="line">    <span class="keyword">if</span> (_IOC_TYPE(cmd) != SPI_IOC_MAGIC)</span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    <span class="comment">/* guard against device removal before, or while,</span></span><br><span class="line"><span class="comment">     * we issue this ioctl.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    spidev = filp-&gt;private_data;</span><br><span class="line">    spin_lock_irq(&amp;spidev-&gt;spi_lock);</span><br><span class="line">    spi = spi_dev_get(spidev-&gt;spi);</span><br><span class="line">    spin_unlock_irq(&amp;spidev-&gt;spi_lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (spi == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span> -ESHUTDOWN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* use the buffer lock here for triple duty:</span></span><br><span class="line"><span class="comment">     *  - prevent I/O (from us) so calling spi_setup() is safe;</span></span><br><span class="line"><span class="comment">     *  - prevent concurrent SPI_IOC_WR_* from morphing</span></span><br><span class="line"><span class="comment">     *    data fields while SPI_IOC_RD_* reads them;</span></span><br><span class="line"><span class="comment">     *  - SPI_IOC_MESSAGE needs the buffer locked &quot;normally&quot;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    mutex_lock(&amp;spidev-&gt;buf_lock);</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="comment">/* read requests */</span></span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_RD_MODE:</span><br><span class="line">        retval = put_user(spi-&gt;mode &amp; SPI_MODE_MASK,</span><br><span class="line">                    (__u8 __user *)arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_RD_MODE32:</span><br><span class="line">        retval = put_user(spi-&gt;mode &amp; SPI_MODE_MASK,</span><br><span class="line">                    (__u32 __user *)arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_RD_LSB_FIRST:</span><br><span class="line">        retval = put_user((spi-&gt;mode &amp; SPI_LSB_FIRST) ?  <span class="number">1</span> : <span class="number">0</span>,</span><br><span class="line">                    (__u8 __user *)arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_RD_BITS_PER_WORD:</span><br><span class="line">        retval = put_user(spi-&gt;bits_per_word, (__u8 __user *)arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_RD_MAX_SPEED_HZ:</span><br><span class="line">        retval = put_user(spidev-&gt;speed_hz, (__u32 __user *)arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* write requests */</span></span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_WR_MODE:</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_WR_MODE32:</span><br><span class="line">        <span class="keyword">if</span> (cmd == SPI_IOC_WR_MODE)</span><br><span class="line">            retval = get_user(tmp, (u8 __user *)arg);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            retval = get_user(tmp, (u32 __user *)arg);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">spi_controller</span> *<span class="title">ctlr</span> =</span> spi-&gt;controller;</span><br><span class="line">            u32	save = spi-&gt;mode;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tmp &amp; ~SPI_MODE_MASK) &#123;</span><br><span class="line">                retval = -EINVAL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ctlr-&gt;use_gpio_descriptors &amp;&amp; ctlr-&gt;cs_gpiods &amp;&amp;</span><br><span class="line">                ctlr-&gt;cs_gpiods[spi-&gt;chip_select])</span><br><span class="line">                tmp |= SPI_CS_HIGH;</span><br><span class="line"></span><br><span class="line">            tmp |= spi-&gt;mode &amp; ~SPI_MODE_MASK;</span><br><span class="line">            spi-&gt;mode = (u16)tmp;</span><br><span class="line">            retval = spi_setup(spi);</span><br><span class="line">            <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">                spi-&gt;mode = save;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                dev_dbg(&amp;spi-&gt;dev, <span class="string">&quot;spi mode %x\n&quot;</span>, tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_WR_LSB_FIRST:</span><br><span class="line">        retval = get_user(tmp, (__u8 __user *)arg);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            u32	save = spi-&gt;mode;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tmp)</span><br><span class="line">                spi-&gt;mode |= SPI_LSB_FIRST;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                spi-&gt;mode &amp;= ~SPI_LSB_FIRST;</span><br><span class="line">            retval = spi_setup(spi);</span><br><span class="line">            <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">                spi-&gt;mode = save;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                dev_dbg(&amp;spi-&gt;dev, <span class="string">&quot;%csb first\n&quot;</span>,</span><br><span class="line">                        tmp ? <span class="string">&#x27;l&#x27;</span> : <span class="string">&#x27;m&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_WR_BITS_PER_WORD:</span><br><span class="line">        retval = get_user(tmp, (__u8 __user *)arg);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            u8	save = spi-&gt;bits_per_word;</span><br><span class="line"></span><br><span class="line">            spi-&gt;bits_per_word = tmp;</span><br><span class="line">            retval = spi_setup(spi);</span><br><span class="line">            <span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">                spi-&gt;bits_per_word = save;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                dev_dbg(&amp;spi-&gt;dev, <span class="string">&quot;%d bits per word\n&quot;</span>, tmp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SPI_IOC_WR_MAX_SPEED_HZ:</span><br><span class="line">        retval = get_user(tmp, (__u32 __user *)arg);</span><br><span class="line">        <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">            u32	save = spi-&gt;max_speed_hz;</span><br><span class="line"></span><br><span class="line">            spi-&gt;max_speed_hz = tmp;</span><br><span class="line">            retval = spi_setup(spi);</span><br><span class="line">            <span class="keyword">if</span> (retval == <span class="number">0</span>) &#123;</span><br><span class="line">                spidev-&gt;speed_hz = tmp;</span><br><span class="line">                dev_dbg(&amp;spi-&gt;dev, <span class="string">&quot;%d Hz (max)\n&quot;</span>,</span><br><span class="line">                    spidev-&gt;speed_hz);</span><br><span class="line">            &#125;</span><br><span class="line">            spi-&gt;max_speed_hz = save;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">/* segmented and/or full-duplex I/O request */</span></span><br><span class="line">        <span class="comment">/* Check message and copy into scratch area */</span></span><br><span class="line">        ioc = spidev_get_ioc_message(cmd,</span><br><span class="line">                (<span class="keyword">struct</span> spi_ioc_transfer __user *)arg, &amp;n_ioc);</span><br><span class="line">        <span class="keyword">if</span> (IS_ERR(ioc)) &#123;</span><br><span class="line">            retval = PTR_ERR(ioc);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!ioc)</span><br><span class="line">            <span class="keyword">break</span>;	<span class="comment">/* n_ioc is also 0 */</span></span><br><span class="line">        <span class="comment">/* translate to spi_message, execute */</span></span><br><span class="line">        retval = spidev_message(spidev, ioc, n_ioc);</span><br><span class="line">        kfree(ioc);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;spidev-&gt;buf_lock);</span><br><span class="line">    spi_dev_put(spi);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png" alt="image"></p>
<p><img src="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png" alt="image"></p>
<p>这些SPI_IOC命令就是一些设置速率参数，spi模式啊，然后就可以通过read,write操作<code>/dev/spidev%d.%d</code>设备了。</p>
<h3><span id="1-3-4-shi-yong-spi-wan-neng-qu-dong-oled-ju-li">1.3.4 使用SPI万能驱动oled举例</span><a href="#1-3-4-shi-yong-spi-wan-neng-qu-dong-oled-ju-li" class="header-anchor">#</a></h3><h4><span id="1-3-4-1-spi-oled-yuan-li">1.3.4.1 spi oled原理</span><a href="#1-3-4-1-spi-oled-yuan-li" class="header-anchor">#</a></h4><p>见<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/04/18/s3c2440%E8%A3%B8%E6%9C%BA%E7%BC%96%E7%A8%8B-SPI/#3-spi-luo-ji-shi-li">SPI-OLED显示面板介绍</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/15668520.html">S3c2440裸机-spi编程-2.OLED显示面板 - fuzidage - 博客园 (cnblogs.com)</a> </p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/15697593.html">S3c2440裸机-spi编程-3.gpio模拟spi驱动OLED - fuzidage - 博客园 (cnblogs.com)</a>。</p>
<h4><span id="1-3-4-2-spi-oled-c">1.3.4.2 spi_oled.c</span><a href="#1-3-4-2-spi-oled-c" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spidev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;font.h&quot;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> fd_spidev;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> dc_pin_num;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Set_Pos</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">dc_pin_init</span><span class="params">(<span class="type">int</span> number)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// echo 509 &gt; /sys/class/gpio/export</span></span><br><span class="line">	<span class="comment">// echo out &gt; /sys/class/gpio/gpio509/direction	</span></span><br><span class="line">	<span class="type">char</span> cmd[<span class="number">100</span>];</span><br><span class="line">	dc_pin_num = number;</span><br><span class="line"> </span><br><span class="line">	<span class="built_in">sprintf</span>(cmd, <span class="string">&quot;echo %d &gt; /sys/class/gpio/export&quot;</span>, number);</span><br><span class="line">	system(cmd);</span><br><span class="line">	<span class="built_in">sprintf</span>(cmd, <span class="string">&quot;echo out &gt; /sys/class/gpio/gpio%d/direction&quot;</span>, number);</span><br><span class="line">	system(cmd);	</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">oled_set_dc_pin</span><span class="params">(<span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* echo 1 &gt; /sys/class/gpio/gpio509/value</span></span><br><span class="line"><span class="comment">	 * echo 0 &gt; /sys/class/gpio/gpio509/value</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">char</span> cmd[<span class="number">100</span>];</span><br><span class="line">	<span class="built_in">sprintf</span>(cmd, <span class="string">&quot;echo %d &gt; /sys/class/gpio/gpio%d/value&quot;</span>, val, dc_pin_num);</span><br><span class="line">	system(cmd);	</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">spi_write_datas</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	write(fd_spidev, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">oled_write_datas</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	oled_set_dc_pin(<span class="number">1</span>);<span class="comment">//拉高，表示写入数据</span></span><br><span class="line">	spi_write_datas(buf, len);</span><br><span class="line">&#125;</span><br><span class="line">  			 		  						  					  				 	   		  	  	 	  </span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">	 * 函数名称： oled_write_cmd</span></span><br><span class="line"><span class="comment">	 * 功能描述： oled向特定地址写入数据或者命令</span></span><br><span class="line"><span class="comment">	 * 输入参数：@uc_data :要写入的数据</span></span><br><span class="line"><span class="comment">	 			@uc_cmd:为1则表示写入数据，为0表示写入命令</span></span><br><span class="line"><span class="comment">	 * 输出参数：无</span></span><br><span class="line"><span class="comment">	 * 返 回 值： 无</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">oled_write_cmd_data</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> uc_data,<span class="type">unsigned</span> <span class="type">char</span> uc_cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> uc_read=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>(uc_cmd==<span class="number">0</span>)</span><br><span class="line">		oled_set_dc_pin(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		oled_set_dc_pin(<span class="number">1</span>);<span class="comment">//拉高，表示写入数据</span></span><br><span class="line"></span><br><span class="line">	spi_write_datas(&amp;uc_data, <span class="number">1</span>);<span class="comment">//写入</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">oled_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> uc_dev_id = <span class="number">0</span>;</span><br><span class="line">		  			 		  						  					  				 	   		  	  	 	  </span><br><span class="line">	oled_write_cmd_data(<span class="number">0xae</span>,OLED_CMD);<span class="comment">//关闭显示</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//设置 lower column address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x10</span>,OLED_CMD);<span class="comment">//设置 higher column address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x40</span>,OLED_CMD);<span class="comment">//设置 display start line</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xB0</span>,OLED_CMD);<span class="comment">//设置page address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x81</span>,OLED_CMD);<span class="comment">// contract control</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x66</span>,OLED_CMD);<span class="comment">//128</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa1</span>,OLED_CMD);<span class="comment">//设置 segment remap</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa6</span>,OLED_CMD);<span class="comment">//normal /reverse</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa8</span>,OLED_CMD);<span class="comment">//multiple ratio</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x3f</span>,OLED_CMD);<span class="comment">//duty = 1/64</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xc8</span>,OLED_CMD);<span class="comment">//com scan direction</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd3</span>,OLED_CMD);<span class="comment">//set displat offset</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd5</span>,OLED_CMD);<span class="comment">//set osc division</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x80</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd9</span>,OLED_CMD);<span class="comment">//ser pre-charge period</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x1f</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xda</span>,OLED_CMD);<span class="comment">//set com pins</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x12</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xdb</span>,OLED_CMD);<span class="comment">//set vcomh</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x30</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x8d</span>,OLED_CMD);<span class="comment">//set charge pump disable </span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x14</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xaf</span>,OLED_CMD);<span class="comment">//set dispkay on</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;		  			 		  						  					  				 	   		  	  	 	  </span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">	 * 函数名称： oled_fill_data</span></span><br><span class="line"><span class="comment">	 * 功能描述： 整个屏幕显示填充某个固定数据</span></span><br><span class="line"><span class="comment">	 * 输入参数：@fill_Data：要填充的数据</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">oled_fill_data</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> fill_Data)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> x,y;</span><br><span class="line">	<span class="keyword">for</span>(x=<span class="number">0</span>;x&lt;<span class="number">8</span>;x++) &#123;</span><br><span class="line">		oled_write_cmd_data(<span class="number">0xb0</span>+x,OLED_CMD);		<span class="comment">//page0-page1</span></span><br><span class="line">		oled_write_cmd_data(<span class="number">0x00</span>,OLED_CMD);		<span class="comment">//low column start address</span></span><br><span class="line">		oled_write_cmd_data(<span class="number">0x10</span>,OLED_CMD);		<span class="comment">//high column start address	</span></span><br><span class="line">		<span class="keyword">for</span>(y=<span class="number">0</span>;y&lt;<span class="number">128</span>;y++)</span><br><span class="line">			oled_write_cmd_data(fill_Data,OLED_DATA);<span class="comment">//填充数据				</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Clear</span><span class="params">(<span class="type">void</span>)</span>  </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x, y;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; <span class="number">8</span>; y++) &#123;</span><br><span class="line">        OLED_DIsp_Set_Pos(<span class="number">0</span>, y);</span><br><span class="line">        <span class="comment">//for (x = 0; x &lt; 128; x++)</span></span><br><span class="line">        <span class="comment">//    oled_write_cmd_data(0, OLED_DATA); /* 清零 */</span></span><br><span class="line">        oled_write_datas(buf, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">	 * 函数名称： OLED_DIsp_All</span></span><br><span class="line"><span class="comment">	 * 功能描述： 整个屏幕显示全部点亮，可以用于检查坏点</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_All</span><span class="params">(<span class="type">void</span>)</span>  </span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> x, y;</span><br><span class="line">	<span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; <span class="number">8</span>; y++)</span><br><span class="line">	&#123;</span><br><span class="line">		OLED_DIsp_Set_Pos(<span class="number">0</span>, y);</span><br><span class="line">		<span class="keyword">for</span> (x = <span class="number">0</span>; x &lt; <span class="number">128</span>; x++)</span><br><span class="line">			oled_write_cmd_data(<span class="number">0xff</span>, OLED_DATA); <span class="comment">/* 全点亮 */</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//坐标设置</span></span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment">	 * 函数名称： OLED_DIsp_Set_Pos</span></span><br><span class="line"><span class="comment">	 * 功能描述：设置要显示的位置</span></span><br><span class="line"><span class="comment">	 * 输入参数：@ x ：要显示的column address</span></span><br><span class="line"><span class="comment">	 			@y :要显示的page address</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Set_Pos</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123; 	oled_write_cmd_data(<span class="number">0xb0</span>+y,OLED_CMD);</span><br><span class="line">	oled_write_cmd_data((x&amp;<span class="number">0x0f</span>),OLED_CMD); </span><br><span class="line">	oled_write_cmd_data(((x&amp;<span class="number">0xf0</span>)&gt;&gt;<span class="number">4</span>)|<span class="number">0x10</span>,OLED_CMD);</span><br><span class="line">&#125;   	      	   			 </span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Char</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">char</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* 得到字模 */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *dots = oled_asc2_8x16[c - <span class="string">&#x27; &#x27;</span>];</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* 发给OLED */</span></span><br><span class="line">	OLED_DIsp_Set_Pos(x, y);</span><br><span class="line">	<span class="comment">/* 发出8字节数据 */</span></span><br><span class="line">	<span class="comment">//for (i = 0; i &lt; 8; i++)</span></span><br><span class="line">	<span class="comment">//	oled_write_cmd_data(dots[i], OLED_DATA);</span></span><br><span class="line">	oled_write_datas(&amp;dots[<span class="number">0</span>], <span class="number">8</span>);</span><br><span class="line"> </span><br><span class="line">	OLED_DIsp_Set_Pos(x, y+<span class="number">1</span>);</span><br><span class="line">	<span class="comment">/* 发出8字节数据 */</span></span><br><span class="line">	<span class="comment">//for (i = 0; i &lt; 8; i++)</span></span><br><span class="line">		<span class="comment">//oled_write_cmd_data(dots[i+8], OLED_DATA);</span></span><br><span class="line">	oled_write_datas(&amp;dots[<span class="number">8</span>], <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_String</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> j=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (str[j])&#123;		</span><br><span class="line">		OLED_DIsp_Char(x, y, str[j]);<span class="comment">//显示单个字符</span></span><br><span class="line">		x += <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">if</span>(x &gt; <span class="number">127</span>)&#123;</span><br><span class="line">			x = <span class="number">0</span>;</span><br><span class="line">			y += <span class="number">2</span>;</span><br><span class="line">		&#125;<span class="comment">//移动显示位置</span></span><br><span class="line">		j++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123; 	</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	OLED_DIsp_String(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;wiki.100ask.net&quot;</span>);</span><br><span class="line">	OLED_DIsp_String(<span class="number">0</span>, <span class="number">2</span>, <span class="string">&quot;book.100ask.net&quot;</span>);</span><br><span class="line">	OLED_DIsp_String(<span class="number">0</span>, <span class="number">4</span>, <span class="string">&quot;bbs.100ask.net&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* spi_oled /dev/spidevB.D &lt;DC_pin_number&gt; */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> dc_pin;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">3</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;dev/spidevB.D&gt; &lt;DC_pin_number&gt;\n&quot;</span>, argv[<span class="number">0</span>]);<span class="comment">//B表示spi bus, D表示cs片选</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	fd_spidev = open(argv[<span class="number">1</span>], O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd_spidev &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open %s err\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	dc_pin = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">	dc_pin_init(dc_pin);</span><br><span class="line"> </span><br><span class="line">	oled_init();</span><br><span class="line">	OLED_DIsp_Clear();</span><br><span class="line">	OLED_DIsp_Test();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5><span id="1-3-4-2-1-yong-hu-tai-qu-dong-fen-xi">1.3.4.2.1 用户态驱动分析</span><a href="#1-3-4-2-1-yong-hu-tai-qu-dong-fen-xi" class="header-anchor">#</a></h5><p>有了spidev.c万能SPI从设备驱动，就不需要去写spi从设备驱动了，直接用户态去读写spidev即可。</p>
<ol>
<li><code>open(&quot;/dev/spi%d.%d&quot;, O_RDWR);</code>&#x2F;&#x2F;根据自己外设使用的spi bus和cs片选去设置</li>
<li>对外设oled进行初始化<code>D/C（data or cmd ）引脚</code>, 利用gpio子系统的命令去设置gpio模式为输出。</li>
<li>利用spi协议发送初始化序列：<ol>
<li><code>spi_write_datas</code>就是操作<code>spidev</code>，write数据到底层<code>spidev</code>，再调用对应的fops中的<code>spidev_write</code>，最终调用<code>spi_sync</code>传输数据。这里是每次传输1byte，把初始化序列利用spi协议写完。</li>
</ol>
</li>
<li>清屏并且测试<code>oled</code>显示字符。</li>
</ol>
<h3><span id="1-3-5-bu-shi-yong-spi-wan-neng-qu-dong-oled-ju-li">1.3.5 不使用SPI万能驱动oled举例</span><a href="#1-3-5-bu-shi-yong-spi-wan-neng-qu-dong-oled-ju-li" class="header-anchor">#</a></h3><h4><span id="1-3-5-1-dts-miao-shu">1.3.5.1 dts描述</span><a href="#1-3-5-1-dts-miao-shu" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&amp;ecspi1 &#123;</span><br><span class="line">    pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">    pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_ecspi1&gt;;</span><br><span class="line">    fsl,spi-num-chipselects = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    cs-gpios = &lt;&amp;gpio4 <span class="number">26</span> GPIO_ACTIVE_LOW&gt;, &lt;&amp;gpio4 <span class="number">24</span> GPIO_ACTIVE_LOW&gt;;</span><br><span class="line">    status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line"> </span><br><span class="line">    oled: oled &#123;</span><br><span class="line">        compatible = <span class="string">&quot;100ask,oled&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        spi-max-frequency = &lt;<span class="number">10000000</span>&gt;;</span><br><span class="line">        dc-gpios = &lt;&amp;gpio4 <span class="number">20</span> GPIO_ACTIVE_HIGH&gt;; </span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>spi1</code>下接了一个<code>spi oled</code>，修改对应dts文件，修改<code>ecspi1</code>节点，添加oled子节点。oled有一个<code>dc引脚</code>，叫做<code>data/cmd</code>引脚，选择是发送数据还是命令。参考spi oled原理。</p>
<h4><span id="1-3-5-2-oled-drv-c">1.3.5.2 oled_drv.c</span><a href="#1-3-5-2-oled-drv-c" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/err.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/mutex.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/compat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/of_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/acpi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spidev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio/consumer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_IOC_INIT 			123</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_IOC_SET_POS 		124</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//为0 表示命令，为1表示数据</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_CMD 	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_DATA 	1</span></span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">oled</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> major;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span> *<span class="title">dc_gpio</span>;</span></span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dc_pin_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	gpiod_direction_output(dc_gpio, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">oled_set_dc_pin</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">	gpiod_set_value(dc_gpio, val);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">spi_write_datas</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">	spi_write(oled, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">oled_write_cmd_data</span><span class="params">(<span class="type">unsigned</span> <span class="type">char</span> uc_data,<span class="type">unsigned</span> <span class="type">char</span> uc_cmd)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span>(uc_cmd==<span class="number">0</span>)</span><br><span class="line">		oled_set_dc_pin(<span class="number">0</span>);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		oled_set_dc_pin(<span class="number">1</span>);<span class="comment">//拉高，表示写入数据</span></span><br><span class="line"></span><br><span class="line">	spi_write_datas(&amp;uc_data, <span class="number">1</span>);<span class="comment">//写入</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">oled_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	oled_write_cmd_data(<span class="number">0xae</span>,OLED_CMD);<span class="comment">//关闭显示</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//设置 lower column address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x10</span>,OLED_CMD);<span class="comment">//设置 higher column address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x40</span>,OLED_CMD);<span class="comment">//设置 display start line</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xB0</span>,OLED_CMD);<span class="comment">//设置page address</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x81</span>,OLED_CMD);<span class="comment">// contract control</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x66</span>,OLED_CMD);<span class="comment">//128</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa1</span>,OLED_CMD);<span class="comment">//设置 segment remap</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa6</span>,OLED_CMD);<span class="comment">//normal /reverse</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xa8</span>,OLED_CMD);<span class="comment">//multiple ratio</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x3f</span>,OLED_CMD);<span class="comment">//duty = 1/64</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xc8</span>,OLED_CMD);<span class="comment">//com scan direction</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd3</span>,OLED_CMD);<span class="comment">//set displat offset</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x00</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd5</span>,OLED_CMD);<span class="comment">//set osc division</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x80</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xd9</span>,OLED_CMD);<span class="comment">//ser pre-charge period</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x1f</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xda</span>,OLED_CMD);<span class="comment">//set com pins</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x12</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xdb</span>,OLED_CMD);<span class="comment">//set vcomh</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x30</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x8d</span>,OLED_CMD);<span class="comment">//set charge pump disable </span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0x14</span>,OLED_CMD);<span class="comment">//</span></span><br><span class="line">	oled_write_cmd_data(<span class="number">0xaf</span>,OLED_CMD);<span class="comment">//set dispkay on</span></span><br><span class="line"> </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;		  			 		  						  					  				 	   		  	  	 	  </span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">OLED_DIsp_Set_Pos</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123; 	oled_write_cmd_data(<span class="number">0xb0</span>+y,OLED_CMD);</span><br><span class="line">	oled_write_cmd_data((x&amp;<span class="number">0x0f</span>),OLED_CMD); </span><br><span class="line">	oled_write_cmd_data(((x&amp;<span class="number">0xf0</span>)&gt;&gt;<span class="number">4</span>)|<span class="number">0x10</span>,OLED_CMD);</span><br><span class="line">&#125;   	      	   			 </span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">spidev_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> &#123;</span><br><span class="line">	<span class="type">int</span> x, y;</span><br><span class="line">	<span class="comment">/* 根据cmd操作硬件 */</span></span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">		<span class="keyword">case</span> OLED_IOC_INIT: <span class="comment">/* init */</span></span><br><span class="line">		&#123;</span><br><span class="line">			dc_pin_init();</span><br><span class="line">			oled_init();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">case</span> OLED_IOC_SET_POS: <span class="comment">/* set pos */</span></span><br><span class="line">		&#123;</span><br><span class="line">			x = arg &amp; <span class="number">0xff</span>;</span><br><span class="line">			y = (arg &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">			OLED_DIsp_Set_Pos(x, y);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">spidev_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">const</span> <span class="type">char</span> __user *buf, <span class="type">size_t</span> count, <span class="type">loff_t</span> *f_pos)</span> &#123;</span><br><span class="line">	<span class="type">char</span> *ker_buf;</span><br><span class="line">	<span class="type">int</span> err;</span><br><span class="line">	ker_buf = kmalloc(count, GFP_KERNEL);</span><br><span class="line">	err = copy_from_user(ker_buf, buf, count);</span><br><span class="line">	oled_set_dc_pin(<span class="number">1</span>);<span class="comment">//拉高，表示写入数据</span></span><br><span class="line">	spi_write_datas(ker_buf, count);</span><br><span class="line">	kfree(ker_buf);</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">spidev_fops</span> =</span> &#123;</span><br><span class="line">	.owner =	THIS_MODULE,</span><br><span class="line">	.write =	spidev_write,</span><br><span class="line">	.unlocked_ioctl = spidev_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="keyword">class</span> *<span class="title">spidev_class</span>;</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">spidev_dt_ids</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;100ask,oled&quot;</span> &#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spidev_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line">	oled = spi;</span><br><span class="line"> </span><br><span class="line">	major = register_chrdev(<span class="number">0</span>, <span class="string">&quot;100ask_oled&quot;</span>, &amp;spidev_fops);</span><br><span class="line">	spidev_class = class_create(THIS_MODULE, <span class="string">&quot;100ask_oled&quot;</span>);</span><br><span class="line">	device_create(spidev_class, <span class="literal">NULL</span>, MKDEV(major, <span class="number">0</span>), <span class="literal">NULL</span>, <span class="string">&quot;100ask_oled&quot;</span>);	</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* 3. 获得GPIO引脚 */</span></span><br><span class="line">	dc_gpio = gpiod_get(&amp;spi-&gt;dev, <span class="string">&quot;dc&quot;</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">spidev_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span> &#123;</span><br><span class="line">	gpiod_put(dc_gpio);</span><br><span class="line">	device_destroy(spidev_class, MKDEV(major, <span class="number">0</span>));</span><br><span class="line">	class_destroy(spidev_class);</span><br><span class="line">	unregister_chrdev(major, <span class="string">&quot;cumtchw_oled&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">spidev_spi_driver</span> =</span> &#123;</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name =		<span class="string">&quot;cumtchw_spi_oled_drv&quot;</span>,</span><br><span class="line">		.of_match_table = of_match_ptr(spidev_dt_ids),</span><br><span class="line">	&#125;,</span><br><span class="line">	.probe =	spidev_probe,</span><br><span class="line">	.remove =	spidev_remove,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">spidev_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="type">int</span> status;</span><br><span class="line">	status = spi_register_driver(&amp;spidev_spi_driver);</span><br><span class="line">	<span class="keyword">if</span> (status &lt; <span class="number">0</span>) &#123;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">spidev_exit</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">	spi_unregister_driver(&amp;spidev_spi_driver);</span><br><span class="line">&#125;</span><br><span class="line">module_init(spidev_init);</span><br><span class="line">module_exit(spidev_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5><span id="1-3-5-2-1-qu-dong-fen-xi">1.3.5.2.1 驱动分析</span><a href="#1-3-5-2-1-qu-dong-fen-xi" class="header-anchor">#</a></h5><ol>
<li>调用<code>spi_register_driver</code>注册SPI从设备驱动，probe函数中利用标准字符设备驱动框架编写的驱动，注册字符设备，添加类。</li>
<li>当用户调用<code>open(&quot;/dev/100ask_oled&quot;)</code>后，就可以调用read,write函数读写oled。<ol>
<li>spidev_ioctl提供了2个ioctl命令，用来初始化oled和设置坐标位置。用<code>spi_write_datas</code>写入初始化序列，每次写1byte。</li>
<li><code>spi_write_datas</code>调用标准的SPI从设备驱动API(<code>spi_write</code>)传输数据。</li>
</ol>
</li>
<li>spi oled初始化完后就可以使用另一个<code>OLED_IOC_SET_POS</code> ioctl命令设置坐标位置。</li>
<li>调用spidev_write写入数据。</li>
</ol>
<h4><span id="1-3-5-3-spi-oled-c-ying-yong-ce-shi">1.3.5.3 spi_oled.c应用测试</span><a href="#1-3-5-3-spi-oled-c-ying-yong-ce-shi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spidev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;font.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_IOC_INIT 			123</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_IOC_SET_POS 		124</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//为0 表示命令，为1表示数据</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_CMD 	0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OLED_DATA 	1</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> fd_spidev;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> dc_pin_num;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Set_Pos</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">oled_write_datas</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	write(fd_spidev, buf, len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Clear</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x, y;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; <span class="number">8</span>; y++) &#123;</span><br><span class="line">        OLED_DIsp_Set_Pos(<span class="number">0</span>, y);</span><br><span class="line">        oled_write_datas(buf, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_All</span><span class="params">(<span class="type">void</span>)</span>  &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> x, y;</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">128</span>];</span><br><span class="line">	<span class="built_in">memset</span>(buf, <span class="number">0xff</span>, <span class="number">128</span>);</span><br><span class="line">    <span class="keyword">for</span> (y = <span class="number">0</span>; y &lt; <span class="number">8</span>; y++) &#123;</span><br><span class="line">        OLED_DIsp_Set_Pos(<span class="number">0</span>, y);</span><br><span class="line">        oled_write_datas(buf, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Set_Pos</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123; 	</span><br><span class="line">	ioctl(fd_spidev, OLED_IOC_SET_POS, x  | (y &lt;&lt; <span class="number">8</span>));</span><br><span class="line">&#125;   	      	   			 </span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Char</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">char</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">/* 得到字模 */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *dots = oled_asc2_8x16[c - <span class="string">&#x27; &#x27;</span>];</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/* 发给OLED */</span></span><br><span class="line">	OLED_DIsp_Set_Pos(x, y);</span><br><span class="line">	<span class="comment">/* 发出8字节数据 */</span></span><br><span class="line">	<span class="comment">//for (i = 0; i &lt; 8; i++)</span></span><br><span class="line">	<span class="comment">//	oled_write_cmd_data(dots[i], OLED_DATA);</span></span><br><span class="line">	oled_write_datas(&amp;dots[<span class="number">0</span>], <span class="number">8</span>);</span><br><span class="line"> </span><br><span class="line">	OLED_DIsp_Set_Pos(x, y+<span class="number">1</span>);</span><br><span class="line">	<span class="comment">/* 发出8字节数据 */</span></span><br><span class="line">	<span class="comment">//for (i = 0; i &lt; 8; i++)</span></span><br><span class="line">		<span class="comment">//oled_write_cmd_data(dots[i+8], OLED_DATA);</span></span><br><span class="line">	oled_write_datas(&amp;dots[<span class="number">8</span>], <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_String</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> j=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (str[j]) &#123;		</span><br><span class="line">		OLED_DIsp_Char(x, y, str[j]);<span class="comment">//显示单个字符</span></span><br><span class="line">		x += <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">if</span>(x &gt; <span class="number">127</span>) &#123;</span><br><span class="line">			x = <span class="number">0</span>;</span><br><span class="line">			y += <span class="number">2</span>;</span><br><span class="line">		&#125;<span class="comment">//移动显示位置</span></span><br><span class="line">		j++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">OLED_DIsp_Test</span><span class="params">(<span class="type">void</span>)</span> &#123; 	</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	OLED_DIsp_String(<span class="number">0</span>, <span class="number">0</span>, <span class="string">&quot;100ask test&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;	</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s /dev/cumtchw_oled\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	fd_spidev = open(argv[<span class="number">1</span>], O_RDWR);</span><br><span class="line">	<span class="keyword">if</span> (fd_spidev &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;open %s err\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ioctl(fd_spidev, OLED_IOC_INIT);</span><br><span class="line">	OLED_DIsp_Clear();</span><br><span class="line">	OLED_DIsp_Test();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1><span id="2-shu-ju-jie-gou">2 数据结构</span><a href="#2-shu-ju-jie-gou" class="header-anchor">#</a></h1><h2><span id="2-1-spi-master-x2f-spi-controller">2.1 spi_master&#x2F;spi_controller</span><a href="#2-1-spi-master-x2f-spi-controller" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_master</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>	<span class="title">dev</span>;</span>	<span class="comment">/* SPI设备的device数据结构 */</span></span><br><span class="line">	s16			bus_num;		<span class="comment">/* SPI总线序号 */</span></span><br><span class="line">	u16			num_chipselect;	<span class="comment">/* 片选信号数量 */</span></span><br><span class="line">	u16			dma_alignment;	<span class="comment">/* SPI控制器DMA缓冲区对齐定义 */</span></span><br><span class="line">	u16			mode_bits;		<span class="comment">/* 工作模式位，由驱动定义 */</span></span><br><span class="line">	u32			min_speed_hz;	<span class="comment">/* 最小速度 */</span></span><br><span class="line">	u32			max_speed_hz;	<span class="comment">/* 最小速度 */</span></span><br><span class="line">	u16			flags;			<span class="comment">/* 限制条件标志 */</span></span><br><span class="line">	<span class="type">int</span>			(*setup)(<span class="keyword">struct</span> spi_device *spi);   <span class="comment">/* 设置SPI设备的工作参数 */</span></span><br><span class="line">	<span class="type">int</span>			(*transfer)(<span class="keyword">struct</span> spi_device *spi,	<span class="comment">/* SPI发送函数1 */</span></span><br><span class="line">						<span class="keyword">struct</span> spi_message *mesg);</span><br><span class="line">	<span class="type">void</span>		(*cleanup)(<span class="keyword">struct</span> spi_device *spi);	<span class="comment">/* SPI清除函数，当spi_master被释放时调用 */</span></span><br><span class="line">	<span class="type">int</span> (*transfer_one_message)(<span class="keyword">struct</span> spi_master *master,	<span class="comment">/* SPI发送函数2 */</span></span><br><span class="line">	<span class="type">int</span> (*transfer_one)(<span class="keyword">struct</span> spi_master *master, <span class="keyword">struct</span> spi_device *spi,<span class="comment">/* SPI发送函数3 */</span></span><br><span class="line">			    <span class="keyword">struct</span> spi_transfer *transfer);</span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>struct <code>spi_master</code>描述一个spi控制器，包扩spi控制器的属性描述信息，spi的一些操作回调函数，如<code>transfer</code>，<code>setup</code>。</p>
<h2><span id="2-2-spi-driver">2.2 spi_driver</span><a href="#2-2-spi-driver" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> *<span class="title">id_table</span>;</span></span><br><span class="line">	<span class="type">int</span>			(*probe)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line">	<span class="type">int</span>			(*remove)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line">	<span class="type">void</span>			(*shutdown)(<span class="keyword">struct</span> spi_device *spi);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_driver</span>	<span class="title">driver</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>用来描述一个spi从设备驱动。用来和spi从设备匹配。</p>
<h2><span id="2-3-spi-device">2.3 spi_device</span><a href="#2-3-spi-device" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span>		<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_controller</span>	*<span class="title">controller</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_controller</span>	*<span class="title">master</span>;</span>	<span class="comment">/* compatibility layer */</span></span><br><span class="line">	u32			max_speed_hz;</span><br><span class="line">	u8			chip_select;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_CPHA	0x01			<span class="comment">/* clock phase */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_CPOL	0x02			<span class="comment">/* clock polarity */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_MODE_0	(0|0)			<span class="comment">/* (original MicroWire) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_MODE_1	(0|SPI_CPHA)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_MODE_2	(SPI_CPOL|0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_MODE_3	(SPI_CPOL|SPI_CPHA)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_CS_HIGH	0x04			<span class="comment">/* chipselect active high? */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_LSB_FIRST	0x08			<span class="comment">/* per-word bits-on-wire */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_3WIRE	0x10			<span class="comment">/* SI/SO signals shared */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_LOOP	0x20			<span class="comment">/* loopback mode */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_NO_CS	0x40			<span class="comment">/* 1 dev/bus, no chipselect */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_READY	0x80			<span class="comment">/* slave pulls low to pause */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_TX_DUAL	0x100			<span class="comment">/* transmit with 2 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_TX_QUAD	0x200			<span class="comment">/* transmit with 4 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_RX_DUAL	0x400			<span class="comment">/* receive with 2 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_RX_QUAD	0x800			<span class="comment">/* receive with 4 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_CS_WORD	0x1000			<span class="comment">/* toggle cs after each word */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_TX_OCTAL	0x2000			<span class="comment">/* transmit with 8 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_RX_OCTAL	0x4000			<span class="comment">/* receive with 8 wires */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SPI_3WIRE_HIZ	0x8000			<span class="comment">/* high impedance turnaround */</span></span></span><br><span class="line">	<span class="type">int</span>			irq;</span><br><span class="line">	<span class="type">void</span>			*controller_state;</span><br><span class="line">	<span class="type">void</span>			*controller_data;</span><br><span class="line">	<span class="type">char</span>			modalias[SPI_NAME_SIZE];</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*driver_override;</span><br><span class="line">	<span class="type">int</span>			cs_gpio;	<span class="comment">/* LEGACY: chip select gpio */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gpio_desc</span>	*<span class="title">cs_gpiod</span>;</span>	<span class="comment">/* chip select gpio desc */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_delay</span>	<span class="title">word_delay</span>;</span> <span class="comment">/* inter-word delay */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>用来描述一个spi从设备。用来和spi从设备驱动匹配。</p>
<h2><span id="2-4-spi-message-x2f-spi-transfer">2.4 spi_message&#x2F;spi_transfer</span><a href="#2-4-spi-message-x2f-spi-transfer" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_transfer</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">void</span>	*tx_buf;</span><br><span class="line">	<span class="type">void</span>		*rx_buf;</span><br><span class="line">	<span class="type">unsigned</span>	len;</span><br><span class="line">	...</span><br><span class="line">	u8		bits_per_word;</span><br><span class="line">	u16		delay_usecs;</span><br><span class="line">	u32		speed_hz;</span><br><span class="line">	...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">transfer_list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spi_message</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">transfers</span>;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span>	*<span class="title">spi</span>;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="type">void</span>			(*complete)(<span class="type">void</span> *context);</span><br><span class="line">	<span class="type">void</span>			*context;</span><br><span class="line">	...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">queue</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>spi_message</code>是发起一次数据传输，里面的<code>transfers</code>构成基本输入输出数据，通过<code>spi_sync</code>函数或<code>spi_async</code>函数发送。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/" data-id="cm0xxogea004fqsuf1zlc0eh5" data-title="字符设备驱动-SPI子系统" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          字符设备驱动-input子系统
        
      </div>
    </a>
  
  
    <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">字符设备驱动-I2C子系统</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 14.55px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-PWM%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-PWM子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-input%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-input子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-SPI%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-SPI子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/25/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-I2C%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-I2C子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
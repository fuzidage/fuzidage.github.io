<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>字符设备驱动-IIO子系统 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 引入IIO 子系统 2 IIO 子系统驱动框架 3 数据结构 3.1 iio_dev-iio设备 3.1.1 iio_buffer_setup_ops   3.2 iio_info-属性和函数实现 3.3 iio_chan_spec-通道属性 3.4 iio_trigger-触发数据采集 3.4.1 iio_trigger_ops   3.5 iio_buffer-保存采集到的数据">
<meta property="og:type" content="article">
<meta property="og:title" content="字符设备驱动-IIO子系统">
<meta property="og:url" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 引入IIO 子系统 2 IIO 子系统驱动框架 3 数据结构 3.1 iio_dev-iio设备 3.1.1 iio_buffer_setup_ops   3.2 iio_info-属性和函数实现 3.3 iio_chan_spec-通道属性 3.4 iio_trigger-触发数据采集 3.4.1 iio_trigger_ops   3.5 iio_buffer-保存采集到的数据">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png">
<meta property="og:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/33.png">
<meta property="article:published_time" content="2024-09-22T07:59:20.000Z">
<meta property="article:modified_time" content="2024-09-22T08:56:15.912Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Linux设备驱动">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-字符设备驱动-IIO子系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2024-09-22T07:59:20.000Z" itemprop="datePublished">2024-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      字符设备驱动-IIO子系统
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-yin-ru-iio-zi-xi-tong">1 引入IIO 子系统</a></li>
<li><a href="#2-iio-zi-xi-tong-qu-dong-kuang-jia">2 IIO 子系统驱动框架</a></li>
<li><a href="#3-shu-ju-jie-gou">3 数据结构</a><ul>
<li><a href="#3-1-iio-dev-iio-she-bei">3.1 iio_dev-iio设备</a><ul>
<li><a href="#3-1-1-iio-buffer-setup-ops">3.1.1 iio_buffer_setup_ops</a></li>
</ul>
</li>
<li><a href="#3-2-iio-info-shu-xing-he-han-shu-shi-xian">3.2 iio_info-属性和函数实现</a></li>
<li><a href="#3-3-iio-chan-spec-tong-dao-shu-xing">3.3 iio_chan_spec-通道属性</a></li>
<li><a href="#3-4-iio-trigger-hong-fa-shu-ju-cai-ji">3.4 iio_trigger-触发数据采集</a><ul>
<li><a href="#3-4-1-iio-trigger-ops">3.4.1 iio_trigger_ops</a></li>
</ul>
</li>
<li><a href="#3-5-iio-buffer-bao-cun-cai-ji-dao-de-shu-ju">3.5 iio_buffer-保存采集到的数据</a></li>
</ul>
</li>
<li><a href="#4-api">4 API</a><ul>
<li><a href="#4-1-iio-dev-zhu-ce-yu-zhu-xiao">4.1 iio_dev 注册与注销</a><ul>
<li><a href="#4-1-1-iio-device-register-sysfs-guo-cheng">4.1.1 <code>iio_device_register_sysfs</code>过程</a></li>
</ul>
</li>
<li><a href="#4-2-iio-init-zi-xi-tong-de-chu-shi-hua">4.2 iio_init-子系统的初始化</a></li>
</ul>
</li>
<li><a href="#5-iio-shi-yan-cao-zuo-icm20608">5 iio实验-操作ICM20608</a><ul>
<li><a href="#5-1-shi-neng-nei-he-iio">5.1 使能内核 IIO</a></li>
<li><a href="#5-2-qu-dong-dai-ma-fen-xi">5.2 驱动代码分析</a><ul>
<li><a href="#5-2-0-yuan-ma">5.2.0 源码</a></li>
<li><a href="#5-2-1-probe">5.2.1 probe</a></li>
<li><a href="#5-2-2-icm20608-read-raw">5.2.2 icm20608_read_raw</a><ul>
<li><a href="#5-2-2-1-du-raw-shu-ju">5.2.2.1 读raw数据</a></li>
<li><a href="#5-2-2-2-du-liang-cheng">5.2.2.2 读量程</a></li>
<li><a href="#5-2-2-3-du-offset">5.2.2.3 读offset</a></li>
</ul>
</li>
<li><a href="#5-2-3-icm20608-write-raw">5.2.3 icm20608_write_raw</a><ul>
<li><a href="#5-2-3-1-pei-zhi-liang-cheng">5.2.3.1 配置量程</a></li>
<li><a href="#5-2-3-2-pei-zhi-xiao-zhun-zhi">5.2.3.2 配置校准值</a></li>
</ul>
</li>
<li><a href="#5-2-4-icm20608-write-raw-get-fmt">5.2.4 icm20608_write_raw_get_fmt</a></li>
</ul>
</li>
<li><a href="#5-3-ce-shi">5.3 测试</a><ul>
<li><a href="#5-3-1-tong-dao-wen-jian-ming-ming-fang-shi">5.3.1 通道文件命名方式</a></li>
<li><a href="#5-3-2-du-qu-raw-shu-ju">5.3.2 读取raw数据</a></li>
<li><a href="#5-3-3-bian-xie-ying-yong-cheng-xu-ce-shi">5.3.3 编写应用程序测试</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#6-iio-shi-yan-cao-zuo-vf610-adc-c">6 IIO实验-操作vf610_adc.c</a><ul>
<li><a href="#6-1-dts-miao-shu">6.1 dts描述</a></li>
<li><a href="#6-2-shi-neng-adc-qu-dong">6.2 使能 ADC 驱动</a></li>
<li><a href="#6-3-qu-dong-dai-ma-fen-xi">6.3 驱动代码分析</a><ul>
<li><a href="#6-3-1-probe">6.3.1 probe</a></li>
<li><a href="#6-3-2-vf610-read-raw">6.3.2 vf610_read_raw</a></li>
</ul>
</li>
<li><a href="#6-4-yong-hu-tai-ce-shi">6.4 用户态测试</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-yin-ru-iio-zi-xi-tong">1 引入IIO 子系统</span><a href="#1-yin-ru-iio-zi-xi-tong" class="header-anchor">#</a></h1><p>随着手机、物联网、工业物联网和可穿戴设备的爆发，传感器的需求越来越多。比如手机或者手环里面的加速度计、光传感器、陀螺仪、气压计、磁力计等，这些传感器本质上都是 ADC。这些传感器对外通过 IIC 或者 SPI 接口来发送ADC转换后的原始数据。</p>
<p>Linux 内核为了管理这些日益增多的 ADC 类传感器，特地推出了 IIO 子系统。</p>
<p><code>IIO </code>全称是<code> Industrial I/O</code>，翻译过来就是工业 I&#x2F;O，常用的陀螺仪、加速度计、电压&#x2F;电流测量芯片、光照传感器、压力传感器等内部都是有个 ADC，内部 ADC 将原始的 模拟数据转换为数字量，然后通过其他的通信接口，比如 IIC、SPI 等传输给 SOC。</p>
<p>因此，当使用的传感器本质是 ADC器件的时候，可以优先考虑使用 IIO 驱动框架。</p>
<h1><span id="2-iio-zi-xi-tong-qu-dong-kuang-jia">2 IIO 子系统驱动框架</span><a href="#2-iio-zi-xi-tong-qu-dong-kuang-jia" class="header-anchor">#</a></h1><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/1.png" alt="image"></p>
<ul>
<li><strong>IIO sysfs</strong>对用户空间提供IIO设备访问和配置。</li>
<li><strong>IIO Core</strong>提供IIO设备、<code>IIO Trigger、IIO Buffer</code>分配、初始化、注册等工作。<ul>
<li><code>industrialio-core.c</code></li>
<li><code>industrialio-buffer.c</code></li>
<li><code>industrialio-event.c</code></li>
</ul>
</li>
<li><strong>IIO Driver</strong>不同IIO设备的驱动程序。</li>
</ul>
<h1><span id="3-shu-ju-jie-gou">3 数据结构</span><a href="#3-shu-ju-jie-gou" class="header-anchor">#</a></h1><h2><span id="3-1-iio-dev-iio-she-bei">3.1 iio_dev-iio设备</span><a href="#3-1-iio-dev-iio-she-bei" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_dev</span> &#123;</span></span><br><span class="line">      <span class="type">int</span> id;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">module</span>                   *<span class="title">driver_module</span>;</span></span><br><span class="line">      <span class="type">int</span> modes;<span class="comment">//设备支持的模式</span></span><br><span class="line">      <span class="type">int</span> currentmode;<span class="comment">//表示设备当前模式</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">device</span>                   <span class="title">dev</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_event_interface</span>      *<span class="title">event_interface</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_buffer</span>               *<span class="title">buffer</span>;</span><span class="comment">//缓冲区</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>                <span class="title">buffer_list</span>;</span><span class="comment">//当前匹配的缓冲区列表</span></span><br><span class="line">      <span class="type">int</span> scan_bytes; <span class="comment">//捕获到，并且提供给缓冲区的字节数</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>                    <span class="title">mlock</span>;</span></span><br><span class="line">      <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span>             *available_scan_masks;<span class="comment">//扫描位掩码，使用触发缓冲区的时候可以通过</span></span><br><span class="line"><span class="comment">//设置掩码来确定使能哪些通道，使能以后的通道会将捕获到的数据发送到 IIO 缓冲区</span></span><br><span class="line">      <span class="type">unsigned</span> masklength;</span><br><span class="line">      <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span>             *active_scan_mask;<span class="comment">//缓冲区已经开启的通道掩码</span></span><br><span class="line">      <span class="type">bool</span> scan_timestamp; </span><br><span class="line">      <span class="type">unsigned</span> scan_index_timestamp;<span class="comment">//扫描时间戳，如果使能以后会将捕获时间戳放到缓冲区里面</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_trigger</span>              *<span class="title">trig</span>;</span><span class="comment">// IIO 设备当前触发器</span></span><br><span class="line">      <span class="type">bool</span> trig_readonly;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_poll_func</span>            *<span class="title">pollfunc</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_poll_func</span>            *<span class="title">pollfunc_event</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">iio_chan_spec</span> <span class="title">const</span>      *<span class="title">channels</span>;</span><span class="comment">//IIO设备通道列表</span></span><br><span class="line">      <span class="type">int</span> num_channels;<span class="comment">//IIO设备通道数</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>                <span class="title">channel_attr_list</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>          <span class="title">chan_attr_group</span>;</span></span><br><span class="line">      <span class="type">const</span> <span class="type">char</span>                      *name;</span><br><span class="line">      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_info</span>           *<span class="title">info</span>;</span></span><br><span class="line">      <span class="type">clockid_t</span> clock_id;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>                    <span class="title">info_exist_lock</span>;</span></span><br><span class="line">      <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_buffer_setup_ops</span>       *<span class="title">setup_ops</span>;</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span>                     <span class="title">chrdev</span>;</span></span><br><span class="line">&#125;;<span class="comment">//iio_dev用于描述一个具体IIO设备, include/linux/iio/iio.h</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Device operating modes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INDIO_DIRECT_MODE		0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INDIO_BUFFER_TRIGGERED		0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INDIO_BUFFER_SOFTWARE		0x04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INDIO_BUFFER_HARDWARE		0x08</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INDIO_ALL_BUFFER_MODES					\</span></span><br><span class="line">	(INDIO_BUFFER_TRIGGERED | INDIO_BUFFER_HARDWARE | INDIO_BUFFER_SOFTWARE)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>模式</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>INDIO_DIRECT_MODE</td>
<td>提供 sysfs 接口</td>
</tr>
<tr>
<td>INDIO_BUFFER_TRIGGERED</td>
<td>支持硬件缓冲触发</td>
</tr>
<tr>
<td>INDIO_BUFFER_SOFTWARE</td>
<td>支持软件缓冲触发</td>
</tr>
<tr>
<td>INDIO_BUFFER_HARDWARE</td>
<td>支持硬件缓冲区</td>
</tr>
</tbody></table>
<h3><span id="3-1-1-iio-buffer-setup-ops">3.1.1 iio_buffer_setup_ops</span><a href="#3-1-1-iio-buffer-setup-ops" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_buffer_setup_ops</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> (*preenable)(<span class="keyword">struct</span> iio_dev *); <span class="comment">/* 缓冲区使能之前调用 */</span></span><br><span class="line">	<span class="type">int</span> (*postenable)(<span class="keyword">struct</span> iio_dev *); <span class="comment">/* 缓冲区使能之后调用 */</span></span><br><span class="line">	<span class="type">int</span> (*predisable)(<span class="keyword">struct</span> iio_dev *); <span class="comment">/* 缓冲区禁用之前调用 */</span></span><br><span class="line">	<span class="type">int</span> (*postdisable)(<span class="keyword">struct</span> iio_dev *); <span class="comment">/* 缓冲区禁用之后调用 */</span></span><br><span class="line">	<span class="type">bool</span> (*validate_scan_mask)(<span class="keyword">struct</span> iio_dev *indio_dev, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> *scan_mask); <span class="comment">/* 检查扫描掩码是否有效 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在使能或禁用缓冲区的时候会调用这些函数。</p>
<h2><span id="3-2-iio-info-shu-xing-he-han-shu-shi-xian">3.2 iio_info-属性和函数实现</span><a href="#3-2-iio-info-shu-xing-he-han-shu-shi-xian" class="header-anchor">#</a></h2><p><code>iio_info</code>包含每个iio设备的属性和具体实现函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_info</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">module</span>			*<span class="title">driver_module</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>		*<span class="title">event_attrs</span>;</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>	*<span class="title">attrs</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*read_raw)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">			<span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span><br><span class="line">			<span class="type">int</span> *val,</span><br><span class="line">			<span class="type">int</span> *val2,</span><br><span class="line">			<span class="type">long</span> mask);<span class="comment">//最终读写传感器设备内部数据的操作函数</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*read_raw_multi)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">			<span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span><br><span class="line">			<span class="type">int</span> max_len,</span><br><span class="line">			<span class="type">int</span> *vals,</span><br><span class="line">			<span class="type">int</span> *val_len,</span><br><span class="line">			<span class="type">long</span> mask);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*write_raw)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">			 <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span><br><span class="line">			 <span class="type">int</span> val,</span><br><span class="line">			 <span class="type">int</span> val2,</span><br><span class="line">			 <span class="type">long</span> mask);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*write_raw_get_fmt)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">			 <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span><br><span class="line">			 <span class="type">long</span> mask);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*read_event_config)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				 <span class="type">const</span> <span class="keyword">struct</span> iio_chan_spec *chan,</span><br><span class="line">				 <span class="keyword">enum</span> iio_event_type type,</span><br><span class="line">				 <span class="keyword">enum</span> iio_event_direction dir);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*write_event_config)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				  <span class="type">const</span> <span class="keyword">struct</span> iio_chan_spec *chan,</span><br><span class="line">				  <span class="keyword">enum</span> iio_event_type type,</span><br><span class="line">				  <span class="keyword">enum</span> iio_event_direction dir,</span><br><span class="line">				  <span class="type">int</span> state);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*read_event_value)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				<span class="type">const</span> <span class="keyword">struct</span> iio_chan_spec *chan,</span><br><span class="line">				<span class="keyword">enum</span> iio_event_type type,</span><br><span class="line">				<span class="keyword">enum</span> iio_event_direction dir,</span><br><span class="line">				<span class="keyword">enum</span> iio_event_info info, <span class="type">int</span> *val, <span class="type">int</span> *val2);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*write_event_value)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				 <span class="type">const</span> <span class="keyword">struct</span> iio_chan_spec *chan,</span><br><span class="line">				 <span class="keyword">enum</span> iio_event_type type,</span><br><span class="line">				 <span class="keyword">enum</span> iio_event_direction dir,</span><br><span class="line">				 <span class="keyword">enum</span> iio_event_info info, <span class="type">int</span> val, <span class="type">int</span> val2);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> (*validate_trigger)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				<span class="keyword">struct</span> iio_trigger *trig);</span><br><span class="line">	<span class="type">int</span> (*update_scan_mode)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				<span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> *scan_mask);</span><br><span class="line">	<span class="type">int</span> (*debugfs_reg_access)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				  <span class="type">unsigned</span> reg, <span class="type">unsigned</span> writeval,</span><br><span class="line">				  <span class="type">unsigned</span> *readval);</span><br><span class="line">	<span class="type">int</span> (*of_xlate)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">			<span class="type">const</span> <span class="keyword">struct</span> of_phandle_args *iiospec);</span><br><span class="line">	<span class="type">int</span> (*hwfifo_set_watermark)(<span class="keyword">struct</span> iio_dev *indio_dev, <span class="type">unsigned</span> val);</span><br><span class="line">	<span class="type">int</span> (*hwfifo_flush_to_buffer)(<span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">				      <span class="type">unsigned</span> count);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>indio_dev</strong>：需要读写的 IIO 设备。</p>
<p><strong>chan</strong>：需要读取的通道。</p>
<p><strong>val，val2</strong>：对于 <code>read_raw </code>来说 val 和 val2 这两个就是应用程序从内核空间读取到数据，一般就是传感器指定通道值，或者传感器的量程、分辨率等。对于 <code>write_raw</code> 来说就是应用程序向设备写入的数据。val 和 val2 共同组成具体值，val 是整数部分，val2 是小数部分。Linux内核无法支持浮点运算，因此val2是放大后的值。扩大的倍数我们不能随便设置，而是要使用 Linux 定义的倍数，Linux 内核里面定义的数据扩大倍数：</p>
<table>
<thead>
<tr>
<th>组合宏</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>IIO_VAL_INT</code></td>
<td>整数值，没有小数。比如 5000，那么就是 val&#x3D;5000，不 需要设置 val2</td>
</tr>
<tr>
<td><code>IIO_VAL_INT_PLUS_MICRO</code></td>
<td>小数部分扩大 1000000 倍，比如 <code>1.00236</code>，此时 val&#x3D;1， val2&#x3D;2360</td>
</tr>
<tr>
<td><code>IIO_VAL_INT_PLUS_NANO</code></td>
<td>小数部分扩大 1000000000 倍，同样是 <code>1.00236</code>，此时 val&#x3D;1，val2&#x3D;2360000</td>
</tr>
<tr>
<td><code>IIO_VAL_INT_PLUS_MICRO_DB</code></td>
<td>dB 数据，和<code>IIO_VAL_INT_PLUS_MICRO</code>数据形式一 样，只是在后面添加 db</td>
</tr>
<tr>
<td><code>IIO_VAL_INT_MULTIPLE</code></td>
<td>多个整数值，比如一次要传回 6 个整数值，那么 val 和 val2就不够用了。此宏主要用于<code>iio_info</code>的<code>read_raw_multi </code>函数</td>
</tr>
<tr>
<td><code>IIO_VAL_FRACTIONAL</code></td>
<td>分数值，也就是 <code>val/val2</code>。比如 val&#x3D;1，val2&#x3D;4，那么实际 值就是 <code>1/4</code></td>
</tr>
<tr>
<td><code>IIO_VAL_FRACTIONAL_LOG2</code></td>
<td>值为 <code>val&gt;&gt;val2</code>，也就是 val 右移 val2 位。比如 val&#x3D;25600， val2&#x3D;4 ， 那 么 真 正 的 值 就 是 25600 右 移 4 位 ， <code>25600&gt;&gt;4=1600</code></td>
</tr>
</tbody></table>
<p><strong>mask</strong>：掩码，用于指定我们读取的是什么数据，比如 <code>ICM20608</code> 这样的传感器，他既有原 始的测量数据，比如 <code>X,Y,Z </code>轴的陀螺仪、加速度计等，也有测量范围值，或者分辨率。比如加 速度计测量范围设置为<code>±16g</code>，那么分辨率就是 <code>32/65536≈0.000488</code>，我们只有读出原始值以及 对应的分辨率(量程)，才能计算出真实的重力加速度。此时就有两种数据值：传感器原始值、分辨率。Linux 内核使用 <code>IIO_CHAN_INFO_RAW</code> 和<code> IIO_CHAN_INFO_SCALE</code> 这两个宏来表示原 始值以及分辨率，这两个宏就是掩码。</p>
<p><code>write_raw_get_fmt </code>用于设置用户空间向内核空间写入的数据格式，<code>write_raw_get_fmt</code>函数决定了 <code>wtite_raw </code>函数中 val 和 val2 的意义，也就是表中的组合 形式。比如我们需要在应用程序中设置<code> ICM20608</code> 加速度计的量程为<code>±8g</code>，那么分辨率就是<code>16/65536≈0.000244</code>，我们在 <code>write_raw_get_fmt</code> 函数里面设置加速度计的数据格式为<code> IIO_VAL_INT_PLUS_MICRO</code>。那么我们在应用程序里面向指定的文件写入<code> 0.000244</code> 以后，最 终传递给内核驱动的就是 <code>0.000244*1000000=244</code>。也就是 <code>write_raw</code> 函数的 val 参数为 0，val2 参数为 244。</p>
<h2><span id="3-3-iio-chan-spec-tong-dao-shu-xing">3.3 iio_chan_spec-通道属性</span><a href="#3-3-iio-chan-spec-tong-dao-shu-xing" class="header-anchor">#</a></h2><p>一个IIO设备可能有多个通道，每个通道由<code>struct iio_chan_spec</code>表示。比如一个 ADC 芯片支持 8 路采集，那 么这个 ADC 就有 8 个通道。的 <code>ICM20608</code>六轴传感器，可以输出三轴陀螺仪<code>(X、Y、Z)</code>、三轴加速度计<code>(X、Y、Z)</code>和一路温度，共7路数据。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_chan_spec</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">iio_chan_type</span>    <span class="title">type</span>;</span><span class="comment">//表示channel类型，电压、电流、加速度、电磁等等。</span></span><br><span class="line">    <span class="type">int</span>            channel;</span><br><span class="line">    <span class="type">int</span>            channel2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        address;<span class="comment">//该通道对应的芯片数据寄存器地址</span></span><br><span class="line">    <span class="type">int</span>            scan_index;<span class="comment">//当使用触发缓冲区的时候，scan_index 是扫描索引</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">char</span>    sign;</span><br><span class="line">        u8    realbits;</span><br><span class="line">        u8    storagebits;</span><br><span class="line">        u8    shift;</span><br><span class="line">        u8    repeat;</span><br><span class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">iio_endian</span> <span class="title">endianness</span>;</span></span><br><span class="line">    &#125; scan_type;<span class="comment">//扫描数据的存储格式</span></span><br><span class="line">    <span class="type">long</span>            info_mask_separate;</span><br><span class="line">    <span class="type">long</span>            info_mask_separate_available;</span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_type;<span class="comment">//标记导出的信息由相同类型的通道共享,比如</span></span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_type_available;</span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_dir;</span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_dir_available;</span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_all;</span><br><span class="line">    <span class="type">long</span>            info_mask_shared_by_all_available;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_event_spec</span> *<span class="title">event_spec</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>        num_event_specs;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_chan_spec_ext_info</span> *<span class="title">ext_info</span>;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>        *extend_name;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>        *datasheet_name;</span><br><span class="line">    <span class="type">unsigned</span>        modified:<span class="number">1</span>;<span class="comment">//modified 为 1 的时候，channel2 为通道修饰符</span></span><br><span class="line">    <span class="type">unsigned</span>        indexed:<span class="number">1</span>;<span class="comment">// indexed 为 1时候，channel 为通道索引</span></span><br><span class="line">    <span class="type">unsigned</span>        output:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span>        differential:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">iio_chan_type</span> &#123;</span></span><br><span class="line">	IIO_VOLTAGE, <span class="comment">/* 电压类型 */</span></span><br><span class="line">	IIO_CURRENT, <span class="comment">/* 电流类型 */</span></span><br><span class="line">	IIO_POWER, <span class="comment">/* 功率类型 */</span></span><br><span class="line">	IIO_ACCEL, <span class="comment">/* 加速度类型 */</span></span><br><span class="line">	IIO_ANGL_VEL, <span class="comment">/* 角度类型(陀螺仪) */</span></span><br><span class="line">	IIO_MAGN, <span class="comment">/* 电磁类型(磁力计) */</span></span><br><span class="line">	IIO_LIGHT, <span class="comment">/* 灯光类型 */</span></span><br><span class="line">	IIO_INTENSITY, <span class="comment">/* 强度类型(光强传感器) */</span></span><br><span class="line">	IIO_PROXIMITY, <span class="comment">/* 接近类型(接近传感器) */</span></span><br><span class="line">	IIO_TEMP, <span class="comment">/* 温度类型 */</span></span><br><span class="line">	IIO_INCLI, <span class="comment">/* 倾角类型(倾角测量传感器) */</span></span><br><span class="line">	IIO_ROT, <span class="comment">/* 旋转角度类型 */</span></span><br><span class="line">	IIO_ANGL, <span class="comment">/* 转动角度类型(电机旋转角度测量传感器) */</span></span><br><span class="line">	IIO_TIMESTAMP, <span class="comment">/* 时间戳类型 */</span></span><br><span class="line">	IIO_CAPACITANCE, <span class="comment">/* 电容类型 */</span></span><br><span class="line">	IIO_ALTVOLTAGE, <span class="comment">/* 频率类型 */</span></span><br><span class="line">	IIO_CCT, <span class="comment">/* 笔者暂时未知的类型 */</span></span><br><span class="line">	IIO_PRESSURE, <span class="comment">/* 压力类型 */</span></span><br><span class="line">	IIO_HUMIDITYRELATIVE, <span class="comment">/* 湿度类型 */</span></span><br><span class="line">	IIO_ACTIVITY, <span class="comment">/* 活动类型(计步传感器) */</span></span><br><span class="line">	IIO_STEPS, <span class="comment">/* 步数类型 */</span></span><br><span class="line">	IIO_ENERGY, <span class="comment">/* 能量类型(卡路里) */</span></span><br><span class="line">	IIO_DISTANCE, <span class="comment">/* 距离类型 */</span></span><br><span class="line">	IIO_VELOCITY, <span class="comment">/* 速度类型 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果是 ICM20608 这样的多轴传感器，那么就是复合类型了，陀螺仪部分是 <code>IIO_ANGL_VEL </code>类型，加速度计部分是<code>IIO_ACCEL</code>，温度部分就是<code> IIO_TEMP</code>。</p>
<p>当成员变量 <code>modified 为 1 </code>的时候，<code>channel2 为通道修饰符</code>。Linux 内核给出了 可用的<code>通道修饰符</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">iio_modifier</span> &#123;</span></span><br><span class="line">	IIO_NO_MOD,</span><br><span class="line">	IIO_MOD_X, <span class="comment">/* X 轴 */</span></span><br><span class="line">	IIO_MOD_Y, <span class="comment">/* Y 轴 */</span></span><br><span class="line">	IIO_MOD_Z, <span class="comment">/* Z 轴 */</span></span><br><span class="line">......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>比如 <code>ICM20608 </code>的加速度计部分，类型设置为<code> IIO_ACCEL</code>，<code>X、Y、Z </code>这三个轴就用<code> channel2</code> 的<code>通道修饰符</code>来区分.</p>
<p><code>scan_type</code> 各个成员变量:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">scan_type.sign：如果为‘u’表示数据为无符号类型，为‘s’的话为有符号类型。</span><br><span class="line"></span><br><span class="line">scan_type.realbits：数据真实的有效位数，比如很多传感器说的 10 位 ADC，其真实有效数</span><br><span class="line">据就是 10 位。</span><br><span class="line"></span><br><span class="line">scan_type.storagebits：存储位数，有效位数+填充位。比如有些传感器 ADC 是 12 位的，</span><br><span class="line">那么我们存储的话肯定要用到 2 个字节，也就是 16 位，这 16 位就是存储位数。</span><br><span class="line"></span><br><span class="line">scan_type.shift:右移位数，也就是存储位数和有效位数不一致的时候，需要右移的位数，这</span><br><span class="line">个参数不总是需要，一切以实际芯片的数据手册位数。</span><br><span class="line"></span><br><span class="line">scan_type.repeat：实际或存储位的重复数量。</span><br><span class="line">scan_type.endianness:数据的大小端模式，可设置为 IIO_CPU、IIO_BE(大端)或 IIO_LE(小</span><br><span class="line">端)。</span><br></pre></td></tr></table></figure>

<p><code>info_mask_separate</code> 将属性标记为特定于此通</p>
<p><code>info_mask_shared_by_type </code>标记导出的信息由相同类型的通道共享。<code>X、Y、Z </code>轴他们的 type 都 是<code> IIO_ACCEL</code>，也就是类型相同。而这三个轴的分辨率(量程)是一样的，那么这3个通道<code>info_mask_shared_by_type</code> 中使能<code>IO_CHAN_INFO_SCALE</code> 这个属性，表示 这三个通道的分辨率是共用的，这样在<code>sysfs</code>下就会只生成一个描述分辨率的文件，这三个通道 都可以使用这一个分辨率文件。</p>
<p><code>info_mask_shared_by_dir </code>标记某些导出的信息由相同方向的通道共享。</p>
<p><code>info_mask_shared_by_all </code>表设计某些信息所有的通道共享，无论这些通道的类 型、方向如何，全部共享。</p>
<p><code>output </code>表示为输出通道。</p>
<p><code>differential </code>表示为差分通道。</p>
<h2><span id="3-4-iio-trigger-hong-fa-shu-ju-cai-ji">3.4 iio_trigger-触发数据采集</span><a href="#3-4-iio-trigger-hong-fa-shu-ju-cai-ji" class="header-anchor">#</a></h2><p>触发器是基于某种信号来触发数据采集，比如：数据就绪中断；周期性中断；用户空间sysfs读写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_trigger</span> &#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_trigger_ops</span>    *<span class="title">ops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span>            *<span class="title">owner</span>;</span></span><br><span class="line">    <span class="type">int</span>                id;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>            *name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span>            <span class="title">dev</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">list</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">alloc_list</span>;</span></span><br><span class="line">    <span class="type">atomic_t</span>            use_count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">irq_chip</span>            <span class="title">subirq_chip</span>;</span></span><br><span class="line">    <span class="type">int</span>                subirq_base;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iio_subirq</span> <span class="title">subirqs</span>[<span class="title">CONFIG_IIO_CONSUMERS_PER_TRIGGER</span>];</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pool[BITS_TO_LONGS(CONFIG_IIO_CONSUMERS_PER_TRIGGER)];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>            <span class="title">pool_lock</span>;</span></span><br><span class="line">    <span class="type">bool</span>                attached_own_device;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3><span id="3-4-1-iio-trigger-ops">3.4.1 iio_trigger_ops</span><a href="#3-4-1-iio-trigger-ops" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_trigger_ops</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> (*set_trigger_state)(<span class="keyword">struct</span> iio_trigger *trig, <span class="type">bool</span> state);--设置触发器状态，打开或关闭。</span><br><span class="line">    <span class="type">int</span> (*try_reenable)(<span class="keyword">struct</span> iio_trigger *trig);--当用户计数为<span class="number">0</span>时，重新使能接口。</span><br><span class="line">    <span class="type">int</span> (*validate_device)(<span class="keyword">struct</span> iio_trigger *trig,</span><br><span class="line">                   <span class="keyword">struct</span> iio_dev *indio_dev);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2><span id="3-5-iio-buffer-bao-cun-cai-ji-dao-de-shu-ju">3.5 iio_buffer-保存采集到的数据</span><a href="#3-5-iio-buffer-bao-cun-cai-ji-dao-de-shu-ju" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iio_buffer</span> &#123;</span></span><br><span class="line">	<span class="type">int</span>					length;</span><br><span class="line">	<span class="type">int</span>					bytes_per_datum;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>			*<span class="title">scan_el_attrs</span>;</span></span><br><span class="line">	<span class="type">long</span>					*scan_mask;</span><br><span class="line">	<span class="type">bool</span>					scan_timestamp;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_buffer_access_funcs</span>	*<span class="title">access</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>			<span class="title">scan_el_dev_attr_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>			<span class="title">buffer_group</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">attribute_group</span>			<span class="title">scan_el_group</span>;</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span>			pollq;</span><br><span class="line">	<span class="type">bool</span>					stufftoread;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span>			**<span class="title">attrs</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>			<span class="title">demux_list</span>;</span></span><br><span class="line">	<span class="type">void</span>					*demux_bounce;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>			<span class="title">buffer_list</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span>				<span class="title">ref</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>				watermark;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1><span id="4-api">4 API</span><a href="#4-api" class="header-anchor">#</a></h1><h2><span id="4-1-iio-dev-zhu-ce-yu-zhu-xiao">4.1 iio_dev 注册与注销</span><a href="#4-1-iio-dev-zhu-ce-yu-zhu-xiao" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> iio_dev *<span class="title function_">iio_device_alloc</span><span class="params">(<span class="type">int</span> sizeof_priv)</span><span class="comment">//申请 iio_dev</span></span><br><span class="line"><span class="keyword">struct</span> iio_dev *<span class="title function_">devm_iio_device_alloc</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">int</span> sizeof_priv)</span><span class="comment">//申请 iio_dev</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iio_device_free</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">devm_iio_device_free</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> iio_dev *indio_dev)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">iio_device_register</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev)</span><span class="comment">//注册iio设备</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">iio_device_unregister</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev)</span><span class="comment">//注销iio设备</span></span><br><span class="line">      </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> iio_device_register(indio_dev) \</span></span><br><span class="line"><span class="meta">    __iio_device_register((indio_dev), THIS_MODULE)</span></span><br><span class="line"><span class="type">int</span> __<span class="title function_">iio_device_register</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev, <span class="keyword">struct</span> module *this_mod)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">iio_device_unregister</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> devm_iio_device_register(dev, indio_dev) \</span></span><br><span class="line"><span class="meta">    __devm_iio_device_register((dev), (indio_dev), THIS_MODULE);</span></span><br><span class="line"><span class="type">int</span> __devm_iio_device_register(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> iio_dev *indio_dev,</span><br><span class="line">                   <span class="keyword">struct</span> module *this_mod);</span><br><span class="line"><span class="type">void</span> <span class="title function_">devm_iio_device_unregister</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> iio_dev *indio_dev)</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/2.png" alt="image"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">devm_iio_device_register/iio_device_register</span><br><span class="line">　　-&gt;__iio_device_register</span><br><span class="line">　　　　-&gt;iio_check_unique_scan_index</span><br><span class="line">　　　　-&gt;iio_device_register_debugfs</span><br><span class="line">　　　　　　-&gt;debugfs_create_file<span class="comment">//创建direct_reg_access调试节点，通过此节点可以直接读写寄存器。</span></span><br><span class="line">    		<span class="comment">//iio_debugfs_reg_fops调用IIO设备struct iio_dev-&gt;info-&gt;debugfs_reg_access()函数。</span></span><br></pre></td></tr></table></figure>

<h3><span id="4-1-1-iio-device-register-sysfs-guo-cheng">4.1.1 <code>iio_device_register_sysfs</code>过程</span><a href="#4-1-1-iio-device-register-sysfs-guo-cheng" class="header-anchor">#</a></h3><p><code>devm_iio_device_register</code>过程中会调用<code>iio_device_register_sysfs</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">　-&gt;iio_buffer_alloc_sysfs_and_mask</span><br><span class="line">　　　　-&gt;iio_device_register_sysfs<span class="comment">//创建adc属性和每个channel属性。</span></span><br><span class="line">　　　　-&gt;cdev_init<span class="comment">//初始化cdev设备，操作函数集为iio_buffer_fileops。</span></span><br><span class="line">　　　　-&gt;cdev_device_add<span class="comment">//创建cdev设备/dev/iio:deviceX。</span></span><br></pre></td></tr></table></figure>

<p>展开<code>iio_device_register_sysfs</code>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">iio_device_register_sysfs</span><br><span class="line">        ---&gt;  iio_device_add_channel_sysfs</span><br><span class="line">                ---&gt;  iio_device_add_info_mask_type</span><br><span class="line">                        ---&gt;  __iio_add_chan_devattr</span><br><span class="line">                                ---&gt;  __iio_device_attr_init</span><br></pre></td></tr></table></figure>

<p>其中在<code>iio_device_add_info_mask_type</code>中设置了读写回调函数，比如<code>cat in_voltage0_input</code>就会调用回调函数<code>iio_read_channel_info</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __iio_device_attr_init()</span><br><span class="line">&#123;...</span><br><span class="line">		<span class="keyword">case</span> IIO_SEPARATE:</span><br><span class="line">			<span class="keyword">if</span> (chan-&gt;indexed)</span><br><span class="line">				name = kasprintf(GFP_KERNEL, <span class="string">&quot;%s_%s%d_%s&quot;</span>,</span><br><span class="line">						    iio_direction[chan-&gt;output],</span><br><span class="line">						    iio_chan_type_name_spec[chan-&gt;type],</span><br><span class="line">						    chan-&gt;channel,</span><br><span class="line">						    full_postfix);</span><br><span class="line">    <span class="comment">//in_voltage0_input</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">      ..........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>格式为<code>%s_%s%d_%s&quot;</code>， 对应了<code>in_voltage0_input</code>，其中<code>iio_direction、iio_chan_type_name_spec、iio_chan_info_postfix</code>对应的值为<code> &quot;in&quot; 、&quot;voltage&quot; 、&quot;input&quot;</code></p>
<p>如下代码片段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_direction[] = &#123;</span><br><span class="line">	[<span class="number">0</span>] = <span class="string">&quot;in&quot;</span>,</span><br><span class="line">	[<span class="number">1</span>] = <span class="string">&quot;out&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_chan_type_name_spec[] = &#123;</span><br><span class="line">	[IIO_VOLTAGE] = <span class="string">&quot;voltage&quot;</span>,</span><br><span class="line">	[IIO_CURRENT] = <span class="string">&quot;current&quot;</span>,</span><br><span class="line">	[IIO_POWER] = <span class="string">&quot;power&quot;</span>,</span><br><span class="line">	[IIO_ACCEL] = <span class="string">&quot;accel&quot;</span>,</span><br><span class="line">	<span class="comment">// 以下省略</span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">/* relies on pairs of these shared then separate */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_chan_info_postfix[] = &#123;</span><br><span class="line">	[IIO_CHAN_INFO_RAW] = <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_PROCESSED] = <span class="string">&quot;input&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_SCALE] = <span class="string">&quot;scale&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_OFFSET] = <span class="string">&quot;offset&quot;</span>,</span><br><span class="line">    <span class="comment">// 以下省略</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2><span id="4-2-iio-init-zi-xi-tong-de-chu-shi-hua">4.2 iio_init-子系统的初始化</span><a href="#4-2-iio-init-zi-xi-tong-de-chu-shi-hua" class="header-anchor">#</a></h2><p>IIO子系统初始化包括：</p>
<ul>
<li>iio总线注册</li>
<li>分配IIO字符设备号</li>
<li>创建IIO设备<code>debugfs</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iio_init</span><br><span class="line">　　-&gt;bus_register<span class="comment">//注册iio bus。</span></span><br><span class="line">　　-&gt;alloc_chrdev_region<span class="comment">//创建iio cdev设备编号iio_devt。</span></span><br><span class="line">　　-&gt;debugfs_create_dir<span class="comment">//创建/sys/kernel/debug/iio调试目录iio_debugfs_dentry。</span></span><br></pre></td></tr></table></figure>

<h1><span id="5-iio-shi-yan-cao-zuo-icm20608">5 iio实验-操作ICM20608</span><a href="#5-iio-shi-yan-cao-zuo-icm20608" class="header-anchor">#</a></h1><h2><span id="5-1-shi-neng-nei-he-iio">5.1  使能内核 IIO</span><a href="#5-1-shi-neng-nei-he-iio" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line"> -&gt; Industrial I/O <span class="title function_">support</span> <span class="params">(IIO [=y])</span> </span><br><span class="line"> 	-&gt; [*]Enable buffer support within IIO <span class="comment">//选中</span></span><br><span class="line"> 	-&gt; &lt;*&gt;Industrial I/O buffering based on kfifo <span class="comment">//选中</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/3.png" alt="image"></p>
<h2><span id="5-2-qu-dong-dai-ma-fen-xi">5.2 驱动代码分析</span><a href="#5-2-qu-dong-dai-ma-fen-xi" class="header-anchor">#</a></h2><h3><span id="5-2-0-yuan-ma">5.2.0 源码</span><a href="#5-2-0-yuan-ma" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/spi/spi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/delay.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/ide.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/platform_device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;icm20608reg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/gpio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/device.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/regmap.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/iio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/sysfs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/trigger.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/triggered_buffer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/iio/trigger_consumer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/unaligned/be_byteshift.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_NAME	<span class="string">&quot;icm20608&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_TEMP_OFFSET	     0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_TEMP_SCALE		     326800000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ICM20608_CHAN(_type, _channel2, _index)                \</span></span><br><span class="line"><span class="meta">	&#123;                                                          \</span></span><br><span class="line"><span class="meta">		.type = _type,                                        \</span></span><br><span class="line"><span class="meta">		.modified = 1,                                        \</span></span><br><span class="line"><span class="meta">		.channel2 = _channel2,                                \</span></span><br><span class="line"><span class="meta">		.info_mask_shared_by_type = BIT(IIO_CHAN_INFO_SCALE), \</span></span><br><span class="line"><span class="meta">		.info_mask_separate = BIT(IIO_CHAN_INFO_RAW) |	      \</span></span><br><span class="line"><span class="meta">				      BIT(IIO_CHAN_INFO_CALIBBIAS),   \</span></span><br><span class="line"><span class="meta">		.scan_index = _index,                                 \</span></span><br><span class="line"><span class="meta">		.scan_type = &#123;                                        \</span></span><br><span class="line"><span class="meta">				.sign = <span class="string">&#x27;s&#x27;</span>,                          \</span></span><br><span class="line"><span class="meta">				.realbits = 16,                       \</span></span><br><span class="line"><span class="meta">				.storagebits = 16,                    \</span></span><br><span class="line"><span class="meta">				.shift = 0,                           \</span></span><br><span class="line"><span class="meta">				.endianness = IIO_BE,                 \</span></span><br><span class="line"><span class="meta">			     &#125;,                                       \</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * ICM20608的扫描元素，3轴加速度计、</span></span><br><span class="line"><span class="comment"> * 3轴陀螺仪、1路温度传感器，1路时间戳 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">inv_icm20608_scan</span> &#123;</span></span><br><span class="line">	INV_ICM20608_SCAN_ACCL_X,</span><br><span class="line">	INV_ICM20608_SCAN_ACCL_Y,</span><br><span class="line">	INV_ICM20608_SCAN_ACCL_Z,</span><br><span class="line">	INV_ICM20608_SCAN_TEMP,</span><br><span class="line">	INV_ICM20608_SCAN_GYRO_X,</span><br><span class="line">	INV_ICM20608_SCAN_GYRO_Y,</span><br><span class="line">	INV_ICM20608_SCAN_GYRO_Z,</span><br><span class="line">	INV_ICM20608_SCAN_TIMESTAMP,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">spi_device</span> *<span class="title">spi</span>;</span>		<span class="comment">/* spi设备 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regmap</span> *<span class="title">regmap</span>;</span>				<span class="comment">/* regmap */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">regmap_config</span> <span class="title">regmap_config</span>;</span>	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">lock</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * icm20608陀螺仪分辨率，对应250、500、1000、2000，计算方法：</span></span><br><span class="line"><span class="comment"> * 以正负250度量程为例，500/2^16=0.007629，扩大1000000倍，就是7629</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> gyro_scale_icm20608[] = &#123;<span class="number">7629</span>, <span class="number">15258</span>, <span class="number">30517</span>, <span class="number">61035</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * icm20608加速度计分辨率，对应2、4、8、16 计算方法：</span></span><br><span class="line"><span class="comment"> * 以正负2g量程为例，4/2^16=0.000061035，扩大1000000000倍，就是61035</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> accel_scale_icm20608[] = &#123;<span class="number">61035</span>, <span class="number">122070</span>, <span class="number">244140</span>, <span class="number">488281</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * icm20608通道，1路温度通道，3路陀螺仪，3路加速度计</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_chan_spec</span> <span class="title">icm20608_channels</span>[] =</span> &#123;</span><br><span class="line">	<span class="comment">/* 温度通道 */</span></span><br><span class="line">	&#123;</span><br><span class="line">		.type = IIO_TEMP,</span><br><span class="line">		.info_mask_separate = BIT(IIO_CHAN_INFO_RAW)</span><br><span class="line">				| BIT(IIO_CHAN_INFO_OFFSET)</span><br><span class="line">				| BIT(IIO_CHAN_INFO_SCALE),</span><br><span class="line">		.scan_index = INV_ICM20608_SCAN_TEMP,</span><br><span class="line">		.scan_type = &#123;</span><br><span class="line">				.sign = <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">				.realbits = <span class="number">16</span>,</span><br><span class="line">				.storagebits = <span class="number">16</span>,</span><br><span class="line">				.shift = <span class="number">0</span>,</span><br><span class="line">				.endianness = IIO_BE,</span><br><span class="line">			     &#125;,</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	ICM20608_CHAN(IIO_ANGL_VEL, IIO_MOD_X, INV_ICM20608_SCAN_GYRO_X),	<span class="comment">/* 陀螺仪X轴 */</span></span><br><span class="line">	ICM20608_CHAN(IIO_ANGL_VEL, IIO_MOD_Y, INV_ICM20608_SCAN_GYRO_Y),	<span class="comment">/* 陀螺仪Y轴 */</span></span><br><span class="line">	ICM20608_CHAN(IIO_ANGL_VEL, IIO_MOD_Z, INV_ICM20608_SCAN_GYRO_Z),	<span class="comment">/* 陀螺仪Z轴 */</span></span><br><span class="line"></span><br><span class="line">	ICM20608_CHAN(IIO_ACCEL, IIO_MOD_Y, INV_ICM20608_SCAN_ACCL_Y),	<span class="comment">/* 加速度X轴 */</span></span><br><span class="line">	ICM20608_CHAN(IIO_ACCEL, IIO_MOD_X, INV_ICM20608_SCAN_ACCL_X),	<span class="comment">/* 加速度Y轴 */</span></span><br><span class="line">	ICM20608_CHAN(IIO_ACCEL, IIO_MOD_Z, INV_ICM20608_SCAN_ACCL_Z),	<span class="comment">/* 加速度Z轴 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">unsigned</span> <span class="type">char</span> <span class="title function_">icm20608_read_onereg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 ret;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> data;</span><br><span class="line"></span><br><span class="line">	ret = regmap_read(dev-&gt;regmap, reg, &amp;data);</span><br><span class="line">	<span class="keyword">return</span> (u8)data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">icm20608_write_onereg</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, u8 reg, u8 value)</span></span><br><span class="line">&#123;</span><br><span class="line">	regmap_write(dev-&gt;regmap,  reg, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">icm20608_reginit</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	u8 value = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	icm20608_write_onereg(dev, ICM20_PWR_MGMT_1, <span class="number">0x80</span>);</span><br><span class="line">	mdelay(<span class="number">50</span>);</span><br><span class="line">	icm20608_write_onereg(dev, ICM20_PWR_MGMT_1, <span class="number">0x01</span>);</span><br><span class="line">	mdelay(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">	value = icm20608_read_onereg(dev, ICM20_WHO_AM_I);</span><br><span class="line">	printk(<span class="string">&quot;ICM20608 ID = %#X\r\n&quot;</span>, value);	</span><br><span class="line"></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_SMPLRT_DIV, <span class="number">0x00</span>); <span class="comment">/* 输出速率是内部采样率*/</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_GYRO_CONFIG, <span class="number">0x18</span>); <span class="comment">/* 陀螺仪±2000dps量程 */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_ACCEL_CONFIG, <span class="number">0x18</span>); <span class="comment">/* 加速度计±16G量程 */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_CONFIG, <span class="number">0x04</span>); <span class="comment">/* 陀螺仪低通滤波BW=20Hz */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_ACCEL_CONFIG2, <span class="number">0x04</span>); <span class="comment">/* 加速度计低通滤波BW=21.2Hz */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_PWR_MGMT_2, <span class="number">0x00</span>); <span class="comment">/* 打开加速度计和陀螺仪所有轴 */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_LP_MODE_CFG, <span class="number">0x00</span>); <span class="comment">/* 关闭低功耗 */</span></span><br><span class="line">	icm20608_write_onereg(dev, ICM20_INT_ENABLE, <span class="number">0x01</span>);	<span class="comment">/* 使能FIFO溢出以及数据就绪中断	*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description  	: 设置ICM20608传感器，可以用于陀螺仪、加速度计设置</span></span><br><span class="line"><span class="comment">  * @param - dev	: icm20608设备 </span></span><br><span class="line"><span class="comment">  * @param - reg  	: 要设置的通道寄存器首地址。</span></span><br><span class="line"><span class="comment">  * @param - anix  	: 要设置的通道，比如X，Y，Z。</span></span><br><span class="line"><span class="comment">  * @param - val  	: 要设置的值。</span></span><br><span class="line"><span class="comment">  * @return			: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_sensor_set</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">int</span> reg,</span></span><br><span class="line"><span class="params">				<span class="type">int</span> axis, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ind, result;</span><br><span class="line">	__be16 d = cpu_to_be16(val);</span><br><span class="line"></span><br><span class="line">	ind = (axis - IIO_MOD_X) * <span class="number">2</span>;</span><br><span class="line">	result = regmap_bulk_write(dev-&gt;regmap, reg + ind, (u8 *)&amp;d, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (result)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description  	: 读取ICM20608传感器数据，可以用于陀螺仪、加速度计、温度的读取</span></span><br><span class="line"><span class="comment">  * @param - dev	: icm20608设备 </span></span><br><span class="line"><span class="comment">  * @param - reg  	: 要读取的通道寄存器首地址。</span></span><br><span class="line"><span class="comment">  * @param - anix  	: 需要读取的通道，比如X，Y，Z。</span></span><br><span class="line"><span class="comment">  * @param - val  	: 保存读取到的值。</span></span><br><span class="line"><span class="comment">  * @return			: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_sensor_show</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">int</span> reg,</span></span><br><span class="line"><span class="params">				   <span class="type">int</span> axis, <span class="type">int</span> *val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ind, result;</span><br><span class="line">	__be16 d;</span><br><span class="line"></span><br><span class="line">	ind = (axis - IIO_MOD_X) * <span class="number">2</span>;</span><br><span class="line">	result = regmap_bulk_read(dev-&gt;regmap, reg + ind, (u8 *)&amp;d, <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">if</span> (result)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	*val = (<span class="type">short</span>)be16_to_cpup(&amp;d);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> IIO_VAL_INT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description  		: 读取ICM20608陀螺仪、加速度计、温度通道值</span></span><br><span class="line"><span class="comment">  * @param - indio_dev	: iio设备 </span></span><br><span class="line"><span class="comment">  * @param - chan  		: 通道。</span></span><br><span class="line"><span class="comment">  * @param - val  		: 保存读取到的通道值。</span></span><br><span class="line"><span class="comment">  * @return				: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_read_channel_data</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev,</span></span><br><span class="line"><span class="params">					 <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span></span><br><span class="line"><span class="params">					 <span class="type">int</span> *val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span> =</span> iio_priv(indio_dev);</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">	<span class="keyword">case</span> IIO_ANGL_VEL:	<span class="comment">/* 读取陀螺仪数据, channel2为X、Y、Z轴*/</span></span><br><span class="line">		ret = icm20608_sensor_show(dev, ICM20_GYRO_XOUT_H, chan-&gt;channel2, val);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> IIO_ACCEL:		<span class="comment">/* 读取加速度计数据,channel2为X、Y、Z轴 */</span></span><br><span class="line">		ret = icm20608_sensor_show(dev, ICM20_ACCEL_XOUT_H, chan-&gt;channel2, val);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> IIO_TEMP:		<span class="comment">/* 读取温度 */</span></span><br><span class="line">		ret = icm20608_sensor_show(dev, ICM20_TEMP_OUT_H, IIO_MOD_X, val);  </span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description  	: 设置ICM20608的陀螺仪计量程(分辨率)</span></span><br><span class="line"><span class="comment">  * @param - dev	: icm20608设备</span></span><br><span class="line"><span class="comment">  * @param - val   	: 量程(分辨率值)。</span></span><br><span class="line"><span class="comment">  * @return			: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_write_gyro_scale</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result, i;</span><br><span class="line">	u8 d;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(gyro_scale_icm20608); ++i) &#123;</span><br><span class="line">		<span class="keyword">if</span> (gyro_scale_icm20608[i] == val) &#123;</span><br><span class="line">			d = (i &lt;&lt; <span class="number">3</span>);</span><br><span class="line">			result = regmap_write(dev-&gt;regmap, ICM20_GYRO_CONFIG, d);</span><br><span class="line">			<span class="keyword">if</span> (result)</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description  	: 设置ICM20608的加速度计量程(分辨率)</span></span><br><span class="line"><span class="comment">  * @param - dev	: icm20608设备</span></span><br><span class="line"><span class="comment">  * @param - val   	: 量程(分辨率值)。</span></span><br><span class="line"><span class="comment">  * @return			: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_write_accel_scale</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev, <span class="type">int</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> result, i;</span><br><span class="line">	u8 d;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ARRAY_SIZE(accel_scale_icm20608); ++i) &#123;</span><br><span class="line">		<span class="keyword">if</span> (accel_scale_icm20608[i] == val) &#123;</span><br><span class="line">			d = (i &lt;&lt; <span class="number">3</span>);</span><br><span class="line">			result = regmap_write(dev-&gt;regmap, ICM20_ACCEL_CONFIG, d);</span><br><span class="line">			<span class="keyword">if</span> (result)</span><br><span class="line">				<span class="keyword">return</span> result;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description     	: 读函数，当读取sysfs中的文件的时候最终此函数会执行，此函数</span></span><br><span class="line"><span class="comment">  * 					：里面会从传感器里面读取各种数据，然后上传给应用。</span></span><br><span class="line"><span class="comment">  * @param - indio_dev	: iio_dev</span></span><br><span class="line"><span class="comment">  * @param - chan   	: 通道</span></span><br><span class="line"><span class="comment">  * @param - val   		: 读取的值，如果是小数值的话，val是整数部分。</span></span><br><span class="line"><span class="comment">  * @param - val2   	: 读取的值，如果是小数值的话，val2是小数部分。</span></span><br><span class="line"><span class="comment">  * @param - mask   	: 掩码。</span></span><br><span class="line"><span class="comment">  * @return				: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_read_raw</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev,</span></span><br><span class="line"><span class="params">			   <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span></span><br><span class="line"><span class="params">			   <span class="type">int</span> *val, <span class="type">int</span> *val2, <span class="type">long</span> mask)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span> =</span> iio_priv(indio_dev);</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> regdata = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mask) &#123;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_RAW:	<span class="comment">/* 读取ICM20608加速度计、陀螺仪、温度传感器原始值 */</span></span><br><span class="line">		mutex_lock(&amp;dev-&gt;lock); <span class="comment">/* 上锁 */</span></span><br><span class="line">		ret = icm20608_read_channel_data(indio_dev, chan, val); <span class="comment">/* 读取通道值 */</span></span><br><span class="line">		mutex_unlock(&amp;dev-&gt;lock);<span class="comment">/* 释放锁 */</span></span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_SCALE:</span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_ANGL_VEL:</span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			regdata = (icm20608_read_onereg(dev, ICM20_GYRO_CONFIG) &amp; <span class="number">0X18</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">			*val  = <span class="number">0</span>;</span><br><span class="line">			*val2 = gyro_scale_icm20608[regdata];</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT_PLUS_MICRO;	<span class="comment">/* 值为val+val2/1000000 */</span></span><br><span class="line">		<span class="keyword">case</span> IIO_ACCEL:</span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			regdata = (icm20608_read_onereg(dev, ICM20_ACCEL_CONFIG) &amp; <span class="number">0X18</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">			*val = <span class="number">0</span>;</span><br><span class="line">			*val2 = accel_scale_icm20608[regdata];;</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT_PLUS_NANO;<span class="comment">/* 值为val+val2/1000000000 */</span></span><br><span class="line">		<span class="keyword">case</span> IIO_TEMP:					</span><br><span class="line">			*val = ICM20608_TEMP_SCALE/ <span class="number">1000000</span>;</span><br><span class="line">			*val2 = ICM20608_TEMP_SCALE % <span class="number">1000000</span>;</span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT_PLUS_MICRO;	<span class="comment">/* 值为val+val2/1000000 */</span></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_OFFSET:		<span class="comment">/* ICM20608温度传感器offset值 */</span></span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_TEMP:</span><br><span class="line">			*val = ICM20608_TEMP_OFFSET;</span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_CALIBBIAS:	<span class="comment">/* ICM20608加速度计和陀螺仪校准值 */</span></span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_ANGL_VEL:		<span class="comment">/* 陀螺仪的校准值 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			ret = icm20608_sensor_show(dev, ICM20_XG_OFFS_USRH, chan-&gt;channel2, val);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">case</span> IIO_ACCEL:			<span class="comment">/* 加速度计的校准值 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);	</span><br><span class="line">			ret = icm20608_sensor_show(dev, ICM20_XA_OFFSET_H, chan-&gt;channel2, val);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">return</span> ret;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> ret -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description     	: 写函数，当向sysfs中的文件写数据的时候最终此函数会执行，一般在此函数</span></span><br><span class="line"><span class="comment">  * 					：里面设置传感器，比如量程等。</span></span><br><span class="line"><span class="comment">  * @param - indio_dev	: iio_dev</span></span><br><span class="line"><span class="comment">  * @param - chan   	: 通道</span></span><br><span class="line"><span class="comment">  * @param - val   		: 应用程序写入的值，如果是小数值的话，val是整数部分。</span></span><br><span class="line"><span class="comment">  * @param - val2   	: 应用程序写入的值，如果是小数值的话，val2是小数部分。</span></span><br><span class="line"><span class="comment">  * @return				: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_write_raw</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev,</span></span><br><span class="line"><span class="params">			    <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan,</span></span><br><span class="line"><span class="params">			    <span class="type">int</span> val, <span class="type">int</span> val2, <span class="type">long</span> mask)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span> =</span> iio_priv(indio_dev);</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (mask) &#123;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_SCALE:	<span class="comment">/* 设置陀螺仪和加速度计的分辨率 */</span></span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_ANGL_VEL:		<span class="comment">/* 设置陀螺仪 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			ret = icm20608_write_gyro_scale(dev, val2);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> IIO_ACCEL:			<span class="comment">/* 设置加速度计 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			ret = icm20608_write_accel_scale(dev, val2);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_CALIBBIAS:	<span class="comment">/* 设置陀螺仪和加速度计的校准值*/</span></span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_ANGL_VEL:		<span class="comment">/* 设置陀螺仪校准值 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			ret = icm20608_sensor_set(dev, ICM20_XG_OFFS_USRH,</span><br><span class="line">									    chan-&gt;channel2, val);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> IIO_ACCEL:			<span class="comment">/* 加速度计校准值 */</span></span><br><span class="line">			mutex_lock(&amp;dev-&gt;lock);</span><br><span class="line">			ret = icm20608_sensor_set(dev, ICM20_XA_OFFSET_H,</span><br><span class="line">							             chan-&gt;channel2, val);</span><br><span class="line">			mutex_unlock(&amp;dev-&gt;lock);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			ret = -EINVAL;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * @description     	: 用户空间写数据格式，比如我们在用户空间操作sysfs来设置传感器的分辨率，</span></span><br><span class="line"><span class="comment">  * 					：如果分辨率带小数，那么这个小数传递到内核空间应该扩大多少倍，此函数就是</span></span><br><span class="line"><span class="comment">  *						: 用来设置这个的。</span></span><br><span class="line"><span class="comment">  * @param - indio_dev	: iio_dev</span></span><br><span class="line"><span class="comment">  * @param - chan   	: 通道</span></span><br><span class="line"><span class="comment">  * @param - mask   	: 掩码</span></span><br><span class="line"><span class="comment">  * @return				: 0，成功；其他值，错误</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_write_raw_get_fmt</span><span class="params">(<span class="keyword">struct</span> iio_dev *indio_dev,</span></span><br><span class="line"><span class="params">				 <span class="keyword">struct</span> iio_chan_spec <span class="type">const</span> *chan, <span class="type">long</span> mask)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> (mask) &#123;</span><br><span class="line">	<span class="keyword">case</span> IIO_CHAN_INFO_SCALE:</span><br><span class="line">		<span class="keyword">switch</span> (chan-&gt;type) &#123;</span><br><span class="line">		<span class="keyword">case</span> IIO_ANGL_VEL:		<span class="comment">/* 用户空间写的陀螺仪分辨率数据要乘以1000000 */</span></span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT_PLUS_MICRO;</span><br><span class="line">		<span class="keyword">default</span>:				<span class="comment">/* 用户空间写的加速度计分辨率数据要乘以1000000000 */</span></span><br><span class="line">			<span class="keyword">return</span> IIO_VAL_INT_PLUS_NANO;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> IIO_VAL_INT_PLUS_MICRO;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">iio_info</span> <span class="title">icm20608_info</span> =</span> &#123;</span><br><span class="line">	.read_raw		= icm20608_read_raw,</span><br><span class="line">	.write_raw		= icm20608_write_raw,</span><br><span class="line">	.write_raw_get_fmt = &amp;icm20608_write_raw_get_fmt,	<span class="comment">/* 用户空间写数据格式 */</span></span><br><span class="line">&#125;;</span><br><span class="line">	</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_probe</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iio_dev</span> *<span class="title">indio_dev</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*  1、申请iio_dev内存 */</span></span><br><span class="line">	indio_dev = devm_iio_device_alloc(&amp;spi-&gt;dev, <span class="keyword">sizeof</span>(*dev));</span><br><span class="line">	<span class="keyword">if</span> (!indio_dev)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 2、获取icm20608_dev结构体地址 */</span></span><br><span class="line">	dev = iio_priv(indio_dev); </span><br><span class="line">	dev-&gt;spi = spi;</span><br><span class="line">	spi_set_drvdata(spi, indio_dev);    		<span class="comment">/* 将indio_de设置为spi-&gt;dev的driver_data */</span></span><br><span class="line">	mutex_init(&amp;dev-&gt;lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 3、iio_dev的其他成员变量 */</span></span><br><span class="line">	indio_dev-&gt;dev.parent = &amp;spi-&gt;dev;</span><br><span class="line">	indio_dev-&gt;info = &amp;icm20608_info;</span><br><span class="line">	indio_dev-&gt;name = ICM20608_NAME;	</span><br><span class="line">	indio_dev-&gt;modes = INDIO_DIRECT_MODE;	<span class="comment">/* 直接模式，提供sysfs接口 */</span></span><br><span class="line">	indio_dev-&gt;channels = icm20608_channels;</span><br><span class="line">	indio_dev-&gt;num_channels = ARRAY_SIZE(icm20608_channels);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 4、注册iio_dev */</span></span><br><span class="line">	ret = iio_device_register(indio_dev);</span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		dev_err(&amp;spi-&gt;dev, <span class="string">&quot;iio_device_register failed\n&quot;</span>);</span><br><span class="line">		<span class="keyword">goto</span> err_iio_register;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 5、初始化regmap_config设置 */</span></span><br><span class="line">	dev-&gt;regmap_config.reg_bits = <span class="number">8</span>;			<span class="comment">/* 寄存器长度8bit */</span></span><br><span class="line">	dev-&gt;regmap_config.val_bits = <span class="number">8</span>;			<span class="comment">/* 值长度8bit */</span></span><br><span class="line">	dev-&gt;regmap_config.read_flag_mask = <span class="number">0x80</span>;</span><br><span class="line">	<span class="comment">/* 读掩码设置为0X80，ICM20608使用SPI接口读的时候寄存器最高位应该为1 */</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 6、初始化SPI接口的regmap */</span></span><br><span class="line">	dev-&gt;regmap = regmap_init_spi(spi, &amp;dev-&gt;regmap_config);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(dev-&gt;regmap)) &#123;</span><br><span class="line">		ret = PTR_ERR(dev-&gt;regmap);</span><br><span class="line">		<span class="keyword">goto</span> err_regmap_init;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 7、初始化spi_device */</span></span><br><span class="line">	spi-&gt;mode = SPI_MODE_0;	<span class="comment">/*MODE0，CPOL=0，CPHA=0*/</span></span><br><span class="line">	spi_setup(spi);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* 初始化ICM20608内部寄存器 */</span></span><br><span class="line">	icm20608_reginit(dev);	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_regmap_init:</span><br><span class="line">    iio_device_unregister(indio_dev);</span><br><span class="line">err_iio_register:</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">icm20608_remove</span><span class="params">(<span class="keyword">struct</span> spi_device *spi)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iio_dev</span> *<span class="title">indio_dev</span> =</span> spi_get_drvdata(spi);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> *<span class="title">dev</span>;</span></span><br><span class="line">	</span><br><span class="line">	dev = iio_priv(indio_dev);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1、删除regmap */</span> </span><br><span class="line">	regmap_exit(dev-&gt;regmap);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 2、注销IIO */</span></span><br><span class="line">	iio_device_unregister(indio_dev);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_device_id</span> <span class="title">icm20608_id</span>[] =</span> &#123;</span><br><span class="line">	&#123;<span class="string">&quot;alientek,icm20608&quot;</span>, <span class="number">0</span>&#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">icm20608_of_match</span>[] =</span> &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">&quot;alientek,icm20608&quot;</span> &#125;,</span><br><span class="line">	&#123; <span class="comment">/* Sentinel */</span> &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">spi_driver</span> <span class="title">icm20608_driver</span> =</span> &#123;</span><br><span class="line">	.probe = icm20608_probe,</span><br><span class="line">	.remove = icm20608_remove,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">			.owner = THIS_MODULE,</span><br><span class="line">		   	.name = <span class="string">&quot;icm20608&quot;</span>,</span><br><span class="line">		   	.of_match_table = icm20608_of_match,</span><br><span class="line">		   &#125;,</span><br><span class="line">	.id_table = icm20608_id,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">icm20608_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> spi_register_driver(&amp;icm20608_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">icm20608_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	spi_unregister_driver(&amp;icm20608_driver);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(icm20608_init);</span><br><span class="line">module_exit(icm20608_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;ALIENTEK&quot;</span>);</span><br><span class="line">MODULE_INFO(intree, <span class="string">&quot;Y&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3><span id="5-2-1-probe">5.2.1 probe</span><a href="#5-2-1-probe" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/4.png" alt="image"></p>
<p>还是按照<code>spi子系统框架</code>，<code>probe</code>时利用iio子系统，初始化<code>iio_dev</code>。</p>
<p><code>iio_info</code>属性赋值：</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/5.png" alt="image"></p>
<p><code>iio_channels</code>属性赋值：</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/6.png" alt="image"></p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/7.png" alt="image"></p>
<p><strong>温度通道</strong>：</p>
<ol>
<li><p><code>info_mask_separate</code>设置为<code>IIO_CHAN_INFO_RAW,IIO_CHAN_INFO_SCALE, IIO_CHAN_INFO_OFFSET</code>此通。</p>
<p> <code>IIO_CHAN_INFO_RAW </code>为温度通道的原始值，<code>IIO_CHAN_INFO_OFFSET</code> 是 <code>ICM20608 </code>温度 offset 值，这个要查阅数 据手册。<code>IIO_CHAN_INFO_SCALE </code>是 <code>ICM20608</code> 的比例，也就是一个单位的原始值为多少℃， 这个也要查阅 <code>ICM20608 </code>的数据手册。</p>
</li>
<li><p>扫描元素设置成<code>SCAN_TEMP</code>。</p>
</li>
<li><p>扫描类型：有符号数据，数据位数16位，存储位数16位，右移位数0， 大端传输（一般MSB传输）</p>
</li>
</ol>
<p><strong>陀螺仪通道</strong>：</p>
<ol>
<li><p><code>modified </code>成员变量为 1，所以 <code>channel2 </code>就是<code>通道修饰符</code>，用来指定 X、Y、Z 轴。</p>
</li>
<li><p>扫描元素设置<code>SCAN_GYRO_X, Y,Z</code>。</p>
</li>
<li><p><code>info_mask_separate</code>设置为<code>IIO_CHAN_INFO_RAW, IIO_CHAN_INFO_CALIBBIAS</code>此通。“scale”是比例的意思，在这里就是量程(分辨率)，因为 ICM20608 的陀螺仪和加速度计的量程是可以调整的，量程不同分辨率也就不同。设置每个通道的<code>IIO_CHAN_INFO_RAW</code>和<code>IIO_CHAN_INFO_CALIBBIAS</code>这两个属性都是独立的，<code>IIO_CHAN_INFO_RAW </code>表示 ICM20608 每个通道的原始值，这个肯定 是每个通道独立的。<code>IIO_CHAN_INFO_CALIBBIAS</code> 是 ICM20608 每个通道的校准值，这个是 ICM20608 的特性，不是所有的传感器都有校准值，一切都要以实际所使用的传感器为准。</p>
</li>
<li><p><code>info_mask_shared_by_type</code>设置为<code>IIO_CHAN_INFO_SCALE</code>此通。表示量程分辨率共享对陀螺仪通道。</p>
</li>
<li><p>扫描类型：有符号数据，数据位数16位，存储位数16位，右移位数0， 大端传输（一般MSB传输）</p>
</li>
</ol>
<p><strong>加速度通道</strong>：同理与陀螺仪通道.</p>
<p><code>INDIO_DIRECT_MODE </code>直接模式，提供<code>sysfs</code>接口。</p>
<h3><span id="5-2-2-icm20608-read-raw">5.2.2 icm20608_read_raw</span><a href="#5-2-2-icm20608-read-raw" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/8.png" alt="image"></p>
<h4><span id="5-2-2-1-du-raw-shu-ju">5.2.2.1 读raw数据</span><a href="#5-2-2-1-du-raw-shu-ju" class="header-anchor">#</a></h4><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/9.png" alt="image"></p>
<p><code>icm20608_read_raw</code>会传入具体通道和mask, 比如温度通道的raw,传入<code>ICM20_TEMP_OUT_H</code>寄存器，<code>IIO_MOD_X</code>那么<code>ind</code>就等于0，那么<code>regmap_bulk_read</code>出来就是一个16位的温度值。</p>
<p>同理，读加速度通道，传入<code>ICM20_ACCEL_XOUT_H</code>寄存器，<code>ind = (IIO_MOD_X - IIO_MOD_X )*2 = 0;</code>,因此读出16bit的x数据。再次传入<code>ind  = (IIO_MOD_Y - IIO_MOD_X)*2 = 2</code>,得到<code>ICM20_ACCEL_YOUT_H</code>寄存器，因此读取出16bit的y数据。再次传入<code>ind  = (IIO_MOD_Z - IIO_MOD_X)*2 = 4</code>,得到<code>ICM20_ACCEL_ZOUT_H</code>寄存器,因此读取出16bit的z数据。</p>
<p>同理，读陀螺仪通道。</p>
<h4><span id="5-2-2-2-du-liang-cheng">5.2.2.2 读量程</span><a href="#5-2-2-2-du-liang-cheng" class="header-anchor">#</a></h4><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/10.png" alt="image"></p>
<p>温度通道： 直接用预设量程即可或者<code>val1,val2</code>。分别表示整数，小数。</p>
<p>加速度通道: 获取量程参考数据手册：<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/05/02/imx6ull%E8%A3%B8%E6%9C%BA-SPI/#2-2-1-kong-zhi-ji-cun-qi">icm20608控制寄存器</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17780817.html">icm20608控制寄存器</a></p>
<p>根据读到的寄存器值：<code>regdata</code>配置量程如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * icm20608陀螺仪分辨率，对应250、500、1000、2000，计算方法：</span></span><br><span class="line"><span class="comment"> * 以正负250度量程为例，500/2^16=0.007629，扩大1000000倍，就是7629</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> gyro_scale_icm20608[] = &#123;<span class="number">7629</span>, <span class="number">15258</span>, <span class="number">30517</span>, <span class="number">61035</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * icm20608加速度计分辨率，对应2、4、8、16 计算方法：</span></span><br><span class="line"><span class="comment"> * 以正负2g量程为例，4/2^16=0.000061035，扩大1000000000倍，就是61035</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">int</span> accel_scale_icm20608[] = &#123;<span class="number">61035</span>, <span class="number">122070</span>, <span class="number">244140</span>, <span class="number">488281</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>陀螺仪通道：同理</p>
<p>陀螺仪量程计算：</p>
<p>可选的量程有<code>±250、±500、±1000 和±2000°/s</code>。以<code>± 250</code> 这个量程为例，每个数值对应的度数就是<code> 500/2^10≈0.007629°/s</code>。同理，<code>±500</code> 量程对应 的度数为<code> 0.015258</code>，<code>±1000</code> 量程对应的度数为<code> 0.030517</code>，<code>±2000 </code>量程为<code>0.061035</code>。假设现在设 置量程为<code>±2000</code>，读取到的原始值为 <code>12540</code>，那么对应的度数就是 <code>12540*0.061035≈765.37°/s</code>。 注意，这里扩大了 1000000 倍。</p>
<p>加速度量程计算：</p>
<p>计算方法和陀螺仪一样。这里扩大了 1000000000 倍。</p>
<h4><span id="5-2-2-3-du-offset">5.2.2.3 读offset</span><a href="#5-2-2-3-du-offset" class="header-anchor">#</a></h4><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/11.png" alt="image"></p>
<p>只有温度有<code>offset</code>。</p>
<h3><span id="5-2-3-icm20608-write-raw">5.2.3 icm20608_write_raw</span><a href="#5-2-3-icm20608-write-raw" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/12.png" alt="image"></p>
<p>通过写寄存器来配置量程，校准值。</p>
<h4><span id="5-2-3-1-pei-zhi-liang-cheng">5.2.3.1 配置量程</span><a href="#5-2-3-1-pei-zhi-liang-cheng" class="header-anchor">#</a></h4><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/13.png" alt="image"></p>
<p>根据设置的<code>val</code>量程值，匹配到<code>i</code>量程等级，<code>d&lt;&lt;3</code>然后设置量程等级。</p>
<h4><span id="5-2-3-2-pei-zhi-xiao-zhun-zhi">5.2.3.2 配置校准值</span><a href="#5-2-3-2-pei-zhi-xiao-zhun-zhi" class="header-anchor">#</a></h4><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/14.png" alt="image"></p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/15.png" alt="image"></p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/16.png" alt="image"></p>
<p>根据静态偏移寄存器，进行校准，写入校准值。</p>
<h3><span id="5-2-4-icm20608-write-raw-get-fmt">5.2.4 icm20608_write_raw_get_fmt</span><a href="#5-2-4-icm20608-write-raw-get-fmt" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/17.png" alt="image"></p>
<p>用户空间设置数据格式。</p>
<p>陀螺仪通道：规定用户空间写的陀螺仪分辨率数据要乘以1000000。</p>
<p>加速度通道：规定用户空间写的陀螺仪分辨率数据要乘以1000000000。</p>
<p>比如我们在用户空间要设置加速度计量程为<code>±4g</code>，只需要向 <code>in_accel_scale</code> 写 入<code> 0.000122070</code> ， 那 么 最 终 传 入 到 驱 动 里 面 的 就 是 <code>0.000122070*1000000000=122070</code>。</p>
<h2><span id="5-3-ce-shi">5.3 测试</span><a href="#5-3-ce-shi" class="header-anchor">#</a></h2><p>进入<code>“/sys/bus/iio/devices/”</code>目录：可以看到，此时有两个 IIO 设备<code>“iio:device0”，iio:device0 </code>是 I.MX6ULL 内 部 ADC，<code>iio:device1 </code>才是 ICM20608。</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/18.png" alt="image"></p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/19.png" alt="image"></p>
<p>可以看出，<code>iio:device1 </code>对应<code>spi2.0</code> 上的设备，也就是<code> ICM20608</code>。</p>
<p>此目录下有 很多文件，比如<code>in_accel_scale、in_accel_x_calibias、in_accel_x_raw</code>等，这些就是我们设置的通道。<code>in_accel_scale </code>就是加速度计的比例，也就是分辨率(量程)，<code>in_accel_x_calibias </code>就是加速度 计 X 轴的校准值，<code>in_accel_x_raw </code>就是加速度计的 X 轴原始值。我们在配置通道的时候，设置 了类型相同的所有通道共用<code> SCALE</code>，所以这里只有一个<code> in_accel_scale</code>，而 X、Y、Z 轴的原始值和校准值每个轴都有一个文件，陀螺仪和温度计同理。</p>
<h3><span id="5-3-1-tong-dao-wen-jian-ming-ming-fang-shi">5.3.1 通道文件命名方式</span><a href="#5-3-1-tong-dao-wen-jian-ming-ming-fang-shi" class="header-anchor">#</a></h3><p>源码见4.1.1 <code>iio_device_register_sysfs</code>过程。</p>
<p><code>IIO_CHAN_INFO_RAW</code> 和<code> IIO_CHAN_INFO_CALIBBIAS</code>这两个专属属性，对应<code>in_accel_x_raw </code>和 <code>in_accel_x_calibias </code>这两个文件。</p>
<p>通道的命名:<code>[direction]_[type]_[index]_[modifier]_[info_mask]</code></p>
<p><strong>direction</strong>：为属性对应的方向</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_direction[] = &#123;</span><br><span class="line">	[<span class="number">0</span>] = <span class="string">&quot;in&quot;</span>,</span><br><span class="line">	[<span class="number">1</span>] = <span class="string">&quot;out&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>type</strong>：也就是配置通道的时候 type 值，type 对应的字符可以参考 <code>iio_chan_type_name_spec</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_chan_type_name_spec[] = &#123;</span><br><span class="line">	[IIO_VOLTAGE] = <span class="string">&quot;voltage&quot;</span>,</span><br><span class="line">	[IIO_CURRENT] = <span class="string">&quot;current&quot;</span>,</span><br><span class="line">	[IIO_POWER] = <span class="string">&quot;power&quot;</span>,</span><br><span class="line">	[IIO_ACCEL] = <span class="string">&quot;accel&quot;</span>,</span><br><span class="line">	[IIO_ANGL_VEL] = <span class="string">&quot;anglvel&quot;</span>,</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>index</strong>：索引，如果配置通道的时候设置了 indexed&#x3D;1，那么就会使用通道的 channel 成员变 量来替代此部分命名。比如，有个 ADC 芯片支持 8 个通道，那么就可以使用 channel 来表示对 应的通道，最终在用户空间呈现的每个通道文件名的 index 部分就是通道号。</p>
<p><strong>modifier</strong>：当通道的 modified 成员变量为 1 的时候，channel2 就是修饰符, <code>iio_modifier_names</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_modifier_names[] = &#123;</span><br><span class="line">	[IIO_MOD_X] = <span class="string">&quot;x&quot;</span>,</span><br><span class="line">	[IIO_MOD_Y] = <span class="string">&quot;y&quot;</span>,</span><br><span class="line">	[IIO_MOD_Z] = <span class="string">&quot;z&quot;</span>,</span><br><span class="line">......</span><br><span class="line">	[IIO_MOD_PM4] = <span class="string">&quot;pm4&quot;</span>,</span><br><span class="line">	[IIO_MOD_PM10] = <span class="string">&quot;pm10&quot;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>info_mask</strong>：属性掩码，也就是属性:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> iio_chan_info_postfix[] = &#123;</span><br><span class="line">	[IIO_CHAN_INFO_RAW] = <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_PROCESSED] = <span class="string">&quot;input&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_SCALE] = <span class="string">&quot;scale&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_OFFSET] = <span class="string">&quot;offset&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_CALIBSCALE] = <span class="string">&quot;calibscale&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_CALIBBIAS] = <span class="string">&quot;calibbias&quot;</span>,</span><br><span class="line">......</span><br><span class="line">	[IIO_CHAN_INFO_DEBOUNCE_TIME] = <span class="string">&quot;debounce_time&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_CALIBEMISSIVITY] = <span class="string">&quot;calibemissivity&quot;</span>,</span><br><span class="line">	[IIO_CHAN_INFO_OVERSAMPLING_RATIO] = <span class="string">&quot;oversampling_ratio&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>综上所述，<code>in_accel_x_raw </code>组成形式如图:</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/20.png" alt="image"></p>
<h3><span id="5-3-2-du-qu-raw-shu-ju">5.3.2 读取raw数据</span><a href="#5-3-2-du-qu-raw-shu-ju" class="header-anchor">#</a></h3><p><code>进入“/sys/bus/iio/devices/”</code>目录,<code>cat iio:device1/in_ccel_x</code>,这时驱动中的<code>icm20608_read_raw</code>执行。</p>
<p>读取一下<code> in_accel_scale</code> 这个文件，这是加速度计的分辨率，我们默认设置了加速度计 量程为<code>±16g</code>，因此分辨率为 <code>0.000488281</code>。</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/21.png" alt="image"></p>
<p>这时候有朋友可能会疑问,我们设置加速度计<code>±16g </code>的分辨率为 <code>488281</code>，也就是扩大了1000000000 倍，为啥这里读出来的是 <code>0.000488281</code> 这个原始值？</p>
<p>驱动返回的是<code>IIO_VAL_INT_PLUS_NANO</code>, 因 此 用 户 空 间 得 到 分 辨 率 以 后 会 除 以 1000000000 ， 得 到 真 实 的 分 辨 率 ， <code>488281/1000000000=0.000488281</code>。</p>
<p>再读取一下<code> in_accel_z_raw</code>，加速度计的 Z 轴原始值。静态情况 下 Z 轴应该是 1g 的重力加速度计。</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/22.png" alt="image"></p>
<p><code>2074×0.000488281≈1.01g</code>，此时 Z 轴重力为 1g，结果正确。</p>
<h3><span id="5-3-3-bian-xie-ying-yong-cheng-xu-ce-shi">5.3.3 编写应用程序测试</span><a href="#5-3-3-bian-xie-ying-yong-cheng-xu-ce-shi" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/ioctl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 字符串转数字，将浮点小数字符串转换为浮点数数值 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_FLOAT_DATA_GET(ret, index, str, member)\</span></span><br><span class="line"><span class="meta">	ret = file_data_read(file_path[index], str);\</span></span><br><span class="line"><span class="meta">	dev-&gt;member = atof(str);\</span></span><br><span class="line"><span class="meta">	</span></span><br><span class="line"><span class="comment">/* 字符串转数字，将整数字符串转换为整数数值 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_INT_DATA_GET(ret, index, str, member)\</span></span><br><span class="line"><span class="meta">	ret = file_data_read(file_path[index], str);\</span></span><br><span class="line"><span class="meta">	dev-&gt;member = atoi(str);\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">/* icm20608 iio框架对应的文件路径 */</span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *file_path[] = &#123;</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_scale&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_x_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_x_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_y_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_y_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_z_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_accel_z_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_scale&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_x_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_x_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_y_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_y_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_z_calibbias&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_anglvel_z_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_temp_offset&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_temp_raw&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device1/in_temp_scale&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 文件路径索引，要和file_path里面的文件顺序对应 */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">path_index</span> &#123;</span></span><br><span class="line">	IN_ACCEL_SCALE = <span class="number">0</span>,</span><br><span class="line">	IN_ACCEL_X_CALIBBIAS,</span><br><span class="line">	IN_ACCEL_X_RAW,</span><br><span class="line">	IN_ACCEL_Y_CALIBBIAS,</span><br><span class="line">	IN_ACCEL_Y_RAW,</span><br><span class="line">	IN_ACCEL_Z_CALIBBIAS,</span><br><span class="line">	IN_ACCEL_Z_RAW,</span><br><span class="line">	IN_ANGLVEL_SCALE,</span><br><span class="line">	IN_ANGLVEL_X_CALIBBIAS,</span><br><span class="line">	IN_ANGLVEL_X_RAW,</span><br><span class="line">	IN_ANGLVEL_Y_CALIBBIAS,</span><br><span class="line">	IN_ANGLVEL_Y_RAW,</span><br><span class="line">	IN_ANGLVEL_Z_CALIBBIAS,</span><br><span class="line">	IN_ANGLVEL_Z_RAW,</span><br><span class="line">	IN_TEMP_OFFSET,</span><br><span class="line">	IN_TEMP_RAW,</span><br><span class="line">	IN_TEMP_SCALE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * icm20608数据设备结构体</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span>&#123;</span></span><br><span class="line">	<span class="type">int</span> accel_x_calibbias, accel_y_calibbias, accel_z_calibbias;</span><br><span class="line">	<span class="type">int</span> accel_x_raw, accel_y_raw, accel_z_raw;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> gyro_x_calibbias, gyro_y_calibbias, gyro_z_calibbias;</span><br><span class="line">	<span class="type">int</span> gyro_x_raw, gyro_y_raw, gyro_z_raw;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> temp_offset, temp_raw;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> accel_scale, gyro_scale, temp_scale;</span><br><span class="line"></span><br><span class="line">	<span class="type">float</span> gyro_x_act, gyro_y_act, gyro_z_act;</span><br><span class="line">	<span class="type">float</span> accel_x_act, accel_y_act, accel_z_act;</span><br><span class="line">	<span class="type">float</span> temp_act;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icm20608_dev</span> <span class="title">icm20608</span>;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description			: 读取指定文件内容</span></span><br><span class="line"><span class="comment"> * @param - filename 	: 要读取的文件路径</span></span><br><span class="line"><span class="comment"> * @param - str 		: 读取到的文件字符串</span></span><br><span class="line"><span class="comment"> * @return 				: 0 成功;其他 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">file_data_read</span><span class="params">(<span class="type">char</span> *filename, <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	FILE *data_stream;</span><br><span class="line"></span><br><span class="line">    data_stream = fopen(filename, <span class="string">&quot;r&quot;</span>); <span class="comment">/* 只读打开 */</span></span><br><span class="line">    <span class="keyword">if</span>(data_stream == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s\r\n&quot;</span>, filename);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = <span class="built_in">fscanf</span>(data_stream, <span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">    <span class="keyword">if</span>(!ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;file read error!\r\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(ret == EOF) &#123;</span><br><span class="line">        <span class="comment">/* 读到文件末尾的话将文件指针重新调整到文件头 */</span></span><br><span class="line">        fseek(data_stream, <span class="number">0</span>, SEEK_SET);  </span><br><span class="line">    &#125;</span><br><span class="line">	fclose(data_stream);	<span class="comment">/* 关闭文件 */</span>	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description	: 获取ICM20608数据</span></span><br><span class="line"><span class="comment"> * @param - dev : 设备结构体</span></span><br><span class="line"><span class="comment"> * @return 		: 0 成功;其他 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">sensor_read</span><span class="params">(<span class="keyword">struct</span> icm20608_dev *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 1、获取陀螺仪原始数据 */</span></span><br><span class="line">	SENSOR_FLOAT_DATA_GET(ret, IN_ANGLVEL_SCALE, str, gyro_scale);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ANGLVEL_X_RAW, str, gyro_x_raw);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ANGLVEL_Y_RAW, str, gyro_y_raw);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ANGLVEL_Z_RAW, str, gyro_z_raw);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 2、获取加速度计原始数据 */</span></span><br><span class="line">	SENSOR_FLOAT_DATA_GET(ret, IN_ACCEL_SCALE, str, accel_scale);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ACCEL_X_RAW, str, accel_x_raw);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ACCEL_Y_RAW, str, accel_y_raw);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_ACCEL_Z_RAW, str, accel_z_raw);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 3、获取温度值 */</span></span><br><span class="line">	SENSOR_FLOAT_DATA_GET(ret, IN_TEMP_SCALE, str, temp_scale);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_TEMP_OFFSET, str, temp_offset);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_TEMP_RAW, str, temp_raw);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 3、转换为实际数值 */</span></span><br><span class="line">	dev-&gt;accel_x_act = dev-&gt;accel_x_raw * dev-&gt;accel_scale;</span><br><span class="line">	dev-&gt;accel_y_act = dev-&gt;accel_y_raw * dev-&gt;accel_scale;</span><br><span class="line">	dev-&gt;accel_z_act = dev-&gt;accel_z_raw * dev-&gt;accel_scale;</span><br><span class="line"></span><br><span class="line">	dev-&gt;gyro_x_act = dev-&gt;gyro_x_raw * dev-&gt;gyro_scale;</span><br><span class="line">	dev-&gt;gyro_y_act = dev-&gt;gyro_y_raw * dev-&gt;gyro_scale;</span><br><span class="line">	dev-&gt;gyro_z_act = dev-&gt;gyro_z_raw * dev-&gt;gyro_scale;</span><br><span class="line"></span><br><span class="line">	dev-&gt;temp_act = ((dev-&gt;temp_raw - dev-&gt;temp_offset) / dev-&gt;temp_scale) + <span class="number">25</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @description		: main主程序</span></span><br><span class="line"><span class="comment"> * @param - argc 	: argv数组元素个数</span></span><br><span class="line"><span class="comment"> * @param - argv 	: 具体参数</span></span><br><span class="line"><span class="comment"> * @return 			: 0 成功;其他 失败</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error Usage!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		ret = sensor_read(&amp;icm20608);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123; 			<span class="comment">/* 数据读取成功 */</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;\r\n原始值:\r\n&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;gx = %d, gy = %d, gz = %d\r\n&quot;</span></span><br><span class="line">                   , icm20608.gyro_x_raw, icm20608.gyro_y_raw, icm20608.gyro_z_raw);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ax = %d, ay = %d, az = %d\r\n&quot;</span></span><br><span class="line">                   , icm20608.accel_x_raw, icm20608.accel_y_raw, icm20608.accel_z_raw);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;temp = %d\r\n&quot;</span>, icm20608.temp_raw);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;实际值:&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act gx = %.2f°/S, act gy = %.2f°/S, act gz = %.2f°/S\r\n&quot;</span></span><br><span class="line">                   , icm20608.gyro_x_act, icm20608.gyro_y_act, icm20608.gyro_z_act);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act ax = %.2fg, act ay = %.2fg, act az = %.2fg\r\n&quot;</span></span><br><span class="line">                   , icm20608.accel_x_act, icm20608.accel_y_act, icm20608.accel_z_act);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;act temp = %.2f°C\r\n&quot;</span>, icm20608.temp_act);</span><br><span class="line">		&#125;</span><br><span class="line">		usleep(<span class="number">100000</span>); <span class="comment">/*100ms */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/23.png" alt="image"></p>
<h1><span id="6-iio-shi-yan-cao-zuo-vf610-adc-c">6 IIO实验-操作vf610_adc.c</span><a href="#6-iio-shi-yan-cao-zuo-vf610-adc-c" class="header-anchor">#</a></h1><p>以imx6ull芯片为例子，<code>drivers/iio/adc/vf610_adc.c</code></p>
<h2><span id="6-1-dts-miao-shu">6.1 dts描述</span><a href="#6-1-dts-miao-shu" class="header-anchor">#</a></h2><p>dtsi描述如下：默认是关闭的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">adc1: adc@<span class="number">02198000</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;fsl,imx6ul-adc&quot;</span>, <span class="string">&quot;fsl,vf610-adc&quot;</span>;</span><br><span class="line">	reg = &lt;<span class="number">0x02198000</span> <span class="number">0x4000</span>&gt;;</span><br><span class="line">	interrupts = &lt;GIC_SPI <span class="number">100</span> IRQ_TYPE_LEVEL_HIGH&gt;;</span><br><span class="line">	clocks = &lt;&amp;clks IMX6UL_CLK_ADC1&gt;;</span><br><span class="line">	num-channels = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">	clock-names = <span class="string">&quot;adc&quot;</span>;</span><br><span class="line">	status = <span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们最后在<code> imx6ull-alientek-emmc.dts</code>添加节点内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pinctrl_adc1: adc1grp &#123;</span><br><span class="line">	fsl,pins = &lt;MX6UL_PAD_GPIO1_IO01__GPIO1_IO01 <span class="number">0xb0</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">reg_vref_adc: regulator@<span class="number">2</span> &#123;</span><br><span class="line">	compatible = <span class="string">&quot;regulator-fixed&quot;</span>;</span><br><span class="line">	regulator-name = <span class="string">&quot;VREF_3V3&quot;</span>;</span><br><span class="line">	regulator-min-microvolt = &lt;<span class="number">3300000</span>&gt;;</span><br><span class="line">	regulator-max-microvolt = &lt;<span class="number">3300000</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">&amp;adc1 &#123;</span><br><span class="line">	pinctrl-names = <span class="string">&quot;default&quot;</span>;</span><br><span class="line">	pinctrl<span class="number">-0</span> = &lt;&amp;pinctrl_adc1&gt;;</span><br><span class="line">	num-channels = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">	vref-supply = &lt;&amp;reg_vref_adc&gt;;</span><br><span class="line">	status = <span class="string">&quot;okay&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol>
<li>添加 ADC 使用的<code>GPIO1_IO01</code>引脚配置信息</li>
<li><code>regulators </code>节点下添加参考电源子节点，最后status设置成okay</li>
</ol>
<h2><span id="6-2-shi-neng-adc-qu-dong">6.2 使能 ADC 驱动</span><a href="#6-2-shi-neng-adc-qu-dong" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt; Device Drivers</span><br><span class="line">	-&gt; Industrial I/O support</span><br><span class="line">		-&gt; Analog to digital converters</span><br><span class="line">			-&gt; &lt;*&gt; Freescale vf610 ADC driver <span class="comment">//选中</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/24.png" alt="image"></p>
<p><code>drivers/iio/adc/</code>下的<code>makefile和Kconfig</code>:</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/25.png" alt="image"></p>
<h2><span id="6-3-qu-dong-dai-ma-fen-xi">6.3 驱动代码分析</span><a href="#6-3-qu-dong-dai-ma-fen-xi" class="header-anchor">#</a></h2><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/26.png" alt="image"></p>
<h3><span id="6-3-1-probe">6.3.1 probe</span><a href="#6-3-1-probe" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/27.png" alt="image"></p>
<p>申请初始化iio设备，alloc iio设备有多分一块内存给info结构体。</p>
<p>从dts获取寄存器地址信息，进行ioremap。获取中断号，注册中断服务程序。</p>
<p>获取时钟资源，电源资源，使能电源输出。并且获取电源参考电压<code>vref_uv</code>.</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/28.png" alt="image"></p>
<p>获取adc采样周期，<code>num-channels =2</code>.</p>
<p>中间<code>vf610_adc_cfg_init和vf610_adc_hw_init</code>是ADC controller的寄存器配置不展开介绍。可以参考裸机实验<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17798452.html">IMX6ULL ADC控制器</a></p>
<p>然后设置<code>iio_dev</code>结构体，最后注册iio设备。</p>
<h3><span id="6-3-2-vf610-read-raw">6.3.2 vf610_read_raw</span><a href="#6-3-2-vf610-read-raw" class="header-anchor">#</a></h3><p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/29.png" alt="image"></p>
<p>读取 ADC 原始数据值，type 值为<code> IIO_VOLTAGE</code>，也就是读取电压值。这里<code>info-&gt;value</code>是怎么来的呢？</p>
<p>当然是中断服务程序进行ADC采样啊，如下：</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/30.png" alt="image"></p>
<h2><span id="6-4-yong-hu-tai-ce-shi">6.4 用户态测试</span><a href="#6-4-yong-hu-tai-ce-shi" class="header-anchor">#</a></h2><p>进入<code>/sys/bus/iio/devices/iio:device0 </code>目录下,该<code>iio</code>就是对应<code>vf610</code>这个ADC:</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/31.png" alt="image"></p>
<p><code>in_voltage1_raw：</code>ADC1 通道 1 原始值文件。</p>
<p><code>in_voltage_scale：</code>ADC1 比例文件(分辨率)，单位为 mV。实际电压值<code>(mV)=in_voltage1_raw* in_voltage_scale</code></p>
<p> 我的开发板此时 <code>in_voltage1_raw</code> 和 <code>in_voltage_scale</code> 这两个文件内容如下：</p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/32.png" alt="image"></p>
<p>经过计算，实际电压：<code>991*0.805664062≈798.4mV</code>，也就是<code> 0.7984V</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;unistd.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sys/ioctl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;fcntl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdlib.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 字符串转数字，将浮点小数字符串转换为浮点数数值 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_FLOAT_DATA_GET(ret, index, str, member)\</span></span><br><span class="line"><span class="meta">	ret = file_data_read(file_path[index], str);\</span></span><br><span class="line"><span class="meta">	dev-&gt;member = atof(str);\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">/* 字符串转数字，将整数字符串转换为整数数值 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SENSOR_INT_DATA_GET(ret, index, str, member)\</span></span><br><span class="line"><span class="meta">	ret = file_data_read(file_path[index], str);\</span></span><br><span class="line"><span class="meta">	dev-&gt;member = atoi(str);\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *file_path[] = &#123;</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device0/in_voltage_scale&quot;</span>,</span><br><span class="line">	<span class="string">&quot;/sys/bus/iio/devices/iio:device0/in_voltage1_raw&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">path_index</span> &#123;</span></span><br><span class="line">	IN_VOLTAGE_SCALE = <span class="number">0</span>,</span><br><span class="line">	IN_VOLTAGE_RAW,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">adc_dev</span>&#123;</span></span><br><span class="line">	<span class="type">int</span> raw;</span><br><span class="line">	<span class="type">float</span> scale;</span><br><span class="line">	<span class="type">float</span> act;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">adc_dev</span> <span class="title">imx6ulladc</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">file_data_read</span><span class="params">(<span class="type">char</span> *filename, <span class="type">char</span> *str)</span> &#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	FILE *data_stream;</span><br><span class="line"></span><br><span class="line">    data_stream = fopen(filename, <span class="string">&quot;r&quot;</span>); <span class="comment">/* 只读打开 */</span></span><br><span class="line">    <span class="keyword">if</span>(data_stream == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open file %s\r\n&quot;</span>, filename);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	ret = <span class="built_in">fscanf</span>(data_stream, <span class="string">&quot;%s&quot;</span>, str);</span><br><span class="line">    <span class="keyword">if</span>(!ret) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;file read error!\r\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(ret == EOF) &#123;</span><br><span class="line">        <span class="comment">/* 读到文件末尾的话将文件指针重新调整到文件头 */</span></span><br><span class="line">        fseek(data_stream, <span class="number">0</span>, SEEK_SET);  </span><br><span class="line">    &#125;</span><br><span class="line">	fclose(data_stream);	<span class="comment">/* 关闭文件 */</span>	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">adc_read</span><span class="params">(<span class="keyword">struct</span> adc_dev *dev)</span>&#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> str[<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">	SENSOR_FLOAT_DATA_GET(ret, IN_VOLTAGE_SCALE, str, scale);</span><br><span class="line">	SENSOR_INT_DATA_GET(ret, IN_VOLTAGE_RAW, str, raw);</span><br><span class="line">	<span class="comment">/* 转换得到实际电压值mV */</span></span><br><span class="line">	dev-&gt;act = (dev-&gt;scale * dev-&gt;raw)/<span class="number">1000.f</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">	<span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Error Usage!\r\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		ret = adc_read(&amp;imx6ulladc);</span><br><span class="line">		<span class="keyword">if</span>(ret == <span class="number">0</span>) &#123; 			<span class="comment">/* 数据读取成功 */</span></span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;ADC原始值：%d，电压值：%.3fV\r\n&quot;</span>, imx6ulladc.raw, imx6ulladc.act);</span><br><span class="line">		&#125;</span><br><span class="line">		usleep(<span class="number">100000</span>); <span class="comment">/*100ms */</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意应用程序用到了浮点运算，因此：</p>
<p><code>arm-linux-gnueabihf-gcc -march=armv7-a -mfpu=neon -mfloat-abi=hard adcApp.c -o adcApp</code></p>
<p><img src="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/33.png" alt="image"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/" data-id="cm1dc7q6j000018uf69j25er8" data-title="字符设备驱动-IIO子系统" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-regmap%E5%AD%90%E7%B3%BB%E7%BB%9F/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">字符设备驱动-regmap子系统</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 15.45px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-IIO子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-regmap%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-regmap子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-UART%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-UART子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-RTC%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-RTC子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>uboot-编译defconfig分析 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 版本号 2 MAKEFLAGS 3 设置命令输出详细程度 4 设置编译结果输出位置 5 代码检查 6 子模块编译 7 获取主机架构系统信息 8 设置目标架构、工具链和配置文件 9 调用 scripts&#x2F;Kbuild.include 9.1 build变量 9.1.1 调用scripts&#x2F;Makefile.build   9.2 filechk变量 9.3 if_change">
<meta property="og:type" content="article">
<meta property="og:title" content="uboot-编译defconfig分析">
<meta property="og:url" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 版本号 2 MAKEFLAGS 3 设置命令输出详细程度 4 设置编译结果输出位置 5 代码检查 6 子模块编译 7 获取主机架构系统信息 8 设置目标架构、工具链和配置文件 9 调用 scripts&#x2F;Kbuild.include 9.1 build变量 9.1.1 调用scripts&#x2F;Makefile.build   9.2 filechk变量 9.3 if_change">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/1.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/2.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/3.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/4.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/5.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/6.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/7.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/8.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/9.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/10.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/11.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/12.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/13.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/14.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/15.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/16.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/17.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/18.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/19.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/20.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/21.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/22.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/23.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/24.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/25.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/26.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/27.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/28.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/29.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/30.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/31.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/32.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/33.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/34.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/35.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/36.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/37.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/38.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/39.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/40.png">
<meta property="og:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/41.png">
<meta property="article:published_time" content="2024-06-22T13:21:56.000Z">
<meta property="article:modified_time" content="2024-06-29T18:20:14.598Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="linux系统构建">
<meta property="article:tag" content="boot启动">
<meta property="article:tag" content="uboot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-uboot-编译defconfig分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2024-06-22T13:21:56.000Z" itemprop="datePublished">2024-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      uboot-编译defconfig分析
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-ban-ben-hao">1 版本号</a></li>
<li><a href="#2-makeflags">2 <code>MAKEFLAGS</code></a></li>
<li><a href="#3-she-zhi-ming-ling-shu-chu-xiang-xi-cheng-du">3 设置命令输出详细程度</a></li>
<li><a href="#4-she-zhi-bian-yi-jie-guo-shu-chu-wei-zhi">4 设置编译结果输出位置</a></li>
<li><a href="#5-dai-ma-jian-cha">5 代码检查</a></li>
<li><a href="#6-zi-mo-kuai-bian-yi">6 子模块编译</a></li>
<li><a href="#7-huo-qu-zhu-ji-jia-gou-xi-tong-xin-xi">7 获取主机架构系统信息</a></li>
<li><a href="#8-she-zhi-mu-biao-jia-gou-gong-ju-lian-he-pei-zhi-wen-jian">8 设置目标架构、工具链和配置文件</a></li>
<li><a href="#9-diao-yong-scripts-kbuild-include">9 调用 <code>scripts/Kbuild.include</code></a><ul>
<li><a href="#9-1-build-bian-liang">9.1 <code>build变量</code></a><ul>
<li><a href="#9-1-1-diao-yong-scripts-makefile-build">9.1.1 调用scripts&#x2F;Makefile.build</a></li>
</ul>
</li>
<li><a href="#9-2-filechk-bian-liang">9.2 <code>filechk</code>变量</a></li>
<li><a href="#9-3-if-changed-bian-liang">9.3 if_changed变量</a></li>
<li><a href="#9-4-scripts-makefile-lib-wen-jian-zuo-yong">9.4 <code>scripts/Makefile.lib</code>文件作用</a><ul>
<li><a href="#9-4-1-ding-yi-bian-yi-xuan-xiang">9.4.1 定义编译选项</a></li>
<li><a href="#9-4-2-qu-chong">9.4.2 去重</a></li>
<li><a href="#9-4-3-modules-order">9.4.3 <code>modules.order</code></a></li>
<li><a href="#9-4-4-mu-lu-de-chu-li">9.4.4 目录的处理</a></li>
<li><a href="#9-4-5-she-bei-shu-xiang-guan">9.4.5 设备树相关</a></li>
<li><a href="#9-4-6-tian-jia-lu-jing">9.4.6 添加路径</a></li>
</ul>
</li>
<li><a href="#9-5-scripts-makefile-build-wen-jian-zuo-yong">9.5 <code>scripts/Makefile.build</code>文件作用</a><ul>
<li><a href="#9-5-1-bao-han-include-config-auto-conf">9.5.1 包含<code> include/config/auto.conf</code></a></li>
<li><a href="#9-5-2-bao-han-scripts-kbuild-include">9.5.2 包含<code> scripts/Kbuild.include</code></a></li>
<li><a href="#9-5-3-chu-li-bian-yi-mu-biao">9.5.3 处理编译目标</a></li>
<li><a href="#9-5-4-mo-ren-bian-yi-mu-biao-build">9.5.4 默认编译目标<code>_build</code></a><ul>
<li><a href="#9-5-4-1-builtin-target">9.5.4.1<code>builtin-target</code></a></li>
<li><a href="#9-5-4-2-lib-target">9.5.4.2 <code>lib-target</code></a></li>
<li><a href="#9-5-4-3-extra-y">9.5.4.3 <code>extra-y</code></a></li>
<li><a href="#9-5-4-4-obj-m">9.5.4.4 <code>obj-m</code></a></li>
<li><a href="#9-5-4-5-modorder-target">9.5.4.5 modorder-target</a></li>
<li><a href="#9-5-4-6-subdir-ym">9.5.4.6 subdir-ym</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#10-she-zhi-jiao-cha-bian-yi-qi">10 设置交叉编译器</a></li>
<li><a href="#11-he-xin-bian-liang-dao-chu">11 核心变量导出</a></li>
<li><a href="#12-make-xxx-defconfig-pei-zhi-guo-cheng">12 <code>make xxx_defconfig</code> 配置过程</a><ul>
<li><a href="#12-1-chan-sheng-ban-ben-ri-qi-xin-xi">12.1 产生版本日期信息</a></li>
<li><a href="#12-2-pei-zhi-bian-liang">12.2 配置变量</a></li>
<li><a href="#12-3-zhi-xing-3-ge-yi-lai">12.3 执行3个依赖</a><ul>
<li><a href="#12-3-1-scripts-basic">12.3.1 <code>scripts_basic</code></a><ul>
<li><a href="#12-3-1-1-scripts-makefile-build">12.3.1.1 <code>scripts/Makefile.build</code></a><ul>
<li><a href="#12-3-1-1-1-zhao-dao-mo-ren-mu-biao-build">12.3.1.1.1 找到默认目标<code>_build</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#12-3-2-outputmakefile">12.3.2 <code>outputmakefile</code></a></li>
<li><a href="#12-3-3-force">12.3.3 <code>FORCE</code></a></li>
</ul>
</li>
<li><a href="#12-4-chan-sheng-config">12.4 产生<code>.config</code></a></li>
<li><a href="#12-5-zhi-zuo-defconfig">12.5 制作<code>defconfig</code></a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h2><span id="1-ban-ben-hao">1 版本号</span><a href="#1-ban-ben-hao" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/1.png" alt="image"><br>Top Makefile的开头会有版本描述，<code>VERSION </code>是主版本号，<code>PATCHLEVEL </code>是补丁版本号，<code>SUBLEVEL </code>是次版本号，这三个一 起构成了 uboot 的版本号，比如当前的 uboot 版本号就是<code>2016.03</code>。<code>EXTRAVERSION </code>是附加 版本信息，NAME 是和名字有关的，一般不使用这两个。</p>
<h2><span id="2-makeflags">2 <code>MAKEFLAGS</code></span><a href="#2-makeflags" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/2.png" alt="image"><br>有两个特殊的变量：<code>SHELL</code>和<code>MAKEFLAGS</code>，这两个变量除非使用<code>unexport</code>声明， 否则的话在整个make的执行过程中，它们的值始终自动的传递给子make。<br><code>MAKEFLAGS</code> 追加了一些值，<code>-rR</code>表示禁止使用内置的隐 含规则和变量定义，<code>--include-dir</code>指明搜索路径，<code>$(CURDIR)</code>表示当前目录。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/3.png" alt="image"></p>
<h2><span id="3-she-zhi-ming-ling-shu-chu-xiang-xi-cheng-du">3 设置命令输出详细程度</span><a href="#3-she-zhi-ming-ling-shu-chu-xiang-xi-cheng-du" class="header-anchor">#</a></h2><p>①uboot 默认编译使用短命令。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/4.png" alt="image"><br>②设置变量<code>V=1</code>来实现完整的命令输出。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/5.png" alt="image"><br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/6.png" alt="image"><br>③<code>make -s</code>设置成静默输出，将会<code>silent_输出</code>,不打印任何提示信息。如下：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/7.png" alt="image"><br><code>MAKE_VERSION</code>就是make版本号，我这里是<code>4.2.1</code>。因此<code>filter 4.%,$(MAKE_VERSION)</code>得到的过滤结果不为空。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/8.png" alt="image"></p>
<p>当使用<code>make -s</code>编译的时候，<code>-s</code>会作为 <code>MAKEFLAGS </code>变量的一部分传递给 Makefile。因此<code>$(firstword x$(MAKEFLAGS))得到xrRs</code>，最后<code>quiet=silent</code>_,否则不使用<code>silent_</code>输出。最后使用 <code>export 导出变量 quiet、Q 和 KBUILD_VERBOSE</code>。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/9.png" alt="image"><br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/10.png" alt="image"></p>
<h2><span id="4-she-zhi-bian-yi-jie-guo-shu-chu-wei-zhi">4 设置编译结果输出位置</span><a href="#4-she-zhi-bian-yi-jie-guo-shu-chu-wei-zhi" class="header-anchor">#</a></h2><p>在 make 的时候使用<code>O</code>来指定 输出目录，这么做是为了将源文件 和编译产生的文件分开，当然也可以不指定 O 参数，不指定的话源文件和编译产生的文件都在 同一个目录内。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/11.png" alt="image"><br>判断<code>O</code>是否来自于命令行，如果来自命令行的话，<code>KBUILD_OUTPUT 就为$(O)</code>，也就是输出目录。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/12.png" alt="image"><br>一开始判断<code>KBUILD_OUTPUT </code>是否为空。 如果指定了输出目录就调用 <code>mkdir </code>命令创建目录。</p>
<h2><span id="5-dai-ma-jian-cha">5 代码检查</span><a href="#5-dai-ma-jian-cha" class="header-anchor">#</a></h2><p>命令<code>make C=1</code>使能代码检查，检查那些需要重新编译的文 件。<code>make C=2</code>用于检查所有的源码文件。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/13.png" alt="image"></p>
<h2><span id="6-zi-mo-kuai-bian-yi">6 子模块编译</span><a href="#6-zi-mo-kuai-bian-yi" class="header-anchor">#</a></h2><p>使用命令<code>make M=dir</code>即可，旧语法<code>make SUBDIRS=dir</code>也是支持的。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/14.png" alt="image"><br>如果定 义 了 SUBDIRS或者M,那么<code>KBUILD_EXTMOD</code>就会被赋值。然后进入目标<code>_all 依赖 modules</code>，要先编译出<code> modules</code>，也就是编译模块。<br>否则<code>KBUILD_EXTMOD</code>为空，进入<code>all</code>编译。<br>判断<code>KBUILD_SRC</code>是否为空，如果为空的话就设置变量<code>srctree</code>为当前目录，否则<code>srctree</code>就是<code>KBUILD_SRC</code>。一般不设置 <code>KBUILD_SRC</code>。<br>设置变量<code>src</code>和<code> obj</code>，都为当前目录，设置<code>VPATH</code>，导出量<code> scrtree、objtree 和 VPATH</code>。</p>
<h2><span id="7-huo-qu-zhu-ji-jia-gou-xi-tong-xin-xi">7 获取主机架构系统信息</span><a href="#7-huo-qu-zhu-ji-jia-gou-xi-tong-xin-xi" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/15.png" alt="image"><br>最终开发服务器主机架构和操作系统信息如下:<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/16.png" alt="image"></p>
<h2><span id="8-she-zhi-mu-biao-jia-gou-gong-ju-lian-he-pei-zhi-wen-jian">8 设置目标架构、工具链和配置文件</span><a href="#8-she-zhi-mu-biao-jia-gou-gong-ju-lian-he-pei-zhi-wen-jian" class="header-anchor">#</a></h2><p><code>HOSTARCH是x86_64</code>,我们编译<code>make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf-</code>就是用于设置目标<code> ARCH 和 CROSS_COMPILE</code>。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/17.png" alt="image"><br><code>KCONFIG_CONFIG</code>，这里设置配置文件为<code>.config，.config </code>默认是没有的，需要使用命令<code>make xxx_defconfig</code> 对 uboot 进行配置，配置完成以后就会在 uboot 根目录下生成<code>.config</code>。<br>设置主机编译器<code>HOSTCC，HOSTCXX</code>等。</p>
<h2><span id="9-diao-yong-scripts-kbuild-include">9 调用 <code>scripts/Kbuild.include</code></span><a href="#9-diao-yong-scripts-kbuild-include" class="header-anchor">#</a></h2><p>在整个<code>Kbuild</code>系统中，<code>scripts/Kbuild.include </code>提供了大量通用函数以及变量的定义，这些定义将被 <code>Makefile.build 、Makefile.lib 和 top Makefile</code>频繁调用，以实现相应的功能,<code>scripts/Kbuild.include </code>参与整个内核编译的过程，是编译的核心脚本之一。</p>
<p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/18.png" alt="image"><br><code>Kbuild.include</code>定义了很多变量:<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/19.png" alt="image"><br>里面定了build变量，后面产生配置文件时会用到：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/20.png" alt="image"></p>
<h3><span id="9-1-build-bian-liang">9.1 <code>build变量</code></span><a href="#9-1-build-bian-liang" class="header-anchor">#</a></h3><p><code>build := -f $(srctree)/scripts/Makefile.build obj</code></p>
<p>例如：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">%config: scripts_basic outputmakefile FORCE</span></span><br><span class="line">    <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> <span class="variable">$(build)</span>=scripts/kconfig <span class="variable">$@</span></span><br></pre></td></tr></table></figure>

<p>当我们执行<code>make menuconfig</code>时:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">menuconfig: scripts_basic outputmakefile FORCE</span></span><br><span class="line">    make -f <span class="variable">$(srctree)</span>/scripts/Makefile.build obj=scripts/kconfig menuconfig</span><br></pre></td></tr></table></figure>

<h4><span id="9-1-1-diao-yong-scripts-x2f-makefile-build">9.1.1 调用scripts&#x2F;Makefile.build</span><a href="#9-1-1-diao-yong-scripts-x2f-makefile-build" class="header-anchor">#</a></h4><p>参见后面<code>12.3.1.1节</code>再详细介绍。</p>
<p>与<code>build变量</code>相类似的，还有以下的编译指令:</p>
<p><code>$(modbuiltin)</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modbuiltin := -f <span class="variable">$(srctree)</span>/scripts/Makefile.modbuiltin obj</span><br></pre></td></tr></table></figure>

<p><code>$(dtbinst)</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtbinst := -f <span class="variable">$(srctree)</span>/scripts/Makefile.dtbinst obj</span><br></pre></td></tr></table></figure>

<p><code>$(clean)</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clean := -f <span class="variable">$(srctree)</span>/scripts/Makefile.clean obj</span><br></pre></td></tr></table></figure>

<p><code>$(hdr-inst)</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdr-inst := -f <span class="variable">$(srctree)</span>/scripts/Makefile.headersinst obj</span><br></pre></td></tr></table></figure>

<p>这四条指令，分别对应 <code>內建模块编译</code>、<code>dtb文件安装</code>、<code>目标清除</code>和<code>头文件安装</code>.</p>
<p>9.2 </p>
<h3><span id="9-2-filechk-bian-liang">9.2 <code>filechk</code>变量</span><a href="#9-2-filechk-bian-liang" class="header-anchor">#</a></h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> filechk</span><br><span class="line">    <span class="variable">$(Q)</span>set -e;             \</span><br><span class="line">    mkdir -p <span class="variable">$(<span class="built_in">dir</span> <span class="variable">$@</span>)</span>;         \</span><br><span class="line">    &#123; $(filechk_$(1)); &#125; &gt; <span class="variable">$@</span>.tmp;      \</span><br><span class="line">    if [ -r <span class="variable">$@</span> ] &amp;&amp; cmp -s <span class="variable">$@</span> <span class="variable">$@</span>.tmp; then  \</span><br><span class="line">        rm -f <span class="variable">$@</span>.tmp;           \</span><br><span class="line">    <span class="keyword">else</span>                    \</span><br><span class="line">        <span class="variable">$(kecho)</span> &#x27;  UPD     <span class="variable">$@</span>&#x27;;    \</span><br><span class="line">        mv -f <span class="variable">$@</span>.tmp <span class="variable">$@</span>;        \</span><br><span class="line">    fi</span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<ol>
<li><code>mkdir -p $(dir $@)</code>：如果<code>$@</code>目录不存在，就创建目录，<code>$@</code>是编译规则中的目标部分。($@ 在 Makefile 表目标文件)</li>
<li>执行<code>filechk_$(1)</code>,然后将执行结果保存到 <code>$@.tmp</code>中</li>
<li>对比<code>$@.tmp</code>和<code>$@</code>是否有更新，有更新就使用 <code>$@.tmp</code>，否则删除<code> $@.tmp</code>。</li>
</ol>
<h3><span id="9-3-if-changed-bian-liang">9.3 if_changed变量</span><a href="#9-3-if-changed-bian-liang" class="header-anchor">#</a></h3><p>下一节有详细解析介绍：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/17901135.html">uboot顶层makefile-2编译过程 - fuzidage - 博客园 (cnblogs.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/06/22/uboot-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8BMake%E5%88%86%E6%9E%90/#1-2-2-if-changed-jie-shi">uboot-编译过程Make分析 | Hexo (fuzidage.github.io)</a></p>
<h3><span id="9-4-scripts-makefile-lib-wen-jian-zuo-yong">9.4 <code>scripts/Makefile.lib</code>文件作用</span><a href="#9-4-scripts-makefile-lib-wen-jian-zuo-yong" class="header-anchor">#</a></h3><h4><span id="9-4-1-ding-yi-bian-yi-xuan-xiang">9.4.1 定义编译选项</span><a href="#9-4-1-ding-yi-bian-yi-xuan-xiang" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">asflags-y  += <span class="variable">$(EXTRA_AFLAGS)</span></span><br><span class="line">ccflags-y  += <span class="variable">$(EXTRA_CFLAGS)</span></span><br><span class="line">cppflags-y += <span class="variable">$(EXTRA_CPPFLAGS)</span></span><br><span class="line">ldflags-y  += <span class="variable">$(EXTRA_LDFLAGS)</span></span><br><span class="line"></span><br><span class="line">KBUILD_AFLAGS += $(subdir-asflags-y)</span><br><span class="line">KBUILD_CFLAGS += $(subdir-ccflags-y</span><br></pre></td></tr></table></figure>

<h4><span id="9-4-2-qu-chong">9.4.2 去重</span><a href="#9-4-2-qu-chong" class="header-anchor">#</a></h4><p>如果某个模块已经被定义在obj-y中，就没必要再编译了。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 去除obj-m中已经定义在obj-y中的部分</span></span><br><span class="line">obj-m := <span class="variable">$(<span class="built_in">filter</span>-out $(obj-y)</span>,$(obj-m))</span><br><span class="line"><span class="comment"># 去除lib-y中已经定义在obj-y中的部分</span></span><br><span class="line">lib-y := <span class="variable">$(<span class="built_in">filter</span>-out $(obj-y)</span>, <span class="variable">$(<span class="built_in">sort</span> $(lib-y)</span> $(lib-m)))</span><br></pre></td></tr></table></figure>

<h4><span id="9-4-3-modules-order">9.4.3 <code>modules.order</code></span><a href="#9-4-3-modules-order" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#将obj-y中的目录 dir 修改为 dir/modules.order赋值给modorder，</span></span><br><span class="line"><span class="comment">#将obj-m中的.o修改为.ko赋值给modorder。 </span></span><br><span class="line">modorder    := <span class="variable">$(<span class="built_in">patsubst</span> %/,%/modules.order,\</span></span><br><span class="line"><span class="variable">                 $(<span class="built_in">filter</span> %/, $(obj-y)</span>) $(obj-m:.o=.ko))</span><br></pre></td></tr></table></figure>

<p>内核将编译的外部模块全部记录在<code> modules.order</code> 文件中，以便 <code>modprobe </code>命令在加载卸载时查询使用。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kernel/drivers/input/mouse/psmouse.ko</span><br><span class="line">kernel/drivers/input/misc/100ask_adxl345-spi.ko</span><br><span class="line">kernel/drivers/input/evbug.ko</span><br></pre></td></tr></table></figure>

<h4><span id="9-4-4-mu-lu-de-chu-li">9.4.4 目录的处理</span><a href="#9-4-4-mu-lu-de-chu-li" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#挑选出obj-y 和 obj-m 中的纯目录部分，然后添加到subdir-y和subdir-m中。  </span></span><br><span class="line">__subdir-y  := <span class="variable">$(<span class="built_in">patsubst</span> %/,%,$(<span class="built_in">filter</span> %/, $(obj-y)</span>))</span><br><span class="line">subdir-y    += $(__subdir-y)</span><br><span class="line"></span><br><span class="line">__subdir-m  := <span class="variable">$(<span class="built_in">patsubst</span> %/,%,$(<span class="built_in">filter</span> %/, $(obj-m)</span>))</span><br><span class="line">subdir-m    += $(__subdir-m)</span><br><span class="line"></span><br><span class="line"><span class="comment">#需要被递归搜寻的子路径，带有可编译内部和外部模块的子目录。  </span></span><br><span class="line">subdir-ym   := <span class="variable">$(<span class="built_in">sort</span> $(subdir-y)</span> $(subdir-m))</span><br><span class="line"></span><br><span class="line"><span class="comment">#obj-y 中纯目录部分则将其改名为dir/build-in.a,obj-y的其他部分则不变。  </span></span><br><span class="line">obj-y       := <span class="variable">$(<span class="built_in">patsubst</span> %/, %/built-in.a, $(obj-y)</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#将obj-m中的纯目录部分剔除掉(因为已经在上面加入到subdir-m中了)。</span></span><br><span class="line">obj-m       := <span class="variable">$(<span class="built_in">filter</span>-out %/, $(obj-m)</span>)</span><br></pre></td></tr></table></figure>

<p>   <code>obj-y 和 obj-m </code>的定义中同时夹杂着目标文件和目标文件夹，文件夹当然是不能直接参与编译的，所以需要将文件夹提取出来。</p>
<p>将 <code>obj-y or obj-m</code>中以<code>&quot;/&quot;</code>结尾的纯目录部分提取出来，并赋值给 <code>subdir-ym</code>.</p>
<h4><span id="9-4-5-she-bei-shu-xiang-guan">9.4.5 设备树相关</span><a href="#9-4-5-she-bei-shu-xiang-guan" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">extra-y             += $(dtb-y)</span><br><span class="line">extra-<span class="variable">$(CONFIG_OF_ALL_DTBS)</span> += $(dtb-)</span><br><span class="line"></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(CHECK_DTBS)</span>,)</span><br><span class="line">extra-y += <span class="variable">$(<span class="built_in">patsubst</span> %.dtb,%.dt.yaml, $(dtb-y)</span>)</span><br><span class="line">extra-<span class="variable">$(CONFIG_OF_ALL_DTBS)</span> += <span class="variable">$(<span class="built_in">patsubst</span> %.dtb,%.dt.yaml, $(dtb-)</span>)</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p>将所有的<code>dtb-y</code>赋值给<code>extra-y</code>。</p>
<h4><span id="9-4-6-tian-jia-lu-jing">9.4.6 添加路径</span><a href="#9-4-6-tian-jia-lu-jing" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">extra-y     := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(extra-y)</span>)</span><br><span class="line">always      := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,<span class="variable">$(always)</span>)</span></span><br><span class="line">targets     := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,<span class="variable">$(targets)</span>)</span></span><br><span class="line">modorder    := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,<span class="variable">$(modorder)</span>)</span></span><br><span class="line">obj-m       := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(obj-m)</span>)</span><br><span class="line">lib-y       := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(lib-y)</span>)</span><br><span class="line">subdir-obj-y    := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(subdir-obj-y)</span>)</span><br><span class="line">real-obj-y  := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(real-obj-y)</span>)</span><br><span class="line">real-obj-m  := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(real-obj-m)</span>)</span><br><span class="line">single-used-m   := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(single-used-m)</span>)</span><br><span class="line">multi-used-m    := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(multi-used-m)</span>)</span><br><span class="line">subdir-ym   := <span class="variable">$(<span class="built_in">addprefix</span> <span class="variable">$(obj)</span>/,$(subdir-ym)</span>)</span><br></pre></td></tr></table></figure>

<p>文件的处理最后，给所有的变量加上相应的路径，以便编译的时候进行索引。</p>
<p><code>Makefile.lib </code>通常都被包含在于<code> Makefile.build</code>中，这个变量继承了<code>Makefile.build</code>的 <code>obj </code>变量。而 <code>Makefile.build </code>的<code>obj</code>变量则是通过调用 <code>$(build) </code>时进行赋值的。</p>
<h3><span id="9-5-scripts-makefile-build-wen-jian-zuo-yong">9.5 <code>scripts/Makefile.build</code>文件作用</span><a href="#9-5-scripts-makefile-build-wen-jian-zuo-yong" class="header-anchor">#</a></h3><h4><span id="9-5-1-bao-han-include-config-auto-conf">9.5.1 包含<code> include/config/auto.conf</code></span><a href="#9-5-1-bao-han-include-config-auto-conf" class="header-anchor">#</a></h4><p>包含<code>include/config/auto.conf</code>文件，这个文件的内容是这样的：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_RING_BUFFER=y</span><br><span class="line">CONFIG_HAVE_ARCH_SECCOMP_FILTER=y</span><br><span class="line">CONFIG_SND_PROC_FS=y</span><br><span class="line">CONFIG_SCSI_DMA=y</span><br><span class="line">CONFIG_TCP_MD5SIG=y</span><br><span class="line">CONFIG_KERNEL_GZIP=y</span><br></pre></td></tr></table></figure>

<h4><span id="9-5-2-bao-han-scripts-kbuild-include">9.5.2 包含<code> scripts/Kbuild.include</code></span><a href="#9-5-2-bao-han-scripts-kbuild-include" class="header-anchor">#</a></h4><h4><span id="9-5-3-chu-li-bian-yi-mu-biao">9.5.3 处理编译目标</span><a href="#9-5-3-chu-li-bian-yi-mu-biao" class="header-anchor">#</a></h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#主机程序，在前期的准备过程中可能需要用到，比如make menuconfig时需要准备命令行的图形配置。</span></span><br><span class="line"><span class="keyword">ifneq</span> ($(hostprogs-y)$(hostprogs-m)$(hostlibs-y)$(hostlibs-m)$(hostcxxlibs-y)$(hostcxxlibs-m),)</span><br><span class="line"><span class="keyword">include</span> scripts/Makefile.host</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#判断obj，如果obj没有指定则给出警告 </span></span><br><span class="line"><span class="keyword">ifndef</span> obj</span><br><span class="line"><span class="variable">$(<span class="built_in">warning</span> kbuild: Makefile.build is included improperly)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果有编译库的需求，则给lib-target赋值，并将 $(obj)/lib-ksyms.o 追加到 real-obj-y 中。 </span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">strip</span> $(lib-y)</span> $(lib-m) $(lib-)),)</span><br><span class="line">lib-target := <span class="variable">$(obj)</span>/lib.a</span><br><span class="line">real-obj-y += <span class="variable">$(obj)</span>/lib-ksyms.o</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果需要编译 将要编译进内核(也就是obj-y指定的文件) 的模块，则赋值 builtin-target </span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(<span class="built_in">strip</span> $(real-obj-y)</span> $(need-builtin)),)</span><br><span class="line">builtin-target := <span class="variable">$(obj)</span>/built-in.a</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果定义了 CONFIG_MODULES，则赋值 modorder-target。</span></span><br><span class="line"><span class="keyword">ifdef</span> CONFIG_MODULES</span><br><span class="line">modorder-target := <span class="variable">$(obj)</span>/modules.order</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure>

<p><code>modorder-target</code>将被赋值为<code>$(obj)/modules.order</code>，<code> module.order</code>这个文件记录了可加载模块在<code>Makefile</code>中出现的顺序，主要是提供给modprobe程序在匹配时使用。</p>
<h4><span id="9-5-4-mo-ren-bian-yi-mu-biao-build">9.5.4 默认编译目标<code>_build</code></span><a href="#9-5-4-mo-ren-bian-yi-mu-biao-build" class="header-anchor">#</a></h4><p>例子见<code>12.3.1.1.1</code>。</p>
<h5><span id="9-5-4-1builtin-target">9.5.4.1<code>builtin-target</code></span><a href="#9-5-4-1builtin-target" class="header-anchor">#</a></h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$(builtin-target): $(real-obj-y) FORCE</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> if_changed,ar_builtin)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">real-prereqs = <span class="variable">$(<span class="built_in">filter</span>-out <span class="variable">$(PHONY)</span>, <span class="variable">$^</span>)</span></span><br><span class="line">cmd_ar_builtin = rm -f <span class="variable">$@</span>; <span class="variable">$(AR)</span> rcSTP<span class="variable">$(KBUILD_ARFLAGS)</span> <span class="variable">$@</span> $(real-prereqs)</span><br></pre></td></tr></table></figure>

<p><code>ar_builtin</code>就是执行<code>cmd_ar_builtin</code>, 就是使用<code>ar</code>指令打包成<code> $(builtin-target)</code>,也就是<code>$(obj)/built-in.a</code>。它的依赖文件被保存在 <code>$(real-obj-y) </code>中。</p>
<p><code>$(real-obj-y) </code>在<code>scritps/Makefile.lib</code>被处理出来的变量, 对应目录下的所有目标文件，不包含文件夹。</p>
<h5><span id="9-5-4-2-lib-target">9.5.4.2 <code>lib-target</code></span><a href="#9-5-4-2-lib-target" class="header-anchor">#</a></h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$(lib-target): $(lib-y) FORCE</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> if_changed,ar)</span></span><br></pre></td></tr></table></figure>

<p>同理，最终将调用<code>cmd_ar</code>命令:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">real-prereqs = <span class="variable">$(<span class="built_in">filter</span>-out <span class="variable">$(PHONY)</span>, <span class="variable">$^</span>)</span></span><br><span class="line">cmd_ar = rm -f <span class="variable">$@</span>; <span class="variable">$(AR)</span> rcsTP<span class="variable">$(KBUILD_ARFLAGS)</span> <span class="variable">$@</span> $(real-prereqs)</span><br></pre></td></tr></table></figure>

<p>将本模块中的目标全部打包成<code>$(lib-target)</code>,也就是 <code>$(obj)/lib.a</code></p>
<h5><span id="9-5-4-3-extra-y">9.5.4.3 <code>extra-y</code></span><a href="#9-5-4-3-extra-y" class="header-anchor">#</a></h5><p><code>$(extra-y) </code>在<code>Makefile.lib</code>中被确定，主要负责<code>dtb</code>相关的编译:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">extra-y             += $(dtb-y)</span><br><span class="line">extra-<span class="variable">$(CONFIG_OF_ALL_DTBS)</span> += $(dtb-)</span><br></pre></td></tr></table></figure>

<p><code>Makefile.lib</code> 中可以找到对应的实现:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(obj)</span>/%.dtb: <span class="variable">$(src)</span>/%.dts <span class="variable">$(DTC)</span> FORCE</span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> if_changed_dep,dtc,dtb)</span></span><br></pre></td></tr></table></figure>

<p>调用了<code> cmd_dtc</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cmd_dtc = mkdir -p <span class="variable">$(<span class="built_in">dir</span> $&#123;dtc-tmp&#125;)</span> ; \</span><br><span class="line">    <span class="variable">$(HOSTCC)</span> -E <span class="variable">$(dtc_cpp_flags)</span> -x assembler-with-cpp -o $(dtc-tmp) <span class="variable">$&lt;</span> ; \</span><br><span class="line"></span><br><span class="line">    <span class="variable">$(DTC)</span> -O $(2) -o <span class="variable">$@</span> -b 0 \</span><br><span class="line">        <span class="variable">$(<span class="built_in">addprefix</span> -i,$(<span class="built_in">dir</span> <span class="variable">$&lt;</span>)</span> <span class="variable">$(DTC_INCLUDE)</span>) <span class="variable">$(DTC_FLAGS)</span> \</span><br><span class="line">        -d <span class="variable">$(depfile)</span>.dtc.tmp $(dtc-tmp) ; \</span><br><span class="line"></span><br><span class="line">    cat <span class="variable">$(depfile)</span>.pre.tmp <span class="variable">$(depfile)</span>.dtc.tmp &gt; <span class="variable">$(depfile)</span></span><br></pre></td></tr></table></figure>

<p><code>$(2) </code>为 dtb，<code>-O dtb </code>表示输出文件格式为 dtb 。<code> -o $@</code>, <code>$@ </code>为目标文件，表示输出目标文件，输入文件则是对应的<code> $&lt;</code>。</p>
<h5><span id="9-5-4-4-obj-m">9.5.4.4 <code>obj-m</code></span><a href="#9-5-4-4-obj-m" class="header-anchor">#</a></h5><p>由于它是一系列的 .o 文件，所以它的编译是通过模式规则的匹配完成的。</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(obj)</span>/%.o: <span class="variable">$(src)</span>/%.c <span class="variable">$(recordmcount_source)</span> <span class="variable">$(objtool_dep)</span> FORCE</span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,force_checksrc)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> if_changed_rule,cc_o_c)</span></span><br></pre></td></tr></table></figure>

<p>执行<code>rule_cc_o_c</code>:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> rule_cc_o_c</span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,checksrc)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd_and_fixdep,cc_o_c)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,gen_ksymdeps)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,checkdoc)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,objtool)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,modversions_c)</span></span><br><span class="line">    <span class="variable">$(<span class="built_in">call</span> cmd,record_mcount)</span></span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure>

<p>cmd 函数其实就是执行 <code>cmd_$1</code>,那么也就是上述命令中分别执行 <code>cmd_checksrc,cmd_gen_ksymdeps</code>等等。</p>
<p>其中最重要的指令就是 ： <code>$(call cmd_and_fixdep,cc_o_c)</code>，它对目标文件执行了 <code>fixdep</code>，生成依赖文件，然后执行了<code> cmd_cc_o_c</code>, 这个命令就是真正的编译指令:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd_cc_o_c = <span class="variable">$(CC)</span> <span class="variable">$(c_flags)</span> -c -o <span class="variable">$@</span> <span class="variable">$&lt;</span></span><br></pre></td></tr></table></figure>

<h5><span id="9-5-4-5-modorder-target">9.5.4.5 modorder-target</span><a href="#9-5-4-5-modorder-target" class="header-anchor">#</a></h5><p><code>modorder-target值为</code> $(obj)&#x2F;modules.order<code>，也就是大多数目录下都存在这么一个 </code>modules.orders &#96;文件，来提供一个该目录下编译模块的列表。 </p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$(modorder-target): $(subdir-ym) FORCE</span></span><br><span class="line">    <span class="variable">$(Q)</span>(cat /dev/null; $(modorder-cmds)) &gt; <span class="variable">$@</span></span><br></pre></td></tr></table></figure>

<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modorder-cmds =                     \</span><br><span class="line">    <span class="variable">$(<span class="built_in">foreach</span> m, <span class="variable">$(modorder)</span>,           \</span></span><br><span class="line"><span class="variable">        $(<span class="built_in">if</span> $(<span class="built_in">filter</span> %/modules.order, $m)</span>, \</span><br><span class="line">            cat $m;, echo kernel/$m;))</span><br></pre></td></tr></table></figure>

<p>该操作的目的就是将需要编译的<code>.ko</code>的模块以<code>kernel/$(dir)/*.ko</code>为名记录到 <code>obj-m </code>指定的目录下。</p>
<h5><span id="9-5-4-6-subdir-ym">9.5.4.6 subdir-ym</span><a href="#9-5-4-6-subdir-ym" class="header-anchor">#</a></h5><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">$(subdir-ym):</span></span><br><span class="line">    <span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> <span class="variable">$(build)</span>=<span class="variable">$@</span> need-builtin=<span class="variable">$(<span class="built_in">if</span> $(<span class="built_in">findstring</span> <span class="variable">$@</span>,$(subdir-obj-y)</span>),1)</span><br></pre></td></tr></table></figure>

<p>这就是Kbuild递归遍历子目录编译的策略，对于每个需要递归进入编译的目录，都调用：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(Q)</span><span class="variable">$(MAKE)</span> <span class="variable">$(build)</span>=<span class="variable">$@</span> need-builtin=<span class="variable">$(<span class="built_in">if</span> $(<span class="built_in">findstring</span> <span class="variable">$@</span>,$(subdir-obj-y)</span>),1)</span><br></pre></td></tr></table></figure>

<h2><span id="10-she-zhi-jiao-cha-bian-yi-qi">10 设置交叉编译器</span><a href="#10-she-zhi-jiao-cha-bian-yi-qi" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/21.png" alt="image"></p>
<h2><span id="11-he-xin-bian-liang-dao-chu">11 核心变量导出</span><a href="#11-he-xin-bian-liang-dao-chu" class="header-anchor">#</a></h2><p>在顶层 Makefile 会导出很多变量：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> VERSION PATCHLEVEL SUBLEVEL UBOOTRELEASE UBOOTVERSION</span><br><span class="line"><span class="built_in">export</span> ARCH CPU BOARD VENDOR SOC CPUDIR BOARDDIR</span><br><span class="line"><span class="built_in">export</span> CONFIG_SHELL HOSTCC HOSTCFLAGS HOSTLDFLAGS CROSS_COMPILE AS LD CC</span><br><span class="line"><span class="built_in">export</span> CPP AR NM LDR STRIP OBJCOPY OBJDUMP</span><br><span class="line"><span class="built_in">export</span> MAKE AWK PERL PYTHON</span><br><span class="line"><span class="built_in">export</span> HOSTCXX HOSTCXXFLAGS DTC CHECK CHECKFLAGS</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> KBUILD_CPPFLAGS NOSTDINC_FLAGS UBOOTINCLUDE OBJCOPYFLAGS LDFLAGS</span><br><span class="line"><span class="built_in">export</span> KBUILD_CFLAGS KBUILD_AFLAGS</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/22.png" alt="image"><br>打印出export的这些变量：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/23.png" alt="image"><br>①这些变量来自<code>config.mk</code>，里面定义了<code>ARCH,CPU,BOARD,VENDOR,SOC，BOARDDIR</code>等变量。变 量 <code>ARCH </code>， 值 为 <code>$(CONFIG_SYS_ARCH:&quot;%&quot;=%)</code> ， 也 就 是 提 取<code> CONFIG_SYS_ARCH</code> 里面双引号“”之间的内容。比如 <code>CONFIG_SYS_ARCH=“arm”</code>的话， <code>ARCH=arm</code>。经过展开确定了<code>CPUDIR=arch/arm/cpu/armv7</code>。<br>②这里有一个<code>sinclude</code>指令，<code>sinclude 和 include </code>的功能类似，在 Makefile 中都是读取指定文件内容，这里读取 文件<code>$(srctree)/arch/$(ARCH)/config.mk </code>的内容。<code>sinclude </code>读取的文件如果不存在的话不会报错。<br>③依次包含<code>arch,cpu,soc，vendor,board</code>相关的<code>config.mk</code><br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/24.png" alt="image"><br><code>.config</code>如下：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/25.png" alt="image"></p>
<h2><span id="12-make-xxx-defconfig-pei-zhi-guo-cheng">12 <code>make xxx_defconfig</code> 配置过程</span><a href="#12-make-xxx-defconfig-pei-zhi-guo-cheng" class="header-anchor">#</a></h2><p>输入命令进行配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mx6ull_14x14_ddr512_emmc_defconfig</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/26.png" alt="image"></p>
<h3><span id="12-1-chan-sheng-ban-ben-ri-qi-xin-xi">12.1 产生版本日期信息</span><a href="#12-1-chan-sheng-ban-ben-ri-qi-xin-xi" class="header-anchor">#</a></h3><p>先产生<code>version_h和timestamp_h</code>。<code>version_h</code>记录uboot版本和编译器版本。<code>timestamp_h</code>记录uboot的日期时间戳信息。打开这两个头文件：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/27.png" alt="image"><br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/28.png" alt="image"></p>
<h3><span id="12-2-pei-zhi-bian-liang">12.2 配置变量</span><a href="#12-2-pei-zhi-bian-liang" class="header-anchor">#</a></h3><p><code>MAKECMDGOALS </code>是 make 的一个环境变量，这个变量会保存你所指 定的终极目标列表，比如执行<code>make mx6ull_alientek_emmc_defconfig</code>，那么 <code>MAKECMDGOALS </code>就为 <code>mx6ull_alientek_emmc_defconfig</code>。<code>filter</code>函数将 <code>MAKECMDGOALS</code> 中符合<code>no-dot-config-targets</code>的部分过滤出来，可以看到为空，所以<code>dot-config</code>还是等于1.</p>
<p><code>KBUILD_EXTMOD</code>前面提到没有编译子模块，<code>KBUILD_EXTMOD</code>为空，进入，在判断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifneq ($(filter config %config,$(MAKECMDGOALS),)</span><br></pre></td></tr></table></figure>
<p>当<code>make mx6ull_alientek_emmc_defconfig</code>, 明显过滤出来不为空，因此<code>config-targets=1</code>.</p>
<p><code>words $(MAKECMDGOALS)</code>等于1，最后得到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">config-targets = 1</span><br><span class="line">mixed-targets = 0</span><br><span class="line">dot-config = 1</span><br></pre></td></tr></table></figure>

<h3><span id="12-3-zhi-xing-3-ge-yi-lai">12.3 执行3个依赖</span><a href="#12-3-zhi-xing-3-ge-yi-lai" class="header-anchor">#</a></h3><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/29.png" alt="image"><br><code>KBUILD_DEFCONFIG</code>等于<code>mx6ull_14x14_ddr512_emmc_defconfig</code>，<code> KBUILD_KCONFIG</code>等于空，导出。<br>匹配到<code>%config</code>， 执行<code>scripts_basic、outputmakefile 和 FORCE </code>3个依赖.<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/30.png" alt="image"></p>
<h4><span id="12-3-1-scripts-basic">12.3.1 <code>scripts_basic</code></span><a href="#12-3-1-scripts-basic" class="header-anchor">#</a></h4><p><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/31.png" alt="image"></p>
<p><code>scripts/Kbuild.include</code>定义了<code>build</code>变量。<code>$Q$(MAKE) $(build)=scripts/basic</code>展开<code>build</code>变量后得：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -f ./scripts/Makefile.build obj=scripts/basic</span><br></pre></td></tr></table></figure>

<h5><span id="12-3-1-1-scripts-makefile-build">12.3.1.1 <code>scripts/Makefile.build</code></span><a href="#12-3-1-1-scripts-makefile-build" class="header-anchor">#</a></h5><p><code>scripts_basic </code>会调用文件<code>./scripts/Makefile.build</code>,打开这个文件：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/32.png" alt="image"></p>
<p>这里<code>$(obj)=scripts/basic, patsubst </code>是替换函数在<code>scripts/basic</code>中查找符合<code>tpl/%</code>的部分，然后将<code>tpl/</code>取消掉，但是 <code>scripts/basic</code>没有<code>tpl/</code>，所以<code> src= scripts/basic</code>。两个<code>ifeq ($(obj),$(src))</code>都满足条件，最终<code>prefix等于.</code>。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/33.png" alt="image"><br><code>kbuild-dir </code>展开后为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">if</span> $(filter /%, scripts/basic), scripts/basic, ./scripts/basic)</span><br></pre></td></tr></table></figure>
<p>因为没有以<code>/</code>为开头的单词，所以<code>$(filter /%, scripts/basic)</code>的结果为空，<code>kbuilddir=./scripts/basic</code>。<br><code>kbuild-file </code>展开后为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">if</span> $(wildcard ./scripts/basic/Kbuild), ./scripts/basic/Kbuild, ./scripts/basic/Makefile)</span><br></pre></td></tr></table></figure>
<p><code>scrpts/basic </code>目录中没有<code>Kbuild</code>这个文件，所以<code> kbuild-file= ./scripts/basic/Makefile</code>.<br><code>scripts/Makefile.build</code>文件包含<code>/scripts/basic/Makefile</code></p>
<h6><span id="12-3-1-1-1-zhao-dao-mo-ren-mu-biao-build">12.3.1.1.1 找到默认目标<code>_build</code></span><a href="#12-3-1-1-1-zhao-dao-mo-ren-mu-biao-build" class="header-anchor">#</a></h6><p>再继续分析<code>scripts/Makefile.build</code>：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/34.png" alt="image"></p>
<p><code>__build </code>是默认目标，因为命令<code>@make -f ./scripts/Makefile.build obj=scripts/basic</code>没有指定目标，所以会使用到默认目标：<code>__build</code>。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/35.png" alt="image"></p>
<p>顶层 Makefile 中，<code>KBUILD_BUILTIN 为 1</code>， <code>KBUILD_MODULES 为 0</code>，因此展开后目标<code>__build </code>为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__build:$(builtin-target) $(lib-target) $(extra-y)) $(subdir-ym) $(always)</span><br><span class="line">@:</span><br></pre></td></tr></table></figure>
<p>直接打印出这5个目标：所以最终只有一个依赖<code>scripts/basic/fixdep</code>要执行，产生<code>fixdep</code>.<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/36.png" alt="image"></p>
<p>执行打印如下：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/37.png" alt="image"><br>至此第一个依赖<code>scripts_basic</code>就结束了。<br>总结：<code>scripts_basic</code>就是利用<code>scripts/Makefile.build</code>去找到<code>_build</code>目标，然后去<code>scripts/basic</code>目录编译出<code>fixdep</code>.</p>
<h4><span id="12-3-2-outputmakefile">12.3.2 <code>outputmakefile</code></span><a href="#12-3-2-outputmakefile" class="header-anchor">#</a></h4><p>由于<code>KBUILD_SRC</code>为空，不执行。否则会为源码路径创建<code>source</code>这个符号链接，执行<code>mkmakefile</code>。</p>
<h4><span id="12-3-3-force">12.3.3 <code>FORCE</code></span><a href="#12-3-3-force" class="header-anchor">#</a></h4><p>Makefile最底下定了<code>FORCE</code>目标，可以看到什么都不执行。<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/38.png" alt="image"></p>
<p>FORCE的作用：</p>
<p>可以看到它也是一个目标，没有依赖文件且没有命令部分，由于它没有命令生成FORCE，所以每次都会被更新。</p>
<p>所以它的作用就是：FORCE作为依赖时，就导致依赖列表中每次都有FORCE依赖被更新，导致目标每次被重新编译生成。</p>
<h3><span id="12-4-chan-sheng-config">12.4 产生<code>.config</code></span><a href="#12-4-chan-sheng-config" class="header-anchor">#</a></h3><p>回到<code>%config </code>处：<br><code>$(Q)$(MAKE) $(build)=scripts/kconfig $@</code>展开后</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -f ./scripts/Makefile.build obj=scripts/kconfig mx6ull_14x14_ddr512_emmc_defconfig</span><br></pre></td></tr></table></figure>

<p>再次进入<code>scripts/Makefile.build， 用echo</code>得到一些变量值:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kbuild-dir = ./scripts/kconfig</span><br><span class="line">kbuild-file = ./scripts/kconfig/Makefile</span><br><span class="line">include ./scripts/kconfig/Makefile</span><br></pre></td></tr></table></figure>
<p>打开<code>./scripts/kconfig/Makefile</code>：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/39.png" alt="image"><br><code>%_defconfig: $(obj)/conf</code>匹配到我们的<code>mx6ull_14x14_ddr512_emmc_defconfig</code>，先编译依赖<code>scripts/kconfig/conf</code>,编译生成<code>scripts/kconfig/conf</code>如下：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/40.png" alt="image"><br>最终利用<code>conf</code>工具从<code>configs</code>目录找到<code>mx6ull_14x14_ddr512_emmc_defconfig</code>，将配置写成<code>.config</code>文件。<br>总结<code>defconfig</code>配置过程：<br><img src="/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/41.png" alt="image"></p>
<h3><span id="12-5-zhi-zuo-defconfig">12.5 制作<code>defconfig</code></span><a href="#12-5-zhi-zuo-defconfig" class="header-anchor">#</a></h3><p>如果没有对应的<code>defconfig</code>可以找一个与自己板级信息类似的defconfig生成一个<code>.config</code>，再通过<code>menuconfig</code>来完成自己board的配置，并最后通过<code>savedefconfig</code>保存为自己<code>board的defconfig</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">make CROSS_COMPILE=aarch64-linux-gnu- evb-rk3399_defconfig</span><br><span class="line">make menuconfig</span><br><span class="line">make savedefconfig</span><br><span class="line">cp defconfig configs/my_defconfig</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/22/uboot-%E7%BC%96%E8%AF%91defconfig%E5%88%86%E6%9E%90/" data-id="clzp8utta002r9oufabj7709j" data-title="uboot-编译defconfig分析" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/06/22/uboot-%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8BMake%E5%88%86%E6%9E%90/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          uboot-编译过程Make分析
        
      </div>
    </a>
  
  
    <a href="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">uboot-命令和环境变量</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 12px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 11px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 13px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-pinctrl子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-gpio子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E7%94%A8%E6%88%B7%E6%80%81%E6%9E%84%E9%80%A0IP%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E4%BD%93%E5%92%8C%E8%AF%BB%E5%86%99%E5%AF%84%E5%AD%98%E5%99%A8/">字符设备驱动-用户态构造IP寄存器结构体和读写寄存器</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-ioctl%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/">字符设备驱动-ioctl命令详解</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-misc%E6%9D%82%E9%A1%B9%E8%AE%BE%E5%A4%87/">字符设备驱动-misc杂项设备</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
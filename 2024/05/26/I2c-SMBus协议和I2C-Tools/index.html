<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>I2C-SMBus协议和I2C Tool | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 SMBus协议 1.1 SMBus 是 I2C 协议的一个子集 1.2 和I2C协议特性对比 1.3 SMBus数据格式 1.3.1 SMBus Quick Command 1.3.2 SMBus Receive Byte 1.3.3 SMBus Send Byte 1.3.4 SMBus Read Byte 1.3.5 SMBus Read Word 1.3.6 SMBus Wri">
<meta property="og:type" content="article">
<meta property="og:title" content="I2C-SMBus协议和I2C Tool">
<meta property="og:url" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 SMBus协议 1.1 SMBus 是 I2C 协议的一个子集 1.2 和I2C协议特性对比 1.3 SMBus数据格式 1.3.1 SMBus Quick Command 1.3.2 SMBus Receive Byte 1.3.3 SMBus Send Byte 1.3.4 SMBus Read Byte 1.3.5 SMBus Read Word 1.3.6 SMBus Wri">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/1.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/2.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/3.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/4.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/5.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/6.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/7.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/8.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/9.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/10.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/11.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/12.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/13.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/14.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/15.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/16.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/17.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/18.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/19.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/20.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/21.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/22.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/23.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/24.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/25.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/26.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/27.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/28.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/29.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/30.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/31.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/32.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/33.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/34.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/35.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/36.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/37.png">
<meta property="og:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/38.png">
<meta property="article:published_time" content="2024-05-26T07:00:39.000Z">
<meta property="article:modified_time" content="2024-05-26T08:34:54.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="通信协议">
<meta property="article:tag" content="开源插件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-I2c-SMBus协议和I2C-Tools" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T07:00:39.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      I2C-SMBus协议和I2C Tool
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-smbus-xie-yi">1 SMBus协议</a><ul>
<li><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</a></li>
<li><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</a></li>
<li><a href="#1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</a><ul>
<li><a href="#1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</a></li>
<li><a href="#1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</a></li>
<li><a href="#1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</a></li>
<li><a href="#1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</a></li>
<li><a href="#1-3-5-smbus-read-word">1.3.5 SMBus Read Word</a></li>
<li><a href="#1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</a></li>
<li><a href="#1-3-7-smbus-write-word">1.3.7 SMBus Write Word</a></li>
<li><a href="#1-3-8-smbus-block-read">1.3.8 SMBus Block Read</a></li>
<li><a href="#1-3-8-smbus-block-write">1.3.8 SMBus Block Write</a></li>
<li><a href="#1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</a></li>
<li><a href="#1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</a></li>
</ul>
</li>
<li><a href="#1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</a><ul>
<li><a href="#1-4-1-i2c-block-read">1.4.1 I2C Block Read</a></li>
<li><a href="#1-4-2-i2c-block-write">1.4.2 I2C Block Write</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-i2c-tools">2 I2C Tools</a><ul>
<li><a href="#2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</a></li>
<li><a href="#2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</a><ul>
<li><a href="#2-2-1-i2c-adapter">2.2.1 i2c_adapter</a></li>
<li><a href="#2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</a></li>
<li><a href="#2-3-4-i2c-device-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</a></li>
<li><a href="#2-3-5-i2c-msg">2.3.5 i2c_msg</a></li>
</ul>
</li>
<li><a href="#2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</a><ul>
<li><a href="#2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</a></li>
<li><a href="#2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</a></li>
<li><a href="#2-3-3-bian-yi">2.3.3 编译</a></li>
</ul>
</li>
<li><a href="#2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</a><ul>
<li><a href="#2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</a></li>
<li><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</a></li>
<li><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</a></li>
<li><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</a></li>
</ul>
</li>
<li><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</a><ul>
<li><a href="#2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</a><ul>
<li><a href="#2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</a></li>
<li><a href="#2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</a></li>
<li><a href="#2-5-1-3-zhi-jie-shi-yong-read-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-smbus-xie-yi">1 SMBus协议</span><a href="#1-smbus-xie-yi" class="header-anchor">#</a></h1><h2><span id="1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</span><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji" class="header-anchor">#</a></h2><p>SMBus: System Management Bus，系统管理总线。SMBus 最初的目的是为智能电池、充电电池、其他微控制器之间的通信链路而定义的。SMBus 也被用来连接各种设备，包括电源相关设备，系统传感器，EEPROM 通讯设备等等。SMBus 为系统和电源管理这样的任务提供了一条控制总线，使用 SMBus 的系 统，设备之间发送和接收消息都是通过 SMBus，而不是使用单独的控制线，这样可以节省设备的管脚数。</p>
<p>SMBus 是基于 I2C 协议的，SMBus 要求更严格，SMBus 是 I2C 协议的子集。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/1.png" alt="img"></p>
<h2><span id="1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</span><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi" class="header-anchor">#</a></h2><p>SMBus 有哪些更严格的要求？跟一般的 I2C 协议有哪些差别？</p>
<ol>
<li>VDD 的极限值不一样<br>　　1.1 I2C 协议：范围很广，甚至讨论了高达 12V 的情况<br>　　　　　　　　　　　　　　　　1.2 SMBus：1.8V~5V</li>
<li>速率更高<br>　　I2C 协议：时钟频率最小值无限制，Clock Stretching 时长也没有限制<br>　　　　　　　　　　　　　　　　SMBus：时钟频率最小值是 10KHz，Clock Stretching 的最大时间值也有限制</li>
<li>地址回应(Address Acknowledge)：一个 I2C 设备接收到它的设备地址后， 是否必须发出回应信号？<br>　　I2C 协议：没有强制要求必须发出回应信号<br>　　　　　　　　　　　　　　　　SMBus：强制要求必须发出回应信号，这样对方才知道该设备的状态： busy，failed，或是被移除了</li>
<li>SMBus 协议明确了数据的传输格式<br>　　I2C 协议：它只定义了怎么传输数据，但是并没有定义数据的格式，这完全由设备来定义<br>　　　　　　　　　　　　　　　　SMBus：定义了几种数据格式</li>
<li><code>REPEATED START Condition(重复发出 S 信号)</code><br>　　比如读 EEPROM 时，涉及 2 个操作：<br>　　　　　　　　　　　　　　​	 把存储地址发给设备<br>　　　　　　　　　　　　　　​	 读数据<br>　　　　　　　　　　　　　　在写、读之间，可以不发出 P 信号，而是直接发出 S 信号：这个 S 信号就是<br>　　　　　　　　　　　　　　<code>REPEATED START</code></li>
</ol>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/2.png" alt="img"></p>
<h2><span id="1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</span><a href="#1-3-smbus-shu-ju-ge-shi" class="header-anchor">#</a></h2><p>下面文档中的 Functionality flag 是 Linux 的某个 I2C 控制器驱动所支持的功能。比如 Functionality flag: I2C_FUNC_SMBUS_QUICK，表示需要I2C 控制器支持 SMBus Quick Command。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">symbols(符号)：</span><br><span class="line">S (<span class="number">1</span> bit) : Start <span class="title function_">bit</span><span class="params">(开始位)</span></span><br><span class="line">　<span class="title function_">Sr</span> <span class="params">(<span class="number">1</span> bit)</span> : 重复的开始位</span><br><span class="line">　<span class="title function_">P</span> <span class="params">(<span class="number">1</span> bit)</span> : Stop <span class="title function_">bit</span><span class="params">(停止位)</span></span><br><span class="line">　R/W# <span class="params">(<span class="number">1</span> bit)</span> : Read/Write bit. Rd equals 1, Wr equals 0.<span class="params">(读写位)</span></span><br><span class="line">　A, <span class="title function_">N</span> <span class="params">(<span class="number">1</span> bit)</span> : Accept and reverse accept bit.<span class="params">(回应位)</span></span><br><span class="line">　<span class="title function_">Address</span><span class="params">(<span class="number">7</span> bits)</span>: I2C 7 bit address. Note that this can be expanded as usual to get a 10 bit I2C address.<span class="params">(地址位，<span class="number">7</span> 位地址)</span></span><br><span class="line">　Command <span class="title function_">Code</span> <span class="params">(<span class="number">8</span> bits)</span>: Command byte, a data byte which often selects a <span class="keyword">register</span> on the device.<span class="params">(命令字节，一般用来选择芯片内部的寄存器)</span></span><br><span class="line">  Data <span class="title function_">Byte</span> <span class="params">(<span class="number">8</span> bits)</span>: A plain data byte. Sometimes, I write DataLow, DataHigh <span class="keyword">for</span> 16 bit data.<span class="params">(数据字节，<span class="number">8</span> 位；如果是 <span class="number">16</span> 位数据的话，用 <span class="number">2</span> 个字节来表示：DataLow、DataHigh)</span></span><br><span class="line">　<span class="title function_">Count</span> <span class="params">(<span class="number">8</span> bits)</span>: A data byte containing the length of a block operation.<span class="params">(在 block 操作总，表示数据长度)</span></span><br><span class="line">　[..]: Data sent by I2C device, as opposed to data sent by the host adapter.<span class="params">(中括号表示 I2C 设备发送的数据，没有中括号表示 host adapter 发送的数据)</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</span><a href="#1-3-1-smbus-quick-command" class="header-anchor">#</a></h3><p>只是用来发送一位数据：R&#x2F;W#本意是用来表示读或写，但是在 SMBus 里可以用来表示其他含义。比如某些开关设备，可以根据这一位来决定是打开还是关闭.</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/3.png" alt="img"></p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_QUICK</strong></p>
<h3><span id="1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</span><a href="#1-3-2-smbus-receive-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/4.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte()</code>。读取一个字节，Host adapter 接收到一个字节后不需要发出回应信号(上图中 N 表示不回应)。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</span><a href="#1-3-3-smbus-send-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/5.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte()</code>。发送一个字节。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</span><a href="#1-3-4-smbus-read-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/6.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取一个字节的数据。上面介绍的 SMBus Receive Byte 是不发送 Comand，直接读取数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BYTE_DATA</strong></p>
<h3><span id="1-3-5-smbus-read-word">1.3.5 SMBus Read Word</span><a href="#1-3-5-smbus-read-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/7.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取 2 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_WORD_DATA</strong></p>
<h3><span id="1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</span><a href="#1-3-6-smbus-write-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/8.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE_DATA</strong></p>
<h3><span id="1-3-7-smbus-write-word">1.3.7 SMBus Write Word</span><a href="#1-3-7-smbus-write-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/9.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_WORD_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-read">1.3.8 SMBus Block Read</span><a href="#1-3-8-smbus-block-read" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/10.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发起度操作：</p>
<p>　　1. 先读到一个字节(Block Count)，表示后续要读的字节数<br>　　1.  然后读取全部数据</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BLOCK_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-write">1.3.8 SMBus Block Write</span><a href="#1-3-8-smbus-block-write" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/11.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 Byte Conut(表示后续要发出的数据字节数)，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BLOCK_DATA</strong></p>
<h3><span id="1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</span><a href="#1-3-9-smbus-block-write-block-read-process-call" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/12.png" alt="img"></p>
<p>先写一块数据，再读一块数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_BLOCK_PROC_CALL</strong></p>
<h3><span id="1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</span><a href="#1-3-10-packet-error-checking-pec" class="header-anchor">#</a></h3><p>PEC 是一种错误校验码，如果使用 PEC，那么在 P 信号之前，数据发送方要发送一个字节的 PEC 码(它是 CRC-8 码)。以 SMBus Send Byte 为例，下图中，一个未使用 PEC，另一个使用 PEC：(一般很少使用)</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/13.png" alt="img"></p>
<h2><span id="1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</span><a href="#1-4-i2c-shu-ju-ge-shi" class="header-anchor">#</a></h2><h3><span id="1-4-1-i2c-block-read">1.4.1 I2C Block Read</span><a href="#1-4-1-i2c-block-read" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续读出多个字节。它跟 SMBus Block Read 的差别在于设备发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/14.png" alt="img"></p>
<p>I2C-tools 中的函数：&#96;i2c_smbus_read_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，直接读出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_I2C_BLOCK</strong></p>
<h3><span id="1-4-2-i2c-block-write">1.4.2 I2C Block Write</span><a href="#1-4-2-i2c-block-write" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续发出多个字节。它跟 SMBus Block Write 的差别在于发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/15.png" alt="img"></p>
<p>I2C-tools 中的函数：i2c_smbus_write_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 data，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_I2C_BLOCK</strong></p>
<h1><span id="2-i2c-tools">2 I2C Tools</span><a href="#2-i2c-tools" class="header-anchor">#</a></h1><h2><span id="2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</span><a href="#2-1-i2c-kong-zhi-qi-kuang-jia" class="header-anchor">#</a></h2><p>APP 访问硬件肯定是需要驱动程序的，对于 I2C 设备，linux内核提供了默认的驱动程序 drivers&#x2F;i2c&#x2F;i2c-dev.c，通过它可以直接使用下面的 I2C 控制器驱动程序来 访问 I2C 设备。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/16.png" alt="img"></p>
<h2><span id="2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</span><a href="#2-2-i2c-shu-ju-jie-gou" class="header-anchor">#</a></h2><h3><span id="2-2-1-i2c-adapter">2.2.1 i2c_adapter</span><a href="#2-2-1-i2c-adapter" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/17.png" alt="img"></p>
<p>i2c_adapter 表示一个 I2C BUS，或称为 I2C Controller，里面有 2 个重要的成员：</p>
<ol>
<li>nr：第几个 I2C BUS(I2C Controller)</li>
<li>i2c_algorithm，里面有该 I2C BUS 的传输函数，用来收发 I2C 数据</li>
</ol>
<p>怎么表示 I2C Controller , 一个芯片里可能有多个 I2C Controller，比如第 0 个、第 1 个、……</p>
<h3><span id="2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</span><a href="#2-2-3-i2c-algorithm" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/18.png" alt="img"></p>
<h3><span id="2-3-4-i2c-device-x2f-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</span><a href="#2-3-4-i2c-device-x2f-i2c-client" class="header-anchor">#</a></h3><p>一个 I2C Device，一定有设备地址， 那它连接在哪个 I2C Controller 上，即对应的 i2c_adapter 是什么。</p>
<p>使用 i2c_client 来表示一个 I2C Device。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/19.png" alt="img"></p>
<h3><span id="2-3-5-i2c-msg">2.3.5 i2c_msg</span><a href="#2-3-5-i2c-msg" class="header-anchor">#</a></h3><p>在上面的i2c_algorithm结构体中可以看到要传输的数据被称为：i2c_msg</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/20.png" alt="img"></p>
<p>flags： 用来表示传输方向：bit 0 等于 I2C_M_RD 表示 读，bit 0 等于 0 表示写。一个 i2c_msg 要么是读，要么是写<br>举例：设备地址为 0x50 的 EEPROM，要读取它里面存储地址为 0x10 的一个字节， 应该构造几个 i2c_msg？<br>要构造 2 个 i2c_msg :</p>
<ol>
<li><p>第一个 i2c_msg 表示写操作，把要访问的存储地址 0x10 发给设备</p>
</li>
<li><p>第二个 i2c_msg 表示读操作,并且返回读出的数据</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="comment">//例如：</span></span><br><span class="line">　　u8 data_addr = <span class="number">0x10</span>;</span><br><span class="line">　　i8 data;</span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msgs</span>[2];</span></span><br><span class="line">　　</span><br><span class="line">　　msgs[<span class="number">0</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].flags = <span class="number">0</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].buf = &amp;data_addr;</span><br><span class="line">　　msgs[<span class="number">1</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].flags = I2C_M_RD;</span><br><span class="line">　　msgs[<span class="number">1</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].buf = &amp;data;</span><br></pre></td></tr></table></figure>

<h2><span id="2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</span><a href="#2-3-i2c-tools-yi-zhi" class="header-anchor">#</a></h2><h3><span id="2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</span><a href="#2-3-1-yuan-ma-xia-zai" class="header-anchor">#</a></h3><p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/">https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</a></p>
<h3><span id="2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</span><a href="#2-3-2-gong-ju-lian-pei-zhi" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ARCH=arm</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueab ihf_sdk-buildroot/bin</span><br></pre></td></tr></table></figure>

<h3><span id="2-3-3-bian-yi">2.3.3 编译</span><a href="#2-3-3-bian-yi" class="header-anchor">#</a></h3><p>修改 I2C-Tools 的 Makefile 指定交叉编译工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC ?= gcc</span><br><span class="line">AR ?= ar</span><br><span class="line">STRIP ?= strip</span><br></pre></td></tr></table></figure>

<p>改为(指定交叉编译工具链前缀, 去掉问号)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC = $(CROSS_COMPILE)gcc</span><br><span class="line">AR = $(CROSS_COMPILE)ar</span><br><span class="line">STRIP = $(CROSS_COMPILE)strip</span><br></pre></td></tr></table></figure>

<p>在 Makefile 中，“?&#x3D;”在第一次设置变量时才会起效果，如果之前设置过该变量，则不会起效果。</p>
<p>执行 make 时，是动态链接，需要把 libi2c.so 也放到单板上。 想静态链接的话，执行：make USE_STATIC_LIB&#x3D;1</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/21.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/22.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/23.png" alt="img"></p>
<h2><span id="2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</span><a href="#2-4-i2c-tools-shi-yong" class="header-anchor">#</a></h2><h3><span id="2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</span><a href="#2-4-1-i2cdetect-i2c-jian-ce" class="header-anchor">#</a></h3><p>&#x2F;&#x2F; 列出当前的 I2C Adapter(或称为 I2C Bus、I2C Controller)</p>
<p><code>i2cdetect -l</code></p>
<p>&#x2F;&#x2F; 打印某个 I2C Adapter 的 Functionalities, I2CBUS 为 0、1、2 等整数 i2cdetect -F I2CBUS</p>
<p>&#x2F;&#x2F; 看看有哪些 I2C 设备, I2CBUS 为 0、1、2 等整数</p>
<p><code>i2cdetect -y -a I2CBUS</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/24.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/25.png" alt="img"></p>
<h3><span id="2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</span><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/26.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/27.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/28.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/29.png" alt="img"></p>
<h3><span id="2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</span><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/30.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/31.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/32.png" alt="img"></p>
<h3><span id="2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</span><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/33.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/34.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/35.png" alt="img"></p>
<p>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x4。<br>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x3。<br>从i2c总线0，往0x1e设备地址，写1个字节，写入寄存器地址0xc表示要读0xc里面的值，再从0xc读2个字节。</p>
<h2><span id="2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</span><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi" class="header-anchor">#</a></h2><p>I2C-Tools 可以通过 <strong>SMBus</strong> 来访问 I2C 设备，也可以使用一般的 <strong>I2C 协议</strong> 来访问 I2C 设备。 使用一句话概括 I2C 传输：APP 通过 I2C Controller 与 I2C Device 传 输数据.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Open(<span class="string">&quot;dev/i2c-0&quot;</span>);</span><br><span class="line">ioctl(file, I2C_SLAVE, address);</span><br></pre></td></tr></table></figure>

<p>如果该设备已经有了对应的设备驱动程序，则返回失败。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(file, I2C_SLAVE_FORCE, address);</span><br></pre></td></tr></table></figure>

<p> 如果该设备已经有了对应的设备驱动程序但是还是想通过 i2c-dev 驱 动来访问它，则使用这个 ioctl 来指定 I2C 设备地址。</p>
<h3><span id="2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</span><a href="#2-5-1-shu-ju-chuan-shu-fang-shi" class="header-anchor">#</a></h3><h4><span id="2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</span><a href="#2-5-1-1-shi-yong-i2c-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_RDWR, &amp;rdwr)；(使用I2C方式)</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/36.png" alt="img"></p>
<p>该结构体表示一个或者多个i2c_msg。</p>
<p>示例代码：i2ctransfer.c</p>
<p>以<code>i2ctransfer -f -y 0 w1@0x1e 0xe r2</code>为例：</p>
<p>流程如下：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/37.png" alt="img"></p>
<p>构造i2c_rdwr_ioctl_data结构，要用2个i2c_msg结构，第一个表示写入0xe寄存器地址给设备，第二个表示要从0xe寄存器读出2个字节。</p>
<h4><span id="2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</span><a href="#2-5-1-2-shi-yong-smbus-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_SMBUS, &amp;args) ；（使用SMBus方式）</code></p>
<p>示例代码：i2cget.c i2cset.c</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/38.png" alt="img"></p>
<h4><span id="2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</span><a href="#2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gc2053_read_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> ret, data;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">2</span>)</span><br><span class="line">                buf[idx++] = (addr &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add address byte 0</span></span><br><span class="line">        buf[idx++] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_READ error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// pack read back data</span></span><br><span class="line">        data = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">2</span>) &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">                data += buf[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        syslog(LOG_DEBUG, <span class="string">&quot;i2c r 0x%x = 0x%x\n&quot;</span>, addr, data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gc2053_write_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr, <span class="type">int</span> data)</span> &#123;</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = data &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="comment">//syslog(LOG_DEBUG, &quot;i2c w 0x%x 0x%x\n&quot;, addr, data);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" data-id="clzp8utsw00089oufgo2l8nal" data-title="I2C-SMBus协议和I2C Tool" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          markdown语法教程
        
      </div>
    </a>
  
  
    <a href="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">字符编码与freetype移植</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 12px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 11px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 13px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/18/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-pinctrl%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-pinctrl子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-gpio%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-gpio子系统</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-%E7%94%A8%E6%88%B7%E6%80%81%E6%9E%84%E9%80%A0IP%E5%AF%84%E5%AD%98%E5%99%A8%E7%BB%93%E6%9E%84%E4%BD%93%E5%92%8C%E8%AF%BB%E5%86%99%E5%AF%84%E5%AD%98%E5%99%A8/">字符设备驱动-用户态构造IP寄存器结构体和读写寄存器</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-ioctl%E5%91%BD%E4%BB%A4%E8%AF%A6%E8%A7%A3/">字符设备驱动-ioctl命令详解</a>
          </li>
        
          <li>
            <a href="/2024/08/17/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-misc%E6%9D%82%E9%A1%B9%E8%AE%BE%E5%A4%87/">字符设备驱动-misc杂项设备</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
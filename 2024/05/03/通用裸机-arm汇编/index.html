<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>通用裸机-arm汇编 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1 GNU 汇编格式 1.1伪操作 1.1.1 .section 1.1.2 .global 1.1.3 .comm 1.1.4 .byte ， .word 1.1.5 .set， .eqv， .equ， .equiv 1.1.6 .weak   1.2 函数定义   2 ARMv7汇编指令 2.1 数据移动指令 2.1.1 MOV 2.1.2 MRS 2.1.3 MSR 2.1.4 C">
<meta property="og:type" content="article">
<meta property="og:title" content="通用裸机-arm汇编">
<meta property="og:url" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 GNU 汇编格式 1.1伪操作 1.1.1 .section 1.1.2 .global 1.1.3 .comm 1.1.4 .byte ， .word 1.1.5 .set， .eqv， .equ， .equiv 1.1.6 .weak   1.2 函数定义   2 ARMv7汇编指令 2.1 数据移动指令 2.1.1 MOV 2.1.2 MRS 2.1.3 MSR 2.1.4 C">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/1.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/2.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/3.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/4.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/5.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/6.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/7.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/8.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/9.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/10.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/11.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/12.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/13.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/14.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/15.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/16.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/17.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/18.png">
<meta property="og:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/19.png">
<meta property="article:published_time" content="2024-05-03T07:51:11.000Z">
<meta property="article:modified_time" content="2024-06-29T10:06:16.000Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="arm裸机">
<meta property="article:tag" content="arm汇编">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/1.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-通用裸机-arm汇编" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/" class="article-date">
  <time class="dt-published" datetime="2024-05-03T07:51:11.000Z" itemprop="datePublished">2024-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      通用裸机-arm汇编
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-gnu-hui-bian-ge-shi">1 GNU 汇编格式</a><ul>
<li><a href="#1-1-wei-cao-zuo">1.1伪操作</a><ul>
<li><a href="#1-1-1-section">1.1.1 .section</a></li>
<li><a href="#1-1-2-global">1.1.2 .global</a></li>
<li><a href="#1-1-3-comm">1.1.3 .comm</a></li>
<li><a href="#1-1-4-byte-word">1.1.4 .byte ， .word</a></li>
<li><a href="#1-1-5-set-eqv-equ-equiv">1.1.5 .set， .eqv， .equ， .equiv</a></li>
<li><a href="#1-1-6-weak">1.1.6 .weak</a></li>
</ul>
</li>
<li><a href="#1-2-han-shu-ding-yi">1.2 函数定义</a></li>
</ul>
</li>
<li><a href="#2-armv7-hui-bian-zhi-ling">2 ARMv7汇编指令</a><ul>
<li><a href="#2-1-shu-ju-yi-dong-zhi-ling">2.1 数据移动指令</a><ul>
<li><a href="#2-1-1-mov">2.1.1 MOV</a></li>
<li><a href="#2-1-2-mrs">2.1.2 MRS</a></li>
<li><a href="#2-1-3-msr">2.1.3 MSR</a></li>
<li><a href="#2-1-4-cps">2.1.4 CPS</a></li>
</ul>
</li>
<li><a href="#2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram">2.2 数据存取指令（访问存储器RAM）</a><ul>
<li><a href="#2-2-1-ldr">2.2.1 LDR</a></li>
<li><a href="#2-2-2-str">2.2.2 STR</a></li>
<li><a href="#2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng">2.2.3 多寄存器加载存储指令LDMIA，STMIA等</a></li>
</ul>
</li>
<li><a href="#2-3-ru-zhan-chu-zhan-zhi-ling">2.3 入栈出栈指令</a><ul>
<li><a href="#2-3-1-push">2.3.1 PUSH</a></li>
<li><a href="#2-3-2-pop">2.3.2 POP</a></li>
</ul>
<ul>
<li><a href="#2-3-3-stmfd-he-ldmfd">2.3.3 STMFD和LDMFD</a></li>
</ul>
</li>
<li><a href="#2-4-tiao-zhuan-zhi-ling">2.4 跳转指令</a><ul>
<li><a href="#2-4-1-b-zhi-ling">2.4.1 B 指令</a></li>
<li><a href="#2-4-2-bl-zhi-ling">2.4.2 BL 指令</a></li>
</ul>
</li>
<li><a href="#2-5-suan-shu-yun-suan-zhi-ling">2.5 算数运算指令</a></li>
<li><a href="#2-6-luo-ji-yun-suan-zhi-ling">2.6 逻辑运算指令</a></li>
<li><a href="#2-7-nei-cun-ping-zhang-zhi-ling">2.7 内存屏障指令</a><ul>
<li><a href="#2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang">2.7.1 Data Memory Barrier(DMB)：数据内存屏障</a></li>
<li><a href="#2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang">2.7.2 Data Synchronization Barrier(DSB)：数据同步屏障</a></li>
<li><a href="#2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang">2.7.3 Instruction Synchronization Barrier(ISB)：指令同步屏障</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-arm-v7-cpu-yun-xing-mo-shi">3 arm-v7 cpu运行模式</a></li>
<li><a href="#4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi">4 arm-v7 cpu通用和特殊寄存器</a><ul>
<li><a href="#4-1-tong-yong-ji-cun-qi">4.1 通用寄存器</a><ul>
<li><a href="#4-1-1-tong-yong-ji-cun-qi-fen-lei">4.1.1 通用寄存器分类</a></li>
<li><a href="#4-1-2-wei-bei-fen-ji-cun-qi-r0-r7">4.1.2 未备份寄存器R0-R7</a></li>
<li><a href="#4-1-3-bei-fen-ji-cun-qi">4.1.3 备份寄存器</a><ul>
<li><a href="#4-1-3-1-r8-r12">4.1.3.1 R8~R12</a></li>
<li><a href="#4-1-3-2-r13-sp">4.1.3.2 R13 (SP)</a></li>
<li><a href="#4-1-3-2-r14-lr">4.1.3.2 R14 (LR)</a></li>
<li><a href="#4-1-3-2-r15-pc">4.1.3.2 R15 (PC)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-2-te-shu-ji-cun-qi">4.2 特殊寄存器</a><ul>
<li><a href="#4-2-1-cpsr">4.2.1 CPSR</a></li>
<li><a href="#4-2-2-spsr">4.2.2 SPSR</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-cp15-xie-chu-li-qi">5 CP15协处理器</a><ul>
<li><a href="#5-1-xie-chu-li-qi-zhi-ling">5.1 协处理器指令</a></li>
<li><a href="#5-2-c0-ji-cun-qi-midr">5.2 c0寄存器（MIDR）</a></li>
<li><a href="#5-3-c1-ji-cun-qi-sctlr">5.3 c1寄存器（SCTLR）</a></li>
<li><a href="#5-4-c12-ji-cun-qi-vbar">5.4 c12寄存器（VBAR）</a></li>
<li><a href="#5-5-c15-ji-cun-qi-cbar">5.5 c15寄存器（CBAR）</a></li>
</ul>
</li>
<li><a href="#6-arm-guan-fang-can-kao-lian-jie">6 arm官方参考链接</a><ul>
<li><a href="#6-1-armv7-yu-armv8-jia-gou">6.1 armv7与armv8架构</a></li>
<li><a href="#6-2-armv7-can-kao-shou-ce">6.2 armv7参考手册</a></li>
<li><a href="#6-3-armv7-bian-cheng-shou-ce">6.3 armv7 编程手册</a></li>
<li><a href="#6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce">6.4 Cortex-A7 <code>MPCore</code> 技术参考手册</a></li>
</ul>
</li>
<li><a href="#7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li">7 附件1：armv7裸机启动汇编示例：</a></li>
<li><a href="#8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi">8 附件2：GIC指令和寄存器定义（内联汇编方式）</a><ul>
<li><a href="#8-1-nei-lian-hui-bian-yuan-li">8.1 内联汇编原理</a><ul>
<li><a href="#8-1-1-cao-zuo-shu-shu-xing">8.1.1 操作数属性</a></li>
<li><a href="#8-1-2-clobber-list">8.1.2 clobber list</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-gnu-hui-bian-ge-shi">1 GNU 汇编格式</span><a href="#1-gnu-hui-bian-ge-shi" class="header-anchor">#</a></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label：instruction @ comment</span><br></pre></td></tr></table></figure>
<p><strong>label</strong> 即标号，表示地址位置，有些指令前面可能会有标号，这样就可以通过这个标号得到指令的地址，标号也可以用来表示数据地址。注意 label 后面的“：”，任何以“：”结尾的标识符都会被识别为一个标号。<br><strong>instruction</strong> 即指令，也就是汇编指令或伪指令。<br><strong>@符号</strong>，表示后面的是注释，就跟 C 语言里面的<code>/*</code>和<code>*/</code>一样，其实在 GNU 汇编文件中我们也可以使用<code>\*</code>和<code>*/</code>来注释。<br><strong>comment</strong> 就是注释内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add:</span><br><span class="line">MOVS R0, #0X12 @设置 R0=0X12</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong> ARM 中的指令、伪指令、伪操作、寄存器名等可以全部使用大写，也可以全部使用小写，但是不能大小写混用</p>
<h2><span id="1-1-wei-cao-zuo">1.1伪操作</span><a href="#1-1-wei-cao-zuo" class="header-anchor">#</a></h2><h3><span id="1-1-1-section">1.1.1 .section</span><a href="#1-1-1-section" class="header-anchor">#</a></h3><p>来定义一个段，汇编系统预定义了一些段名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text 表示代码段。</span><br><span class="line">.data 初始化的数据段。</span><br><span class="line">.bss 未初始化的数据段。</span><br><span class="line">.rodata 只读数据段。</span><br></pre></td></tr></table></figure>

<p>定义一个 testsetcion 段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.section .testsection</span><br></pre></td></tr></table></figure>
<p>同时，还可以指定该段的属性，对应的属性见下表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a section is allocatable</span><br><span class="line">d section is a GNU_MBIND section</span><br><span class="line">e section is excluded from executable and shared library.</span><br><span class="line">w section is writable</span><br><span class="line">x section is executable</span><br><span class="line">M section is mergeable</span><br><span class="line">S section contains zero terminated strings</span><br><span class="line">G section is a member of a section group</span><br><span class="line">T section is used <span class="keyword">for</span> thread-local-storage</span><br></pre></td></tr></table></figure>

<p>属性可以组合， 比如:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.section .foo，<span class="string">&quot;aex&quot;</span></span><br><span class="line">    text...</span><br></pre></td></tr></table></figure>

<p>汇编程序的默认入口标号是_start，不过我们也可以在链接脚本中使用 <code>ENTRY</code> 来指明其它的入口点。</p>
<h3><span id="1-1-2-global">1.1.2 .global</span><a href="#1-1-2-global" class="header-anchor">#</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">_start:</span><br><span class="line">ldr r0, =0x12 @r0=0x12</span><br></pre></td></tr></table></figure>

<p><code>.global</code> 是伪操作，表示<code>_start</code> 是一个全局标号，类似 C 语言里面的全局变量一样，常见的伪操作有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.byte 定义单字节数据，比如.byte <span class="number">0x12</span>。</span><br><span class="line">.<span class="type">short</span> 定义双字节数据，比如.<span class="type">short</span> <span class="number">0x1234</span>。</span><br><span class="line">.<span class="type">long</span> 定义一个 <span class="number">4</span> 字节数据，比如.<span class="type">long</span> <span class="number">0x12345678</span>。</span><br><span class="line">.equ 赋值语句，格式为：.equ 变量名，表达式，比如.equ num, <span class="number">0x12</span>，表示 num=<span class="number">0x12</span>。</span><br><span class="line">.align 数据字节对齐，比如：.align <span class="number">4</span> 表示 <span class="number">4</span> 字节对齐。</span><br><span class="line">.end 表示源文件结束。</span><br><span class="line">.global 定义一个全局符号，格式为：.global symbol，比如：.global _start。</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-3-comm">1.1.3 .comm</span><a href="#1-1-3-comm" class="header-anchor">#</a></h3><p><code>.comm </code>表示目标文件中的<code> common symbol</code>，表示公共的符号:<br><code>.comm symbol，length</code></p>
<p>这和 GNU 中的强弱符号机制相关，未初始化的变量表示为弱符号，初始化的变量为强符号，当不同源文件中存在多个同名变量时，强符号会覆盖弱符号而不会报错，这是 <code>gcc </code>的扩展语法，所以实际上未初始化的全局变量是作为公共符号保存的，当多个文件中的<code>comm</code>符号出现冲突时，需要将其以一定规则融合. 实际上，C 语言中未定义的全局变量(也就是 <code>comm </code>符号)并非是存放到 <code>bss </code>段中的，而是保存在 COMMON 段.</p>
<h3><span id="1-1-4-byte-word">1.1.4 .byte ， .word</span><a href="#1-1-4-byte-word" class="header-anchor">#</a></h3><p>伪汇编中有一系列的数据放置指令，表示在当前位置放置某些数据，相对应的有:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.byte : 放置一个字节</span><br><span class="line">.hword:放置半字，在 <span class="number">32</span> 位平台中对应两个字节，<span class="number">64</span> 位对应四字节</span><br><span class="line">.<span class="type">short</span>:放置一个 <span class="type">short</span> 类型数据，两个字节.word:放置一个字，在 <span class="number">32</span> 位平台中对应四个字节，<span class="number">64</span> 位对应八字节</span><br><span class="line">.<span class="type">int</span> : 放置一个 <span class="type">int</span> 类型的数据，数据长度根据平台而定，<span class="number">16</span>位平台为两字节，<span class="number">32</span>位和<span class="number">64</span>位平台为四字节</span><br><span class="line">.<span class="type">long</span>:放置一个 <span class="type">long</span> 类型的数据，数据长度根据平台而定，<span class="number">32</span>位平台为四字节，<span class="number">64</span>位平台为八字节</span><br><span class="line">.<span class="type">float</span>:放置一个 <span class="type">float</span> 类型数据，四字节</span><br><span class="line">.<span class="type">double</span>:放置一个 <span class="type">double</span> 类型数据，八字节</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-5-set-eqv-equ-equiv">1.1.5 .set， .eqv， .equ， .equiv</span><a href="#1-1-5-set-eqv-equ-equiv" class="header-anchor">#</a></h3><p>set:设置一个符号的值, C 中的宏。通过设置一个符号的值，在后续的代码中可以重复使用该符号的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">set</span> sym_set，<span class="number">0x100</span></span><br><span class="line">mov r0，#sym_set</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-6-weak">1.1.6 .weak</span><a href="#1-1-6-weak" class="header-anchor">#</a></h3><p>定义一个 weak 类型的符号，当这个符号在相同作用域的地方存在定义，当前符号会被忽略，如果这个符号之前不存在，这个符号就会被使用. 这和 C 语言中的 weak 机制是一样的.</p>
<h2><span id="1-2-han-shu-ding-yi">1.2 函数定义</span><a href="#1-2-han-shu-ding-yi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">函数名:</span><br><span class="line">	函数体</span><br><span class="line">	返回语句</span><br></pre></td></tr></table></figure>

<p>GNU 汇编函数返回语句不是必须的，如下代码就是用汇编写的Cortex-A7 中断服务函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 未定义中断 */</span></span><br><span class="line">Undefined_Handler:</span><br><span class="line">	ldr r0, =Undefined_Handler</span><br><span class="line">	bx r0</span><br><span class="line"><span class="comment">/* SVC 中断 */</span></span><br><span class="line">SVC_Handler:</span><br><span class="line">	ldr r0, =SVC_Handler</span><br><span class="line">	bx r0</span><br><span class="line"><span class="comment">/* 预取终止中断 */</span></span><br><span class="line">PrefAbort_Handler:</span><br><span class="line">	ldr r0, =PrefAbort_Handler </span><br><span class="line">	bx r0</span><br></pre></td></tr></table></figure>

<p>以函数 <code>Undefined_Handler</code> 为例我们来看一下汇编函数组成，<code>Undefined_Handler</code>就是函数名，<code>ldr r0, =Undefined_Handler</code>是函数体，<code>bx r0</code>是函数返回语句，<code>bx</code>指令是返回指令，函数返回语句不是必须的.</p>
<h1><span id="2-armv7-hui-bian-zhi-ling">2 ARMv7汇编指令</span><a href="#2-armv7-hui-bian-zhi-ling" class="header-anchor">#</a></h1><h2><span id="2-1-shu-ju-yi-dong-zhi-ling">2.1 数据移动指令</span><a href="#2-1-shu-ju-yi-dong-zhi-ling" class="header-anchor">#</a></h2><p>数据移动指令都是cpu内部寄存器之间的数据拷贝。</p>
<h3><span id="2-1-1-mov">2.1.1 MOV</span><a href="#2-1-1-mov" class="header-anchor">#</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV R0，R1 @将寄存器 R1 中的数据传递给 R0，即 R0=R1</span><br><span class="line">MOV R0, #0X12 @将立即数 0X12 传递给 R0 寄存器，即 R0=0X12</span><br></pre></td></tr></table></figure>
<h3><span id="2-1-2-mrs">2.1.2 MRS</span><a href="#2-1-2-mrs" class="header-anchor">#</a></h3><p>读取特殊寄存器的数据只能使用 MRS 指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRS R0, CPSR @将 CPSR 里面的数据传递给 R0，即 R0=CPSR</span><br></pre></td></tr></table></figure>
<h3><span id="2-1-3-msr">2.1.3 MSR</span><a href="#2-1-3-msr" class="header-anchor">#</a></h3><p>和 MRS 刚好相反，通用寄存器写入到特殊寄存器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSR CPSR, R0 @将 R0 中的数据复制到 CPSR 中，即 CPSR=R0</span><br></pre></td></tr></table></figure>

<p>举个例子利用MRS MSR进行清bss (_bss_start, __bss_end定义在链接脚本):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">.global _bss_start</span><br><span class="line">.global _bss_end</span><br><span class="line"></span><br><span class="line">_bss_start:</span><br><span class="line">	.word __bss_start</span><br><span class="line">_bss_end:</span><br><span class="line">	.word __bss_end</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	<span class="comment">//disable watchdog, disable icache dcache</span></span><br><span class="line">	<span class="comment">//init_clk</span></span><br><span class="line">	<span class="comment">//enter svc mode</span></span><br><span class="line">	<span class="comment">/*clear bss*/</span></span><br><span class="line">	ldr r0, _bss_start</span><br><span class="line">	ldr r1, _bss_end</span><br><span class="line">	move r2, <span class="number">0</span></span><br><span class="line">clr_bss:</span><br><span class="line">	stmia r0!, &#123;r2&#125; <span class="comment">//复制一r2中的数据给r0, 并将指针r0增加4</span></span><br><span class="line">	cmp r0, r1</span><br><span class="line">	ble clr_bss <span class="comment">/*if r0&lt;r1, b clr_bss*/</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-1-4-cps">2.1.4 CPS</span><a href="#2-1-4-cps" class="header-anchor">#</a></h3><p>特权模式下（除了用户模式，剩余的模式都是特权模式），可以通过CPS指令直接修改CPSR寄存器的M[4:0]，让处理器进入不同的模式。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/1.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPS #0x12 /*irq mode*/</span><br><span class="line">CPS #0x13 /*svc mode*/</span><br></pre></td></tr></table></figure>
<h2><span id="2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram">2.2 数据存取指令（访问存储器RAM）</span><a href="#2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram" class="header-anchor">#</a></h2><h3><span id="2-2-1-ldr">2.2.1 LDR</span><a href="#2-2-1-ldr" class="header-anchor">#</a></h3><p>数据加载指令，从指定地址读取到cpu寄存器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR R0, =0X0209C004 @将寄存器地址 0X0209C004 加载到 R0 中，即 R0=0X0209C004</span><br><span class="line">LDR R1, [R0] @读取地址 0X0209C004 中的数据到 R1 寄存器中</span><br></pre></td></tr></table></figure>
<h3><span id="2-2-2-str">2.2.2 STR</span><a href="#2-2-2-str" class="header-anchor">#</a></h3><p>数据存放指令，从cpu寄存器写入指定地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LDR R0, =0X0209C004 @将寄存器地址 0X0209C004 加载到 R0 中，即 R0=0X0209C004</span><br><span class="line">LDR R1, =0X20000002 @R1 保存要写入到寄存器的值，即 R1=0X20000002</span><br><span class="line">STR R1, [R0] @将 R1 中的值写入到 R0 中所保存的地址中</span><br></pre></td></tr></table></figure>

<p>LDR 和 STR 都是按照4 byte进行读取和写入的，也就是操作的 32 位数据，如果要按照字节、半字进行操作的话可以在指令“LDR”后面加上 B 或 H，比如按字节操作的指令就是 LDRB 和STRB，按半字(16位)操作的指令就是 LDRH 和 STRH。</p>
<h3><span id="2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng">2.2.3 多寄存器加载存储指令LDMIA，STMIA等</span><a href="#2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng" class="header-anchor">#</a></h3><p><strong>1.LDMIA指令、LDMIB指令、LDMDB指令、LDMDA指令</strong><br>LDM是LDR指令的增强型 ， 将连续的数据加载到多组寄存器。<br>DB （Decrement Before）栈指针先减小再操作、DA（Decrement After）栈指针先操作再减小。<br>IB（Increment Before）栈指针先增加再操作、IA（Increment After）栈指针先操作再增加。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">LDMIA指令，IA表示每次传送后地址加<span class="number">4</span></span><br><span class="line">LDMIB指令，IB表示每次传送前地址加<span class="number">4</span></span><br><span class="line">LDMDA指令，DA表示每次传送后地址减<span class="number">4</span></span><br><span class="line">LDMDB指令，DB表示每次传送前地址减<span class="number">4</span></span><br><span class="line"></span><br><span class="line">LDMIA R14，&#123;R0-R3，R12&#125; <span class="comment">/*从R14寄存器指向的地址取出5个32位数据分别存进到R0-R4以及R12*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//等效于</span></span><br><span class="line"><span class="comment">//R0=*R14</span></span><br><span class="line"><span class="comment">//R1=*（R14+4）</span></span><br><span class="line"><span class="comment">//R2=*（R14+8）</span></span><br><span class="line"><span class="comment">//R3=*（R14+12）</span></span><br><span class="line"><span class="comment">//R12=*（R14+16）</span></span><br><span class="line"></span><br><span class="line">LDMIA R1！，&#123;R4-R11&#125; <span class="comment">/*从R1指向的地址取8个32位数据存入R4-R11, 每取一次，让R1指针加4，因此最后R1指针加了32*/</span></span><br></pre></td></tr></table></figure>

<p><strong>2.STMIA指令、STMIB指令、STMDB指令、STMDA指令</strong><br>同理，STM是STR指令的增强型 ， 将多组寄存器数据保存进连续地址空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STMIA R13！，&#123;R0-R1&#125; /*将R0，R1寄存器中的数据存入R13指向的栈空间, r13指向的地址存入R0数据，再地址+4后存入R1的数据*/</span><br></pre></td></tr></table></figure>
<h2><span id="2-3-ru-zhan-chu-zhan-zhi-ling">2.3 入栈出栈指令</span><a href="#2-3-ru-zhan-chu-zhan-zhi-ling" class="header-anchor">#</a></h2><p>函调调用过程中离不开现场的保护和恢复。保存 <code>R0~R15</code> 寄存器的操作就叫做现场保护，恢复 R0~R15 寄存器的操作就叫做恢复现场。</p>
<h4><span id="2-3-1-push">2.3.1 PUSH</span><a href="#2-3-1-push" class="header-anchor">#</a></h4><p>比如要将 R0~R3 和 R12 这 5 个寄存器压栈，当前的 <code>SP （stack pointer）</code>指针指向 <code>0X80000000</code>，我们知道栈空间的地址是向下增长的，堆空间地址向上增长。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH &#123;R0~R3, R12&#125; @将 R0~R3 和 R12 压栈</span><br></pre></td></tr></table></figure>

<p>那么压栈完成以后的堆栈如下：入栈保护现场完这5个寄存器后，SP指向<code>0X7FFFFFEC</code>（每压栈一个寄存器，SP地址减4）<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/2.png" alt="image"><br>再次保存LR寄存器，进行压栈：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/3.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH &#123;LR&#125; @将 LR 进行压栈</span><br></pre></td></tr></table></figure>

<h4><span id="2-3-2-pop">2.3.2 POP</span><a href="#2-3-2-pop" class="header-anchor">#</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POP &#123;LR&#125; @先恢复 LR</span><br><span class="line">POP &#123;R0~R3,R12&#125; @在恢复 R0~R3,R12</span><br></pre></td></tr></table></figure>

<p>可以看出入栈出栈本质都是对SP指针进行加减，入栈减，出栈加，入栈把寄存器依次保存进SP指向的地址去，出栈从SP地址依次取出数据。</p>
<h3><span id="2-3-3-stmfd-he-ldmfd">2.3.3 STMFD和LDMFD</span><a href="#2-3-3-stmfd-he-ldmfd" class="header-anchor">#</a></h3><p>入栈出栈的另外一种写法是“STMFD SP！”和“LDMFD SP!”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STMFD SP!,&#123;R0~R3, R12&#125; @R0~R3,R12 入栈</span><br><span class="line">STMFD SP!,&#123;LR&#125; @LR 入栈</span><br><span class="line">bl xxx</span><br><span class="line">LDMFD SP!, &#123;LR&#125; @先恢复 LR</span><br><span class="line">LDMFD SP!, &#123;R0~R3, R12&#125; @再恢复 R0~R3, R12</span><br></pre></td></tr></table></figure>

<p>STMFD 可以分为两部分：STM 和 FD，同理，LDMFD 也可以分为 LDM 和 FD。前面我们讲了 LDR 和 STR，这两个是数据加载和存储指令，但是每次只能读写存储器中的一个数据。STM 和 LDM 就是多存储和多加载，可以连续的读写存储器中的多个连续数据。<br>FD 是 Full Descending 的缩写，即满递减的意思。根据 ATPCS 规则,ARM 使用的 FD 类型的堆栈，SP 指向最后一个入栈的数值，堆栈是由高地址向下增长的，也就是前面说的向下增长的堆栈，因此最常用的指令就是 STMFD 和 LDMFD。STM 和 LDM 的指令寄存器列表中编号小的对应低地址，编号高的对应高地址.</p>
<h2><span id="2-4-tiao-zhuan-zhi-ling">2.4 跳转指令</span><a href="#2-4-tiao-zhuan-zhi-ling" class="header-anchor">#</a></h2><h3><span id="2-4-1-b-zhi-ling">2.4.1 B 指令</span><a href="#2-4-1-b-zhi-ling" class="header-anchor">#</a></h3><p>B 指令会将 PC 寄存器的值设置为跳转目标地址，如果要调用的函数不会再返回到原来的执行处，那就可以用 B 指令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">ldr sp,=0X80200000 @设置栈指针</span><br><span class="line">b main @跳转到 main 函数</span><br></pre></td></tr></table></figure>

<p>在汇编中初始化 C 运行环境，然后跳转到 C 文件的 main 函数中运行，上述代码只是初始化了 SP 指针，有些处理器还需要做其他的初始化，比如初始化 DDR 等等.</p>
<h3><span id="2-4-2-bl-zhi-ling">2.4.2 BL 指令</span><a href="#2-4-2-bl-zhi-ling" class="header-anchor">#</a></h3><p>有返回的跳转，跳转之前会在寄存器 LR(R14)中保存当前 PC 寄存器值，所以可以通过<strong>将 LR 寄存器中的值重新加载到 PC</strong> 中来继续从跳转之前的代码处运行，这是子程序调用一个基本但常用的手段。<br>比如 Cortex-A 处理器的 irq 中断服务函数都是汇编写的，主要用汇编来实现现场的保护和恢复、获取中断号等。但是具体的中断处理过程都是 C 函数，所以就会存在汇编中调用 C 函数的问题。而且当 C 语言版本的中断处理函数执行完成以后是需要返回到irq 汇编中断服务函数，因为还要处理其他的工作，一般是恢复现场。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">push &#123;r0, r1&#125; @保存 r0,r1</span><br><span class="line">cps #0x13 @进入 SVC 模式，允许其他中断再次进去</span><br><span class="line"></span><br><span class="line">bl system_irqhandler @加载 C 语言中断处理函数到 r2 寄存器中</span><br><span class="line"></span><br><span class="line">cps #0x12 @进入 IRQ 模式</span><br><span class="line">pop &#123;r0, r1&#125; </span><br><span class="line">str r0, [r1, #0X10] @中断执行完成，写 EOIR</span><br></pre></td></tr></table></figure>

<p>跳转指令总结：<br>有多种跳转操作，比如：<br>①、直接使用跳转指令 B、BL、BX 等。<br>②、直接向 PC 寄存器里面写入数据。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/4.png" alt="image"></p>
<h2><span id="2-5-suan-shu-yun-suan-zhi-ling">2.5 算数运算指令</span><a href="#2-5-suan-shu-yun-suan-zhi-ling" class="header-anchor">#</a></h2><p>加减乘除，常用的运算指令用法：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/5.png" alt="image"></p>
<h2><span id="2-6-luo-ji-yun-suan-zhi-ling">2.6 逻辑运算指令</span><a href="#2-6-luo-ji-yun-suan-zhi-ling" class="header-anchor">#</a></h2><p>与或非指令用法：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/6.png" alt="image"><br>来看一个例子利用arm汇编进行初始化C语言环境。让arm进入svc模式，才能访问特殊寄存器如cpsr, spsr, sp指针。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">_start:</span><br><span class="line">	/* 进入SVC模式 */</span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #0x1f  /* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 */</span><br><span class="line">	orr r0, r0, #0x13  /* r0或上0x13,表示使用SVC模式 */</span><br><span class="line">	msr cpsr, r0 /* 将r0 的数据写入到cpsr_c中 */</span><br><span class="line"></span><br><span class="line">	ldr sp, =0X80200000 /* 设置栈指针 */</span><br><span class="line">	b main /* 跳转到main函数 */</span><br></pre></td></tr></table></figure>

<h2><span id="2-7-nei-cun-ping-zhang-zhi-ling">2.7 内存屏障指令</span><a href="#2-7-nei-cun-ping-zhang-zhi-ling" class="header-anchor">#</a></h2><h3><span id="2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang">2.7.1 Data Memory Barrier(DMB)：数据内存屏障</span><a href="#2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang" class="header-anchor">#</a></h3><p>DMB指令确保在DMB之前的所有显式数据内存传输指令都已经在内存中读取或写入完成，同时确保任何后续的数据内存传输指令都将在DMB执行之后开始执行，否则有些数据传输指令可能会提前执行。保证了两个内存访问能按正确的顺序执行。<br>应用场景：<br>（1）DMA<br>在使用DMA控制器时，需要在CPU内存访问和DMA操作之间插入DMB屏障，以确保CPU当前的内存读写操作在DMA开始之前完成。</p>
<p>（2）多核系统中的信号量<br>在多核系统中，使用信号量进行核间同步。需要使用DMB来强制指定内存执行顺序，以避免潜在的竞态条件或数据不一致性。当一个核要访问共享资源之前，它会先检查信号量的状态。如果信号量已经被另一个核获取，当前核就必须等待，直到信号量状态变为可用。这个等待过程需要保证在一个核释放信号量之后，其他核能够立即看到信号量状态的变化，而不是因为处理器优化或缓存导致的无效读取而产生错误。</p>
<h3><span id="2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang">2.7.2 Data Synchronization Barrier(DSB)：数据同步屏障</span><a href="#2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang" class="header-anchor">#</a></h3><p>在多线程编程中，两个线程同时对共享的内存进行读写操作，由于读&#x2F;写操作的重排序，就会导致数据的不一致, DSB指令时，它确保在DSB之前的所有显式数据内存传输指令都已经在内存中读取或写入完成，同时确保任何后续的指令都将在DSB执行之后开始执行。<br>应用场景：<br>例如启用或禁用特定的中断、配置时钟、设置系统控制位等。为了确保对SCS的修改在下一条指令执行之前生效，需要使用DSB指令进行数据同步。一些特殊的指令如SVC(Supervisor Call，特权级调用)、WFI(Wait For Interrupt，等待中断）、WFE(Wait For Event，等待事件)等操作，涉及到特权级的转换或者等待系统事件发生，需要使用DSB指令。</p>
<h3><span id="2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang">2.7.3 Instruction Synchronization Barrier(ISB)：指令同步屏障</span><a href="#2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang" class="header-anchor">#</a></h3><p>插入ISB指令，处理器会将流水线中的指令全部刷新，从而确保之前的指令不会影响后续指令的执行，并且后续指令将从正确的上下文开始重新获取。<br>应用场景：<br>在进行异常进入之前，处理器会执行ISB操作。这样做的目的是刷新指令流水线，确保异常处理程序的指令是从正确的地址开始执行，避免异常之前的指令对异常处理程序造成干扰。<br>在进行异常返回之前，处理器同样会执行ISB操作。这样做的目的是刷新指令流水线，确保返回时从正确的地址重新获取指令，避免异常处理程序的指令对正常任务造成干扰。</p>
<h1><span id="3-arm-v7-cpu-yun-xing-mo-shi">3 arm-v7 cpu运行模式</span><a href="#3-arm-v7-cpu-yun-xing-mo-shi" class="header-anchor">#</a></h1><p>以前的 ARM 处理器有 7 中运行模型：User、FIQ、IRQ、Supervisor(SVC)、Abort、Undef和 System，其中 User 是非特权模式，其余 6 中都是特权模式。</p>
<p>到了Cortex-A7 处理器有 9 种处理模式:</p>
<table>
<thead>
<tr>
<th align="center">模式</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">User(USR)</td>
<td align="center">用户模式，非特权模式，大部分程序运行的时候就处于此模式。</td>
</tr>
<tr>
<td align="center">FIQ</td>
<td align="center">快速中断模式，进入 FIQ 中断异常</td>
</tr>
<tr>
<td align="center">IRQ</td>
<td align="center">一般中断模式。</td>
</tr>
<tr>
<td align="center">Supervisor(SVC)</td>
<td align="center">超级管理员模式，特权模式，供操作系统使用。</td>
</tr>
<tr>
<td align="center">Monitor(MON)</td>
<td align="center">监视模式？这个模式用于安全扩展模式。</td>
</tr>
<tr>
<td align="center">Abort(ABT)</td>
<td align="center">数据访问终止模式，用于虚拟存储以及存储保护。</td>
</tr>
<tr>
<td align="center">Hyp(HYP)</td>
<td align="center">Hyp(HYP) 超级监视模式？用于虚拟化扩展。</td>
</tr>
<tr>
<td align="center">Undef(UND)</td>
<td align="center">Undef(UND) 未定义指令终止模式。</td>
</tr>
<tr>
<td align="center">System(SYS)</td>
<td align="center">System(SYS) 系统模式，用于运行特权级的操作系统任务</td>
</tr>
</tbody></table>
<p>九种模式所对应的寄存器：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/7.png" alt="image"><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/12066599.html" title="arm920t cpu模式">arm920t cpu模式</a>或者查看<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/04/16/s3c2440%E8%A3%B8%E6%9C%BA-%E5%BC%82%E5%B8%B8%E4%B8%AD%E6%96%AD/">s3c2440裸机-异常中断 | Hexo (fuzidage.github.io)</a>的CPU模式。</p>
<h1><span id="4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi">4 arm-v7 cpu通用和特殊寄存器</span><a href="#4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi" class="header-anchor">#</a></h1><p>ARM 架构提供了 16 个 32 位的通用寄存器<code>(R0~R15)</code>供软件使用，前 15 个(<code>R0~R14</code>)可以用作通用的数据存储，R15 是程序计数器 PC，用来保存将要执行的指令。ARM 还提供了一个当前程序状态寄存器 CPSR 和一个备份程序状态寄存器 SPSR，SPSR 寄存器就是 CPSR 寄存器的备份。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/8.png" alt="image"></p>
<h2><span id="4-1-tong-yong-ji-cun-qi">4.1 通用寄存器</span><a href="#4-1-tong-yong-ji-cun-qi" class="header-anchor">#</a></h2><h3><span id="4-1-1-tong-yong-ji-cun-qi-fen-lei">4.1.1 通用寄存器分类</span><a href="#4-1-1-tong-yong-ji-cun-qi-fen-lei" class="header-anchor">#</a></h3><p><code>R0~R15</code> 就是通用寄存器，通用寄存器可以分为以下三类：<br>①、未备份寄存器，即 <code>R0~R7</code>。<br>②、备份寄存器，即 <code>R8~R14</code>。<br>③、程序计数器 PC，即 R15。</p>
<h3><span id="4-1-2-wei-bei-fen-ji-cun-qi-r0-r7">4.1.2 未备份寄存器R0-R7</span><a href="#4-1-2-wei-bei-fen-ji-cun-qi-r0-r7" class="header-anchor">#</a></h3><p>未备份寄存器指的是 <code>R0~R7</code> 这 8 个寄存器，因为在所有的处理器模式下这 8 个寄存器都是同一个物理寄存器，在不同的模式下，这 8 个寄存器中的数据就会被破坏.</p>
<h3><span id="4-1-3-bei-fen-ji-cun-qi">4.1.3 备份寄存器</span><a href="#4-1-3-bei-fen-ji-cun-qi" class="header-anchor">#</a></h3><h4><span id="4-1-3-1-r8-r12">4.1.3.1 R8~R12</span><a href="#4-1-3-1-r8-r12" class="header-anchor">#</a></h4><p><code>R8~R12</code> 这 5 个寄存器有2种物理寄存器.在快速中断模式下<code>(FIQ)</code>它们对应着 <code>Rx_irq(x=8~12)</code>物理寄存器，其他模式下对应着 <code>Rx(8~12)</code>物理寄存器. <code>FIQ </code>模式下的 <code>R8~R12</code> 是独立的，因此中断处理程序可以不用执行保存和恢复中断现场的指令，从而加速中断的执行过程。</p>
<h4><span id="4-1-3-2-r13-sp">4.1.3.2 R13 (SP)</span><a href="#4-1-3-2-r13-sp" class="header-anchor">#</a></h4><p>R13 一共有 8 个物理寄存器，其中一个是用户模式<code>(User)</code>和系统模式<code>(Sys)</code>共用的，剩下的 7 个分别对应 7 种不同的模式。R13 也叫做 SP，用来做为栈指针。基本上每种模式<br>都有一个自己的 R13 物理寄存器，应用程序会初始化 R13，使其指向该模式专用的栈地址，这就是常说的初始化 SP 指针.</p>
<h4><span id="4-1-3-2-r14-lr">4.1.3.2 R14 (LR)</span><a href="#4-1-3-2-r14-lr" class="header-anchor">#</a></h4><p> R14 一共有 7 个物理寄存器，其中一个是用户模式(User)、系统模式(Sys)和超级监视模式<code>(Hyp)</code>所共有的，剩下的 6 个分别对应 6 种不同的模式.<br> LR被叫做链接寄存器:<br>①用来存放子函数的返回地址。<br> 在子函数中，将 R14(LR)中的值赋给 R15(PC)即可完成子函数返回，比如在子程序中可以使用如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV PC, LR</span><br></pre></td></tr></table></figure>
<p>②当异常发生以后，该异常模式对应的 R14寄存器被设置成该异常模式将要返回的地址.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subs pc, lr, #4				/* 将lr-4赋给pc */</span><br></pre></td></tr></table></figure>
<p>比如下面代码示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0X2000 MOV R1, R0 ;执行</span><br><span class="line">0X2004 MOV R2, R3 ;译指</span><br><span class="line">0X2008 MOV R4, R5 ;取值 PC</span><br></pre></td></tr></table></figure>
<p>当前正在执行 <code>0X2000</code>地址处的指令<code>MOV R1, R0</code>，但是 PC 里面已经保存了 <code>0X2008 </code>地址处的指令<code>MOV R4, R5</code>。假设此时发生了中断，中断发生的时候保存在 <code>lr </code>中的是 <code>pc</code> 的值，也就是地址<code> 0X2008</code>。</p>
<h4><span id="4-1-3-2-r15-pc">4.1.3.2 R15 (PC)</span><a href="#4-1-3-2-r15-pc" class="header-anchor">#</a></h4><p>R15 保存着当前执行的指令地址值加 8 个字节，这是因为 ARM的流水线机制导致的。ARM 处理器 3 级流水线：取指-&gt;译码-&gt;执行，这三级流水线循环执行，比如当前正在执行第一条指令的同时也对第二条指令进行译码，第三条指令也同时被取出存放在 <code>R15(PC)</code>中.<br>对于arm32位处理器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R15 (PC)值 = 当前执行的程序位置 + 8 个字节</span><br></pre></td></tr></table></figure>
<h2><span id="4-2-te-shu-ji-cun-qi">4.2 特殊寄存器</span><a href="#4-2-te-shu-ji-cun-qi" class="header-anchor">#</a></h2><h3><span id="4-2-1-cpsr">4.2.1 CPSR</span><a href="#4-2-1-cpsr" class="header-anchor">#</a></h3><p>当前程序状态寄存器<code>（current program status register）</code>，所有模式共用一个 <code>CPSR</code> 物理寄存器，因此 <code>CPSR </code>可以在任何模式下被访问。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/9.png" alt="image"><br>N(bit31)：当两个补码表示的 有符号整数运算的时候，N&#x3D;1 表示运算对的结果为负数，N&#x3D;0表示结果为正数。<br>Z(bit30)：Z&#x3D;1 表示运算结果为零，Z&#x3D;0 表示运算结果不为零，对于 CMP 指令，Z&#x3D;1 表示进行比较的两个数大小相等。<br>C(bit29)：在加法指令中，当结果产生了进位，则 C&#x3D;1，表示无符号数运算发生上溢，其它情况下 C&#x3D;0。在减法指令中，当运算中发生借位，则 C&#x3D;0，表示无符号数运算发生下溢，其它情况下 C&#x3D;1。对于包含移位操作的非加&#x2F;减法运算指令，C 中包含最后一次溢出的位的数值，对于其它非加&#x2F;减运算指令，C 位的值通常不受影响。<br>V(bit28)：对于加&#x2F;减法运算指令，当操作数和运算结果表示为二进制的补码表示的带符号数时，V&#x3D;1 表示符号位溢出，通常其他位不影响 V 位。<br>Q(bit27)：仅 ARM v5TE_J 架构支持，表示饱和状态，Q&#x3D;1 表示累积饱和，Q&#x3D;0 表示累积不饱和。<br>IT<a href="bit26:25">1:0</a>：和 IT<a href="bit15:bit10">7:2</a>一起组成 IT[7:0]，作为 IF-THEN 指令执行状态。<br>J(bit24)：仅 ARM_v5TE-J 架构支持，J&#x3D;1 表示处于 <code>Jazelle</code> 状态，此位通常和 T(bit5)位一起表示当前所使用的指令集:</p>
<table>
<thead>
<tr>
<th>J</th>
<th>T</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>ARM</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>Thumb</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>ThumbEE</td>
</tr>
</tbody></table>
<p>GE<a href="bit19:16">3:0</a>：SIMD 指令有效，大于或等于。<br>IT<a href="bit15:10">7:2</a>：参考 IT[1:0]。<br>E(bit9)：大小端控制位，E&#x3D;1 表示大端模式，E&#x3D;0 表示小端模式。<br>A(bit8)：禁止异步中断位，A&#x3D;1 表示禁止异步中断。<br>I(bit7)：I&#x3D;1 禁止 IRQ，I&#x3D;0 使能 IRQ。<br>F(bit6)：F&#x3D;1 禁止 FIQ，F&#x3D;0 使能 FIQ。<br>T(bit5)：控制指令执行状态，表明本指令是 ARM 指令还是 Thumb 指令，通常和 J(bit24)一起表明指令类型，参考 J(bit24)位。<br>M[4:0]：处理器模式控制位<br><code>cpsr</code>最常用就是来控制处理器模式</p>
<table>
<thead>
<tr>
<th>M[4:0]</th>
<th>处理器模式</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>User 模式</td>
</tr>
<tr>
<td>10001</td>
<td>FIQ 模式</td>
</tr>
<tr>
<td>10010</td>
<td>IRQ 模式</td>
</tr>
<tr>
<td>10011</td>
<td>Supervisor(SVC)模式</td>
</tr>
<tr>
<td>10110</td>
<td>Monitor(MON)模式</td>
</tr>
<tr>
<td>10111</td>
<td>Abort(ABT)模式</td>
</tr>
<tr>
<td>11010</td>
<td>Hyp(HYP)模式</td>
</tr>
<tr>
<td>11011</td>
<td>Undef(UND)模式</td>
</tr>
<tr>
<td>11111</td>
<td>System(SYS)模式</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 进入SVC模式 */</span></span><br><span class="line">mrs r0, cpsr</span><br><span class="line">bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">orr r0, r0, #<span class="number">0x13</span> 	<span class="comment">/* r0或上0x13,表示使用SVC模式					*/</span></span><br><span class="line">msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">ldr sp, =<span class="number">0X80200000</span>	<span class="comment">/* 设置SVC模式下的栈首地址为0X80200000,大小为2MB */</span></span><br></pre></td></tr></table></figure>
<h3><span id="4-2-2-spsr">4.2.2 SPSR</span><a href="#4-2-2-spsr" class="header-anchor">#</a></h3><p>除了 User 和 Sys 这两个模式以外，其他 7 个模式每个都配备了一个专用的物理状态寄存器，叫做 SPSR(备份程序状态寄存器)，当特定的异常中断发生时，SPSR 寄存器用来保存当前程序状态寄存器(CPSR)的值，当异常退出以后可以用 SPSR 中保存的值来恢复 CPSR。User 和 Sys 这两个模式不是异常模式，所以并没有配备 SPSR，因此不能在 User 和Sys 模式下访问 SPSR。</p>
<h1><span id="5-cp15-xie-chu-li-qi">5 CP15协处理器</span><a href="#5-cp15-xie-chu-li-qi" class="header-anchor">#</a></h1><p>CP15 协处理器一般用于存储系统管理，但是在中断中也会使用到，比如进入reset复位异常向量时，需要利用协处理器命令进行<code>ICache DCache</code>的开关。CP15 协处理器一共有16 个 32 位寄存器（C0-C15），MRC和MCR用来访问CP15协处理器。</p>
<h2><span id="5-1-xie-chu-li-qi-zhi-ling">5.1 协处理器指令</span><a href="#5-1-xie-chu-li-qi-zhi-ling" class="header-anchor">#</a></h2><p><strong>MRC</strong>: 将 CP15 协处理器中的寄存器数据读到 ARM 寄存器中。<br><strong>MCR</strong>: 将 ARM 寄存器的数据写入到 CP15 协处理器寄存器中。<br>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MCR&#123;cond&#125; p15, &lt;opc1&gt;, &lt;Rt&gt;, &lt;CRn&gt;, &lt;CRm&gt;, &lt;opc2&gt;</span><br></pre></td></tr></table></figure>

<p><code>cond:</code>指令执行的条件码，如果忽略的话就表示无条件执行。<br><code>opc1：</code>协处理器要执行的操作码。<br><code>Rt：</code>ARM 源寄存器，要写入到 CP15 寄存器的数据就保存在此寄存器中。<br><code>CRn：</code>CP15 协处理器的目标寄存器。<br><code>CRm：</code>协处理器中附加的目标寄存器或者源操作数寄存器，如果不需要附加信息就将CRm 设置为 C0，否则结果不可预测。<br><code>opc2：</code>可选的协处理器特定操作码，当不需要的时候要设置为 0</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 0, r0, c0, c0, 0 //将 CP15 中 C0 寄存器的值读取到 R0 寄存器</span><br></pre></td></tr></table></figure>

<h2><span id="5-2-c0-ji-cun-qi-midr">5.2 c0寄存器（MIDR）</span><a href="#5-2-c0-ji-cun-qi-midr" class="header-anchor">#</a></h2><p>使用 MRC 或者 MCR 指令访问<code>c0-c15</code>寄存器的时候，指令中的<code>CRn、opc1、CRm 和 opc2</code>通过不同的搭配，其得到的寄存器含义不同：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/10.png" alt="image"><br>当<code>CRn=c0，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时的 c0 就是 MIDR 寄存器，也就是主 ID 寄存器，这个也是 c0 的基本作用。来看下c0作为MDIR寄存器时的含义：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/11.png" alt="image"><br>bit31:24：厂商编号，0X41，ARM。<br>bit23:20：内核架构的主版本号，ARM 内核版本一般使用<code>rnpn</code>来表示，比如<code> r0p1</code>，其中 r0<br>后面的 0 就是内核架构主版本号。<br>bit19:16：架构代码，0XF，ARMv7 架构。<br>bit15:4：内核版本号，0XC07，<code>Cortex-A7 MPCore </code>内核。<br>bit3:0：内核架构的次版本号，<code>rnpn </code>中的 <code>pn</code>，比如<code>r0p1</code>中 <code>p1</code> 后面的 1 就是次版本号。</p>
<h2><span id="5-3-c1-ji-cun-qi-sctlr">5.3 c1寄存器（SCTLR）</span><a href="#5-3-c1-ji-cun-qi-sctlr" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/12.png" alt="image"><br><code>CRn=c1，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时的 c1 就是 SCTLR 寄存器，也就是系统控制寄存器，这个是 c1 的基本作用。<br><strong>SCTLR 寄存器主要是完成控制功能的，比如使能或者禁止 MMU、I&#x2F;D Cache 等。</strong>  SCTLR 寄存器展开如下：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/13.png" alt="image"></p>
<p>bit13：V , 中断向量表基地址选择位，为 0 的话中断向量表基地址为 <code>0X00000000</code>，软件可以使用<code>VBAR</code>来重映射此基地址，也就是中断向量表重定位。为 1 的话中断向量表基地址为<code>0XFFFF0000</code>，此基地址不能被重映射。<br>bit12：I，I Cache 使能位，为 0 的话关闭 I Cache，为 1 的话使能 I Cache。<br>bit11：Z，分支预测使能位，如果开启 MMU 的话，此位也会使能。<br>bit10：SW，SWP 和 SWPB 使能位，当为 0 的话关闭 SWP 和 SWPB 指令，当为 1 的时候就使能 SWP 和 SWPB 指令。<br>bit9:3：未使用，保留。<br>bit2：C，D Cache 和缓存一致性使能位，为 0 的时候禁止 D Cache 和缓存一致性，为 1 时使能。<br>bit1：A，内存对齐检查使能位，为 0 的时候关闭内存对齐检查，为 1 的时候使能内存对齐检查。<br>bit0：M，MMU 使能位，为 0 的时候禁止 MMU，为 1 的时候使能 MMU。<br>举个读写SCTLR的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 0, &lt;Rt&gt;, c1, c0, 0 ;读取 SCTLR 寄存器，数据保存到 Rt 中。</span><br><span class="line"></span><br><span class="line">MCR p15, 0, &lt;Rt&gt;, c1, c0, 0 ;将 Rt 中的数据写到 SCTLR(c1)寄存器中。</span><br></pre></td></tr></table></figure>

<p>再来一个关闭MMU,ICache,DCache的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 读取CP15的C1寄存器到R0中       		        	*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>)     <span class="comment">/* 清除C1寄存器的bit12位(I位)，关闭I Cache            	*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt;  <span class="number">2</span>)     <span class="comment">/* 清除C1寄存器的bit2(C位)，关闭D Cache    				*/</span></span><br><span class="line">bic     r0,  r0, #<span class="number">0x2</span>             <span class="comment">/* 清除C1寄存器的bit1(A位)，关闭对齐						*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">11</span>)     <span class="comment">/* 清除C1寄存器的bit11(Z位)，关闭分支预测					*/</span></span><br><span class="line">bic     r0,  r0, #<span class="number">0x1</span>             <span class="comment">/* 清除C1寄存器的bit0(M位)，关闭MMU				       	*/</span></span><br><span class="line">mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 将r0寄存器中的值写入到CP15的C1寄存器中	 				*/</span></span><br></pre></td></tr></table></figure>
<h2><span id="5-4-c12-ji-cun-qi-vbar">5.4 c12寄存器（VBAR）</span><a href="#5-4-c12-ji-cun-qi-vbar" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/14.png" alt="image"><br><code>CRn=c12，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时 c12 为 <code>VBAR </code>寄存器，也就是<strong>中断向量表基地址寄存器</strong>。</p>
<p>比如代码链接到DDR的某个位置作为起始地址，起始地址为<code>0X87800000</code>，而中断向量表肯定要放到最前面，也就是 <code>0X87800000</code> 这个地址处。所以就需要设置 <code>VBAR</code> 为 <code>0X87800000</code>，设置命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dsb</span><br><span class="line">isb</span><br><span class="line">ldr r0, =0x87800000 ; r0=0x87800000</span><br><span class="line">MCR p15, 0, r0, c12, c0, 0 ;将 r0 里面的数据写入到 c12 中，即 c12=0X87800000</span><br><span class="line">dsb</span><br><span class="line">isb</span><br></pre></td></tr></table></figure>
<h2><span id="5-5-c15-ji-cun-qi-cbar">5.5 c15寄存器（CBAR）</span><a href="#5-5-c15-ji-cun-qi-cbar" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/15.png" alt="image"><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/16.png" alt="image"></p>
<p>CBAR寄存器中保存了<code>GIC（Generic Interrupt Controller）</code>的基地址。<code>GIC</code>基地址偏移<code>0x1000</code>是<code>分发器 block</code>, 偏移<code>0x2000</code>是CPU <code>接口端 block</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 4, r1, c15, c0, 0 ; 获取 GIC 基础地址，基地址保存在 r1 中</span><br></pre></td></tr></table></figure>
<h1><span id="6-arm-guan-fang-can-kao-lian-jie">6 arm官方参考链接</span><a href="#6-arm-guan-fang-can-kao-lian-jie" class="header-anchor">#</a></h1><h2><span id="6-1-armv7-yu-armv8-jia-gou">6.1 armv7与armv8架构</span><a href="#6-1-armv7-yu-armv8-jia-gou" class="header-anchor">#</a></h2><p>armv7都是32位处理器，典型的有<code>CorTex-A</code> A7 A8 A9 A15 A17。armv8采用64位处理器，典型的比如手机处理器，有Cortex A53 A76 A77都是64位架构。</p>
<h2><span id="6-2-armv7-can-kao-shou-ce">6.2 armv7参考手册</span><a href="#6-2-armv7-can-kao-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0406/cd?lang=en">https://developer.arm.com/documentation/ddi0406/cd?lang=en</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/17.png" alt="image"></p>
<h2><span id="6-3-armv7-bian-cheng-shou-ce">6.3 armv7 编程手册</span><a href="#6-3-armv7-bian-cheng-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/den0013/d/?lang=en">https://developer.arm.com/documentation/den0013/d/?lang=en</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/18.png" alt="image"></p>
<h2><span id="6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce">6.4 Cortex-A7 <code>MPCore</code> 技术参考手册</span><a href="#6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0464/latest/">https://developer.arm.com/documentation/ddi0464/latest/</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/19.png" alt="image"></p>
<h1><span id="7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li">7 附件1：armv7裸机启动汇编示例：</span><a href="#7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">.global _start  				<span class="comment">/* 全局标号 */</span></span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	ldr pc, =Reset_Handler		<span class="comment">/* 复位中断 					*/</span>	</span><br><span class="line">	ldr pc, =Undefined_Handler	<span class="comment">/* 未定义中断 					*/</span></span><br><span class="line">	ldr pc, =SVC_Handler		<span class="comment">/* SVC(Supervisor)中断 		*/</span></span><br><span class="line">	ldr pc, =PrefAbort_Handler	<span class="comment">/* 预取终止中断 					*/</span></span><br><span class="line">	ldr pc, =DataAbort_Handler	<span class="comment">/* 数据终止中断 					*/</span></span><br><span class="line">	ldr	pc, =NotUsed_Handler	<span class="comment">/* 未使用中断					*/</span></span><br><span class="line">	ldr pc, =IRQ_Handler		<span class="comment">/* IRQ中断 					*/</span></span><br><span class="line">	ldr pc, =FIQ_Handler		<span class="comment">/* FIQ(快速中断)未定义中断 			*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 复位中断 */</span>	</span><br><span class="line">Reset_Handler:</span><br><span class="line"></span><br><span class="line">	cpsid i						<span class="comment">/* 关闭全局中断 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 关闭I,DCache和MMU </span></span><br><span class="line"><span class="comment">	 * 采取读-改-写的方式。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 读取CP15的C1寄存器到R0中       		        	*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>)     <span class="comment">/* 清除C1寄存器的bit12位(I位)，关闭I Cache            	*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt;  <span class="number">2</span>)     <span class="comment">/* 清除C1寄存器的bit2(C位)，关闭D Cache    				*/</span></span><br><span class="line">    bic     r0,  r0, #<span class="number">0x2</span>             <span class="comment">/* 清除C1寄存器的bit1(A位)，关闭对齐						*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">11</span>)     <span class="comment">/* 清除C1寄存器的bit11(Z位)，关闭分支预测					*/</span></span><br><span class="line">    bic     r0,  r0, #<span class="number">0x1</span>             <span class="comment">/* 清除C1寄存器的bit0(M位)，关闭MMU				       	*/</span></span><br><span class="line">    mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 将r0寄存器中的值写入到CP15的C1寄存器中	 				*/</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 汇编版本设置中断向量表偏移 */</span></span><br><span class="line">	ldr r0, =<span class="number">0X87800000</span></span><br><span class="line"></span><br><span class="line">	dsb</span><br><span class="line">	isb</span><br><span class="line">	mcr p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span></span><br><span class="line">	dsb</span><br><span class="line">	isb</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 设置各个模式下的栈指针，</span></span><br><span class="line"><span class="comment">	 * 注意：IMX6UL的堆栈是向下增长的！</span></span><br><span class="line"><span class="comment">	 * 堆栈指针地址一定要是4字节地址对齐的！！！</span></span><br><span class="line"><span class="comment">	 * DDR范围:0X80000000~0X9FFFFFFF</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* 进入IRQ模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x12</span> 	<span class="comment">/* r0或上0x13,表示使用IRQ模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0x80600000</span>	<span class="comment">/* 设置IRQ模式下的栈首地址为0X80600000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 进入SYS模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* r0或上0x13,表示使用SYS模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0x80400000</span>	<span class="comment">/* 设置SYS模式下的栈首地址为0X80400000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 进入SVC模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x13</span> 	<span class="comment">/* r0或上0x13,表示使用SVC模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0X80200000</span>	<span class="comment">/* 设置SVC模式下的栈首地址为0X80200000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	cpsie i				<span class="comment">/* 打开全局中断 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 使能IRQ中断 */</span></span><br><span class="line">	mrs r0, cpsr		<span class="comment">/* 读取cpsr寄存器值到r0中 			*/</span></span><br><span class="line">	bic r0, r0, #<span class="number">0x80</span>	<span class="comment">/* 将r0寄存器中bit7清零，也就是CPSR中的I位清零，表示允许IRQ中断 */</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0重新写入到cpsr中 			*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	b main				<span class="comment">/* 跳转到main函数 			 	*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 未定义中断 */</span></span><br><span class="line">Undefined_Handler:</span><br><span class="line">	ldr r0, =Undefined_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SVC中断 */</span></span><br><span class="line">SVC_Handler:</span><br><span class="line">	ldr r0, =SVC_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 预取终止中断 */</span></span><br><span class="line">PrefAbort_Handler:</span><br><span class="line">	ldr r0, =PrefAbort_Handler	</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据终止中断 */</span></span><br><span class="line">DataAbort_Handler:</span><br><span class="line">	ldr r0, =DataAbort_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 未使用的中断 */</span></span><br><span class="line">NotUsed_Handler:</span><br><span class="line"></span><br><span class="line">	ldr r0, =NotUsed_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line">IRQ_Handler:</span><br><span class="line">	push &#123;lr&#125;					<span class="comment">/* 保存lr地址 */</span></span><br><span class="line">	push &#123;r0-r3, r12&#125;			<span class="comment">/* 保存r0-r3，r12寄存器 */</span></span><br><span class="line"></span><br><span class="line">	mrs r0, spsr				<span class="comment">/* 读取spsr寄存器 */</span></span><br><span class="line">	push &#123;r0&#125;					<span class="comment">/* 保存spsr寄存器 */</span></span><br><span class="line"></span><br><span class="line">	mrc p15, <span class="number">4</span>, r1, c15, c0, <span class="number">0</span> <span class="comment">/* 从CP15的C0寄存器内的值到R1寄存器中</span></span><br><span class="line"><span class="comment">								* 参考文档ARM Cortex-A(armV7)编程手册V4.0.pdf P49</span></span><br><span class="line"><span class="comment">								* Cortex-A7 Technical ReferenceManua.pdf P68 P138</span></span><br><span class="line"><span class="comment">								*/</span>							</span><br><span class="line">	add r1, r1, #<span class="number">0X2000</span>			<span class="comment">/* GIC基地址加0X2000，也就是GIC的CPU接口端基地址 */</span></span><br><span class="line">	ldr r0, [r1, #<span class="number">0XC</span>]			<span class="comment">/* GIC的CPU接口端基地址加0X0C就是GICC_IAR寄存器，</span></span><br><span class="line"><span class="comment">								 * GICC_IAR寄存器保存这当前发生中断的中断号，我们要根据</span></span><br><span class="line"><span class="comment">								 * 这个中断号来绝对调用哪个中断服务函数</span></span><br><span class="line"><span class="comment">								 */</span></span><br><span class="line">	push &#123;r0, r1&#125;				<span class="comment">/* 保存r0,r1 */</span></span><br><span class="line">	</span><br><span class="line">	cps #<span class="number">0x13</span>					<span class="comment">/* 进入SVC模式，允许其他中断再次进去 */</span></span><br><span class="line">	</span><br><span class="line">	push &#123;lr&#125;					<span class="comment">/* 保存SVC模式的lr寄存器 */</span></span><br><span class="line">	ldr r2, =system_irqhandler	<span class="comment">/* 加载C语言中断处理函数到r2寄存器中*/</span></span><br><span class="line">	blx r2						<span class="comment">/* 运行C语言中断处理函数，带有一个参数，保存在R0寄存器中 */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;lr&#125;					<span class="comment">/* 执行完C语言中断服务函数，lr出栈 */</span></span><br><span class="line">	cps #<span class="number">0x12</span>					<span class="comment">/* 进入IRQ模式 */</span></span><br><span class="line">	pop &#123;r0, r1&#125;				</span><br><span class="line">	str r0, [r1, #<span class="number">0X10</span>]			<span class="comment">/* 中断执行完成，写EOIR */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;r0&#125;						</span><br><span class="line">	msr spsr_cxsf, r0			<span class="comment">/* 恢复spsr */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;r0-r3, r12&#125;			<span class="comment">/* r0-r3,r12出栈 */</span></span><br><span class="line">	pop &#123;lr&#125;					<span class="comment">/* lr出栈 */</span></span><br><span class="line">	subs pc, lr, #<span class="number">4</span>				<span class="comment">/* 将lr-4赋给pc */</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">/* FIQ中断 */</span></span><br><span class="line">FIQ_Handler:</span><br><span class="line"></span><br><span class="line">	ldr r0, =FIQ_Handler	</span><br><span class="line">	bx r0</span><br></pre></td></tr></table></figure>
<h1><span id="8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi">8 附件2：GIC指令和寄存器定义（内联汇编方式）</span><a href="#8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __CORTEX_CA7_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __CORTEX_CA7_H</span></span><br><span class="line"><span class="comment">/***************************************************************</span></span><br><span class="line"><span class="comment">文件名	: 	 core_ca7.h</span></span><br><span class="line"><span class="comment">描述	   : Cortex-A7内核通用文件。</span></span><br><span class="line"><span class="comment">其他	   : 本文件主要实现了对GIC操作函数</span></span><br><span class="line"><span class="comment">论坛 	   : www.wtmembed.com</span></span><br><span class="line"><span class="comment">***************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORCEDINLINE  __attribute__((always_inline))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ASM            __asm                         	<span class="comment">/* GNU C语言内嵌汇编关键字 */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __INLINE         inline                      	<span class="comment">/* GNU内联关键字 */</span>             </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STATIC_INLINE  static inline					</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __IM     volatile const      <span class="comment">/* 只读 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __OM     volatile            <span class="comment">/* 只写 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __IOM    volatile            <span class="comment">/* 读写 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STRINGIFY(x) #x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* C语言实现MCR指令 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MCR(coproc, opcode_1, src, CRn, CRm, opcode_2)                          \</span></span><br><span class="line"><span class="meta">    __ASM volatile (<span class="string">&quot;MCR &quot;</span> __STRINGIFY(p##coproc) <span class="string">&quot;, &quot;</span> __STRINGIFY(opcode_1) <span class="string">&quot;, &quot;</span> \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;%0, &quot;</span> __STRINGIFY(c##CRn) <span class="string">&quot;, &quot;</span> __STRINGIFY(c##CRm) <span class="string">&quot;, &quot;</span>      \</span></span><br><span class="line"><span class="meta">                    __STRINGIFY(opcode_2)                                         \</span></span><br><span class="line"><span class="meta">                    : : <span class="string">&quot;r&quot;</span> (src) )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* C语言实现MRC指令 */</span>                    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MRC(coproc, opcode_1, CRn, CRm, opcode_2)                               \</span></span><br><span class="line"><span class="meta">  (&#123;                                                                              \</span></span><br><span class="line"><span class="meta">    uint32_t __dst;                                                               \</span></span><br><span class="line"><span class="meta">    __ASM volatile (<span class="string">&quot;MRC &quot;</span> __STRINGIFY(p##coproc) <span class="string">&quot;, &quot;</span> __STRINGIFY(opcode_1) <span class="string">&quot;, &quot;</span> \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;%0, &quot;</span> __STRINGIFY(c##CRn) <span class="string">&quot;, &quot;</span> __STRINGIFY(c##CRm) <span class="string">&quot;, &quot;</span>      \</span></span><br><span class="line"><span class="meta">                    __STRINGIFY(opcode_2)                                         \</span></span><br><span class="line"><span class="meta">                    : <span class="string">&quot;=r&quot;</span> (__dst) );                                             \</span></span><br><span class="line"><span class="meta">    __dst;                                                                        \</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 其他一些C语言内嵌汇编 */</span>  </span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_APSR(<span class="type">uint32_t</span> apsr)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MSR apsr, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (apsr) : <span class="string">&quot;cc&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">uint32_t</span> __get_CPSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> result;</span><br><span class="line"></span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MRS %0, cpsr&quot;</span> : <span class="string">&quot;=r&quot;</span> (result) )</span>;</span><br><span class="line">  <span class="keyword">return</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_CPSR(<span class="type">uint32_t</span> cpsr)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MSR cpsr, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (cpsr) : <span class="string">&quot;cc&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">uint32_t</span> __get_FPEXC(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> result;</span><br><span class="line"></span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;VMRS %0, fpexc&quot;</span> : <span class="string">&quot;=r&quot;</span> (result) )</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_FPEXC(<span class="type">uint32_t</span> fpexc)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;VMSR fpexc, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (fpexc))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *        		一些内核寄存器定义和抽象</span></span><br><span class="line"><span class="comment">  定义如下几个内核寄存器:</span></span><br><span class="line"><span class="comment">  - CPSR</span></span><br><span class="line"><span class="comment">  - CP15</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CPSR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：ARM Cortex-A(armV7)编程手册V4.0.pdf P46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> M:<span class="number">5</span>;                        <span class="comment">/*!&lt; bit:  0.. 4  Mode field */</span></span><br><span class="line">    <span class="type">uint32_t</span> T:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      5  Thumb execution state bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> F:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      6  FIQ mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      7  IRQ mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      8  Asynchronous abort mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> E:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      9  Endianness execution state bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> IT1:<span class="number">6</span>;                      <span class="comment">/*!&lt; bit: 10..15  If-Then execution state bits 2-7 */</span></span><br><span class="line">    <span class="type">uint32_t</span> GE:<span class="number">4</span>;                       <span class="comment">/*!&lt; bit: 16..19  Greater than or Equal flags */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">4</span>;               <span class="comment">/*!&lt; bit: 20..23  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> J:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     24  Jazelle bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> IT0:<span class="number">2</span>;                      <span class="comment">/*!&lt; bit: 25..26  If-Then execution state bits 0-1 */</span></span><br><span class="line">    <span class="type">uint32_t</span> Q:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     27  Saturation condition flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> V:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     28  Overflow condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> C:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     29  Carry condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> Z:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     30  Zero condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> N:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     31  Negative condition code flag */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; CPSR_Type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的SCTLR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P105</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> M:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     0  MMU enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     1  Alignment check enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> C:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     2  Cache enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 3.. 4  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> CP15BEN:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:     5  CP15 barrier enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:     6  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> B:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     7  Endianness model */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved2:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 8.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> SW:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    10  SWP and SWPB enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> Z:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    11  Branch prediction enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    12  Instruction cache enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> V:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    13  Vectors bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> RR:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    14  Round Robin select */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved3:<span class="number">2</span>;               <span class="comment">/*!&lt; bit:15..16  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> HA:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    17  Hardware Access flag enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved4:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    18  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> WXN:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    19  Write permission implies XN */</span></span><br><span class="line">    <span class="type">uint32_t</span> UWXN:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    20  Unprivileged write permission implies PL1 XN */</span></span><br><span class="line">    <span class="type">uint32_t</span> FI:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    21  Fast interrupts configuration enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> U:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    22  Alignment model */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved5:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    23  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> VE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    24  Interrupt Vectors Enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> EE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    25  Exception Endianness */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved6:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    26  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> NMFI:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    27  Non-maskable FIQ (NMFI) support */</span></span><br><span class="line">    <span class="type">uint32_t</span> TRE:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    28  TEX remap enable. */</span></span><br><span class="line">    <span class="type">uint32_t</span> AFE:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    29  Access flag enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> TE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    30  Thumb Exception enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved7:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; SCTLR_Type;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15 寄存器SCTLR各个位定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TE_Pos                     30U                                    <span class="comment">/*!&lt; SCTLR: TE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TE_Msk                     (1UL &lt;&lt; SCTLR_TE_Pos)                  <span class="comment">/*!&lt; SCTLR: TE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_AFE_Pos                    29U                                    <span class="comment">/*!&lt; SCTLR: AFE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_AFE_Msk                    (1UL &lt;&lt; SCTLR_AFE_Pos)                 <span class="comment">/*!&lt; SCTLR: AFE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TRE_Pos                    28U                                    <span class="comment">/*!&lt; SCTLR: TRE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TRE_Msk                    (1UL &lt;&lt; SCTLR_TRE_Pos)                 <span class="comment">/*!&lt; SCTLR: TRE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_NMFI_Pos                   27U                                    <span class="comment">/*!&lt; SCTLR: NMFI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_NMFI_Msk                   (1UL &lt;&lt; SCTLR_NMFI_Pos)                <span class="comment">/*!&lt; SCTLR: NMFI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_EE_Pos                     25U                                    <span class="comment">/*!&lt; SCTLR: EE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_EE_Msk                     (1UL &lt;&lt; SCTLR_EE_Pos)                  <span class="comment">/*!&lt; SCTLR: EE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_VE_Pos                     24U                                    <span class="comment">/*!&lt; SCTLR: VE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_VE_Msk                     (1UL &lt;&lt; SCTLR_VE_Pos)                  <span class="comment">/*!&lt; SCTLR: VE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_U_Pos                      22U                                    <span class="comment">/*!&lt; SCTLR: U Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_U_Msk                      (1UL &lt;&lt; SCTLR_U_Pos)                   <span class="comment">/*!&lt; SCTLR: U Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_FI_Pos                     21U                                    <span class="comment">/*!&lt; SCTLR: FI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_FI_Msk                     (1UL &lt;&lt; SCTLR_FI_Pos)                  <span class="comment">/*!&lt; SCTLR: FI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_UWXN_Pos                   20U                                    <span class="comment">/*!&lt; SCTLR: UWXN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_UWXN_Msk                   (1UL &lt;&lt; SCTLR_UWXN_Pos)                <span class="comment">/*!&lt; SCTLR: UWXN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_WXN_Pos                    19U                                    <span class="comment">/*!&lt; SCTLR: WXN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_WXN_Msk                    (1UL &lt;&lt; SCTLR_WXN_Pos)                 <span class="comment">/*!&lt; SCTLR: WXN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_HA_Pos                     17U                                    <span class="comment">/*!&lt; SCTLR: HA Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_HA_Msk                     (1UL &lt;&lt; SCTLR_HA_Pos)                  <span class="comment">/*!&lt; SCTLR: HA Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_RR_Pos                     14U                                    <span class="comment">/*!&lt; SCTLR: RR Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_RR_Msk                     (1UL &lt;&lt; SCTLR_RR_Pos)                  <span class="comment">/*!&lt; SCTLR: RR Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_V_Pos                      13U                                    <span class="comment">/*!&lt; SCTLR: V Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_V_Msk                      (1UL &lt;&lt; SCTLR_V_Pos)                   <span class="comment">/*!&lt; SCTLR: V Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_I_Pos                      12U                                    <span class="comment">/*!&lt; SCTLR: I Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_I_Msk                      (1UL &lt;&lt; SCTLR_I_Pos)                   <span class="comment">/*!&lt; SCTLR: I Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_Z_Pos                      11U                                    <span class="comment">/*!&lt; SCTLR: Z Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_Z_Msk                      (1UL &lt;&lt; SCTLR_Z_Pos)                   <span class="comment">/*!&lt; SCTLR: Z Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_SW_Pos                     10U                                    <span class="comment">/*!&lt; SCTLR: SW Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_SW_Msk                     (1UL &lt;&lt; SCTLR_SW_Pos)                  <span class="comment">/*!&lt; SCTLR: SW Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_B_Pos                      7U                                     <span class="comment">/*!&lt; SCTLR: B Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_B_Msk                      (1UL &lt;&lt; SCTLR_B_Pos)                   <span class="comment">/*!&lt; SCTLR: B Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_CP15BEN_Pos                5U                                     <span class="comment">/*!&lt; SCTLR: CP15BEN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_CP15BEN_Msk                (1UL &lt;&lt; SCTLR_CP15BEN_Pos)             <span class="comment">/*!&lt; SCTLR: CP15BEN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_C_Pos                      2U                                     <span class="comment">/*!&lt; SCTLR: C Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_C_Msk                      (1UL &lt;&lt; SCTLR_C_Pos)                   <span class="comment">/*!&lt; SCTLR: C Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_A_Pos                      1U                                     <span class="comment">/*!&lt; SCTLR: A Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_A_Msk                      (1UL &lt;&lt; SCTLR_A_Pos)                   <span class="comment">/*!&lt; SCTLR: A Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_M_Pos                      0U                                     <span class="comment">/*!&lt; SCTLR: M Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_M_Msk                      (1UL &lt;&lt; SCTLR_M_Pos)                   <span class="comment">/*!&lt; SCTLR: M Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的ACTLR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料:Cortex-A7 Technical ReferenceManua.pdf P113</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 0.. 5  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> SMP:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:     6  Enables coherent requests to the processor */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">3</span>;               <span class="comment">/*!&lt; bit: 7.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> DODMBS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    10  Disable optimized data memory barrier behavior */</span></span><br><span class="line">    <span class="type">uint32_t</span> L2RADIS:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:    11  L2 Data Cache read-allocate mode disable */</span></span><br><span class="line">    <span class="type">uint32_t</span> L1RADIS:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:    12  L1 Data Cache read-allocate mode disable */</span></span><br><span class="line">    <span class="type">uint32_t</span> L1PCTL:<span class="number">2</span>;                   <span class="comment">/*!&lt; bit:13..14  L1 Data prefetch control */</span></span><br><span class="line">    <span class="type">uint32_t</span> DDVM:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    15  Disable Distributed Virtual Memory (DVM) transactions */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved3:<span class="number">12</span>;              <span class="comment">/*!&lt; bit:16..27  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> DDI:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    28  Disable dual issue */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved7:<span class="number">3</span>;               <span class="comment">/*!&lt; bit:29..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; ACTLR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDI_Pos                    28U                                     <span class="comment">/*!&lt; ACTLR: DDI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDI_Msk                    (1UL &lt;&lt; ACTLR_DDI_Pos)                  <span class="comment">/*!&lt; ACTLR: DDI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDVM_Pos                   15U                                     <span class="comment">/*!&lt; ACTLR: DDVM Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDVM_Msk                   (1UL &lt;&lt; ACTLR_DDVM_Pos)                 <span class="comment">/*!&lt; ACTLR: DDVM Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1PCTL_Pos                 13U                                     <span class="comment">/*!&lt; ACTLR: L1PCTL Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1PCTL_Msk                 (3UL &lt;&lt; ACTLR_L1PCTL_Pos)               <span class="comment">/*!&lt; ACTLR: L1PCTL Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1RADIS_Pos                12U                                     <span class="comment">/*!&lt; ACTLR: L1RADIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1RADIS_Msk                (1UL &lt;&lt; ACTLR_L1RADIS_Pos)              <span class="comment">/*!&lt; ACTLR: L1RADIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L2RADIS_Pos                11U                                     <span class="comment">/*!&lt; ACTLR: L2RADIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L2RADIS_Msk                (1UL &lt;&lt; ACTLR_L2RADIS_Pos)              <span class="comment">/*!&lt; ACTLR: L2RADIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DODMBS_Pos                 10U                                     <span class="comment">/*!&lt; ACTLR: DODMBS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DODMBS_Msk                 (1UL &lt;&lt; ACTLR_DODMBS_Pos)               <span class="comment">/*!&lt; ACTLR: DODMBS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_SMP_Pos                    6U                                      <span class="comment">/*!&lt; ACTLR: SMP Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_SMP_Msk                    (1UL &lt;&lt; ACTLR_SMP_Pos)                  <span class="comment">/*!&lt; ACTLR: SMP Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的CPACR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P115</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">20</span>;              <span class="comment">/*!&lt; bit: 0..19  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> cp10:<span class="number">2</span>;                     <span class="comment">/*!&lt; bit:20..21  Access rights for coprocessor 10 */</span></span><br><span class="line">    <span class="type">uint32_t</span> cp11:<span class="number">2</span>;                     <span class="comment">/*!&lt; bit:22..23  Access rights for coprocessor 11 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">6</span>;               <span class="comment">/*!&lt; bit:24..29  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> D32DIS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    30  Disable use of registers D16-D31 of the VFP register file */</span></span><br><span class="line">    <span class="type">uint32_t</span> ASEDIS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    31  Disable Advanced SIMD Functionality */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; CPACR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_ASEDIS_Pos                 31U                                    <span class="comment">/*!&lt; CPACR: ASEDIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_ASEDIS_Msk                 (1UL &lt;&lt; CPACR_ASEDIS_Pos)              <span class="comment">/*!&lt; CPACR: ASEDIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_D32DIS_Pos                 30U                                    <span class="comment">/*!&lt; CPACR: D32DIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_D32DIS_Msk                 (1UL &lt;&lt; CPACR_D32DIS_Pos)              <span class="comment">/*!&lt; CPACR: D32DIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp11_Pos                   22U                                    <span class="comment">/*!&lt; CPACR: cp11 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp11_Msk                   (3UL &lt;&lt; CPACR_cp11_Pos)                <span class="comment">/*!&lt; CPACR: cp11 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp10_Pos                   20U                                    <span class="comment">/*!&lt; CPACR: cp10 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp10_Msk                   (3UL &lt;&lt; CPACR_cp10_Pos)                <span class="comment">/*!&lt; CPACR: cp10 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的DFSR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P128</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> FS0:<span class="number">4</span>;                      <span class="comment">/*!&lt; bit: 0.. 3  Fault Status bits bit 0-3 */</span></span><br><span class="line">    <span class="type">uint32_t</span> Domain:<span class="number">4</span>;                   <span class="comment">/*!&lt; bit: 4.. 7  Fault on which domain */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 8.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> FS1:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    10  Fault Status bits bit 4 */</span></span><br><span class="line">    <span class="type">uint32_t</span> WnR:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    11  Write not Read bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> ExT:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    12  External abort type */</span></span><br><span class="line">    <span class="type">uint32_t</span> CM:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    13  Cache maintenance fault */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">18</span>;              <span class="comment">/*!&lt; bit:14..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; DFSR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_CM_Pos                      13U                                    <span class="comment">/*!&lt; DFSR: CM Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_CM_Msk                      (1UL &lt;&lt; DFSR_CM_Pos)                   <span class="comment">/*!&lt; DFSR: CM Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Ext_Pos                     12U                                    <span class="comment">/*!&lt; DFSR: Ext Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Ext_Msk                     (1UL &lt;&lt; DFSR_Ext_Pos)                  <span class="comment">/*!&lt; DFSR: Ext Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_WnR_Pos                     11U                                    <span class="comment">/*!&lt; DFSR: WnR Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_WnR_Msk                     (1UL &lt;&lt; DFSR_WnR_Pos)                  <span class="comment">/*!&lt; DFSR: WnR Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS1_Pos                     10U                                    <span class="comment">/*!&lt; DFSR: FS1 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS1_Msk                     (1UL &lt;&lt; DFSR_FS1_Pos)                  <span class="comment">/*!&lt; DFSR: FS1 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Domain_Pos                  4U                                     <span class="comment">/*!&lt; DFSR: Domain Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Domain_Msk                  (0xFUL &lt;&lt; DFSR_Domain_Pos)             <span class="comment">/*!&lt; DFSR: Domain Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS0_Pos                     0U                                     <span class="comment">/*!&lt; DFSR: FS0 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS0_Msk                     (0xFUL &lt;&lt; DFSR_FS0_Pos)                <span class="comment">/*!&lt; DFSR: FS0 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的IFSR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P131</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> FS0:<span class="number">4</span>;                      <span class="comment">/*!&lt; bit: 0.. 3  Fault Status bits bit 0-3 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 4.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> FS1:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    10  Fault Status bits bit 4 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    11  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> ExT:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    12  External abort type */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved2:<span class="number">19</span>;              <span class="comment">/*!&lt; bit:13..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; IFSR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_ExT_Pos                     12U                                    <span class="comment">/*!&lt; IFSR: ExT Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_ExT_Msk                     (1UL &lt;&lt; IFSR_ExT_Pos)                  <span class="comment">/*!&lt; IFSR: ExT Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS1_Pos                     10U                                    <span class="comment">/*!&lt; IFSR: FS1 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS1_Msk                     (1UL &lt;&lt; IFSR_FS1_Pos)                  <span class="comment">/*!&lt; IFSR: FS1 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS0_Pos                     0U                                     <span class="comment">/*!&lt; IFSR: FS0 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS0_Msk                     (0xFUL &lt;&lt; IFSR_FS0_Pos)                <span class="comment">/*!&lt; IFSR: FS0 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的ISR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：ARM ArchitectureReference Manual ARMv7-A and ARMv7-R edition.pdf P1640</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 0.. 5  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> F:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     6  FIQ pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     7  IRQ pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     8  External abort pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">23</span>;              <span class="comment">/*!&lt; bit:14..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; ISR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_A_Pos                        13U                                    <span class="comment">/*!&lt; ISR: A Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_A_Msk                        (1UL &lt;&lt; ISR_A_Pos)                     <span class="comment">/*!&lt; ISR: A Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_I_Pos                        12U                                    <span class="comment">/*!&lt; ISR: I Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_I_Msk                        (1UL &lt;&lt; ISR_I_Pos)                     <span class="comment">/*!&lt; ISR: I Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_F_Pos                        11U                                    <span class="comment">/*!&lt; ISR: F Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_F_Msk                        (1UL &lt;&lt; ISR_F_Pos)                     <span class="comment">/*!&lt; ISR: F Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mask and shift a bit field value for use in a register bit range. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _VAL2FLD(field, value)    ((value &lt;&lt; field ## _Pos) &amp; field ## _Msk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mask and shift a register value to extract a bit filed value. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FLD2VAL(field, value)    ((value &amp; field ## _Msk) &gt;&gt; field ## _Pos)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *       			CP15 访问函数</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_SCTLR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_SCTLR(<span class="type">uint32_t</span> sctlr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, sctlr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_ACTLR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_ACTLR(<span class="type">uint32_t</span> actlr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, actlr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CPACR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_CPACR(<span class="type">uint32_t</span> cpacr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, cpacr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBR0(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBR0(<span class="type">uint32_t</span> ttbr0)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbr0, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBR1(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBR1(<span class="type">uint32_t</span> ttbr1)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbr1, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBCR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBCR(<span class="type">uint32_t</span> ttbcr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbcr, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DACR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DACR(<span class="type">uint32_t</span> dacr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dacr, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DFSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DFSR(<span class="type">uint32_t</span> dfsr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dfsr, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_IFSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_IFSR(<span class="type">uint32_t</span> ifsr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ifsr, <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DFAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DFAR(<span class="type">uint32_t</span> dfar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dfar, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_IFAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_IFAR(<span class="type">uint32_t</span> ifar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ifar, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_VBAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_VBAR(<span class="type">uint32_t</span> vbar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, vbar, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_ISR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_ISR(<span class="type">uint32_t</span> isr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, isr, <span class="number">12</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CONTEXTIDR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_CONTEXTIDR(<span class="type">uint32_t</span> contextidr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, contextidr, <span class="number">13</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CBAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *                 GIC相关内容</span></span><br><span class="line"><span class="comment"> *有关GIC的内容，参考：ARM Generic Interrupt Controller(ARM GIC控制器)V2.0.pdf</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * GIC寄存器描述结构体，</span></span><br><span class="line"><span class="comment"> * GIC分为分发器端和CPU接口端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED0[<span class="number">1024</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_CTLR;                 <span class="comment">/*!&lt; Offset: 0x1000 (R/W) Distributor Control Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_TYPER;                <span class="comment">/*!&lt; Offset: 0x1004 (R/ )  Interrupt Controller Type Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_IIDR;                 <span class="comment">/*!&lt; Offset: 0x1008 (R/ )  Distributor Implementer Identification Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED1[<span class="number">29</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_IGROUPR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1080 - 0x0BC (R/W) Interrupt Group Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED2[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISENABLER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1100 - 0x13C (R/W) Interrupt Set-Enable Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED3[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICENABLER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1180 - 0x1BC (R/W) Interrupt Clear-Enable Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED4[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISPENDR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1200 - 0x23C (R/W) Interrupt Set-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED5[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICPENDR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1280 - 0x2BC (R/W) Interrupt Clear-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED6[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISACTIVER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1300 - 0x33C (R/W) Interrupt Set-Active Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED7[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICACTIVER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1380 - 0x3BC (R/W) Interrupt Clear-Active Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED8[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_IPRIORITYR[<span class="number">512</span>];      <span class="comment">/*!&lt; Offset: 0x1400 - 0x5FC (R/W) Interrupt Priority Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED9[<span class="number">128</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_ITARGETSR[<span class="number">512</span>];       <span class="comment">/*!&lt; Offset: 0x1800 - 0x9FC (R/W) Interrupt Targets Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED10[<span class="number">128</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICFGR[<span class="number">32</span>];            <span class="comment">/*!&lt; Offset: 0x1C00 - 0xC7C (R/W) Interrupt configuration registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED11[<span class="number">32</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PPISR;                <span class="comment">/*!&lt; Offset: 0x1D00 (R/ ) Private Peripheral Interrupt Status Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_SPISR[<span class="number">15</span>];            <span class="comment">/*!&lt; Offset: 0x1D04 - 0xD3C (R/ ) Shared Peripheral Interrupt Status Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED12[<span class="number">112</span>];</span><br><span class="line">  __OM  <span class="type">uint32_t</span> D_SGIR;                 <span class="comment">/*!&lt; Offset: 0x1F00 ( /W) Software Generated Interrupt Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED13[<span class="number">3</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_CPENDSGIR[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1F10 - 0xF1C (R/W) SGI Clear-Pending Registers */</span></span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_SPENDSGIR[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1F20 - 0xF2C (R/W) SGI Set-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED14[<span class="number">40</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR4;                <span class="comment">/*!&lt; Offset: 0x1FD0 (R/ ) Peripheral ID4 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR5;                <span class="comment">/*!&lt; Offset: 0x1FD4 (R/ ) Peripheral ID5 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR6;                <span class="comment">/*!&lt; Offset: 0x1FD8 (R/ ) Peripheral ID6 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR7;                <span class="comment">/*!&lt; Offset: 0x1FDC (R/ ) Peripheral ID7 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR0;                <span class="comment">/*!&lt; Offset: 0x1FE0 (R/ ) Peripheral ID0 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR1;                <span class="comment">/*!&lt; Offset: 0x1FE4 (R/ ) Peripheral ID1 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR2;                <span class="comment">/*!&lt; Offset: 0x1FE8 (R/ ) Peripheral ID2 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR3;                <span class="comment">/*!&lt; Offset: 0x1FEC (R/ ) Peripheral ID3 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR0;                <span class="comment">/*!&lt; Offset: 0x1FF0 (R/ ) Component ID0 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR1;                <span class="comment">/*!&lt; Offset: 0x1FF4 (R/ ) Component ID1 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR2;                <span class="comment">/*!&lt; Offset: 0x1FF8 (R/ ) Component ID2 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR3;                <span class="comment">/*!&lt; Offset: 0x1FFC (R/ ) Component ID3 Register */</span></span><br><span class="line"></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_CTLR;                 <span class="comment">/*!&lt; Offset: 0x2000 (R/W) CPU Interface Control Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_PMR;                  <span class="comment">/*!&lt; Offset: 0x2004 (R/W) Interrupt Priority Mask Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_BPR;                  <span class="comment">/*!&lt; Offset: 0x2008 (R/W) Binary Point Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_IAR;                  <span class="comment">/*!&lt; Offset: 0x200C (R/ ) Interrupt Acknowledge Register */</span></span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_EOIR;                 <span class="comment">/*!&lt; Offset: 0x2010 ( /W) End Of Interrupt Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_RPR;                  <span class="comment">/*!&lt; Offset: 0x2014 (R/ ) Running Priority Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_HPPIR;                <span class="comment">/*!&lt; Offset: 0x2018 (R/ ) Highest Priority Pending Interrupt Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_ABPR;                 <span class="comment">/*!&lt; Offset: 0x201C (R/W) Aliased Binary Point Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_AIAR;                 <span class="comment">/*!&lt; Offset: 0x2020 (R/ ) Aliased Interrupt Acknowledge Register */</span></span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_AEOIR;                <span class="comment">/*!&lt; Offset: 0x2024 ( /W) Aliased End Of Interrupt Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_AHPPIR;               <span class="comment">/*!&lt; Offset: 0x2028 (R/ ) Aliased Highest Priority Pending Interrupt Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED15[<span class="number">41</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_APR0;                 <span class="comment">/*!&lt; Offset: 0x20D0 (R/W) Active Priority Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED16[<span class="number">3</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_NSAPR0;               <span class="comment">/*!&lt; Offset: 0x20E0 (R/W) Non-secure Active Priority Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED17[<span class="number">6</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_IIDR;                 <span class="comment">/*!&lt; Offset: 0x20FC (R/ ) CPU Interface Identification Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED18[<span class="number">960</span>];</span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_DIR;                  <span class="comment">/*!&lt; Offset: 0x3000 ( /W) Deactivate Interrupt Register */</span></span><br><span class="line">&#125; GIC_Type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * GIC初始化</span></span><br><span class="line"><span class="comment"> * 为了简单使用GIC的group0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> i;</span><br><span class="line">  <span class="type">uint32_t</span> irqRegs;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line"></span><br><span class="line">  irqRegs = (gic-&gt;D_TYPER &amp; <span class="number">0x1F</span>UL) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* On POR, all SPI is in group 0, level-sensitive and using 1-N model */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Disable all PPI, SGI and SPI */</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; irqRegs; i++)</span><br><span class="line">    gic-&gt;D_ICENABLER[i] = <span class="number">0xFFFFFFFF</span>UL;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make all interrupts have higher priority */</span></span><br><span class="line">  gic-&gt;C_PMR = (<span class="number">0xFF</span>UL &lt;&lt; (<span class="number">8</span> - __GIC_PRIO_BITS)) &amp; <span class="number">0xFF</span>UL;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* No subpriority, all priority level allows preemption */</span></span><br><span class="line">  gic-&gt;C_BPR = <span class="number">7</span> - __GIC_PRIO_BITS;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enable group0 distribution */</span></span><br><span class="line">  gic-&gt;D_CTLR = <span class="number">1UL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enable group0 signaling */</span></span><br><span class="line">  gic-&gt;C_CTLR = <span class="number">1UL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 使能指定的中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_EnableIRQ</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_ISENABLER[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &gt;&gt; <span class="number">5</span>] = (<span class="type">uint32_t</span>)(<span class="number">1UL</span> &lt;&lt; (((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &amp; <span class="number">0x1F</span>UL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 关闭指定的中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_DisableIRQ</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_ICENABLER[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &gt;&gt; <span class="number">5</span>] = (<span class="type">uint32_t</span>)(<span class="number">1UL</span> &lt;&lt; (((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &amp; <span class="number">0x1F</span>UL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 返回中断号 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_AcknowledgeIRQ</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	<span class="keyword">return</span> gic-&gt;C_IAR &amp; <span class="number">0x1FFF</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 向EOIR写入发送中断的中断号来释放中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_DeactivateIRQ</span><span class="params">(<span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;C_EOIR = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取运行优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetRunningPriority</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	<span class="keyword">return</span> gic-&gt;C_RPR &amp; <span class="number">0xFF</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 设置组优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_SetPriorityGrouping</span><span class="params">(<span class="type">uint32_t</span> PriorityGroup)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;C_BPR = PriorityGroup &amp; <span class="number">0x7</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取组优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetPriorityGrouping</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> gic-&gt;C_BPR &amp; <span class="number">0x7</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 设置优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_SetPriority</span><span class="params">(IRQn_Type IRQn, <span class="type">uint32_t</span> priority)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_IPRIORITYR[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn)] = (<span class="type">uint8_t</span>)((priority &lt;&lt; (<span class="number">8UL</span> - __GIC_PRIO_BITS)) &amp; (<span class="type">uint32_t</span>)<span class="number">0xFF</span>UL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetPriority</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  <span class="keyword">return</span>(((<span class="type">uint32_t</span>)gic-&gt;D_IPRIORITYR[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn)] &gt;&gt; (<span class="number">8UL</span> - __GIC_PRIO_BITS)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2><span id="8-1-nei-lian-hui-bian-yuan-li">8.1 内联汇编原理</span><a href="#8-1-nei-lian-hui-bian-yuan-li" class="header-anchor">#</a></h2><p>先看一个错误的示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov r1,r0&quot;</span>);</span><br><span class="line">    __asm__(<span class="string">&quot;mov r2,r1&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种操作可能产生负面的影响，因为 r0~r2 寄存器很可能正在被程序的其它部分使用而在这里被意外地修改。<br>这就需要使用到嵌入汇编的另一种表达形式：<br><code>asm(code : output operand list : input operand list : clobber list);</code><br>这种嵌入汇编的形式一共分为四个部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* code</span><br><span class="line">* [attr]output operand list</span><br><span class="line">* [attr]input operand list</span><br><span class="line">* clobber list</span><br></pre></td></tr></table></figure>

<p><code>code</code>：汇编的操作代码，一条或者多条指令，如果是多条指令，需要在指令间使用<code>\n\t</code>隔开。<br>    与通用的汇编代码有一些不同：因为支持 C 变量的操作，所以在操作由第二、三部分提供<br>    的操作数时，使用 %n 来替代操作数。<br><code>output operand list</code>：表示输出的操作数，通常是一个或者多个 C 函数中的变量。<br><code>input operand list</code>：表示输入的操作数，通常是一个或者多个 C 函数中的变量，<code>attr</code>部分表示操作数的属性，以字符串的形式提供，是必须的参数。<br><code>clobber list</code>：被破坏的列表，这部分我们放到后面讨论。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> val1 = <span class="number">111</span>,val2 = <span class="number">222</span>;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot;mov %0,%1&quot;</span></span><br><span class="line">        :<span class="string">&quot;+r&quot;</span>(val1)</span><br><span class="line">        :<span class="string">&quot;r&quot;</span>(val2)</span><br><span class="line">        :);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;val1 = %d\n&quot;</span>,val1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>func</code> 函数的输出结果为：<code>val1 = 222</code>.<br>分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">输出操作数为 val1，属性为 &quot;=r&quot;。</span><br><span class="line">输入操作数为 val2，属性为 &quot;r&quot;</span><br><span class="line">code 部分为 mov %1,%0, %0 表示输入输出列表中的第一个操作数，</span><br><span class="line">	%1 表示操作数列表中提供的第二个操作数，以此类推，这条汇编指</span><br><span class="line">	令很明显就是将第二个操作数(val2)赋值给第一个操作数(val1),所以最后的结果为 val1 = 222.</span><br><span class="line"></span><br><span class="line">code 中的操作数命名顺序为输出操作书列表递增，输入操作数列表递增，比如增加一个操作数的代码为：</span><br><span class="line">	int val1 = 111,val2 = 222,val3=333;</span><br><span class="line">	asm(&quot;mov %0,%2&quot; :&quot;+r&quot;(val1) :&quot;r&quot;(val2),&quot;r&quot;(val3) :);</span><br></pre></td></tr></table></figure>

<h3><span id="8-1-1-cao-zuo-shu-shu-xing">8.1.1 操作数属性</span><a href="#8-1-1-cao-zuo-shu-shu-xing" class="header-anchor">#</a></h3><p>在上述的示例中，输入操作数和输出操作数都会使用到 <code>attr </code>字段，即操作数的属性，下面是其属性对应的列表:</p>
<ul>
<li>“&#x3D;” 表示只写，通常用于所有输出操作数的属性</li>
<li>“+” 表示读写，只能被列为输出操作数的属性，否则编译会报错。</li>
</ul>
<h3><span id="8-1-2-clobber-list">8.1.2 clobber list</span><a href="#8-1-2-clobber-list" class="header-anchor">#</a></h3><p>clobber 的意思为破坏，在这里的意思是：这段汇编指令将会破坏哪些寄存器的值。</p>
<p>在目前的 gcc 设计中，编译分为4个过程：<code>预编译、编译、汇编、链接</code>。  其中，编译就是将 C 代码编译成汇编代码，而通用的汇编代码在这个过程是不会处理的，也就是说，<code>嵌入汇编代码</code>的解析只涉及到输入输出操作数的替换，对于不包含输入输出操作数的部分不会解析，所以在编译阶段，编译器不会知道嵌入汇编代码中静态地使用到哪些寄存器，而是自顾自地编译 C 代码，从而导致 C 代码和嵌入汇编代码操作到同一个寄存器，而出现错误。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov lr,#1&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>嵌入汇编代码过程</code>中，将<code>lr</code>的值修改为 1，当前函数返回的时候也就返回到 1 地址，不出意料: 程序出现段错误:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p>解决办法是：将程序修改一下,用<code>clobber list</code>这种标准格式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov lr,#1&quot;</span>:::<span class="string">&quot;lr&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了进一步追求真相，我们来对比它们的反汇编代码:</p>
<p>不添加 clobber list 的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000083f</span>4 &lt;func3&gt;:</span><br><span class="line">    <span class="number">83f</span>4:       b480            push    &#123;r7&#125;</span><br><span class="line">    <span class="number">83f</span>6:       af00            add     r7, sp, #<span class="number">0</span></span><br><span class="line">    <span class="number">83f</span>8:       f04f <span class="number">0e01</span>       mov.w   lr, #<span class="number">1</span></span><br><span class="line">    <span class="number">83f</span>c:       <span class="number">46b</span>d            mov     sp, r7</span><br><span class="line">    <span class="number">83f</span>e:       f85d <span class="number">7b</span>04       ldr.w   r7, [sp], #<span class="number">4</span></span><br><span class="line">    <span class="number">8402</span>:       <span class="number">4770</span>            bx      lr</span><br></pre></td></tr></table></figure>

<p>添加 clobber list 的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func3</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">83f</span>4:       b580            push    &#123;r7, lr&#125;</span><br><span class="line">    <span class="number">83f</span>6:       af00            add     r7, sp, #<span class="number">0</span></span><br><span class="line">    <span class="number">83f</span>8:       f04f <span class="number">0e01</span>       mov.w   lr, #<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="number">83f</span>c:       bd80            pop     &#123;r7, pc&#125;</span><br><span class="line">    <span class="number">83f</span>e:       bf00            nop</span><br></pre></td></tr></table></figure>

<p>对比可以看出，对于不将<code>&quot;lr&quot;</code>添加到 <code>clobber list </code>中的代码，返回指令为<code> bx lr</code>，因为<code>lr</code>被修改为 1，所以返回一定出错.<br>第二个代码则不一样，在函数调用之初，就将<code>lr</code>寄存器使用 push 指令保存到了栈上，在最后返回的时候再将栈上的原 <code>lr </code>数据 pop 到 pc 指针中，其中<code>lr</code>的修改没有任何影响。</p>
<p>通常情况下，<code>clobber list </code>对应着寄存器的修改，所以我们只需要将寄存器的名字作为参数添加到<code>clobber list</code>中，比如<code>&quot;r0&quot; &quot;lr&quot;</code>等，有<strong>两个特殊的参数需要关注</strong>，就是 **<code>&quot;cc&quot; 和 &quot;memory&quot;</code>**。  </p>
<p><code>&quot;cc&quot; </code>对应的并非是普通寄存器，而是 CPU 的<code>状态寄存器</code>，如果某些指令将状态寄存器修改了，需要在<code>clobber list</code>中添加<code>&quot;cc&quot;</code>来声明这个事情。</p>
<p><code>&quot;memory&quot; </code>对应内存操作，这从名称也可以看出，当<code>clobber list</code>中包含<code>&quot;memory&quot;</code>时，表示嵌入汇编代码会对内存进行一些操作，gcc 生成的代码会将特定的寄存器的值写回到内存中以保证内存中的值是最新的，这样做的原因是 gcc 经常会将内存数据缓存在寄存器中，如果不及时写回，嵌入汇编代码读到的内存就是原来的值。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/" data-id="clyylnk92006f7wuf4bhr2ucx" data-title="通用裸机-arm汇编" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          通用裸机-传感器
        
      </div>
    </a>
  
  
    <a href="/2024/05/02/imx6ull%E8%A3%B8%E6%9C%BA-SPI/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">imx6ull裸机-SPI</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 19.09px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 17.27px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 18.18px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 20px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 11.82px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 12.73px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 17.27px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 13.64px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/04/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-8-%E5%86%85%E6%A0%B8%E5%AE%9A%E6%97%B6%E5%99%A8/">字符设备驱动-8-内核定时器</a>
          </li>
        
          <li>
            <a href="/2024/08/04/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-7-%E5%BC%82%E6%AD%A5%E9%80%9A%E7%9F%A5/">字符设备驱动-7-异步通知</a>
          </li>
        
          <li>
            <a href="/2024/07/30/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-6-poll%E5%BA%95%E5%B1%82%E9%A9%B1%E5%8A%A8%E6%9C%BA%E5%88%B6/">字符设备驱动-6-poll底层驱动机制</a>
          </li>
        
          <li>
            <a href="/2024/07/30/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-6-pre-%E4%BC%91%E7%9C%A0%E5%94%A4%E9%86%92%E6%9C%BA%E5%88%B6/">字符设备驱动-6-pre-休眠唤醒机制</a>
          </li>
        
          <li>
            <a href="/2024/07/28/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-5-%E8%AE%BE%E5%A4%87%E6%A0%91%E5%87%BD%E6%95%B0/">字符设备驱动-5-设备树函数</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
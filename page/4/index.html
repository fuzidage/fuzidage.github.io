<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Linux日志管理-dynamic-debug" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/" class="article-date">
  <time class="dt-published" datetime="2024-06-08T14:22:28.000Z" itemprop="datePublished">2024-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/">Linux日志管理-dynamic_debug</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-dynamic-debug-jie-shao">1 dynamic_debug介绍</a><ul>
<li><a href="#1-1-kai-qi-dynamic-debug">1.1 开启dynamic debug</a></li>
<li><a href="#1-2-dynamic-debug-shi-yong">1.2 dynamic debug使用</a><ul>
<li><a href="#1-2-1-kai-qi-dynamic-debug">1.2.1 开启dynamic debug</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-dev-err-dev-info-dev-warn">2 dev_err&#x2F;dev_info&#x2F;dev_warn</a></li>
<li><a href="#3-ke-bian-can-shu-hong">3 可变参数宏</a></li>
<li><a href="#4-mo-kuai-da-yin-deng-ji-kong-zhi">4 模块打印等级控制</a><ul>
<li><a href="#4-1-an-zhao-da-yin-deng-ji-kong-zhi">4.1 按照打印等级控制</a></li>
<li><a href="#4-2-jing-que-kong-zhi-da-yin-deng-ji">4.2 精确控制打印等级</a></li>
</ul>
</li>
<li><a href="#5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi">5 用户态模块打印等级控制</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-dynamic-debug-jie-shao">1 dynamic_debug介绍</span><a href="#1-dynamic-debug-jie-shao" class="header-anchor">#</a></h1><p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/1.png" alt="img"></p>
<p>这里强烈推荐驱动开发者用这种方式输出log。linux kernel space中有<code>pr_debug</code>及<code>dev_dbg</code>来使用dynamic debug。可以看到当用户<code>define DEBUG</code>后，<code>pr_debug</code>和<code>dev_dbg</code>就等于printk的KERN_DEBUG级别输出了；否则什么也不打印。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/2.png" alt="img"></p>
<h2><span id="1-1-kai-qi-dynamic-debug">1.1 开启dynamic debug</span><a href="#1-1-kai-qi-dynamic-debug" class="header-anchor">#</a></h2><p>要使用dynamic_debug需要在kernel的defconfig中开启。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DYNAMIC_DEBUG=y</span><br></pre></td></tr></table></figure>

<p>用menuconfig去配置的话如下图：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/3.png" alt="img"></p>
<h2><span id="1-2-dynamic-debug-shi-yong">1.2 dynamic debug使用</span><a href="#1-2-dynamic-debug-shi-yong" class="header-anchor">#</a></h2><p>编译好image后，需要挂载debugfs（不挂载的话将不会创建debugfs,那么<code>/sys/kernel/debug/</code>下是空的）。</p>
<p>修改etc&#x2F;fstab文件，追加下面这段字符:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodev      /sys/kernel/debug debugfs   defaults    0   0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/4.png" alt="img"></p>
<p>可以用<code>cat /sys/kernel/debug/dynamic_debug/control | grep xxx.c</code>来查看自己想要查看的log所在文件有没有包含进去。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/5.png" alt="img"></p>
<p>这里可以看到该文件所有用<code>dev_dbg()</code>打印出的讯息。</p>
<p>那如果不开启<code>CONFIG_DYNAMIC_DEBUG</code>，将不会产生<code>/sys/kernel/debug/dynamic_debug</code>目录, 是不能进行动态打印的。</p>
<h3><span id="1-2-1-kai-qi-dynamic-debug">1.2.1 开启dynamic debug</span><a href="#1-2-1-kai-qi-dynamic-debug" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;module cvi_mipi_rx +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">echo <span class="string">&quot;file cvi_vip_cif.c +p&quot;</span> &gt;/sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p>这两种方式都是开dynamic debug，第一种是对模块开启，第二种只对文件开启。</p>
<p>下面举一个栗子：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/6.png" alt="img"></p>
<p>开启之后，可以看到<code>dev_dbg()</code>打印的log都会输出。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/7.png" alt="img"></p>
<p>反之，关闭<code>dynamic debug</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;module cvi_mipi_rx -p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">echo <span class="string">&quot;file cvi_vip_cif.c -p&quot;</span> &gt;/sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p>除了上面的两种方式还有一种可以只开启某个function:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;func _init_resource +p&quot; &gt; /sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/8.png" alt="img"></p>
<h1><span id="2-dev-err-x2f-dev-info-x2f-dev-warn">2 dev_err&#x2F;dev_info&#x2F;dev_warn</span><a href="#2-dev-err-x2f-dev-info-x2f-dev-warn" class="header-anchor">#</a></h1><p>在Linux驱动代码中，有大量的调试信息，那么推荐使用<code>dev_err/dev_info/dev_warn</code>这一系列函数族。这一系列函数族定义在<code>include/linux/device.h</code>。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/9.png" alt="img"></p>
<p>其实这些函数族本质上和下面printk.h中的定义也是完全一致的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> pr_emerg(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_EMERG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_alert(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ALERT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_crit(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_CRIT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_err(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warning(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_WARNING pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warn pr_warning</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_notice(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>

<p>下图是示例，可以看到err级别以下的log没有打印，那么设置printk的控制台级别可以把对应的log输出到console。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/10.png" alt="img"></p>
<p>如何设置printk console level可以看上一篇<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/">Linux日志管理-printk和dmesg</a>。</p>
<h1><span id="3-ke-bian-can-shu-hong">3 可变参数宏</span><a href="#3-ke-bian-can-shu-hong" class="header-anchor">#</a></h1><p>##__VA_ARGS__表示可变参数宏，可以用来传递多个参数，如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> my_dbg(fmt, ...) \</span></span><br><span class="line"><span class="meta">do &#123;                        \</span></span><br><span class="line"><span class="meta">        printf(<span class="string">&quot;[%s] [%d] &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__);\</span></span><br><span class="line"><span class="meta">&#125; while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> my_dbg(fmt...) \</span></span><br><span class="line"><span class="meta">do &#123; \</span></span><br><span class="line"><span class="meta">　　printf(<span class="string">&quot;[%s] [%d] &quot;</span>, __func__, __LINE__); \</span></span><br><span class="line"><span class="meta">　　printf(fmt); \</span></span><br><span class="line"><span class="meta">&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *name = <span class="string">&quot;robin&quot;</span>; <span class="type">int</span> age = <span class="number">18</span>; my_dbg(<span class="string">&quot;this is a test. name:%s, age:%d\n&quot;</span>, name, age);</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/11.png" alt="img"></p>
<p>那和下面这种写法呢本质上是完全一样的。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/12.png" alt="img"></p>
<h1><span id="4-mo-kuai-da-yin-deng-ji-kong-zhi">4 模块打印等级控制</span><a href="#4-mo-kuai-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h1><h2><span id="4-1-an-zhao-da-yin-deng-ji-kong-zhi">4.1 按照打印等级控制</span><a href="#4-1-an-zhao-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _VPSS_DEBUG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _VPSS_DEBUG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/debugfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u32 vpss_log_lv;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_ERR        1   <span class="comment">/* error conditions                     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_WARN       2   <span class="comment">/* warning conditions                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_NOTICE     3   <span class="comment">/* normal but significant condition     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_INFO       4   <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_DEBUG      5   <span class="comment">/* debug-level messages                 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_CVI_LOG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VPSS(level, fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (level &lt;= vpss_log_lv) &#123; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (level == CVI_DBG_ERR) \</span></span><br><span class="line"><span class="meta">                pr_err(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == CVI_DBG_WARN) \</span></span><br><span class="line"><span class="meta">                pr_warn(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == CVI_DBG_NOTICE) \</span></span><br><span class="line"><span class="meta">                pr_notice(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == CVI_DBG_INFO) \</span></span><br><span class="line"><span class="meta">                pr_info(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == CVI_DBG_DEBUG) \</span></span><br><span class="line"><span class="meta">                printk(KERN_DEBUG <span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VPSS(level, fmt, ...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _VPSS_DEBUG_H_ */</span></span></span><br></pre></td></tr></table></figure>

<p>当级别高于DBG,即可输出高于DBG的所有级别打印。</p>
<h2><span id="4-2-jing-que-kong-zhi-da-yin-deng-ji">4.2 精确控制打印等级</span><a href="#4-2-jing-que-kong-zhi-da-yin-deng-ji" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> u32 vi_log_lv;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">vi_msg_pri</span> &#123;</span></span><br><span class="line">    VI_ERR        = <span class="number">0x1</span>,</span><br><span class="line">    VI_WARN        = <span class="number">0x2</span>,</span><br><span class="line">    VI_NOTICE    = <span class="number">0x4</span>,</span><br><span class="line">    VI_INFO        = <span class="number">0x8</span>,</span><br><span class="line">    VI_DBG        = <span class="number">0x10</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vi_pr(level, fmt, arg...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (vi_log_lv &amp; level) &#123; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (level == VI_ERR) \</span></span><br><span class="line"><span class="meta">                pr_err(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_WARN) \</span></span><br><span class="line"><span class="meta">                pr_warn(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_NOTICE) \</span></span><br><span class="line"><span class="meta">                pr_notice(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_INFO) \</span></span><br><span class="line"><span class="meta">                pr_info(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_DBG) \</span></span><br><span class="line"><span class="meta">                pr_debug(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br></pre></td></tr></table></figure>

<p>可以随意开启任意级别打印，比如只开启DBG，只开启WARN。</p>
<h1><span id="5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi">5 用户态模块打印等级控制</span><a href="#5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">CVI_S32 *log_levels;</span><br><span class="line">CVI_CHAR <span class="type">const</span> *log_name[<span class="number">8</span>] = &#123;</span><br><span class="line">    (CVI_CHAR *)<span class="string">&quot;EMG&quot;</span>, (CVI_CHAR *)<span class="string">&quot;ALT&quot;</span>, (CVI_CHAR *)<span class="string">&quot;CRI&quot;</span>, (CVI_CHAR *)<span class="string">&quot;ERR&quot;</span>,</span><br><span class="line">    (CVI_CHAR *)<span class="string">&quot;WRN&quot;</span>, (CVI_CHAR *)<span class="string">&quot;NOT&quot;</span>, (CVI_CHAR *)<span class="string">&quot;INF&quot;</span>, (CVI_CHAR *)<span class="string">&quot;DBG&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">CVI_S32 <span class="title function_">CVI_LOG_SetLevelConf</span><span class="params">(LOG_LEVEL_CONF_S *pstConf)</span></span><br><span class="line">&#123;</span><br><span class="line">    log_levels[pstConf-&gt;enModId] = pstConf-&gt;s32Level;</span><br><span class="line">    <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CVI_S32 <span class="title function_">CVI_LOG_GetLevelConf</span><span class="params">(LOG_LEVEL_CONF_S *pstConf)</span></span><br><span class="line">&#123;</span><br><span class="line">    pstConf-&gt;s32Level = log_levels[pstConf-&gt;enModId];</span><br><span class="line">    <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Copyright (C) Cvitek Co., Ltd. 2019-2020. All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * File Name: include/cvi_debug.h</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __CVI_DEBUG_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __CVI_DEBUG_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cvi_common.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* End of #ifdef __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Debug Config</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CVI_GDB_NO 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CVI_GDB <span class="string">&quot;n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CVI_LOG_TRACE_SUPPORT 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CVI_LOG_TRACE_ALL 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_CVI_LOG_TRACE_LEVEL 4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_EMERG      0   <span class="comment">/* system is unusable                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_ALERT      1   <span class="comment">/* action must be taken immediately     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_CRIT       2   <span class="comment">/* critical conditions                  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_ERR        3   <span class="comment">/* error conditions                     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_WARN       4   <span class="comment">/* warning conditions                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_NOTICE     5   <span class="comment">/* normal but significant condition     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_INFO       6   <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_DBG_DEBUG      7   <span class="comment">/* debug-level messages                 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LOG_LEVEL_CONF_S</span> &#123;</span></span><br><span class="line">    MOD_ID_E  enModId;</span><br><span class="line">    CVI_S32   s32Level;</span><br><span class="line">    <span class="type">char</span>   cModName[<span class="number">16</span>];</span><br><span class="line">&#125; LOG_LEVEL_CONF_S;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_PRINT printf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wunused-variable&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> CVI_S32 * log_levels;</span><br><span class="line"><span class="keyword">extern</span> CVI_CHAR <span class="type">const</span> *log_name[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GENERATE_STRING(STRING) (#STRING),</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> MOD_STRING[] = FOREACH_MOD(_GENERATE_STRING);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_GET_MOD_NAME(id) (id &lt; CVI_ID_BUTT)? MOD_STRING[id] : <span class="string">&quot;UNDEF&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* #ifdef CVI_DEBUG */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CVI_LOG_TRACE_SUPPORT</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> CVI_ASSERT(expr)                               \</span></span><br><span class="line"><span class="meta">    do &#123;                                                   \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(expr)) &#123;                                 \</span></span><br><span class="line"><span class="meta">            printf(<span class="string">&quot;\nASSERT at:\n&quot;</span>                \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Function : %s\n&quot;</span>            \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Line No. : %d\n&quot;</span>            \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Condition: %s\n&quot;</span>,           \</span></span><br><span class="line"><span class="meta">                   __func__, __LINE__, #expr);     \</span></span><br><span class="line"><span class="meta">            _exit(-1);                             \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FPGA_PORTING</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> CVI_TRACE(level, enModId, fmt, ...)            \</span></span><br><span class="line"><span class="meta">    do &#123;                                                   \</span></span><br><span class="line"><span class="meta">        CVI_S32 LogLevel = (log_levels == NULL) ? CONFIG_CVI_LOG_TRACE_LEVEL : log_levels[enModId];      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (level &lt;= LogLevel)           \</span></span><br><span class="line"><span class="meta">            syslog(LOG_LOCAL5|level, <span class="string">&quot;[%s-%s] &quot;</span> fmt, CVI_GET_MOD_NAME(enModId), log_name[level],    \</span></span><br><span class="line"><span class="meta">                ##__VA_ARGS__);           \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> CVI_TRACE(level, enModId, fmt, ...) \</span></span><br><span class="line"><span class="meta">        printf(fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> CVI_ASSERT(expr)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> CVI_TRACE(level, enModId, fmt...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_ID(level, id, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, id, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_LOG(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_LOG, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_SYS(level, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_SYS, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VB(level, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_VB, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_SNS(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_VI, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VI(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_VI, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VPSS(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_VPSS, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_VO(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_VO, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_GDC(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_GDC, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_RGN(level, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_RGN, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_MISC(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_SYS, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_DWA(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_DWA, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_DPU(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_DPU, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_STITCH(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_STITCH, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVI_TRACE_HDMI(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        CVI_TRACE(level, CVI_ID_HDMI, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">/* __CVI_COMM_SYS_H__ */</span></span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/" data-id="clyylnk8i000b7wufcqmxg0qx" data-title="Linux日志管理-dynamic_debug" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux日志管理-printk和demsg" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/" class="article-date">
  <time class="dt-published" datetime="2024-06-07T12:41:02.000Z" itemprop="datePublished">2024-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/">Linux日志管理-printk和demsg</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-printk">1 printk</a><ul>
<li><a href="#1-1-ri-zhi-ji-bie">1.1 日志级别</a></li>
<li><a href="#1-2-kong-zhi-tai-ji-bie">1.2 <strong>控制台级别</strong></a></li>
<li><a href="#1-3-xiu-gai-kong-zhi-tai-ji-bie">1.3 修改控制台级别</a></li>
<li><a href="#1-4-printk-dai-shi-jian-chuo-xun-xi">1.4 printk带时间戳讯息</a></li>
<li><a href="#1-5-printk-di-ceng-shi-xian">1.5 printk底层实现</a><ul>
<li><a href="#1-5-1-ming-ling-xing-can-shu-console">1.5.1 命令行参数console</a></li>
<li><a href="#1-5-2-console-qu-dong-zhu-ce-guo-cheng">1.5.2 console驱动注册过程</a><ul>
<li><a href="#1-5-2-1-chu-li-ming-ling-xing-can-shu">1.5.2.1 处理命令行参数</a></li>
<li><a href="#1-5-2-2-register-console">1.5.2.2 register_console</a></li>
<li><a href="#1-5-2-3-dev-console">1.5.2.3 &#x2F;dev&#x2F;console</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-6-nei-he-xin-xi-de-zao-qi-da-yin">1.6 内核信息的早期打印</a><ul>
<li><a href="#1-6-1-early-printk">1.6.1 early_printk</a></li>
<li><a href="#1-6-2-earlycon">1.6.2 earlycon</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-prink-h-jie-shao">2 prink.h介绍</a></li>
<li><a href="#3-dmesg-ming-ling">3 dmesg命令</a><ul>
<li><a href="#3-1-proc-kmsg">3.1 &#x2F;proc&#x2F;kmsg</a></li>
<li><a href="#3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao">3.2 修改内核日志缓冲区大小</a></li>
<li><a href="#3-3-dmesg">3.3 dmesg</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-printk">1 printk</span><a href="#1-printk" class="header-anchor">#</a></h1><p>printk函数主要做两件事情：第一件就是将信息记录到log中，而第二件事就是调用控制台驱动来将信息输出。printk的相关函数定义在linux&#x2F;printk.h。</p>
<h2><span id="1-1-ri-zhi-ji-bie">1.1 日志级别</span><a href="#1-1-ri-zhi-ji-bie" class="header-anchor">#</a></h2><p>printk需要设置日志级别，用来控制printk打印的这条信息是否在终端上显示的，当printk设置的日志级别高于控制台级别时，printk要打印的信息才会在控制台打印出来。</p>
<p>内核日志一共有8种级别:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_EMERG        <span class="string">&quot;&lt;0&gt;&quot;</span>        <span class="comment">/* system is unusable                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_ALERT        <span class="string">&quot;&lt;1&gt;&quot;</span>        <span class="comment">/* action must be taken immediately        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_CRIT        <span class="string">&quot;&lt;2&gt;&quot;</span>        <span class="comment">/* critical conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_ERR        <span class="string">&quot;&lt;3&gt;&quot;</span>        <span class="comment">/* error conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_WARNING        <span class="string">&quot;&lt;4&gt;&quot;</span>        <span class="comment">/* warning conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_NOTICE        <span class="string">&quot;&lt;5&gt;&quot;</span>        <span class="comment">/* normal but significant condition        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_INFO        <span class="string">&quot;&lt;6&gt;&quot;</span>        <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_DEBUG        <span class="string">&quot;&lt;7&gt;&quot;</span>        <span class="comment">/* debug-level messages                        */</span></span></span><br></pre></td></tr></table></figure>

<h2><span id="1-2-kong-zhi-tai-ji-bie">1.2 <strong>控制台级别</strong></span><a href="#1-2-kong-zhi-tai-ji-bie" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MINIMUM_CONSOLE_LOGLEVEL 1 <span class="comment">/*可以使用的最小日志级别*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_CONSOLE_LOGLEVEL 7 <span class="comment">/*默认的控制台级别*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_MESSAGE_LOGLEVEL 4 <span class="comment">/* 默认的日志级别 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> console_printk[<span class="number">4</span>] = &#123;</span><br><span class="line">    DEFAULT_CONSOLE_LOGLEVEL,<span class="comment">/*控制台日志级别：优先级高于该值的消息将被打印至控制台*/</span></span><br><span class="line">    DEFAULT_MESSAGE_LOGLEVEL,<span class="comment">/*缺省的消息日志级别：将用该优先级来打印没有优先级的消息*/</span></span><br><span class="line">    MINIMUM_CONSOLE_LOGLEVEL,<span class="comment">/*最低的控制台日志级别：控制台日志级别可被设置的最小值（最高优先级）*/</span></span><br><span class="line">    DEFAULT_CONSOLE_LOGLEVEL,<span class="comment">/*缺省的控制台日志级别：控制台日志级别的缺省值*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> console_loglevel (console_printk[0])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> default_message_loglevel (console_printk[1])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> minimum_console_loglevel (console_printk[2])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> default_console_loglevel (console_printk[3])</span></span><br></pre></td></tr></table></figure>

<p>使用命令 <code>cat /proc/sys/kernel/printk </code>来查看这四个值:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/1.png" alt="img"></p>
<p>结果显示了 <em>current</em>, <em>default</em>, <em>minimum</em> 和 <em>boot-time-default</em> 日志级别。</p>
<p>其中的 4 4 1 7，分别对应与：<code>console_loglevel、default_message_loglevel、minimum_console_loglevel、default_console_loglevel</code></p>
<p><strong>default_message_loglevel</strong>：</p>
<p>缺省时的消息日志级别，因此当printk未指定优先级时，将以该默认级别输出，也就是<code>DEFAULT_MESSAGE_LOGLEVEL =4， 对应KERN_WARNING。</code></p>
<p>也就是说<code>printk(&quot;hello world\n&quot;);就表示printk(KERN_WARNING &quot;hello world\n&quot;);</code></p>
<p>那如果我们将控制台级别设成&lt;4，如：</p>
<p><code>echo 3 &gt; /proc/sys/kernel/printk</code></p>
<p>那么<code>printk(&quot;hello world\n&quot;);</code>就无法输出到控制台。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">字符串</th>
<th align="left">别名函数</th>
</tr>
</thead>
<tbody><tr>
<td align="left">KERN_EMERG</td>
<td align="left">“0”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_emerg"><code>pr_emerg()</code></a></td>
</tr>
<tr>
<td align="left">KERN_ALERT</td>
<td align="left">“1”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_alert"><code>pr_alert()</code></a></td>
</tr>
<tr>
<td align="left">KERN_CRIT</td>
<td align="left">“2”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_crit"><code>pr_crit()</code></a></td>
</tr>
<tr>
<td align="left">KERN_ERR</td>
<td align="left">“3”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_err"><code>pr_err()</code></a></td>
</tr>
<tr>
<td align="left">KERN_WARNING</td>
<td align="left">“4”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_warn"><code>pr_warn()</code></a></td>
</tr>
<tr>
<td align="left">KERN_NOTICE</td>
<td align="left">“5”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_notice"><code>pr_notice()</code></a></td>
</tr>
<tr>
<td align="left">KERN_INFO</td>
<td align="left">“6”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_info"><code>pr_info()</code></a></td>
</tr>
<tr>
<td align="left">KERN_DEBUG</td>
<td align="left">“7”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_debug"><code>pr_debug()</code></a> and <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_devel"><code>pr_devel()</code></a> 若定义了DEBUG</td>
</tr>
<tr>
<td align="left">KERN_DEFAULT</td>
<td align="left">“”</td>
<td align="left">KERN_WARNING</td>
</tr>
<tr>
<td align="left">KERN_CONT</td>
<td align="left">“c”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_cont"><code>pr_cont()</code></a></td>
</tr>
</tbody></table>
<h2><span id="1-3-xiu-gai-kong-zhi-tai-ji-bie">1.3 修改控制台级别</span><a href="#1-3-xiu-gai-kong-zhi-tai-ji-bie" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;n&quot;</span> &gt; /proc/sys/kernel/printk</span><br><span class="line"><span class="comment">#Eg:</span></span><br><span class="line"><span class="built_in">echo</span> 8 &gt; /proc/sys/kernel/printk</span><br></pre></td></tr></table></figure>



<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/2.png" alt="img"></p>
<p>另一种方式，使用 <code>dmesg</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg -n 8</span><br></pre></td></tr></table></figure>

<p>此时所有的printk日志级别都会被输出到控制台，如下图所示:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">printk ( KERN_EMERG <span class="string">&quot;Hello, EMERG.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_ALERT <span class="string">&quot;Hello, ALERT.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_CRIT <span class="string">&quot;Hello, CRIT.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_ERR <span class="string">&quot;Hello, ERR.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_WARNING <span class="string">&quot;Hello, WARNING.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_NOTICE <span class="string">&quot;Hello, NOTICE.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_INFO <span class="string">&quot;Hello, INFO.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_DEBUG <span class="string">&quot;Hello, DEBUG.\n&quot;</span> ) ;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/3.png" alt="img"></p>
<p>再来一种方法，修改bootargs：</p>
<p>Uboot中修改<code>console=ttyS0,115200</code>改为<code>loglevel=7 console=ttyS0,115200</code>,表示设置内核的<code>console_loglevel 值=7</code>，开机<code>cat /proc/sys/kernel/printk</code>，可以看到控制台级别被设置成了7:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/4.png" alt="img"></p>
<h2><span id="1-4-printk-dai-shi-jian-chuo-xun-xi">1.4 printk带时间戳讯息</span><a href="#1-4-printk-dai-shi-jian-chuo-xun-xi" class="header-anchor">#</a></h2><p>make menuconfig开启如下:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/5.png" alt="img"></p>
<h2><span id="1-5-printk-di-ceng-shi-xian">1.5 printk底层实现</span><a href="#1-5-printk-di-ceng-shi-xian" class="header-anchor">#</a></h2><p>源码位于<code>kernel\printk\printk.c</code>。</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/6.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">printk</span><br><span class="line">    <span class="comment">// linux 4.9: kernel/printk/internal.h</span></span><br><span class="line">    <span class="comment">// linux 5.4: kernel/printk/printk_safe.c</span></span><br><span class="line">    vprintk_func </span><br><span class="line">        <span class="title function_">vprintk_default</span><span class="params">(fmt, args)</span>;</span><br><span class="line">            vprintk_emit</span><br><span class="line">                vprintk_store <span class="comment">// 把要打印的信息保存在log_buf中</span></span><br><span class="line">                    log_output</span><br><span class="line">                <span class="title function_">preempt_disable</span><span class="params">()</span>;</span><br><span class="line">                <span class="keyword">if</span> (console_trylock_spinning())</span><br><span class="line">                    console_unlock();</span><br><span class="line">                preempt_enable();</span><br><span class="line">console_unlock</span><br><span class="line">    <span class="title function_">for</span> <span class="params">(;;)</span> &#123;</span><br><span class="line">        msg = log_from_idx(console_idx);</span><br><span class="line">        <span class="keyword">if</span> (suppress_message_printing(msg-&gt;level)) &#123;</span><br><span class="line">            <span class="comment">/* 如果消息的级别数值大于console_loglevel, 则不打印此信息 */</span></span><br><span class="line">        &#125;</span><br><span class="line">        printk_safe_enter_irqsave(flags);</span><br><span class="line">        call_console_drivers(ext_text, ext_len, text, len);</span><br><span class="line">        printk_safe_exit_irqrestore(flags);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/7.png" alt="img"></p>
<h3><span id="1-5-1-ming-ling-xing-can-shu-console">1.5.1 命令行参数console</span><a href="#1-5-1-ming-ling-xing-can-shu-console" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* IMX6ULL */</span><br><span class="line">[root@100ask:~]<span class="comment"># cat /proc/cmdline</span></span><br><span class="line">console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw</span><br></pre></td></tr></table></figure>

<p>命令行信息可以来自设备树或者环境变量:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">    chosen &#123;</span><br><span class="line">                bootargs = <span class="string">&quot;console=ttymxc1,115200&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>修改环境变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 进入IMX6ULL的UBOOT */</span></span><br><span class="line">=&gt; print mmcargs</span><br><span class="line">mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</span><br><span class="line">=&gt; print console</span><br><span class="line">console=ttymxc0</span><br><span class="line">=&gt; print baudrate</span><br><span class="line">baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-5-2-console-qu-dong-zhu-ce-guo-cheng">1.5.2 console驱动注册过程</span><a href="#1-5-2-console-qu-dong-zhu-ce-guo-cheng" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">console</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>    name[<span class="number">16</span>];  <span class="comment">// name为&quot;ttyXXX&quot;，在cmdline中用&quot;console=ttyXXX0&quot;来匹配</span></span><br><span class="line">    <span class="comment">// 输出函数</span></span><br><span class="line">    <span class="type">void</span>    (*write)(<span class="keyword">struct</span> console *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">unsigned</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span>        (*read)(<span class="keyword">struct</span> console *, <span class="type">char</span> *, <span class="type">unsigned</span>);</span><br><span class="line">    <span class="comment">// APP访问/dev/console时通过这个函数来确定是哪个(index)设备</span></span><br><span class="line">    <span class="comment">// 举例:</span></span><br><span class="line">    <span class="comment">// a. cmdline中&quot;console=ttymxc1&quot;</span></span><br><span class="line">    <span class="comment">// b. 则注册对应的console驱动时：console-&gt;index = 1</span></span><br><span class="line">    <span class="comment">// c. APP访问/dev/console时调用&quot;console-&gt;device&quot;来返回这个index</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span>  <span class="title">tty_driver</span> *(*<span class="title">device</span>)(<span class="keyword">struct</span> <span class="title">console</span> *<span class="title">co</span>, <span class="title">int</span> *<span class="title">index</span>);</span></span><br><span class="line">    <span class="type">void</span>    (*unblank)(<span class="type">void</span>);</span><br><span class="line">    <span class="comment">// 设置函数, 可设为NULL</span></span><br><span class="line">    <span class="type">int</span>        (*setup)(<span class="keyword">struct</span> console *, <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">// 匹配函数, 可设为NULL</span></span><br><span class="line">    <span class="type">int</span>        (*match)(<span class="keyword">struct</span> console *, <span class="type">char</span> *name, <span class="type">int</span> idx, <span class="type">char</span> *options); </span><br><span class="line">    <span class="type">short</span>    flags;</span><br><span class="line">    <span class="comment">// 哪个设备用作console: </span></span><br><span class="line">    <span class="comment">// a. 可以设置为-1, 表示由cmdline确定</span></span><br><span class="line">    <span class="comment">// b. 也可以直接指定</span></span><br><span class="line">    <span class="type">short</span>    index;</span><br><span class="line">    <span class="comment">// 常用: CON_PRINTBUFFER</span></span><br><span class="line">    <span class="type">int</span>        cflag;</span><br><span class="line">    <span class="type">void</span>    *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>     <span class="title">console</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4><span id="1-5-2-1-chu-li-ming-ling-xing-can-shu">1.5.2.1 处理命令行参数</span><a href="#1-5-2-1-chu-li-ming-ling-xing-can-shu" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__setup(<span class="string">&quot;console=&quot;</span>, console_setup);</span><br><span class="line">console=ttymxc0,<span class="number">115200</span>  console=ttyVIRT0</span><br></pre></td></tr></table></figure>

<p>处理u-boot通过dts传给内核的cmdline参数，比如bootparam参数。</p>
<p>对于这两个”console&#x3D;xxx”就会调用console_setup函数两次，构造得到2个数组项:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">console_cmdline</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>    name[<span class="number">16</span>];            <span class="comment">/* Name of the driver        */</span></span><br><span class="line">    <span class="type">int</span>    index;                <span class="comment">/* Minor dev. to use        */</span></span><br><span class="line">    <span class="type">char</span>    *options;            <span class="comment">/* Options for the driver   */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_A11Y_BRAILLE_CONSOLE</span></span><br><span class="line">    <span class="type">char</span>    *brl_options;            <span class="comment">/* Options for braille driver */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">console_cmdline</span> <span class="title">console_cmdline</span>[<span class="title">MAX_CMDLINECONSOLES</span>];</span></span><br></pre></td></tr></table></figure>

<p>在cmdline中，最后的”console&#x3D;xxx”就是”selected_console”(被选中的console，对应&#x2F;dev&#x2F;console)：</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/8.png" alt="img"></p>
<h4><span id="1-5-2-2-register-console">1.5.2.2 register_console</span><a href="#1-5-2-2-register-console" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uart_add_one_port</span><br><span class="line">    uart_configure_port</span><br><span class="line">        <span class="title function_">register_console</span><span class="params">(port-&gt;cons)</span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18203864">Linux下Uart子系统驱动 - fuzidage - 博客园 (cnblogs.com)</a></p>
<h4><span id="1-5-2-3-x2f-dev-x2f-console">1.5.2.3 &#x2F;dev&#x2F;console</span><a href="#1-5-2-3-x2f-dev-x2f-console" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">tty_open</span><br><span class="line">    tty = tty_open_by_driver(device, inode, filp);</span><br><span class="line">        driver = tty_lookup_driver(device, filp, &amp;index);</span><br><span class="line">            <span class="keyword">case</span> <span class="title function_">MKDEV</span><span class="params">(TTYAUX_MAJOR, <span class="number">1</span>)</span>: &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">console_driver</span> =</span> console_device(index);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* 从console_drivers链表头开始寻找</span></span><br><span class="line"><span class="comment"> * 如果console-&gt;device成功，就返回它对应的tty_driver</span></span><br><span class="line"><span class="comment"> * 这就是/dev/console对应的tty_driver</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">struct</span> tty_driver *<span class="title function_">console_device</span><span class="params">(<span class="type">int</span> *index)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">console</span> *<span class="title">c</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">    console_lock();</span><br><span class="line">    for_each_console(c) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!c-&gt;device)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        driver = c-&gt;device(c, index);</span><br><span class="line">        <span class="keyword">if</span> (driver)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    console_unlock();</span><br><span class="line">    <span class="keyword">return</span> driver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18203864">Linux下Uart子系统驱动 - fuzidage - 博客园 (cnblogs.com)</a></p>
<h2><span id="1-6-nei-he-xin-xi-de-zao-qi-da-yin">1.6 内核信息的早期打印</span><a href="#1-6-nei-he-xin-xi-de-zao-qi-da-yin" class="header-anchor">#</a></h2><p>当我们注册了uart_driver、并调用uart_add_one_port后，它里面才注册console，在这之后才能使用printk。</p>
<p>如果想更早地使用printk函数，比如在安装UART驱动之前就使用printk，这时就需要自己去注册console。</p>
<p>更早地、单独地注册console，有两种方法：</p>
<p>early_printk：自己实现write函数，不涉及设备树，简单明了</p>
<p>earlycon：通过设备树传入硬件信息，跟内核中驱动程序匹配<br>earlycon是新的、推荐的方法，在内核已经有驱动的前提下，通过设备树或cmdline指定寄存器地址即可。</p>
<h3><span id="1-6-1-early-printk">1.6.1 early_printk</span><a href="#1-6-1-early-printk" class="header-anchor">#</a></h3><p>arch\arm\kernel\early_printk.c，必须实现这几点：</p>
<ul>
<li>配置内核，选择：CONFIG_EARLY_PRINTK</li>
<li>内核中实现：printch函数</li>
<li>cmdline中添加：earlyprintk</li>
</ul>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/9.png" alt="img"></p>
<h3><span id="1-6-2-earlycon">1.6.2 earlycon</span><a href="#1-6-2-earlycon" class="header-anchor">#</a></h3><h1><span id="2-prink-h-jie-shao">2 prink.h介绍</span><a href="#2-prink-h-jie-shao" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> pr_emerg(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_EMERG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_alert(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ALERT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_crit(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_CRIT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_err(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warning(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_WARNING pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warn pr_warning</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_notice(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="comment">/* If you are writing a driver, please use dev_dbg instead */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DYNAMIC_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/dynamic_debug.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dynamic_pr_debug() uses pr_fmt() internally so we don&#x27;t need it here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        dynamic_pr_debug(fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        no_printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/10.png" alt="img"></p>
<p><code>pr_emerg到pr_info</code>都是一些基本的kernel打印函数，用来设置内核日志打印级别，可以看到它和下面这种打印本质上并无差异。</p>
<p>而<code>pr_debug</code>则有3种输出方式，当开启dynamic_debug后，则走dynamic_pr_debug流程（dynamic_debug见下一节）。当用户开启了DEBUG宏，则走printk流程，否则什么都不打印。</p>
<h1><span id="3-dmesg-ming-ling">3 dmesg命令</span><a href="#3-dmesg-ming-ling" class="header-anchor">#</a></h1><h2><span id="3-1-x2f-proc-x2f-kmsg">3.1 &#x2F;proc&#x2F;kmsg</span><a href="#3-1-x2f-proc-x2f-kmsg" class="header-anchor">#</a></h2><p><code>/proc/kmsg</code> 是一个特殊的文件，它提供了内核消息缓冲区的访问，这个缓冲区包含了内核产生的所有消息，包括各种调试和错误信息，如内核的启动打印</p>
<p><code>dmesg命令就是cat /proc/kmsg</code>。</p>
<h2><span id="3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao">3.2 修改内核日志缓冲区大小</span><a href="#3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao" class="header-anchor">#</a></h2><p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/11.png" alt="img"></p>
<h2><span id="3-3-dmesg">3.3 dmesg</span><a href="#3-3-dmesg" class="header-anchor">#</a></h2><p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/12.png" alt="img"></p>
<p>dmesg命令是从kernel ring buffer中读取内核日志信息。因此可以用dmesg命令查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-C:  直接清除ring buffer</span><br><span class="line">-c： 当完成打印显示后清除环缓冲内的内容。</span><br><span class="line">-s： 缓冲区大小</span><br><span class="line">　	定义一个大小为&quot;缓冲区大小&quot;的缓冲区用于查询内核环缓冲区。默认大小为 8196，如果你设置了一个大于默认值的环缓冲区，那你就可以用这个选项定义一个相当的缓冲区来查看完整的环缓冲区内容。</span><br><span class="line"></span><br><span class="line">-n：级别</span><br><span class="line"></span><br><span class="line">dmesg -k：打印内核信息</span><br><span class="line">dmesg -u：打印用户空间信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其实用dmesg -n也是可以设置控制台打印级别:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/13.png" alt="img"></p>
<p>有时候在调试kernel驱动时内核panic了or死锁了，那么无法敲命令，如何查看日志呢？重启后日志就没了，那么可以敲如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kmsg &gt; /mnt/data/ker.log &amp; 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p> 用后台进程将日志导入到文件。</p>
<ol>
<li>dmesg -f：根据系统打印信息:</li>
</ol>
<p>可用系统有</p>
<pre><code>kern - kernel messages（内核信息）
user - random user-level messages（随机用户信息）
mail - mail system（邮件系统信息）
daemon - system daemons（系统守护进程信息）
auth - security/authorization messages（认证授权安全信息）
syslog - messages generated internally by syslogd（系统日志信息）
lpr - line printer subsystem（打印机信息）
news - network news subsystem（网络系统信息）
</code></pre>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/14.png" alt="img"></p>
<ol start="2">
<li>dmesg -l：根据level来打印信息:</li>
</ol>
<p>   可用的level信息有</p>
<pre><code>   emerg - system is unusable（系统无法使用）
      alert - action must be taken immediately
       crit - critical conditions（临界条件）
        err - error conditions（错误条件）
       warn - warning conditions（警告条件）
     notice - normal but significant condition
       info - informational
      debug - debug-level messages（debug）
</code></pre>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/15.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/" data-id="clyylnk8i000d7wufe3sqhm4k" data-title="Linux日志管理-printk和demsg" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux日志管理-syslog和rsyslog" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/" class="article-date">
  <time class="dt-published" datetime="2024-06-02T10:13:09.000Z" itemprop="datePublished">2024-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/">Linux日志管理-syslog和rsyslog</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-syslogd-jian-jie">1 syslogd简介</a><ul>
<li><a href="#1-1-ri-zhi-ge-shi">1.1 日志格式</a></li>
<li><a href="#1-2-etc-syslog-conf-fu-wu-pei-zhi">1.2 &#x2F;etc&#x2F;syslog.conf服务配置</a><ul>
<li><a href="#1-2-1-zong-pei-zhi-etc-syslog-conf">1.2.1 总配置&#x2F;etc&#x2F;syslog.conf</a></li>
<li><a href="#1-2-2-rsyslog-gui-ze-etc-rsyslog-d-conf">1.2.2 rsyslog规则（&#x2F;etc&#x2F;rsyslog.d&#x2F;*.conf）</a><ul>
<li><a href="#1-2-2-1-facility-ri-zhi-lei-xing">1.2.2.1 facility-日志类型</a></li>
<li><a href="#1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu">1.2.2.2 level-按严重程度由低到高排序</a></li>
<li><a href="#1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi">1.2.2.3 action-表示log保存的位置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze">1.3 程序如何配置syslog子服务(自定义rsyslog规则)</a></li>
</ul>
</li>
<li><a href="#2-syslog-han-shu">2 syslog()函数</a><ul>
<li><a href="#2-1-openlog-han-shu">2.1 openlog函数</a></li>
<li><a href="#2-2-syslog-han-shu">2.2 syslog函数</a></li>
<li><a href="#2-3-chong-ding-xiang-log">2.3 重定向log</a><ul>
<li><a href="#2-3-1-fang-fa-1-xiu-gai-rsyslog-conf">2.3.1 方法1-修改rsyslog.conf</a></li>
<li><a href="#2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility">2.3.2 方法2-修改code中的facility</a></li>
</ul>
</li>
<li><a href="#2-4-she-zhi-log-deng-ji">2.4 设置log等级</a></li>
<li><a href="#2-5-chong-ding-xiang-log-dao-console">2.5 重定向log到console</a></li>
</ul>
</li>
<li><a href="#3-dup-han-shu-jie-shao">3 dup函数介绍</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-syslogd-jian-jie">1 syslogd简介</span><a href="#1-syslogd-jian-jie" class="header-anchor">#</a></h1><p>syslogd不仅仅是记录kernel log的服务，还能记录user space中的日志。</p>
<p>syslogd是Linux下的一个记录日志文件服务。新版本叫做rsyslogd。</p>
<p>syslogd有一系列的子服务，例如mail、auth、cron、kern等等，这些子服务提供日志记录的功能,。当程序要记录log时,可以直接调用这些子服务将日志记录到设定的地方。</p>
<p><strong>syslogd</strong>是一个守护进程，配置这整个守护进程以及其子服务的地方就是&#x2F;etc&#x2F;syslog.conf这个文件。可以从<a target="_blank" rel="noopener" href="https://www.rsyslog.com/doc/master/%E8%8E%B7%E5%8F%96%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E3%80%82">https://www.rsyslog.com/doc/master/获取官方文档。</a></p>
<h2><span id="1-1-ri-zhi-ge-shi">1.1 日志格式</span><a href="#1-1-ri-zhi-ge-shi" class="header-anchor">#</a></h2><p>如果配置好并运行了 syslogd 或 klogd，一般所有 log的信息也会追加到<code> /var/log/messages</code>。并且kernel log信息被记录在<code>/val/log/kern.log</code>。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/1.png" alt="img"></p>
<p>可以看到基本日志格式包含以下四列:</p>
<ol>
<li>事件产生的时间(Jan 1 08:00:09)</li>
<li>发生事件的服务器的主机名 (cvitek)</li>
<li>产生事件的服务名或程序名 (kernel or local5)</li>
<li>事件的具体信息(…cif a0c2000.cif:..)</li>
</ol>
<p>当开启rsyslogd后，不能透过&#x2F;proc&#x2F;kmsg来查看kernel log。</p>
<h2><span id="1-2-x2f-etc-x2f-syslog-conf-fu-wu-pei-zhi">1.2 &#x2F;etc&#x2F;syslog.conf服务配置</span><a href="#1-2-x2f-etc-x2f-syslog-conf-fu-wu-pei-zhi" class="header-anchor">#</a></h2><ol>
<li>&#x2F;etc&#x2F;rsyslog.conf 是rsyslog服务的总配置文件</li>
<li>&#x2F;etc&#x2F;rsyslog.d 该目录是单独配置的rsyslog配置文件</li>
</ol>
<h3><span id="1-2-1-zong-pei-zhi-x2f-etc-x2f-syslog-conf">1.2.1 总配置&#x2F;etc&#x2F;syslog.conf</span><a href="#1-2-1-zong-pei-zhi-x2f-etc-x2f-syslog-conf" class="header-anchor">#</a></h3><p>rsyslog记录哪些日志，到底记录了什么样的日志，是通过这个<code>/etc/rsyslog.conf</code>配置文件来决定的，先分析一下rsyslogd的总配置文件：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/2.png" alt="img"></p>
<p>默认规则会定义在<code>/etc/rsyslog.d/50-default.conf</code>中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################</span></span><br><span class="line"><span class="comment">#### MODULES ####</span></span><br><span class="line"><span class="comment">#################</span></span><br><span class="line">module(load=<span class="string">&quot;imuxsock&quot;</span>) <span class="comment"># provides support for local system logging   ；加载提供对本地系统日志的支持</span></span><br><span class="line">module(load=<span class="string">&quot;imklog&quot;</span>)   <span class="comment"># provides kernel logging support；加载读取内核消息模块</span></span><br><span class="line"><span class="comment">#module(load=&quot;immark&quot;)  # provides --MARK-- message capability</span></span><br><span class="line"><span class="comment"># provides UDP syslog reception  （接收使用UDP 协议转发过来的日志，这里#注释掉了表示不启用）</span></span><br><span class="line"><span class="comment">#module(load=&quot;imudp&quot;)</span></span><br><span class="line"><span class="comment">#input(type=&quot;imudp&quot; port=&quot;514&quot;)  （允许514端口接收）</span></span><br><span class="line"><span class="comment"># provides TCP syslog reception （接收使用UDP 协议转发过来的日志）</span></span><br><span class="line"><span class="comment">#module(load=&quot;imtcp&quot;)</span></span><br><span class="line"><span class="comment">#input(type=&quot;imtcp&quot; port=&quot;514&quot;)（允许514端口接收）</span></span><br><span class="line"><span class="comment"># Enable non-kernel facility klog messages</span></span><br><span class="line"><span class="variable">$KLogPermitNonKernelFacility</span> on</span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment">#### GLOBAL DIRECTIVES ####</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use traditional timestamp format.</span></span><br><span class="line"><span class="comment"># To enable high precision timestamps, comment out the following line.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$ActionFileDefaultTemplate</span> RSYSLOG_TraditionalFileFormat</span><br><span class="line"><span class="comment"># Filter duplicated messages</span></span><br><span class="line"><span class="variable">$RepeatedMsgReduction</span> on</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the default permissions for all log files.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$FileOwner</span> syslog</span><br><span class="line"><span class="variable">$FileGroup</span> adm</span><br><span class="line"><span class="variable">$FileCreateMode</span> 0640</span><br><span class="line"><span class="variable">$DirCreateMode</span> 0755</span><br><span class="line"><span class="variable">$Umask</span> 0022</span><br><span class="line"><span class="variable">$PrivDropToUser</span> syslog</span><br><span class="line"><span class="variable">$PrivDropToGroup</span> syslog</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Where to place spool and state files</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$WorkDirectory</span> /var/spool/rsyslog</span><br><span class="line">(记录所有日志类型的info级别以及大于info级别的信息到/var/log/messages,但是mail邮件信息,authpriv验证方面的信息和cron时间任务相关的信息除外)</span><br><span class="line"><span class="comment">#*.info;mail.none;authpriv.none;cron.none    /var/log/messages</span></span><br><span class="line"><span class="comment"># Include all config files in /etc/rsyslog.d/ </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$IncludeConfig</span> /etc/rsyslog.d/*.conf  （表示加载该目录中的所有配置）</span><br></pre></td></tr></table></figure>

<h3><span id="1-2-2-rsyslog-gui-ze-x2f-etc-x2f-rsyslog-d-x2f-conf">1.2.2 rsyslog规则（&#x2F;etc&#x2F;rsyslog.d&#x2F;*.conf）</span><a href="#1-2-2-rsyslog-gui-ze-x2f-etc-x2f-rsyslog-d-x2f-conf" class="header-anchor">#</a></h3><p>rsyslog规则配置文件一般由以下3部分组成，每一行表示一个项目，格式为：facility.level action，分别表示日志类型，日志等级，日志输出路径。一般系统默认的规则定义在<code>/etc/rsyslog.d/50-default.conf</code>：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/3.png" alt="img"></p>
<p>一般所有日志类型都会被追加在<code>/val/log/messages</code>。如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.info;mail.none;authpriv.none;cron.none    /var/log/messages  </span><br></pre></td></tr></table></figure>

<h4><span id="1-2-2-1-facility-ri-zhi-lei-xing">1.2.2.1 facility-日志类型</span><a href="#1-2-2-1-facility-ri-zhi-lei-xing" class="header-anchor">#</a></h4><ul>
<li>kern: 内核信息</li>
<li>user: 用户进程相关信息</li>
<li>mail: 电子邮件相关信息</li>
<li>Local0- local7: 为本地使用预留的服务</li>
<li>daemon: 后台进程相关信息</li>
<li>syslog: 系统日志信息</li>
</ul>
<h4><span id="1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu">1.2.2.2 level-按严重程度由低到高排序</span><a href="#1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu" class="header-anchor">#</a></h4><ul>
<li>none: 没有重要级</li>
<li>debug: 调试信息</li>
<li>info: 打印的信息</li>
<li>notice: 具有重要信息的普通条件</li>
<li>warning: 警告信息</li>
<li>err: 错误信息</li>
<li>crit: 阻止某些工具或子系统功能实现的错误条件</li>
<li>alert: 需要立即被修改的条件</li>
<li>emerg: 该系统不可用</li>
</ul>
<h4><span id="1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi">1.2.2.3 action-表示log保存的位置</span><a href="#1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi" class="header-anchor">#</a></h4><p>那下面我也抄过来一份比较全面的规则定义示例供大家参考:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录mail日志等级为error及以上日志</span></span><br><span class="line">mail.err                                                        /var/log/mail_err.log</span><br><span class="line"><span class="comment"># 记录mail所有等级为warn级别的日志（仅记录warn级别）</span></span><br><span class="line">mail.=warn                                                        /var/log/mail_err.log</span><br><span class="line"><span class="comment"># 记录kern所有日志</span></span><br><span class="line">kern.*                                                                /var/log/kern.log</span><br><span class="line"><span class="comment"># 将mail的所有信息，除了info以外，其他的都写入/var/adm/mail</span></span><br><span class="line">mail.*;mail.!=info   /var/adm/mail</span><br><span class="line"><span class="comment"># 将日志等级为crit或更高的内核消息定向到远程主机finlandia</span></span><br><span class="line"><span class="comment"># 如果主机崩溃，磁盘出现不可修复的错误，可能无法读取存储的消息。如果有日志在远程主机上，可以尝试找出崩溃的原因。</span></span><br><span class="line">kern.crit                                                     @finlandia</span><br><span class="line"><span class="comment"># 记录所有类型的warning等级及以上日志</span></span><br><span class="line">*.warning                                                        /var/log/syslog_warn.log</span><br><span class="line"><span class="comment"># 记录mail的warning日志和kern的error日志,其他所有的info日志</span></span><br><span class="line">*.info;mail.warning;kern.error                /var/log/messages</span><br><span class="line"><span class="comment"># 记录kernel的info到warning日志</span></span><br><span class="line">kern.info;kern.!err   /var/adm/kernel-info</span><br><span class="line"><span class="comment"># 将mail和news的info级别日志写入/var/adminfo</span></span><br><span class="line">mail,news.=info    /var/adm/info</span><br><span class="line"><span class="comment"># 将所有系统中所有类型的info日志和notice日志存入/var/log/massages,mail的所有日志除外。</span></span><br><span class="line">*.=info;*.=notice;\</span><br><span class="line">mail.none /var/log/messages</span><br><span class="line"><span class="comment"># 紧急消息（emerg级别）将使用wall显示给当前所有登录的用户，这里用等号表示只对emerg日志级别有效</span></span><br><span class="line">*.=emerg                   *</span><br><span class="line"><span class="comment"># 该规则将所有alert以及更高级别的消息定向到操作员的终端，即登录的用户“root”和“joey”的终端。</span></span><br><span class="line">*.alert      root,joey</span><br></pre></td></tr></table></figure>

<h2><span id="1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze">1.3 程序如何配置syslog子服务(自定义rsyslog规则)</span><a href="#1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze" class="header-anchor">#</a></h2><p><strong>问题：进程如何发送消息给rsyslog守护进程，rsyslog守护进程是如何对各种日志区分开来的？</strong></p>
<p>像<code>/usr/sbin/sshd、/usr/bin/login、/usr/bin/su</code>这些进程，它们是调用一个叫syslog的系统调用, syslog系统调用是一个用于向rsyslog守护进程发送消息的的系统函数。<br><code>/usr/sbin/sshd,/usr/bin/login、/usr/bin/su</code>这些进程专门执行登录验证时，它们在调用syslog系统函数会一般会传入<code>LOG_AUTH</code>这个常量。</p>
<p>而<code>/usr/bin/crond和/usr/bin/at</code>这些在调用syslog系统调用会传入<code>LOG_CRON</code>这个常量（具体请看**syslog()**函数），日志归类规则如下：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/4.png" alt="img"></p>
<p>所以如果用<code>LOG_AUTH</code>的syslog()函数调用，那么会归类到了<code>/val/log/secure</code>。</p>
<p>如果用<code>LOG_CRON</code>的syslog()调用则归类到了<code>/val/log/cron</code>。而kernel等其他log被记录在了<code>/val/log/messages</code>中。</p>
<p>那么我们可以自定义规则如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/5.png" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syslogfacility-text：表示facility日志类型</span><br><span class="line">syslogseverity-text：表示level日志级别</span><br><span class="line"></span><br><span class="line">这里对aisdk.conf用local7日志类型产生的大于warn日志级别的<span class="built_in">log</span>都将记录到/val/log/aisdk，</span><br><span class="line">对kern.conf用kern类型产生的所有级别日志都记录到/val/log/kern，</span><br><span class="line">Local5类型的日志记录到/val/log/middleware, 并且当日志级别等于或高于4（warn）时也会追加到console.</span><br></pre></td></tr></table></figure>

<p>注意busybox要开启使能syslog.conf解析：<code>/etc/syslog.conf</code>解析，<code>CONFIG_FEATURE_SYSLOGD_CFG=y</code></p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/5-1.png" alt="img"></p>
<h1><span id="2-syslog-han-shu">2 syslog()函数</span><a href="#2-syslog-han-shu" class="header-anchor">#</a></h1><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/6.png" alt="img"></p>
<p>用户空间也可以用syslog()函数来记录自己的进程的日志，所以用户进程可以自定义日志规则。<br>调用openlog是可选择的。如果不调用openlog，则在第一次调用syslog时，会自动调用openlog。<br>syslog的相关函数和宏定义一般在toolchain中都会有定义:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/7.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">openlog</span> <span class="params">(<span class="type">char</span>*ident,<span class="type">int</span> option ,<span class="type">int</span> facility)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority,<span class="type">char</span>*format,……)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">closelog</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>



<h2><span id="2-1-openlog-han-shu">2.1 openlog函数</span><a href="#2-1-openlog-han-shu" class="header-anchor">#</a></h2><p>第1个参数为ident，该参数常用来表示信息的来源。ident信息会被固定地添加在每行日志的前面：<br>第2个参数 option控制标志:</p>
<table>
<thead>
<tr>
<th>option控制标志</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_CONS</td>
<td>如果将信息发送给syslogd守护进程时发生错误，直接将相关信息输出到终端</td>
</tr>
<tr>
<td>LOG_PID</td>
<td>每条日志信息中都包括进程号</td>
</tr>
</tbody></table>
<p>第3个参数为facility：</p>
<table>
<thead>
<tr>
<th>facility参数</th>
<th>syslog.conf中对应的facility取值</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_KERN</td>
<td>kern</td>
</tr>
<tr>
<td>LOG_USER</td>
<td>user</td>
</tr>
<tr>
<td>LOG_MAIL</td>
<td>mail</td>
</tr>
<tr>
<td>LOG_DAEMON</td>
<td>daemon</td>
</tr>
<tr>
<td>LOG_AUTH</td>
<td>auth</td>
</tr>
<tr>
<td>LOG_SYSLOG</td>
<td>syslog</td>
</tr>
<tr>
<td>LOG_LPR</td>
<td>lpr</td>
</tr>
<tr>
<td>LOG_NEWS</td>
<td>news</td>
</tr>
<tr>
<td>LOG_UUCP</td>
<td>uucp</td>
</tr>
<tr>
<td>LOG_CRON</td>
<td>cron</td>
</tr>
<tr>
<td>LOG_AUTHPRIV</td>
<td>authpriv</td>
</tr>
<tr>
<td>LOG_FTP</td>
<td>ftp</td>
</tr>
<tr>
<td>LOG_LOCAL0～LOG_LOCAL7</td>
<td>local0～local7</td>
</tr>
</tbody></table>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/8.png" alt="img"></p>
<h2><span id="2-2-syslog-han-shu">2.2 syslog函数</span><a href="#2-2-syslog-han-shu" class="header-anchor">#</a></h2><p>第一个参数priority表示日志级别：</p>
<table>
<thead>
<tr>
<th>priority参数</th>
<th>syslog.conf中对应的level取值</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_EMERG</td>
<td>emerg</td>
</tr>
<tr>
<td>LOG_ALERT</td>
<td>alert</td>
</tr>
<tr>
<td>LOG_CRIT</td>
<td>crit</td>
</tr>
<tr>
<td>LOG_ERR</td>
<td>err</td>
</tr>
<tr>
<td>LOG_WARNING</td>
<td>warning</td>
</tr>
<tr>
<td>LOG_NOTICE</td>
<td>notice</td>
</tr>
<tr>
<td>LOG_INFO</td>
<td>info</td>
</tr>
<tr>
<td>LOG_DEBUG</td>
<td>debug</td>
</tr>
</tbody></table>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/9.png" alt="img"></p>
<p>下面是具体的例子：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/10.png" alt="img"></p>
<p>这里<code>printf(&quot;%m&quot;)等价于printf(&quot;%s&quot;,strerror(errno));</code>它表示把errno用string形式打印出来。</p>
<p>由于我这里facility为user时，是记录在&#x2F;val&#x2F;log&#x2F;syslog中的:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/11.png" alt="img"></p>
<p>因此打印log如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/12.png" alt="img"></p>
<h2><span id="2-3-chong-ding-xiang-log">2.3 重定向log</span><a href="#2-3-chong-ding-xiang-log" class="header-anchor">#</a></h2><p>我们也可以把log定向到自己想要的地方。</p>
<h3><span id="2-3-1-fang-fa-1-xiu-gai-rsyslog-conf">2.3.1 方法1-修改rsyslog.conf</span><a href="#2-3-1-fang-fa-1-xiu-gai-rsyslog-conf" class="header-anchor">#</a></h3><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/13.png" alt="img"></p>
<p>将<code>facility=user</code>时的所有level级别的log重定向到<code>/val/log/user.log</code>, 重启rsyslog服务:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/14.png" alt="img"></p>
<p>此时log将被写入到新配置的位置&#x2F;val&#x2F;log&#x2F;user.log, 当然&#x2F;val&#x2F;log&#x2F;syslog也会保留一份.（因为也符合&#x2F;val&#x2F;log&#x2F;syslog这条规则）</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/15.png" alt="img"></p>
<h3><span id="2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility">2.3.2 方法2-修改code中的facility</span><a href="#2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility" class="header-anchor">#</a></h3><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/16.png" alt="img"></p>
<p>那这里的facility被设置成了local0, 那也会记录在<code>/val/log/syslog</code>:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/17.png" alt="img"></p>
<h2><span id="2-4-she-zhi-log-deng-ji">2.4 设置log等级</span><a href="#2-4-she-zhi-log-deng-ji" class="header-anchor">#</a></h2><ol>
<li>这里新增一个app.conf，然后自定义log路径:</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/18.png" alt="img"></p>
<p>当然还可以类似于这样子写， syslogfacility-text和syslogseverity-text是rsyslog自带的系统变量。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/19.png" alt="img"></p>
<ol start="2">
<li><p>重启rsyslog服务</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/20.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/21.png" alt="img"></p>
<p>这里切成4个文件，每个文件记录1024k。</p>
<ol start="3">
<li><p>运行程序,查看log如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/22.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/23.png" alt="img"></p>
<ol start="4">
<li><p>那现在修改log等级为warn, 表示只有大于等于该等级的log才会记录。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/24.png" alt="img"></p>
</li>
<li><p>再次重启rsyslog服务，运行程序，可以看到”log debug”不再打印：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/25.png" alt="img"></p>
</li>
</ol>
<h2><span id="2-5-chong-ding-xiang-log-dao-console">2.5 重定向log到console</span><a href="#2-5-chong-ding-xiang-log-dao-console" class="header-anchor">#</a></h2><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/26.png" alt="img"></p>
<p>再次重启rsyslog服务，运行程序，那么可以看到err级别的log打印在了console上，但是低于err级别还是会记录在&#x2F;val&#x2F;log&#x2F;app。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/27.png" alt="img"></p>
<h1><span id="3-dup-han-shu-jie-shao">3 dup函数介绍</span><a href="#3-dup-han-shu-jie-shao" class="header-anchor">#</a></h1><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/28.png" alt="img"></p>
<p>用来将标准输出重定向到文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> dup_fd;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> dup_fd_bak = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dup_fd</span><span class="params">(<span class="type">void</span>)</span>  &#123;</span><br><span class="line">    dup_fd = open( <span class="string">&quot;./printf_dup_log.txt &quot;</span>, O_CREAT | O_RDWR | O_TRUNC);</span><br><span class="line">    dup2(STDOUT_FILENO, dup_fd_bak);<span class="comment">/*backup stdout*/</span></span><br><span class="line">    dup2(dup_fd, STDOUT_FILENO);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rst_fd</span><span class="params">(<span class="type">void</span>)</span>  &#123;</span><br><span class="line">    dup2(dup_fd_bak, fileno(<span class="built_in">stdout</span>));<span class="comment">/*recover stdout*/</span></span><br><span class="line">    close(dup_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/" data-id="clyylnk8i000f7wuf3tw3huee" data-title="Linux日志管理-syslog和rsyslog" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-linux基本命令集合" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T11:03:01.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/">linux基本命令集合</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-qian-yan-can-kao-zi-liao">1 前言-参考资料</a></li>
<li><a href="#2-linux-ming-ling">2 linux 命令</a><ul>
<li><a href="#1-1-ci-pan-xiang-guan">1.1 磁盘相关</a><ul>
<li><a href="#1-1-1-fdisk">1.1.1 fdisk</a><ul>
<li><a href="#1-1-1-1-cha-kan-fen-qu">1.1.1.1 查看分区</a></li>
<li><a href="#1-1-1-2-shan-chu-fen-qu">1.1.1.2 删除分区</a></li>
<li><a href="#1-1-1-3-chuang-jian-fen-qu">1.1.1.3 创建分区</a></li>
</ul>
</li>
<li><a href="#1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs">1.1.2 磁盘格式化命令-mkfs</a></li>
<li><a href="#1-1-3-du">1.1.3 du</a></li>
<li><a href="#1-1-4-df">1.1.4 df</a></li>
</ul>
</li>
<li><a href="#1-2-wen-jian-zi-fu-cao-zuo-ming-ling">1.2 文件字符操作命令</a><ul>
<li><a href="#1-2-1-xargs">1.2.1 xargs</a></li>
<li><a href="#1-2-2-grep">1.2.2 grep</a></li>
</ul>
</li>
<li><a href="#1-3-wang-luo-ming-ling">1.3 网络命令</a></li>
</ul>
</li>
<li><a href="#3-shell-jiao-ben-ming-ling">3 shell脚本命令</a><ul>
<li><a href="#3-1-jie-shi-qi">3.1 解释器</a></li>
<li><a href="#3-2-duan-dai-ma-zhu-shi">3.2 段代码注释</a></li>
<li><a href="#3-3-read-ming-ling">3.3 read命令</a></li>
<li><a href="#3-4-test-ming-ling">3.4 test命令</a></li>
<li><a href="#3-5-ming-ling-xing-can-shu">3.5 命令行参数</a></li>
<li><a href="#3-6-tiao-jian-yu-ju">3.6 条件语句</a></li>
<li><a href="#3-7-case-yu-ju">3.7 case语句</a></li>
<li><a href="#3-8-han-shu">3.8 函数</a></li>
<li><a href="#3-9-xun-huan-yu-ju">3.9 循环语句</a></li>
<li><a href="#3-10-typeset-huo-zhe-declare">3.10 typeset或者declare</a></li>
<li><a href="#3-11-unset">3.11 unset</a></li>
<li><a href="#3-12-readonly">3.12 readonly</a></li>
<li><a href="#3-13-sed">3.13 sed</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-qian-yan-can-kao-zi-liao">1 前言-参考资料</span><a href="#1-qian-yan-can-kao-zi-liao" class="header-anchor">#</a></h1><p>正点原子：<a target="_blank" rel="noopener" href="http://www.openedv.com/docs/boards/arm-linux/zdyz-i.mx6ull.html">http://www.openedv.com/docs/boards/arm-linux/zdyz-i.mx6ull.html</a></p>
<h1><span id="2-linux-ming-ling">2 linux 命令</span><a href="#2-linux-ming-ling" class="header-anchor">#</a></h1><h2><span id="1-1-ci-pan-xiang-guan">1.1 磁盘相关</span><a href="#1-1-ci-pan-xiang-guan" class="header-anchor">#</a></h2><h3><span id="1-1-1-fdisk">1.1.1 fdisk</span><a href="#1-1-1-fdisk" class="header-anchor">#</a></h3><h4><span id="1-1-1-1-cha-kan-fen-qu">1.1.1.1 查看分区</span><a href="#1-1-1-1-cha-kan-fen-qu" class="header-anchor">#</a></h4><p><code>fdisk -l</code>显示磁盘分区使用情况</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/0.png" alt="image"></p>
<h4><span id="1-1-1-2-shan-chu-fen-qu">1.1.1.2 删除分区</span><a href="#1-1-1-2-shan-chu-fen-qu" class="header-anchor">#</a></h4><p><code>fdisk /dev/sdb1 </code>用来对sdb1进行分区.</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/1.png" alt="image"></p>
<p>输入m表示获取帮助，默认有分区sdb1, 然后输入d删除分区1，p打印出分区表，i表示打印出详细分区信息，n表示新增分区信息，w表示保存，q表示退出。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/2.png" alt="image"></p>
<p>来看dev&#x2F;sd*信息，发现已经没有了sdb1.</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/3.png" alt="image"></p>
<h4><span id="1-1-1-3-chuang-jian-fen-qu">1.1.1.3 创建分区</span><a href="#1-1-1-3-chuang-jian-fen-qu" class="header-anchor">#</a></h4><p>再来看如何建立分区1：<br>先建立一个1GB的分区，<code>1GB= 1024 * 1024 * 1024=1073741824 B = 2097152</code>个sector，一个sector有512 byte,再加上2048 个sector，那么等于2099200个sector。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/4.png" alt="image"></p>
<p>再来何建立分区2：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/5.png" alt="image"></p>
<p>这里First sector使用默认值2101248，Last sector使用4198400（1G是2097152， 2101248 + 2097152 &#x3D; 4198400），分区2也是1GB<br>再来何建立分区3：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/6.png" alt="image"></p>
<p>First sector和Last sector使用默认，那么最终分区3有26.8GiB。</p>
<p>最后输入w保存退出，来看下分区:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/7.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/8.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/9.png" alt="image"></p>
<h3><span id="1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs">1.1.2 磁盘格式化命令-mkfs</span><a href="#1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs" class="header-anchor">#</a></h3><p>mkfs命令用来对磁盘分区格式化，将格式化好的sd卡放入windows系统查看，可以看到3个盘:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/10.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/11.png" alt="image"></p>
<h3><span id="1-1-3-du">1.1.3 du</span><a href="#1-1-3-du" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/12.png" alt="image"></p>
<h3><span id="1-1-4-df">1.1.4 df</span><a href="#1-1-4-df" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/13.png" alt="image"></p>
<h2><span id="1-2-wen-jian-zi-fu-cao-zuo-ming-ling">1.2 文件字符操作命令</span><a href="#1-2-wen-jian-zi-fu-cao-zuo-ming-ling" class="header-anchor">#</a></h2><h3><span id="1-2-1-xargs">1.2.1 xargs</span><a href="#1-2-1-xargs" class="header-anchor">#</a></h3><p><code>find -name *.sh |xargs grep -rn &quot;build_all&quot;</code></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/14.png" alt="image"></p>
<h3><span id="1-2-2-grep">1.2.2 grep</span><a href="#1-2-2-grep" class="header-anchor">#</a></h3><p><code>find /path/to/directory -type f -name &quot;*.txt&quot; | grep &quot;keyword&quot;</code></p>
<p>-w 全词匹配。<br>-v 反向搜索<br>-i 不区分大小写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$匹配以字符串结尾的行</span><br><span class="line">^ 匹配以字符串开头的行</span><br><span class="line"></span><br><span class="line">找出空行 grep <span class="string">&quot;^$&quot;</span> test.txt -n</span><br><span class="line">找出unix开头的行grep <span class="string">&quot;^unix&quot;</span> geekfile.txt</span><br><span class="line">找出.结尾的行 grep <span class="string">&quot;\.$&quot;</span> test.txt -n -o</span><br><span class="line">找出os.结尾的行，grep <span class="string">&quot;os.$&quot;</span> geekfile.txt</span><br></pre></td></tr></table></figure>

<p><strong>[abc]中括号</strong></p>
<p>匹配abc字符中的任意一个:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/15.png" alt="image"></p>
<p>匹配a-z:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/16.png" alt="image"></p>
<p>下面一个脚本用grep -v排除掉不需要的行，也就是删除包含指定字符的行从一个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 定义要删除的特定字符</span></span><br><span class="line">pattern=<span class="string">&quot;特定字符&quot;</span></span><br><span class="line"><span class="comment"># 定义要处理的文件名</span></span><br><span class="line">filename=<span class="string">&quot;文件名&quot;</span></span><br><span class="line"><span class="comment"># 使用grep命令找到含有特定字符的行，并将结果输出到一个临时文件中</span></span><br><span class="line">grep -v <span class="string">&quot;<span class="variable">$pattern</span>&quot;</span> <span class="string">&quot;<span class="variable">$filename</span>&quot;</span> &gt; temp.txt</span><br><span class="line"><span class="comment"># 将临时文件的内容复制回原始文件</span></span><br><span class="line"><span class="built_in">cat</span> temp.txt &gt; <span class="string">&quot;<span class="variable">$filename</span>&quot;</span></span><br><span class="line"><span class="comment"># 删除临时文件</span></span><br><span class="line"><span class="built_in">rm</span> temp.txt</span><br></pre></td></tr></table></figure>

<h2><span id="1-3-wang-luo-ming-ling">1.3 网络命令</span><a href="#1-3-wang-luo-ming-ling" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up/down</span><br><span class="line">udhcpc -i eth0 //通过路由器分配 IP 地址</span><br><span class="line">ifconfig eth0 192.168.1.251 netmask 255.255.255.0 //设置 IP 地址和子网掩码</span><br><span class="line">route add default gw 192.168.1.1 //添加默认网关</span><br></pre></td></tr></table></figure>

<h1><span id="3-shell-jiao-ben-ming-ling">3 shell脚本命令</span><a href="#3-shell-jiao-ben-ming-ling" class="header-anchor">#</a></h1><h2><span id="3-1-jie-shi-qi">3.1 解释器</span><a href="#3-1-jie-shi-qi" class="header-anchor">#</a></h2><ol>
<li><p>sh解释器</p>
</li>
<li><p>bash解释器<br>脚本开头用<code>#！</code>用来申明用什么解释器，如：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/17.png" alt="image"></p>
</li>
</ol>
<h2><span id="3-2-duan-dai-ma-zhu-shi">3.2 段代码注释</span><a href="#3-2-duan-dai-ma-zhu-shi" class="header-anchor">#</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;EOF</span><br><span class="line">...</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/18.png" alt="image"></p>
<h2><span id="3-3-read-ming-ling">3.3 read命令</span><a href="#3-3-read-ming-ling" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/19.png" alt="image"></p>
<h2><span id="3-4-test-ming-ling">3.4 test命令</span><a href="#3-4-test-ming-ling" class="header-anchor">#</a></h2><p>测试文件，数值，权限，字符串等参数。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/20.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/21.png" alt="image"></p>
<p>中括号也能表示测试，里面只能用&#x3D;&#x3D;或!&#x3D;。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22.png" alt="image"></p>
<h2><span id="3-5-ming-ling-xing-can-shu">3.5 命令行参数</span><a href="#3-5-ming-ling-xing-can-shu" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>, <span class="variable">$1</span>, <span class="variable">$2</span>, <span class="variable">$3</span>...</span><br><span class="line"><span class="variable">$0</span>表示脚本文件名</span><br><span class="line"><span class="variable">$1</span>表示第一个参数</span><br><span class="line"><span class="variable">$n</span>表示第n个参数</span><br><span class="line"><span class="variable">$#</span>表示一共有多少个命令行参数</span><br><span class="line"><span class="variable">$@</span>表示所有的命令行参数集合，<span class="variable">$0</span> <span class="variable">$1</span> <span class="variable">$2</span> ... <span class="variable">$n</span></span><br><span class="line">$*表示等价<span class="variable">$@</span></span><br><span class="line">$?表示上一条命令是否返回成功，成功为0,错误非0</span><br><span class="line">$$表示当前脚本的进程号</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/23.png" alt="image"></p>
<h2><span id="3-6-tiao-jian-yu-ju">3.6 条件语句</span><a href="#3-6-tiao-jian-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/24.png" alt="image"></p>
<h2><span id="3-7-case-yu-ju">3.7 case语句</span><a href="#3-7-case-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/25.png" alt="image"></p>
<h2><span id="3-8-han-shu">3.8 函数</span><a href="#3-8-han-shu" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/26.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/27.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/28.png" alt="image"></p>
<h2><span id="3-9-xun-huan-yu-ju">3.9 循环语句</span><a href="#3-9-xun-huan-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/29.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/30.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/31.png" alt="image"></p>
<h2><span id="3-10-typeset-huo-zhe-declare">3.10 typeset或者declare</span><a href="#3-10-typeset-huo-zhe-declare" class="header-anchor">#</a></h2><p>sh脚本默认所有变量都是字符串，比如val&#x3D;1，也表示val是一个字符串“1”。那么需要如何声明一个变量类型，用typeset或者declare。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">typeset</span> -i data=1</span><br></pre></td></tr></table></figure>

<h2><span id="3-11-unset">3.11 unset</span><a href="#3-11-unset" class="header-anchor">#</a></h2><p>清除变量值.</p>
<h2><span id="3-12-readonly">3.12 readonly</span><a href="#3-12-readonly" class="header-anchor">#</a></h2><p>只读变量.</p>
<h2><span id="3-13-sed">3.13 sed</span><a href="#3-13-sed" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/dir -<span class="built_in">type</span> f -name <span class="string">&quot;*.[c-h]&quot;</span> -<span class="built_in">exec</span> sed -i <span class="string">&#x27;s/oldstring/newstring/g&#x27;</span> &#123;&#125; +</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/dir：找到指定目录/path/to/dir下的所有文件。</span><br><span class="line">-<span class="built_in">type</span> f：仅查找文件。</span><br><span class="line">-name <span class="string">&quot;*.txt&quot;</span>：限制文件名以.txt结尾。</span><br><span class="line">-<span class="built_in">exec</span>：对找到的每个文件执行后面的命令。</span><br><span class="line">sed -i：使用sed进行替换，-i表示直接修改文件内容。</span><br><span class="line"><span class="string">&#x27;s/oldstring/newstring/g&#x27;</span>：sed的替换表达式，g表示全局替换。</span><br><span class="line">&#123;&#125;：表示find找到的文件名。</span><br><span class="line">+：结束-<span class="built_in">exec</span>命令，批量处理匹配到的文件。</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/" data-id="clyylnk8n00137wufbpqxbono" data-title="linux基本命令集合" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-markdown语法教程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T09:24:38.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/">markdown语法教程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-duo-ji-biao-ti-mu-lu-jie-gou">1 多级标题目录结构</a></li>
<li><a href="#yi-ji-biao-ti">一级标题</a><ul>
<li><a href="#er-ji-biao-ti">二级标题</a><ul>
<li><a href="#san-ji-biao-ti">三级标题</a><ul>
<li><a href="#si-ji-biao-ti">四级标题</a><ul>
<li><a href="#wu-ji-biao-ti">五级标题</a><ul>
<li><a href="#liu-ji-biao-ti">六级标题</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-duan-luo">2 段落</a><ul>
<li><a href="#2-1-huan-xing">2.1 换行</a></li>
</ul>
</li>
<li><a href="#3-zi-ti">3 字体</a></li>
<li><a href="#4-zi-ti-yan-se-da-xiao">4 字体颜色,大小</a></li>
<li><a href="#5-zi-ti-bei-jing-yan-se">5 字体背景颜色</a></li>
<li><a href="#5-xia-hua-xian">5 下划线</a></li>
<li><a href="#6-lie-biao-xiang">6 列表项</a></li>
<li><a href="#7-dai-ma-kuai-yu-yu-fa-gao-liang">7 代码块与语法高亮</a><ul>
<li><a href="#7-1-xing-nei-dai-ma">7.1 行内代码</a></li>
<li><a href="#7-2-kuai-dai-ma">7.2 块代码</a></li>
</ul>
</li>
<li><a href="#8-dai-ma-zhe-die">8 代码折叠</a></li>
<li><a href="#9-cha-ru-lian-jie">9 插入链接</a><ul>
<li><a href="#9-1-zi-dong-lian-jie">9.1 自动链接</a></li>
</ul>
</li>
<li><a href="#10-tian-jia-tu-pian">10 添加图片</a></li>
<li><a href="#11-biao-ge">11 表格</a></li>
<li><a href="#12-zhuan-yi-zi-fu">12 转义字符</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-duo-ji-biao-ti-mu-lu-jie-gou">1 多级标题目录结构</span><a href="#1-duo-ji-biao-ti-mu-lu-jie-gou" class="header-anchor">#</a></h1><pre><code># 一级标题
## 二级标题
### 三级标题
#### 四级标题
##### 五级标题
###### 六级标题
</code></pre>
<p>效果如下：</p>
<h1><span id="yi-ji-biao-ti">一级标题</span><a href="#yi-ji-biao-ti" class="header-anchor">#</a></h1><h2><span id="er-ji-biao-ti">二级标题</span><a href="#er-ji-biao-ti" class="header-anchor">#</a></h2><h3><span id="san-ji-biao-ti">三级标题</span><a href="#san-ji-biao-ti" class="header-anchor">#</a></h3><h4><span id="si-ji-biao-ti">四级标题</span><a href="#si-ji-biao-ti" class="header-anchor">#</a></h4><h5><span id="wu-ji-biao-ti">五级标题</span><a href="#wu-ji-biao-ti" class="header-anchor">#</a></h5><h6><span id="liu-ji-biao-ti">六级标题</span><a href="#liu-ji-biao-ti" class="header-anchor">#</a></h6><h1><span id="2-duan-luo">2 段落</span><a href="#2-duan-luo" class="header-anchor">#</a></h1><h2><span id="2-1-huan-xing">2.1 换行</span><a href="#2-1-huan-xing" class="header-anchor">#</a></h2><p>Markdown段落的换行是使用两个以上空格加上回车，当然也可以在段落后面使用一个空行来表示重新开始一个段落。</p>
<h1><span id="3-zi-ti">3 字体</span><a href="#3-zi-ti" class="header-anchor">#</a></h1><pre><code>*斜体*
**粗体**
***加粗斜体***

&lt;font face=&quot;黑体&quot;&gt;我是黑体字&lt;/font&gt;
&lt;font face=&quot;微软雅黑&quot;&gt;我是微软雅黑&lt;/font&gt;
&lt;font face=&quot;STCAIYUN&quot;&gt;我是华文彩云&lt;/font&gt;
</code></pre>
<p>效果：</p>
<p><em>斜体</em><br><strong>粗体</strong><br><em><strong>加粗斜体</strong></em></p>
<p><font face="黑体">我是黑体字</font><br><font face="微软雅黑">我是微软雅黑</font><br><font face="STCAIYUN">我是华文彩云</font></p>
<h1><span id="4-zi-ti-yan-se-da-xiao">4 字体颜色,大小</span><a href="#4-zi-ti-yan-se-da-xiao" class="header-anchor">#</a></h1><pre><code>&lt;font color=#0099ff size=12 face=&quot;黑体&quot;&gt;黑体&lt;/font&gt;
&lt;font color=gray size=5&gt;gray&lt;/font&gt;
&lt;font color=#00ffff size=3&gt;null&lt;/font&gt;
</code></pre>
<p>效果：</p>
<p><font color="#0099ff" size="12" face="黑体">黑体</font><br><font color="gray" size="5">gray</font><br><font color="#00ffff" size="3">null</font></p>
<h1><span id="5-zi-ti-bei-jing-yan-se">5 字体背景颜色</span><a href="#5-zi-ti-bei-jing-yan-se" class="header-anchor">#</a></h1><pre><code>&lt;table&gt;&lt;td bgcolor=pink&gt; 
背景色是pink &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=LightGoldenRodYellow&gt; 
LightGoldenRodYellow &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PeachPuff&gt; 
PeachPuff &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PapayaWhip&gt; 
PapayaWhip &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PaleGreen&gt; 
PaleGreen &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PaleGoldenRod&gt; 
PaleGoldenRod &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=MistyRose&gt; 
MistyRose &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=Linen&gt; 
Linen &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=LightPink&gt; 
LightPink &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=BurlyWood&gt; 
BurlyWood &lt;/table&gt;
</code></pre>
<p>效果：</p>
<table><td bgcolor="pink"> 
背景色是pink </td></table>

<table><td bgcolor="LightGoldenRodYellow"> 
LightGoldenRodYellow </td></table>

<table><td bgcolor="PeachPuff"> 
PeachPuff </td></table>

<table><td bgcolor="PapayaWhip"> 
PapayaWhip </td></table>

<table><td bgcolor="PaleGreen"> 
PaleGreen </td></table>

<table><td bgcolor="PaleGoldenRod"> 
PaleGoldenRod </td></table>

<table><td bgcolor="MistyRose"> 
MistyRose </td></table>

<table><td bgcolor="Linen"> 
Linen </td></table>

<table><td bgcolor="LightPink"> 
LightPink </td></table>

<table><td bgcolor="BurlyWood"> 
BurlyWood </td></table>


<h1><span id="5-xia-hua-xian">5 下划线</span><a href="#5-xia-hua-xian" class="header-anchor">#</a></h1><p>写法：<br>    <code>&lt;u&gt;下划线&lt;/u&gt;</code></p>
<p>效果如下：<br><u>下划线</u></p>
<h1><span id="6-lie-biao-xiang">6 列表项</span><a href="#6-lie-biao-xiang" class="header-anchor">#</a></h1><p>无序列表使用星号(*)、加号(+)或是减号(-)作为列表标记：</p>
<pre><code>* 第一项
* 第二项
* 第三项
</code></pre>
<p>显示效果：  </p>
<ul>
<li>第一项</li>
<li>第二项</li>
<li>第三项</li>
</ul>
<p>有序列表使用数字并加上 <code>.</code> 号来表示： 	<br>    1. 第一项<br>        1. 小一项<br>        2. 小二项<br>    2. 第二项<br>    3. 第三项<br>显示效果： </p>
<ol>
<li>第一项<ol>
<li>小一项</li>
<li>小二项</li>
</ol>
</li>
<li>第二项</li>
<li>第三项</li>
</ol>
<h1><span id="7-dai-ma-kuai-yu-yu-fa-gao-liang">7 代码块与语法高亮</span><a href="#7-dai-ma-kuai-yu-yu-fa-gao-liang" class="header-anchor">#</a></h1><h2><span id="7-1-xing-nei-dai-ma">7.1 行内代码</span><a href="#7-1-xing-nei-dai-ma" class="header-anchor">#</a></h2><p>用反引号 &#96;&#96; 来标记或插入代码区段</p>
<p>效果：<br><code>int main(void)</code></p>
<h2><span id="7-2-kuai-dai-ma">7.2 块代码</span><a href="#7-2-kuai-dai-ma" class="header-anchor">#</a></h2><p>用tab键或者用&#96;&#96;&#96;</p>
<p>效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(vpod)</span> &#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1><span id="8-dai-ma-zhe-die">8 代码折叠</span><a href="#8-dai-ma-zhe-die" class="header-anchor">#</a></h1><p>写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;details&gt;</span><br><span class="line">&lt;summary&gt;点击展开代码&lt;/summary&gt;</span><br><span class="line">&lt;pre&gt;&lt;code&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;hello world\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/code&gt;&lt;/pre&gt;</span><br><span class="line">&lt;/details&gt;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<details>
<summary>点击展开代码</summary>
<pre><code>
    #include &lt;stdio.h&gt;
    int main(int argc, char **argv)
    &#123;
        printf("hello world\n");
        return 0;
    &#125;

<p></p></code></pre><p></p>
</details>

<h1><span id="9-cha-ru-lian-jie">9 插入链接</span><a href="#9-cha-ru-lian-jie" class="header-anchor">#</a></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用:</span><br><span class="line">[fuzidage的博客](https://www.cnblogs.com/fuzidage/)</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/">fuzidage的博客</a></p>
<h2><span id="9-1-zi-dong-lian-jie">9.1 自动链接</span><a href="#9-1-zi-dong-lian-jie" class="header-anchor">#</a></h2><p>只要是用&lt;&gt;包起来， Markdown 就会自动把它转成链接：</p>
<p>效果：<br><a target="_blank" rel="noopener" href="https://github.com/fuzidage">https://github.com/fuzidage</a></p>
<h1><span id="10-tian-jia-tu-pian">10 添加图片</span><a href="#10-tian-jia-tu-pian" class="header-anchor">#</a></h1><pre><code>写法：![](https://img2018.cnblogs.com/blog/1876680/201912/1876680-20191214155002138-1798053565.png)
当然如果是本地图片写法：
![](./markdown语法教程/1.png)
</code></pre>
<p>引用网络效果：</p>
<p><img src="https://img2018.cnblogs.com/blog/1876680/201912/1876680-20191214155002138-1798053565.png"></p>
<p>引用本地图片效果：<br><img src="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/1.png" alt="image-20240526174126727"></p>
<h1><span id="11-biao-ge">11 表格</span><a href="#11-biao-ge" class="header-anchor">#</a></h1><p>写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| 左对齐 | 右对齐 | 居中对齐 |</span><br><span class="line">| :-----| ----: | :----:|</span><br><span class="line">| 单元格 | 单元格 | 单元格 |</span><br><span class="line">| 单元格 | 单元格 | 单元格 |</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<table>
<thead>
<tr>
<th align="left">左对齐</th>
<th align="right">右对齐</th>
<th align="center">居中对齐</th>
</tr>
</thead>
<tbody><tr>
<td align="left">单元格</td>
<td align="right">单元格</td>
<td align="center">单元格</td>
</tr>
<tr>
<td align="left">单元格</td>
<td align="right">单元格</td>
<td align="center">单元格</td>
</tr>
</tbody></table>
<h1><span id="12-zhuan-yi-zi-fu">12 转义字符</span><a href="#12-zhuan-yi-zi-fu" class="header-anchor">#</a></h1><table>
<thead>
<tr>
<th>显示结果</th>
<th>描述</th>
<th>输入</th>
<th>实体编号</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空格</td>
<td>&amp;nbsp；</td>
<td>&amp;#160；</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于号</td>
<td>&amp;lt；</td>
<td>&amp;#60；</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于号</td>
<td>&amp;gt；</td>
<td>&amp;#62；</td>
</tr>
<tr>
<td>&amp;</td>
<td>和号</td>
<td>&amp;amp；</td>
<td>&amp;#38；</td>
</tr>
<tr>
<td>“</td>
<td>引号</td>
<td>&amp;quot；</td>
<td>&amp;#34；</td>
</tr>
<tr>
<td>‘</td>
<td>撇号</td>
<td>&amp;apos；</td>
<td>(IE不支持)	&amp;#39；</td>
</tr>
<tr>
<td>￠</td>
<td>分</td>
<td>&amp;cent；</td>
<td>&amp;#162；</td>
</tr>
<tr>
<td>£</td>
<td>镑</td>
<td>&amp;pound；</td>
<td>&amp;#163；</td>
</tr>
<tr>
<td>¥</td>
<td>日圆</td>
<td>&amp;yen；</td>
<td>&amp;#165；</td>
</tr>
<tr>
<td>§</td>
<td>节</td>
<td>&amp;sect；</td>
<td>&amp;#167；</td>
</tr>
<tr>
<td>©</td>
<td>版权</td>
<td>&amp;copy；</td>
<td>&amp;#169；</td>
</tr>
<tr>
<td>®</td>
<td>注册商标</td>
<td>&amp;reg；</td>
<td>&amp;#174；</td>
</tr>
<tr>
<td>×</td>
<td>乘号</td>
<td>&amp;times；</td>
<td>&amp;#215；</td>
</tr>
<tr>
<td>÷</td>
<td>除号</td>
<td>&amp;divide；</td>
<td>&amp;#247；</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/" data-id="clyylnk8n00177wufhpuw5rwg" data-title="markdown语法教程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-I2c-SMBus协议和I2C-Tools" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T07:00:39.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/">I2C-SMBus协议和I2C Tool</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-smbus-xie-yi">1 SMBus协议</a><ul>
<li><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</a></li>
<li><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</a></li>
<li><a href="#1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</a><ul>
<li><a href="#1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</a></li>
<li><a href="#1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</a></li>
<li><a href="#1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</a></li>
<li><a href="#1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</a></li>
<li><a href="#1-3-5-smbus-read-word">1.3.5 SMBus Read Word</a></li>
<li><a href="#1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</a></li>
<li><a href="#1-3-7-smbus-write-word">1.3.7 SMBus Write Word</a></li>
<li><a href="#1-3-8-smbus-block-read">1.3.8 SMBus Block Read</a></li>
<li><a href="#1-3-8-smbus-block-write">1.3.8 SMBus Block Write</a></li>
<li><a href="#1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</a></li>
<li><a href="#1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</a></li>
</ul>
</li>
<li><a href="#1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</a><ul>
<li><a href="#1-4-1-i2c-block-read">1.4.1 I2C Block Read</a></li>
<li><a href="#1-4-2-i2c-block-write">1.4.2 I2C Block Write</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-i2c-tools">2 I2C Tools</a><ul>
<li><a href="#2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</a></li>
<li><a href="#2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</a><ul>
<li><a href="#2-2-1-i2c-adapter">2.2.1 i2c_adapter</a></li>
<li><a href="#2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</a></li>
<li><a href="#2-3-4-i2c-device-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</a></li>
<li><a href="#2-3-5-i2c-msg">2.3.5 i2c_msg</a></li>
</ul>
</li>
<li><a href="#2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</a><ul>
<li><a href="#2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</a></li>
<li><a href="#2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</a></li>
<li><a href="#2-3-3-bian-yi">2.3.3 编译</a></li>
</ul>
</li>
<li><a href="#2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</a><ul>
<li><a href="#2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</a></li>
<li><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</a></li>
<li><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</a></li>
<li><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</a></li>
</ul>
</li>
<li><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</a><ul>
<li><a href="#2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</a><ul>
<li><a href="#2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</a></li>
<li><a href="#2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</a></li>
<li><a href="#2-5-1-3-zhi-jie-shi-yong-read-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-smbus-xie-yi">1 SMBus协议</span><a href="#1-smbus-xie-yi" class="header-anchor">#</a></h1><h2><span id="1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</span><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji" class="header-anchor">#</a></h2><p>SMBus: System Management Bus，系统管理总线。SMBus 最初的目的是为智能电池、充电电池、其他微控制器之间的通信链路而定义的。SMBus 也被用来连接各种设备，包括电源相关设备，系统传感器，EEPROM 通讯设备等等。SMBus 为系统和电源管理这样的任务提供了一条控制总线，使用 SMBus 的系 统，设备之间发送和接收消息都是通过 SMBus，而不是使用单独的控制线，这样可以节省设备的管脚数。</p>
<p>SMBus 是基于 I2C 协议的，SMBus 要求更严格，SMBus 是 I2C 协议的子集。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/1.png" alt="img"></p>
<h2><span id="1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</span><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi" class="header-anchor">#</a></h2><p>SMBus 有哪些更严格的要求？跟一般的 I2C 协议有哪些差别？</p>
<ol>
<li>VDD 的极限值不一样<br>　　1.1 I2C 协议：范围很广，甚至讨论了高达 12V 的情况<br>　　　　　　　　　　　　　　　　1.2 SMBus：1.8V~5V</li>
<li>速率更高<br>　　I2C 协议：时钟频率最小值无限制，Clock Stretching 时长也没有限制<br>　　　　　　　　　　　　　　　　SMBus：时钟频率最小值是 10KHz，Clock Stretching 的最大时间值也有限制</li>
<li>地址回应(Address Acknowledge)：一个 I2C 设备接收到它的设备地址后， 是否必须发出回应信号？<br>　　I2C 协议：没有强制要求必须发出回应信号<br>　　　　　　　　　　　　　　　　SMBus：强制要求必须发出回应信号，这样对方才知道该设备的状态： busy，failed，或是被移除了</li>
<li>SMBus 协议明确了数据的传输格式<br>　　I2C 协议：它只定义了怎么传输数据，但是并没有定义数据的格式，这完全由设备来定义<br>　　　　　　　　　　　　　　　　SMBus：定义了几种数据格式</li>
<li><code>REPEATED START Condition(重复发出 S 信号)</code><br>　　比如读 EEPROM 时，涉及 2 个操作：<br>　　　　　　　　　　　　　　​	 把存储地址发给设备<br>　　　　　　　　　　　　　　​	 读数据<br>　　　　　　　　　　　　　　在写、读之间，可以不发出 P 信号，而是直接发出 S 信号：这个 S 信号就是<br>　　　　　　　　　　　　　　<code>REPEATED START</code></li>
</ol>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/2.png" alt="img"></p>
<h2><span id="1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</span><a href="#1-3-smbus-shu-ju-ge-shi" class="header-anchor">#</a></h2><p>下面文档中的 Functionality flag 是 Linux 的某个 I2C 控制器驱动所支持的功能。比如 Functionality flag: I2C_FUNC_SMBUS_QUICK，表示需要I2C 控制器支持 SMBus Quick Command。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">symbols(符号)：</span><br><span class="line">S (<span class="number">1</span> bit) : Start <span class="title function_">bit</span><span class="params">(开始位)</span></span><br><span class="line">　<span class="title function_">Sr</span> <span class="params">(<span class="number">1</span> bit)</span> : 重复的开始位</span><br><span class="line">　<span class="title function_">P</span> <span class="params">(<span class="number">1</span> bit)</span> : Stop <span class="title function_">bit</span><span class="params">(停止位)</span></span><br><span class="line">　R/W# <span class="params">(<span class="number">1</span> bit)</span> : Read/Write bit. Rd equals 1, Wr equals 0.<span class="params">(读写位)</span></span><br><span class="line">　A, <span class="title function_">N</span> <span class="params">(<span class="number">1</span> bit)</span> : Accept and reverse accept bit.<span class="params">(回应位)</span></span><br><span class="line">　<span class="title function_">Address</span><span class="params">(<span class="number">7</span> bits)</span>: I2C 7 bit address. Note that this can be expanded as usual to get a 10 bit I2C address.<span class="params">(地址位，<span class="number">7</span> 位地址)</span></span><br><span class="line">　Command <span class="title function_">Code</span> <span class="params">(<span class="number">8</span> bits)</span>: Command byte, a data byte which often selects a <span class="keyword">register</span> on the device.<span class="params">(命令字节，一般用来选择芯片内部的寄存器)</span></span><br><span class="line">  Data <span class="title function_">Byte</span> <span class="params">(<span class="number">8</span> bits)</span>: A plain data byte. Sometimes, I write DataLow, DataHigh <span class="keyword">for</span> 16 bit data.<span class="params">(数据字节，<span class="number">8</span> 位；如果是 <span class="number">16</span> 位数据的话，用 <span class="number">2</span> 个字节来表示：DataLow、DataHigh)</span></span><br><span class="line">　<span class="title function_">Count</span> <span class="params">(<span class="number">8</span> bits)</span>: A data byte containing the length of a block operation.<span class="params">(在 block 操作总，表示数据长度)</span></span><br><span class="line">　[..]: Data sent by I2C device, as opposed to data sent by the host adapter.<span class="params">(中括号表示 I2C 设备发送的数据，没有中括号表示 host adapter 发送的数据)</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</span><a href="#1-3-1-smbus-quick-command" class="header-anchor">#</a></h3><p>只是用来发送一位数据：R&#x2F;W#本意是用来表示读或写，但是在 SMBus 里可以用来表示其他含义。比如某些开关设备，可以根据这一位来决定是打开还是关闭.</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/3.png" alt="img"></p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_QUICK</strong></p>
<h3><span id="1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</span><a href="#1-3-2-smbus-receive-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/4.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte()</code>。读取一个字节，Host adapter 接收到一个字节后不需要发出回应信号(上图中 N 表示不回应)。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</span><a href="#1-3-3-smbus-send-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/5.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte()</code>。发送一个字节。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</span><a href="#1-3-4-smbus-read-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/6.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取一个字节的数据。上面介绍的 SMBus Receive Byte 是不发送 Comand，直接读取数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BYTE_DATA</strong></p>
<h3><span id="1-3-5-smbus-read-word">1.3.5 SMBus Read Word</span><a href="#1-3-5-smbus-read-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/7.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取 2 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_WORD_DATA</strong></p>
<h3><span id="1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</span><a href="#1-3-6-smbus-write-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/8.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE_DATA</strong></p>
<h3><span id="1-3-7-smbus-write-word">1.3.7 SMBus Write Word</span><a href="#1-3-7-smbus-write-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/9.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_WORD_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-read">1.3.8 SMBus Block Read</span><a href="#1-3-8-smbus-block-read" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/10.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发起度操作：</p>
<p>　　1. 先读到一个字节(Block Count)，表示后续要读的字节数<br>　　1.  然后读取全部数据</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BLOCK_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-write">1.3.8 SMBus Block Write</span><a href="#1-3-8-smbus-block-write" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/11.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 Byte Conut(表示后续要发出的数据字节数)，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BLOCK_DATA</strong></p>
<h3><span id="1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</span><a href="#1-3-9-smbus-block-write-block-read-process-call" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/12.png" alt="img"></p>
<p>先写一块数据，再读一块数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_BLOCK_PROC_CALL</strong></p>
<h3><span id="1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</span><a href="#1-3-10-packet-error-checking-pec" class="header-anchor">#</a></h3><p>PEC 是一种错误校验码，如果使用 PEC，那么在 P 信号之前，数据发送方要发送一个字节的 PEC 码(它是 CRC-8 码)。以 SMBus Send Byte 为例，下图中，一个未使用 PEC，另一个使用 PEC：(一般很少使用)</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/13.png" alt="img"></p>
<h2><span id="1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</span><a href="#1-4-i2c-shu-ju-ge-shi" class="header-anchor">#</a></h2><h3><span id="1-4-1-i2c-block-read">1.4.1 I2C Block Read</span><a href="#1-4-1-i2c-block-read" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续读出多个字节。它跟 SMBus Block Read 的差别在于设备发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/14.png" alt="img"></p>
<p>I2C-tools 中的函数：&#96;i2c_smbus_read_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，直接读出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_I2C_BLOCK</strong></p>
<h3><span id="1-4-2-i2c-block-write">1.4.2 I2C Block Write</span><a href="#1-4-2-i2c-block-write" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续发出多个字节。它跟 SMBus Block Write 的差别在于发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/15.png" alt="img"></p>
<p>I2C-tools 中的函数：i2c_smbus_write_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 data，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_I2C_BLOCK</strong></p>
<h1><span id="2-i2c-tools">2 I2C Tools</span><a href="#2-i2c-tools" class="header-anchor">#</a></h1><h2><span id="2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</span><a href="#2-1-i2c-kong-zhi-qi-kuang-jia" class="header-anchor">#</a></h2><p>APP 访问硬件肯定是需要驱动程序的，对于 I2C 设备，linux内核提供了默认的驱动程序 drivers&#x2F;i2c&#x2F;i2c-dev.c，通过它可以直接使用下面的 I2C 控制器驱动程序来 访问 I2C 设备。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/16.png" alt="img"></p>
<h2><span id="2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</span><a href="#2-2-i2c-shu-ju-jie-gou" class="header-anchor">#</a></h2><h3><span id="2-2-1-i2c-adapter">2.2.1 i2c_adapter</span><a href="#2-2-1-i2c-adapter" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/17.png" alt="img"></p>
<p>i2c_adapter 表示一个 I2C BUS，或称为 I2C Controller，里面有 2 个重要的成员：</p>
<ol>
<li>nr：第几个 I2C BUS(I2C Controller)</li>
<li>i2c_algorithm，里面有该 I2C BUS 的传输函数，用来收发 I2C 数据</li>
</ol>
<p>怎么表示 I2C Controller , 一个芯片里可能有多个 I2C Controller，比如第 0 个、第 1 个、……</p>
<h3><span id="2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</span><a href="#2-2-3-i2c-algorithm" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/18.png" alt="img"></p>
<h3><span id="2-3-4-i2c-device-x2f-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</span><a href="#2-3-4-i2c-device-x2f-i2c-client" class="header-anchor">#</a></h3><p>一个 I2C Device，一定有设备地址， 那它连接在哪个 I2C Controller 上，即对应的 i2c_adapter 是什么。</p>
<p>使用 i2c_client 来表示一个 I2C Device。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/19.png" alt="img"></p>
<h3><span id="2-3-5-i2c-msg">2.3.5 i2c_msg</span><a href="#2-3-5-i2c-msg" class="header-anchor">#</a></h3><p>在上面的i2c_algorithm结构体中可以看到要传输的数据被称为：i2c_msg</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/20.png" alt="img"></p>
<p>flags： 用来表示传输方向：bit 0 等于 I2C_M_RD 表示 读，bit 0 等于 0 表示写。一个 i2c_msg 要么是读，要么是写<br>举例：设备地址为 0x50 的 EEPROM，要读取它里面存储地址为 0x10 的一个字节， 应该构造几个 i2c_msg？<br>要构造 2 个 i2c_msg :</p>
<ol>
<li><p>第一个 i2c_msg 表示写操作，把要访问的存储地址 0x10 发给设备</p>
</li>
<li><p>第二个 i2c_msg 表示读操作,并且返回读出的数据</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="comment">//例如：</span></span><br><span class="line">　　u8 data_addr = <span class="number">0x10</span>;</span><br><span class="line">　　i8 data;</span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msgs</span>[2];</span></span><br><span class="line">　　</span><br><span class="line">　　msgs[<span class="number">0</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].flags = <span class="number">0</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].buf = &amp;data_addr;</span><br><span class="line">　　msgs[<span class="number">1</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].flags = I2C_M_RD;</span><br><span class="line">　　msgs[<span class="number">1</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].buf = &amp;data;</span><br></pre></td></tr></table></figure>

<h2><span id="2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</span><a href="#2-3-i2c-tools-yi-zhi" class="header-anchor">#</a></h2><h3><span id="2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</span><a href="#2-3-1-yuan-ma-xia-zai" class="header-anchor">#</a></h3><p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/">https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</a></p>
<h3><span id="2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</span><a href="#2-3-2-gong-ju-lian-pei-zhi" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ARCH=arm</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueab ihf_sdk-buildroot/bin</span><br></pre></td></tr></table></figure>

<h3><span id="2-3-3-bian-yi">2.3.3 编译</span><a href="#2-3-3-bian-yi" class="header-anchor">#</a></h3><p>修改 I2C-Tools 的 Makefile 指定交叉编译工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC ?= gcc</span><br><span class="line">AR ?= ar</span><br><span class="line">STRIP ?= strip</span><br></pre></td></tr></table></figure>

<p>改为(指定交叉编译工具链前缀, 去掉问号)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC = $(CROSS_COMPILE)gcc</span><br><span class="line">AR = $(CROSS_COMPILE)ar</span><br><span class="line">STRIP = $(CROSS_COMPILE)strip</span><br></pre></td></tr></table></figure>

<p>在 Makefile 中，“?&#x3D;”在第一次设置变量时才会起效果，如果之前设置过该变量，则不会起效果。</p>
<p>执行 make 时，是动态链接，需要把 libi2c.so 也放到单板上。 想静态链接的话，执行：make USE_STATIC_LIB&#x3D;1</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/21.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/22.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/23.png" alt="img"></p>
<h2><span id="2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</span><a href="#2-4-i2c-tools-shi-yong" class="header-anchor">#</a></h2><h3><span id="2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</span><a href="#2-4-1-i2cdetect-i2c-jian-ce" class="header-anchor">#</a></h3><p>&#x2F;&#x2F; 列出当前的 I2C Adapter(或称为 I2C Bus、I2C Controller)</p>
<p><code>i2cdetect -l</code></p>
<p>&#x2F;&#x2F; 打印某个 I2C Adapter 的 Functionalities, I2CBUS 为 0、1、2 等整数 i2cdetect -F I2CBUS</p>
<p>&#x2F;&#x2F; 看看有哪些 I2C 设备, I2CBUS 为 0、1、2 等整数</p>
<p><code>i2cdetect -y -a I2CBUS</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/24.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/25.png" alt="img"></p>
<h3><span id="2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</span><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/26.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/27.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/28.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/29.png" alt="img"></p>
<h3><span id="2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</span><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/30.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/31.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/32.png" alt="img"></p>
<h3><span id="2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</span><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/33.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/34.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/35.png" alt="img"></p>
<p>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x4。<br>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x3。<br>从i2c总线0，往0x1e设备地址，写1个字节，写入寄存器地址0xc表示要读0xc里面的值，再从0xc读2个字节。</p>
<h2><span id="2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</span><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi" class="header-anchor">#</a></h2><p>I2C-Tools 可以通过 <strong>SMBus</strong> 来访问 I2C 设备，也可以使用一般的 <strong>I2C 协议</strong> 来访问 I2C 设备。 使用一句话概括 I2C 传输：APP 通过 I2C Controller 与 I2C Device 传 输数据.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Open(<span class="string">&quot;dev/i2c-0&quot;</span>);</span><br><span class="line">ioctl(file, I2C_SLAVE, address);</span><br></pre></td></tr></table></figure>

<p>如果该设备已经有了对应的设备驱动程序，则返回失败。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(file, I2C_SLAVE_FORCE, address);</span><br></pre></td></tr></table></figure>

<p> 如果该设备已经有了对应的设备驱动程序但是还是想通过 i2c-dev 驱 动来访问它，则使用这个 ioctl 来指定 I2C 设备地址。</p>
<h3><span id="2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</span><a href="#2-5-1-shu-ju-chuan-shu-fang-shi" class="header-anchor">#</a></h3><h4><span id="2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</span><a href="#2-5-1-1-shi-yong-i2c-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_RDWR, &amp;rdwr)；(使用I2C方式)</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/36.png" alt="img"></p>
<p>该结构体表示一个或者多个i2c_msg。</p>
<p>示例代码：i2ctransfer.c</p>
<p>以<code>i2ctransfer -f -y 0 w1@0x1e 0xe r2</code>为例：</p>
<p>流程如下：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/37.png" alt="img"></p>
<p>构造i2c_rdwr_ioctl_data结构，要用2个i2c_msg结构，第一个表示写入0xe寄存器地址给设备，第二个表示要从0xe寄存器读出2个字节。</p>
<h4><span id="2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</span><a href="#2-5-1-2-shi-yong-smbus-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_SMBUS, &amp;args) ；（使用SMBus方式）</code></p>
<p>示例代码：i2cget.c i2cset.c</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/38.png" alt="img"></p>
<h4><span id="2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</span><a href="#2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gc2053_read_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> ret, data;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">2</span>)</span><br><span class="line">                buf[idx++] = (addr &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add address byte 0</span></span><br><span class="line">        buf[idx++] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_READ error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// pack read back data</span></span><br><span class="line">        data = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">2</span>) &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">                data += buf[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        syslog(LOG_DEBUG, <span class="string">&quot;i2c r 0x%x = 0x%x\n&quot;</span>, addr, data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gc2053_write_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr, <span class="type">int</span> data)</span> &#123;</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = data &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="comment">//syslog(LOG_DEBUG, &quot;i2c w 0x%x 0x%x\n&quot;, addr, data);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" data-id="clyylnk8d00017wuf57ffgv8m" data-title="I2C-SMBus协议和I2C Tool" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-字符编码与freetype移植" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/" class="article-date">
  <time class="dt-published" datetime="2024-05-25T11:07:24.000Z" itemprop="datePublished">2024-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/">字符编码与freetype移植</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-zi-fu-bian-ma">1 字符编码</a><ul>
<li><a href="#1-1-ascii-bian-ma">1.1 ASCII编码</a></li>
<li><a href="#1-2-ansi">1.2 ANSI</a></li>
<li><a href="#1-3-unicode">1.3 UNICODE</a><ul>
<li><a href="#1-3-1-utf-16-le">1.3.1 UTF-16 LE</a></li>
<li><a href="#1-3-2-utf-16-be">1.3.2 UTF-16 BE</a></li>
</ul>
</li>
<li><a href="#1-4-utf8">1.4 UTF8</a></li>
</ul>
</li>
<li><a href="#2-zhong-wen-zi-ku-yi-zhi">2 中文字库移植</a><ul>
<li><a href="#2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang">2.1 -finput-charset -fexec-charset编译选项</a></li>
<li><a href="#2-2-gb2312-zhuan-wei-utf-8">2.2 GB2312 转为 UTF-8</a></li>
<li><a href="#2-3-utf-8-zhuan-wei-gb2312">2.3 UTF-8 转为 GB2312</a></li>
<li><a href="#2-4-hzk16-zhong-wen-zi-ku">2.4 HZK16中文字库</a></li>
</ul>
</li>
<li><a href="#3-freetype-yi-zhi">3 freetype移植</a><ul>
<li><a href="#3-1-shi-liang-zi-ti">3.1 矢量字体</a></li>
<li><a href="#3-2-xia-zai-freetype">3.2 下载freetype</a></li>
<li><a href="#3-3-bian-yi-freetype">3.3 编译freetype</a><ul>
<li><a href="#3-3-1-she-zhi-gong-ju-lian">3.3.1 设置工具链</a></li>
<li><a href="#3-3-2-bian-yi-zlib">3.3.2 编译zlib</a></li>
<li><a href="#3-3-3-bian-yi-libpng">3.3.3 编译libpng</a></li>
<li><a href="#3-3-4-bian-yi-freetype">3.3.4 编译freetype</a></li>
</ul>
</li>
<li><a href="#3-4-ce-shi">3.4 测试</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-zi-fu-bian-ma">1 字符编码</span><a href="#1-zi-fu-bian-ma" class="header-anchor">#</a></h1><h2><span id="1-1-ascii-bian-ma">1.1 ASCII编码</span><a href="#1-1-ascii-bian-ma" class="header-anchor">#</a></h2><p>ascii是“American Standard Code for Information Interchange”的缩写， 美国信息交换标准代码。</p>
<p>电脑毕竟是西方人发明的，他们常用字母就 26 个，区分大小写、加上标点符号也没超过 127 个，每个字符用一个字节来表示就足够了。一个字节的 7 位就可以表示 128 个数值，在 ASCII 码中最高位永远是 0。</p>
<p>linux-4.18.16&#x2F;lib&#x2F;fonts这个目录下就有对应文件。在这里我挑选font_8x16.c</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/1.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/2.png" alt="img"></p>
<h2><span id="1-2-ansi">1.2 ANSI</span><a href="#1-2-ansi" class="header-anchor">#</a></h2><p>ASNI 是 ASCII 的扩展，向下包含 ASCII。对于 ASCII 字符仍以一个字节来表示。</p>
<p>对于非 ASCII 字符则使用 2 字节来表示。并没有固定的 ASNI 编码。</p>
<p>比如在中国大陆地区， ANSI 的默认编码是 GB2312；</p>
<p>在港澳台地区默认编码是 BIG5。以数值“ 0xd0d6”为例，对于 GB2312 编码它表示“中”；对于 BIG5 编码它表示“ 笢”。</p>
<p>用ANSI编码字符’aa中’的16进制数据</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/3.png" alt="img"></p>
<h2><span id="1-3-unicode">1.3 UNICODE</span><a href="#1-3-unicode" class="header-anchor">#</a></h2><p>在 ANSI 标准中，很多种文字都有自己的编码标准，汉字简体字有 GB2312、繁体字有 BIG5，这难免同一个数值对应不同字符。比如数值“ 0xd0d6”，对于GB2312 编码它表示“中”；对于 BIG5 编码它表示“ 笢”。这造成了使用 ANSI 编码保存的文件，不适合跨地区交流。</p>
<p>UNICODE 编码就是解决这类问题：对于地球上任意一个字符，都给它一个唯一的数值。</p>
<ol>
<li>ASCII 编码中使用一个字节来表示一个字符，只用到其中的 7 位，最高位恒为 0；</li>
<li>ANSI 编码中，对于 ASCII 字符仍使用一个字节来表示(BIT7 是 0)，对于非ASCII 字符一般使用 2 个字节来表示，非 ASCII 字符的数值 BIT7 都是 1</li>
</ol>
<h3><span id="1-3-1-utf-16-le">1.3.1 UTF-16 LE</span><a href="#1-3-1-utf-16-le" class="header-anchor">#</a></h3><p>每个 UNICODE 值用 3 字节来表示有点浪费，那只用 2 字节呢？它可以表示2^16&#x3D;65536 个字符，全世界常用的字符都可以表示了。Little endian 表示小字节序，数值中权重低的字节放在前面，比如字符“ A 中”在 TXT 文件中的数值如下，其中的“ A”使用“0x41 0x00”两字节表示；“中”使用“ 0x2d 0x4e”两字节表示。文件开头的“ 0xff 0xfe”表示“UTF-16 LE”。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/4.png" alt="img"></p>
<h3><span id="1-3-2-utf-16-be">1.3.2 UTF-16 BE</span><a href="#1-3-2-utf-16-be" class="header-anchor">#</a></h3><p>Big endian 表示大字节序，数值中权重低的字节放在后面，比如字符“ ab中”在 TXT 文件中的数值如下，其中的“ A”使用“ 0x00 0x41”两字节表示；“中”使用“ 0x4e 0x2d”两字节表示。文件开头的“ 0xfe 0xff”表示“UTF-16 BE”。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/5.png" alt="img"></p>
<h2><span id="1-4-utf8">1.4 UTF8</span><a href="#1-4-utf8" class="header-anchor">#</a></h2><p>UTF8 是一种变长的编码方法，有 2 种 UTF8格式的文件：带有头部、不带头部。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/6.png" alt="img"></p>
<p>对于 ASCII 字符用UTF-16有空间浪费、而且文件中有某个字节丢失，这会使得后面所有字符都因为错位而无法显示。UTF8则不会有这样的问题。0x41表示大写字母’A’，只用了一个字节。上图中的 3 个字节“ 0xe4 0xb8 0xad”表示的数值是 0x4e2d，对应“中”的 UNICODE 码.</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/7.png" alt="img"></p>
<p>上图中， 0xe4 的二进制是“ 11100100”，高位有 3 个 1，表示从当前字节起有 3 字节参与表示 UNICODE；<br>0xb8 的二进制是“10111000”，高位有 1 个 1，表示从当前字节起有 1 字节参与表示 UNICODE；<br>0xad 的二进制是“10101101”，高位有 1 个 1，表示从当前字节起有 1 字节参与表示 UNICODE；<br>除去高位的“ 1110”、“ 10”、“ 10”后，剩下的二进制数组合起来得到“ 01001110001101”，它就是 0x4e2d，即“中”的 UNICODE 值。</p>
<p>使用 UTF8 编码时，即使 TXT 文件中丢失了某些数据，也只会影响到当前字符的显示，后面的字符不受影响。</p>
<h1><span id="2-zhong-wen-zi-ku-yi-zhi">2 中文字库移植</span><a href="#2-zhong-wen-zi-ku-yi-zhi" class="header-anchor">#</a></h1><h2><span id="2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang">2.1 -finput-charset -fexec-charset编译选项</span><a href="#2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang" class="header-anchor">#</a></h2><p>我们编写 C 程序时，可以使用 ANSI 编码，或是 UTF-8 编码；在编译程序时，可以使用以下的选项告诉编译器用什么方式编码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-finput-charset=GB2312</span><br><span class="line">-finput-charset=UTF<span class="number">-8</span></span><br></pre></td></tr></table></figure>

<p>如果不指定<code>-finput-charset</code>， GCC 就会默认 C 程序的编码方式为 UTF8。</p>
<ol>
<li><p>用ANSI格式编写编码，vim浏览显示会乱码，用notepad++采用ANSI编码格式浏览。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/8.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/9.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/10.png" alt="img"></p>
<p>由于编译器默认用utf8编码，所以看到最终打印是乱码的。可以看到“中”的ANSI码是d6 d0。</p>
<ol start="2">
<li><p>用utf8编写代码</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/11.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/12.png" alt="img"></p>
<p>最终打印是OK的。可以看到“中”的utf8码是e4 b8 ad。</p>
<h2><span id="2-2-gb2312-zhuan-wei-utf-8">2.2 GB2312 转为 UTF-8</span><a href="#2-2-gb2312-zhuan-wei-utf-8" class="header-anchor">#</a></h2><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/13.png" alt="img"></p>
<p>从上面的输出信息可以看出来， GB2312 的”0xd6 0xd0”可以转换为 UTF-8的“ 0xe4 0xb8 0xad”。而如果把原本就是 UTF-8 格式的 test_charset_utf8.c当作 GB2312 格式，会引起错误.</p>
<h2><span id="2-3-utf-8-zhuan-wei-gb2312">2.3 UTF-8 转为 GB2312</span><a href="#2-3-utf-8-zhuan-wei-gb2312" class="header-anchor">#</a></h2><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/14.png" alt="img"></p>
<p>从 上 面 的 输 出 信 息 可 以 看 出 来 ， 如 果 把 原 本 就 是 GB2312 格 式 test_charset_ansi.c 当成UTF-8 格式，会引起错误。而 UTF-8 格式的“中”编码值为“ 0xe4 0xb8 0xad”，可以转换为 GB2312 的“0xd6 0xd0”</p>
<h2><span id="2-4-hzk16-zhong-wen-zi-ku">2.4 HZK16中文字库</span><a href="#2-4-hzk16-zhong-wen-zi-ku" class="header-anchor">#</a></h2><p>HZK16字库里的16×16汉字一共需要256个点来显示，也就是说需要32个字节才能达到显示一个普通汉字的目的。符合GB2312标准。</p>
<p>一个GB2312汉字是由两个字节编码的，范围为A1A1~FEFE。A1-A9为符号区，B0到F7为汉字区。每一个区有94个字符。</p>
<p>HZK16 中是以 GB2312 编码值来查找点阵的，以“中”字为例，它的编码值是“ 0xd6 0xd0”，其中的 0xd6 表示“区码”，表示在哪一个区；其中的 0xd0 表示“位码”，表示它是这个区里的哪一个字符。每一个区有 94 个汉字。区位码从 0xa1 而不是从 0 开始，是为了兼容 ASCII码。</p>
<p>要显示“中”字， 它的 GB2312 编码是 d6d0，它是 HZK16 里第“ (0xd6-0xa1)*94+(0xd0-0xa1)”个字符。(0xd6-0xa1)表示是哪个区，(0xd0-0xa1)表示是哪个位。</p>
<p>如何获取和显示汉字”中“?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fd_hzk16 = open(<span class="string">&quot;HZK16&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (fd_hzk16 &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open HZK16\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(fstat(fd_hzk16, &amp;hzk_stat))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t get fstat\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">hzkmem = (<span class="type">unsigned</span> <span class="type">char</span> *)mmap(<span class="literal">NULL</span> , hzk_stat.st_size, PROT_READ, MAP_SHARED, fd_hzk16, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (hzkmem == (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t mmap for hzk16\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载HZK16字库，读取并且mmap字库：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/15.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/16.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">该函数在 LCD 的(x,y)位置处显示汉字字符 str， str[0]中保存区码、 str[1]中保存位码。</span><br><span class="line">第 4734 行确定该汉字属于哪个区；第 4735 行确实它是该区中哪一个汉字。</span><br><span class="line">第 4736 行确实它的字库地址（第多少个字节）：每个区中有 94 个汉字，每个汉字在字库中占据 32 字节。</span><br></pre></td></tr></table></figure>

<p>根据下图来理解字库中每个像素点是如何显示的:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/17.png" alt="img"></p>
<p>总共有十六行，因此需要一个循环 16次的大循环(第 4740 行)。</p>
<p>考虑到一行有两个字节， 在大循环中加入一个 2 次的循环用于区分是哪个字节(第 4741 行)。</p>
<p>最后使用第 3 个循环来处理一个字节中的 8 位(第 4744 行)。对于每一位，它等于 1 时对应的像素被设置为白色，它等于 0 时对应的像素被设置为黑色。需要注意的是根据 x、 y、 i、 j、 b 来计算像素坐标。</p>
<p>测试：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/18.png" alt="img"></p>
<p>注意：使用上述命令时 show_chinese.c 的编码格式必须是 ANSI(GB2312)，因为HZK16字库是按照GB2312编码的，否则编译时需要指定“ -fexec-charset&#x3D;GB2312”。</p>
<h1><span id="3-freetype-yi-zhi">3 freetype移植</span><a href="#3-freetype-yi-zhi" class="header-anchor">#</a></h1><p>FreeType库是一个完全免费（开源）的、高质量的且可移植的字体引擎。Freetype 是开源的字体引擎库， 它提供统一的接口来访问多种字体格式文件，从而实现矢量字体显示。我们只需要移植这个字体引擎，调用对应的 API 接口，提供字体文件，就可以让 freetype 库帮我们取出关键点、实现闭合曲线， 填充颜色， 达到显示矢量字体的目的。</p>
<p>这里仅移植freetype库，freetype的使用不做具体展开。可以从 <a target="_blank" rel="noopener" href="https://www.freetype.org/">https://www.freetype.org/</a> 可 以 下 载 到 “ freetype-doc-2.10.2.tar.xz”。</p>
<h2><span id="3-1-shi-liang-zi-ti">3.1 矢量字体</span><a href="#3-1-shi-liang-zi-ti" class="header-anchor">#</a></h2><p>使用点阵字库显示英文字母、汉字时， 大小固定， 如果放大缩小则会模糊甚至有锯齿出现，为了解决这个问题，引用矢量字体。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">第1步 确定关键点，</span><br><span class="line">第2步 使用数学曲线（ 贝塞尔曲线） 连接头键点，</span><br><span class="line">第3步 填充闭合区线内部空间。</span><br></pre></td></tr></table></figure>

<p>什么是关键点？以字母“ A”为例:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/19.png" alt="img"></p>
<p>再用数学曲线(比如贝塞尔曲线)将关键点都连接起来， 得到一系列的封闭的曲线:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/20.png" alt="img"></p>
<p>最后把封闭空间填满颜色，就显示出一个 A 字母:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/21.png" alt="img"></p>
<p>如果需要放大或者缩小字体，关键点的相对位置是不变的， 只要数学曲线平滑，字体就不会变形。</p>
<h2><span id="3-2-xia-zai-freetype">3.2 下载freetype</span><a href="#3-2-xia-zai-freetype" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://freetype.org/download.html">https://freetype.org/download.html</a></p>
<p><a target="_blank" rel="noopener" href="https://download.savannah.gnu.org/releases/freetype/">https://download.savannah.gnu.org/releases/freetype/</a></p>
<p>freetype 依赖于 libpng， libpng 又依赖于 zlib，所以我们应该：先编译安装 zlib，再编译安装 libpng，最后编译安装 freetype。 但是，有些工具链里有 zlib, 那就不用编译安装 zlib.</p>
<p>下载安装libpng: <a target="_blank" rel="noopener" href="https://www.linuxfromscratch.org/blfs/view/svn/general/libpng.html">https://www.linuxfromscratch.org/blfs/view/svn/general/libpng.html</a></p>
<p>下载安装zlib: <a target="_blank" rel="noopener" href="https://www.zlib.net/fossils/">https://www.zlib.net/fossils/</a></p>
<h2><span id="3-3-bian-yi-freetype">3.3 编译freetype</span><a href="#3-3-bian-yi-freetype" class="header-anchor">#</a></h2><h3><span id="3-3-1-she-zhi-gong-ju-lian">3.3.1 设置工具链</span><a href="#3-3-1-she-zhi-gong-ju-lian" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ARCH=arm</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;main()&#123;&#125;&#x27;</span>| arm-buildroot-linux-gnueabihf-gcc -E -v -</span><br></pre></td></tr></table></figure>

<p>得到头文件的系统目录为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include</span><br><span class="line"></span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include-fixed</span><br><span class="line"> </span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/include</span><br><span class="line"></span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/include</span><br></pre></td></tr></table></figure>

<p>库文件系统目录为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">COMPILER_PATH=/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../libexec/gcc/arm-buildroot-linux-gnueabihf/7.5.0/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../libexec/gcc/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/bin/</span><br><span class="line"></span><br><span class="line">LIBRARY_PATH=/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/lib/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/lib/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib/</span><br></pre></td></tr></table></figure>

<h3><span id="3-3-2-bian-yi-zlib">3.3.2 编译zlib</span><a href="#3-3-2-bian-yi-zlib" class="header-anchor">#</a></h3><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/22.png" alt="img"></p>
<p>编译zlib库时，.&#x2F;configure不允许传入–host参数；不支持的话需要export CC设置为你的arm工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CC=arm-buildroot-linux-gnueabihf-gcc</span><br><span class="line">./configure --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">make;make install</span><br><span class="line"><span class="built_in">cd</span> tmp/lib;<span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>将lib和头文件拷贝到工具链目录(或者不拷贝，到时候编译用-L, -I指定即可，运行时指定LIBRARY_PATH)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp include<span class="comment">/* -rf /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include</span></span><br><span class="line"><span class="comment">cp lib/* -rfd /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/lib</span></span><br></pre></td></tr></table></figure>

<h3><span id="3-3-3-bian-yi-libpng">3.3.3 编译libpng</span><a href="#3-3-3-bian-yi-libpng" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure --host= arm-buildroot-linux-gnueabihf --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">cd</span> tmp/lib;<span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/23.png" alt="img"></p>
<p>将lib和头文件拷贝到工具链目录。</p>
<h3><span id="3-3-4-bian-yi-freetype">3.3.4 编译freetype</span><a href="#3-3-4-bian-yi-freetype" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --host= arm-buildroot-linux-gnueabihf --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">Make</span><br><span class="line">Make  install</span><br></pre></td></tr></table></figure>

<p>注意：如果你的工具链路径不是 <code>/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot</code>，那么make时会出现类似如下错误。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/24.png" alt="img"></p>
<p>修改自己工具链下的$(TOOLCHAIN)&#x2F;arm-buildroot-linux-gnueabihf&#x2F;sysroot&#x2F;usr&#x2F;lib目录下编辑libfreetype.la, 替换dependency_libs和libdir的路径。来自 &lt; <a target="_blank" rel="noopener" href="http://bbs.100ask.net/question/15908%3E">http://bbs.100ask.net/question/15908&gt;</a></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/25.png" alt="img"></p>
<p>libfreetype库如下：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/26.png" alt="img"></p>
<p>将lib和头文件拷贝到工具链目录。</p>
<h2><span id="3-4-ce-shi">3.4 测试</span><a href="#3-4-ce-shi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc freetype_show_font.c -I /media/cvitek/robin.lee/my_test/study/weidongshan/<span class="number">100</span>ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/include/freetype2/ -L /media/cvitek/robin.lee/my_test/study/weidongshan/<span class="number">100</span>ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib -lfreetype</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ft2build.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> FT_FREETYPE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> FT_GLYPH_H</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd_fb;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span>        <span class="comment">/* Current var */</span></span><br><span class="line"><span class="type">int</span> screen_size;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *fbmem;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> line_width;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> pixel_width;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称： lcd_put_pixel</span></span><br><span class="line"><span class="comment"> * 功能描述： 在LCD指定位置上输出指定颜色（描点）</span></span><br><span class="line"><span class="comment"> * 输入参数： x坐标，y坐标，颜色</span></span><br><span class="line"><span class="comment"> * 输出参数： 无</span></span><br><span class="line"><span class="comment"> * 返 回 值： 会</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">lcd_put_pixel</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">int</span> color)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *pen_8 = fbmem+y*line_width+x*pixel_width;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> *pen_16;        </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *pen_32;        </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> red, green, blue;        </span><br><span class="line"></span><br><span class="line">    pen_16 = (<span class="type">unsigned</span> <span class="type">short</span> *)pen_8;</span><br><span class="line">    pen_32 = (<span class="type">unsigned</span> <span class="type">int</span> *)pen_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (var.bits_per_pixel) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line">            *pen_8 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">            <span class="comment">/* 565 */</span></span><br><span class="line">            red   = (color &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            green = (color &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            blue  = (color &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            color = ((red &gt;&gt; <span class="number">3</span>) &lt;&lt; <span class="number">11</span>) | ((green &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">5</span>) | (blue &gt;&gt; <span class="number">3</span>);</span><br><span class="line">            *pen_16 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>: &#123;</span><br><span class="line">            *pen_32 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t surport %dbpp\n&quot;</span>, var.bits_per_pixel);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称： draw_bitmap</span></span><br><span class="line"><span class="comment"> * 功能描述： 根据bitmap位图，在LCD指定位置显示汉字</span></span><br><span class="line"><span class="comment"> * 输入参数： x坐标，y坐标，位图指针</span></span><br><span class="line"><span class="comment"> * 输出参数： 无</span></span><br><span class="line"><span class="comment"> * 返 回 值： 无</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_bitmap</span><span class="params">( FT_Bitmap* bitmap, FT_Int x, FT_Int y)</span> &#123;</span><br><span class="line">    FT_Int  i, j, p, q;</span><br><span class="line">    FT_Int  x_max = x + bitmap-&gt;width;</span><br><span class="line">    FT_Int  y_max = y + bitmap-&gt;rows;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf(&quot;x = %d, y = %d\n&quot;, x, y);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = y, q = <span class="number">0</span>; j &lt; y_max; j++, q++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = x, p = <span class="number">0</span>; i &lt; x_max; i++, p++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || j &lt; <span class="number">0</span> || i &gt;= var.xres || j &gt;= var.yres)</span><br><span class="line">            	<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    		<span class="comment">//image[j][i] |= bitmap-&gt;buffer[q * bitmap-&gt;width + p];</span></span><br><span class="line">    		lcd_put_pixel(i, j, bitmap-&gt;buffer[q * bitmap-&gt;width + p]);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">wchar_t</span> *chinese_str = <span class="string">L&quot;繁&quot;</span>;</span><br><span class="line">    FT_Library          library;</span><br><span class="line">    FT_Face           face;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    FT_Vector     pen;</span><br><span class="line">    FT_GlyphSlot  slot;</span><br><span class="line">    <span class="type">int</span> font_size = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage : %s &lt;font_file&gt; [font_size]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span>)</span><br><span class="line">        font_size = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    fd_fb = open(<span class="string">&quot;/dev/fb0&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd_fb &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open /dev/fb0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd_fb, FBIOGET_VSCREENINFO, &amp;var)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t get var\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    line_width  = var.xres * var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    pixel_width = var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    screen_size = var.xres * var.yres * var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    fbmem = (<span class="type">unsigned</span> <span class="type">char</span> *)mmap(<span class="literal">NULL</span> , screen_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd_fb, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fbmem == (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t mmap\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 清屏: 全部设为黑色 */</span></span><br><span class="line">    <span class="built_in">memset</span>(fbmem, <span class="number">0</span>, screen_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 显示矢量字体 */</span></span><br><span class="line">    error = FT_Init_FreeType( &amp;library );                           <span class="comment">/* initialize library */</span></span><br><span class="line">    <span class="comment">/* error handling omitted */</span></span><br><span class="line">    </span><br><span class="line">    error = FT_New_Face( library, argv[<span class="number">1</span>], <span class="number">0</span>, &amp;face ); <span class="comment">/* create face object */</span></span><br><span class="line">    <span class="comment">/* error handling omitted */</span>        </span><br><span class="line">    slot = face-&gt;glyph;</span><br><span class="line"></span><br><span class="line">    FT_Set_Pixel_Sizes(face, font_size, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 确定座标:</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//pen.x = 0;</span></span><br><span class="line">    <span class="comment">//pen.y = 0;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set transformation */</span></span><br><span class="line">    <span class="comment">//FT_Set_Transform( face, 0, &amp;pen);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* load glyph image into the slot (erase previous one) */</span></span><br><span class="line">    error = FT_Load_Char( face, chinese_str[<span class="number">0</span>], FT_LOAD_RENDER );</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FT_Load_Char error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw_bitmap( &amp;slot-&gt;bitmap,</span><br><span class="line">                 var.xres/<span class="number">2</span>,</span><br><span class="line">                 var.yres/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/" data-id="clyylnk92006c7wuf0r5g66wb" data-title="字符编码与freetype移植" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ini-parse配置解析功能移植" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/" class="article-date">
  <time class="dt-published" datetime="2024-05-25T08:08:09.000Z" itemprop="datePublished">2024-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/">ini_parse配置解析功能移植</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-ini-parse-yi-zhi">1 ini_parse移植</a><ul>
<li><a href="#1-1-xia-zai-ini-jie-xi-yuan-ma">1.1 下载ini解析源码</a></li>
<li><a href="#1-2-shi-yong-ini-parse-gong-neng">1.2 使用ini_parse功能</a><ul>
<li><a href="#1-2-1-zi-ding-yi-ini-wen-jian">1.2.1 自定义ini文件</a></li>
<li><a href="#1-2-2-zhi-chi-yu-fa-jian-ce">1.2.2 支持语法检测</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-minini-yi-zhi-shi-yong">2 minIni移植使用</a><ul>
<li><a href="#2-1-xia-zai-minini">2.1 下载minIni</a></li>
<li><a href="#2-2-te-zheng">2.2 特征</a></li>
<li><a href="#2-3-ini-wen-jian-yu-fa">2.3 INI 文件语法</a></li>
<li><a href="#2-4-minini-zhi-chi-wen-jian-xi-tong">2.4 minIni支持文件系统</a></li>
<li><a href="#2-5-minini-de-api-jie-shao">2.5 minIni的API介绍</a><ul>
<li><a href="#2-5-1-ini-gets">2.5.1 ini_gets()</a><ul>
<li><a href="#2-5-1-1-getkeystring">2.5.1.1 getkeystring</a></li>
</ul>
</li>
<li><a href="#2-5-2-ini-getl">2.5.2 ini_getl()</a></li>
<li><a href="#2-5-3-ini-puts">2.5.3 ini_puts()</a></li>
<li><a href="#2-5-4-ini-putl">2.5.4 ini_putl()</a></li>
<li><a href="#2-5-5-section-key-enumeration">2.5.5 section&#x2F;key enumeration</a></li>
<li><a href="#2-5-6-section-key-cun-zai-xing-jian-cha">2.5.6 section&#x2F;key存在性检查</a></li>
<li><a href="#2-5-7-pei-zhi-wen-jian-yue-du-da-yin">2.5.7 配置文件阅读打印</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-ini-parse-yi-zhi">1 ini_parse移植</span><a href="#1-ini-parse-yi-zhi" class="header-anchor">#</a></h1><h2><span id="1-1-xia-zai-ini-jie-xi-yuan-ma">1.1 下载ini解析源码</span><a href="#1-1-xia-zai-ini-jie-xi-yuan-ma" class="header-anchor">#</a></h2><p>源码的github地址<a target="_blank" rel="noopener" href="https://github.com/benhoyt/inih">https://github.com/benhoyt/ini</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/benhoyt/inih.git</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/1.png" alt="img"></p>
<h2><span id="1-2-shi-yong-ini-parse-gong-neng">1.2 使用ini_parse功能</span><a href="#1-2-shi-yong-ini-parse-gong-neng" class="header-anchor">#</a></h2><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/2.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/3.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/4.png" alt="img"></p>
<p>可以看到核心就是一个ini_parse函数。用户自定义一个callback函数去解析自己的配置ini。测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ini.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SAMPLE_INI_CFG_S</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> bus_id;</span><br><span class="line">        <span class="type">int</span> age;</span><br><span class="line">        <span class="type">char</span> name2[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> bus_id2;</span><br><span class="line">        <span class="type">int</span> age2;</span><br><span class="line">&#125; SAMPLE_INI_CFG_S;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_handler</span><span class="params">(<span class="type">void</span> *user, <span class="type">const</span> <span class="type">char</span> *section, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *value)</span> &#123;</span><br><span class="line">        SAMPLE_INI_CFG_S *cfg = (SAMPLE_INI_CFG_S *)user;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(section, <span class="string">&quot;person1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">strcpy</span>(cfg-&gt;name, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;bus_id&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;bus_id = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;age&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;age = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/* unknown section/name */</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(section, <span class="string">&quot;person2&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">strcpy</span>(cfg-&gt;name2, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;bus_id&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;bus_id2 = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;age&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;age2 = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">/* unknown section/name */</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* unknown section/name */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">        SAMPLE_INI_CFG_S ini_cfg;</span><br><span class="line">        <span class="type">int</span> ret = ini_parse(<span class="string">&quot;./sensor_cfg.ini&quot;</span>, parse_handler, &amp;ini_cfg);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Parse err in %d line.\n&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Parse incomplete, use default cfg ./sensor_cfg.ini\n&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s, %d, %d\n&quot;</span>, ini_cfg.name, ini_cfg.bus_id, ini_cfg.age);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s, %d, %d\n&quot;</span>, ini_cfg.name2, ini_cfg.bus_id2, ini_cfg.age2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="1-2-1-zi-ding-yi-ini-wen-jian">1.2.1 自定义ini文件</span><a href="#1-2-1-zi-ding-yi-ini-wen-jian" class="header-anchor">#</a></h3><p>ini配置文件sensor_cfg.ini如下：</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/5.png" alt="img"></p>
<p><code>gcc test.c ini.c</code>。我的callback定义是<code>parse_handler</code>，从ini中解析section，每个section会调用一次callback，解析出所有的section。</p>
<p>运行代码:</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/6.png" alt="img"></p>
<h3><span id="1-2-2-zhi-chi-yu-fa-jian-ce">1.2.2 支持语法检测</span><a href="#1-2-2-zhi-chi-yu-fa-jian-ce" class="header-anchor">#</a></h3><p>ini_parse还支持语法检测。但ini写的不和语法规范会报错。手工制造ini语法错误，测试结果如下：</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/7.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/8.png" alt="img"></p>
<h1><span id="2-minini-yi-zhi-shi-yong">2 minIni移植使用</span><a href="#2-minini-yi-zhi-shi-yong" class="header-anchor">#</a></h1><p>MiniINI 是一个用来解析 INI&#x2F;CFG 配置文件的 C++ 库，主要特点是可移植性、性能和小体积。支持上千种 INI 格式配置，易用简单。</p>
<h2><span id="2-1-xia-zai-minini">2.1 下载minIni</span><a href="#2-1-xia-zai-minini" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/compuphase/minIni">GitHub - compuphase&#x2F;minIni: A small and portable INI file library with read&#x2F;write support</a></p>
<h2><span id="2-2-te-zheng">2.2 特征</span><a href="#2-2-te-zheng" class="header-anchor">#</a></h2><ul>
<li>minIni 支持读取senction外部的key，因此它支持不使用section的配置文件（但在其他方面与 INI 文件兼容）。</li>
<li>可以使用冒号分隔键和值;冒号等价于等号。也就是说，字符串“Name： Value”和“Name&#x3D;Value”具有相同的含义。</li>
<li>minIni 不需要标准 C&#x2F;C++ 库中的 文件 I&#x2F;O 函数，且允许通过宏配置要选择文件 I&#x2F;O 接口。</li>
<li>哈希字符 （“#”） 是分号开始注释的替代方法。允许尾随注释（即在一行上的键&#x2F;值对后面）。</li>
<li>key名称和val周围的前导和尾随空格将被忽略。</li>
<li>当写入包含注释字符（“;”或“#”）的值时，该值将自动放在双引号之间;读取值时，将删除这些引号。当设置中出现双引号本身时，这些字符将被转义。</li>
<li>支持section和key枚举。</li>
<li>您可以选择设置 minIni 将使用的行终止符（对于文本文件）。（这是编译时设置，而不是运行时设置)。</li>
<li>由于写入速度远低于闪存（SD&#x2F;MMC 卡、U 盘）中的读取速度，因此 minIni 以双倍“文件读取”为代价将“文件写入”降至最低。</li>
<li>内存占用是确定性的。没有动态内存分配。</li>
</ul>
<h2><span id="2-3-ini-wen-jian-yu-fa">2.3 INI 文件语法</span><a href="#2-3-ini-wen-jian-yu-fa" class="header-anchor">#</a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Network]  <span class="comment">#section</span></span><br><span class="line">hostname=My Computer  <span class="comment">#key = val</span></span><br><span class="line">address=dhcp</span><br><span class="line">dns = <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h2><span id="2-4-minini-zhi-chi-wen-jian-xi-tong">2.4 minIni支持文件系统</span><a href="#2-4-minini-zhi-chi-wen-jian-xi-tong" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INI_FILETYPE                  FILE*</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_openread(filename,file)   ((*(file) = fopen((filename),<span class="string">&quot;r&quot;</span>)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_openwrite(filename,file)  ((*(file) = fopen((filename),<span class="string">&quot;w&quot;</span>)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_close(file)               (fclose(*(file)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_read(buffer,size,file)    (fgets((buffer),(size),*(file)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_write(buffer,file)        (fputs((buffer),*(file)) &gt;= 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_rename(source,dest)       (rename((source), (dest)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_remove(filename)          (remove(filename) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INI_FILEPOS                   fpos_t</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_tell(file,pos)            (fgetpos(*(file), (pos)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_seek(file,pos)            (fsetpos(*(file), (pos)) == 0)</span></span><br></pre></td></tr></table></figure>

<h2><span id="2-5-minini-de-api-jie-shao">2.5 minIni的API介绍</span><a href="#2-5-minini-de-api-jie-shao" class="header-anchor">#</a></h2><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/9.png" alt="image-20240602144015881"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;minIni.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sizearray(a)  (sizeof(a) / sizeof((a)[0]))</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> inifile[] = <span class="string">&quot;example.ini&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span> section[<span class="number">50</span>];</span><br><span class="line">    <span class="type">long</span> n;</span><br><span class="line"></span><br><span class="line">    n = ini_gets(<span class="string">&quot;Network&quot;</span>, <span class="string">&quot;address&quot;</span>, <span class="string">&quot;dummy&quot;</span>, str, sizearray(str), inifile);</span><br><span class="line">    <span class="keyword">if</span> (n &gt;= <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;Network/address=%s&quot;</span>, str);</span><br><span class="line"></span><br><span class="line">    n = ini_getl(<span class="string">&quot;Network&quot;</span>, <span class="string">&quot;timeout&quot;</span>, <span class="number">-1</span>, inifile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Network/timeout=%ld\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>example.ini如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Network]</span><br><span class="line">hostname=My Computer</span><br><span class="line">address=dhcp</span><br><span class="line">dns=<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">timeout=<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Network/address=dhcp</span><br><span class="line">Network/timeout=10</span><br></pre></td></tr></table></figure>

<h3><span id="2-5-1-ini-gets">2.5.1 ini_gets()</span><a href="#2-5-1-ini-gets" class="header-anchor">#</a></h3><p>获取字符串类型的值.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>   <span class="title function_">ini_gets</span><span class="params">(<span class="type">const</span> mTCHAR *Section, <span class="type">const</span> mTCHAR *Key, <span class="type">const</span> mTCHAR *DefValue, mTCHAR *Buffer, <span class="type">int</span> BufferSize, <span class="type">const</span> mTCHAR *Filename)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数 1 是 Section;</span></span><br><span class="line"><span class="comment">参数 2 是 Key;</span></span><br><span class="line"><span class="comment">参数 3 是获取不到值时的默认值;</span></span><br><span class="line"><span class="comment">参数 4 是用于保存目标键值的 Buffer;</span></span><br><span class="line"><span class="comment">参数 5 是 Buffer 的长度;</span></span><br><span class="line"><span class="comment">参数 6 是 INI 文件的路径;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/10.png" alt="image-20240602144722018"></p>
<p>先打开文件，然后用 <code>getkeystring() </code>找到目标键值，最后拷贝给调用者。</p>
<h4><span id="2-5-1-1-getkeystring">2.5.1.1 getkeystring</span><a href="#2-5-1-1-getkeystring" class="header-anchor">#</a></h4><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/11.png" alt="image-20240602150058567"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/12.png" alt="image-20240602145619533"></p>
<ol>
<li>用 fgets 进行逐行读取，用 strrchr 找到包含 ‘[‘ 和 ‘]’ 的行，然后再用 strncasecmp 找到目标 Section 所在的行。</li>
<li>继续用 fgets 进行逐行读取，用 strrchr 找到包含 ‘&#x3D;’ 的行，然后再用 strncasecmp 找到目标 Key 所在的行。</li>
<li>用 strncpy 将目标 Key 的值拷贝给调用者。</li>
</ol>
<p>大致就是这3个关键步骤，当然还有很多其他异常处理，语法检测和边界判断的逻辑，这里不做展示。</p>
<h3><span id="2-5-2-ini-getl">2.5.2 ini_getl()</span><a href="#2-5-2-ini-getl" class="header-anchor">#</a></h3><p><code>ini_getl() </code>用于获取整型类型的值，也是间接调用<code>int_gets</code>， 最后将字符串转换成数字。</p>
<h3><span id="2-5-3-ini-puts">2.5.3 ini_puts()</span><a href="#2-5-3-ini-puts" class="header-anchor">#</a></h3><p>写出参数到ini,保存到ini。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ini_puts()</span></span><br><span class="line"><span class="comment"> * \param Section     the name of the section to write the string in</span></span><br><span class="line"><span class="comment"> * \param Key         the name of the entry to write, or NULL to erase all keys in the section</span></span><br><span class="line"><span class="comment"> * \param Value       a pointer to the buffer the string, or NULL to erase the key</span></span><br><span class="line"><span class="comment"> * \param Filename    the name and full path of the .ini file to write to</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return            1 if successful, otherwise 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ini_puts</span><span class="params">(<span class="type">const</span> TCHAR *Section, <span class="type">const</span> TCHAR *Key, <span class="type">const</span> TCHAR *Value, <span class="type">const</span> TCHAR *Filename)</span></span><br><span class="line"><span class="comment">//eg:</span></span><br><span class="line"><span class="title function_">ini_putl</span><span class="params">(<span class="string">&quot;second&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="number">20</span>, inifile)</span>;</span><br><span class="line">n = ini_puts(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;alt&quot;</span>, <span class="literal">NULL</span>, inifile);<span class="comment">//当val等于NULL表示删除该key</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-5-4-ini-putl">2.5.4 ini_putl()</span><a href="#2-5-4-ini-putl" class="header-anchor">#</a></h3><p><code>ini_putl() </code>用于写出整型类型的值，也是间接调用<code>int_puts</code>， 将数字转换成字符串,然后保存字符串到ini。</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/13.png" alt="image-20240602171648913"></p>
<h3><span id="2-5-5-section-x2f-key-enumeration">2.5.5 section&#x2F;key enumeration</span><a href="#2-5-5-section-x2f-key-enumeration" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;4. Section/key enumeration, file structure follows\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>; ini_getsection(s, section, sizearray(section), inifile) &gt; <span class="number">0</span>; s++) &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;    [%s]\n&quot;</span>, section);</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; ini_getkey(section, k, str, sizearray(str), inifile) &gt; <span class="number">0</span>; k++) &#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;\t%s\n&quot;</span>, str);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;<span class="comment">//对section和key进行枚举</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-5-6-section-x2f-key-cun-zai-xing-jian-cha">2.5.6 section&#x2F;key存在性检查</span><a href="#2-5-6-section-x2f-key-cun-zai-xing-jian-cha" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* section/key presence check */</span></span><br><span class="line">assert(ini_hassection(<span class="string">&quot;first&quot;</span>, inifile));<span class="comment">//检查是否有first 段</span></span><br><span class="line">assert(!ini_hassection(<span class="string">&quot;fourth&quot;</span>, inifile));</span><br><span class="line">assert(ini_haskey(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;val&quot;</span>, inifile));<span class="comment">//检查first段是否有val这个key</span></span><br><span class="line">assert(!ini_haskey(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;test&quot;</span>, inifile));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;5. checking presence of sections and keys passed\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3><span id="2-5-7-pei-zhi-wen-jian-yue-du-da-yin">2.5.7 配置文件阅读打印</span><a href="#2-5-7-pei-zhi-wen-jian-yue-du-da-yin" class="header-anchor">#</a></h3><p><code>ini_browse</code>用来打印出每个段的每个key的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Callback</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *section, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value, <span class="type">void</span> *userdata)</span> &#123;</span><br><span class="line">	(<span class="type">void</span>)userdata; <span class="comment">/* this parameter is not used in this example */</span></span><br><span class="line">  	<span class="built_in">printf</span>(<span class="string">&quot;    [%s]\t%s=%s\n&quot;</span>, section, key, value);</span><br><span class="line">  	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* browsing through the file */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;6. browse through all settings, file field list follows\n&quot;</span>);</span><br><span class="line">ini_browse(Callback, <span class="literal">NULL</span>, inifile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (access(filename, F_OK) != <span class="number">0</span>) &#123;</span><br><span class="line">	perror(<span class="string">&quot;open %s fail&quot;</span>, filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/14.png" alt="image-20240602173647362"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/" data-id="clyylnk8l000v7wufess612kt" data-title="ini_parse配置解析功能移植" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-通用裸机-传感器" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/" class="article-date">
  <time class="dt-published" datetime="2024-05-12T06:59:31.000Z" itemprop="datePublished">2024-05-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/">通用裸机-传感器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-dht11-wen-shi-du-chuan-gan-qi">1 DHT11温湿度传感器</a><ul>
<li><a href="#1-1-shi-xu-jie-xi">1.1 时序解析</a><ul>
<li><a href="#1-1-1-shu-ju-ge-shi">1.1.1 数据格式</a></li>
<li><a href="#1-1-2-shi-xu-can-shu">1.1.2 时序参数</a></li>
<li><a href="#1-1-3-shu-ju-chuan-shu">1.1.3 数据传输</a></li>
</ul>
</li>
<li><a href="#1-1-4-dai-ma-shi-xian">1.1.4 代码实现</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-dht11-wen-shi-du-chuan-gan-qi">1 DHT11温湿度传感器</span><a href="#1-dht11-wen-shi-du-chuan-gan-qi" class="header-anchor">#</a></h1><p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/1.png" alt="img"></p>
<p>MCU通过一条数据线与DH11连接，MCU通过这条线发命令给DH11，DH11再通过这条线把数据发送给MCU。只需要一根GPIO就OK了。</p>
<p>核心就是MCU发给DH11的命令格式和DH11返回的数据格式。</p>
<h2><span id="1-1-shi-xu-jie-xi">1.1 时序解析</span><a href="#1-1-shi-xu-jie-xi" class="header-anchor">#</a></h2><p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/2.png" alt="img"></p>
<ol>
<li><p>MCU发送一个开始信号S，这个开始信号是一个低脉冲，然后再拉高。等待DHT11应答。</p>
</li>
<li><p>DH11拉低，做出一个响应信号，再拉高，准备发送数据。</p>
</li>
<li><p>接着就是DH11返回的数据。</p>
</li>
</ol>
<h3><span id="1-1-1-shu-ju-ge-shi">1.1.1 数据格式</span><a href="#1-1-1-shu-ju-ge-shi" class="header-anchor">#</a></h3><p>这些数据一共有40bit,高位先出。（8bit湿度整数数据+8bit湿度小数数据+8bi温度整数数据+8bit温度小数数据+8bit校验和）</p>
<p>数据有40bit: 8bit湿度整数数据+8bit湿度小数数据+8bit温度整数数据+8bit温度小数数据+8bit校验和</p>
<h3><span id="1-1-2-shi-xu-can-shu">1.1.2 时序参数</span><a href="#1-1-2-shi-xu-can-shu" class="header-anchor">#</a></h3><p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/3.png" alt="img"></p>
<p>MCU必须先拉低至少18ms, 然后再拉高20-40us, DH11再拉低80us以响应,最后再拉高80us。</p>
<h3><span id="1-1-3-shu-ju-chuan-shu">1.1.3 数据传输</span><a href="#1-1-3-shu-ju-chuan-shu" class="header-anchor">#</a></h3><p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/4.png" alt="img"></p>
<p><strong>Bit0</strong>：1bit 50us开始后，DHT11拉低数据时间为30us以内。</p>
<p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/5.png" alt="img"></p>
<p><strong>Bit1</strong>: 1bit 50us开始后，DHT11拉低数据时间为超过70us。</p>
<h2><span id="1-1-4-dai-ma-shi-xian">1.1.4 代码实现</span><a href="#1-1-4-dai-ma-shi-xian" class="header-anchor">#</a></h2><p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/6.png" alt="img"></p>
<p><img src="/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/7.png" alt="img"></p>
<p>使用GPG5引脚:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dht11_data_cfg_as_output</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">        GPGCON &amp;= ~(<span class="number">3</span>&lt;&lt;<span class="number">10</span>);</span><br><span class="line">        GPGCON |= (<span class="number">1</span>&lt;&lt;<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dht11_data_cfg_as_input</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">        GPGCON &amp;= ~(<span class="number">3</span>&lt;&lt;<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dht11_data_set</span><span class="params">(<span class="type">int</span> val)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (val)</span><br><span class="line">                GPGDAT |= (<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                GPGDAT &amp;= ~(<span class="number">1</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dht11_data_get</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (GPGDAT &amp; (<span class="number">1</span>&lt;&lt;<span class="number">5</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//DHT11操作：</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">dht11_init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    dht11_data_cfg_as_output();</span><br><span class="line">    dht11_data_set(<span class="number">1</span>);</span><br><span class="line">    mdelay(<span class="number">2000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dht11_start</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    dht11_data_set(<span class="number">0</span>);</span><br><span class="line">    mdelay(<span class="number">20</span>);</span><br><span class="line">    dht11_data_cfg_as_input();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dht11_wait_ack</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    udelay(<span class="number">60</span>);</span><br><span class="line">    <span class="keyword">return</span> dht11_data_get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dht11_recv_byte</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> data = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dht11_wait_for_val(<span class="number">1</span>, <span class="number">1000</span>)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;dht11 wait for high data err!\n\r&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        udelay(<span class="number">40</span>);</span><br><span class="line">        data &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (dht11_data_get() == <span class="number">1</span>)</span><br><span class="line">            data |= <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (dht11_wait_for_val(<span class="number">0</span>, <span class="number">1000</span>)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;dht11 wait for low data err!\n\r&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dht11_wait_for_val</span><span class="params">(<span class="type">int</span> val, <span class="type">int</span> timeout_us)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (timeout_us--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dht11_data_get() == val)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* ok */</span></span><br><span class="line">        udelay(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* err */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dht11_read</span><span class="params">(<span class="type">int</span> *hum, <span class="type">int</span> *temp)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> hum_m, hum_n;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> temp_m, temp_n;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> check;        </span><br><span class="line">    </span><br><span class="line">    dht11_start();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != dht11_wait_ack()) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dht11 not ack, err!\n\r&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != dht11_wait_for_val(<span class="number">1</span>, <span class="number">1000</span>)) &#123; <span class="comment">/* 等待ACK变为高电平, 超时时间是1000us */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dht11 wait for ack high err!\n\r&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != dht11_wait_for_val(<span class="number">0</span>, <span class="number">1000</span>)) &#123; <span class="comment">/* 数据阶段: 等待低电平, 超时时间是1000us */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dht11 wait for data low err!\n\r&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hum_m  = dht11_recv_byte();</span><br><span class="line">    hum_n  = dht11_recv_byte();</span><br><span class="line">    temp_m = dht11_recv_byte();</span><br><span class="line">    temp_n = dht11_recv_byte();</span><br><span class="line">    check  = dht11_recv_byte();</span><br><span class="line"></span><br><span class="line">    dht11_data_cfg_as_output();</span><br><span class="line">    dht11_data_set(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hum_m + hum_n + temp_m + temp_n == check) &#123;</span><br><span class="line">        *hum  = hum_m;</span><br><span class="line">        *temp = temp_m;</span><br><span class="line">        mdelay(<span class="number">2000</span>);  <span class="comment">/* 读取周期是2S, 不能读太频繁 */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dht11 checksum err!\n\r&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dht11_test</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">int</span> hum, temp;</span><br><span class="line">    dht11_init();</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (dht11_read(&amp;hum, &amp;temp) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n\rdht11 read err!\n\r&quot;</span>);</span><br><span class="line">            dht11_init();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n\rDHT11 : %d humidity, %d temperature\n\r&quot;</span>, hum, temp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/12/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-%E4%BC%A0%E6%84%9F%E5%99%A8/" data-id="clyylnk92006d7wuf5igoa12z" data-title="通用裸机-传感器" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-通用裸机-arm汇编" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/" class="article-date">
  <time class="dt-published" datetime="2024-05-03T07:51:11.000Z" itemprop="datePublished">2024-05-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/">通用裸机-arm汇编</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-gnu-hui-bian-ge-shi">1 GNU 汇编格式</a><ul>
<li><a href="#1-1-wei-cao-zuo">1.1伪操作</a><ul>
<li><a href="#1-1-1-section">1.1.1 .section</a></li>
<li><a href="#1-1-2-global">1.1.2 .global</a></li>
<li><a href="#1-1-3-comm">1.1.3 .comm</a></li>
<li><a href="#1-1-4-byte-word">1.1.4 .byte ， .word</a></li>
<li><a href="#1-1-5-set-eqv-equ-equiv">1.1.5 .set， .eqv， .equ， .equiv</a></li>
<li><a href="#1-1-6-weak">1.1.6 .weak</a></li>
</ul>
</li>
<li><a href="#1-2-han-shu-ding-yi">1.2 函数定义</a></li>
</ul>
</li>
<li><a href="#2-armv7-hui-bian-zhi-ling">2 ARMv7汇编指令</a><ul>
<li><a href="#2-1-shu-ju-yi-dong-zhi-ling">2.1 数据移动指令</a><ul>
<li><a href="#2-1-1-mov">2.1.1 MOV</a></li>
<li><a href="#2-1-2-mrs">2.1.2 MRS</a></li>
<li><a href="#2-1-3-msr">2.1.3 MSR</a></li>
<li><a href="#2-1-4-cps">2.1.4 CPS</a></li>
</ul>
</li>
<li><a href="#2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram">2.2 数据存取指令（访问存储器RAM）</a><ul>
<li><a href="#2-2-1-ldr">2.2.1 LDR</a></li>
<li><a href="#2-2-2-str">2.2.2 STR</a></li>
<li><a href="#2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng">2.2.3 多寄存器加载存储指令LDMIA，STMIA等</a></li>
</ul>
</li>
<li><a href="#2-3-ru-zhan-chu-zhan-zhi-ling">2.3 入栈出栈指令</a><ul>
<li><a href="#2-3-1-push">2.3.1 PUSH</a></li>
<li><a href="#2-3-2-pop">2.3.2 POP</a></li>
</ul>
<ul>
<li><a href="#2-3-3-stmfd-he-ldmfd">2.3.3 STMFD和LDMFD</a></li>
</ul>
</li>
<li><a href="#2-4-tiao-zhuan-zhi-ling">2.4 跳转指令</a><ul>
<li><a href="#2-4-1-b-zhi-ling">2.4.1 B 指令</a></li>
<li><a href="#2-4-2-bl-zhi-ling">2.4.2 BL 指令</a></li>
</ul>
</li>
<li><a href="#2-5-suan-shu-yun-suan-zhi-ling">2.5 算数运算指令</a></li>
<li><a href="#2-6-luo-ji-yun-suan-zhi-ling">2.6 逻辑运算指令</a></li>
<li><a href="#2-7-nei-cun-ping-zhang-zhi-ling">2.7 内存屏障指令</a><ul>
<li><a href="#2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang">2.7.1 Data Memory Barrier(DMB)：数据内存屏障</a></li>
<li><a href="#2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang">2.7.2 Data Synchronization Barrier(DSB)：数据同步屏障</a></li>
<li><a href="#2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang">2.7.3 Instruction Synchronization Barrier(ISB)：指令同步屏障</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-arm-v7-cpu-yun-xing-mo-shi">3 arm-v7 cpu运行模式</a></li>
<li><a href="#4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi">4 arm-v7 cpu通用和特殊寄存器</a><ul>
<li><a href="#4-1-tong-yong-ji-cun-qi">4.1 通用寄存器</a><ul>
<li><a href="#4-1-1-tong-yong-ji-cun-qi-fen-lei">4.1.1 通用寄存器分类</a></li>
<li><a href="#4-1-2-wei-bei-fen-ji-cun-qi-r0-r7">4.1.2 未备份寄存器R0-R7</a></li>
<li><a href="#4-1-3-bei-fen-ji-cun-qi">4.1.3 备份寄存器</a><ul>
<li><a href="#4-1-3-1-r8-r12">4.1.3.1 R8~R12</a></li>
<li><a href="#4-1-3-2-r13-sp">4.1.3.2 R13 (SP)</a></li>
<li><a href="#4-1-3-2-r14-lr">4.1.3.2 R14 (LR)</a></li>
<li><a href="#4-1-3-2-r15-pc">4.1.3.2 R15 (PC)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-2-te-shu-ji-cun-qi">4.2 特殊寄存器</a><ul>
<li><a href="#4-2-1-cpsr">4.2.1 CPSR</a></li>
<li><a href="#4-2-2-spsr">4.2.2 SPSR</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-cp15-xie-chu-li-qi">5 CP15协处理器</a><ul>
<li><a href="#5-1-xie-chu-li-qi-zhi-ling">5.1 协处理器指令</a></li>
<li><a href="#5-2-c0-ji-cun-qi-midr">5.2 c0寄存器（MIDR）</a></li>
<li><a href="#5-3-c1-ji-cun-qi-sctlr">5.3 c1寄存器（SCTLR）</a></li>
<li><a href="#5-4-c12-ji-cun-qi-vbar">5.4 c12寄存器（VBAR）</a></li>
<li><a href="#5-5-c15-ji-cun-qi-cbar">5.5 c15寄存器（CBAR）</a></li>
</ul>
</li>
<li><a href="#6-arm-guan-fang-can-kao-lian-jie">6 arm官方参考链接</a><ul>
<li><a href="#6-1-armv7-yu-armv8-jia-gou">6.1 armv7与armv8架构</a></li>
<li><a href="#6-2-armv7-can-kao-shou-ce">6.2 armv7参考手册</a></li>
<li><a href="#6-3-armv7-bian-cheng-shou-ce">6.3 armv7 编程手册</a></li>
<li><a href="#6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce">6.4 Cortex-A7 <code>MPCore</code> 技术参考手册</a></li>
</ul>
</li>
<li><a href="#7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li">7 附件1：armv7裸机启动汇编示例：</a></li>
<li><a href="#8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi">8 附件2：GIC指令和寄存器定义（内联汇编方式）</a><ul>
<li><a href="#8-1-nei-lian-hui-bian-yuan-li">8.1 内联汇编原理</a><ul>
<li><a href="#8-1-1-cao-zuo-shu-shu-xing">8.1.1 操作数属性</a></li>
<li><a href="#8-1-2-clobber-list">8.1.2 clobber list</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-gnu-hui-bian-ge-shi">1 GNU 汇编格式</span><a href="#1-gnu-hui-bian-ge-shi" class="header-anchor">#</a></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label：instruction @ comment</span><br></pre></td></tr></table></figure>
<p><strong>label</strong> 即标号，表示地址位置，有些指令前面可能会有标号，这样就可以通过这个标号得到指令的地址，标号也可以用来表示数据地址。注意 label 后面的“：”，任何以“：”结尾的标识符都会被识别为一个标号。<br><strong>instruction</strong> 即指令，也就是汇编指令或伪指令。<br><strong>@符号</strong>，表示后面的是注释，就跟 C 语言里面的<code>/*</code>和<code>*/</code>一样，其实在 GNU 汇编文件中我们也可以使用<code>\*</code>和<code>*/</code>来注释。<br><strong>comment</strong> 就是注释内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add:</span><br><span class="line">MOVS R0, #0X12 @设置 R0=0X12</span><br></pre></td></tr></table></figure>

<p><strong>注意:</strong> ARM 中的指令、伪指令、伪操作、寄存器名等可以全部使用大写，也可以全部使用小写，但是不能大小写混用</p>
<h2><span id="1-1-wei-cao-zuo">1.1伪操作</span><a href="#1-1-wei-cao-zuo" class="header-anchor">#</a></h2><h3><span id="1-1-1-section">1.1.1 .section</span><a href="#1-1-1-section" class="header-anchor">#</a></h3><p>来定义一个段，汇编系统预定义了一些段名：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text 表示代码段。</span><br><span class="line">.data 初始化的数据段。</span><br><span class="line">.bss 未初始化的数据段。</span><br><span class="line">.rodata 只读数据段。</span><br></pre></td></tr></table></figure>

<p>定义一个 testsetcion 段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.section .testsection</span><br></pre></td></tr></table></figure>
<p>同时，还可以指定该段的属性，对应的属性见下表:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">a section is allocatable</span><br><span class="line">d section is a GNU_MBIND section</span><br><span class="line">e section is excluded from executable and shared library.</span><br><span class="line">w section is writable</span><br><span class="line">x section is executable</span><br><span class="line">M section is mergeable</span><br><span class="line">S section contains zero terminated strings</span><br><span class="line">G section is a member of a section group</span><br><span class="line">T section is used <span class="keyword">for</span> thread-local-storage</span><br></pre></td></tr></table></figure>

<p>属性可以组合， 比如:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.section .foo，<span class="string">&quot;aex&quot;</span></span><br><span class="line">    text...</span><br></pre></td></tr></table></figure>

<p>汇编程序的默认入口标号是_start，不过我们也可以在链接脚本中使用 <code>ENTRY</code> 来指明其它的入口点。</p>
<h3><span id="1-1-2-global">1.1.2 .global</span><a href="#1-1-2-global" class="header-anchor">#</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">_start:</span><br><span class="line">ldr r0, =0x12 @r0=0x12</span><br></pre></td></tr></table></figure>

<p><code>.global</code> 是伪操作，表示<code>_start</code> 是一个全局标号，类似 C 语言里面的全局变量一样，常见的伪操作有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.byte 定义单字节数据，比如.byte <span class="number">0x12</span>。</span><br><span class="line">.<span class="type">short</span> 定义双字节数据，比如.<span class="type">short</span> <span class="number">0x1234</span>。</span><br><span class="line">.<span class="type">long</span> 定义一个 <span class="number">4</span> 字节数据，比如.<span class="type">long</span> <span class="number">0x12345678</span>。</span><br><span class="line">.equ 赋值语句，格式为：.equ 变量名，表达式，比如.equ num, <span class="number">0x12</span>，表示 num=<span class="number">0x12</span>。</span><br><span class="line">.align 数据字节对齐，比如：.align <span class="number">4</span> 表示 <span class="number">4</span> 字节对齐。</span><br><span class="line">.end 表示源文件结束。</span><br><span class="line">.global 定义一个全局符号，格式为：.global symbol，比如：.global _start。</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-3-comm">1.1.3 .comm</span><a href="#1-1-3-comm" class="header-anchor">#</a></h3><p><code>.comm </code>表示目标文件中的<code> common symbol</code>，表示公共的符号:<br><code>.comm symbol，length</code></p>
<p>这和 GNU 中的强弱符号机制相关，未初始化的变量表示为弱符号，初始化的变量为强符号，当不同源文件中存在多个同名变量时，强符号会覆盖弱符号而不会报错，这是 <code>gcc </code>的扩展语法，所以实际上未初始化的全局变量是作为公共符号保存的，当多个文件中的<code>comm</code>符号出现冲突时，需要将其以一定规则融合. 实际上，C 语言中未定义的全局变量(也就是 <code>comm </code>符号)并非是存放到 <code>bss </code>段中的，而是保存在 COMMON 段.</p>
<h3><span id="1-1-4-byte-word">1.1.4 .byte ， .word</span><a href="#1-1-4-byte-word" class="header-anchor">#</a></h3><p>伪汇编中有一系列的数据放置指令，表示在当前位置放置某些数据，相对应的有:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.byte : 放置一个字节</span><br><span class="line">.hword:放置半字，在 <span class="number">32</span> 位平台中对应两个字节，<span class="number">64</span> 位对应四字节</span><br><span class="line">.<span class="type">short</span>:放置一个 <span class="type">short</span> 类型数据，两个字节.word:放置一个字，在 <span class="number">32</span> 位平台中对应四个字节，<span class="number">64</span> 位对应八字节</span><br><span class="line">.<span class="type">int</span> : 放置一个 <span class="type">int</span> 类型的数据，数据长度根据平台而定，<span class="number">16</span>位平台为两字节，<span class="number">32</span>位和<span class="number">64</span>位平台为四字节</span><br><span class="line">.<span class="type">long</span>:放置一个 <span class="type">long</span> 类型的数据，数据长度根据平台而定，<span class="number">32</span>位平台为四字节，<span class="number">64</span>位平台为八字节</span><br><span class="line">.<span class="type">float</span>:放置一个 <span class="type">float</span> 类型数据，四字节</span><br><span class="line">.<span class="type">double</span>:放置一个 <span class="type">double</span> 类型数据，八字节</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-5-set-eqv-equ-equiv">1.1.5 .set， .eqv， .equ， .equiv</span><a href="#1-1-5-set-eqv-equ-equiv" class="header-anchor">#</a></h3><p>set:设置一个符号的值, C 中的宏。通过设置一个符号的值，在后续的代码中可以重复使用该符号的值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="built_in">set</span> sym_set，<span class="number">0x100</span></span><br><span class="line">mov r0，#sym_set</span><br></pre></td></tr></table></figure>

<h3><span id="1-1-6-weak">1.1.6 .weak</span><a href="#1-1-6-weak" class="header-anchor">#</a></h3><p>定义一个 weak 类型的符号，当这个符号在相同作用域的地方存在定义，当前符号会被忽略，如果这个符号之前不存在，这个符号就会被使用. 这和 C 语言中的 weak 机制是一样的.</p>
<h2><span id="1-2-han-shu-ding-yi">1.2 函数定义</span><a href="#1-2-han-shu-ding-yi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">函数名:</span><br><span class="line">	函数体</span><br><span class="line">	返回语句</span><br></pre></td></tr></table></figure>

<p>GNU 汇编函数返回语句不是必须的，如下代码就是用汇编写的Cortex-A7 中断服务函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 未定义中断 */</span></span><br><span class="line">Undefined_Handler:</span><br><span class="line">	ldr r0, =Undefined_Handler</span><br><span class="line">	bx r0</span><br><span class="line"><span class="comment">/* SVC 中断 */</span></span><br><span class="line">SVC_Handler:</span><br><span class="line">	ldr r0, =SVC_Handler</span><br><span class="line">	bx r0</span><br><span class="line"><span class="comment">/* 预取终止中断 */</span></span><br><span class="line">PrefAbort_Handler:</span><br><span class="line">	ldr r0, =PrefAbort_Handler </span><br><span class="line">	bx r0</span><br></pre></td></tr></table></figure>

<p>以函数 <code>Undefined_Handler</code> 为例我们来看一下汇编函数组成，<code>Undefined_Handler</code>就是函数名，<code>ldr r0, =Undefined_Handler</code>是函数体，<code>bx r0</code>是函数返回语句，<code>bx</code>指令是返回指令，函数返回语句不是必须的.</p>
<h1><span id="2-armv7-hui-bian-zhi-ling">2 ARMv7汇编指令</span><a href="#2-armv7-hui-bian-zhi-ling" class="header-anchor">#</a></h1><h2><span id="2-1-shu-ju-yi-dong-zhi-ling">2.1 数据移动指令</span><a href="#2-1-shu-ju-yi-dong-zhi-ling" class="header-anchor">#</a></h2><p>数据移动指令都是cpu内部寄存器之间的数据拷贝。</p>
<h3><span id="2-1-1-mov">2.1.1 MOV</span><a href="#2-1-1-mov" class="header-anchor">#</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV R0，R1 @将寄存器 R1 中的数据传递给 R0，即 R0=R1</span><br><span class="line">MOV R0, #0X12 @将立即数 0X12 传递给 R0 寄存器，即 R0=0X12</span><br></pre></td></tr></table></figure>
<h3><span id="2-1-2-mrs">2.1.2 MRS</span><a href="#2-1-2-mrs" class="header-anchor">#</a></h3><p>读取特殊寄存器的数据只能使用 MRS 指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRS R0, CPSR @将 CPSR 里面的数据传递给 R0，即 R0=CPSR</span><br></pre></td></tr></table></figure>
<h3><span id="2-1-3-msr">2.1.3 MSR</span><a href="#2-1-3-msr" class="header-anchor">#</a></h3><p>和 MRS 刚好相反，通用寄存器写入到特殊寄存器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSR CPSR, R0 @将 R0 中的数据复制到 CPSR 中，即 CPSR=R0</span><br></pre></td></tr></table></figure>

<p>举个例子利用MRS MSR进行清bss (_bss_start, __bss_end定义在链接脚本):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">.global _bss_start</span><br><span class="line">.global _bss_end</span><br><span class="line"></span><br><span class="line">_bss_start:</span><br><span class="line">	.word __bss_start</span><br><span class="line">_bss_end:</span><br><span class="line">	.word __bss_end</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	<span class="comment">//disable watchdog, disable icache dcache</span></span><br><span class="line">	<span class="comment">//init_clk</span></span><br><span class="line">	<span class="comment">//enter svc mode</span></span><br><span class="line">	<span class="comment">/*clear bss*/</span></span><br><span class="line">	ldr r0, _bss_start</span><br><span class="line">	ldr r1, _bss_end</span><br><span class="line">	move r2, <span class="number">0</span></span><br><span class="line">clr_bss:</span><br><span class="line">	stmia r0!, &#123;r2&#125; <span class="comment">//复制一r2中的数据给r0, 并将指针r0增加4</span></span><br><span class="line">	cmp r0, r1</span><br><span class="line">	ble clr_bss <span class="comment">/*if r0&lt;r1, b clr_bss*/</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-1-4-cps">2.1.4 CPS</span><a href="#2-1-4-cps" class="header-anchor">#</a></h3><p>特权模式下（除了用户模式，剩余的模式都是特权模式），可以通过CPS指令直接修改CPSR寄存器的M[4:0]，让处理器进入不同的模式。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/1.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CPS #0x12 /*irq mode*/</span><br><span class="line">CPS #0x13 /*svc mode*/</span><br></pre></td></tr></table></figure>
<h2><span id="2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram">2.2 数据存取指令（访问存储器RAM）</span><a href="#2-2-shu-ju-cun-qu-zhi-ling-fang-wen-cun-chu-qi-ram" class="header-anchor">#</a></h2><h3><span id="2-2-1-ldr">2.2.1 LDR</span><a href="#2-2-1-ldr" class="header-anchor">#</a></h3><p>数据加载指令，从指定地址读取到cpu寄存器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR R0, =0X0209C004 @将寄存器地址 0X0209C004 加载到 R0 中，即 R0=0X0209C004</span><br><span class="line">LDR R1, [R0] @读取地址 0X0209C004 中的数据到 R1 寄存器中</span><br></pre></td></tr></table></figure>
<h3><span id="2-2-2-str">2.2.2 STR</span><a href="#2-2-2-str" class="header-anchor">#</a></h3><p>数据存放指令，从cpu寄存器写入指定地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LDR R0, =0X0209C004 @将寄存器地址 0X0209C004 加载到 R0 中，即 R0=0X0209C004</span><br><span class="line">LDR R1, =0X20000002 @R1 保存要写入到寄存器的值，即 R1=0X20000002</span><br><span class="line">STR R1, [R0] @将 R1 中的值写入到 R0 中所保存的地址中</span><br></pre></td></tr></table></figure>

<p>LDR 和 STR 都是按照4 byte进行读取和写入的，也就是操作的 32 位数据，如果要按照字节、半字进行操作的话可以在指令“LDR”后面加上 B 或 H，比如按字节操作的指令就是 LDRB 和STRB，按半字(16位)操作的指令就是 LDRH 和 STRH。</p>
<h3><span id="2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng">2.2.3 多寄存器加载存储指令LDMIA，STMIA等</span><a href="#2-2-3-duo-ji-cun-qi-jia-zai-cun-chu-zhi-ling-ldmia-stmia-deng" class="header-anchor">#</a></h3><p><strong>1.LDMIA指令、LDMIB指令、LDMDB指令、LDMDA指令</strong><br>LDM是LDR指令的增强型 ， 将连续的数据加载到多组寄存器。<br>DB （Decrement Before）栈指针先减小再操作、DA（Decrement After）栈指针先操作再减小。<br>IB（Increment Before）栈指针先增加再操作、IA（Increment After）栈指针先操作再增加。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">LDMIA指令，IA表示每次传送后地址加<span class="number">4</span></span><br><span class="line">LDMIB指令，IB表示每次传送前地址加<span class="number">4</span></span><br><span class="line">LDMDA指令，DA表示每次传送后地址减<span class="number">4</span></span><br><span class="line">LDMDB指令，DB表示每次传送前地址减<span class="number">4</span></span><br><span class="line"></span><br><span class="line">LDMIA R14，&#123;R0-R3，R12&#125; <span class="comment">/*从R14寄存器指向的地址取出5个32位数据分别存进到R0-R4以及R12*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//等效于</span></span><br><span class="line"><span class="comment">//R0=*R14</span></span><br><span class="line"><span class="comment">//R1=*（R14+4）</span></span><br><span class="line"><span class="comment">//R2=*（R14+8）</span></span><br><span class="line"><span class="comment">//R3=*（R14+12）</span></span><br><span class="line"><span class="comment">//R12=*（R14+16）</span></span><br><span class="line"></span><br><span class="line">LDMIA R1！，&#123;R4-R11&#125; <span class="comment">/*从R1指向的地址取8个32位数据存入R4-R11, 每取一次，让R1指针加4，因此最后R1指针加了32*/</span></span><br></pre></td></tr></table></figure>

<p><strong>2.STMIA指令、STMIB指令、STMDB指令、STMDA指令</strong><br>同理，STM是STR指令的增强型 ， 将多组寄存器数据保存进连续地址空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STMIA R13！，&#123;R0-R1&#125; /*将R0，R1寄存器中的数据存入R13指向的栈空间, r13指向的地址存入R0数据，再地址+4后存入R1的数据*/</span><br></pre></td></tr></table></figure>
<h2><span id="2-3-ru-zhan-chu-zhan-zhi-ling">2.3 入栈出栈指令</span><a href="#2-3-ru-zhan-chu-zhan-zhi-ling" class="header-anchor">#</a></h2><p>函调调用过程中离不开现场的保护和恢复。保存 <code>R0~R15</code> 寄存器的操作就叫做现场保护，恢复 R0~R15 寄存器的操作就叫做恢复现场。</p>
<h4><span id="2-3-1-push">2.3.1 PUSH</span><a href="#2-3-1-push" class="header-anchor">#</a></h4><p>比如要将 R0~R3 和 R12 这 5 个寄存器压栈，当前的 <code>SP （stack pointer）</code>指针指向 <code>0X80000000</code>，我们知道栈空间的地址是向下增长的，堆空间地址向上增长。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH &#123;R0~R3, R12&#125; @将 R0~R3 和 R12 压栈</span><br></pre></td></tr></table></figure>

<p>那么压栈完成以后的堆栈如下：入栈保护现场完这5个寄存器后，SP指向<code>0X7FFFFFEC</code>（每压栈一个寄存器，SP地址减4）<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/2.png" alt="image"><br>再次保存LR寄存器，进行压栈：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/3.png" alt="image"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH &#123;LR&#125; @将 LR 进行压栈</span><br></pre></td></tr></table></figure>

<h4><span id="2-3-2-pop">2.3.2 POP</span><a href="#2-3-2-pop" class="header-anchor">#</a></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POP &#123;LR&#125; @先恢复 LR</span><br><span class="line">POP &#123;R0~R3,R12&#125; @在恢复 R0~R3,R12</span><br></pre></td></tr></table></figure>

<p>可以看出入栈出栈本质都是对SP指针进行加减，入栈减，出栈加，入栈把寄存器依次保存进SP指向的地址去，出栈从SP地址依次取出数据。</p>
<h3><span id="2-3-3-stmfd-he-ldmfd">2.3.3 STMFD和LDMFD</span><a href="#2-3-3-stmfd-he-ldmfd" class="header-anchor">#</a></h3><p>入栈出栈的另外一种写法是“STMFD SP！”和“LDMFD SP!”。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STMFD SP!,&#123;R0~R3, R12&#125; @R0~R3,R12 入栈</span><br><span class="line">STMFD SP!,&#123;LR&#125; @LR 入栈</span><br><span class="line">bl xxx</span><br><span class="line">LDMFD SP!, &#123;LR&#125; @先恢复 LR</span><br><span class="line">LDMFD SP!, &#123;R0~R3, R12&#125; @再恢复 R0~R3, R12</span><br></pre></td></tr></table></figure>

<p>STMFD 可以分为两部分：STM 和 FD，同理，LDMFD 也可以分为 LDM 和 FD。前面我们讲了 LDR 和 STR，这两个是数据加载和存储指令，但是每次只能读写存储器中的一个数据。STM 和 LDM 就是多存储和多加载，可以连续的读写存储器中的多个连续数据。<br>FD 是 Full Descending 的缩写，即满递减的意思。根据 ATPCS 规则,ARM 使用的 FD 类型的堆栈，SP 指向最后一个入栈的数值，堆栈是由高地址向下增长的，也就是前面说的向下增长的堆栈，因此最常用的指令就是 STMFD 和 LDMFD。STM 和 LDM 的指令寄存器列表中编号小的对应低地址，编号高的对应高地址.</p>
<h2><span id="2-4-tiao-zhuan-zhi-ling">2.4 跳转指令</span><a href="#2-4-tiao-zhuan-zhi-ling" class="header-anchor">#</a></h2><h3><span id="2-4-1-b-zhi-ling">2.4.1 B 指令</span><a href="#2-4-1-b-zhi-ling" class="header-anchor">#</a></h3><p>B 指令会将 PC 寄存器的值设置为跳转目标地址，如果要调用的函数不会再返回到原来的执行处，那就可以用 B 指令.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">ldr sp,=0X80200000 @设置栈指针</span><br><span class="line">b main @跳转到 main 函数</span><br></pre></td></tr></table></figure>

<p>在汇编中初始化 C 运行环境，然后跳转到 C 文件的 main 函数中运行，上述代码只是初始化了 SP 指针，有些处理器还需要做其他的初始化，比如初始化 DDR 等等.</p>
<h3><span id="2-4-2-bl-zhi-ling">2.4.2 BL 指令</span><a href="#2-4-2-bl-zhi-ling" class="header-anchor">#</a></h3><p>有返回的跳转，跳转之前会在寄存器 LR(R14)中保存当前 PC 寄存器值，所以可以通过<strong>将 LR 寄存器中的值重新加载到 PC</strong> 中来继续从跳转之前的代码处运行，这是子程序调用一个基本但常用的手段。<br>比如 Cortex-A 处理器的 irq 中断服务函数都是汇编写的，主要用汇编来实现现场的保护和恢复、获取中断号等。但是具体的中断处理过程都是 C 函数，所以就会存在汇编中调用 C 函数的问题。而且当 C 语言版本的中断处理函数执行完成以后是需要返回到irq 汇编中断服务函数，因为还要处理其他的工作，一般是恢复现场。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">push &#123;r0, r1&#125; @保存 r0,r1</span><br><span class="line">cps #0x13 @进入 SVC 模式，允许其他中断再次进去</span><br><span class="line"></span><br><span class="line">bl system_irqhandler @加载 C 语言中断处理函数到 r2 寄存器中</span><br><span class="line"></span><br><span class="line">cps #0x12 @进入 IRQ 模式</span><br><span class="line">pop &#123;r0, r1&#125; </span><br><span class="line">str r0, [r1, #0X10] @中断执行完成，写 EOIR</span><br></pre></td></tr></table></figure>

<p>跳转指令总结：<br>有多种跳转操作，比如：<br>①、直接使用跳转指令 B、BL、BX 等。<br>②、直接向 PC 寄存器里面写入数据。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/4.png" alt="image"></p>
<h2><span id="2-5-suan-shu-yun-suan-zhi-ling">2.5 算数运算指令</span><a href="#2-5-suan-shu-yun-suan-zhi-ling" class="header-anchor">#</a></h2><p>加减乘除，常用的运算指令用法：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/5.png" alt="image"></p>
<h2><span id="2-6-luo-ji-yun-suan-zhi-ling">2.6 逻辑运算指令</span><a href="#2-6-luo-ji-yun-suan-zhi-ling" class="header-anchor">#</a></h2><p>与或非指令用法：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/6.png" alt="image"><br>来看一个例子利用arm汇编进行初始化C语言环境。让arm进入svc模式，才能访问特殊寄存器如cpsr, spsr, sp指针。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.global _start</span><br><span class="line">_start:</span><br><span class="line">	/* 进入SVC模式 */</span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #0x1f  /* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 */</span><br><span class="line">	orr r0, r0, #0x13  /* r0或上0x13,表示使用SVC模式 */</span><br><span class="line">	msr cpsr, r0 /* 将r0 的数据写入到cpsr_c中 */</span><br><span class="line"></span><br><span class="line">	ldr sp, =0X80200000 /* 设置栈指针 */</span><br><span class="line">	b main /* 跳转到main函数 */</span><br></pre></td></tr></table></figure>

<h2><span id="2-7-nei-cun-ping-zhang-zhi-ling">2.7 内存屏障指令</span><a href="#2-7-nei-cun-ping-zhang-zhi-ling" class="header-anchor">#</a></h2><h3><span id="2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang">2.7.1 Data Memory Barrier(DMB)：数据内存屏障</span><a href="#2-7-1-data-memory-barrier-dmb-shu-ju-nei-cun-ping-zhang" class="header-anchor">#</a></h3><p>DMB指令确保在DMB之前的所有显式数据内存传输指令都已经在内存中读取或写入完成，同时确保任何后续的数据内存传输指令都将在DMB执行之后开始执行，否则有些数据传输指令可能会提前执行。保证了两个内存访问能按正确的顺序执行。<br>应用场景：<br>（1）DMA<br>在使用DMA控制器时，需要在CPU内存访问和DMA操作之间插入DMB屏障，以确保CPU当前的内存读写操作在DMA开始之前完成。</p>
<p>（2）多核系统中的信号量<br>在多核系统中，使用信号量进行核间同步。需要使用DMB来强制指定内存执行顺序，以避免潜在的竞态条件或数据不一致性。当一个核要访问共享资源之前，它会先检查信号量的状态。如果信号量已经被另一个核获取，当前核就必须等待，直到信号量状态变为可用。这个等待过程需要保证在一个核释放信号量之后，其他核能够立即看到信号量状态的变化，而不是因为处理器优化或缓存导致的无效读取而产生错误。</p>
<h3><span id="2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang">2.7.2 Data Synchronization Barrier(DSB)：数据同步屏障</span><a href="#2-7-2-data-synchronization-barrier-dsb-shu-ju-tong-bu-ping-zhang" class="header-anchor">#</a></h3><p>在多线程编程中，两个线程同时对共享的内存进行读写操作，由于读&#x2F;写操作的重排序，就会导致数据的不一致, DSB指令时，它确保在DSB之前的所有显式数据内存传输指令都已经在内存中读取或写入完成，同时确保任何后续的指令都将在DSB执行之后开始执行。<br>应用场景：<br>例如启用或禁用特定的中断、配置时钟、设置系统控制位等。为了确保对SCS的修改在下一条指令执行之前生效，需要使用DSB指令进行数据同步。一些特殊的指令如SVC(Supervisor Call，特权级调用)、WFI(Wait For Interrupt，等待中断）、WFE(Wait For Event，等待事件)等操作，涉及到特权级的转换或者等待系统事件发生，需要使用DSB指令。</p>
<h3><span id="2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang">2.7.3 Instruction Synchronization Barrier(ISB)：指令同步屏障</span><a href="#2-7-3-instruction-synchronization-barrier-isb-zhi-ling-tong-bu-ping-zhang" class="header-anchor">#</a></h3><p>插入ISB指令，处理器会将流水线中的指令全部刷新，从而确保之前的指令不会影响后续指令的执行，并且后续指令将从正确的上下文开始重新获取。<br>应用场景：<br>在进行异常进入之前，处理器会执行ISB操作。这样做的目的是刷新指令流水线，确保异常处理程序的指令是从正确的地址开始执行，避免异常之前的指令对异常处理程序造成干扰。<br>在进行异常返回之前，处理器同样会执行ISB操作。这样做的目的是刷新指令流水线，确保返回时从正确的地址重新获取指令，避免异常处理程序的指令对正常任务造成干扰。</p>
<h1><span id="3-arm-v7-cpu-yun-xing-mo-shi">3 arm-v7 cpu运行模式</span><a href="#3-arm-v7-cpu-yun-xing-mo-shi" class="header-anchor">#</a></h1><p>以前的 ARM 处理器有 7 中运行模型：User、FIQ、IRQ、Supervisor(SVC)、Abort、Undef和 System，其中 User 是非特权模式，其余 6 中都是特权模式。</p>
<p>到了Cortex-A7 处理器有 9 种处理模式:</p>
<table>
<thead>
<tr>
<th align="center">模式</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">User(USR)</td>
<td align="center">用户模式，非特权模式，大部分程序运行的时候就处于此模式。</td>
</tr>
<tr>
<td align="center">FIQ</td>
<td align="center">快速中断模式，进入 FIQ 中断异常</td>
</tr>
<tr>
<td align="center">IRQ</td>
<td align="center">一般中断模式。</td>
</tr>
<tr>
<td align="center">Supervisor(SVC)</td>
<td align="center">超级管理员模式，特权模式，供操作系统使用。</td>
</tr>
<tr>
<td align="center">Monitor(MON)</td>
<td align="center">监视模式？这个模式用于安全扩展模式。</td>
</tr>
<tr>
<td align="center">Abort(ABT)</td>
<td align="center">数据访问终止模式，用于虚拟存储以及存储保护。</td>
</tr>
<tr>
<td align="center">Hyp(HYP)</td>
<td align="center">Hyp(HYP) 超级监视模式？用于虚拟化扩展。</td>
</tr>
<tr>
<td align="center">Undef(UND)</td>
<td align="center">Undef(UND) 未定义指令终止模式。</td>
</tr>
<tr>
<td align="center">System(SYS)</td>
<td align="center">System(SYS) 系统模式，用于运行特权级的操作系统任务</td>
</tr>
</tbody></table>
<p>九种模式所对应的寄存器：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/7.png" alt="image"><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/12066599.html" title="arm920t cpu模式">arm920t cpu模式</a>或者查看<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/04/16/s3c2440%E8%A3%B8%E6%9C%BA-%E5%BC%82%E5%B8%B8%E4%B8%AD%E6%96%AD/">s3c2440裸机-异常中断 | Hexo (fuzidage.github.io)</a>的CPU模式。</p>
<h1><span id="4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi">4 arm-v7 cpu通用和特殊寄存器</span><a href="#4-arm-v7-cpu-tong-yong-he-te-shu-ji-cun-qi" class="header-anchor">#</a></h1><p>ARM 架构提供了 16 个 32 位的通用寄存器<code>(R0~R15)</code>供软件使用，前 15 个(<code>R0~R14</code>)可以用作通用的数据存储，R15 是程序计数器 PC，用来保存将要执行的指令。ARM 还提供了一个当前程序状态寄存器 CPSR 和一个备份程序状态寄存器 SPSR，SPSR 寄存器就是 CPSR 寄存器的备份。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/8.png" alt="image"></p>
<h2><span id="4-1-tong-yong-ji-cun-qi">4.1 通用寄存器</span><a href="#4-1-tong-yong-ji-cun-qi" class="header-anchor">#</a></h2><h3><span id="4-1-1-tong-yong-ji-cun-qi-fen-lei">4.1.1 通用寄存器分类</span><a href="#4-1-1-tong-yong-ji-cun-qi-fen-lei" class="header-anchor">#</a></h3><p><code>R0~R15</code> 就是通用寄存器，通用寄存器可以分为以下三类：<br>①、未备份寄存器，即 <code>R0~R7</code>。<br>②、备份寄存器，即 <code>R8~R14</code>。<br>③、程序计数器 PC，即 R15。</p>
<h3><span id="4-1-2-wei-bei-fen-ji-cun-qi-r0-r7">4.1.2 未备份寄存器R0-R7</span><a href="#4-1-2-wei-bei-fen-ji-cun-qi-r0-r7" class="header-anchor">#</a></h3><p>未备份寄存器指的是 <code>R0~R7</code> 这 8 个寄存器，因为在所有的处理器模式下这 8 个寄存器都是同一个物理寄存器，在不同的模式下，这 8 个寄存器中的数据就会被破坏.</p>
<h3><span id="4-1-3-bei-fen-ji-cun-qi">4.1.3 备份寄存器</span><a href="#4-1-3-bei-fen-ji-cun-qi" class="header-anchor">#</a></h3><h4><span id="4-1-3-1-r8-r12">4.1.3.1 R8~R12</span><a href="#4-1-3-1-r8-r12" class="header-anchor">#</a></h4><p><code>R8~R12</code> 这 5 个寄存器有2种物理寄存器.在快速中断模式下<code>(FIQ)</code>它们对应着 <code>Rx_irq(x=8~12)</code>物理寄存器，其他模式下对应着 <code>Rx(8~12)</code>物理寄存器. <code>FIQ </code>模式下的 <code>R8~R12</code> 是独立的，因此中断处理程序可以不用执行保存和恢复中断现场的指令，从而加速中断的执行过程。</p>
<h4><span id="4-1-3-2-r13-sp">4.1.3.2 R13 (SP)</span><a href="#4-1-3-2-r13-sp" class="header-anchor">#</a></h4><p>R13 一共有 8 个物理寄存器，其中一个是用户模式<code>(User)</code>和系统模式<code>(Sys)</code>共用的，剩下的 7 个分别对应 7 种不同的模式。R13 也叫做 SP，用来做为栈指针。基本上每种模式<br>都有一个自己的 R13 物理寄存器，应用程序会初始化 R13，使其指向该模式专用的栈地址，这就是常说的初始化 SP 指针.</p>
<h4><span id="4-1-3-2-r14-lr">4.1.3.2 R14 (LR)</span><a href="#4-1-3-2-r14-lr" class="header-anchor">#</a></h4><p> R14 一共有 7 个物理寄存器，其中一个是用户模式(User)、系统模式(Sys)和超级监视模式<code>(Hyp)</code>所共有的，剩下的 6 个分别对应 6 种不同的模式.<br> LR被叫做链接寄存器:<br>①用来存放子函数的返回地址。<br> 在子函数中，将 R14(LR)中的值赋给 R15(PC)即可完成子函数返回，比如在子程序中可以使用如下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MOV PC, LR</span><br></pre></td></tr></table></figure>
<p>②当异常发生以后，该异常模式对应的 R14寄存器被设置成该异常模式将要返回的地址.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subs pc, lr, #4				/* 将lr-4赋给pc */</span><br></pre></td></tr></table></figure>
<p>比如下面代码示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0X2000 MOV R1, R0 ;执行</span><br><span class="line">0X2004 MOV R2, R3 ;译指</span><br><span class="line">0X2008 MOV R4, R5 ;取值 PC</span><br></pre></td></tr></table></figure>
<p>当前正在执行 <code>0X2000</code>地址处的指令<code>MOV R1, R0</code>，但是 PC 里面已经保存了 <code>0X2008 </code>地址处的指令<code>MOV R4, R5</code>。假设此时发生了中断，中断发生的时候保存在 <code>lr </code>中的是 <code>pc</code> 的值，也就是地址<code> 0X2008</code>。</p>
<h4><span id="4-1-3-2-r15-pc">4.1.3.2 R15 (PC)</span><a href="#4-1-3-2-r15-pc" class="header-anchor">#</a></h4><p>R15 保存着当前执行的指令地址值加 8 个字节，这是因为 ARM的流水线机制导致的。ARM 处理器 3 级流水线：取指-&gt;译码-&gt;执行，这三级流水线循环执行，比如当前正在执行第一条指令的同时也对第二条指令进行译码，第三条指令也同时被取出存放在 <code>R15(PC)</code>中.<br>对于arm32位处理器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R15 (PC)值 = 当前执行的程序位置 + 8 个字节</span><br></pre></td></tr></table></figure>
<h2><span id="4-2-te-shu-ji-cun-qi">4.2 特殊寄存器</span><a href="#4-2-te-shu-ji-cun-qi" class="header-anchor">#</a></h2><h3><span id="4-2-1-cpsr">4.2.1 CPSR</span><a href="#4-2-1-cpsr" class="header-anchor">#</a></h3><p>当前程序状态寄存器<code>（current program status register）</code>，所有模式共用一个 <code>CPSR</code> 物理寄存器，因此 <code>CPSR </code>可以在任何模式下被访问。<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/9.png" alt="image"><br>N(bit31)：当两个补码表示的 有符号整数运算的时候，N&#x3D;1 表示运算对的结果为负数，N&#x3D;0表示结果为正数。<br>Z(bit30)：Z&#x3D;1 表示运算结果为零，Z&#x3D;0 表示运算结果不为零，对于 CMP 指令，Z&#x3D;1 表示进行比较的两个数大小相等。<br>C(bit29)：在加法指令中，当结果产生了进位，则 C&#x3D;1，表示无符号数运算发生上溢，其它情况下 C&#x3D;0。在减法指令中，当运算中发生借位，则 C&#x3D;0，表示无符号数运算发生下溢，其它情况下 C&#x3D;1。对于包含移位操作的非加&#x2F;减法运算指令，C 中包含最后一次溢出的位的数值，对于其它非加&#x2F;减运算指令，C 位的值通常不受影响。<br>V(bit28)：对于加&#x2F;减法运算指令，当操作数和运算结果表示为二进制的补码表示的带符号数时，V&#x3D;1 表示符号位溢出，通常其他位不影响 V 位。<br>Q(bit27)：仅 ARM v5TE_J 架构支持，表示饱和状态，Q&#x3D;1 表示累积饱和，Q&#x3D;0 表示累积不饱和。<br>IT<a href="bit26:25">1:0</a>：和 IT<a href="bit15:bit10">7:2</a>一起组成 IT[7:0]，作为 IF-THEN 指令执行状态。<br>J(bit24)：仅 ARM_v5TE-J 架构支持，J&#x3D;1 表示处于 <code>Jazelle</code> 状态，此位通常和 T(bit5)位一起表示当前所使用的指令集:</p>
<table>
<thead>
<tr>
<th>J</th>
<th>T</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>ARM</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>Thumb</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>ThumbEE</td>
</tr>
</tbody></table>
<p>GE<a href="bit19:16">3:0</a>：SIMD 指令有效，大于或等于。<br>IT<a href="bit15:10">7:2</a>：参考 IT[1:0]。<br>E(bit9)：大小端控制位，E&#x3D;1 表示大端模式，E&#x3D;0 表示小端模式。<br>A(bit8)：禁止异步中断位，A&#x3D;1 表示禁止异步中断。<br>I(bit7)：I&#x3D;1 禁止 IRQ，I&#x3D;0 使能 IRQ。<br>F(bit6)：F&#x3D;1 禁止 FIQ，F&#x3D;0 使能 FIQ。<br>T(bit5)：控制指令执行状态，表明本指令是 ARM 指令还是 Thumb 指令，通常和 J(bit24)一起表明指令类型，参考 J(bit24)位。<br>M[4:0]：处理器模式控制位<br><code>cpsr</code>最常用就是来控制处理器模式</p>
<table>
<thead>
<tr>
<th>M[4:0]</th>
<th>处理器模式</th>
</tr>
</thead>
<tbody><tr>
<td>10000</td>
<td>User 模式</td>
</tr>
<tr>
<td>10001</td>
<td>FIQ 模式</td>
</tr>
<tr>
<td>10010</td>
<td>IRQ 模式</td>
</tr>
<tr>
<td>10011</td>
<td>Supervisor(SVC)模式</td>
</tr>
<tr>
<td>10110</td>
<td>Monitor(MON)模式</td>
</tr>
<tr>
<td>10111</td>
<td>Abort(ABT)模式</td>
</tr>
<tr>
<td>11010</td>
<td>Hyp(HYP)模式</td>
</tr>
<tr>
<td>11011</td>
<td>Undef(UND)模式</td>
</tr>
<tr>
<td>11111</td>
<td>System(SYS)模式</td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 进入SVC模式 */</span></span><br><span class="line">mrs r0, cpsr</span><br><span class="line">bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">orr r0, r0, #<span class="number">0x13</span> 	<span class="comment">/* r0或上0x13,表示使用SVC模式					*/</span></span><br><span class="line">msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">ldr sp, =<span class="number">0X80200000</span>	<span class="comment">/* 设置SVC模式下的栈首地址为0X80200000,大小为2MB */</span></span><br></pre></td></tr></table></figure>
<h3><span id="4-2-2-spsr">4.2.2 SPSR</span><a href="#4-2-2-spsr" class="header-anchor">#</a></h3><p>除了 User 和 Sys 这两个模式以外，其他 7 个模式每个都配备了一个专用的物理状态寄存器，叫做 SPSR(备份程序状态寄存器)，当特定的异常中断发生时，SPSR 寄存器用来保存当前程序状态寄存器(CPSR)的值，当异常退出以后可以用 SPSR 中保存的值来恢复 CPSR。User 和 Sys 这两个模式不是异常模式，所以并没有配备 SPSR，因此不能在 User 和Sys 模式下访问 SPSR。</p>
<h1><span id="5-cp15-xie-chu-li-qi">5 CP15协处理器</span><a href="#5-cp15-xie-chu-li-qi" class="header-anchor">#</a></h1><p>CP15 协处理器一般用于存储系统管理，但是在中断中也会使用到，比如进入reset复位异常向量时，需要利用协处理器命令进行<code>ICache DCache</code>的开关。CP15 协处理器一共有16 个 32 位寄存器（C0-C15），MRC和MCR用来访问CP15协处理器。</p>
<h2><span id="5-1-xie-chu-li-qi-zhi-ling">5.1 协处理器指令</span><a href="#5-1-xie-chu-li-qi-zhi-ling" class="header-anchor">#</a></h2><p><strong>MRC</strong>: 将 CP15 协处理器中的寄存器数据读到 ARM 寄存器中。<br><strong>MCR</strong>: 将 ARM 寄存器的数据写入到 CP15 协处理器寄存器中。<br>格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MCR&#123;cond&#125; p15, &lt;opc1&gt;, &lt;Rt&gt;, &lt;CRn&gt;, &lt;CRm&gt;, &lt;opc2&gt;</span><br></pre></td></tr></table></figure>

<p><code>cond:</code>指令执行的条件码，如果忽略的话就表示无条件执行。<br><code>opc1：</code>协处理器要执行的操作码。<br><code>Rt：</code>ARM 源寄存器，要写入到 CP15 寄存器的数据就保存在此寄存器中。<br><code>CRn：</code>CP15 协处理器的目标寄存器。<br><code>CRm：</code>协处理器中附加的目标寄存器或者源操作数寄存器，如果不需要附加信息就将CRm 设置为 C0，否则结果不可预测。<br><code>opc2：</code>可选的协处理器特定操作码，当不需要的时候要设置为 0</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 0, r0, c0, c0, 0 //将 CP15 中 C0 寄存器的值读取到 R0 寄存器</span><br></pre></td></tr></table></figure>

<h2><span id="5-2-c0-ji-cun-qi-midr">5.2 c0寄存器（MIDR）</span><a href="#5-2-c0-ji-cun-qi-midr" class="header-anchor">#</a></h2><p>使用 MRC 或者 MCR 指令访问<code>c0-c15</code>寄存器的时候，指令中的<code>CRn、opc1、CRm 和 opc2</code>通过不同的搭配，其得到的寄存器含义不同：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/10.png" alt="image"><br>当<code>CRn=c0，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时的 c0 就是 MIDR 寄存器，也就是主 ID 寄存器，这个也是 c0 的基本作用。来看下c0作为MDIR寄存器时的含义：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/11.png" alt="image"><br>bit31:24：厂商编号，0X41，ARM。<br>bit23:20：内核架构的主版本号，ARM 内核版本一般使用<code>rnpn</code>来表示，比如<code> r0p1</code>，其中 r0<br>后面的 0 就是内核架构主版本号。<br>bit19:16：架构代码，0XF，ARMv7 架构。<br>bit15:4：内核版本号，0XC07，<code>Cortex-A7 MPCore </code>内核。<br>bit3:0：内核架构的次版本号，<code>rnpn </code>中的 <code>pn</code>，比如<code>r0p1</code>中 <code>p1</code> 后面的 1 就是次版本号。</p>
<h2><span id="5-3-c1-ji-cun-qi-sctlr">5.3 c1寄存器（SCTLR）</span><a href="#5-3-c1-ji-cun-qi-sctlr" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/12.png" alt="image"><br><code>CRn=c1，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时的 c1 就是 SCTLR 寄存器，也就是系统控制寄存器，这个是 c1 的基本作用。<br><strong>SCTLR 寄存器主要是完成控制功能的，比如使能或者禁止 MMU、I&#x2F;D Cache 等。</strong>  SCTLR 寄存器展开如下：<br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/13.png" alt="image"></p>
<p>bit13：V , 中断向量表基地址选择位，为 0 的话中断向量表基地址为 <code>0X00000000</code>，软件可以使用<code>VBAR</code>来重映射此基地址，也就是中断向量表重定位。为 1 的话中断向量表基地址为<code>0XFFFF0000</code>，此基地址不能被重映射。<br>bit12：I，I Cache 使能位，为 0 的话关闭 I Cache，为 1 的话使能 I Cache。<br>bit11：Z，分支预测使能位，如果开启 MMU 的话，此位也会使能。<br>bit10：SW，SWP 和 SWPB 使能位，当为 0 的话关闭 SWP 和 SWPB 指令，当为 1 的时候就使能 SWP 和 SWPB 指令。<br>bit9:3：未使用，保留。<br>bit2：C，D Cache 和缓存一致性使能位，为 0 的时候禁止 D Cache 和缓存一致性，为 1 时使能。<br>bit1：A，内存对齐检查使能位，为 0 的时候关闭内存对齐检查，为 1 的时候使能内存对齐检查。<br>bit0：M，MMU 使能位，为 0 的时候禁止 MMU，为 1 的时候使能 MMU。<br>举个读写SCTLR的例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 0, &lt;Rt&gt;, c1, c0, 0 ;读取 SCTLR 寄存器，数据保存到 Rt 中。</span><br><span class="line"></span><br><span class="line">MCR p15, 0, &lt;Rt&gt;, c1, c0, 0 ;将 Rt 中的数据写到 SCTLR(c1)寄存器中。</span><br></pre></td></tr></table></figure>

<p>再来一个关闭MMU,ICache,DCache的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 读取CP15的C1寄存器到R0中       		        	*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>)     <span class="comment">/* 清除C1寄存器的bit12位(I位)，关闭I Cache            	*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt;  <span class="number">2</span>)     <span class="comment">/* 清除C1寄存器的bit2(C位)，关闭D Cache    				*/</span></span><br><span class="line">bic     r0,  r0, #<span class="number">0x2</span>             <span class="comment">/* 清除C1寄存器的bit1(A位)，关闭对齐						*/</span></span><br><span class="line">bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">11</span>)     <span class="comment">/* 清除C1寄存器的bit11(Z位)，关闭分支预测					*/</span></span><br><span class="line">bic     r0,  r0, #<span class="number">0x1</span>             <span class="comment">/* 清除C1寄存器的bit0(M位)，关闭MMU				       	*/</span></span><br><span class="line">mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 将r0寄存器中的值写入到CP15的C1寄存器中	 				*/</span></span><br></pre></td></tr></table></figure>
<h2><span id="5-4-c12-ji-cun-qi-vbar">5.4 c12寄存器（VBAR）</span><a href="#5-4-c12-ji-cun-qi-vbar" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/14.png" alt="image"><br><code>CRn=c12，opc1=0，CRm=c0，opc2=0 </code>的时候就表示此时 c12 为 <code>VBAR </code>寄存器，也就是<strong>中断向量表基地址寄存器</strong>。</p>
<p>比如代码链接到DDR的某个位置作为起始地址，起始地址为<code>0X87800000</code>，而中断向量表肯定要放到最前面，也就是 <code>0X87800000</code> 这个地址处。所以就需要设置 <code>VBAR</code> 为 <code>0X87800000</code>，设置命令如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dsb</span><br><span class="line">isb</span><br><span class="line">ldr r0, =0x87800000 ; r0=0x87800000</span><br><span class="line">MCR p15, 0, r0, c12, c0, 0 ;将 r0 里面的数据写入到 c12 中，即 c12=0X87800000</span><br><span class="line">dsb</span><br><span class="line">isb</span><br></pre></td></tr></table></figure>
<h2><span id="5-5-c15-ji-cun-qi-cbar">5.5 c15寄存器（CBAR）</span><a href="#5-5-c15-ji-cun-qi-cbar" class="header-anchor">#</a></h2><p><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/15.png" alt="image"><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/16.png" alt="image"></p>
<p>CBAR寄存器中保存了<code>GIC（Generic Interrupt Controller）</code>的基地址。<code>GIC</code>基地址偏移<code>0x1000</code>是<code>分发器 block</code>, 偏移<code>0x2000</code>是CPU <code>接口端 block</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MRC p15, 4, r1, c15, c0, 0 ; 获取 GIC 基础地址，基地址保存在 r1 中</span><br></pre></td></tr></table></figure>
<h1><span id="6-arm-guan-fang-can-kao-lian-jie">6 arm官方参考链接</span><a href="#6-arm-guan-fang-can-kao-lian-jie" class="header-anchor">#</a></h1><h2><span id="6-1-armv7-yu-armv8-jia-gou">6.1 armv7与armv8架构</span><a href="#6-1-armv7-yu-armv8-jia-gou" class="header-anchor">#</a></h2><p>armv7都是32位处理器，典型的有<code>CorTex-A</code> A7 A8 A9 A15 A17。armv8采用64位处理器，典型的比如手机处理器，有Cortex A53 A76 A77都是64位架构。</p>
<h2><span id="6-2-armv7-can-kao-shou-ce">6.2 armv7参考手册</span><a href="#6-2-armv7-can-kao-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0406/cd?lang=en">https://developer.arm.com/documentation/ddi0406/cd?lang=en</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/17.png" alt="image"></p>
<h2><span id="6-3-armv7-bian-cheng-shou-ce">6.3 armv7 编程手册</span><a href="#6-3-armv7-bian-cheng-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/den0013/d/?lang=en">https://developer.arm.com/documentation/den0013/d/?lang=en</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/18.png" alt="image"></p>
<h2><span id="6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce">6.4 Cortex-A7 <code>MPCore</code> 技术参考手册</span><a href="#6-4-cortex-a7-mpcore-ji-zhu-can-kao-shou-ce" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://developer.arm.com/documentation/ddi0464/latest/">https://developer.arm.com/documentation/ddi0464/latest/</a><br><img src="/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/19.png" alt="image"></p>
<h1><span id="7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li">7 附件1：armv7裸机启动汇编示例：</span><a href="#7-fu-jian-1-armv7-luo-ji-qi-dong-hui-bian-shi-li" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">.global _start  				<span class="comment">/* 全局标号 */</span></span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">	ldr pc, =Reset_Handler		<span class="comment">/* 复位中断 					*/</span>	</span><br><span class="line">	ldr pc, =Undefined_Handler	<span class="comment">/* 未定义中断 					*/</span></span><br><span class="line">	ldr pc, =SVC_Handler		<span class="comment">/* SVC(Supervisor)中断 		*/</span></span><br><span class="line">	ldr pc, =PrefAbort_Handler	<span class="comment">/* 预取终止中断 					*/</span></span><br><span class="line">	ldr pc, =DataAbort_Handler	<span class="comment">/* 数据终止中断 					*/</span></span><br><span class="line">	ldr	pc, =NotUsed_Handler	<span class="comment">/* 未使用中断					*/</span></span><br><span class="line">	ldr pc, =IRQ_Handler		<span class="comment">/* IRQ中断 					*/</span></span><br><span class="line">	ldr pc, =FIQ_Handler		<span class="comment">/* FIQ(快速中断)未定义中断 			*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 复位中断 */</span>	</span><br><span class="line">Reset_Handler:</span><br><span class="line"></span><br><span class="line">	cpsid i						<span class="comment">/* 关闭全局中断 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 关闭I,DCache和MMU </span></span><br><span class="line"><span class="comment">	 * 采取读-改-写的方式。</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	mrc     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 读取CP15的C1寄存器到R0中       		        	*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">12</span>)     <span class="comment">/* 清除C1寄存器的bit12位(I位)，关闭I Cache            	*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt;  <span class="number">2</span>)     <span class="comment">/* 清除C1寄存器的bit2(C位)，关闭D Cache    				*/</span></span><br><span class="line">    bic     r0,  r0, #<span class="number">0x2</span>             <span class="comment">/* 清除C1寄存器的bit1(A位)，关闭对齐						*/</span></span><br><span class="line">    bic     r0,  r0, #(<span class="number">0x1</span> &lt;&lt; <span class="number">11</span>)     <span class="comment">/* 清除C1寄存器的bit11(Z位)，关闭分支预测					*/</span></span><br><span class="line">    bic     r0,  r0, #<span class="number">0x1</span>             <span class="comment">/* 清除C1寄存器的bit0(M位)，关闭MMU				       	*/</span></span><br><span class="line">    mcr     p15, <span class="number">0</span>, r0, c1, c0, <span class="number">0</span>     <span class="comment">/* 将r0寄存器中的值写入到CP15的C1寄存器中	 				*/</span></span><br><span class="line">	</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 汇编版本设置中断向量表偏移 */</span></span><br><span class="line">	ldr r0, =<span class="number">0X87800000</span></span><br><span class="line"></span><br><span class="line">	dsb</span><br><span class="line">	isb</span><br><span class="line">	mcr p15, <span class="number">0</span>, r0, c12, c0, <span class="number">0</span></span><br><span class="line">	dsb</span><br><span class="line">	isb</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">/* 设置各个模式下的栈指针，</span></span><br><span class="line"><span class="comment">	 * 注意：IMX6UL的堆栈是向下增长的！</span></span><br><span class="line"><span class="comment">	 * 堆栈指针地址一定要是4字节地址对齐的！！！</span></span><br><span class="line"><span class="comment">	 * DDR范围:0X80000000~0X9FFFFFFF</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="comment">/* 进入IRQ模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x12</span> 	<span class="comment">/* r0或上0x13,表示使用IRQ模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0x80600000</span>	<span class="comment">/* 设置IRQ模式下的栈首地址为0X80600000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 进入SYS模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* r0或上0x13,表示使用SYS模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0x80400000</span>	<span class="comment">/* 设置SYS模式下的栈首地址为0X80400000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 进入SVC模式 */</span></span><br><span class="line">	mrs r0, cpsr</span><br><span class="line">	bic r0, r0, #<span class="number">0x1f</span> 	<span class="comment">/* 将r0寄存器中的低5位清零，也就是cpsr的M0~M4 	*/</span></span><br><span class="line">	orr r0, r0, #<span class="number">0x13</span> 	<span class="comment">/* r0或上0x13,表示使用SVC模式					*/</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0 的数据写入到cpsr_c中 					*/</span></span><br><span class="line">	ldr sp, =<span class="number">0X80200000</span>	<span class="comment">/* 设置SVC模式下的栈首地址为0X80200000,大小为2MB */</span></span><br><span class="line"></span><br><span class="line">	cpsie i				<span class="comment">/* 打开全局中断 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">	<span class="comment">/* 使能IRQ中断 */</span></span><br><span class="line">	mrs r0, cpsr		<span class="comment">/* 读取cpsr寄存器值到r0中 			*/</span></span><br><span class="line">	bic r0, r0, #<span class="number">0x80</span>	<span class="comment">/* 将r0寄存器中bit7清零，也就是CPSR中的I位清零，表示允许IRQ中断 */</span></span><br><span class="line">	msr cpsr, r0		<span class="comment">/* 将r0重新写入到cpsr中 			*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	b main				<span class="comment">/* 跳转到main函数 			 	*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 未定义中断 */</span></span><br><span class="line">Undefined_Handler:</span><br><span class="line">	ldr r0, =Undefined_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SVC中断 */</span></span><br><span class="line">SVC_Handler:</span><br><span class="line">	ldr r0, =SVC_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 预取终止中断 */</span></span><br><span class="line">PrefAbort_Handler:</span><br><span class="line">	ldr r0, =PrefAbort_Handler	</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 数据终止中断 */</span></span><br><span class="line">DataAbort_Handler:</span><br><span class="line">	ldr r0, =DataAbort_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 未使用的中断 */</span></span><br><span class="line">NotUsed_Handler:</span><br><span class="line"></span><br><span class="line">	ldr r0, =NotUsed_Handler</span><br><span class="line">	bx r0</span><br><span class="line"></span><br><span class="line">IRQ_Handler:</span><br><span class="line">	push &#123;lr&#125;					<span class="comment">/* 保存lr地址 */</span></span><br><span class="line">	push &#123;r0-r3, r12&#125;			<span class="comment">/* 保存r0-r3，r12寄存器 */</span></span><br><span class="line"></span><br><span class="line">	mrs r0, spsr				<span class="comment">/* 读取spsr寄存器 */</span></span><br><span class="line">	push &#123;r0&#125;					<span class="comment">/* 保存spsr寄存器 */</span></span><br><span class="line"></span><br><span class="line">	mrc p15, <span class="number">4</span>, r1, c15, c0, <span class="number">0</span> <span class="comment">/* 从CP15的C0寄存器内的值到R1寄存器中</span></span><br><span class="line"><span class="comment">								* 参考文档ARM Cortex-A(armV7)编程手册V4.0.pdf P49</span></span><br><span class="line"><span class="comment">								* Cortex-A7 Technical ReferenceManua.pdf P68 P138</span></span><br><span class="line"><span class="comment">								*/</span>							</span><br><span class="line">	add r1, r1, #<span class="number">0X2000</span>			<span class="comment">/* GIC基地址加0X2000，也就是GIC的CPU接口端基地址 */</span></span><br><span class="line">	ldr r0, [r1, #<span class="number">0XC</span>]			<span class="comment">/* GIC的CPU接口端基地址加0X0C就是GICC_IAR寄存器，</span></span><br><span class="line"><span class="comment">								 * GICC_IAR寄存器保存这当前发生中断的中断号，我们要根据</span></span><br><span class="line"><span class="comment">								 * 这个中断号来绝对调用哪个中断服务函数</span></span><br><span class="line"><span class="comment">								 */</span></span><br><span class="line">	push &#123;r0, r1&#125;				<span class="comment">/* 保存r0,r1 */</span></span><br><span class="line">	</span><br><span class="line">	cps #<span class="number">0x13</span>					<span class="comment">/* 进入SVC模式，允许其他中断再次进去 */</span></span><br><span class="line">	</span><br><span class="line">	push &#123;lr&#125;					<span class="comment">/* 保存SVC模式的lr寄存器 */</span></span><br><span class="line">	ldr r2, =system_irqhandler	<span class="comment">/* 加载C语言中断处理函数到r2寄存器中*/</span></span><br><span class="line">	blx r2						<span class="comment">/* 运行C语言中断处理函数，带有一个参数，保存在R0寄存器中 */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;lr&#125;					<span class="comment">/* 执行完C语言中断服务函数，lr出栈 */</span></span><br><span class="line">	cps #<span class="number">0x12</span>					<span class="comment">/* 进入IRQ模式 */</span></span><br><span class="line">	pop &#123;r0, r1&#125;				</span><br><span class="line">	str r0, [r1, #<span class="number">0X10</span>]			<span class="comment">/* 中断执行完成，写EOIR */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;r0&#125;						</span><br><span class="line">	msr spsr_cxsf, r0			<span class="comment">/* 恢复spsr */</span></span><br><span class="line"></span><br><span class="line">	pop &#123;r0-r3, r12&#125;			<span class="comment">/* r0-r3,r12出栈 */</span></span><br><span class="line">	pop &#123;lr&#125;					<span class="comment">/* lr出栈 */</span></span><br><span class="line">	subs pc, lr, #<span class="number">4</span>				<span class="comment">/* 将lr-4赋给pc */</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">/* FIQ中断 */</span></span><br><span class="line">FIQ_Handler:</span><br><span class="line"></span><br><span class="line">	ldr r0, =FIQ_Handler	</span><br><span class="line">	bx r0</span><br></pre></td></tr></table></figure>
<h1><span id="8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi">8 附件2：GIC指令和寄存器定义（内联汇编方式）</span><a href="#8-fu-jian-2-gic-zhi-ling-he-ji-cun-qi-ding-yi-nei-lian-hui-bian-fang-shi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __CORTEX_CA7_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __CORTEX_CA7_H</span></span><br><span class="line"><span class="comment">/***************************************************************</span></span><br><span class="line"><span class="comment">文件名	: 	 core_ca7.h</span></span><br><span class="line"><span class="comment">描述	   : Cortex-A7内核通用文件。</span></span><br><span class="line"><span class="comment">其他	   : 本文件主要实现了对GIC操作函数</span></span><br><span class="line"><span class="comment">论坛 	   : www.wtmembed.com</span></span><br><span class="line"><span class="comment">***************************************************************/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORCEDINLINE  __attribute__((always_inline))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ASM            __asm                         	<span class="comment">/* GNU C语言内嵌汇编关键字 */</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __INLINE         inline                      	<span class="comment">/* GNU内联关键字 */</span>             </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STATIC_INLINE  static inline					</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __IM     volatile const      <span class="comment">/* 只读 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __OM     volatile            <span class="comment">/* 只写 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>     __IOM    volatile            <span class="comment">/* 读写 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __STRINGIFY(x) #x</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* C语言实现MCR指令 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MCR(coproc, opcode_1, src, CRn, CRm, opcode_2)                          \</span></span><br><span class="line"><span class="meta">    __ASM volatile (<span class="string">&quot;MCR &quot;</span> __STRINGIFY(p##coproc) <span class="string">&quot;, &quot;</span> __STRINGIFY(opcode_1) <span class="string">&quot;, &quot;</span> \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;%0, &quot;</span> __STRINGIFY(c##CRn) <span class="string">&quot;, &quot;</span> __STRINGIFY(c##CRm) <span class="string">&quot;, &quot;</span>      \</span></span><br><span class="line"><span class="meta">                    __STRINGIFY(opcode_2)                                         \</span></span><br><span class="line"><span class="meta">                    : : <span class="string">&quot;r&quot;</span> (src) )</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* C语言实现MRC指令 */</span>                    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __MRC(coproc, opcode_1, CRn, CRm, opcode_2)                               \</span></span><br><span class="line"><span class="meta">  (&#123;                                                                              \</span></span><br><span class="line"><span class="meta">    uint32_t __dst;                                                               \</span></span><br><span class="line"><span class="meta">    __ASM volatile (<span class="string">&quot;MRC &quot;</span> __STRINGIFY(p##coproc) <span class="string">&quot;, &quot;</span> __STRINGIFY(opcode_1) <span class="string">&quot;, &quot;</span> \</span></span><br><span class="line"><span class="meta">                    <span class="string">&quot;%0, &quot;</span> __STRINGIFY(c##CRn) <span class="string">&quot;, &quot;</span> __STRINGIFY(c##CRm) <span class="string">&quot;, &quot;</span>      \</span></span><br><span class="line"><span class="meta">                    __STRINGIFY(opcode_2)                                         \</span></span><br><span class="line"><span class="meta">                    : <span class="string">&quot;=r&quot;</span> (__dst) );                                             \</span></span><br><span class="line"><span class="meta">    __dst;                                                                        \</span></span><br><span class="line"><span class="meta">  &#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 其他一些C语言内嵌汇编 */</span>  </span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_APSR(<span class="type">uint32_t</span> apsr)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MSR apsr, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (apsr) : <span class="string">&quot;cc&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">uint32_t</span> __get_CPSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> result;</span><br><span class="line"></span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MRS %0, cpsr&quot;</span> : <span class="string">&quot;=r&quot;</span> (result) )</span>;</span><br><span class="line">  <span class="keyword">return</span>(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_CPSR(<span class="type">uint32_t</span> cpsr)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;MSR cpsr, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (cpsr) : <span class="string">&quot;cc&quot;</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">uint32_t</span> __get_FPEXC(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> result;</span><br><span class="line"></span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;VMRS %0, fpexc&quot;</span> : <span class="string">&quot;=r&quot;</span> (result) )</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__( ( always_inline ) ) __STATIC_INLINE <span class="type">void</span> __set_FPEXC(<span class="type">uint32_t</span> fpexc)</span><br><span class="line">&#123;</span><br><span class="line">  __ASM <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;VMSR fpexc, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (fpexc))</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *        		一些内核寄存器定义和抽象</span></span><br><span class="line"><span class="comment">  定义如下几个内核寄存器:</span></span><br><span class="line"><span class="comment">  - CPSR</span></span><br><span class="line"><span class="comment">  - CP15</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CPSR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：ARM Cortex-A(armV7)编程手册V4.0.pdf P46</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> M:<span class="number">5</span>;                        <span class="comment">/*!&lt; bit:  0.. 4  Mode field */</span></span><br><span class="line">    <span class="type">uint32_t</span> T:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      5  Thumb execution state bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> F:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      6  FIQ mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      7  IRQ mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      8  Asynchronous abort mask bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> E:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:      9  Endianness execution state bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> IT1:<span class="number">6</span>;                      <span class="comment">/*!&lt; bit: 10..15  If-Then execution state bits 2-7 */</span></span><br><span class="line">    <span class="type">uint32_t</span> GE:<span class="number">4</span>;                       <span class="comment">/*!&lt; bit: 16..19  Greater than or Equal flags */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">4</span>;               <span class="comment">/*!&lt; bit: 20..23  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> J:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     24  Jazelle bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> IT0:<span class="number">2</span>;                      <span class="comment">/*!&lt; bit: 25..26  If-Then execution state bits 0-1 */</span></span><br><span class="line">    <span class="type">uint32_t</span> Q:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     27  Saturation condition flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> V:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     28  Overflow condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> C:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     29  Carry condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> Z:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     30  Zero condition code flag */</span></span><br><span class="line">    <span class="type">uint32_t</span> N:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     31  Negative condition code flag */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; CPSR_Type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的SCTLR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P105</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> M:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     0  MMU enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     1  Alignment check enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> C:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     2  Cache enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 3.. 4  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> CP15BEN:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:     5  CP15 barrier enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:     6  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> B:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     7  Endianness model */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved2:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 8.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> SW:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    10  SWP and SWPB enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> Z:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    11  Branch prediction enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    12  Instruction cache enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> V:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    13  Vectors bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> RR:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    14  Round Robin select */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved3:<span class="number">2</span>;               <span class="comment">/*!&lt; bit:15..16  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> HA:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    17  Hardware Access flag enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved4:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    18  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> WXN:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    19  Write permission implies XN */</span></span><br><span class="line">    <span class="type">uint32_t</span> UWXN:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    20  Unprivileged write permission implies PL1 XN */</span></span><br><span class="line">    <span class="type">uint32_t</span> FI:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    21  Fast interrupts configuration enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> U:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:    22  Alignment model */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved5:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    23  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> VE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    24  Interrupt Vectors Enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> EE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    25  Exception Endianness */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved6:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    26  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> NMFI:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    27  Non-maskable FIQ (NMFI) support */</span></span><br><span class="line">    <span class="type">uint32_t</span> TRE:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    28  TEX remap enable. */</span></span><br><span class="line">    <span class="type">uint32_t</span> AFE:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    29  Access flag enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> TE:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    30  Thumb Exception enable */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved7:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; SCTLR_Type;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15 寄存器SCTLR各个位定义 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TE_Pos                     30U                                    <span class="comment">/*!&lt; SCTLR: TE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TE_Msk                     (1UL &lt;&lt; SCTLR_TE_Pos)                  <span class="comment">/*!&lt; SCTLR: TE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_AFE_Pos                    29U                                    <span class="comment">/*!&lt; SCTLR: AFE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_AFE_Msk                    (1UL &lt;&lt; SCTLR_AFE_Pos)                 <span class="comment">/*!&lt; SCTLR: AFE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TRE_Pos                    28U                                    <span class="comment">/*!&lt; SCTLR: TRE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_TRE_Msk                    (1UL &lt;&lt; SCTLR_TRE_Pos)                 <span class="comment">/*!&lt; SCTLR: TRE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_NMFI_Pos                   27U                                    <span class="comment">/*!&lt; SCTLR: NMFI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_NMFI_Msk                   (1UL &lt;&lt; SCTLR_NMFI_Pos)                <span class="comment">/*!&lt; SCTLR: NMFI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_EE_Pos                     25U                                    <span class="comment">/*!&lt; SCTLR: EE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_EE_Msk                     (1UL &lt;&lt; SCTLR_EE_Pos)                  <span class="comment">/*!&lt; SCTLR: EE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_VE_Pos                     24U                                    <span class="comment">/*!&lt; SCTLR: VE Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_VE_Msk                     (1UL &lt;&lt; SCTLR_VE_Pos)                  <span class="comment">/*!&lt; SCTLR: VE Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_U_Pos                      22U                                    <span class="comment">/*!&lt; SCTLR: U Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_U_Msk                      (1UL &lt;&lt; SCTLR_U_Pos)                   <span class="comment">/*!&lt; SCTLR: U Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_FI_Pos                     21U                                    <span class="comment">/*!&lt; SCTLR: FI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_FI_Msk                     (1UL &lt;&lt; SCTLR_FI_Pos)                  <span class="comment">/*!&lt; SCTLR: FI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_UWXN_Pos                   20U                                    <span class="comment">/*!&lt; SCTLR: UWXN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_UWXN_Msk                   (1UL &lt;&lt; SCTLR_UWXN_Pos)                <span class="comment">/*!&lt; SCTLR: UWXN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_WXN_Pos                    19U                                    <span class="comment">/*!&lt; SCTLR: WXN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_WXN_Msk                    (1UL &lt;&lt; SCTLR_WXN_Pos)                 <span class="comment">/*!&lt; SCTLR: WXN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_HA_Pos                     17U                                    <span class="comment">/*!&lt; SCTLR: HA Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_HA_Msk                     (1UL &lt;&lt; SCTLR_HA_Pos)                  <span class="comment">/*!&lt; SCTLR: HA Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_RR_Pos                     14U                                    <span class="comment">/*!&lt; SCTLR: RR Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_RR_Msk                     (1UL &lt;&lt; SCTLR_RR_Pos)                  <span class="comment">/*!&lt; SCTLR: RR Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_V_Pos                      13U                                    <span class="comment">/*!&lt; SCTLR: V Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_V_Msk                      (1UL &lt;&lt; SCTLR_V_Pos)                   <span class="comment">/*!&lt; SCTLR: V Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_I_Pos                      12U                                    <span class="comment">/*!&lt; SCTLR: I Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_I_Msk                      (1UL &lt;&lt; SCTLR_I_Pos)                   <span class="comment">/*!&lt; SCTLR: I Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_Z_Pos                      11U                                    <span class="comment">/*!&lt; SCTLR: Z Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_Z_Msk                      (1UL &lt;&lt; SCTLR_Z_Pos)                   <span class="comment">/*!&lt; SCTLR: Z Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_SW_Pos                     10U                                    <span class="comment">/*!&lt; SCTLR: SW Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_SW_Msk                     (1UL &lt;&lt; SCTLR_SW_Pos)                  <span class="comment">/*!&lt; SCTLR: SW Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_B_Pos                      7U                                     <span class="comment">/*!&lt; SCTLR: B Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_B_Msk                      (1UL &lt;&lt; SCTLR_B_Pos)                   <span class="comment">/*!&lt; SCTLR: B Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_CP15BEN_Pos                5U                                     <span class="comment">/*!&lt; SCTLR: CP15BEN Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_CP15BEN_Msk                (1UL &lt;&lt; SCTLR_CP15BEN_Pos)             <span class="comment">/*!&lt; SCTLR: CP15BEN Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_C_Pos                      2U                                     <span class="comment">/*!&lt; SCTLR: C Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_C_Msk                      (1UL &lt;&lt; SCTLR_C_Pos)                   <span class="comment">/*!&lt; SCTLR: C Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_A_Pos                      1U                                     <span class="comment">/*!&lt; SCTLR: A Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_A_Msk                      (1UL &lt;&lt; SCTLR_A_Pos)                   <span class="comment">/*!&lt; SCTLR: A Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_M_Pos                      0U                                     <span class="comment">/*!&lt; SCTLR: M Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCTLR_M_Msk                      (1UL &lt;&lt; SCTLR_M_Pos)                   <span class="comment">/*!&lt; SCTLR: M Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的ACTLR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料:Cortex-A7 Technical ReferenceManua.pdf P113</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 0.. 5  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> SMP:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:     6  Enables coherent requests to the processor */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">3</span>;               <span class="comment">/*!&lt; bit: 7.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> DODMBS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    10  Disable optimized data memory barrier behavior */</span></span><br><span class="line">    <span class="type">uint32_t</span> L2RADIS:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:    11  L2 Data Cache read-allocate mode disable */</span></span><br><span class="line">    <span class="type">uint32_t</span> L1RADIS:<span class="number">1</span>;                  <span class="comment">/*!&lt; bit:    12  L1 Data Cache read-allocate mode disable */</span></span><br><span class="line">    <span class="type">uint32_t</span> L1PCTL:<span class="number">2</span>;                   <span class="comment">/*!&lt; bit:13..14  L1 Data prefetch control */</span></span><br><span class="line">    <span class="type">uint32_t</span> DDVM:<span class="number">1</span>;                     <span class="comment">/*!&lt; bit:    15  Disable Distributed Virtual Memory (DVM) transactions */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved3:<span class="number">12</span>;              <span class="comment">/*!&lt; bit:16..27  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> DDI:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    28  Disable dual issue */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved7:<span class="number">3</span>;               <span class="comment">/*!&lt; bit:29..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; ACTLR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDI_Pos                    28U                                     <span class="comment">/*!&lt; ACTLR: DDI Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDI_Msk                    (1UL &lt;&lt; ACTLR_DDI_Pos)                  <span class="comment">/*!&lt; ACTLR: DDI Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDVM_Pos                   15U                                     <span class="comment">/*!&lt; ACTLR: DDVM Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DDVM_Msk                   (1UL &lt;&lt; ACTLR_DDVM_Pos)                 <span class="comment">/*!&lt; ACTLR: DDVM Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1PCTL_Pos                 13U                                     <span class="comment">/*!&lt; ACTLR: L1PCTL Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1PCTL_Msk                 (3UL &lt;&lt; ACTLR_L1PCTL_Pos)               <span class="comment">/*!&lt; ACTLR: L1PCTL Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1RADIS_Pos                12U                                     <span class="comment">/*!&lt; ACTLR: L1RADIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L1RADIS_Msk                (1UL &lt;&lt; ACTLR_L1RADIS_Pos)              <span class="comment">/*!&lt; ACTLR: L1RADIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L2RADIS_Pos                11U                                     <span class="comment">/*!&lt; ACTLR: L2RADIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_L2RADIS_Msk                (1UL &lt;&lt; ACTLR_L2RADIS_Pos)              <span class="comment">/*!&lt; ACTLR: L2RADIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DODMBS_Pos                 10U                                     <span class="comment">/*!&lt; ACTLR: DODMBS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_DODMBS_Msk                 (1UL &lt;&lt; ACTLR_DODMBS_Pos)               <span class="comment">/*!&lt; ACTLR: DODMBS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_SMP_Pos                    6U                                      <span class="comment">/*!&lt; ACTLR: SMP Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ACTLR_SMP_Msk                    (1UL &lt;&lt; ACTLR_SMP_Pos)                  <span class="comment">/*!&lt; ACTLR: SMP Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的CPACR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P115</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">20</span>;              <span class="comment">/*!&lt; bit: 0..19  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> cp10:<span class="number">2</span>;                     <span class="comment">/*!&lt; bit:20..21  Access rights for coprocessor 10 */</span></span><br><span class="line">    <span class="type">uint32_t</span> cp11:<span class="number">2</span>;                     <span class="comment">/*!&lt; bit:22..23  Access rights for coprocessor 11 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">6</span>;               <span class="comment">/*!&lt; bit:24..29  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> D32DIS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    30  Disable use of registers D16-D31 of the VFP register file */</span></span><br><span class="line">    <span class="type">uint32_t</span> ASEDIS:<span class="number">1</span>;                   <span class="comment">/*!&lt; bit:    31  Disable Advanced SIMD Functionality */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; CPACR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_ASEDIS_Pos                 31U                                    <span class="comment">/*!&lt; CPACR: ASEDIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_ASEDIS_Msk                 (1UL &lt;&lt; CPACR_ASEDIS_Pos)              <span class="comment">/*!&lt; CPACR: ASEDIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_D32DIS_Pos                 30U                                    <span class="comment">/*!&lt; CPACR: D32DIS Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_D32DIS_Msk                 (1UL &lt;&lt; CPACR_D32DIS_Pos)              <span class="comment">/*!&lt; CPACR: D32DIS Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp11_Pos                   22U                                    <span class="comment">/*!&lt; CPACR: cp11 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp11_Msk                   (3UL &lt;&lt; CPACR_cp11_Pos)                <span class="comment">/*!&lt; CPACR: cp11 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp10_Pos                   20U                                    <span class="comment">/*!&lt; CPACR: cp10 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CPACR_cp10_Msk                   (3UL &lt;&lt; CPACR_cp10_Pos)                <span class="comment">/*!&lt; CPACR: cp10 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的DFSR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P128</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> FS0:<span class="number">4</span>;                      <span class="comment">/*!&lt; bit: 0.. 3  Fault Status bits bit 0-3 */</span></span><br><span class="line">    <span class="type">uint32_t</span> Domain:<span class="number">4</span>;                   <span class="comment">/*!&lt; bit: 4.. 7  Fault on which domain */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">2</span>;               <span class="comment">/*!&lt; bit: 8.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> FS1:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    10  Fault Status bits bit 4 */</span></span><br><span class="line">    <span class="type">uint32_t</span> WnR:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    11  Write not Read bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> ExT:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    12  External abort type */</span></span><br><span class="line">    <span class="type">uint32_t</span> CM:<span class="number">1</span>;                       <span class="comment">/*!&lt; bit:    13  Cache maintenance fault */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">18</span>;              <span class="comment">/*!&lt; bit:14..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; DFSR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_CM_Pos                      13U                                    <span class="comment">/*!&lt; DFSR: CM Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_CM_Msk                      (1UL &lt;&lt; DFSR_CM_Pos)                   <span class="comment">/*!&lt; DFSR: CM Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Ext_Pos                     12U                                    <span class="comment">/*!&lt; DFSR: Ext Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Ext_Msk                     (1UL &lt;&lt; DFSR_Ext_Pos)                  <span class="comment">/*!&lt; DFSR: Ext Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_WnR_Pos                     11U                                    <span class="comment">/*!&lt; DFSR: WnR Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_WnR_Msk                     (1UL &lt;&lt; DFSR_WnR_Pos)                  <span class="comment">/*!&lt; DFSR: WnR Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS1_Pos                     10U                                    <span class="comment">/*!&lt; DFSR: FS1 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS1_Msk                     (1UL &lt;&lt; DFSR_FS1_Pos)                  <span class="comment">/*!&lt; DFSR: FS1 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Domain_Pos                  4U                                     <span class="comment">/*!&lt; DFSR: Domain Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_Domain_Msk                  (0xFUL &lt;&lt; DFSR_Domain_Pos)             <span class="comment">/*!&lt; DFSR: Domain Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS0_Pos                     0U                                     <span class="comment">/*!&lt; DFSR: FS0 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DFSR_FS0_Msk                     (0xFUL &lt;&lt; DFSR_FS0_Pos)                <span class="comment">/*!&lt; DFSR: FS0 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的IFSR寄存器 </span></span><br><span class="line"><span class="comment"> * 参考资料：Cortex-A7 Technical ReferenceManua.pdf P131</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> FS0:<span class="number">4</span>;                      <span class="comment">/*!&lt; bit: 0.. 3  Fault Status bits bit 0-3 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 4.. 9  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> FS1:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    10  Fault Status bits bit 4 */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">1</span>;               <span class="comment">/*!&lt; bit:    11  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> ExT:<span class="number">1</span>;                      <span class="comment">/*!&lt; bit:    12  External abort type */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved2:<span class="number">19</span>;              <span class="comment">/*!&lt; bit:13..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; IFSR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_ExT_Pos                     12U                                    <span class="comment">/*!&lt; IFSR: ExT Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_ExT_Msk                     (1UL &lt;&lt; IFSR_ExT_Pos)                  <span class="comment">/*!&lt; IFSR: ExT Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS1_Pos                     10U                                    <span class="comment">/*!&lt; IFSR: FS1 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS1_Msk                     (1UL &lt;&lt; IFSR_FS1_Pos)                  <span class="comment">/*!&lt; IFSR: FS1 Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS0_Pos                     0U                                     <span class="comment">/*!&lt; IFSR: FS0 Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IFSR_FS0_Msk                     (0xFUL &lt;&lt; IFSR_FS0_Pos)                <span class="comment">/*!&lt; IFSR: FS0 Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* CP15的ISR寄存器</span></span><br><span class="line"><span class="comment"> * 参考资料：ARM ArchitectureReference Manual ARMv7-A and ARMv7-R edition.pdf P1640</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved0:<span class="number">6</span>;               <span class="comment">/*!&lt; bit: 0.. 5  Reserved */</span></span><br><span class="line">    <span class="type">uint32_t</span> F:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     6  FIQ pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> I:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     7  IRQ pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> A:<span class="number">1</span>;                        <span class="comment">/*!&lt; bit:     8  External abort pending bit */</span></span><br><span class="line">    <span class="type">uint32_t</span> _reserved1:<span class="number">23</span>;              <span class="comment">/*!&lt; bit:14..31  Reserved */</span></span><br><span class="line">  &#125; b;                                   <span class="comment">/*!&lt; Structure used for bit  access */</span></span><br><span class="line">  <span class="type">uint32_t</span> w;                            <span class="comment">/*!&lt; Type      used for word access */</span></span><br><span class="line">&#125; ISR_Type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_A_Pos                        13U                                    <span class="comment">/*!&lt; ISR: A Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_A_Msk                        (1UL &lt;&lt; ISR_A_Pos)                     <span class="comment">/*!&lt; ISR: A Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_I_Pos                        12U                                    <span class="comment">/*!&lt; ISR: I Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_I_Msk                        (1UL &lt;&lt; ISR_I_Pos)                     <span class="comment">/*!&lt; ISR: I Mask */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_F_Pos                        11U                                    <span class="comment">/*!&lt; ISR: F Position */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ISR_F_Msk                        (1UL &lt;&lt; ISR_F_Pos)                     <span class="comment">/*!&lt; ISR: F Mask */</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mask and shift a bit field value for use in a register bit range. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _VAL2FLD(field, value)    ((value &lt;&lt; field ## _Pos) &amp; field ## _Msk)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mask and shift a register value to extract a bit filed value. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _FLD2VAL(field, value)    ((value &amp; field ## _Msk) &gt;&gt; field ## _Pos)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *       			CP15 访问函数</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_SCTLR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_SCTLR(<span class="type">uint32_t</span> sctlr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, sctlr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_ACTLR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_ACTLR(<span class="type">uint32_t</span> actlr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, actlr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CPACR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_CPACR(<span class="type">uint32_t</span> cpacr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, cpacr, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBR0(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBR0(<span class="type">uint32_t</span> ttbr0)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbr0, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBR1(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBR1(<span class="type">uint32_t</span> ttbr1)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbr1, <span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_TTBCR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_TTBCR(<span class="type">uint32_t</span> ttbcr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ttbcr, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DACR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DACR(<span class="type">uint32_t</span> dacr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dacr, <span class="number">3</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DFSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DFSR(<span class="type">uint32_t</span> dfsr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dfsr, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_IFSR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_IFSR(<span class="type">uint32_t</span> ifsr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ifsr, <span class="number">5</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_DFAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_DFAR(<span class="type">uint32_t</span> dfar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, dfar, <span class="number">6</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_IFAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_IFAR(<span class="type">uint32_t</span> ifar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, ifar, <span class="number">6</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_VBAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_VBAR(<span class="type">uint32_t</span> vbar)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, vbar, <span class="number">12</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_ISR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_ISR(<span class="type">uint32_t</span> isr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, isr, <span class="number">12</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CONTEXTIDR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> __set_CONTEXTIDR(<span class="type">uint32_t</span> contextidr)</span><br><span class="line">&#123;</span><br><span class="line">  __MCR(<span class="number">15</span>, <span class="number">0</span>, contextidr, <span class="number">13</span>, <span class="number">0</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> __get_CBAR(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> __MRC(<span class="number">15</span>, <span class="number">4</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> *                 GIC相关内容</span></span><br><span class="line"><span class="comment"> *有关GIC的内容，参考：ARM Generic Interrupt Controller(ARM GIC控制器)V2.0.pdf</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * GIC寄存器描述结构体，</span></span><br><span class="line"><span class="comment"> * GIC分为分发器端和CPU接口端</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED0[<span class="number">1024</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_CTLR;                 <span class="comment">/*!&lt; Offset: 0x1000 (R/W) Distributor Control Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_TYPER;                <span class="comment">/*!&lt; Offset: 0x1004 (R/ )  Interrupt Controller Type Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_IIDR;                 <span class="comment">/*!&lt; Offset: 0x1008 (R/ )  Distributor Implementer Identification Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED1[<span class="number">29</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_IGROUPR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1080 - 0x0BC (R/W) Interrupt Group Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED2[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISENABLER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1100 - 0x13C (R/W) Interrupt Set-Enable Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED3[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICENABLER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1180 - 0x1BC (R/W) Interrupt Clear-Enable Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED4[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISPENDR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1200 - 0x23C (R/W) Interrupt Set-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED5[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICPENDR[<span class="number">16</span>];          <span class="comment">/*!&lt; Offset: 0x1280 - 0x2BC (R/W) Interrupt Clear-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED6[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ISACTIVER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1300 - 0x33C (R/W) Interrupt Set-Active Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED7[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICACTIVER[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1380 - 0x3BC (R/W) Interrupt Clear-Active Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED8[<span class="number">16</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_IPRIORITYR[<span class="number">512</span>];      <span class="comment">/*!&lt; Offset: 0x1400 - 0x5FC (R/W) Interrupt Priority Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED9[<span class="number">128</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_ITARGETSR[<span class="number">512</span>];       <span class="comment">/*!&lt; Offset: 0x1800 - 0x9FC (R/W) Interrupt Targets Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED10[<span class="number">128</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> D_ICFGR[<span class="number">32</span>];            <span class="comment">/*!&lt; Offset: 0x1C00 - 0xC7C (R/W) Interrupt configuration registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED11[<span class="number">32</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PPISR;                <span class="comment">/*!&lt; Offset: 0x1D00 (R/ ) Private Peripheral Interrupt Status Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_SPISR[<span class="number">15</span>];            <span class="comment">/*!&lt; Offset: 0x1D04 - 0xD3C (R/ ) Shared Peripheral Interrupt Status Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED12[<span class="number">112</span>];</span><br><span class="line">  __OM  <span class="type">uint32_t</span> D_SGIR;                 <span class="comment">/*!&lt; Offset: 0x1F00 ( /W) Software Generated Interrupt Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED13[<span class="number">3</span>];</span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_CPENDSGIR[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1F10 - 0xF1C (R/W) SGI Clear-Pending Registers */</span></span><br><span class="line">  __IOM <span class="type">uint8_t</span>  D_SPENDSGIR[<span class="number">16</span>];        <span class="comment">/*!&lt; Offset: 0x1F20 - 0xF2C (R/W) SGI Set-Pending Registers */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED14[<span class="number">40</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR4;                <span class="comment">/*!&lt; Offset: 0x1FD0 (R/ ) Peripheral ID4 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR5;                <span class="comment">/*!&lt; Offset: 0x1FD4 (R/ ) Peripheral ID5 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR6;                <span class="comment">/*!&lt; Offset: 0x1FD8 (R/ ) Peripheral ID6 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR7;                <span class="comment">/*!&lt; Offset: 0x1FDC (R/ ) Peripheral ID7 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR0;                <span class="comment">/*!&lt; Offset: 0x1FE0 (R/ ) Peripheral ID0 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR1;                <span class="comment">/*!&lt; Offset: 0x1FE4 (R/ ) Peripheral ID1 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR2;                <span class="comment">/*!&lt; Offset: 0x1FE8 (R/ ) Peripheral ID2 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_PIDR3;                <span class="comment">/*!&lt; Offset: 0x1FEC (R/ ) Peripheral ID3 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR0;                <span class="comment">/*!&lt; Offset: 0x1FF0 (R/ ) Component ID0 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR1;                <span class="comment">/*!&lt; Offset: 0x1FF4 (R/ ) Component ID1 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR2;                <span class="comment">/*!&lt; Offset: 0x1FF8 (R/ ) Component ID2 Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> D_CIDR3;                <span class="comment">/*!&lt; Offset: 0x1FFC (R/ ) Component ID3 Register */</span></span><br><span class="line"></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_CTLR;                 <span class="comment">/*!&lt; Offset: 0x2000 (R/W) CPU Interface Control Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_PMR;                  <span class="comment">/*!&lt; Offset: 0x2004 (R/W) Interrupt Priority Mask Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_BPR;                  <span class="comment">/*!&lt; Offset: 0x2008 (R/W) Binary Point Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_IAR;                  <span class="comment">/*!&lt; Offset: 0x200C (R/ ) Interrupt Acknowledge Register */</span></span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_EOIR;                 <span class="comment">/*!&lt; Offset: 0x2010 ( /W) End Of Interrupt Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_RPR;                  <span class="comment">/*!&lt; Offset: 0x2014 (R/ ) Running Priority Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_HPPIR;                <span class="comment">/*!&lt; Offset: 0x2018 (R/ ) Highest Priority Pending Interrupt Register */</span></span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_ABPR;                 <span class="comment">/*!&lt; Offset: 0x201C (R/W) Aliased Binary Point Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_AIAR;                 <span class="comment">/*!&lt; Offset: 0x2020 (R/ ) Aliased Interrupt Acknowledge Register */</span></span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_AEOIR;                <span class="comment">/*!&lt; Offset: 0x2024 ( /W) Aliased End Of Interrupt Register */</span></span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_AHPPIR;               <span class="comment">/*!&lt; Offset: 0x2028 (R/ ) Aliased Highest Priority Pending Interrupt Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED15[<span class="number">41</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_APR0;                 <span class="comment">/*!&lt; Offset: 0x20D0 (R/W) Active Priority Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED16[<span class="number">3</span>];</span><br><span class="line">  __IOM <span class="type">uint32_t</span> C_NSAPR0;               <span class="comment">/*!&lt; Offset: 0x20E0 (R/W) Non-secure Active Priority Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED17[<span class="number">6</span>];</span><br><span class="line">  __IM  <span class="type">uint32_t</span> C_IIDR;                 <span class="comment">/*!&lt; Offset: 0x20FC (R/ ) CPU Interface Identification Register */</span></span><br><span class="line">        <span class="type">uint32_t</span> RESERVED18[<span class="number">960</span>];</span><br><span class="line">  __OM  <span class="type">uint32_t</span> C_DIR;                  <span class="comment">/*!&lt; Offset: 0x3000 ( /W) Deactivate Interrupt Register */</span></span><br><span class="line">&#125; GIC_Type;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * GIC初始化</span></span><br><span class="line"><span class="comment"> * 为了简单使用GIC的group0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_Init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint32_t</span> i;</span><br><span class="line">  <span class="type">uint32_t</span> irqRegs;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line"></span><br><span class="line">  irqRegs = (gic-&gt;D_TYPER &amp; <span class="number">0x1F</span>UL) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* On POR, all SPI is in group 0, level-sensitive and using 1-N model */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Disable all PPI, SGI and SPI */</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; irqRegs; i++)</span><br><span class="line">    gic-&gt;D_ICENABLER[i] = <span class="number">0xFFFFFFFF</span>UL;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Make all interrupts have higher priority */</span></span><br><span class="line">  gic-&gt;C_PMR = (<span class="number">0xFF</span>UL &lt;&lt; (<span class="number">8</span> - __GIC_PRIO_BITS)) &amp; <span class="number">0xFF</span>UL;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* No subpriority, all priority level allows preemption */</span></span><br><span class="line">  gic-&gt;C_BPR = <span class="number">7</span> - __GIC_PRIO_BITS;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enable group0 distribution */</span></span><br><span class="line">  gic-&gt;D_CTLR = <span class="number">1UL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Enable group0 signaling */</span></span><br><span class="line">  gic-&gt;C_CTLR = <span class="number">1UL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 使能指定的中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_EnableIRQ</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_ISENABLER[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &gt;&gt; <span class="number">5</span>] = (<span class="type">uint32_t</span>)(<span class="number">1UL</span> &lt;&lt; (((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &amp; <span class="number">0x1F</span>UL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment"> * 关闭指定的中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_DisableIRQ</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_ICENABLER[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &gt;&gt; <span class="number">5</span>] = (<span class="type">uint32_t</span>)(<span class="number">1UL</span> &lt;&lt; (((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn) &amp; <span class="number">0x1F</span>UL));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 返回中断号 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_AcknowledgeIRQ</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	<span class="keyword">return</span> gic-&gt;C_IAR &amp; <span class="number">0x1FFF</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 向EOIR写入发送中断的中断号来释放中断</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_DeactivateIRQ</span><span class="params">(<span class="type">uint32_t</span> value)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;C_EOIR = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取运行优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetRunningPriority</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	<span class="keyword">return</span> gic-&gt;C_RPR &amp; <span class="number">0xFF</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 设置组优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_SetPriorityGrouping</span><span class="params">(<span class="type">uint32_t</span> PriorityGroup)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;C_BPR = PriorityGroup &amp; <span class="number">0x7</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取组优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetPriorityGrouping</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> gic-&gt;C_BPR &amp; <span class="number">0x7</span>UL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 设置优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">void</span> <span class="title function_">GIC_SetPriority</span><span class="params">(IRQn_Type IRQn, <span class="type">uint32_t</span> priority)</span></span><br><span class="line">&#123;</span><br><span class="line">  	GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  	gic-&gt;D_IPRIORITYR[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn)] = (<span class="type">uint8_t</span>)((priority &lt;&lt; (<span class="number">8UL</span> - __GIC_PRIO_BITS)) &amp; (<span class="type">uint32_t</span>)<span class="number">0xFF</span>UL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 获取优先级</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FORCEDINLINE __STATIC_INLINE <span class="type">uint32_t</span> <span class="title function_">GIC_GetPriority</span><span class="params">(IRQn_Type IRQn)</span></span><br><span class="line">&#123;</span><br><span class="line">  GIC_Type *gic = (GIC_Type *)(__get_CBAR() &amp; <span class="number">0xFFFF0000</span>UL);</span><br><span class="line">  <span class="keyword">return</span>(((<span class="type">uint32_t</span>)gic-&gt;D_IPRIORITYR[((<span class="type">uint32_t</span>)(<span class="type">int32_t</span>)IRQn)] &gt;&gt; (<span class="number">8UL</span> - __GIC_PRIO_BITS)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h2><span id="8-1-nei-lian-hui-bian-yuan-li">8.1 内联汇编原理</span><a href="#8-1-nei-lian-hui-bian-yuan-li" class="header-anchor">#</a></h2><p>先看一个错误的示例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov r1,r0&quot;</span>);</span><br><span class="line">    __asm__(<span class="string">&quot;mov r2,r1&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种操作可能产生负面的影响，因为 r0~r2 寄存器很可能正在被程序的其它部分使用而在这里被意外地修改。<br>这就需要使用到嵌入汇编的另一种表达形式：<br><code>asm(code : output operand list : input operand list : clobber list);</code><br>这种嵌入汇编的形式一共分为四个部分：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* code</span><br><span class="line">* [attr]output operand list</span><br><span class="line">* [attr]input operand list</span><br><span class="line">* clobber list</span><br></pre></td></tr></table></figure>

<p><code>code</code>：汇编的操作代码，一条或者多条指令，如果是多条指令，需要在指令间使用<code>\n\t</code>隔开。<br>    与通用的汇编代码有一些不同：因为支持 C 变量的操作，所以在操作由第二、三部分提供<br>    的操作数时，使用 %n 来替代操作数。<br><code>output operand list</code>：表示输出的操作数，通常是一个或者多个 C 函数中的变量。<br><code>input operand list</code>：表示输入的操作数，通常是一个或者多个 C 函数中的变量，<code>attr</code>部分表示操作数的属性，以字符串的形式提供，是必须的参数。<br><code>clobber list</code>：被破坏的列表，这部分我们放到后面讨论。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> val1 = <span class="number">111</span>,val2 = <span class="number">222</span>;</span><br><span class="line">        <span class="keyword">asm</span>(<span class="string">&quot;mov %0,%1&quot;</span></span><br><span class="line">        :<span class="string">&quot;+r&quot;</span>(val1)</span><br><span class="line">        :<span class="string">&quot;r&quot;</span>(val2)</span><br><span class="line">        :);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;val1 = %d\n&quot;</span>,val1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>func</code> 函数的输出结果为：<code>val1 = 222</code>.<br>分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">输出操作数为 val1，属性为 &quot;=r&quot;。</span><br><span class="line">输入操作数为 val2，属性为 &quot;r&quot;</span><br><span class="line">code 部分为 mov %1,%0, %0 表示输入输出列表中的第一个操作数，</span><br><span class="line">	%1 表示操作数列表中提供的第二个操作数，以此类推，这条汇编指</span><br><span class="line">	令很明显就是将第二个操作数(val2)赋值给第一个操作数(val1),所以最后的结果为 val1 = 222.</span><br><span class="line"></span><br><span class="line">code 中的操作数命名顺序为输出操作书列表递增，输入操作数列表递增，比如增加一个操作数的代码为：</span><br><span class="line">	int val1 = 111,val2 = 222,val3=333;</span><br><span class="line">	asm(&quot;mov %0,%2&quot; :&quot;+r&quot;(val1) :&quot;r&quot;(val2),&quot;r&quot;(val3) :);</span><br></pre></td></tr></table></figure>

<h3><span id="8-1-1-cao-zuo-shu-shu-xing">8.1.1 操作数属性</span><a href="#8-1-1-cao-zuo-shu-shu-xing" class="header-anchor">#</a></h3><p>在上述的示例中，输入操作数和输出操作数都会使用到 <code>attr </code>字段，即操作数的属性，下面是其属性对应的列表:</p>
<ul>
<li>“&#x3D;” 表示只写，通常用于所有输出操作数的属性</li>
<li>“+” 表示读写，只能被列为输出操作数的属性，否则编译会报错。</li>
</ul>
<h3><span id="8-1-2-clobber-list">8.1.2 clobber list</span><a href="#8-1-2-clobber-list" class="header-anchor">#</a></h3><p>clobber 的意思为破坏，在这里的意思是：这段汇编指令将会破坏哪些寄存器的值。</p>
<p>在目前的 gcc 设计中，编译分为4个过程：<code>预编译、编译、汇编、链接</code>。  其中，编译就是将 C 代码编译成汇编代码，而通用的汇编代码在这个过程是不会处理的，也就是说，<code>嵌入汇编代码</code>的解析只涉及到输入输出操作数的替换，对于不包含输入输出操作数的部分不会解析，所以在编译阶段，编译器不会知道嵌入汇编代码中静态地使用到哪些寄存器，而是自顾自地编译 C 代码，从而导致 C 代码和嵌入汇编代码操作到同一个寄存器，而出现错误。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov lr,#1&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>嵌入汇编代码过程</code>中，将<code>lr</code>的值修改为 1，当前函数返回的时候也就返回到 1 地址，不出意料: 程序出现段错误:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Segmentation fault (core dumped)</span><br></pre></td></tr></table></figure>

<p>解决办法是：将程序修改一下,用<code>clobber list</code>这种标准格式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov lr,#1&quot;</span>:::<span class="string">&quot;lr&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了进一步追求真相，我们来对比它们的反汇编代码:</p>
<p>不添加 clobber list 的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000083f</span>4 &lt;func3&gt;:</span><br><span class="line">    <span class="number">83f</span>4:       b480            push    &#123;r7&#125;</span><br><span class="line">    <span class="number">83f</span>6:       af00            add     r7, sp, #<span class="number">0</span></span><br><span class="line">    <span class="number">83f</span>8:       f04f <span class="number">0e01</span>       mov.w   lr, #<span class="number">1</span></span><br><span class="line">    <span class="number">83f</span>c:       <span class="number">46b</span>d            mov     sp, r7</span><br><span class="line">    <span class="number">83f</span>e:       f85d <span class="number">7b</span>04       ldr.w   r7, [sp], #<span class="number">4</span></span><br><span class="line">    <span class="number">8402</span>:       <span class="number">4770</span>            bx      lr</span><br></pre></td></tr></table></figure>

<p>添加 clobber list 的反汇编代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">func3</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="number">83f</span>4:       b580            push    &#123;r7, lr&#125;</span><br><span class="line">    <span class="number">83f</span>6:       af00            add     r7, sp, #<span class="number">0</span></span><br><span class="line">    <span class="number">83f</span>8:       f04f <span class="number">0e01</span>       mov.w   lr, #<span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="number">83f</span>c:       bd80            pop     &#123;r7, pc&#125;</span><br><span class="line">    <span class="number">83f</span>e:       bf00            nop</span><br></pre></td></tr></table></figure>

<p>对比可以看出，对于不将<code>&quot;lr&quot;</code>添加到 <code>clobber list </code>中的代码，返回指令为<code> bx lr</code>，因为<code>lr</code>被修改为 1，所以返回一定出错.<br>第二个代码则不一样，在函数调用之初，就将<code>lr</code>寄存器使用 push 指令保存到了栈上，在最后返回的时候再将栈上的原 <code>lr </code>数据 pop 到 pc 指针中，其中<code>lr</code>的修改没有任何影响。</p>
<p>通常情况下，<code>clobber list </code>对应着寄存器的修改，所以我们只需要将寄存器的名字作为参数添加到<code>clobber list</code>中，比如<code>&quot;r0&quot; &quot;lr&quot;</code>等，有<strong>两个特殊的参数需要关注</strong>，就是 **<code>&quot;cc&quot; 和 &quot;memory&quot;</code>**。  </p>
<p><code>&quot;cc&quot; </code>对应的并非是普通寄存器，而是 CPU 的<code>状态寄存器</code>，如果某些指令将状态寄存器修改了，需要在<code>clobber list</code>中添加<code>&quot;cc&quot;</code>来声明这个事情。</p>
<p><code>&quot;memory&quot; </code>对应内存操作，这从名称也可以看出，当<code>clobber list</code>中包含<code>&quot;memory&quot;</code>时，表示嵌入汇编代码会对内存进行一些操作，gcc 生成的代码会将特定的寄存器的值写回到内存中以保证内存中的值是最新的，这样做的原因是 gcc 经常会将内存数据缓存在寄存器中，如果不及时写回，嵌入汇编代码读到的内存就是原来的值。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/03/%E9%80%9A%E7%94%A8%E8%A3%B8%E6%9C%BA-arm%E6%B1%87%E7%BC%96/" data-id="clyylnk92006f7wuf4bhr2ucx" data-title="通用裸机-arm汇编" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 18.18px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 19.09px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 17.27px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 16.36px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 18.18px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 20px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 15.45px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 14.55px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 11.82px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 12.73px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 17.27px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 13.64px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/08/10/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-9-%E4%B8%AD%E6%96%AD%E5%AD%90%E7%B3%BB%E7%BB%9F-%E4%B8%AD%E6%96%AD%E4%B8%8B%E5%8D%8A%E9%83%A8-tasklet/">字符设备驱动-9-中断子系统-中断下半部-tasklet</a>
          </li>
        
          <li>
            <a href="/2024/08/10/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-9-%E4%B8%AD%E6%96%AD%E5%AD%90%E7%B3%BB%E7%BB%9F-%E4%B8%AD%E6%96%AD%E8%AE%BE%E5%A4%87%E6%A0%91%E8%A1%A8%E8%BF%B0%E4%B8%8E%E8%A7%A3%E6%9E%90/">字符设备驱动-9-中断子系统-中断设备树表述与解析</a>
          </li>
        
          <li>
            <a href="/2024/08/10/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-9-%E4%B8%AD%E6%96%AD%E5%AD%90%E7%B3%BB%E7%BB%9F-%E4%B8%AD%E6%96%AD%E7%BB%93%E6%9E%84%E4%BD%93/">字符设备驱动-9-中断子系统-中断结构体</a>
          </li>
        
          <li>
            <a href="/2024/08/07/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-9-%E4%B8%AD%E6%96%AD%E5%AD%90%E7%B3%BB%E7%BB%9F-GICv2%E6%9E%B6%E6%9E%84%E8%A7%A3%E6%9E%90/">字符设备驱动-9-中断子系统-GICv2架构解析</a>
          </li>
        
          <li>
            <a href="/2024/08/05/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-9-%E4%B8%AD%E6%96%AD%E5%AD%90%E7%B3%BB%E7%BB%9F-%E4%B8%AD%E6%96%AD%E5%BC%95%E5%85%A5/">字符设备驱动-9-中断子系统-中断引入</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>
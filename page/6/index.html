<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-uboot-命令和环境变量" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" class="article-date">
  <time class="dt-published" datetime="2024-06-22T11:13:19.000Z" itemprop="datePublished">2024-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/">uboot-命令和环境变量</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-1-help-huo-zhe">1.1 help或者？</a><ul>
<li><a href="#1-1-1-help-ju-ti-ming-ling">1.1.1 help+具体命令</a></li>
</ul>
</li>
<li><a href="#1-2-xin-xi-cha-xun">1.2 信息查询</a><ul>
<li><a href="#1-2-1-bdinfo">1.2.1 bdinfo</a></li>
<li><a href="#1-2-2-printenv">1.2.2 printenv</a></li>
<li><a href="#1-2-3-version">1.2.3 version</a></li>
</ul>
</li>
<li><a href="#1-3-huan-jing-bian-liang">1.3 环境变量</a><ul>
<li><a href="#1-3-1-setenv-she-ding-huan-jing-bian-liang">1.3.1 setenv设定环境变量</a></li>
<li><a href="#1-3-2-saveenv-bao-cun-huan-jing-bian-liang">1.3.2 saveenv保存环境变量</a></li>
<li><a href="#1-3-3-setenv-shan-chu-huan-jing-bian-liang">1.3.3 setenv删除环境变量</a></li>
<li><a href="#1-3-4-huan-jing-bian-liang-yuan-li">1.3.4 环境变量原理</a><ul>
<li><a href="#1-3-4-1-bootcmd-zhan-kai">1.3.4.1 bootcmd展开</a></li>
<li><a href="#1-3-4-2-bootargs-zhan-kai">1.3.4.2 bootargs展开</a></li>
<li><a href="#1-3-4-3-bootdlelay">1.3.4.3 bootdlelay</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-4-nei-cun-cao-zuo">1.4 内存操作</a><ul>
<li><a href="#1-4-1-md">1.4.1 md</a></li>
<li><a href="#1-4-2-nm-ming-ling">1.4.2 nm命令</a></li>
<li><a href="#1-4-3-mm-ming-ling">1.4.3 mm命令</a></li>
<li><a href="#1-4-4-mw-ming-ling">1.4.4 mw命令</a></li>
<li><a href="#1-4-5-cp-ming-ling">1.4.5 cp命令</a></li>
<li><a href="#1-4-6-cmp-ming-ling">1.4.6 cmp命令</a></li>
</ul>
</li>
<li><a href="#1-5-wang-luo-cao-zuo-ming-ling">1.5 网络操作命令</a><ul>
<li><a href="#1-5-1-ping-ming-ling">1.5.1 ping命令</a></li>
<li><a href="#1-5-2-dhcp-ming-ling-zi-dong-ip-huo-qu">1.5.2 dhcp命令（自动ip获取）</a></li>
<li><a href="#1-5-3-nfs-ming-ling">1.5.3 nfs命令</a></li>
<li><a href="#1-5-4-tftp-ming-ling">1.5.4 tftp命令</a></li>
</ul>
</li>
<li><a href="#1-6-emmc-he-sd-qia-zhi-ling">1.6 emmc和sd卡指令</a><ul>
<li><a href="#1-6-1-mmc-info">1.6.1 mmc info</a></li>
<li><a href="#1-6-2-mmc-rescan">1.6.2 mmc rescan</a></li>
<li><a href="#1-6-3-mmc-list">1.6.3 mmc list</a></li>
<li><a href="#1-6-4-mmc-dev">1.6.4 mmc dev</a></li>
<li><a href="#1-6-5-mmc-part">1.6.5 mmc part</a></li>
<li><a href="#1-6-6-mmc-read">1.6.6 mmc read</a></li>
<li><a href="#1-6-7-mmc-write">1.6.7 mmc write</a></li>
<li><a href="#1-6-7-mmc-erase">1.6.7 mmc erase</a></li>
</ul>
</li>
<li><a href="#1-7-wen-jian-cao-zuo-ming-ling-fat-wen-jian-xi-tong">1.7 文件操作命令（fat文件系统）</a><ul>
<li><a href="#1-7-1-fatinfo">1.7.1 fatinfo</a></li>
<li><a href="#1-7-1-fatls">1.7.1 fatls</a></li>
<li><a href="#1-7-3-fstype">1.7.3 fstype</a></li>
<li><a href="#1-7-4-fatload">1.7.4 fatload</a></li>
<li><a href="#1-7-5-fatwrite">1.7.5 fatwrite</a></li>
</ul>
</li>
<li><a href="#1-8-wen-jian-cao-zuo-ming-ling-ext-wen-jian-xi-tong">1.8 文件操作命令（ext文件系统）</a></li>
<li><a href="#1-9-nandflash-cao-zuo-ming-ling">1.9 nandflash操作命令</a><ul>
<li><a href="#1-9-1-nand-info">1.9.1 nand info</a></li>
<li><a href="#1-9-2-nand-device">1.9.2 nand device</a></li>
<li><a href="#1-9-3-nand-erase">1.9.3 nand erase</a></li>
<li><a href="#1-9-3-nand-write">1.9.3 nand write</a></li>
<li><a href="#1-9-4-nand-read">1.9.4 nand read</a></li>
</ul>
</li>
<li><a href="#1-10-she-bei-shu-xiang-guan">1.10 设备树相关</a><ul>
<li><a href="#1-10-1-fdt-addr">1.10.1 fdt addr</a></li>
<li><a href="#1-10-2-fdt-header">1.10.2 fdt header</a></li>
<li><a href="#1-10-3-fdt-print">1.10.3 fdt print</a></li>
</ul>
</li>
<li><a href="#1-11-qi-dong-xiang-guan">1.11 启动相关</a><ul>
<li><a href="#1-11-1-bootz-qi-dong-zimage">1.11.1 bootz (启动zImage)</a></li>
<li><a href="#1-11-1-bootm-qi-dong-uimage">1.11.1 bootm (启动uImage)</a></li>
<li><a href="#1-11-3-boot">1.11.3 boot</a></li>
<li><a href="#1-11-4-go-ming-ling">1.11.4 go命令</a></li>
<li><a href="#1-11-5-run">1.11.5 run</a></li>
</ul>
</li>
<li><a href="#1-12-nei-cun-ce-shi-mtest">1.12 内存测试mtest</a></li>
</ul>
<!-- tocstop -->

</div>

<h2><span id="1-1-help-huo-zhe">1.1 help或者？</span><a href="#1-1-help-huo-zhe" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/1.png" alt="image"></p>
<h3><span id="1-1-1-help-ju-ti-ming-ling">1.1.1 help+具体命令</span><a href="#1-1-1-help-ju-ti-ming-ling" class="header-anchor">#</a></h3><p><code>? bootz 或 help bootz</code><br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/2.png" alt="image"></p>
<h2><span id="1-2-xin-xi-cha-xun">1.2 信息查询</span><a href="#1-2-xin-xi-cha-xun" class="header-anchor">#</a></h2><h3><span id="1-2-1-bdinfo">1.2.1 bdinfo</span><a href="#1-2-1-bdinfo" class="header-anchor">#</a></h3><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/3.png" alt="image"></p>
<h3><span id="1-2-2-printenv">1.2.2 printenv</span><a href="#1-2-2-printenv" class="header-anchor">#</a></h3><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/4.png" alt="image"><br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/5.png" alt="image"><br>前确保 uboot 中的环境变量 bootargs 内容如下:<br><code>console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/arm/boot/zImage /home/zuozhongkai/linux/tftpboot/ -f</span><br><span class="line"><span class="built_in">cp</span> <span class="built_in">arch</span>/arm/boot/dts/imx6ull-14x14-evk.dtb /home/zuozhongkai/linux/tftpboot/ -f</span><br><span class="line">tftp 80800000 zImage </span><br><span class="line">tftp 83000000 imx6ull-14x14-evk.dtb</span><br><span class="line">bootz 80800000 - 83000000</span><br></pre></td></tr></table></figure>
<h3><span id="1-2-3-version">1.2.3 version</span><a href="#1-2-3-version" class="header-anchor">#</a></h3><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/6.png" alt="image"></p>
<h2><span id="1-3-huan-jing-bian-liang">1.3 环境变量</span><a href="#1-3-huan-jing-bian-liang" class="header-anchor">#</a></h2><h3><span id="1-3-1-setenv-she-ding-huan-jing-bian-liang">1.3.1 setenv设定环境变量</span><a href="#1-3-1-setenv-she-ding-huan-jing-bian-liang" class="header-anchor">#</a></h3><p>设置<code>bootdelay</code>时间为5s.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv bootdelay 5</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/7.png" alt="image"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv author zuozhongkai</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure>
<p>新建环境变量也是用setenv。</p>
<h3><span id="1-3-2-saveenv-bao-cun-huan-jing-bian-liang">1.3.2 saveenv保存环境变量</span><a href="#1-3-2-saveenv-bao-cun-huan-jing-bian-liang" class="header-anchor">#</a></h3><h3><span id="1-3-3-setenv-shan-chu-huan-jing-bian-liang">1.3.3 setenv删除环境变量</span><a href="#1-3-3-setenv-shan-chu-huan-jing-bian-liang" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setenv author</span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure>
<p>设置变量为空表示删除掉该环境变量，重启该环境变量就不会存在了。</p>
<h3><span id="1-3-4-huan-jing-bian-liang-yuan-li">1.3.4 环境变量原理</span><a href="#1-3-4-huan-jing-bian-liang-yuan-li" class="header-anchor">#</a></h3><p><code>include/env_default.h</code>定义了很多环境变量，如<code>bootargs,bootdelay,bootcmd等</code>：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/8.png" alt="image"><br>由 于 没 有 定 义<code>DEFAULT_ENV_INSTANCE_EMBEDDED和CONFIG_SYS_REDUNDAND_ENVIRONMENT</code>，因此 <code>uchar default_environment[]</code>数组保存环境变量。</p>
<h4><span id="1-3-4-1-bootcmd-zhan-kai">1.3.4.1 bootcmd展开</span><a href="#1-3-4-1-bootcmd-zhan-kai" class="header-anchor">#</a></h4><p>如<code>CONFIG_BOOTCOMMAND</code>等一系列宏都是定义在<code>include/configs/mx6ull_alientek_emmc.h</code>:<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/9.png" alt="image"><br> uboot 使用了类似 shell 脚本语言的方式来编写的,首先<code>run findfdt</code>， findfdt 是用来查找开发板对应的设备树文件(.dtb)，IMX6ULL EVK 的设备树文件为<code>imx6ull-14x14-evk.dtb，findfdt</code>内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;findfdt=&quot;</span>\</span><br><span class="line"><span class="string">&quot;if test $fdt_file = undefined; then &quot;</span> \</span><br><span class="line"><span class="string">&quot;if test $board_name = EVK &amp;&amp; test $board_rev = 9X9; then &quot;</span> \</span><br><span class="line"><span class="string">&quot;setenv fdt_file imx6ull-9x9-evk.dtb; fi; &quot;</span> \</span><br><span class="line"><span class="string">&quot;if test $board_name = EVK &amp;&amp; test $board_rev = 14X14; then &quot;</span> \</span><br><span class="line"><span class="string">&quot;setenv fdt_file imx6ull-14x14-evk.dtb; fi; &quot;</span> \</span><br><span class="line"><span class="string">&quot;if test $fdt_file = undefined; then &quot;</span> \</span><br><span class="line"><span class="string">&quot;echo WARNING: Could not determine dtb to use; fi; &quot;</span> \</span><br><span class="line"><span class="string">&quot;fi;\0&quot;</span> \</span><br></pre></td></tr></table></figure>

<p>那么<code>run findfdt</code>就等同于执行<code>setenv fdt_file imx6ull-14x14-evk.dtb</code>。设置fdt_file环境变量等于imx6ull-14x14-evk.dtb。<br><code>mmc dev $&#123;mmcdev&#125;</code>用于切换 mmc 设备，mmcdev 为 1，因此这行代码就是：mmc dev 1，也就是切换到 EMMC 上。<br>先执行<code> mmc dev $&#123;mmcdev&#125;</code>切换到 EMMC 上，然后使用命令<code> mmc rescan</code> 扫描看有没有 SD 卡或者 EMMC 存在，如果没有的话就直接跳到else，执行<code> run netboot</code>，netboot也是一个自定义的环境变量，这个变量是从网络启动 Linux 的。<br>扫描到EMMC后，<code>run loadbootscript</code>：<br>    <code>loadbootscript=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;script&#125;;</code><br>其中 mmcdev&#x3D;1，mmcpart&#x3D;1，loadaddr&#x3D;0x80800000，script&#x3D; boot.scr，因此展开以后就是：<br>    <code>loadbootscript=fatload mmc 1:1 0x80800000 boot.scr;</code><br>loadbootscript 就是从 mmc1 的分区 1 中读取文件 boot.src 到 DRAM 的 0X80800000 处。但是 mmc1 的分区 1 中没有 boot.src 这个文件，可以使用命令<code>ls mmc 1:1</code>查看一下 mmc1 分区1 中的所有文件，看看有没有 boot.src 这个文件。再展开bootscript：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootscript=<span class="built_in">echo</span> Running bootscript from mmc ...;</span><br><span class="line"><span class="built_in">source</span></span><br></pre></td></tr></table></figure>
<p>由于boot.src 文件不存在，所以 bootscript 也就不会运行。就运行环境变量 loadimage:<br><code>loadimage=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;loadaddr&#125; $&#123;image&#125;</code><br>loadimage展开：<br><code>loadimage=fatload mmc 1:1 0x80800000 zImage</code><br>fatload就是从 mmc1 的分区中读取 zImage 到内存的 0X80800000 处，而 mmc1的分区 1 中存在 zImage。<br>loadimage执行完，执行mmcboot环境变量，run mmcboot：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/10.png" alt="image"><br>①打印Booting from mmc …<br>②运行环境变量 mmcargs，mmcargs 用来设置 bootargs，后面分析 bootargs 的时候在学习。<br>③判断boot_fdt是否为yes或者try，根据uboot输出的环境变量信息可知boot_fdt&#x3D;try。因此执行loadfdt。<br>④执行loadfdt环境变量,如下：<br><code>loadfdt=fatload mmc $&#123;mmcdev&#125;:$&#123;mmcpart&#125; $&#123;fdt_addr&#125; $&#123;fdt_file&#125;</code><br>展开以后就是:<br><code>loadfdt=fatload mmc 1:1 0x83000000 imx6ull-14x14-evk.dtb</code><br>因此 loadfdt 的作用就是从 mmc1 的分区 1 中读取 imx6ull-14x14-evk.dtb 文件并放到 0x83000000处。<br>⑤loadfdt加载dtb成功后，调用命令 bootz 启动 linux：<br>    <code>bootz $&#123;loadaddr&#125; - $&#123;fdt_addr&#125;;</code><br>展开：<br>    <code>bootz 0x80800000 - 0x83000000 (注意‘-’前后要有空格)</code></p>
<p>总结一下bootcmd展开：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span> <span class="comment">//切换到 EMMC</span></span><br><span class="line">fatload mmc <span class="number">1</span>:<span class="number">1</span> <span class="number">0x80800000</span> zImage <span class="comment">//读取 zImage 到 0x80800000 处</span></span><br><span class="line">fatload mmc <span class="number">1</span>:<span class="number">1</span> <span class="number">0x83000000</span> imx6ull<span class="number">-14</span>x14-evk.dtb <span class="comment">//读取设备树到 0x83000000 处</span></span><br><span class="line">bootz <span class="number">0x80800000</span> - <span class="number">0x83000000</span> <span class="comment">//启动 Linux</span></span><br></pre></td></tr></table></figure>

<p>我们可以将bootcmd环境变量进行简化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define CONFIG_BOOTCOMMAND \</span></span><br><span class="line"> <span class="string">&quot;mmc dev 1;&quot;</span> \</span><br><span class="line"> <span class="string">&quot;fatload mmc 1:1 0x80800000 zImage;&quot;</span> \</span><br><span class="line"> <span class="string">&quot;fatload mmc 1:1 0x83000000 imx6ull-alientek-emmc.dtb;&quot;</span> \</span><br><span class="line"> <span class="string">&quot;bootz 0x80800000 - 0x83000000;&quot;</span></span><br></pre></td></tr></table></figure>
<p>或者：<br><code>setenv bootcmd &#39;mmc dev 1; fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000 imx6ullalientek-emmc.dtb; bootz 80800000 - 83000000;&#39;</code></p>
<h4><span id="1-3-4-2-bootargs-zhan-kai">1.3.4.2 bootargs展开</span><a href="#1-3-4-2-bootargs-zhan-kai" class="header-anchor">#</a></h4><p>bootargs 保存着 uboot 传递给 Linux 内核的参数。从emmc启动时，bootargs 环境变量是由 mmcargs 设置的：<br><code>mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</code><br>其中：<br><code>console=ttymxc0，baudrate=115200，mmcroot=/dev/mmcblk1p2 rootwait rw</code><br>mmcargs展开以后就是:<br><code>mmcargs=setenv bootargs console= ttymxc0, 115200 root= /dev/mmcblk1p2 rootwait rw</code></p>
<p>可以看出环境变量 mmcargs 就是设置 bootargs 的值为<code>console= ttymxc0, 115200 root= /dev/mmcblk1p2 rootwait rw</code>。<br>①<code>console=ttymxc0,115200 </code>综合起来就是设置 ttymxc0（也就是串口 1）作为 Linux 的终端，并且串口波特率设置为 115200。<br>②<code>root=/dev/mmcblk1p2 </code>用于指明根文件系统存放在mmcblk1 设备的分区 2 中。在 I.MX6U-ALPHA 开发板中&#x2F;dev&#x2F;mmcblk1 表示 EMMC，而&#x2F;dev&#x2F;mmcblk1p2 表示EMMC 的分区 2。<br>③root 后面有<code>rootwait rw</code>，rootwait 表示等待 mmc 设备初始化完成以后再挂载，否则的话mmc 设备还没初始化完成就挂载根文件系统会出错的。rw 表示根文件系统是可以读写的，不加rw 的话可能无法在根文件系统中进行写操作，只能进行读操作。</p>
<h4><span id="1-3-4-3-bootdlelay">1.3.4.3 bootdlelay</span><a href="#1-3-4-3-bootdlelay" class="header-anchor">#</a></h4><p>uboot命令行倒计时</p>
<h2><span id="1-4-nei-cun-cao-zuo">1.4 内存操作</span><a href="#1-4-nei-cun-cao-zuo" class="header-anchor">#</a></h2><h3><span id="1-4-1-md">1.4.1 md</span><a href="#1-4-1-md" class="header-anchor">#</a></h3><pre><code>md[.b, .w, .l] address [# of objects]
</code></pre>
<p>注意：uboot 命令中的数字都是十六进制的</p>
<ol>
<li>命令中的<code>[.b .w .l]对应 byte、word 和 long</code>，也就是分别以 1 个字节、2 个字节、4 个字节来显示内存值.</li>
<li>address 就是要查看的内存起始地址.</li>
<li><code>[# of objects]</code>表示要查看的数据长度:</li>
</ol>
<p>这个数据长度单位不是字节，而是跟你所选择的显示格式有关。比如你设置要查看的内存长度为20(十六进制为 0x14)，如果显示格式为.b 的话那就表示 20 个字节；如果显示格式为.w 的话就表示 20 个 word，也就是<code> 20*2=40 个字节</code>；如果显示格式为.l 的话就表示 20 个 long，也就是<code>20*4=80 </code>个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">md.b <span class="number">80000000</span> <span class="number">10</span> <span class="comment">//读16字节</span></span><br><span class="line">md.w <span class="number">80000000</span> <span class="number">10</span> <span class="comment">//读32字节</span></span><br><span class="line">md.l <span class="number">80000000</span> <span class="number">10</span> <span class="comment">//读64字节</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/11.png" alt="image"></p>
<h3><span id="1-4-2-nm-ming-ling">1.4.2 nm命令</span><a href="#1-4-2-nm-ming-ling" class="header-anchor">#</a></h3><p>写内存，写成功后地址不会自增。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm [.b, .w, .l] address</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/12.png" alt="image"><br>0500e031 表示地址 0x80000000 现在的数据，<code>？</code>后面就可以输入要修改后的数据 0x12345678，输入完成以后按下回车，然后再输入‘q’即可退出。<br>退出后输入md.l查看。<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/13.png" alt="image"></p>
<h3><span id="1-4-3-mm-ming-ling">1.4.3 mm命令</span><a href="#1-4-3-mm-ming-ling" class="header-anchor">#</a></h3><p>写内存，写成功后地址会自增。<br>比如以.l 格式修改从地址 0x80000000 开始的连续 3 个内存块<code>(3*4=12个字节)</code>的数据为 0X05050505.<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/14.png" alt="image"><br>输入md命令查看一下：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/15.png" alt="image"></p>
<h3><span id="1-4-4-mw-ming-ling">1.4.4 mw命令</span><a href="#1-4-4-mw-ming-ling" class="header-anchor">#</a></h3><p>写一段连续的内存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw [.b, .w, .l] address value [count]</span><br></pre></td></tr></table></figure>

<p>比如使用.l 格式将以 0X80000000 为起始地址的 0x10 个内存块<code>(0x10 * 4=64 字节)</code>填充为 0X0A0A0A0A</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mw.l 80000000 0A0A0A0A 10</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/16.png" alt="image"></p>
<h3><span id="1-4-5-cp-ming-ling">1.4.5 cp命令</span><a href="#1-4-5-cp-ming-ling" class="header-anchor">#</a></h3><p>数据拷贝命令，用于将 DRAM 中的数据从一段内存拷贝到另一段内存中，或者把 Nor Flash 中的数据拷贝到 DRAM 中。</p>
<pre><code>cp [.b, .w, .l] source target count
</code></pre>
<p>我们使用.l 格式将 0x80000000 处的地址拷贝到 0X80000100 处，长度为 0x10 个内存块<code>(0x10 * 4=64 个字节).</code></p>
<pre><code>cp.l 80000000 80000100 10
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/17.png" alt="image"></p>
<h3><span id="1-4-6-cmp-ming-ling">1.4.6 cmp命令</span><a href="#1-4-6-cmp-ming-ling" class="header-anchor">#</a></h3><p>比较两段内存的数据是否相等。</p>
<pre><code>cmp [.b, .w, .l] addr1 addr2 count
</code></pre>
<p>比较 0x80000000 和 0X80000100 这两个地址数据是否相等，比较长度为 0x10 个内存块<code>(16 * 4=64 个字节)</code></p>
<pre><code>cmp.l 80000000 80000100 10
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/18.png" alt="image"><br>我们再随便挑两段内存比较一下，比如地址0x80002000 和 0x800003000，长度为 0X10.<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/19.png" alt="image"><br>可以看出，0x80002000 处的数据和 0x80003000 处的数据就不一样.</p>
<h2><span id="1-5-wang-luo-cao-zuo-ming-ling">1.5 网络操作命令</span><a href="#1-5-wang-luo-cao-zuo-ming-ling" class="header-anchor">#</a></h2><table>
<thead>
<tr>
<th>环境变量</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>ipaddr</td>
<td>开发板 ip 地址，可以不设置，使用 dhcp 命令来从路由器获取 IP 地址</td>
</tr>
<tr>
<td>ethaddr</td>
<td>开发板的 MAC 地址，一定要设置</td>
</tr>
<tr>
<td>gatewayip</td>
<td>网关地址</td>
</tr>
<tr>
<td>netmask</td>
<td>子网掩码</td>
</tr>
<tr>
<td>serverip</td>
<td>服务器 IP 地址，也就是 Ubuntu 主机 IP 地址，用于调试代码</td>
</tr>
</tbody></table>
<p>预先设置号网络相关环境变量：</p>
<pre><code>setenv ipaddr 192.168.1.50
setenv ethaddr b8:ae:1d:01:00:00
setenv gatewayip 192.168.1.1
setenv netmask 255.255.255.0
setenv serverip 192.168.1.253
saveenv
</code></pre>
<h3><span id="1-5-1-ping-ming-ling">1.5.1 ping命令</span><a href="#1-5-1-ping-ming-ling" class="header-anchor">#</a></h3><pre><code>ping 192.168.1.100
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/20.png" alt="image"></p>
<h3><span id="1-5-2-dhcp-ming-ling-zi-dong-ip-huo-qu">1.5.2 dhcp命令（自动ip获取）</span><a href="#1-5-2-dhcp-ming-ling-zi-dong-ip-huo-qu" class="header-anchor">#</a></h3><p>dhcp 用于从路由器获取 IP 地址，前提得开发板连接到路由器上的，如果开发板是和电脑<br>直连的，那么 dhcp 命令就会失效。直接输入 dhcp 命令即可通过路由器获取到 IP 地址。</p>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/21.png" alt="image"><br>DHCP 不单单是获取 IP 地址，其还会通过 TFTP 来启动 linux 内核，输入<code>? dhcp</code>即<br>可查看 dhcp 命令详细的信息：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/22.png" alt="image"></p>
<h3><span id="1-5-3-nfs-ming-ling">1.5.3 nfs命令</span><a href="#1-5-3-nfs-ming-ling" class="header-anchor">#</a></h3><p>nfs(Network File System)网络文件系统,通过网络将编译好的 linux 镜像和设备树文件下载<br>到 DRAM 中，然后就可以直接运行。<br>虚拟机Ubuntu先搭建好nfs服务，详见：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/16694496.html" title="nfs服务搭建">nfs服务搭建</a> <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/03/26/linux%E6%90%AD%E5%BB%BAnfs%E6%9C%8D%E5%8A%A1/">linux搭建nfs服务 | Hexo (fuzidage.github.io)</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs [loadAddress] [[hostIPaddr:]bootfilename]</span><br></pre></td></tr></table></figure>

<p>loadAddress 是要保存的 DRAM 地址，<code>[[hostIPaddr:]bootfilename]</code>是要下载的文件地址,<br>我们将正点原子官方编译出来的 Linux 镜像文件 zImage 下载到开发板 DRAM 的 0x80800000这个地址处。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nfs 80800000 192.168.1.253:/home/zuozhongkai/linux/nfs/zImage</span><br></pre></td></tr></table></figure>
<p>下载过程如图下：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/23.png" alt="image"></p>
<p>下载完成以后查看 0x80800000 地址处的数据，使用命令 md.b 来查看前 0x100 个字节的数据。<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/24.png" alt="image"><br>我们再用UE打开编译出的zImage，对比一下说明 nfs 命令下载到的zImage 是正确的。<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/25.png" alt="image"></p>
<h3><span id="1-5-4-tftp-ming-ling">1.5.4 tftp命令</span><a href="#1-5-4-tftp-ming-ling" class="header-anchor">#</a></h3><p>tftp 命令的作用和 nfs 命令一样，都是用于通过网络下载东西到 DRAM 中。tftp服务搭建参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/11997775.html" title="tftp服务搭建">tftp服务搭建</a> <a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/03/24/linux%E6%90%AD%E5%BB%BAtftp%E5%92%8Cftp%E6%9C%8D%E5%8A%A1/">linux搭建tftp和ftp服务 | Hexo (fuzidage.github.io)</a></p>
<pre><code>tftpboot [loadAddress] [[hostIPaddr:]bootfilename]
</code></pre>
<p> loadAddress 是文 件在 DRAM 中的 存放 地址 ，<br><code>[[hostIPaddr:]bootfilename]</code>是要从 Ubuntu 中下载的文件。但是和 nfs 命令的区别在于，tftp 命令不需要输入文件在 Ubuntu 中的完整路径，只需要输入文件名即可。比如我们现在将 tftpboot 文件夹里面的 zImage 文件下载到开发板 DRAM 的 0X80800000 地址处。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tftp 80800000 zImage</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/26.png" alt="image"></p>
<h2><span id="1-6-emmc-he-sd-qia-zhi-ling">1.6 emmc和sd卡指令</span><a href="#1-6-emmc-he-sd-qia-zhi-ling" class="header-anchor">#</a></h2><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/27.png" alt="image"></p>
<p>mmc相关命令：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>mmc info</td>
<td>输出 MMC 设备信息</td>
</tr>
<tr>
<td>mmc read</td>
<td>读取 MMC 中的数据</td>
</tr>
<tr>
<td>mmc wirte</td>
<td>向 MMC 设备写入数据</td>
</tr>
<tr>
<td>mmc rescan</td>
<td>扫描 MMC 设备</td>
</tr>
<tr>
<td>mmc part</td>
<td>列出 MMC 设备的分区</td>
</tr>
<tr>
<td>mmc dev</td>
<td>切换 MMC 设备</td>
</tr>
<tr>
<td>mmc list</td>
<td>列出当前有效的所有 MMC 设备</td>
</tr>
<tr>
<td>mmc hwpartition</td>
<td>设置 MMC 设备的分区</td>
</tr>
<tr>
<td>mmc bootbus……</td>
<td>设置指定 MMC 设备的 BOOT_BUS_WIDTH 域的值</td>
</tr>
<tr>
<td>mmc bootpart……</td>
<td>设置指定 MMC 设备的 boot 和 RPMB 分区的大小</td>
</tr>
<tr>
<td>mmc partconf……</td>
<td>设置指定 MMC 设备的 PARTITION_CONFG 域的值</td>
</tr>
<tr>
<td>mmc rst</td>
<td>复位 MMC 设备</td>
</tr>
<tr>
<td>mmc setdsr</td>
<td>设置 DSR 寄存器的值</td>
</tr>
</tbody></table>
<h3><span id="1-6-1-mmc-info">1.6.1 mmc info</span><a href="#1-6-1-mmc-info" class="header-anchor">#</a></h3><p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/28.png" alt="image"></p>
<p>当前选中的 MMC 设备是EMMC，版本为 5.0，容量为 7.1GiB(EMMC为 8GB)，速度为 52000000Hz&#x3D;52MHz，8 位宽的总线。还有一个与 mmc info 命令相同功能的命令：mmcinfo，“mmc”和“info”之间没有空格。</p>
<h3><span id="1-6-2-mmc-rescan">1.6.2 mmc rescan</span><a href="#1-6-2-mmc-rescan" class="header-anchor">#</a></h3><p>mmc rescan 命令用于扫描当前开发板上所有的 MMC 设备，包括 EMMC 和 SD 卡。</p>
<h3><span id="1-6-3-mmc-list">1.6.3 mmc list</span><a href="#1-6-3-mmc-list" class="header-anchor">#</a></h3><p>查看当前开发板一共有几个 MMC 设备.<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/29.png" alt="image"></p>
<p>可以看出当前开发板有两个 MMC 设备：<code>FSL_SDHC:0 和 FSL_SDHC:1 (eMMC)</code>，这是因为我现在用的是 EMMC 版本的核心板，加上 SD 卡一共有两个 MMC 设备，<code>FSL_SDHC:0 是 SD卡，FSL_SDHC:1(eMMC)是 EMMC</code>。默认会将 EMMC 设置为当前 MMC 设备，这就是为什么输入<code>mmc info</code>查询到的是 EMMC 设备信息，而不是 SD 卡。要想查看 SD 卡信息，就要使用命令<code>mmc dev</code>来将 SD 卡设置为当前的 MMC 设备。</p>
<h3><span id="1-6-4-mmc-dev">1.6.4 mmc dev</span><a href="#1-6-4-mmc-dev" class="header-anchor">#</a></h3><p>选择切换当前emmc设备。</p>
<pre><code>mmc dev [dev] [part]
</code></pre>
<p>[dev]用来设置要切换的 MMC 设备号，[part]是分区号。如果不写分区号的话默认为分区 0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">0</span> <span class="comment">//切换到 SD 卡，0 为 SD 卡，1 为 eMMC</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/30.png" alt="image"><br>切换到sd这个mmc后，输入mmc info命令既可以查看sd信息：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/31.png" alt="image"></p>
<p>可以看到当前 SD 卡为 3.0 版本的，容量为 14.8GiB(16GB 的 SD 卡)，4 位宽的总线。</p>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/32.png" alt="image"></p>
<h3><span id="1-6-5-mmc-part">1.6.5 mmc part</span><a href="#1-6-5-mmc-part" class="header-anchor">#</a></h3><p>查看mmc分区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span> <span class="comment">//切换到 EMMC</span></span><br><span class="line">mmc part <span class="comment">//查看 EMMC 分区</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/33.png" alt="image"></p>
<p>切到核心板的emmc后，<code>mmc part</code>显示分区信息，此时 EMMC 有两个分区，第一个分区起始扇区为 20480，长度为 262144 个扇区；第二个分区起始扇区为 282624，长度为 14594048 个扇区。<br>如果 EMMC 里面烧写了 Linux 系统的话，EMMC 是有 3 个分区的，第 0 个分区存放 uboot，第 1 个分区存放Linux 镜像文件和设备树，第 2 个分区存放根文件系统。但是在上图中只有两个分区，那是因为第 0 个分区没有格式化，所以识别不出来，实际上第 0 个分区是存在的。一个新的 SD卡默认只有一个分区，那就是分区 0，所以前面讲解的 uboot 烧写到 SD 卡，其实就是将 u-boot.bin烧写到了 SD 卡的分区 0 里面.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span> <span class="number">2</span> <span class="comment">//将 EMMC 的分区 2 设置为当前 MMC 设备</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/34.png" alt="image"></p>
<h3><span id="1-6-6-mmc-read">1.6.6 mmc read</span><a href="#1-6-6-mmc-read" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc <span class="built_in">read</span> addr blk<span class="comment"># cnt</span></span><br></pre></td></tr></table></figure>
<p>读mmc设备中的数据。addr 是数据读取到 DRAM 中的地址，blk 是要读取的块起始地址(十六进制)，一个块是 512字节，这里的块和扇区是一个意思，在 MMC 设备中我们通常说扇区，cnt 是要读取的块数量(十六进制)。比如从 EMMC 的第 1536(0x600)个块开始，读取 16(0x10)个块的数据到 DRAM 的0X80800000 地址处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span> <span class="number">0</span> <span class="comment">//切换到 MMC 分区 0</span></span><br><span class="line">mmc read <span class="number">80800000</span> <span class="number">600</span> <span class="number">10</span> <span class="comment">//读取数据</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/35.png" alt="image"><br>这里我们还看不出来读取是否正确，通过 md.b 命令查看 0x80800000 处的数据就行了，查看<code> 16*512=8192(0x2000)</code>个字节的数据。<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/36.png" alt="image"></p>
<p>可以看到<code>baudrate=115200.board_name=EVK.board_rev=14X14</code>等字样，<br>这个就是 uboot 中的环境变量。EMMC 核心板 uboot 环境变量的存储起始地址就是<code>1536*512=786432</code>。</p>
<h3><span id="1-6-7-mmc-write">1.6.7 mmc write</span><a href="#1-6-7-mmc-write" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc write addr blk<span class="comment"># cnt</span></span><br></pre></td></tr></table></figure>
<p>从DRAM写数据到mmc设备。<br>比如通过 nfs 或者 tftp 命令将新的 u-boot.bin 下载到开发板的 DRAM 中，然后再使用命令<code>mmc write</code>将其写入到 MMC设备中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">0</span> <span class="comment">//切换到 SD 卡</span></span><br><span class="line">version <span class="comment">//查看uboot版本号</span></span><br><span class="line">tftp <span class="number">80800000</span> u-boot.imx</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/37.png" alt="image"><br>可以看出，u-boot.imx 大小为 <code>379904 字节，379904/512=742</code>，所以我们要向 SD 卡中写入742 个块，如果有小数的话就要加 1 个块。使用命令<code>mmc write</code>从 SD 卡分区 0 第 2 个块(扇区)开始烧写，一共烧写 742(0x2E6)个块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">0</span> <span class="number">0</span></span><br><span class="line">mmc write <span class="number">80800000</span> <span class="number">2</span> <span class="number">2E6</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/38.png" alt="image"></p>
<p>烧写成功，重启开发板(从 SD 卡启动)，重启以后再输入 version 来查看版本号：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/39.png" alt="image"><br>这样就给mmc0也就是sd卡烧录了uboot, 同理要烧录emmc也是同理，切到mmc1即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mmc dev <span class="number">1</span> <span class="number">0</span> <span class="comment">//切换到 EMMC 分区 0</span></span><br><span class="line">tftp <span class="number">80800000</span> u-boot.imx <span class="comment">//下载 u-boot.imx 到 DRAM</span></span><br><span class="line">mmc write <span class="number">80800000</span> <span class="number">2</span> <span class="number">32</span>E <span class="comment">//烧写 u-boot.imx 到 EMMC 中</span></span><br><span class="line">mmc partconf <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="comment">//分区配置，EMMC 需要这一步！</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：千万不要写 SD 卡或者 EMMC 的前两个块(扇区)，里面保存着分区表！</strong></p>
<h3><span id="1-6-7-mmc-erase">1.6.7 mmc erase</span><a href="#1-6-7-mmc-erase" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc erase blk<span class="comment"># cnt</span></span><br></pre></td></tr></table></figure>
<p>擦除 MMC 设备的指定块, blk 为要擦除的起始块，cnt 是要擦除的数量。</p>
<h2><span id="1-7-wen-jian-cao-zuo-ming-ling-fat-wen-jian-xi-tong">1.7 文件操作命令（fat文件系统）</span><a href="#1-7-wen-jian-cao-zuo-ming-ling-fat-wen-jian-xi-tong" class="header-anchor">#</a></h2><h3><span id="1-7-1-fatinfo">1.7.1 fatinfo</span><a href="#1-7-1-fatinfo" class="header-anchor">#</a></h3><pre><code>fatinfo &lt;interface&gt; [&lt;dev[:part]&gt;]
</code></pre>
<p>于查询指定 MMC 设备分区的文件系统信息，interface 表示接口，比如 mmc，dev 是查询的设备号，part 是要查询的分区。比如我们要查询 EMMC 分区 1 的文件系统信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatinfo mmc <span class="number">1</span>:<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/40.png" alt="image"><br>上图显示mmc1也就是emmc设备的分区1的文件系统为fat32格式。</p>
<h3><span id="1-7-1-fatls">1.7.1 fatls</span><a href="#1-7-1-fatls" class="header-anchor">#</a></h3><pre><code>fatls &lt;interface&gt; [&lt;dev[:part]&gt;] [directory]
</code></pre>
<p>查询设备分区的目录和文件信息。interface 是要查询的接口，比如 mmc，dev 是要查询的设备号，part 是要查询的分区，directory是要查询的目录。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatls mmc <span class="number">1</span>:<span class="number">1</span>   <span class="comment">//查询 mmc1设备（EMMC 设备）中分区 1 中的所有的目录和文件</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/41.png" alt="image"></p>
<h3><span id="1-7-3-fstype">1.7.3 fstype</span><a href="#1-7-3-fstype" class="header-anchor">#</a></h3><pre><code>fstype &lt;interface&gt; &lt;dev&gt;:&lt;part&gt;
</code></pre>
<p>查看 MMC 设备某个分区的文件系统格式.正点原子 EMMC 核心板上的 EMMC 默认有 3 个分区, 分区 0 格式未知，因为分区 0 存放的 uboot，并且分区 0 没有格式化，所以文件系统格式未知。分区 1 的格式为 fat，分区 1 用于存放 linux 镜像和设备树。分区 2 的格式为 ext4，用于存放 Linux 的根文件系统(rootfs)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fstype mmc <span class="number">1</span>:<span class="number">0</span></span><br><span class="line">fstype mmc <span class="number">1</span>:<span class="number">1</span></span><br><span class="line">fstype mmc <span class="number">1</span>:<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/42.png" alt="image"></p>
<h3><span id="1-7-4-fatload">1.7.4 fatload</span><a href="#1-7-4-fatload" class="header-anchor">#</a></h3><pre><code>fatload &lt;interface&gt; [&lt;dev[:part]&gt; [&lt;addr&gt; [&lt;filename&gt; [bytes [pos]]]]]
</code></pre>
<p>将指定的文件读取到 DRAM.<br>interface 为接口，比如 mmc，dev 是设备号，part 是分区，addr 是保存在 DRAM 中的起始地址，filename 是要读取的文件名字。bytes 表示读取多少字节的数据，如果 bytes 为 0 或者省略的话表示读取整个文件。pos 是要读的文件相对于文件首地址的偏移，如果为 0 或者省略的话表示从文件首地址开始读取.</p>
<pre><code>fatload mmc 1:1 80800000 zImage  //将 EMMC 分区 1 中的 zImage 文件读取到 DRAM 中的0X80800000 地址处
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/43.png" alt="image"></p>
<p> 225ms 内读取了 6785272 个字节的数据，速度为 28.8MiB&#x2F;s，速度是非常快的，因为这是从 EMMC 里面读取的，而 EMMC 是 8 位的，速度肯定会很快的。</p>
<h3><span id="1-7-5-fatwrite">1.7.5 fatwrite</span><a href="#1-7-5-fatwrite" class="header-anchor">#</a></h3><p>将 DRAM 中的数据写入到 MMC 设备。<br>uboot 默认没有使能<code> fatwrite</code> 命令，需要修改板子配置头文件，比如 <code>mx6ullevk.h、 mx6ull_alientek_emmc.h </code>等,需要开启宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_FAT_WRITE <span class="comment">/* 使能 fatwrite 命令 */</span></span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/44.png" alt="image"></p>
<pre><code>fatwrite &lt;interface&gt; &lt;dev[:part]&gt; &lt;addr&gt; &lt;filename&gt; &lt;bytes&gt;
</code></pre>
<p>interface 为接口，比如 mmc，dev 是设备号，part 是分区，addr 是要写入的数据在 DRAM中的起始地址，filename 是写入的数据文件名字，bytes 表示要写入多少字节的数据。</p>
<p>比如我们通过nfs or tftp命令下载镜像到DRAM后，通过fatwrite去烧写image：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/45.png" alt="image"><br>zImage 大小为<code>6785272(0X6788f8)</code>个字节(注意，由于开发板系统在不断的更新中，因此zImage 大小不是固定的，一切以实际大小为准)，接下来使用命令<code>fatwrite</code>将其写入到 EMMC 的分区 1 中，文件名字为 zImage：</p>
<pre><code>fatwrite mmc 1:1 80800000 zImage 6788f8
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/46.png" alt="image"></p>
<p>完成以后使用<code>fatls</code>命令查看一下 EMMC 分区 1 里面的文件：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/47.png" alt="image"></p>
<h2><span id="1-8-wen-jian-cao-zuo-ming-ling-ext-wen-jian-xi-tong">1.8 文件操作命令（ext文件系统）</span><a href="#1-8-wen-jian-cao-zuo-ming-ling-ext-wen-jian-xi-tong" class="header-anchor">#</a></h2><p>ext文件系统是linux常用的文件系统，一般rootfs就是典型的ext2文件系统。<br><code>ext2load、ext2ls、ext4load、ext4ls 和 ext4write</code>。这些命令的含义和使用与<code> fatload、fatls 和 fatwrite</code>一样，只是 ext2 和 ext4 都是针对 ext 文件系统的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ext4ls mmc <span class="number">1</span>:<span class="number">2</span>	<span class="comment">//emmc设备分区2就是ext4文件系统，存放了rootfs</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/48.png" alt="image"></p>
<h2><span id="1-9-nandflash-cao-zuo-ming-ling">1.9 nandflash操作命令</span><a href="#1-9-nandflash-cao-zuo-ming-ling" class="header-anchor">#</a></h2><p>输入<code>? nand</code>即可查看NAND 相关命令：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/49.png" alt="image"></p>
<h3><span id="1-9-1-nand-info">1.9.1 nand info</span><a href="#1-9-1-nand-info" class="header-anchor">#</a></h3><p>打印 NAND Flash 信息:<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/50.png" alt="image"></p>
<h3><span id="1-9-2-nand-device">1.9.2 nand device</span><a href="#1-9-2-nand-device" class="header-anchor">#</a></h3><p>用于切换 NAND Flash，如果你的板子支持多片 NAND 的话就可以使用此命令来设置当前所使用的 NAND。</p>
<h3><span id="1-9-3-nand-erase">1.9.3 nand erase</span><a href="#1-9-3-nand-erase" class="header-anchor">#</a></h3><p><code>nand erase </code>命令用于擦除 NAND Flash，NAND Flash 的特性(位翻转，只能由1变成0,而不能由0变成1)决定了在向 NAND Flash 写数据之前一定要先对要写入的区域进行擦除.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nand erase[.spread] [clean] off size <span class="comment">//从指定地址开始(off)开始，擦除指定大小(size)的区域。</span></span><br><span class="line">nand erase.part [clean] partition <span class="comment">//擦除指定的分区</span></span><br><span class="line">nand erase.chip [clean] <span class="comment">//全篇擦除</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-9-3-nand-write">1.9.3 nand write</span><a href="#1-9-3-nand-write" class="header-anchor">#</a></h3><pre><code>nand write addr off size
</code></pre>
<p>addr 是要写入的数据首地址，off 是 NAND 中的目的地址，size 是要写入的数据大小。</p>
<p>编译出来 NAND版本的 kernel 和 dtb 文件，在烧写之前要先对 NAND 进行分区，也就是规划好 uboot、linux kernel、设备树和根文件系统的存储区域，I.MX6U-ALPHA 开发板出厂系统 NAND 分区如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x000000000000</span><span class="number">-0x0000003FFFFF</span> : <span class="string">&quot;boot&quot;</span></span><br><span class="line"><span class="number">0x000000400000</span><span class="number">-0x00000041FFFF</span> : <span class="string">&quot;env&quot;</span></span><br><span class="line"><span class="number">0x000000420000</span><span class="number">-0x00000051FFFF</span> : <span class="string">&quot;logo&quot;</span></span><br><span class="line"><span class="number">0x000000520000</span><span class="number">-0x00000061FFFF</span> : <span class="string">&quot;dtb&quot;</span></span><br><span class="line"><span class="number">0x000000620000</span><span class="number">-0x000000E1FFFF</span> : <span class="string">&quot;kernel&quot;</span></span><br><span class="line"><span class="number">0x000000E20000</span><span class="number">-0x000020000000</span> : <span class="string">&quot;rootfs&quot;</span></span><br></pre></td></tr></table></figure>

<p>一共有六个分区，第一个分区存放 uboot，地址范围为<code> 0x0~0x3FFFFF(共 4MB)</code>；第二个分区存放 env（环境变量），地址范围为 <code>0x400000~0x420000(共 128KB)</code>；第三个分区存放 logo(启动图标)，地址范围为<code> 0x420000~0x51FFFF(共 1MB)</code>；第四个分区存放 dtb(设备树)，地址范围为<code>0x520000~0x61FFFF(共 1MB)</code>；第五个分区存放 kernel(也就是 linux kernel)，地址范围为<code>0x620000~0xE1FFFF(共 8MB)</code>；剩下的所有存储空间全部作为最后一个分区，存放 rootfs(根文件系统)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp <span class="number">0x87800000</span> zImage <span class="comment">//下载 zImage 到 DRAM 中</span></span><br><span class="line">nand erase <span class="number">0x620000</span> <span class="number">0x800000</span> <span class="comment">//从地址 0x620000 开始擦除 8MB 的空间</span></span><br><span class="line">nand write <span class="number">0x87800000</span> <span class="number">0x620000</span> <span class="number">0x800000</span> <span class="comment">//将接收到的 zImage 写到 NAND 中</span></span><br></pre></td></tr></table></figure>

<p>这里我们擦除了 8MB 的空间，因为一般 zImage 就是 6,7MB 左右，8MB 肯定够了，如果不够的话就再多擦除一点就行了。同理烧录dtb:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp <span class="number">0x87800000</span> imx6ull<span class="number">-14</span>x14-emmc<span class="number">-7</span><span class="number">-1024</span>x600-c.dtb <span class="comment">//下载 dtb 到 DRAM 中</span></span><br><span class="line">nand erase <span class="number">0x520000</span> <span class="number">0x100000</span> <span class="comment">//从地址 0x520000 开始擦除 1MB 的空间</span></span><br><span class="line">nand write <span class="number">0x87800000</span> <span class="number">0x520000</span> <span class="number">0x100000</span> <span class="comment">//将接收到的 dtb 写到 NAND 中</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-9-4-nand-read">1.9.4 nand read</span><a href="#1-9-4-nand-read" class="header-anchor">#</a></h3><pre><code>nand read addr off size
</code></pre>
<p>从 NAND 中的指定地址读取指定大小的数据到 DRAM.<br>addr 是目的地址，off 是要读取的 NAND 中的数据源地址，size 是要读取的数据大小。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nand read <span class="number">0x83000000</span> <span class="number">0x520000</span> <span class="number">0x19000</span>  <span class="comment">//读取设备树(dtb)文件到 0x83000000 地址处</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/51.png" alt="image"></p>
<h2><span id="1-10-she-bei-shu-xiang-guan">1.10 设备树相关</span><a href="#1-10-she-bei-shu-xiang-guan" class="header-anchor">#</a></h2><h3><span id="1-10-1-fdt-addr">1.10.1 fdt addr</span><a href="#1-10-1-fdt-addr" class="header-anchor">#</a></h3><p>设置设备树起始地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nand read <span class="number">0x83000000</span> <span class="number">0x520000</span> <span class="number">0x19000</span> <span class="comment">//比如把nand中dtb分区数据读到dram</span></span><br><span class="line">fdt addr <span class="number">83000000</span>	<span class="comment">//设置好设备树起始地址</span></span><br></pre></td></tr></table></figure>
<h3><span id="1-10-2-fdt-header">1.10.2 fdt header</span><a href="#1-10-2-fdt-header" class="header-anchor">#</a></h3><p>查看设备树头部信息：</p>
<pre><code>fdt header
</code></pre>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/52.png" alt="image"></p>
<h3><span id="1-10-3-fdt-print">1.10.3 fdt print</span><a href="#1-10-3-fdt-print" class="header-anchor">#</a></h3><p>解析出dts内容：<br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/53.png" alt="image"></p>
<h2><span id="1-11-qi-dong-xiang-guan">1.11 启动相关</span><a href="#1-11-qi-dong-xiang-guan" class="header-anchor">#</a></h2><h3><span id="1-11-1-bootz-qi-dong-zimage">1.11.1 bootz (启动zImage)</span><a href="#1-11-1-bootz-qi-dong-zimage" class="header-anchor">#</a></h3><pre><code>bootz [addr [initrd[:size]] [fdt]]
</code></pre>
<p>addr 是 Linux 镜像文件在 DRAM 中的位置，initrd 是 initrd 文件在DRAM 中的地址，如果不使用 initrd 的话使用‘-’代替即可，fdt 就是设备树文件在 DRAM 中的地址.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tftp <span class="number">80800000</span> zImage</span><br><span class="line">tftp <span class="number">83000000</span> imx6ull<span class="number">-14</span>x14-emmc<span class="number">-7</span><span class="number">-1024</span>x600-c.dtb</span><br><span class="line">bootz <span class="number">80800000</span> - <span class="number">83000000</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/54.png" alt="image"><br>换一张启动方式：从mmc1也就是emmc启动：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fatload mmc <span class="number">1</span>:<span class="number">1</span> <span class="number">80800000</span> zImage</span><br><span class="line">fatload mmc <span class="number">1</span>:<span class="number">1</span> <span class="number">83000000</span> imx6ull<span class="number">-14</span>x14-emmc<span class="number">-7</span><span class="number">-1024</span>x600-c.dtb</span><br><span class="line">bootz <span class="number">80800000</span> - <span class="number">83000000</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/55.png" alt="image"></p>
<h3><span id="1-11-1-bootm-qi-dong-uimage">1.11.1 bootm (启动uImage)</span><a href="#1-11-1-bootm-qi-dong-uimage" class="header-anchor">#</a></h3><pre><code>bootm [addr [initrd[:size]] [fdt]]
</code></pre>
<p>bootm 命令和 bootz 类似，它是启动 uImage 镜像。uImage是U-boot专用的映像文件，它是在zImage之前加上一个长度为0x40的“头”，说明这个映像文件的类型、加载位置、生成时间、大小等信息。<br>bootm如果不需要启动设备树：</p>
<pre><code>bootm addr
</code></pre>
<h3><span id="1-11-3-boot">1.11.3 boot</span><a href="#1-11-3-boot" class="header-anchor">#</a></h3><p>boot 会读取环境变量 bootcmd 来启动 Linux 系统：<br>比如设置bootcmd如下，从网络启动linux：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd <span class="string">&#x27;tftp 80800000 zImage; tftp 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb; bootz 80800000 - 83000000&#x27;</span></span><br><span class="line">saveenv</span><br><span class="line">boot</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/56.png" alt="image"></p>
<p>同理，如果想从emmc启动linux,设置bootcmd如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setenv bootcmd <span class="string">&#x27;fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb; bootz 80800000 - 83000000&#x27;</span></span><br><span class="line">savenev</span><br><span class="line">boot</span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/57.png" alt="image"></p>
<h3><span id="1-11-4-go-ming-ling">1.11.4 go命令</span><a href="#1-11-4-go-ming-ling" class="header-anchor">#</a></h3><pre><code>go addr
</code></pre>
<p>跳到指定的地址处执行, addr表示DRAM地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tftp <span class="number">87800000</span> <span class="built_in">printf</span>.bin	<span class="comment">//一个裸机程序，打印输入的按键，将两个整数相加</span></span><br><span class="line">go <span class="number">87800000</span></span><br></pre></td></tr></table></figure>
<p><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/58.png" alt="image"></p>
<h3><span id="1-11-5-run">1.11.5 run</span><a href="#1-11-5-run" class="header-anchor">#</a></h3><p>run 命令用于运行环境变量中定义的命令，比如可以通过<code>run bootcmd</code>来运行 bootcmd 中的启动命令:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setenv mybootemmc <span class="string">&#x27;fatload mmc 1:1 80800000 zImage; fatload mmc 1:1 83000000 imx6ull-14x14-emmc-7-1024x600-c.dtb;bootz 80800000 - 83000000&#x27;</span></span><br><span class="line">setenv mybootnand <span class="string">&#x27;nand read 80800000 4000000 800000;nand read 83000000 6000000 100000;bootz 80800000 - 83000000&#x27;</span></span><br><span class="line">setenv mybootnet <span class="string">&#x27;tftp 80800000 zImage; tftp 83000000imx6ull-14x14-emmc-7-1024x600-c.dtb;</span></span><br><span class="line"><span class="string">bootz 80800000 - 83000000&#x27;</span></span><br><span class="line">saveenv</span><br></pre></td></tr></table></figure>

<p>设置了3个环境变量，可以<code>run mybootemmc或者run mybootnand或者run mybootnet</code>来分别从emmc启动，从nand启动，从网络启动。</p>
<h2><span id="1-12-nei-cun-ce-shi-mtest">1.12 内存测试mtest</span><a href="#1-12-nei-cun-ce-shi-mtest" class="header-anchor">#</a></h2><pre><code>mtest [start [end [pattern [iterations]]]]
</code></pre>
<p>start 是要测试的 DRAM 开始地址，end 是结束地址，比如我们测试<code> 0X80000000~0X80001000</code>这段内存，输入<code>mtest 80000000 80001000</code><br><img src="/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/59.png" alt="image"><br> 可以看出，测试范围为<code> 0X80000000~0X80001000</code>，已经测试了 486 次，如果要结束测试就按下键盘上的“Ctrl+C”键。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/22/uboot-%E5%91%BD%E4%BB%A4%E5%92%8C%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/" data-id="cm0xxoge4002rqsufa3mg7417" data-title="uboot-命令和环境变量" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux日志管理-dynamic-debug" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/" class="article-date">
  <time class="dt-published" datetime="2024-06-08T14:22:28.000Z" itemprop="datePublished">2024-06-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/">Linux日志管理-dynamic_debug</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-dynamic-debug-jie-shao">1 dynamic_debug介绍</a><ul>
<li><a href="#1-1-kai-qi-dynamic-debug">1.1 开启dynamic debug</a></li>
<li><a href="#1-2-dynamic-debug-shi-yong">1.2 dynamic debug使用</a><ul>
<li><a href="#1-2-1-kai-qi-dynamic-debug">1.2.1 开启dynamic debug</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-dev-err-dev-info-dev-warn">2 dev_err&#x2F;dev_info&#x2F;dev_warn</a></li>
<li><a href="#3-ke-bian-can-shu-hong">3 可变参数宏</a></li>
<li><a href="#4-mo-kuai-da-yin-deng-ji-kong-zhi">4 模块打印等级控制</a><ul>
<li><a href="#4-1-an-zhao-da-yin-deng-ji-kong-zhi">4.1 按照打印等级控制</a></li>
<li><a href="#4-2-jing-que-kong-zhi-da-yin-deng-ji">4.2 精确控制打印等级</a></li>
</ul>
</li>
<li><a href="#5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi">5 用户态模块打印等级控制</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-dynamic-debug-jie-shao">1 dynamic_debug介绍</span><a href="#1-dynamic-debug-jie-shao" class="header-anchor">#</a></h1><p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/1.png" alt="img"></p>
<p>这里强烈推荐驱动开发者用这种方式输出log。linux kernel space中有<code>pr_debug</code>及<code>dev_dbg</code>来使用dynamic debug。可以看到当用户<code>define DEBUG</code>后，<code>pr_debug</code>和<code>dev_dbg</code>就等于printk的KERN_DEBUG级别输出了；否则什么也不打印。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/2.png" alt="img"></p>
<h2><span id="1-1-kai-qi-dynamic-debug">1.1 开启dynamic debug</span><a href="#1-1-kai-qi-dynamic-debug" class="header-anchor">#</a></h2><p>要使用dynamic_debug需要在kernel的defconfig中开启。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DYNAMIC_DEBUG=y</span><br></pre></td></tr></table></figure>

<p>用menuconfig去配置的话如下图：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/3.png" alt="img"></p>
<h2><span id="1-2-dynamic-debug-shi-yong">1.2 dynamic debug使用</span><a href="#1-2-dynamic-debug-shi-yong" class="header-anchor">#</a></h2><p>编译好image后，需要挂载debugfs（不挂载的话将不会创建debugfs,那么<code>/sys/kernel/debug/</code>下是空的）。</p>
<p>修改etc&#x2F;fstab文件，追加下面这段字符:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodev      /sys/kernel/debug debugfs   defaults    0   0</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/4.png" alt="img"></p>
<p>可以用<code>cat /sys/kernel/debug/dynamic_debug/control | grep xxx.c</code>来查看自己想要查看的log所在文件有没有包含进去。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/5.png" alt="img"></p>
<p>这里可以看到该文件所有用<code>dev_dbg()</code>打印出的讯息。</p>
<p>那如果不开启<code>CONFIG_DYNAMIC_DEBUG</code>，将不会产生<code>/sys/kernel/debug/dynamic_debug</code>目录, 是不能进行动态打印的。</p>
<h3><span id="1-2-1-kai-qi-dynamic-debug">1.2.1 开启dynamic debug</span><a href="#1-2-1-kai-qi-dynamic-debug" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;module cvi_mipi_rx +p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">echo <span class="string">&quot;file cvi_vip_cif.c +p&quot;</span> &gt;/sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p>这两种方式都是开dynamic debug，第一种是对模块开启，第二种只对文件开启。</p>
<p>下面举一个栗子：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/6.png" alt="img"></p>
<p>开启之后，可以看到<code>dev_dbg()</code>打印的log都会输出。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/7.png" alt="img"></p>
<p>反之，关闭<code>dynamic debug</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">&quot;module cvi_mipi_rx -p&quot;</span> &gt; /sys/kernel/debug/dynamic_debug/control</span><br><span class="line">echo <span class="string">&quot;file cvi_vip_cif.c -p&quot;</span> &gt;/sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p>除了上面的两种方式还有一种可以只开启某个function:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;func _init_resource +p&quot; &gt; /sys/kernel/debug/dynamic_debug/control</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/8.png" alt="img"></p>
<h1><span id="2-dev-err-x2f-dev-info-x2f-dev-warn">2 dev_err&#x2F;dev_info&#x2F;dev_warn</span><a href="#2-dev-err-x2f-dev-info-x2f-dev-warn" class="header-anchor">#</a></h1><p>在Linux驱动代码中，有大量的调试信息，那么推荐使用<code>dev_err/dev_info/dev_warn</code>这一系列函数族。这一系列函数族定义在<code>include/linux/device.h</code>。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/9.png" alt="img"></p>
<p>其实这些函数族本质上和下面printk.h中的定义也是完全一致的。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> pr_emerg(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_EMERG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_alert(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ALERT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_crit(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_CRIT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_err(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warning(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_WARNING pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warn pr_warning</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_notice(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure>

<p>下图是示例，可以看到err级别以下的log没有打印，那么设置printk的控制台级别可以把对应的log输出到console。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/10.png" alt="img"></p>
<p>如何设置printk console level可以看上一篇<a target="_blank" rel="noopener" href="https://fuzidage.github.io/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/">Linux日志管理-printk和dmesg</a>。</p>
<h1><span id="3-ke-bian-can-shu-hong">3 可变参数宏</span><a href="#3-ke-bian-can-shu-hong" class="header-anchor">#</a></h1><p>##__VA_ARGS__表示可变参数宏，可以用来传递多个参数，如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> my_dbg(fmt, ...) \</span></span><br><span class="line"><span class="meta">do &#123;                        \</span></span><br><span class="line"><span class="meta">        printf(<span class="string">&quot;[%s] [%d] &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__);\</span></span><br><span class="line"><span class="meta">&#125; while(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> my_dbg(fmt...) \</span></span><br><span class="line"><span class="meta">do &#123; \</span></span><br><span class="line"><span class="meta">　　printf(<span class="string">&quot;[%s] [%d] &quot;</span>, __func__, __LINE__); \</span></span><br><span class="line"><span class="meta">　　printf(fmt); \</span></span><br><span class="line"><span class="meta">&#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *name = <span class="string">&quot;robin&quot;</span>; <span class="type">int</span> age = <span class="number">18</span>; my_dbg(<span class="string">&quot;this is a test. name:%s, age:%d\n&quot;</span>, name, age);</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/11.png" alt="img"></p>
<p>那和下面这种写法呢本质上是完全一样的。</p>
<p><img src="/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/12.png" alt="img"></p>
<h1><span id="4-mo-kuai-da-yin-deng-ji-kong-zhi">4 模块打印等级控制</span><a href="#4-mo-kuai-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h1><h2><span id="4-1-an-zhao-da-yin-deng-ji-kong-zhi">4.1 按照打印等级控制</span><a href="#4-1-an-zhao-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _XXX_DEBUG_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _XXX_DEBUG_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/debugfs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u32 xxx_log_lv;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG_ERR        1   <span class="comment">/* error conditions                     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG_WARN       2   <span class="comment">/* warning conditions                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG_NOTICE     3   <span class="comment">/* normal but significant condition     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG_INFO       4   <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBG_DEBUG      5   <span class="comment">/* debug-level messages                 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_LOG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRACE_XXX(level, fmt, ...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (level &lt;= xxx_log_lv) &#123; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (level == DBG_ERR) \</span></span><br><span class="line"><span class="meta">                pr_err(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == DBG_WARN) \</span></span><br><span class="line"><span class="meta">                pr_warn(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == DBG_NOTICE) \</span></span><br><span class="line"><span class="meta">                pr_notice(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == DBG_INFO) \</span></span><br><span class="line"><span class="meta">                pr_info(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == DBG_DEBUG) \</span></span><br><span class="line"><span class="meta">                printk(KERN_DEBUG <span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TRACE_XXX(level, fmt, ...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _xxx_DEBUG_H_ */</span></span></span><br></pre></td></tr></table></figure>

<p>当级别高于DBG,即可输出高于DBG的所有级别打印。</p>
<h2><span id="4-2-jing-que-kong-zhi-da-yin-deng-ji">4.2 精确控制打印等级</span><a href="#4-2-jing-que-kong-zhi-da-yin-deng-ji" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> u32 vi_log_lv;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">vi_msg_pri</span> &#123;</span></span><br><span class="line">    VI_ERR        = <span class="number">0x1</span>,</span><br><span class="line">    VI_WARN        = <span class="number">0x2</span>,</span><br><span class="line">    VI_NOTICE    = <span class="number">0x4</span>,</span><br><span class="line">    VI_INFO        = <span class="number">0x8</span>,</span><br><span class="line">    VI_DBG        = <span class="number">0x10</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> vi_pr(level, fmt, arg...) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (vi_log_lv &amp; level) &#123; \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (level == VI_ERR) \</span></span><br><span class="line"><span class="meta">                pr_err(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_WARN) \</span></span><br><span class="line"><span class="meta">                pr_warn(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_NOTICE) \</span></span><br><span class="line"><span class="meta">                pr_notice(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_INFO) \</span></span><br><span class="line"><span class="meta">                pr_info(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">            <span class="keyword">else</span> <span class="keyword">if</span> (level == VI_DBG) \</span></span><br><span class="line"><span class="meta">                pr_debug(<span class="string">&quot;%s:%d(): &quot;</span> fmt, __func__, __LINE__, ## arg); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br></pre></td></tr></table></figure>

<p>可以随意开启任意级别打印，比如只开启DBG，只开启WARN。</p>
<h1><span id="5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi">5 用户态模块打印等级控制</span><a href="#5-yong-hu-tai-mo-kuai-da-yin-deng-ji-kong-zhi" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">XXX_S32 *log_levels;</span><br><span class="line">XXX_CHAR <span class="type">const</span> *log_name[<span class="number">8</span>] = &#123;</span><br><span class="line">    (XXX_CHAR *)<span class="string">&quot;EMG&quot;</span>, (XXX_CHAR *)<span class="string">&quot;ALT&quot;</span>, (XXX_CHAR *)<span class="string">&quot;CRI&quot;</span>, (XXX_CHAR *)<span class="string">&quot;ERR&quot;</span>,</span><br><span class="line">    (XXX_CHAR *)<span class="string">&quot;WRN&quot;</span>, (XXX_CHAR *)<span class="string">&quot;NOT&quot;</span>, (XXX_CHAR *)<span class="string">&quot;INF&quot;</span>, (XXX_CHAR *)<span class="string">&quot;DBG&quot;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">XXX_S32 <span class="title function_">XXX_LOG_SetLevelConf</span><span class="params">(LOG_LEVEL_CONF_S *pstConf)</span></span><br><span class="line">&#123;</span><br><span class="line">    log_levels[pstConf-&gt;enModId] = pstConf-&gt;s32Level;</span><br><span class="line">    <span class="keyword">return</span> XXX_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">XXX_S32 <span class="title function_">XXX_LOG_GetLevelConf</span><span class="params">(LOG_LEVEL_CONF_S *pstConf)</span></span><br><span class="line">&#123;</span><br><span class="line">    pstConf-&gt;s32Level = log_levels[pstConf-&gt;enModId];</span><br><span class="line">    <span class="keyword">return</span> XXX_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __XXX_DEBUG_H__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __XXX_DEBUG_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;XXX_common.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* End of #ifdef __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Debug Config</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_XXX_GDB_NO 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_XXX_GDB <span class="string">&quot;n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_XXX_LOG_TRACE_SUPPORT 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_XXX_LOG_TRACE_ALL 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_XXX_LOG_TRACE_LEVEL 4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_EMERG      0   <span class="comment">/* system is unusable                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_ALERT      1   <span class="comment">/* action must be taken immediately     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_CRIT       2   <span class="comment">/* critical conditions                  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_ERR        3   <span class="comment">/* error conditions                     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_WARN       4   <span class="comment">/* warning conditions                   */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_NOTICE     5   <span class="comment">/* normal but significant condition     */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_INFO       6   <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_DBG_DEBUG      7   <span class="comment">/* debug-level messages                 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">LOG_LEVEL_CONF_S</span> &#123;</span></span><br><span class="line">    MOD_ID_E  enModId;</span><br><span class="line">    XXX_S32   s32Level;</span><br><span class="line">    <span class="type">char</span>   cModName[<span class="number">16</span>];</span><br><span class="line">&#125; LOG_LEVEL_CONF_S;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_PRINT printf</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic push</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic ignored <span class="string">&quot;-Wunused-variable&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> XXX_S32 * log_levels;</span><br><span class="line"><span class="keyword">extern</span> XXX_CHAR <span class="type">const</span> *log_name[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> GCC diagnostic pop</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GENERATE_STRING(STRING) (#STRING),</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *<span class="type">const</span> MOD_STRING[] = FOREACH_MOD(_GENERATE_STRING);</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_GET_MOD_NAME(id) (id &lt; XXX_ID_BUTT)? MOD_STRING[id] : <span class="string">&quot;UNDEF&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* #ifdef XXX_DEBUG */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_XXX_LOG_TRACE_SUPPORT</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> XXX_ASSERT(expr)                               \</span></span><br><span class="line"><span class="meta">    do &#123;                                                   \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!(expr)) &#123;                                 \</span></span><br><span class="line"><span class="meta">            printf(<span class="string">&quot;\nASSERT at:\n&quot;</span>                \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Function : %s\n&quot;</span>            \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Line No. : %d\n&quot;</span>            \</span></span><br><span class="line"><span class="meta">                   <span class="string">&quot;  &gt;Condition: %s\n&quot;</span>,           \</span></span><br><span class="line"><span class="meta">                   __func__, __LINE__, #expr);     \</span></span><br><span class="line"><span class="meta">            _exit(-1);                             \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FPGA_PORTING</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> XXX_TRACE(level, enModId, fmt, ...)            \</span></span><br><span class="line"><span class="meta">    do &#123;                                                   \</span></span><br><span class="line"><span class="meta">        XXX_S32 LogLevel = (log_levels == NULL) ? CONFIG_XXX_LOG_TRACE_LEVEL : log_levels[enModId];      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (level &lt;= LogLevel)           \</span></span><br><span class="line"><span class="meta">            syslog(LOG_LOCAL5|level, <span class="string">&quot;[%s-%s] &quot;</span> fmt, XXX_GET_MOD_NAME(enModId), log_name[level],    \</span></span><br><span class="line"><span class="meta">                ##__VA_ARGS__);           \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> XXX_TRACE(level, enModId, fmt, ...) \</span></span><br><span class="line"><span class="meta">        printf(fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> XXX_ASSERT(expr)</span></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> XXX_TRACE(level, enModId, fmt...)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_TRACE_ID(level, id, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        XXX_TRACE(level, id, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_TRACE_LOG(level, fmt, ...)  \</span></span><br><span class="line"><span class="meta">        XXX_TRACE(level, XXX_ID_LOG, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> XXX_TRACE_SYS(level, fmt, ...)                                           \</span></span><br><span class="line"><span class="meta">        XXX_TRACE(level, XXX_ID_SYS, <span class="string">&quot;%s:%d:%s(): &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  <span class="comment">/* __XXX_COMM_SYS_H__ */</span></span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/08/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-dynamic-debug/" data-id="cm0xxogdu000iqsufcsko4hhs" data-title="Linux日志管理-dynamic_debug" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux日志管理-printk和demsg" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/" class="article-date">
  <time class="dt-published" datetime="2024-06-07T12:41:02.000Z" itemprop="datePublished">2024-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/">Linux日志管理-printk和demsg</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-printk">1 printk</a><ul>
<li><a href="#1-1-ri-zhi-ji-bie">1.1 日志级别</a></li>
<li><a href="#1-2-kong-zhi-tai-ji-bie">1.2 <strong>控制台级别</strong></a></li>
<li><a href="#1-3-xiu-gai-kong-zhi-tai-ji-bie">1.3 修改控制台级别</a></li>
<li><a href="#1-4-printk-dai-shi-jian-chuo-xun-xi">1.4 printk带时间戳讯息</a></li>
<li><a href="#1-5-printk-di-ceng-shi-xian">1.5 printk底层实现</a><ul>
<li><a href="#1-5-1-ming-ling-xing-can-shu-console">1.5.1 命令行参数console</a></li>
<li><a href="#1-5-2-console-qu-dong-zhu-ce-guo-cheng">1.5.2 console驱动注册过程</a><ul>
<li><a href="#1-5-2-1-chu-li-ming-ling-xing-can-shu">1.5.2.1 处理命令行参数</a></li>
<li><a href="#1-5-2-2-register-console">1.5.2.2 register_console</a></li>
<li><a href="#1-5-2-3-dev-console">1.5.2.3 &#x2F;dev&#x2F;console</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-6-nei-he-xin-xi-de-zao-qi-da-yin">1.6 内核信息的早期打印</a><ul>
<li><a href="#1-6-1-early-printk">1.6.1 early_printk</a></li>
<li><a href="#1-6-2-earlycon">1.6.2 earlycon</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-prink-h-jie-shao">2 prink.h介绍</a></li>
<li><a href="#3-dmesg-ming-ling">3 dmesg命令</a><ul>
<li><a href="#3-1-proc-kmsg">3.1 &#x2F;proc&#x2F;kmsg</a></li>
<li><a href="#3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao">3.2 修改内核日志缓冲区大小</a></li>
<li><a href="#3-3-dmesg">3.3 dmesg</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-printk">1 printk</span><a href="#1-printk" class="header-anchor">#</a></h1><p>printk函数主要做两件事情：第一件就是将信息记录到log中，而第二件事就是调用控制台驱动来将信息输出。printk的相关函数定义在linux&#x2F;printk.h。</p>
<h2><span id="1-1-ri-zhi-ji-bie">1.1 日志级别</span><a href="#1-1-ri-zhi-ji-bie" class="header-anchor">#</a></h2><p>printk需要设置日志级别，用来控制printk打印的这条信息是否在终端上显示的，当printk设置的日志级别高于控制台级别时，printk要打印的信息才会在控制台打印出来。</p>
<p>内核日志一共有8种级别:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_EMERG        <span class="string">&quot;&lt;0&gt;&quot;</span>        <span class="comment">/* system is unusable                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_ALERT        <span class="string">&quot;&lt;1&gt;&quot;</span>        <span class="comment">/* action must be taken immediately        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_CRIT        <span class="string">&quot;&lt;2&gt;&quot;</span>        <span class="comment">/* critical conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_ERR        <span class="string">&quot;&lt;3&gt;&quot;</span>        <span class="comment">/* error conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_WARNING        <span class="string">&quot;&lt;4&gt;&quot;</span>        <span class="comment">/* warning conditions                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_NOTICE        <span class="string">&quot;&lt;5&gt;&quot;</span>        <span class="comment">/* normal but significant condition        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_INFO        <span class="string">&quot;&lt;6&gt;&quot;</span>        <span class="comment">/* informational                        */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>        KERN_DEBUG        <span class="string">&quot;&lt;7&gt;&quot;</span>        <span class="comment">/* debug-level messages                        */</span></span></span><br></pre></td></tr></table></figure>

<h2><span id="1-2-kong-zhi-tai-ji-bie">1.2 <strong>控制台级别</strong></span><a href="#1-2-kong-zhi-tai-ji-bie" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MINIMUM_CONSOLE_LOGLEVEL 1 <span class="comment">/*可以使用的最小日志级别*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_CONSOLE_LOGLEVEL 7 <span class="comment">/*默认的控制台级别*/</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_MESSAGE_LOGLEVEL 4 <span class="comment">/* 默认的日志级别 */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> console_printk[<span class="number">4</span>] = &#123;</span><br><span class="line">    DEFAULT_CONSOLE_LOGLEVEL,<span class="comment">/*控制台日志级别：优先级高于该值的消息将被打印至控制台*/</span></span><br><span class="line">    DEFAULT_MESSAGE_LOGLEVEL,<span class="comment">/*缺省的消息日志级别：将用该优先级来打印没有优先级的消息*/</span></span><br><span class="line">    MINIMUM_CONSOLE_LOGLEVEL,<span class="comment">/*最低的控制台日志级别：控制台日志级别可被设置的最小值（最高优先级）*/</span></span><br><span class="line">    DEFAULT_CONSOLE_LOGLEVEL,<span class="comment">/*缺省的控制台日志级别：控制台日志级别的缺省值*/</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> console_loglevel (console_printk[0])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> default_message_loglevel (console_printk[1])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> minimum_console_loglevel (console_printk[2])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> default_console_loglevel (console_printk[3])</span></span><br></pre></td></tr></table></figure>

<p>使用命令 <code>cat /proc/sys/kernel/printk </code>来查看这四个值:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/1.png" alt="img"></p>
<p>结果显示了 <em>current</em>, <em>default</em>, <em>minimum</em> 和 <em>boot-time-default</em> 日志级别。</p>
<p>其中的 4 4 1 7，分别对应与：<code>console_loglevel、default_message_loglevel、minimum_console_loglevel、default_console_loglevel</code></p>
<p><strong>default_message_loglevel</strong>：</p>
<p>缺省时的消息日志级别，因此当printk未指定优先级时，将以该默认级别输出，也就是<code>DEFAULT_MESSAGE_LOGLEVEL =4， 对应KERN_WARNING。</code></p>
<p>也就是说<code>printk(&quot;hello world\n&quot;);就表示printk(KERN_WARNING &quot;hello world\n&quot;);</code></p>
<p>那如果我们将控制台级别设成&lt;4，如：</p>
<p><code>echo 3 &gt; /proc/sys/kernel/printk</code></p>
<p>那么<code>printk(&quot;hello world\n&quot;);</code>就无法输出到控制台。</p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">字符串</th>
<th align="left">别名函数</th>
</tr>
</thead>
<tbody><tr>
<td align="left">KERN_EMERG</td>
<td align="left">“0”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_emerg"><code>pr_emerg()</code></a></td>
</tr>
<tr>
<td align="left">KERN_ALERT</td>
<td align="left">“1”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_alert"><code>pr_alert()</code></a></td>
</tr>
<tr>
<td align="left">KERN_CRIT</td>
<td align="left">“2”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_crit"><code>pr_crit()</code></a></td>
</tr>
<tr>
<td align="left">KERN_ERR</td>
<td align="left">“3”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_err"><code>pr_err()</code></a></td>
</tr>
<tr>
<td align="left">KERN_WARNING</td>
<td align="left">“4”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_warn"><code>pr_warn()</code></a></td>
</tr>
<tr>
<td align="left">KERN_NOTICE</td>
<td align="left">“5”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_notice"><code>pr_notice()</code></a></td>
</tr>
<tr>
<td align="left">KERN_INFO</td>
<td align="left">“6”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_info"><code>pr_info()</code></a></td>
</tr>
<tr>
<td align="left">KERN_DEBUG</td>
<td align="left">“7”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_debug"><code>pr_debug()</code></a> and <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_devel"><code>pr_devel()</code></a> 若定义了DEBUG</td>
</tr>
<tr>
<td align="left">KERN_DEFAULT</td>
<td align="left">“”</td>
<td align="left">KERN_WARNING</td>
</tr>
<tr>
<td align="left">KERN_CONT</td>
<td align="left">“c”</td>
<td align="left"><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/next/core-api/printk-basics.html#c.pr_cont"><code>pr_cont()</code></a></td>
</tr>
</tbody></table>
<h2><span id="1-3-xiu-gai-kong-zhi-tai-ji-bie">1.3 修改控制台级别</span><a href="#1-3-xiu-gai-kong-zhi-tai-ji-bie" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;n&quot;</span> &gt; /proc/sys/kernel/printk</span><br><span class="line"><span class="comment">#Eg:</span></span><br><span class="line"><span class="built_in">echo</span> 8 &gt; /proc/sys/kernel/printk</span><br></pre></td></tr></table></figure>



<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/2.png" alt="img"></p>
<p>另一种方式，使用 <code>dmesg</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg -n 8</span><br></pre></td></tr></table></figure>

<p>此时所有的printk日志级别都会被输出到控制台，如下图所示:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">printk ( KERN_EMERG <span class="string">&quot;Hello, EMERG.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_ALERT <span class="string">&quot;Hello, ALERT.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_CRIT <span class="string">&quot;Hello, CRIT.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_ERR <span class="string">&quot;Hello, ERR.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_WARNING <span class="string">&quot;Hello, WARNING.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_NOTICE <span class="string">&quot;Hello, NOTICE.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_INFO <span class="string">&quot;Hello, INFO.\n&quot;</span> ) ;</span><br><span class="line">printk ( KERN_DEBUG <span class="string">&quot;Hello, DEBUG.\n&quot;</span> ) ;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/3.png" alt="img"></p>
<p>再来一种方法，修改bootargs：</p>
<p>Uboot中修改<code>console=ttyS0,115200</code>改为<code>loglevel=7 console=ttyS0,115200</code>,表示设置内核的<code>console_loglevel 值=7</code>，开机<code>cat /proc/sys/kernel/printk</code>，可以看到控制台级别被设置成了7:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/4.png" alt="img"></p>
<h2><span id="1-4-printk-dai-shi-jian-chuo-xun-xi">1.4 printk带时间戳讯息</span><a href="#1-4-printk-dai-shi-jian-chuo-xun-xi" class="header-anchor">#</a></h2><p>make menuconfig开启如下:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/5.png" alt="img"></p>
<h2><span id="1-5-printk-di-ceng-shi-xian">1.5 printk底层实现</span><a href="#1-5-printk-di-ceng-shi-xian" class="header-anchor">#</a></h2><p>源码位于<code>kernel\printk\printk.c</code>。</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/6.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">printk</span><br><span class="line">    <span class="comment">// linux 4.9: kernel/printk/internal.h</span></span><br><span class="line">    <span class="comment">// linux 5.4: kernel/printk/printk_safe.c</span></span><br><span class="line">    vprintk_func </span><br><span class="line">        <span class="title function_">vprintk_default</span><span class="params">(fmt, args)</span>;</span><br><span class="line">            vprintk_emit</span><br><span class="line">                vprintk_store <span class="comment">// 把要打印的信息保存在log_buf中</span></span><br><span class="line">                    log_output</span><br><span class="line">                <span class="title function_">preempt_disable</span><span class="params">()</span>;</span><br><span class="line">                <span class="keyword">if</span> (console_trylock_spinning())</span><br><span class="line">                    console_unlock();</span><br><span class="line">                preempt_enable();</span><br><span class="line">console_unlock</span><br><span class="line">    <span class="title function_">for</span> <span class="params">(;;)</span> &#123;</span><br><span class="line">        msg = log_from_idx(console_idx);</span><br><span class="line">        <span class="keyword">if</span> (suppress_message_printing(msg-&gt;level)) &#123;</span><br><span class="line">            <span class="comment">/* 如果消息的级别数值大于console_loglevel, 则不打印此信息 */</span></span><br><span class="line">        &#125;</span><br><span class="line">        printk_safe_enter_irqsave(flags);</span><br><span class="line">        call_console_drivers(ext_text, ext_len, text, len);</span><br><span class="line">        printk_safe_exit_irqrestore(flags);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/7.png" alt="img"></p>
<h3><span id="1-5-1-ming-ling-xing-can-shu-console">1.5.1 命令行参数console</span><a href="#1-5-1-ming-ling-xing-can-shu-console" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* IMX6ULL */</span><br><span class="line">[root@100ask:~]<span class="comment"># cat /proc/cmdline</span></span><br><span class="line">console=ttymxc0,115200 root=/dev/mmcblk1p2 rootwait rw</span><br></pre></td></tr></table></figure>

<p>命令行信息可以来自设备树或者环境变量:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">    chosen &#123;</span><br><span class="line">                bootargs = <span class="string">&quot;console=ttymxc1,115200&quot;</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>修改环境变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 进入IMX6ULL的UBOOT */</span></span><br><span class="line">=&gt; print mmcargs</span><br><span class="line">mmcargs=setenv bootargs console=$&#123;console&#125;,$&#123;baudrate&#125; root=$&#123;mmcroot&#125;</span><br><span class="line">=&gt; print console</span><br><span class="line">console=ttymxc0</span><br><span class="line">=&gt; print baudrate</span><br><span class="line">baudrate=<span class="number">115200</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-5-2-console-qu-dong-zhu-ce-guo-cheng">1.5.2 console驱动注册过程</span><a href="#1-5-2-console-qu-dong-zhu-ce-guo-cheng" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">console</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>    name[<span class="number">16</span>];  <span class="comment">// name为&quot;ttyXXX&quot;，在cmdline中用&quot;console=ttyXXX0&quot;来匹配</span></span><br><span class="line">    <span class="comment">// 输出函数</span></span><br><span class="line">    <span class="type">void</span>    (*write)(<span class="keyword">struct</span> console *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">unsigned</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span>        (*read)(<span class="keyword">struct</span> console *, <span class="type">char</span> *, <span class="type">unsigned</span>);</span><br><span class="line">    <span class="comment">// APP访问/dev/console时通过这个函数来确定是哪个(index)设备</span></span><br><span class="line">    <span class="comment">// 举例:</span></span><br><span class="line">    <span class="comment">// a. cmdline中&quot;console=ttymxc1&quot;</span></span><br><span class="line">    <span class="comment">// b. 则注册对应的console驱动时：console-&gt;index = 1</span></span><br><span class="line">    <span class="comment">// c. APP访问/dev/console时调用&quot;console-&gt;device&quot;来返回这个index</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span>  <span class="title">tty_driver</span> *(*<span class="title">device</span>)(<span class="keyword">struct</span> <span class="title">console</span> *<span class="title">co</span>, <span class="title">int</span> *<span class="title">index</span>);</span></span><br><span class="line">    <span class="type">void</span>    (*unblank)(<span class="type">void</span>);</span><br><span class="line">    <span class="comment">// 设置函数, 可设为NULL</span></span><br><span class="line">    <span class="type">int</span>        (*setup)(<span class="keyword">struct</span> console *, <span class="type">char</span> *);</span><br><span class="line">    <span class="comment">// 匹配函数, 可设为NULL</span></span><br><span class="line">    <span class="type">int</span>        (*match)(<span class="keyword">struct</span> console *, <span class="type">char</span> *name, <span class="type">int</span> idx, <span class="type">char</span> *options); </span><br><span class="line">    <span class="type">short</span>    flags;</span><br><span class="line">    <span class="comment">// 哪个设备用作console: </span></span><br><span class="line">    <span class="comment">// a. 可以设置为-1, 表示由cmdline确定</span></span><br><span class="line">    <span class="comment">// b. 也可以直接指定</span></span><br><span class="line">    <span class="type">short</span>    index;</span><br><span class="line">    <span class="comment">// 常用: CON_PRINTBUFFER</span></span><br><span class="line">    <span class="type">int</span>        cflag;</span><br><span class="line">    <span class="type">void</span>    *data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>     <span class="title">console</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4><span id="1-5-2-1-chu-li-ming-ling-xing-can-shu">1.5.2.1 处理命令行参数</span><a href="#1-5-2-1-chu-li-ming-ling-xing-can-shu" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__setup(<span class="string">&quot;console=&quot;</span>, console_setup);</span><br><span class="line">console=ttymxc0,<span class="number">115200</span>  console=ttyVIRT0</span><br></pre></td></tr></table></figure>

<p>处理u-boot通过dts传给内核的cmdline参数，比如bootparam参数。</p>
<p>对于这两个”console&#x3D;xxx”就会调用console_setup函数两次，构造得到2个数组项:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">console_cmdline</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>    name[<span class="number">16</span>];            <span class="comment">/* Name of the driver        */</span></span><br><span class="line">    <span class="type">int</span>    index;                <span class="comment">/* Minor dev. to use        */</span></span><br><span class="line">    <span class="type">char</span>    *options;            <span class="comment">/* Options for the driver   */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_A11Y_BRAILLE_CONSOLE</span></span><br><span class="line">    <span class="type">char</span>    *brl_options;            <span class="comment">/* Options for braille driver */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">console_cmdline</span> <span class="title">console_cmdline</span>[<span class="title">MAX_CMDLINECONSOLES</span>];</span></span><br></pre></td></tr></table></figure>

<p>在cmdline中，最后的”console&#x3D;xxx”就是”selected_console”(被选中的console，对应&#x2F;dev&#x2F;console)：</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/8.png" alt="img"></p>
<h4><span id="1-5-2-2-register-console">1.5.2.2 register_console</span><a href="#1-5-2-2-register-console" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uart_add_one_port</span><br><span class="line">    uart_configure_port</span><br><span class="line">        <span class="title function_">register_console</span><span class="params">(port-&gt;cons)</span>;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18203864">Linux下Uart子系统驱动 - fuzidage - 博客园 (cnblogs.com)</a></p>
<h4><span id="1-5-2-3-x2f-dev-x2f-console">1.5.2.3 &#x2F;dev&#x2F;console</span><a href="#1-5-2-3-x2f-dev-x2f-console" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">tty_open</span><br><span class="line">    tty = tty_open_by_driver(device, inode, filp);</span><br><span class="line">        driver = tty_lookup_driver(device, filp, &amp;index);</span><br><span class="line">            <span class="keyword">case</span> <span class="title function_">MKDEV</span><span class="params">(TTYAUX_MAJOR, <span class="number">1</span>)</span>: &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">console_driver</span> =</span> console_device(index);</span><br><span class="line"> </span><br><span class="line"><span class="comment">/* 从console_drivers链表头开始寻找</span></span><br><span class="line"><span class="comment"> * 如果console-&gt;device成功，就返回它对应的tty_driver</span></span><br><span class="line"><span class="comment"> * 这就是/dev/console对应的tty_driver</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">struct</span> tty_driver *<span class="title function_">console_device</span><span class="params">(<span class="type">int</span> *index)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">console</span> *<span class="title">c</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"> </span><br><span class="line">    console_lock();</span><br><span class="line">    for_each_console(c) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!c-&gt;device)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        driver = c-&gt;device(c, index);</span><br><span class="line">        <span class="keyword">if</span> (driver)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    console_unlock();</span><br><span class="line">    <span class="keyword">return</span> driver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/p/18203864">Linux下Uart子系统驱动 - fuzidage - 博客园 (cnblogs.com)</a></p>
<h2><span id="1-6-nei-he-xin-xi-de-zao-qi-da-yin">1.6 内核信息的早期打印</span><a href="#1-6-nei-he-xin-xi-de-zao-qi-da-yin" class="header-anchor">#</a></h2><p>当我们注册了uart_driver、并调用uart_add_one_port后，它里面才注册console，在这之后才能使用printk。</p>
<p>如果想更早地使用printk函数，比如在安装UART驱动之前就使用printk，这时就需要自己去注册console。</p>
<p>更早地、单独地注册console，有两种方法：</p>
<p>early_printk：自己实现write函数，不涉及设备树，简单明了</p>
<p>earlycon：通过设备树传入硬件信息，跟内核中驱动程序匹配<br>earlycon是新的、推荐的方法，在内核已经有驱动的前提下，通过设备树或cmdline指定寄存器地址即可。</p>
<h3><span id="1-6-1-early-printk">1.6.1 early_printk</span><a href="#1-6-1-early-printk" class="header-anchor">#</a></h3><p>arch\arm\kernel\early_printk.c，必须实现这几点：</p>
<ul>
<li>配置内核，选择：CONFIG_EARLY_PRINTK</li>
<li>内核中实现：printch函数</li>
<li>cmdline中添加：earlyprintk</li>
</ul>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/9.png" alt="img"></p>
<h3><span id="1-6-2-earlycon">1.6.2 earlycon</span><a href="#1-6-2-earlycon" class="header-anchor">#</a></h3><h1><span id="2-prink-h-jie-shao">2 prink.h介绍</span><a href="#2-prink-h-jie-shao" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> pr_emerg(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_EMERG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_alert(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ALERT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_crit(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_CRIT pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_err(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_ERR pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warning(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_WARNING pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_warn pr_warning</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_notice(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_NOTICE pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_info(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_INFO pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="comment">/* If you are writing a driver, please use dev_dbg instead */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_DYNAMIC_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/dynamic_debug.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* dynamic_pr_debug() uses pr_fmt() internally so we don&#x27;t need it here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        dynamic_pr_debug(fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pr_debug(fmt, ...) \</span></span><br><span class="line"><span class="meta">        no_printk(KERN_DEBUG pr_fmt(fmt), ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/10.png" alt="img"></p>
<p><code>pr_emerg到pr_info</code>都是一些基本的kernel打印函数，用来设置内核日志打印级别，可以看到它和下面这种打印本质上并无差异。</p>
<p>而<code>pr_debug</code>则有3种输出方式，当开启dynamic_debug后，则走dynamic_pr_debug流程（dynamic_debug见下一节）。当用户开启了DEBUG宏，则走printk流程，否则什么都不打印。</p>
<h1><span id="3-dmesg-ming-ling">3 dmesg命令</span><a href="#3-dmesg-ming-ling" class="header-anchor">#</a></h1><h2><span id="3-1-x2f-proc-x2f-kmsg">3.1 &#x2F;proc&#x2F;kmsg</span><a href="#3-1-x2f-proc-x2f-kmsg" class="header-anchor">#</a></h2><p><code>/proc/kmsg</code> 是一个特殊的文件，它提供了内核消息缓冲区的访问，这个缓冲区包含了内核产生的所有消息，包括各种调试和错误信息，如内核的启动打印</p>
<p><code>dmesg命令就是cat /proc/kmsg</code>。</p>
<h2><span id="3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao">3.2 修改内核日志缓冲区大小</span><a href="#3-2-xiu-gai-nei-he-ri-zhi-huan-chong-qu-da-xiao" class="header-anchor">#</a></h2><p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/11.png" alt="img"></p>
<h2><span id="3-3-dmesg">3.3 dmesg</span><a href="#3-3-dmesg" class="header-anchor">#</a></h2><p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/12.png" alt="img"></p>
<p>dmesg命令是从kernel ring buffer中读取内核日志信息。因此可以用dmesg命令查看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-C:  直接清除ring buffer</span><br><span class="line">-c： 当完成打印显示后清除环缓冲内的内容。</span><br><span class="line">-s： 缓冲区大小</span><br><span class="line">　	定义一个大小为&quot;缓冲区大小&quot;的缓冲区用于查询内核环缓冲区。默认大小为 8196，如果你设置了一个大于默认值的环缓冲区，那你就可以用这个选项定义一个相当的缓冲区来查看完整的环缓冲区内容。</span><br><span class="line"></span><br><span class="line">-n：级别</span><br><span class="line"></span><br><span class="line">dmesg -k：打印内核信息</span><br><span class="line">dmesg -u：打印用户空间信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其实用dmesg -n也是可以设置控制台打印级别:</p>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/13.png" alt="img"></p>
<p>有时候在调试kernel驱动时内核panic了or死锁了，那么无法敲命令，如何查看日志呢？重启后日志就没了，那么可以敲如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kmsg &gt; /mnt/data/ker.log &amp; 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p> 用后台进程将日志导入到文件。</p>
<ol>
<li>dmesg -f：根据系统打印信息:</li>
</ol>
<p>可用系统有</p>
<pre><code>kern - kernel messages（内核信息）
user - random user-level messages（随机用户信息）
mail - mail system（邮件系统信息）
daemon - system daemons（系统守护进程信息）
auth - security/authorization messages（认证授权安全信息）
syslog - messages generated internally by syslogd（系统日志信息）
lpr - line printer subsystem（打印机信息）
news - network news subsystem（网络系统信息）
</code></pre>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/14.png" alt="img"></p>
<ol start="2">
<li>dmesg -l：根据level来打印信息:</li>
</ol>
<p>   可用的level信息有</p>
<pre><code>   emerg - system is unusable（系统无法使用）
      alert - action must be taken immediately
       crit - critical conditions（临界条件）
        err - error conditions（错误条件）
       warn - warning conditions（警告条件）
     notice - normal but significant condition
       info - informational
      debug - debug-level messages（debug）
</code></pre>
<p><img src="/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/15.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/07/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-printk%E5%92%8Cdemsg/" data-id="cm0xxogdt000fqsuf6j5l8mgu" data-title="Linux日志管理-printk和demsg" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux日志管理-syslog和rsyslog" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/" class="article-date">
  <time class="dt-published" datetime="2024-06-02T10:13:09.000Z" itemprop="datePublished">2024-06-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/">Linux日志管理-syslog和rsyslog</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-syslogd-jian-jie">1 syslogd简介</a><ul>
<li><a href="#1-1-ri-zhi-ge-shi">1.1 日志格式</a></li>
<li><a href="#1-2-etc-syslog-conf-fu-wu-pei-zhi">1.2 &#x2F;etc&#x2F;syslog.conf服务配置</a><ul>
<li><a href="#1-2-1-zong-pei-zhi-etc-syslog-conf">1.2.1 总配置&#x2F;etc&#x2F;syslog.conf</a></li>
<li><a href="#1-2-2-rsyslog-gui-ze-etc-rsyslog-d-conf">1.2.2 rsyslog规则（&#x2F;etc&#x2F;rsyslog.d&#x2F;*.conf）</a><ul>
<li><a href="#1-2-2-1-facility-ri-zhi-lei-xing">1.2.2.1 facility-日志类型</a></li>
<li><a href="#1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu">1.2.2.2 level-按严重程度由低到高排序</a></li>
<li><a href="#1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi">1.2.2.3 action-表示log保存的位置</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze">1.3 程序如何配置syslog子服务(自定义rsyslog规则)</a></li>
</ul>
</li>
<li><a href="#2-syslog-han-shu">2 syslog()函数</a><ul>
<li><a href="#2-1-openlog-han-shu">2.1 openlog函数</a></li>
<li><a href="#2-2-syslog-han-shu">2.2 syslog函数</a></li>
<li><a href="#2-3-chong-ding-xiang-log">2.3 重定向log</a><ul>
<li><a href="#2-3-1-fang-fa-1-xiu-gai-rsyslog-conf">2.3.1 方法1-修改rsyslog.conf</a></li>
<li><a href="#2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility">2.3.2 方法2-修改code中的facility</a></li>
</ul>
</li>
<li><a href="#2-4-she-zhi-log-deng-ji">2.4 设置log等级</a></li>
<li><a href="#2-5-chong-ding-xiang-log-dao-console">2.5 重定向log到console</a></li>
</ul>
</li>
<li><a href="#3-dup-han-shu-jie-shao">3 dup函数介绍</a></li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-syslogd-jian-jie">1 syslogd简介</span><a href="#1-syslogd-jian-jie" class="header-anchor">#</a></h1><p>syslogd不仅仅是记录kernel log的服务，还能记录user space中的日志。</p>
<p>syslogd是Linux下的一个记录日志文件服务。新版本叫做rsyslogd。</p>
<p>syslogd有一系列的子服务，例如mail、auth、cron、kern等等，这些子服务提供日志记录的功能,。当程序要记录log时,可以直接调用这些子服务将日志记录到设定的地方。</p>
<p><strong>syslogd</strong>是一个守护进程，配置这整个守护进程以及其子服务的地方就是&#x2F;etc&#x2F;syslog.conf这个文件。可以从<a target="_blank" rel="noopener" href="https://www.rsyslog.com/doc/master/%E8%8E%B7%E5%8F%96%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E3%80%82">https://www.rsyslog.com/doc/master/获取官方文档。</a></p>
<h2><span id="1-1-ri-zhi-ge-shi">1.1 日志格式</span><a href="#1-1-ri-zhi-ge-shi" class="header-anchor">#</a></h2><p>如果配置好并运行了 syslogd 或 klogd，一般所有 log的信息也会追加到<code> /var/log/messages</code>。并且kernel log信息被记录在<code>/val/log/kern.log</code>。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/1.png" alt="img"></p>
<p>可以看到基本日志格式包含以下四列:</p>
<ol>
<li>事件产生的时间(Jan 1 08:00:09)</li>
<li>发生事件的服务器的主机名 (cvitek)</li>
<li>产生事件的服务名或程序名 (kernel or local5)</li>
<li>事件的具体信息(…cif a0c2000.cif:..)</li>
</ol>
<p>当开启rsyslogd后，不能透过&#x2F;proc&#x2F;kmsg来查看kernel log。</p>
<h2><span id="1-2-x2f-etc-x2f-syslog-conf-fu-wu-pei-zhi">1.2 &#x2F;etc&#x2F;syslog.conf服务配置</span><a href="#1-2-x2f-etc-x2f-syslog-conf-fu-wu-pei-zhi" class="header-anchor">#</a></h2><ol>
<li>&#x2F;etc&#x2F;rsyslog.conf 是rsyslog服务的总配置文件</li>
<li>&#x2F;etc&#x2F;rsyslog.d 该目录是单独配置的rsyslog配置文件</li>
</ol>
<h3><span id="1-2-1-zong-pei-zhi-x2f-etc-x2f-syslog-conf">1.2.1 总配置&#x2F;etc&#x2F;syslog.conf</span><a href="#1-2-1-zong-pei-zhi-x2f-etc-x2f-syslog-conf" class="header-anchor">#</a></h3><p>rsyslog记录哪些日志，到底记录了什么样的日志，是通过这个<code>/etc/rsyslog.conf</code>配置文件来决定的，先分析一下rsyslogd的总配置文件：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/2.png" alt="img"></p>
<p>默认规则会定义在<code>/etc/rsyslog.d/50-default.conf</code>中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#################</span></span><br><span class="line"><span class="comment">#### MODULES ####</span></span><br><span class="line"><span class="comment">#################</span></span><br><span class="line">module(load=<span class="string">&quot;imuxsock&quot;</span>) <span class="comment"># provides support for local system logging   ；加载提供对本地系统日志的支持</span></span><br><span class="line">module(load=<span class="string">&quot;imklog&quot;</span>)   <span class="comment"># provides kernel logging support；加载读取内核消息模块</span></span><br><span class="line"><span class="comment">#module(load=&quot;immark&quot;)  # provides --MARK-- message capability</span></span><br><span class="line"><span class="comment"># provides UDP syslog reception  （接收使用UDP 协议转发过来的日志，这里#注释掉了表示不启用）</span></span><br><span class="line"><span class="comment">#module(load=&quot;imudp&quot;)</span></span><br><span class="line"><span class="comment">#input(type=&quot;imudp&quot; port=&quot;514&quot;)  （允许514端口接收）</span></span><br><span class="line"><span class="comment"># provides TCP syslog reception （接收使用UDP 协议转发过来的日志）</span></span><br><span class="line"><span class="comment">#module(load=&quot;imtcp&quot;)</span></span><br><span class="line"><span class="comment">#input(type=&quot;imtcp&quot; port=&quot;514&quot;)（允许514端口接收）</span></span><br><span class="line"><span class="comment"># Enable non-kernel facility klog messages</span></span><br><span class="line"><span class="variable">$KLogPermitNonKernelFacility</span> on</span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment">#### GLOBAL DIRECTIVES ####</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Use traditional timestamp format.</span></span><br><span class="line"><span class="comment"># To enable high precision timestamps, comment out the following line.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$ActionFileDefaultTemplate</span> RSYSLOG_TraditionalFileFormat</span><br><span class="line"><span class="comment"># Filter duplicated messages</span></span><br><span class="line"><span class="variable">$RepeatedMsgReduction</span> on</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Set the default permissions for all log files.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$FileOwner</span> syslog</span><br><span class="line"><span class="variable">$FileGroup</span> adm</span><br><span class="line"><span class="variable">$FileCreateMode</span> 0640</span><br><span class="line"><span class="variable">$DirCreateMode</span> 0755</span><br><span class="line"><span class="variable">$Umask</span> 0022</span><br><span class="line"><span class="variable">$PrivDropToUser</span> syslog</span><br><span class="line"><span class="variable">$PrivDropToGroup</span> syslog</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Where to place spool and state files</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$WorkDirectory</span> /var/spool/rsyslog</span><br><span class="line">(记录所有日志类型的info级别以及大于info级别的信息到/var/log/messages,但是mail邮件信息,authpriv验证方面的信息和cron时间任务相关的信息除外)</span><br><span class="line"><span class="comment">#*.info;mail.none;authpriv.none;cron.none    /var/log/messages</span></span><br><span class="line"><span class="comment"># Include all config files in /etc/rsyslog.d/ </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="variable">$IncludeConfig</span> /etc/rsyslog.d/*.conf  （表示加载该目录中的所有配置）</span><br></pre></td></tr></table></figure>

<h3><span id="1-2-2-rsyslog-gui-ze-x2f-etc-x2f-rsyslog-d-x2f-conf">1.2.2 rsyslog规则（&#x2F;etc&#x2F;rsyslog.d&#x2F;*.conf）</span><a href="#1-2-2-rsyslog-gui-ze-x2f-etc-x2f-rsyslog-d-x2f-conf" class="header-anchor">#</a></h3><p>rsyslog规则配置文件一般由以下3部分组成，每一行表示一个项目，格式为：facility.level action，分别表示日志类型，日志等级，日志输出路径。一般系统默认的规则定义在<code>/etc/rsyslog.d/50-default.conf</code>：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/3.png" alt="img"></p>
<p>一般所有日志类型都会被追加在<code>/val/log/messages</code>。如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.info;mail.none;authpriv.none;cron.none    /var/log/messages  </span><br></pre></td></tr></table></figure>

<h4><span id="1-2-2-1-facility-ri-zhi-lei-xing">1.2.2.1 facility-日志类型</span><a href="#1-2-2-1-facility-ri-zhi-lei-xing" class="header-anchor">#</a></h4><ul>
<li>kern: 内核信息</li>
<li>user: 用户进程相关信息</li>
<li>mail: 电子邮件相关信息</li>
<li>Local0- local7: 为本地使用预留的服务</li>
<li>daemon: 后台进程相关信息</li>
<li>syslog: 系统日志信息</li>
</ul>
<h4><span id="1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu">1.2.2.2 level-按严重程度由低到高排序</span><a href="#1-2-2-2-level-an-yan-chong-cheng-du-you-di-dao-gao-pai-xu" class="header-anchor">#</a></h4><ul>
<li>none: 没有重要级</li>
<li>debug: 调试信息</li>
<li>info: 打印的信息</li>
<li>notice: 具有重要信息的普通条件</li>
<li>warning: 警告信息</li>
<li>err: 错误信息</li>
<li>crit: 阻止某些工具或子系统功能实现的错误条件</li>
<li>alert: 需要立即被修改的条件</li>
<li>emerg: 该系统不可用</li>
</ul>
<h4><span id="1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi">1.2.2.3 action-表示log保存的位置</span><a href="#1-2-2-3-action-biao-shi-log-bao-cun-de-wei-zhi" class="header-anchor">#</a></h4><p>那下面我也抄过来一份比较全面的规则定义示例供大家参考:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录mail日志等级为error及以上日志</span></span><br><span class="line">mail.err                                                        /var/log/mail_err.log</span><br><span class="line"><span class="comment"># 记录mail所有等级为warn级别的日志（仅记录warn级别）</span></span><br><span class="line">mail.=warn                                                        /var/log/mail_err.log</span><br><span class="line"><span class="comment"># 记录kern所有日志</span></span><br><span class="line">kern.*                                                                /var/log/kern.log</span><br><span class="line"><span class="comment"># 将mail的所有信息，除了info以外，其他的都写入/var/adm/mail</span></span><br><span class="line">mail.*;mail.!=info   /var/adm/mail</span><br><span class="line"><span class="comment"># 将日志等级为crit或更高的内核消息定向到远程主机finlandia</span></span><br><span class="line"><span class="comment"># 如果主机崩溃，磁盘出现不可修复的错误，可能无法读取存储的消息。如果有日志在远程主机上，可以尝试找出崩溃的原因。</span></span><br><span class="line">kern.crit                                                     @finlandia</span><br><span class="line"><span class="comment"># 记录所有类型的warning等级及以上日志</span></span><br><span class="line">*.warning                                                        /var/log/syslog_warn.log</span><br><span class="line"><span class="comment"># 记录mail的warning日志和kern的error日志,其他所有的info日志</span></span><br><span class="line">*.info;mail.warning;kern.error                /var/log/messages</span><br><span class="line"><span class="comment"># 记录kernel的info到warning日志</span></span><br><span class="line">kern.info;kern.!err   /var/adm/kernel-info</span><br><span class="line"><span class="comment"># 将mail和news的info级别日志写入/var/adminfo</span></span><br><span class="line">mail,news.=info    /var/adm/info</span><br><span class="line"><span class="comment"># 将所有系统中所有类型的info日志和notice日志存入/var/log/massages,mail的所有日志除外。</span></span><br><span class="line">*.=info;*.=notice;\</span><br><span class="line">mail.none /var/log/messages</span><br><span class="line"><span class="comment"># 紧急消息（emerg级别）将使用wall显示给当前所有登录的用户，这里用等号表示只对emerg日志级别有效</span></span><br><span class="line">*.=emerg                   *</span><br><span class="line"><span class="comment"># 该规则将所有alert以及更高级别的消息定向到操作员的终端，即登录的用户“root”和“joey”的终端。</span></span><br><span class="line">*.alert      root,joey</span><br></pre></td></tr></table></figure>

<h2><span id="1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze">1.3 程序如何配置syslog子服务(自定义rsyslog规则)</span><a href="#1-3-cheng-xu-ru-he-pei-zhi-syslog-zi-fu-wu-zi-ding-yi-rsyslog-gui-ze" class="header-anchor">#</a></h2><p><strong>问题：进程如何发送消息给rsyslog守护进程，rsyslog守护进程是如何对各种日志区分开来的？</strong></p>
<p>像<code>/usr/sbin/sshd、/usr/bin/login、/usr/bin/su</code>这些进程，它们是调用一个叫syslog的系统调用, syslog系统调用是一个用于向rsyslog守护进程发送消息的的系统函数。<br><code>/usr/sbin/sshd,/usr/bin/login、/usr/bin/su</code>这些进程专门执行登录验证时，它们在调用syslog系统函数会一般会传入<code>LOG_AUTH</code>这个常量。</p>
<p>而<code>/usr/bin/crond和/usr/bin/at</code>这些在调用syslog系统调用会传入<code>LOG_CRON</code>这个常量（具体请看**syslog()**函数），日志归类规则如下：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/4.png" alt="img"></p>
<p>所以如果用<code>LOG_AUTH</code>的syslog()函数调用，那么会归类到了<code>/val/log/secure</code>。</p>
<p>如果用<code>LOG_CRON</code>的syslog()调用则归类到了<code>/val/log/cron</code>。而kernel等其他log被记录在了<code>/val/log/messages</code>中。</p>
<p>那么我们可以自定义规则如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/5.png" alt="img"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syslogfacility-text：表示facility日志类型</span><br><span class="line">syslogseverity-text：表示level日志级别</span><br><span class="line"></span><br><span class="line">这里对aisdk.conf用local7日志类型产生的大于warn日志级别的<span class="built_in">log</span>都将记录到/val/log/aisdk，</span><br><span class="line">对kern.conf用kern类型产生的所有级别日志都记录到/val/log/kern，</span><br><span class="line">Local5类型的日志记录到/val/log/middleware, 并且当日志级别等于或高于4（warn）时也会追加到console.</span><br></pre></td></tr></table></figure>

<p>注意busybox要开启使能syslog.conf解析：<code>/etc/syslog.conf</code>解析，<code>CONFIG_FEATURE_SYSLOGD_CFG=y</code></p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/5-1.png" alt="img"></p>
<h1><span id="2-syslog-han-shu">2 syslog()函数</span><a href="#2-syslog-han-shu" class="header-anchor">#</a></h1><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/6.png" alt="img"></p>
<p>用户空间也可以用syslog()函数来记录自己的进程的日志，所以用户进程可以自定义日志规则。<br>调用openlog是可选择的。如果不调用openlog，则在第一次调用syslog时，会自动调用openlog。<br>syslog的相关函数和宏定义一般在toolchain中都会有定义:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/7.png" alt="img"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">openlog</span> <span class="params">(<span class="type">char</span>*ident,<span class="type">int</span> option ,<span class="type">int</span> facility)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority,<span class="type">char</span>*format,……)</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">closelog</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>



<h2><span id="2-1-openlog-han-shu">2.1 openlog函数</span><a href="#2-1-openlog-han-shu" class="header-anchor">#</a></h2><p>第1个参数为ident，该参数常用来表示信息的来源。ident信息会被固定地添加在每行日志的前面：<br>第2个参数 option控制标志:</p>
<table>
<thead>
<tr>
<th>option控制标志</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_CONS</td>
<td>如果将信息发送给syslogd守护进程时发生错误，直接将相关信息输出到终端</td>
</tr>
<tr>
<td>LOG_PID</td>
<td>每条日志信息中都包括进程号</td>
</tr>
</tbody></table>
<p>第3个参数为facility：</p>
<table>
<thead>
<tr>
<th>facility参数</th>
<th>syslog.conf中对应的facility取值</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_KERN</td>
<td>kern</td>
</tr>
<tr>
<td>LOG_USER</td>
<td>user</td>
</tr>
<tr>
<td>LOG_MAIL</td>
<td>mail</td>
</tr>
<tr>
<td>LOG_DAEMON</td>
<td>daemon</td>
</tr>
<tr>
<td>LOG_AUTH</td>
<td>auth</td>
</tr>
<tr>
<td>LOG_SYSLOG</td>
<td>syslog</td>
</tr>
<tr>
<td>LOG_LPR</td>
<td>lpr</td>
</tr>
<tr>
<td>LOG_NEWS</td>
<td>news</td>
</tr>
<tr>
<td>LOG_UUCP</td>
<td>uucp</td>
</tr>
<tr>
<td>LOG_CRON</td>
<td>cron</td>
</tr>
<tr>
<td>LOG_AUTHPRIV</td>
<td>authpriv</td>
</tr>
<tr>
<td>LOG_FTP</td>
<td>ftp</td>
</tr>
<tr>
<td>LOG_LOCAL0～LOG_LOCAL7</td>
<td>local0～local7</td>
</tr>
</tbody></table>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/8.png" alt="img"></p>
<h2><span id="2-2-syslog-han-shu">2.2 syslog函数</span><a href="#2-2-syslog-han-shu" class="header-anchor">#</a></h2><p>第一个参数priority表示日志级别：</p>
<table>
<thead>
<tr>
<th>priority参数</th>
<th>syslog.conf中对应的level取值</th>
</tr>
</thead>
<tbody><tr>
<td>LOG_EMERG</td>
<td>emerg</td>
</tr>
<tr>
<td>LOG_ALERT</td>
<td>alert</td>
</tr>
<tr>
<td>LOG_CRIT</td>
<td>crit</td>
</tr>
<tr>
<td>LOG_ERR</td>
<td>err</td>
</tr>
<tr>
<td>LOG_WARNING</td>
<td>warning</td>
</tr>
<tr>
<td>LOG_NOTICE</td>
<td>notice</td>
</tr>
<tr>
<td>LOG_INFO</td>
<td>info</td>
</tr>
<tr>
<td>LOG_DEBUG</td>
<td>debug</td>
</tr>
</tbody></table>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/9.png" alt="img"></p>
<p>下面是具体的例子：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/10.png" alt="img"></p>
<p>这里<code>printf(&quot;%m&quot;)等价于printf(&quot;%s&quot;,strerror(errno));</code>它表示把errno用string形式打印出来。</p>
<p>由于我这里facility为user时，是记录在&#x2F;val&#x2F;log&#x2F;syslog中的:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/11.png" alt="img"></p>
<p>因此打印log如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/12.png" alt="img"></p>
<h2><span id="2-3-chong-ding-xiang-log">2.3 重定向log</span><a href="#2-3-chong-ding-xiang-log" class="header-anchor">#</a></h2><p>我们也可以把log定向到自己想要的地方。</p>
<h3><span id="2-3-1-fang-fa-1-xiu-gai-rsyslog-conf">2.3.1 方法1-修改rsyslog.conf</span><a href="#2-3-1-fang-fa-1-xiu-gai-rsyslog-conf" class="header-anchor">#</a></h3><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/13.png" alt="img"></p>
<p>将<code>facility=user</code>时的所有level级别的log重定向到<code>/val/log/user.log</code>, 重启rsyslog服务:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/14.png" alt="img"></p>
<p>此时log将被写入到新配置的位置&#x2F;val&#x2F;log&#x2F;user.log, 当然&#x2F;val&#x2F;log&#x2F;syslog也会保留一份.（因为也符合&#x2F;val&#x2F;log&#x2F;syslog这条规则）</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/15.png" alt="img"></p>
<h3><span id="2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility">2.3.2 方法2-修改code中的facility</span><a href="#2-3-2-fang-fa-2-xiu-gai-code-zhong-de-facility" class="header-anchor">#</a></h3><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/16.png" alt="img"></p>
<p>那这里的facility被设置成了local0, 那也会记录在<code>/val/log/syslog</code>:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/17.png" alt="img"></p>
<h2><span id="2-4-she-zhi-log-deng-ji">2.4 设置log等级</span><a href="#2-4-she-zhi-log-deng-ji" class="header-anchor">#</a></h2><ol>
<li>这里新增一个app.conf，然后自定义log路径:</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/18.png" alt="img"></p>
<p>当然还可以类似于这样子写， syslogfacility-text和syslogseverity-text是rsyslog自带的系统变量。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/19.png" alt="img"></p>
<ol start="2">
<li><p>重启rsyslog服务</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/20.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/21.png" alt="img"></p>
<p>这里切成4个文件，每个文件记录1024k。</p>
<ol start="3">
<li><p>运行程序,查看log如下:</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/22.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/23.png" alt="img"></p>
<ol start="4">
<li><p>那现在修改log等级为warn, 表示只有大于等于该等级的log才会记录。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/24.png" alt="img"></p>
</li>
<li><p>再次重启rsyslog服务，运行程序，可以看到”log debug”不再打印：</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/25.png" alt="img"></p>
</li>
</ol>
<h2><span id="2-5-chong-ding-xiang-log-dao-console">2.5 重定向log到console</span><a href="#2-5-chong-ding-xiang-log-dao-console" class="header-anchor">#</a></h2><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/26.png" alt="img"></p>
<p>再次重启rsyslog服务，运行程序，那么可以看到err级别的log打印在了console上，但是低于err级别还是会记录在&#x2F;val&#x2F;log&#x2F;app。</p>
<p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/27.png" alt="img"></p>
<h1><span id="3-dup-han-shu-jie-shao">3 dup函数介绍</span><a href="#3-dup-han-shu-jie-shao" class="header-anchor">#</a></h1><p><img src="/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/28.png" alt="img"></p>
<p>用来将标准输出重定向到文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> dup_fd;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> dup_fd_bak = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dup_fd</span><span class="params">(<span class="type">void</span>)</span>  &#123;</span><br><span class="line">    dup_fd = open( <span class="string">&quot;./printf_dup_log.txt &quot;</span>, O_CREAT | O_RDWR | O_TRUNC);</span><br><span class="line">    dup2(STDOUT_FILENO, dup_fd_bak);<span class="comment">/*backup stdout*/</span></span><br><span class="line">    dup2(dup_fd, STDOUT_FILENO);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">rst_fd</span><span class="params">(<span class="type">void</span>)</span>  &#123;</span><br><span class="line">    dup2(dup_fd_bak, fileno(<span class="built_in">stdout</span>));<span class="comment">/*recover stdout*/</span></span><br><span class="line">    close(dup_fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/06/02/Linux%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86-syslog%E5%92%8Crsyslog/" data-id="cm0xxogdu000jqsufgfupdcqn" data-title="Linux日志管理-syslog和rsyslog" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-tslib移植使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T15:59:59.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/">tslib移植使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-huo-qu-tslib-yuan-ma">1 获取 tslib 源码</a></li>
<li><a href="#2-xiu-gai-tslib-yuan-ma-suo-shu-yong-hu">2 修改 tslib 源码所属用户</a></li>
<li><a href="#3-ubuntu-gong-ju-an-zhuang">3 ubuntu 工具安装</a></li>
<li><a href="#4-bian-yi-tslib">4 编译 tslib</a></li>
<li><a href="#5-pei-zhi-tslib">5 配置 tslib</a></li>
<li><a href="#6-tslib-ce-shi">6 tslib 测试</a><ul>
<li><a href="#6-1-ts-test-mt">6.1 ts_test_mt</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-huo-qu-tslib-yuan-ma">1 获取 tslib 源码</span><a href="#1-huo-qu-tslib-yuan-ma" class="header-anchor">#</a></h1><p><a target="_blank" rel="noopener" href="https://github.com/libts/tslib">https://github.com/libts/tslib</a><br>git clone <a target="_blank" rel="noopener" href="https://github.com/libts/tslib.git">https://github.com/libts/tslib.git</a></p>
<h1><span id="2-xiu-gai-tslib-yuan-ma-suo-shu-yong-hu">2 修改 tslib 源码所属用户</span><a href="#2-xiu-gai-tslib-yuan-ma-suo-shu-yong-hu" class="header-anchor">#</a></h1><p><code>sudo chown book:book tslib-1.21 -R</code><br>这一步一定要做！否则在稍后的编译中会遇到各种问题。</p>
<h1><span id="3-ubuntu-gong-ju-an-zhuang">3 ubuntu 工具安装</span><a href="#3-ubuntu-gong-ju-an-zhuang" class="header-anchor">#</a></h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install autoconf</span><br><span class="line">sudo apt-get install automake</span><br><span class="line">sudo apt-get install libtool</span><br></pre></td></tr></table></figure>
<h1><span id="4-bian-yi-tslib">4 编译 tslib</span><a href="#4-bian-yi-tslib" class="header-anchor">#</a></h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd tslib<span class="number">-1.21</span>/ <span class="comment">//进入 tslib 源码目录</span></span><br><span class="line">./autogen.sh</span><br><span class="line">./configure --host=arm-linux-gnueabihf --prefix=/home/zuozhongkai/linux/IMX6ULL/tool/tslib</span><br><span class="line">make <span class="comment">//编译</span></span><br><span class="line">make install <span class="comment">//安装</span></span><br></pre></td></tr></table></figure>
<p><code>“--host”</code>参数指定编译器，<code>“--prefix”</code>参数指定编译完成以后的 tslib 文件安装到哪里.<br>完成以后 tslib 目录下的内容如下：<br><img src="/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/1.png" alt="image"><br>把所有文件拷贝到开发板的根文件系统中：<br><code>sudo cp * -rf /home/zuozhongkai/linux/nfs/rootfs</code></p>
<h1><span id="5-pei-zhi-tslib">5 配置 tslib</span><a href="#5-pei-zhi-tslib" class="header-anchor">#</a></h1><p>打开<code>/etc/ts.conf</code> 文件，找到下面这一行：<br><code>module_raw input</code><br>打开<code>/etc/profile </code>文件，在里面加入如下内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TSLIB_TSDEVICE=/dev/input/event1</span><br><span class="line"><span class="built_in">export</span> TSLIB_CALIBFILE=/etc/pointercal</span><br><span class="line"><span class="built_in">export</span> TSLIB_CONFFILE=/etc/ts.conf</span><br><span class="line"><span class="built_in">export</span> TSLIB_PLUGINDIR=/lib/ts</span><br><span class="line"><span class="built_in">export</span> TSLIB_CONSOLEDEVICE=none</span><br><span class="line"><span class="built_in">export</span> TSLIB_FBDEVICE=/dev/fb0</span><br></pre></td></tr></table></figure>
<p><code>TSLIB_TSDEVICE</code> 表示触摸设备文件，这里设置为<code>/dev/input/event1</code>，这个要根据具体情况设置，如果你的触摸设备文件为 event2 那么就应该设置为<code>/dev/input/event2</code>，以此类推。<br><code>TSLIB_CALIBFILE</code> 表示校准文件，如果进行屏幕校准的话校准结果就保存在这个文件中，这里设置校准文件为&#x2F;etc&#x2F;pointercal，此文件可以不存在，校准的时候会自动生成。<br><code>TSLIB_CONFFILE </code>表示触摸配置文件，文件为<code>/etc/ts.conf</code>，此文件在移植 tslib 的时候会生成。<br><code>TSLIB_PLUGINDIR </code>表示 tslib 插件目录位置，目录为&#x2F;lib&#x2F;ts。<br><code>TSLIB_CONSOLEDEVICE </code>表示控制台设置，这里不设置，因此为 none。<br><code>TSLIB_FBDEVICE </code>表示 FB 设备，也就是屏幕，根据实际情况配置，我的屏幕文件为<code>/dev/fb0</code>，因此这里设置为<code>/dev/fb0</code>。</p>
<h1><span id="6-tslib-ce-shi">6 tslib 测试</span><a href="#6-tslib-ce-shi" class="header-anchor">#</a></h1><p>一般电容屏可以不用校准，如果是电阻屏就要先进行校准。<br>输入<code>ts_calibrate</code><br>校准完成以后如果不满意，或者不小心对电容屏做了校准，那么直接删除掉<code>/etc/pointercal</code>文件即可。</p>
<h2><span id="6-1-ts-test-mt">6.1 ts_test_mt</span><a href="#6-1-ts-test-mt" class="header-anchor">#</a></h2><p>此命令会打开一个触摸测试界面：<br><img src="/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/2.png" alt="image"><br>Drag：拖拽按钮，默认就是此功能，大家可以看到屏幕中间有一个十字光标，我们可以通过触摸屏幕来拖拽此光标。一个触摸点一个十字光标，对于 5 点电容触摸屏，如果 5 个手指都放到屏幕上，那么就有 5 个光标，一个手指一个。<br>Draw：绘制按钮，按下此按钮我们就可以在屏幕上进行简单的绘制，可以通过此功能检测多点触摸工作是否正常。<br>Quit：退出按钮，退出 ts_test_mt 测试软件。<br>点击“Draw”按钮，使用绘制功能，5 个手指一起划过屏幕，如果多点电容屏工作正常的话就会在屏幕上留下 5 条线：<br><img src="/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/3.png" alt="image"><br>可以看到有5条横线。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/tslib%E7%A7%BB%E6%A4%8D%E4%BD%BF%E7%94%A8/" data-id="cm0xxoge3002cqsuff0xj4qgm" data-title="tslib移植使用" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-linux基本命令集合" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T11:03:01.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/">linux基本命令集合</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-qian-yan-can-kao-zi-liao">1 前言-参考资料</a></li>
<li><a href="#2-linux-ming-ling">2 linux 命令</a><ul>
<li><a href="#1-1-ci-pan-xiang-guan">1.1 磁盘相关</a><ul>
<li><a href="#1-1-1-fdisk">1.1.1 fdisk</a><ul>
<li><a href="#1-1-1-1-cha-kan-fen-qu">1.1.1.1 查看分区</a></li>
<li><a href="#1-1-1-2-shan-chu-fen-qu">1.1.1.2 删除分区</a></li>
<li><a href="#1-1-1-3-chuang-jian-fen-qu">1.1.1.3 创建分区</a></li>
</ul>
</li>
<li><a href="#1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs">1.1.2 磁盘格式化命令-mkfs</a><ul>
<li><a href="#1-1-2-1-mount">1.1.2.1 mount</a></li>
</ul>
</li>
<li><a href="#1-1-3-du">1.1.3 du</a></li>
<li><a href="#1-1-4-df">1.1.4 df</a></li>
</ul>
</li>
<li><a href="#1-2-wen-jian-zi-fu-cao-zuo-ming-ling">1.2 文件字符操作命令</a><ul>
<li><a href="#1-2-1-xargs">1.2.1 xargs</a></li>
<li><a href="#1-2-1-find">1.2.1 find</a><ul>
<li><a href="#tong-pei-fu">通配符</a></li>
<li><a href="#ban-sui-zhi-xing-ren-wu">伴随执行任务</a></li>
</ul>
</li>
<li><a href="#1-2-2-grep">1.2.2 grep</a><ul>
<li><a href="#uniq-shan-chu-chong-fu-xing">uniq 删除重复行</a></li>
<li><a href="#tr-zi-fu-chuan-ti-huan">tr字符串替换</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#1-2-awk-shu-ju-liu-chu-li">1.2 awk数据流处理</a></li>
<li><a href="#1-3-wang-luo-ming-ling">1.3 网络命令</a></li>
</ul>
</li>
<li><a href="#3-shell-jiao-ben-ming-ling">3 shell脚本命令</a><ul>
<li><a href="#3-1-jie-shi-qi">3.1 解释器</a></li>
<li><a href="#3-2-duan-dai-ma-zhu-shi">3.2 段代码注释</a></li>
<li><a href="#3-3-read-ming-ling">3.3 read命令</a></li>
<li><a href="#3-4-test-ming-ling">3.4 test命令</a><ul>
<li><a href="#3-4-1-wen-jian-ce-shi">3.4.1 文件测试</a></li>
<li><a href="#3-4-2-bi-jiao-ce-shi">3.4.2 比较测试</a></li>
<li><a href="#3-4-3-duo-chong-tiao-jian-ce-shi">3.4.3 多重条件测试</a></li>
</ul>
</li>
<li><a href="#3-5-ming-ling-xing-can-shu">3.5 命令行参数</a></li>
<li><a href="#3-6-tiao-jian-yu-ju">3.6 条件语句</a></li>
<li><a href="#3-7-case-yu-ju">3.7 case语句</a></li>
<li><a href="#3-8-han-shu">3.8 函数</a></li>
<li><a href="#3-9-xun-huan-yu-ju">3.9 循环语句</a></li>
<li><a href="#3-9-shu-zu">3.9 数组</a></li>
<li><a href="#3-10-typeset-huo-zhe-declare">3.10 typeset或者declare</a></li>
<li><a href="#3-11-unset">3.11 unset</a></li>
<li><a href="#3-12-readonly">3.12 readonly</a></li>
<li><a href="#3-13-sed">3.13 sed</a><ul>
<li><a href="#3-13-1-mu-lu-di-gui-ti-huan-zi-fu">3.13.1 目录递归替换字符</a></li>
<li><a href="#3-13-2-qu-diao-yi-xing-zhong-duo-yu-de-kong-ge">3.13.2 去掉一行中多余的空格</a></li>
</ul>
</li>
<li><a href="#3-14-shell-jiao-ben-ru-he-cha-kan-jiang-yao-zhi-xing-de-ming-ling">3.14 shell脚本如何查看将要执行的命令</a></li>
<li><a href="#3-15-zi-fu-chuan-zhong-ti-huan-yi-ge-zi-fu">3.15 字符串中替换一个字符</a></li>
<li><a href="#3-16-suan-shu-yun-suan-fu">3.16 算数运算符</a></li>
<li><a href="#3-17-chong-ding-xiang">3.17 重定向</a><ul>
<li><a href="#3-17-1-bao-cun-log-dao-wen-ben">3.17.1 保存log到文本</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-qian-yan-can-kao-zi-liao">1 前言-参考资料</span><a href="#1-qian-yan-can-kao-zi-liao" class="header-anchor">#</a></h1><p>正点原子：<a target="_blank" rel="noopener" href="http://www.openedv.com/docs/boards/arm-linux/zdyz-i.mx6ull.html">http://www.openedv.com/docs/boards/arm-linux/zdyz-i.mx6ull.html</a></p>
<h1><span id="2-linux-ming-ling">2 linux 命令</span><a href="#2-linux-ming-ling" class="header-anchor">#</a></h1><h2><span id="1-1-ci-pan-xiang-guan">1.1 磁盘相关</span><a href="#1-1-ci-pan-xiang-guan" class="header-anchor">#</a></h2><h3><span id="1-1-1-fdisk">1.1.1 fdisk</span><a href="#1-1-1-fdisk" class="header-anchor">#</a></h3><h4><span id="1-1-1-1-cha-kan-fen-qu">1.1.1.1 查看分区</span><a href="#1-1-1-1-cha-kan-fen-qu" class="header-anchor">#</a></h4><p><code>fdisk -l</code>显示磁盘分区使用情况</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/0.png" alt="image"></p>
<h4><span id="1-1-1-2-shan-chu-fen-qu">1.1.1.2 删除分区</span><a href="#1-1-1-2-shan-chu-fen-qu" class="header-anchor">#</a></h4><p><code>fdisk /dev/sdb1 </code>用来对sdb1进行分区.</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/1.png" alt="image"></p>
<p>输入m表示获取帮助，默认有分区sdb1, 然后输入d删除分区1，p打印出分区表，i表示打印出详细分区信息，n表示新增分区信息，w表示保存，q表示退出。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/2.png" alt="image"></p>
<p>来看dev&#x2F;sd*信息，发现已经没有了sdb1.</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/3.png" alt="image"></p>
<h4><span id="1-1-1-3-chuang-jian-fen-qu">1.1.1.3 创建分区</span><a href="#1-1-1-3-chuang-jian-fen-qu" class="header-anchor">#</a></h4><p>再来看如何建立分区1：<br>先建立一个1GB的分区，<code>1GB= 1024 * 1024 * 1024=1073741824 B = 2097152</code>个sector，一个sector有512 byte,再加上2048 个sector，那么等于2099200个sector。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/4.png" alt="image"></p>
<p>再来何建立分区2：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/5.png" alt="image"></p>
<p>这里First sector使用默认值2101248，Last sector使用4198400（1G是2097152， 2101248 + 2097152 &#x3D; 4198400），分区2也是1GB<br>再来何建立分区3：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/6.png" alt="image"></p>
<p>First sector和Last sector使用默认，那么最终分区3有26.8GiB。</p>
<p>最后输入w保存退出，来看下分区:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/7.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/8.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/9.png" alt="image"></p>
<h3><span id="1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs">1.1.2 磁盘格式化命令-mkfs</span><a href="#1-1-2-ci-pan-ge-shi-hua-ming-ling-mkfs" class="header-anchor">#</a></h3><p>mkfs命令用来对磁盘分区格式化，将格式化好的sd卡放入windows系统查看，可以看到3个盘:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/10.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/11.png" alt="image"></p>
<h4><span id="1-1-2-1-mount">1.1.2.1 mount</span><a href="#1-1-2-1-mount" class="header-anchor">#</a></h4><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/mount.png" alt="image"></p>
<h3><span id="1-1-3-du">1.1.3 du</span><a href="#1-1-3-du" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/12.png" alt="image"></p>
<h3><span id="1-1-4-df">1.1.4 df</span><a href="#1-1-4-df" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/13.png" alt="image"></p>
<h2><span id="1-2-wen-jian-zi-fu-cao-zuo-ming-ling">1.2 文件字符操作命令</span><a href="#1-2-wen-jian-zi-fu-cao-zuo-ming-ling" class="header-anchor">#</a></h2><h3><span id="1-2-1-xargs">1.2.1 xargs</span><a href="#1-2-1-xargs" class="header-anchor">#</a></h3><p><code>find -name *.sh |xargs grep -rn &quot;build_all&quot;</code></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/14.png" alt="image"></p>
<h3><span id="1-2-1-find">1.2.1 find</span><a href="#1-2-1-find" class="header-anchor">#</a></h3><p>按时间搜索：<br>-atime 访问时间 (单位是天，分钟单位则是-amin，以下类似）<br>-mtime 修改时间 （内容被修改）<br>-ctime 变化时间 （元数据或权限变化）</p>
<p>最近7天被访问过的所有文件：<br><code>find . -atime 7 -type f -print</code><br>最近7天被修改的文件：<br><code>find . -maxdepth 2 -mtime 7 -type f</code></p>
<h4><span id="tong-pei-fu">通配符</span><a href="#tong-pei-fu" class="header-anchor">#</a></h4><p>一版find命令还会伴随通配符使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*：匹配任意多个字符</span><br><span class="line">?：匹配任意一个字符</span><br><span class="line">[...]：匹配中括号内出现的任意一个字符</span><br><span class="line">[!...]：不匹配中括号内出现的任意一个字符</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ find . -name *.txt</span><br><span class="line">$ find -name *.[ch]</span><br><span class="line">$ find -name *fsi*.?  <span class="comment">#查找包含fsi字符，同时又有.c或者.h等单个字符后缀的文件</span></span><br><span class="line">./i2c/busses/i2c-fsi.c</span><br><span class="line">./spi/spi-fsi.c</span><br><span class="line">./input/joystick/fsia6b.c</span><br><span class="line">./fsi/fsi-sbefifo.c</span><br><span class="line">./fsi/fsi-master-ast-cf.c</span><br><span class="line">./fsi/fsi-master-aspeed.c</span><br><span class="line">./fsi/fsi-master.h</span><br><span class="line">./fsi/fsi-occ.c</span><br><span class="line">./fsi/fsi-master-hub.c</span><br><span class="line">./fsi/fsi-master-gpio.c</span><br><span class="line">./fsi/fsi-core.c</span><br><span class="line">./fsi/fsi-scom.c</span><br><span class="line">./fsi/cf-fsi-fw.h</span><br></pre></td></tr></table></figure>

<h4><span id="ban-sui-zhi-xing-ren-wu">伴随执行任务</span><a href="#ban-sui-zhi-xing-ren-wu" class="header-anchor">#</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 找到后执行删除</span></span><br><span class="line">find . -name <span class="string">&quot;*.txt&quot;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;</span><br></pre></td></tr></table></figure>

<h3><span id="1-2-2-grep">1.2.2 grep</span><a href="#1-2-2-grep" class="header-anchor">#</a></h3><p><code>find /path/to/directory -type f -name &quot;*.txt&quot; | grep &quot;keyword&quot;</code></p>
<p>-w 全词匹配。<br>-v 反向搜索<br>-i 不区分大小写</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$匹配以字符串结尾的行</span><br><span class="line">^ 匹配以字符串开头的行</span><br><span class="line"></span><br><span class="line">找出空行 grep <span class="string">&quot;^$&quot;</span> test.txt -n</span><br><span class="line">找出unix开头的行grep <span class="string">&quot;^unix&quot;</span> geekfile.txt</span><br><span class="line">找出.结尾的行 grep <span class="string">&quot;\.$&quot;</span> test.txt -n -o</span><br><span class="line">找出os.结尾的行，grep <span class="string">&quot;os.$&quot;</span> geekfile.txt</span><br></pre></td></tr></table></figure>

<p><strong>[abc]中括号</strong></p>
<p>匹配abc字符中的任意一个:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/15.png" alt="image"></p>
<p>匹配a-z:</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/16.png" alt="image"></p>
<p>下面一个脚本用grep -v排除掉不需要的行，也就是删除包含指定字符的行从一个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 定义要删除的特定字符</span></span><br><span class="line">pattern=<span class="string">&quot;特定字符&quot;</span></span><br><span class="line"><span class="comment"># 定义要处理的文件名</span></span><br><span class="line">filename=<span class="string">&quot;文件名&quot;</span></span><br><span class="line"><span class="comment"># 使用grep命令找到含有特定字符的行，并将结果输出到一个临时文件中</span></span><br><span class="line">grep -v <span class="string">&quot;<span class="variable">$pattern</span>&quot;</span> <span class="string">&quot;<span class="variable">$filename</span>&quot;</span> &gt; temp.txt</span><br><span class="line"><span class="comment"># 将临时文件的内容复制回原始文件</span></span><br><span class="line"><span class="built_in">cat</span> temp.txt &gt; <span class="string">&quot;<span class="variable">$filename</span>&quot;</span></span><br><span class="line"><span class="comment"># 删除临时文件</span></span><br><span class="line"><span class="built_in">rm</span> temp.txt</span><br></pre></td></tr></table></figure>

<h4><span id="uniq-shan-chu-chong-fu-xing">uniq 删除重复行</span><a href="#uniq-shan-chu-chong-fu-xing" class="header-anchor">#</a></h4><h4><span id="tr-zi-fu-chuan-ti-huan">tr字符串替换</span><a href="#tr-zi-fu-chuan-ti-huan" class="header-anchor">#</a></h4><h2><span id="1-2-awk-shu-ju-liu-chu-li">1.2 awk数据流处理</span><a href="#1-2-awk-shu-ju-liu-chu-li" class="header-anchor">#</a></h2><p>常用的就是提取文件中的列字段，比如提取file中的第二个和第三个字段。<br><code>awk &#39;&#123;print $2, $3&#125;&#39; file</code></p>
<h2><span id="1-3-wang-luo-ming-ling">1.3 网络命令</span><a href="#1-3-wang-luo-ming-ling" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0 up/down</span><br><span class="line">udhcpc -i eth0 //通过路由器分配 IP 地址</span><br><span class="line">ifconfig eth0 192.168.1.251 netmask 255.255.255.0 //设置 IP 地址和子网掩码</span><br><span class="line">route add default gw 192.168.1.1 //添加默认网关</span><br></pre></td></tr></table></figure>

<h1><span id="3-shell-jiao-ben-ming-ling">3 shell脚本命令</span><a href="#3-shell-jiao-ben-ming-ling" class="header-anchor">#</a></h1><h2><span id="3-1-jie-shi-qi">3.1 解释器</span><a href="#3-1-jie-shi-qi" class="header-anchor">#</a></h2><ol>
<li><p>sh解释器</p>
</li>
<li><p>bash解释器<br>脚本开头用<code>#！</code>用来申明用什么解释器，如：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/17.png" alt="image"></p>
</li>
</ol>
<h2><span id="3-2-duan-dai-ma-zhu-shi">3.2 段代码注释</span><a href="#3-2-duan-dai-ma-zhu-shi" class="header-anchor">#</a></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;EOF</span><br><span class="line">...</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/18.png" alt="image"></p>
<h2><span id="3-3-read-ming-ling">3.3 read命令</span><a href="#3-3-read-ming-ling" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/19.png" alt="image"></p>
<h2><span id="3-4-test-ming-ling">3.4 test命令</span><a href="#3-4-test-ming-ling" class="header-anchor">#</a></h2><p>测试文件，数值，权限，字符串等参数。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/20.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/21.png" alt="image"></p>
<p>中括号也能表示测试，里面只能用&#x3D;&#x3D;或!&#x3D;。</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22.png" alt="image"></p>
<h3><span id="3-4-1-wen-jian-ce-shi">3.4.1 文件测试</span><a href="#3-4-1-wen-jian-ce-shi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22-1.png" alt="image-20240921213503247"></p>
<h3><span id="3-4-2-bi-jiao-ce-shi">3.4.2 比较测试</span><a href="#3-4-2-bi-jiao-ce-shi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22-2.png" alt="image-20240921213551593"></p>
<h3><span id="3-4-3-duo-chong-tiao-jian-ce-shi">3.4.3 多重条件测试</span><a href="#3-4-3-duo-chong-tiao-jian-ce-shi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22-3.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22-4.png" alt="image"></p>
<p>可以看到第一和第三条test都成立：</p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/22-5.png" alt="image"></p>
<h2><span id="3-5-ming-ling-xing-can-shu">3.5 命令行参数</span><a href="#3-5-ming-ling-xing-can-shu" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$0</span>, <span class="variable">$1</span>, <span class="variable">$2</span>, <span class="variable">$3</span>...</span><br><span class="line"><span class="variable">$0</span>表示脚本文件名</span><br><span class="line"><span class="variable">$1</span>表示第一个参数</span><br><span class="line"><span class="variable">$n</span>表示第n个参数</span><br><span class="line"><span class="variable">$#</span>表示一共有多少个命令行参数</span><br><span class="line"><span class="variable">$@</span>表示所有的命令行参数集合，<span class="variable">$0</span> <span class="variable">$1</span> <span class="variable">$2</span> ... <span class="variable">$n</span></span><br><span class="line">$*表示等价<span class="variable">$@</span></span><br><span class="line">$?表示上一条命令是否返回成功，成功为0,错误非0</span><br><span class="line">$$表示当前脚本的进程号</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/23.png" alt="image"></p>
<h2><span id="3-6-tiao-jian-yu-ju">3.6 条件语句</span><a href="#3-6-tiao-jian-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/24.png" alt="image"></p>
<h2><span id="3-7-case-yu-ju">3.7 case语句</span><a href="#3-7-case-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/25.png" alt="image"></p>
<h2><span id="3-8-han-shu">3.8 函数</span><a href="#3-8-han-shu" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/26.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/27.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/28.png" alt="image"></p>
<h2><span id="3-9-xun-huan-yu-ju">3.9 循环语句</span><a href="#3-9-xun-huan-yu-ju" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/29.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/30.png" alt="image"></p>
<p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/31.png" alt="image"></p>
<h2><span id="3-9-shu-zu">3.9 数组</span><a href="#3-9-shu-zu" class="header-anchor">#</a></h2><p>用括号来表示数组，数组元素用“空格”符号分割开：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">array_name=(value0 value1 value2 value3)</span><br><span class="line">array_name=(</span><br><span class="line">value0</span><br><span class="line">value1</span><br><span class="line">value2</span><br><span class="line">value3</span><br><span class="line">)</span><br><span class="line"><span class="comment">#还可以每个元素进行定义，可以不使用连续的下标，而且下标的范围没有限制。</span></span><br><span class="line">array_name[0]=value0</span><br><span class="line">array_name[1]=value1</span><br><span class="line">array_name[2]=value2</span><br><span class="line"></span><br><span class="line"><span class="comment">#读取数组</span></span><br><span class="line">val=<span class="variable">$&#123;array_name[2]&#125;</span></span><br><span class="line">all=<span class="variable">$&#123;array_name[*]&#125;</span></span><br><span class="line">all2=<span class="variable">$&#123;array_name[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 取得数组元素的个数</span></span><br><span class="line">length=<span class="variable">$&#123;#array_name[@]&#125;</span></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">length=<span class="variable">$&#123;#array_name[*]&#125;</span></span><br><span class="line"><span class="comment"># 取得数组单个元素的长度</span></span><br><span class="line">lengthn=<span class="variable">$&#123;#array_name[n]&#125;</span></span><br></pre></td></tr></table></figure>

<h2><span id="3-10-typeset-huo-zhe-declare">3.10 typeset或者declare</span><a href="#3-10-typeset-huo-zhe-declare" class="header-anchor">#</a></h2><p>sh脚本默认所有变量都是字符串，比如val&#x3D;1，也表示val是一个字符串“1”。那么需要如何声明一个变量类型，用typeset或者declare。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">typeset</span> -i data=1</span><br></pre></td></tr></table></figure>

<h2><span id="3-11-unset">3.11 unset</span><a href="#3-11-unset" class="header-anchor">#</a></h2><p>清除变量值.</p>
<h2><span id="3-12-readonly">3.12 readonly</span><a href="#3-12-readonly" class="header-anchor">#</a></h2><p>只读变量.</p>
<h2><span id="3-13-sed">3.13 sed</span><a href="#3-13-sed" class="header-anchor">#</a></h2><h3><span id="3-13-1-mu-lu-di-gui-ti-huan-zi-fu">3.13.1 目录递归替换字符</span><a href="#3-13-1-mu-lu-di-gui-ti-huan-zi-fu" class="header-anchor">#</a></h3><p><code>find /path/to/dir -type f -name &quot;*.[c-h]&quot; -exec sed -i &#39;s/oldstring/newstring/g&#39; &#123;&#125; +</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find /path/to/dir：找到指定目录/path/to/dir下的所有文件。</span><br><span class="line">-<span class="built_in">type</span> f：仅查找文件。</span><br><span class="line">-name <span class="string">&quot;*.txt&quot;</span>：限制文件名以.txt结尾。</span><br><span class="line">-<span class="built_in">exec</span>：对找到的每个文件执行后面的命令。</span><br><span class="line">sed -i：使用sed进行替换，-i表示直接修改文件内容。</span><br><span class="line"><span class="string">&#x27;s/oldstring/newstring/g&#x27;</span>：sed的替换表达式，g表示全局替换。</span><br><span class="line">&#123;&#125;：表示find找到的文件名。</span><br><span class="line">+：结束-<span class="built_in">exec</span>命令，批量处理匹配到的文件。</span><br></pre></td></tr></table></figure>

<h3><span id="3-13-2-qu-diao-yi-xing-zhong-duo-yu-de-kong-ge">3.13.2 去掉一行中多余的空格</span><a href="#3-13-2-qu-diao-yi-xing-zhong-duo-yu-de-kong-ge" class="header-anchor">#</a></h3><p><code>sed -i &#39;s/[[:space:]]\+/ /g&#39; array.sh</code><br><code>s/[[:space:]]\+/ /g</code> 是替换命令，它会将一个或多个空白字符（包括空格、制表符等）替换为单个空格.</p>
<h2><span id="3-14-shell-jiao-ben-ru-he-cha-kan-jiang-yao-zhi-xing-de-ming-ling">3.14 shell脚本如何查看将要执行的命令</span><a href="#3-14-shell-jiao-ben-ru-he-cha-kan-jiang-yao-zhi-xing-de-ming-ling" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Hello, World!&quot;</span></span><br></pre></td></tr></table></figure>

<h2><span id="3-15-zi-fu-chuan-zhong-ti-huan-yi-ge-zi-fu">3.15 字符串中替换一个字符</span><a href="#3-15-zi-fu-chuan-zhong-ti-huan-yi-ge-zi-fu" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">string=<span class="string">&quot;123123&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string/3/0&#125;</span>			<span class="comment">#用0替换第一个遇见的3</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;string//3/0&#125;</span>			<span class="comment">#用0替换串中所有3</span></span><br></pre></td></tr></table></figure>

<h2><span id="3-16-suan-shu-yun-suan-fu">3.16 算数运算符</span><a href="#3-16-suan-shu-yun-suan-fu" class="header-anchor">#</a></h2><p><img src="/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/32.png" alt="image"></p>
<h2><span id="3-17-chong-ding-xiang">3.17 重定向</span><a href="#3-17-chong-ding-xiang" class="header-anchor">#</a></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$who</span></span><br><span class="line">weiyong.luo pts/1130     2024-09-21 12:12 (xxx.xxx.xxx.xxx)</span><br><span class="line">shawn.wu pts/1036     2024-09-11 17:48 (xxx.xxx.xxx.xxx)</span><br><span class="line">weiyong.luo pts/1133     2024-09-21 12:12 </span><br><span class="line">robin.lee pts/1134     2024-09-21 15:23 </span><br><span class="line">chengzhi.lian pts/1135     2024-09-21 09:02</span><br><span class="line">robin.lee pts/1166     2024-09-20 18:15 </span><br><span class="line"></span><br><span class="line"><span class="built_in">who</span> &gt;<span class="built_in">users</span> <span class="comment">##输出重定向到users文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#再看输入重定向</span></span><br><span class="line"><span class="comment">#从文件获取输入信息给命令。</span></span><br><span class="line">$ <span class="built_in">wc</span> -l &lt; <span class="built_in">users</span>  <span class="comment">#统计users文件的行数</span></span><br><span class="line">12</span><br></pre></td></tr></table></figure>

<h3><span id="3-17-1-bao-cun-log-dao-wen-ben">3.17.1 保存log到文本</span><a href="#3-17-1-bao-cun-log-dao-wen-ben" class="header-anchor">#</a></h3><p><code>make all &gt; build_osdrv.log 2&gt;&amp;1</code></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/linux%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4%E9%9B%86%E5%90%88/" data-id="cm0xxogdy0015qsuf6c7i18tt" data-title="linux基本命令集合" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-markdown语法教程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T09:24:38.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/">markdown语法教程</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-duo-ji-biao-ti-mu-lu-jie-gou">1 多级标题目录结构</a></li>
<li><a href="#yi-ji-biao-ti">一级标题</a><ul>
<li><a href="#er-ji-biao-ti">二级标题</a><ul>
<li><a href="#san-ji-biao-ti">三级标题</a><ul>
<li><a href="#si-ji-biao-ti">四级标题</a><ul>
<li><a href="#wu-ji-biao-ti">五级标题</a><ul>
<li><a href="#liu-ji-biao-ti">六级标题</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-duan-luo">2 段落</a><ul>
<li><a href="#2-1-huan-xing">2.1 换行</a></li>
</ul>
</li>
<li><a href="#3-zi-ti">3 字体</a></li>
<li><a href="#4-zi-ti-yan-se-da-xiao">4 字体颜色,大小</a></li>
<li><a href="#5-zi-ti-bei-jing-yan-se">5 字体背景颜色</a></li>
<li><a href="#5-xia-hua-xian">5 下划线</a></li>
<li><a href="#6-lie-biao-xiang">6 列表项</a></li>
<li><a href="#7-dai-ma-kuai-yu-yu-fa-gao-liang">7 代码块与语法高亮</a><ul>
<li><a href="#7-1-xing-nei-dai-ma">7.1 行内代码</a></li>
<li><a href="#7-2-kuai-dai-ma">7.2 块代码</a></li>
</ul>
</li>
<li><a href="#8-dai-ma-zhe-die">8 代码折叠</a></li>
<li><a href="#9-cha-ru-lian-jie">9 插入链接</a><ul>
<li><a href="#9-1-zi-dong-lian-jie">9.1 自动链接</a></li>
</ul>
</li>
<li><a href="#10-tian-jia-tu-pian">10 添加图片</a></li>
<li><a href="#11-biao-ge">11 表格</a></li>
<li><a href="#12-zhuan-yi-zi-fu">12 转义字符</a></li>
<li><a href="#mao-dian">锚点</a><ul>
<li><a href="#mu-lu">目录</a><ul>
<li><a href="#di-yi-jie">第一节</a></li>
<li><a href="#di-er-jie">第二节</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-duo-ji-biao-ti-mu-lu-jie-gou">1 多级标题目录结构</span><a href="#1-duo-ji-biao-ti-mu-lu-jie-gou" class="header-anchor">#</a></h1><pre><code># 一级标题
## 二级标题
### 三级标题
#### 四级标题
##### 五级标题
###### 六级标题
</code></pre>
<p>效果如下：</p>
<h1><span id="yi-ji-biao-ti">一级标题</span><a href="#yi-ji-biao-ti" class="header-anchor">#</a></h1><h2><span id="er-ji-biao-ti">二级标题</span><a href="#er-ji-biao-ti" class="header-anchor">#</a></h2><h3><span id="san-ji-biao-ti">三级标题</span><a href="#san-ji-biao-ti" class="header-anchor">#</a></h3><h4><span id="si-ji-biao-ti">四级标题</span><a href="#si-ji-biao-ti" class="header-anchor">#</a></h4><h5><span id="wu-ji-biao-ti">五级标题</span><a href="#wu-ji-biao-ti" class="header-anchor">#</a></h5><h6><span id="liu-ji-biao-ti">六级标题</span><a href="#liu-ji-biao-ti" class="header-anchor">#</a></h6><h1><span id="2-duan-luo">2 段落</span><a href="#2-duan-luo" class="header-anchor">#</a></h1><h2><span id="2-1-huan-xing">2.1 换行</span><a href="#2-1-huan-xing" class="header-anchor">#</a></h2><p>Markdown段落的换行是使用两个以上空格加上回车，当然也可以在段落后面使用一个空行来表示重新开始一个段落。</p>
<h1><span id="3-zi-ti">3 字体</span><a href="#3-zi-ti" class="header-anchor">#</a></h1><pre><code>*斜体*
**粗体**
***加粗斜体***

&lt;font face=&quot;黑体&quot;&gt;我是黑体字&lt;/font&gt;
&lt;font face=&quot;微软雅黑&quot;&gt;我是微软雅黑&lt;/font&gt;
&lt;font face=&quot;STCAIYUN&quot;&gt;我是华文彩云&lt;/font&gt;
</code></pre>
<p>效果：</p>
<p><em>斜体</em><br><strong>粗体</strong><br><em><strong>加粗斜体</strong></em></p>
<p><font face="黑体">我是黑体字</font><br><font face="微软雅黑">我是微软雅黑</font><br><font face="STCAIYUN">我是华文彩云</font></p>
<h1><span id="4-zi-ti-yan-se-da-xiao">4 字体颜色,大小</span><a href="#4-zi-ti-yan-se-da-xiao" class="header-anchor">#</a></h1><pre><code>&lt;font color=#0099ff size=12 face=&quot;黑体&quot;&gt;黑体&lt;/font&gt;
&lt;font color=gray size=5&gt;gray&lt;/font&gt;
&lt;font color=#00ffff size=3&gt;null&lt;/font&gt;
</code></pre>
<p>效果：</p>
<p><font color="#0099ff" size="12" face="黑体">黑体</font><br><font color="gray" size="5">gray</font><br><font color="#00ffff" size="3">null</font></p>
<h1><span id="5-zi-ti-bei-jing-yan-se">5 字体背景颜色</span><a href="#5-zi-ti-bei-jing-yan-se" class="header-anchor">#</a></h1><pre><code>&lt;table&gt;&lt;td bgcolor=pink&gt; 
背景色是pink &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=LightGoldenRodYellow&gt; 
LightGoldenRodYellow &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PeachPuff&gt; 
PeachPuff &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PapayaWhip&gt; 
PapayaWhip &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PaleGreen&gt; 
PaleGreen &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=PaleGoldenRod&gt; 
PaleGoldenRod &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=MistyRose&gt; 
MistyRose &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=Linen&gt; 
Linen &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=LightPink&gt; 
LightPink &lt;/table&gt;

&lt;table&gt;&lt;td bgcolor=BurlyWood&gt; 
BurlyWood &lt;/table&gt;
</code></pre>
<p>效果：</p>
<table><td bgcolor="pink"> 
背景色是pink </td></table>

<table><td bgcolor="LightGoldenRodYellow"> 
LightGoldenRodYellow </td></table>

<table><td bgcolor="PeachPuff"> 
PeachPuff </td></table>

<table><td bgcolor="PapayaWhip"> 
PapayaWhip </td></table>

<table><td bgcolor="PaleGreen"> 
PaleGreen </td></table>

<table><td bgcolor="PaleGoldenRod"> 
PaleGoldenRod </td></table>

<table><td bgcolor="MistyRose"> 
MistyRose </td></table>

<table><td bgcolor="Linen"> 
Linen </td></table>

<table><td bgcolor="LightPink"> 
LightPink </td></table>

<table><td bgcolor="BurlyWood"> 
BurlyWood </td></table>


<h1><span id="5-xia-hua-xian">5 下划线</span><a href="#5-xia-hua-xian" class="header-anchor">#</a></h1><p>写法：<br>    <code>&lt;u&gt;下划线&lt;/u&gt;</code></p>
<p>效果如下：<br><u>下划线</u></p>
<h1><span id="6-lie-biao-xiang">6 列表项</span><a href="#6-lie-biao-xiang" class="header-anchor">#</a></h1><p>无序列表使用星号(*)、加号(+)或是减号(-)作为列表标记：</p>
<pre><code>* 第一项
* 第二项
* 第三项
</code></pre>
<p>显示效果：  </p>
<ul>
<li>第一项</li>
<li>第二项</li>
<li>第三项</li>
</ul>
<p>有序列表使用数字并加上 <code>.</code> 号来表示： 	<br>    1. 第一项<br>        1. 小一项<br>        2. 小二项<br>    2. 第二项<br>    3. 第三项<br>显示效果： </p>
<ol>
<li>第一项<ol>
<li>小一项</li>
<li>小二项</li>
</ol>
</li>
<li>第二项</li>
<li>第三项</li>
</ol>
<h1><span id="7-dai-ma-kuai-yu-yu-fa-gao-liang">7 代码块与语法高亮</span><a href="#7-dai-ma-kuai-yu-yu-fa-gao-liang" class="header-anchor">#</a></h1><h2><span id="7-1-xing-nei-dai-ma">7.1 行内代码</span><a href="#7-1-xing-nei-dai-ma" class="header-anchor">#</a></h2><p>用反引号 &#96;&#96; 来标记或插入代码区段</p>
<p>效果：<br><code>int main(void)</code></p>
<h2><span id="7-2-kuai-dai-ma">7.2 块代码</span><a href="#7-2-kuai-dai-ma" class="header-anchor">#</a></h2><p>用tab键或者用&#96;&#96;&#96;</p>
<p>效果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(vpod)</span> &#123;</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1><span id="8-dai-ma-zhe-die">8 代码折叠</span><a href="#8-dai-ma-zhe-die" class="header-anchor">#</a></h1><p>写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;details&gt;</span><br><span class="line">&lt;summary&gt;点击展开代码&lt;/summary&gt;</span><br><span class="line">&lt;pre&gt;&lt;code&gt;</span><br><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">int main(int argc, char **argv)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;hello world\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/code&gt;&lt;/pre&gt;</span><br><span class="line">&lt;/details&gt;</span><br></pre></td></tr></table></figure>

<p>效果如下：</p>
<details>
<summary>点击展开代码</summary>
<pre><code>
    #include &lt;stdio.h&gt;
    int main(int argc, char **argv)
    &#123;
        printf("hello world\n");
        return 0;
    &#125;

<p></p></code></pre><p></p>
</details>

<h1><span id="9-cha-ru-lian-jie">9 插入链接</span><a href="#9-cha-ru-lian-jie" class="header-anchor">#</a></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用:</span><br><span class="line">[fuzidage的博客](https://www.cnblogs.com/fuzidage/)</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/fuzidage/">fuzidage的博客</a></p>
<h2><span id="9-1-zi-dong-lian-jie">9.1 自动链接</span><a href="#9-1-zi-dong-lian-jie" class="header-anchor">#</a></h2><p>只要是用&lt;&gt;包起来， Markdown 就会自动把它转成链接：</p>
<p>效果：<br><a target="_blank" rel="noopener" href="https://github.com/fuzidage">https://github.com/fuzidage</a></p>
<h1><span id="10-tian-jia-tu-pian">10 添加图片</span><a href="#10-tian-jia-tu-pian" class="header-anchor">#</a></h1><pre><code>写法：![](https://img2018.cnblogs.com/blog/1876680/201912/1876680-20191214155002138-1798053565.png)
当然如果是本地图片写法：
![](./markdown语法教程/1.png)
</code></pre>
<p>引用网络效果：</p>
<p><img src="https://img2018.cnblogs.com/blog/1876680/201912/1876680-20191214155002138-1798053565.png"></p>
<p>引用本地图片效果：<br><img src="/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/1.png" alt="image-20240526174126727"></p>
<h1><span id="11-biao-ge">11 表格</span><a href="#11-biao-ge" class="header-anchor">#</a></h1><p>写法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| 左对齐 | 右对齐 | 居中对齐 |</span><br><span class="line">| :-----| ----: | :----:|</span><br><span class="line">| 单元格 | 单元格 | 单元格 |</span><br><span class="line">| 单元格 | 单元格 | 单元格 |</span><br></pre></td></tr></table></figure>
<p>效果：</p>
<table>
<thead>
<tr>
<th align="left">左对齐</th>
<th align="right">右对齐</th>
<th align="center">居中对齐</th>
</tr>
</thead>
<tbody><tr>
<td align="left">单元格</td>
<td align="right">单元格</td>
<td align="center">单元格</td>
</tr>
<tr>
<td align="left">单元格</td>
<td align="right">单元格</td>
<td align="center">单元格</td>
</tr>
</tbody></table>
<h1><span id="12-zhuan-yi-zi-fu">12 转义字符</span><a href="#12-zhuan-yi-zi-fu" class="header-anchor">#</a></h1><table>
<thead>
<tr>
<th>显示结果</th>
<th>描述</th>
<th>输入</th>
<th>实体编号</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空格</td>
<td>&amp;nbsp；</td>
<td>&amp;#160；</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于号</td>
<td>&amp;lt；</td>
<td>&amp;#60；</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于号</td>
<td>&amp;gt；</td>
<td>&amp;#62；</td>
</tr>
<tr>
<td>&amp;</td>
<td>和号</td>
<td>&amp;amp；</td>
<td>&amp;#38；</td>
</tr>
<tr>
<td>“</td>
<td>引号</td>
<td>&amp;quot；</td>
<td>&amp;#34；</td>
</tr>
<tr>
<td>‘</td>
<td>撇号</td>
<td>&amp;apos；</td>
<td>(IE不支持)	&amp;#39；</td>
</tr>
<tr>
<td>￠</td>
<td>分</td>
<td>&amp;cent；</td>
<td>&amp;#162；</td>
</tr>
<tr>
<td>£</td>
<td>镑</td>
<td>&amp;pound；</td>
<td>&amp;#163；</td>
</tr>
<tr>
<td>¥</td>
<td>日圆</td>
<td>&amp;yen；</td>
<td>&amp;#165；</td>
</tr>
<tr>
<td>§</td>
<td>节</td>
<td>&amp;sect；</td>
<td>&amp;#167；</td>
</tr>
<tr>
<td>©</td>
<td>版权</td>
<td>&amp;copy；</td>
<td>&amp;#169；</td>
</tr>
<tr>
<td>®</td>
<td>注册商标</td>
<td>&amp;reg；</td>
<td>&amp;#174；</td>
</tr>
<tr>
<td>×</td>
<td>乘号</td>
<td>&amp;times；</td>
<td>&amp;#215；</td>
</tr>
<tr>
<td>÷</td>
<td>除号</td>
<td>&amp;divide；</td>
<td>&amp;#247；</td>
</tr>
</tbody></table>
<h1><span id="mao-dian">锚点</span><a href="#mao-dian" class="header-anchor">#</a></h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 目录</span></span><br><span class="line">[跳转到第一节](<span class="comment">#a)</span></span><br><span class="line">[跳转到第二节](<span class="comment">#b)</span></span><br><span class="line"></span><br><span class="line">&lt;a name=<span class="string">&quot;a&quot;</span>&gt;&lt;/a&gt;</span><br><span class="line"><span class="comment">### 第一节</span></span><br><span class="line">这是第一节的内容。</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">&lt;a name=<span class="string">&quot;b&quot;</span>&gt;&lt;/a&gt;</span><br><span class="line"><span class="comment">### 第二节</span></span><br><span class="line">这是第二节的内容。</span><br></pre></td></tr></table></figure>

<h2><span id="mu-lu">目录</span><a href="#mu-lu" class="header-anchor">#</a></h2><p><a href="#a">跳转到第一节</a><br><a href="#b">跳转到第二节</a></p>
<p><a name="a"></a></p>
<h3><span id="di-yi-jie">第一节</span><a href="#di-yi-jie" class="header-anchor">#</a></h3><p>这是第一节的内容。<br>…<br>…<br>…<br>…<br>…<br>…<br>…<br>…<br>…<br>…<br>…<br><a name="b"></a></p>
<h3><span id="di-er-jie">第二节</span><a href="#di-er-jie" class="header-anchor">#</a></h3><p>这是第二节的内容。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/markdown%E8%AF%AD%E6%B3%95%E6%95%99%E7%A8%8B/" data-id="cm0xxogdz001dqsuf125700io" data-title="markdown语法教程" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-I2c-SMBus协议和I2C-Tools" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" class="article-date">
  <time class="dt-published" datetime="2024-05-26T07:00:39.000Z" itemprop="datePublished">2024-05-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/">I2C-SMBus协议和I2C Tool</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-smbus-xie-yi">1 SMBus协议</a><ul>
<li><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</a></li>
<li><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</a></li>
<li><a href="#1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</a><ul>
<li><a href="#1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</a></li>
<li><a href="#1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</a></li>
<li><a href="#1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</a></li>
<li><a href="#1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</a></li>
<li><a href="#1-3-5-smbus-read-word">1.3.5 SMBus Read Word</a></li>
<li><a href="#1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</a></li>
<li><a href="#1-3-7-smbus-write-word">1.3.7 SMBus Write Word</a></li>
<li><a href="#1-3-8-smbus-block-read">1.3.8 SMBus Block Read</a></li>
<li><a href="#1-3-8-smbus-block-write">1.3.8 SMBus Block Write</a></li>
<li><a href="#1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</a></li>
<li><a href="#1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</a></li>
</ul>
</li>
<li><a href="#1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</a><ul>
<li><a href="#1-4-1-i2c-block-read">1.4.1 I2C Block Read</a></li>
<li><a href="#1-4-2-i2c-block-write">1.4.2 I2C Block Write</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-i2c-tools">2 I2C Tools</a><ul>
<li><a href="#2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</a></li>
<li><a href="#2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</a><ul>
<li><a href="#2-2-1-i2c-adapter">2.2.1 i2c_adapter</a></li>
<li><a href="#2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</a></li>
<li><a href="#2-3-4-i2c-device-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</a></li>
<li><a href="#2-3-5-i2c-msg">2.3.5 i2c_msg</a></li>
</ul>
</li>
<li><a href="#2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</a><ul>
<li><a href="#2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</a></li>
<li><a href="#2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</a></li>
<li><a href="#2-3-3-bian-yi">2.3.3 编译</a></li>
</ul>
</li>
<li><a href="#2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</a><ul>
<li><a href="#2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</a></li>
<li><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</a></li>
<li><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</a></li>
<li><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</a></li>
</ul>
</li>
<li><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</a><ul>
<li><a href="#2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</a><ul>
<li><a href="#2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</a></li>
<li><a href="#2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</a></li>
<li><a href="#2-5-1-3-zhi-jie-shi-yong-read-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-smbus-xie-yi">1 SMBus协议</span><a href="#1-smbus-xie-yi" class="header-anchor">#</a></h1><h2><span id="1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji">1.1 SMBus 是 I2C 协议的一个子集</span><a href="#1-1-smbus-shi-i2c-xie-yi-de-yi-ge-zi-ji" class="header-anchor">#</a></h2><p>SMBus: System Management Bus，系统管理总线。SMBus 最初的目的是为智能电池、充电电池、其他微控制器之间的通信链路而定义的。SMBus 也被用来连接各种设备，包括电源相关设备，系统传感器，EEPROM 通讯设备等等。SMBus 为系统和电源管理这样的任务提供了一条控制总线，使用 SMBus 的系 统，设备之间发送和接收消息都是通过 SMBus，而不是使用单独的控制线，这样可以节省设备的管脚数。</p>
<p>SMBus 是基于 I2C 协议的，SMBus 要求更严格，SMBus 是 I2C 协议的子集。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/1.png" alt="img"></p>
<h2><span id="1-2-he-i2c-xie-yi-te-xing-dui-bi">1.2 和I2C协议特性对比</span><a href="#1-2-he-i2c-xie-yi-te-xing-dui-bi" class="header-anchor">#</a></h2><p>SMBus 有哪些更严格的要求？跟一般的 I2C 协议有哪些差别？</p>
<ol>
<li>VDD 的极限值不一样<br>　　1.1 I2C 协议：范围很广，甚至讨论了高达 12V 的情况<br>　　　　　　　　　　　　　　　　1.2 SMBus：1.8V~5V</li>
<li>速率更高<br>　　I2C 协议：时钟频率最小值无限制，Clock Stretching 时长也没有限制<br>　　　　　　　　　　　　　　　　SMBus：时钟频率最小值是 10KHz，Clock Stretching 的最大时间值也有限制</li>
<li>地址回应(Address Acknowledge)：一个 I2C 设备接收到它的设备地址后， 是否必须发出回应信号？<br>　　I2C 协议：没有强制要求必须发出回应信号<br>　　　　　　　　　　　　　　　　SMBus：强制要求必须发出回应信号，这样对方才知道该设备的状态： busy，failed，或是被移除了</li>
<li>SMBus 协议明确了数据的传输格式<br>　　I2C 协议：它只定义了怎么传输数据，但是并没有定义数据的格式，这完全由设备来定义<br>　　　　　　　　　　　　　　　　SMBus：定义了几种数据格式</li>
<li><code>REPEATED START Condition(重复发出 S 信号)</code><br>　　比如读 EEPROM 时，涉及 2 个操作：<br>　　　　　　　　　　　　　　​	 把存储地址发给设备<br>　　　　　　　　　　　　　　​	 读数据<br>　　　　　　　　　　　　　　在写、读之间，可以不发出 P 信号，而是直接发出 S 信号：这个 S 信号就是<br>　　　　　　　　　　　　　　<code>REPEATED START</code></li>
</ol>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/2.png" alt="img"></p>
<h2><span id="1-3-smbus-shu-ju-ge-shi">1.3 SMBus数据格式</span><a href="#1-3-smbus-shu-ju-ge-shi" class="header-anchor">#</a></h2><p>下面文档中的 Functionality flag 是 Linux 的某个 I2C 控制器驱动所支持的功能。比如 Functionality flag: I2C_FUNC_SMBUS_QUICK，表示需要I2C 控制器支持 SMBus Quick Command。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">symbols(符号)：</span><br><span class="line">S (<span class="number">1</span> bit) : Start <span class="title function_">bit</span><span class="params">(开始位)</span></span><br><span class="line">　<span class="title function_">Sr</span> <span class="params">(<span class="number">1</span> bit)</span> : 重复的开始位</span><br><span class="line">　<span class="title function_">P</span> <span class="params">(<span class="number">1</span> bit)</span> : Stop <span class="title function_">bit</span><span class="params">(停止位)</span></span><br><span class="line">　R/W# <span class="params">(<span class="number">1</span> bit)</span> : Read/Write bit. Rd equals 1, Wr equals 0.<span class="params">(读写位)</span></span><br><span class="line">　A, <span class="title function_">N</span> <span class="params">(<span class="number">1</span> bit)</span> : Accept and reverse accept bit.<span class="params">(回应位)</span></span><br><span class="line">　<span class="title function_">Address</span><span class="params">(<span class="number">7</span> bits)</span>: I2C 7 bit address. Note that this can be expanded as usual to get a 10 bit I2C address.<span class="params">(地址位，<span class="number">7</span> 位地址)</span></span><br><span class="line">　Command <span class="title function_">Code</span> <span class="params">(<span class="number">8</span> bits)</span>: Command byte, a data byte which often selects a <span class="keyword">register</span> on the device.<span class="params">(命令字节，一般用来选择芯片内部的寄存器)</span></span><br><span class="line">  Data <span class="title function_">Byte</span> <span class="params">(<span class="number">8</span> bits)</span>: A plain data byte. Sometimes, I write DataLow, DataHigh <span class="keyword">for</span> 16 bit data.<span class="params">(数据字节，<span class="number">8</span> 位；如果是 <span class="number">16</span> 位数据的话，用 <span class="number">2</span> 个字节来表示：DataLow、DataHigh)</span></span><br><span class="line">　<span class="title function_">Count</span> <span class="params">(<span class="number">8</span> bits)</span>: A data byte containing the length of a block operation.<span class="params">(在 block 操作总，表示数据长度)</span></span><br><span class="line">　[..]: Data sent by I2C device, as opposed to data sent by the host adapter.<span class="params">(中括号表示 I2C 设备发送的数据，没有中括号表示 host adapter 发送的数据)</span></span><br></pre></td></tr></table></figure>

<h3><span id="1-3-1-smbus-quick-command">1.3.1 SMBus Quick Command</span><a href="#1-3-1-smbus-quick-command" class="header-anchor">#</a></h3><p>只是用来发送一位数据：R&#x2F;W#本意是用来表示读或写，但是在 SMBus 里可以用来表示其他含义。比如某些开关设备，可以根据这一位来决定是打开还是关闭.</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/3.png" alt="img"></p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_QUICK</strong></p>
<h3><span id="1-3-2-smbus-receive-byte">1.3.2 SMBus Receive Byte</span><a href="#1-3-2-smbus-receive-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/4.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte()</code>。读取一个字节，Host adapter 接收到一个字节后不需要发出回应信号(上图中 N 表示不回应)。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-3-smbus-send-byte">1.3.3 SMBus Send Byte</span><a href="#1-3-3-smbus-send-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/5.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte()</code>。发送一个字节。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE</strong></p>
<h3><span id="1-3-4-smbus-read-byte">1.3.4 SMBus Read Byte</span><a href="#1-3-4-smbus-read-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/6.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取一个字节的数据。上面介绍的 SMBus Receive Byte 是不发送 Comand，直接读取数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BYTE_DATA</strong></p>
<h3><span id="1-3-5-smbus-read-word">1.3.5 SMBus Read Word</span><a href="#1-3-5-smbus-read-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/7.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再读取 2 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_WORD_DATA</strong></p>
<h3><span id="1-3-6-smbus-write-byte">1.3.6 SMBus Write Byte</span><a href="#1-3-6-smbus-write-byte" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/8.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_byte_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BYTE_DATA</strong></p>
<h3><span id="1-3-7-smbus-write-word">1.3.7 SMBus Write Word</span><a href="#1-3-7-smbus-write-word" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/9.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_word_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_WORD_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-read">1.3.8 SMBus Block Read</span><a href="#1-3-8-smbus-block-read" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/10.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_read_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发起度操作：</p>
<p>　　1. 先读到一个字节(Block Count)，表示后续要读的字节数<br>　　1.  然后读取全部数据</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_BLOCK_DATA</strong></p>
<h3><span id="1-3-8-smbus-block-write">1.3.8 SMBus Block Write</span><a href="#1-3-8-smbus-block-write" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/11.png" alt="img"></p>
<p>I2C-tools 中的函数：<code>i2c_smbus_write_block_data()</code>。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 Byte Conut(表示后续要发出的数据字节数)，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_BLOCK_DATA</strong></p>
<h3><span id="1-3-9-smbus-block-write-block-read-process-call">1.3.9 SMBus Block Write - Block Read Process Call</span><a href="#1-3-9-smbus-block-write-block-read-process-call" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/12.png" alt="img"></p>
<p>先写一块数据，再读一块数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_BLOCK_PROC_CALL</strong></p>
<h3><span id="1-3-10-packet-error-checking-pec">1.3.10 Packet Error Checking (PEC)</span><a href="#1-3-10-packet-error-checking-pec" class="header-anchor">#</a></h3><p>PEC 是一种错误校验码，如果使用 PEC，那么在 P 信号之前，数据发送方要发送一个字节的 PEC 码(它是 CRC-8 码)。以 SMBus Send Byte 为例，下图中，一个未使用 PEC，另一个使用 PEC：(一般很少使用)</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/13.png" alt="img"></p>
<h2><span id="1-4-i2c-shu-ju-ge-shi">1.4 I2C数据格式</span><a href="#1-4-i2c-shu-ju-ge-shi" class="header-anchor">#</a></h2><h3><span id="1-4-1-i2c-block-read">1.4.1 I2C Block Read</span><a href="#1-4-1-i2c-block-read" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续读出多个字节。它跟 SMBus Block Read 的差别在于设备发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/14.png" alt="img"></p>
<p>I2C-tools 中的函数：&#96;i2c_smbus_read_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，直接读出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_READ_I2C_BLOCK</strong></p>
<h3><span id="1-4-2-i2c-block-write">1.4.2 I2C Block Write</span><a href="#1-4-2-i2c-block-write" class="header-anchor">#</a></h3><p>在一般的 I2C 协议中，也可以连续发出多个字节。它跟 SMBus Block Write 的差别在于发出的第 1 个数据不是长度 N，如下图所示：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/15.png" alt="img"></p>
<p>I2C-tools 中的函数：i2c_smbus_write_i2c_block_data()。先发出 Command Code(它一般表示芯片内部的寄存器地址)，再发出 1 个字节的 data，最后发出全部数据。</p>
<p><strong>Functionality flag: I2C_FUNC_SMBUS_WRITE_I2C_BLOCK</strong></p>
<h1><span id="2-i2c-tools">2 I2C Tools</span><a href="#2-i2c-tools" class="header-anchor">#</a></h1><h2><span id="2-1-i2c-kong-zhi-qi-kuang-jia">2.1 I2C控制器框架</span><a href="#2-1-i2c-kong-zhi-qi-kuang-jia" class="header-anchor">#</a></h2><p>APP 访问硬件肯定是需要驱动程序的，对于 I2C 设备，linux内核提供了默认的驱动程序 drivers&#x2F;i2c&#x2F;i2c-dev.c，通过它可以直接使用下面的 I2C 控制器驱动程序来 访问 I2C 设备。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/16.png" alt="img"></p>
<h2><span id="2-2-i2c-shu-ju-jie-gou">2.2 i2c数据结构</span><a href="#2-2-i2c-shu-ju-jie-gou" class="header-anchor">#</a></h2><h3><span id="2-2-1-i2c-adapter">2.2.1 i2c_adapter</span><a href="#2-2-1-i2c-adapter" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/17.png" alt="img"></p>
<p>i2c_adapter 表示一个 I2C BUS，或称为 I2C Controller，里面有 2 个重要的成员：</p>
<ol>
<li>nr：第几个 I2C BUS(I2C Controller)</li>
<li>i2c_algorithm，里面有该 I2C BUS 的传输函数，用来收发 I2C 数据</li>
</ol>
<p>怎么表示 I2C Controller , 一个芯片里可能有多个 I2C Controller，比如第 0 个、第 1 个、……</p>
<h3><span id="2-2-3-i2c-algorithm">2.2.3 i2c_algorithm</span><a href="#2-2-3-i2c-algorithm" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/18.png" alt="img"></p>
<h3><span id="2-3-4-i2c-device-x2f-i2c-client">2.3.4 I2c_device&#x2F;I2c_client</span><a href="#2-3-4-i2c-device-x2f-i2c-client" class="header-anchor">#</a></h3><p>一个 I2C Device，一定有设备地址， 那它连接在哪个 I2C Controller 上，即对应的 i2c_adapter 是什么。</p>
<p>使用 i2c_client 来表示一个 I2C Device。</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/19.png" alt="img"></p>
<h3><span id="2-3-5-i2c-msg">2.3.5 i2c_msg</span><a href="#2-3-5-i2c-msg" class="header-anchor">#</a></h3><p>在上面的i2c_algorithm结构体中可以看到要传输的数据被称为：i2c_msg</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/20.png" alt="img"></p>
<p>flags： 用来表示传输方向：bit 0 等于 I2C_M_RD 表示 读，bit 0 等于 0 表示写。一个 i2c_msg 要么是读，要么是写<br>举例：设备地址为 0x50 的 EEPROM，要读取它里面存储地址为 0x10 的一个字节， 应该构造几个 i2c_msg？<br>要构造 2 个 i2c_msg :</p>
<ol>
<li><p>第一个 i2c_msg 表示写操作，把要访问的存储地址 0x10 发给设备</p>
</li>
<li><p>第二个 i2c_msg 表示读操作,并且返回读出的数据</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">　　<span class="comment">//例如：</span></span><br><span class="line">　　u8 data_addr = <span class="number">0x10</span>;</span><br><span class="line">　　i8 data;</span><br><span class="line">　　<span class="class"><span class="keyword">struct</span> <span class="title">i2c_msg</span> <span class="title">msgs</span>[2];</span></span><br><span class="line">　　</span><br><span class="line">　　msgs[<span class="number">0</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].flags = <span class="number">0</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">0</span>].buf = &amp;data_addr;</span><br><span class="line">　　msgs[<span class="number">1</span>].addr = <span class="number">0x50</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].flags = I2C_M_RD;</span><br><span class="line">　　msgs[<span class="number">1</span>].len = <span class="number">1</span>;</span><br><span class="line">　　msgs[<span class="number">1</span>].buf = &amp;data;</span><br></pre></td></tr></table></figure>

<h2><span id="2-3-i2c-tools-yi-zhi">2.3 I2C-Tools移植</span><a href="#2-3-i2c-tools-yi-zhi" class="header-anchor">#</a></h2><h3><span id="2-3-1-yuan-ma-xia-zai">2.3.1 源码下载</span><a href="#2-3-1-yuan-ma-xia-zai" class="header-anchor">#</a></h3><p><a target="_blank" rel="noopener" href="https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/">https://mirrors.edge.kernel.org/pub/software/utils/i2c-tools/</a></p>
<h3><span id="2-3-2-gong-ju-lian-pei-zhi">2.3.2 工具链配置</span><a href="#2-3-2-gong-ju-lian-pei-zhi" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ARCH=arm</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueab ihf_sdk-buildroot/bin</span><br></pre></td></tr></table></figure>

<h3><span id="2-3-3-bian-yi">2.3.3 编译</span><a href="#2-3-3-bian-yi" class="header-anchor">#</a></h3><p>修改 I2C-Tools 的 Makefile 指定交叉编译工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC ?= gcc</span><br><span class="line">AR ?= ar</span><br><span class="line">STRIP ?= strip</span><br></pre></td></tr></table></figure>

<p>改为(指定交叉编译工具链前缀, 去掉问号)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CC = $(CROSS_COMPILE)gcc</span><br><span class="line">AR = $(CROSS_COMPILE)ar</span><br><span class="line">STRIP = $(CROSS_COMPILE)strip</span><br></pre></td></tr></table></figure>

<p>在 Makefile 中，“?&#x3D;”在第一次设置变量时才会起效果，如果之前设置过该变量，则不会起效果。</p>
<p>执行 make 时，是动态链接，需要把 libi2c.so 也放到单板上。 想静态链接的话，执行：make USE_STATIC_LIB&#x3D;1</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/21.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/22.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/23.png" alt="img"></p>
<h2><span id="2-4-i2c-tools-shi-yong">2.4 I2C Tools使用</span><a href="#2-4-i2c-tools-shi-yong" class="header-anchor">#</a></h2><h3><span id="2-4-1-i2cdetect-i2c-jian-ce">2.4.1 i2cdetect: I2C 检测</span><a href="#2-4-1-i2cdetect-i2c-jian-ce" class="header-anchor">#</a></h3><p>&#x2F;&#x2F; 列出当前的 I2C Adapter(或称为 I2C Bus、I2C Controller)</p>
<p><code>i2cdetect -l</code></p>
<p>&#x2F;&#x2F; 打印某个 I2C Adapter 的 Functionalities, I2CBUS 为 0、1、2 等整数 i2cdetect -F I2CBUS</p>
<p>&#x2F;&#x2F; 看看有哪些 I2C 设备, I2CBUS 为 0、1、2 等整数</p>
<p><code>i2cdetect -y -a I2CBUS</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/24.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/25.png" alt="img"></p>
<h3><span id="2-4-2-i2cget-i2c-du-smbus-xie-yi">2.4.2 i2cget:  I2C 读（SMBus协议）</span><a href="#2-4-2-i2cget-i2c-du-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/26.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/27.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/28.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/29.png" alt="img"></p>
<h3><span id="2-4-3-i2cset-i2c-xie-smbus-xie-yi">2.4.3 i2cset: I2C 写（SMBus协议）</span><a href="#2-4-3-i2cset-i2c-xie-smbus-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/30.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/31.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/32.png" alt="img"></p>
<h3><span id="2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi">2.4.4 i2ctransfer：I2C传输（I2C协议）</span><a href="#2-4-4-i2ctransfer-i2c-chuan-shu-i2c-xie-yi" class="header-anchor">#</a></h3><p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/33.png" alt="img"></p>
<p>使用示例：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/34.png" alt="img"></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/35.png" alt="img"></p>
<p>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x4。<br>从i2c总线0，往0x1e设备地址，写2个字节，第一个字节写入寄存器地址0，第二个字节表示往寄存器0地址写入0x3。<br>从i2c总线0，往0x1e设备地址，写1个字节，写入寄存器地址0xc表示要读0xc里面的值，再从0xc读2个字节。</p>
<h2><span id="2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi">2.5 I2C-Tools 访问 I2C 设备的方式</span><a href="#2-5-i2c-tools-fang-wen-i2c-she-bei-de-fang-shi" class="header-anchor">#</a></h2><p>I2C-Tools 可以通过 <strong>SMBus</strong> 来访问 I2C 设备，也可以使用一般的 <strong>I2C 协议</strong> 来访问 I2C 设备。 使用一句话概括 I2C 传输：APP 通过 I2C Controller 与 I2C Device 传 输数据.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Open(<span class="string">&quot;dev/i2c-0&quot;</span>);</span><br><span class="line">ioctl(file, I2C_SLAVE, address);</span><br></pre></td></tr></table></figure>

<p>如果该设备已经有了对应的设备驱动程序，则返回失败。</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(file, I2C_SLAVE_FORCE, address);</span><br></pre></td></tr></table></figure>

<p> 如果该设备已经有了对应的设备驱动程序但是还是想通过 i2c-dev 驱 动来访问它，则使用这个 ioctl 来指定 I2C 设备地址。</p>
<h3><span id="2-5-1-shu-ju-chuan-shu-fang-shi">2.5.1 数据传输方式</span><a href="#2-5-1-shu-ju-chuan-shu-fang-shi" class="header-anchor">#</a></h3><h4><span id="2-5-1-1-shi-yong-i2c-fang-shi">2.5.1.1 使用I2C方式</span><a href="#2-5-1-1-shi-yong-i2c-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_RDWR, &amp;rdwr)；(使用I2C方式)</code></p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/36.png" alt="img"></p>
<p>该结构体表示一个或者多个i2c_msg。</p>
<p>示例代码：i2ctransfer.c</p>
<p>以<code>i2ctransfer -f -y 0 w1@0x1e 0xe r2</code>为例：</p>
<p>流程如下：</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/37.png" alt="img"></p>
<p>构造i2c_rdwr_ioctl_data结构，要用2个i2c_msg结构，第一个表示写入0xe寄存器地址给设备，第二个表示要从0xe寄存器读出2个字节。</p>
<h4><span id="2-5-1-2-shi-yong-smbus-fang-shi">2.5.1.2 使用SMBus方式</span><a href="#2-5-1-2-shi-yong-smbus-fang-shi" class="header-anchor">#</a></h4><p><code>ioctl(file, I2C_SMBUS, &amp;args) ；（使用SMBus方式）</code></p>
<p>示例代码：i2cget.c i2cset.c</p>
<p><img src="/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/38.png" alt="img"></p>
<h4><span id="2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi">2.5.1.3 直接使用read()&#x2F;write()方式</span><a href="#2-5-1-3-zhi-jie-shi-yong-read-x2f-write-fang-shi" class="header-anchor">#</a></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">gc2053_read_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr)</span> &#123;</span><br><span class="line">        <span class="type">int</span> ret, data;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">2</span>)</span><br><span class="line">                buf[idx++] = (addr &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add address byte 0</span></span><br><span class="line">        buf[idx++] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buf[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        buf[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_READ error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// pack read back data</span></span><br><span class="line">        data = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">2</span>) &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">                data += buf[<span class="number">1</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                data = buf[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        syslog(LOG_DEBUG, <span class="string">&quot;i2c r 0x%x = 0x%x\n&quot;</span>, addr, data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">gc2053_write_register</span><span class="params">(VI_PIPE ViPipe, <span class="type">int</span> addr, <span class="type">int</span> data)</span> &#123;</span><br><span class="line">        CVI_U8 idx = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        CVI_U8 buf[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (g_fd[ViPipe] &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (gc2053_addr_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = addr &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (gc2053_data_byte == <span class="number">1</span>) &#123;</span><br><span class="line">                buf[idx] = data &amp; <span class="number">0xff</span>;</span><br><span class="line">                idx++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = write(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                CVI_TRACE_SNS(CVI_DBG_ERR, <span class="string">&quot;I2C_WRITE error!\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> CVI_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ret = read(g_fd[ViPipe], buf, gc2053_addr_byte + gc2053_data_byte);</span><br><span class="line">        <span class="comment">//syslog(LOG_DEBUG, &quot;i2c w 0x%x 0x%x\n&quot;, addr, data);</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> CVI_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/26/I2c-SMBus%E5%8D%8F%E8%AE%AE%E5%92%8CI2C-Tools/" data-id="cm0xxogdn0001qsufaf44enag" data-title="I2C-SMBus协议和I2C Tool" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-字符编码与freetype移植" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/" class="article-date">
  <time class="dt-published" datetime="2024-05-25T11:07:24.000Z" itemprop="datePublished">2024-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/">字符编码与freetype移植</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-zi-fu-bian-ma">1 字符编码</a><ul>
<li><a href="#1-1-ascii-bian-ma">1.1 ASCII编码</a></li>
<li><a href="#1-2-ansi">1.2 ANSI</a></li>
<li><a href="#1-3-unicode">1.3 UNICODE</a><ul>
<li><a href="#1-3-1-utf-16-le">1.3.1 UTF-16 LE</a></li>
<li><a href="#1-3-2-utf-16-be">1.3.2 UTF-16 BE</a></li>
</ul>
</li>
<li><a href="#1-4-utf8">1.4 UTF8</a></li>
</ul>
</li>
<li><a href="#2-zhong-wen-zi-ku-yi-zhi">2 中文字库移植</a><ul>
<li><a href="#2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang">2.1 -finput-charset -fexec-charset编译选项</a></li>
<li><a href="#2-2-gb2312-zhuan-wei-utf-8">2.2 GB2312 转为 UTF-8</a></li>
<li><a href="#2-3-utf-8-zhuan-wei-gb2312">2.3 UTF-8 转为 GB2312</a></li>
<li><a href="#2-4-hzk16-zhong-wen-zi-ku">2.4 HZK16中文字库</a></li>
</ul>
</li>
<li><a href="#3-freetype-yi-zhi">3 freetype移植</a><ul>
<li><a href="#3-1-shi-liang-zi-ti">3.1 矢量字体</a></li>
<li><a href="#3-2-xia-zai-freetype">3.2 下载freetype</a></li>
<li><a href="#3-3-bian-yi-freetype">3.3 编译freetype</a><ul>
<li><a href="#3-3-1-she-zhi-gong-ju-lian">3.3.1 设置工具链</a></li>
<li><a href="#3-3-2-bian-yi-zlib">3.3.2 编译zlib</a></li>
<li><a href="#3-3-3-bian-yi-libpng">3.3.3 编译libpng</a></li>
<li><a href="#3-3-4-bian-yi-freetype">3.3.4 编译freetype</a></li>
</ul>
</li>
<li><a href="#3-4-ce-shi">3.4 测试</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-zi-fu-bian-ma">1 字符编码</span><a href="#1-zi-fu-bian-ma" class="header-anchor">#</a></h1><h2><span id="1-1-ascii-bian-ma">1.1 ASCII编码</span><a href="#1-1-ascii-bian-ma" class="header-anchor">#</a></h2><p>ascii是“American Standard Code for Information Interchange”的缩写， 美国信息交换标准代码。</p>
<p>电脑毕竟是西方人发明的，他们常用字母就 26 个，区分大小写、加上标点符号也没超过 127 个，每个字符用一个字节来表示就足够了。一个字节的 7 位就可以表示 128 个数值，在 ASCII 码中最高位永远是 0。</p>
<p>linux-4.18.16&#x2F;lib&#x2F;fonts这个目录下就有对应文件。在这里我挑选font_8x16.c</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/1.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/2.png" alt="img"></p>
<h2><span id="1-2-ansi">1.2 ANSI</span><a href="#1-2-ansi" class="header-anchor">#</a></h2><p>ASNI 是 ASCII 的扩展，向下包含 ASCII。对于 ASCII 字符仍以一个字节来表示。</p>
<p>对于非 ASCII 字符则使用 2 字节来表示。并没有固定的 ASNI 编码。</p>
<p>比如在中国大陆地区， ANSI 的默认编码是 GB2312；</p>
<p>在港澳台地区默认编码是 BIG5。以数值“ 0xd0d6”为例，对于 GB2312 编码它表示“中”；对于 BIG5 编码它表示“ 笢”。</p>
<p>用ANSI编码字符’aa中’的16进制数据</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/3.png" alt="img"></p>
<h2><span id="1-3-unicode">1.3 UNICODE</span><a href="#1-3-unicode" class="header-anchor">#</a></h2><p>在 ANSI 标准中，很多种文字都有自己的编码标准，汉字简体字有 GB2312、繁体字有 BIG5，这难免同一个数值对应不同字符。比如数值“ 0xd0d6”，对于GB2312 编码它表示“中”；对于 BIG5 编码它表示“ 笢”。这造成了使用 ANSI 编码保存的文件，不适合跨地区交流。</p>
<p>UNICODE 编码就是解决这类问题：对于地球上任意一个字符，都给它一个唯一的数值。</p>
<ol>
<li>ASCII 编码中使用一个字节来表示一个字符，只用到其中的 7 位，最高位恒为 0；</li>
<li>ANSI 编码中，对于 ASCII 字符仍使用一个字节来表示(BIT7 是 0)，对于非ASCII 字符一般使用 2 个字节来表示，非 ASCII 字符的数值 BIT7 都是 1</li>
</ol>
<h3><span id="1-3-1-utf-16-le">1.3.1 UTF-16 LE</span><a href="#1-3-1-utf-16-le" class="header-anchor">#</a></h3><p>每个 UNICODE 值用 3 字节来表示有点浪费，那只用 2 字节呢？它可以表示2^16&#x3D;65536 个字符，全世界常用的字符都可以表示了。Little endian 表示小字节序，数值中权重低的字节放在前面，比如字符“ A 中”在 TXT 文件中的数值如下，其中的“ A”使用“0x41 0x00”两字节表示；“中”使用“ 0x2d 0x4e”两字节表示。文件开头的“ 0xff 0xfe”表示“UTF-16 LE”。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/4.png" alt="img"></p>
<h3><span id="1-3-2-utf-16-be">1.3.2 UTF-16 BE</span><a href="#1-3-2-utf-16-be" class="header-anchor">#</a></h3><p>Big endian 表示大字节序，数值中权重低的字节放在后面，比如字符“ ab中”在 TXT 文件中的数值如下，其中的“ A”使用“ 0x00 0x41”两字节表示；“中”使用“ 0x4e 0x2d”两字节表示。文件开头的“ 0xfe 0xff”表示“UTF-16 BE”。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/5.png" alt="img"></p>
<h2><span id="1-4-utf8">1.4 UTF8</span><a href="#1-4-utf8" class="header-anchor">#</a></h2><p>UTF8 是一种变长的编码方法，有 2 种 UTF8格式的文件：带有头部、不带头部。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/6.png" alt="img"></p>
<p>对于 ASCII 字符用UTF-16有空间浪费、而且文件中有某个字节丢失，这会使得后面所有字符都因为错位而无法显示。UTF8则不会有这样的问题。0x41表示大写字母’A’，只用了一个字节。上图中的 3 个字节“ 0xe4 0xb8 0xad”表示的数值是 0x4e2d，对应“中”的 UNICODE 码.</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/7.png" alt="img"></p>
<p>上图中， 0xe4 的二进制是“ 11100100”，高位有 3 个 1，表示从当前字节起有 3 字节参与表示 UNICODE；<br>0xb8 的二进制是“10111000”，高位有 1 个 1，表示从当前字节起有 1 字节参与表示 UNICODE；<br>0xad 的二进制是“10101101”，高位有 1 个 1，表示从当前字节起有 1 字节参与表示 UNICODE；<br>除去高位的“ 1110”、“ 10”、“ 10”后，剩下的二进制数组合起来得到“ 01001110001101”，它就是 0x4e2d，即“中”的 UNICODE 值。</p>
<p>使用 UTF8 编码时，即使 TXT 文件中丢失了某些数据，也只会影响到当前字符的显示，后面的字符不受影响。</p>
<h1><span id="2-zhong-wen-zi-ku-yi-zhi">2 中文字库移植</span><a href="#2-zhong-wen-zi-ku-yi-zhi" class="header-anchor">#</a></h1><h2><span id="2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang">2.1 -finput-charset -fexec-charset编译选项</span><a href="#2-1-finput-charset-fexec-charset-bian-yi-xuan-xiang" class="header-anchor">#</a></h2><p>我们编写 C 程序时，可以使用 ANSI 编码，或是 UTF-8 编码；在编译程序时，可以使用以下的选项告诉编译器用什么方式编码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-finput-charset=GB2312</span><br><span class="line">-finput-charset=UTF<span class="number">-8</span></span><br></pre></td></tr></table></figure>

<p>如果不指定<code>-finput-charset</code>， GCC 就会默认 C 程序的编码方式为 UTF8。</p>
<ol>
<li><p>用ANSI格式编写编码，vim浏览显示会乱码，用notepad++采用ANSI编码格式浏览。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/8.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/9.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/10.png" alt="img"></p>
<p>由于编译器默认用utf8编码，所以看到最终打印是乱码的。可以看到“中”的ANSI码是d6 d0。</p>
<ol start="2">
<li><p>用utf8编写代码</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/11.png" alt="img"></p>
</li>
</ol>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/12.png" alt="img"></p>
<p>最终打印是OK的。可以看到“中”的utf8码是e4 b8 ad。</p>
<h2><span id="2-2-gb2312-zhuan-wei-utf-8">2.2 GB2312 转为 UTF-8</span><a href="#2-2-gb2312-zhuan-wei-utf-8" class="header-anchor">#</a></h2><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/13.png" alt="img"></p>
<p>从上面的输出信息可以看出来， GB2312 的”0xd6 0xd0”可以转换为 UTF-8的“ 0xe4 0xb8 0xad”。而如果把原本就是 UTF-8 格式的 test_charset_utf8.c当作 GB2312 格式，会引起错误.</p>
<h2><span id="2-3-utf-8-zhuan-wei-gb2312">2.3 UTF-8 转为 GB2312</span><a href="#2-3-utf-8-zhuan-wei-gb2312" class="header-anchor">#</a></h2><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/14.png" alt="img"></p>
<p>从 上 面 的 输 出 信 息 可 以 看 出 来 ， 如 果 把 原 本 就 是 GB2312 格 式 test_charset_ansi.c 当成UTF-8 格式，会引起错误。而 UTF-8 格式的“中”编码值为“ 0xe4 0xb8 0xad”，可以转换为 GB2312 的“0xd6 0xd0”</p>
<h2><span id="2-4-hzk16-zhong-wen-zi-ku">2.4 HZK16中文字库</span><a href="#2-4-hzk16-zhong-wen-zi-ku" class="header-anchor">#</a></h2><p>HZK16字库里的16×16汉字一共需要256个点来显示，也就是说需要32个字节才能达到显示一个普通汉字的目的。符合GB2312标准。</p>
<p>一个GB2312汉字是由两个字节编码的，范围为A1A1~FEFE。A1-A9为符号区，B0到F7为汉字区。每一个区有94个字符。</p>
<p>HZK16 中是以 GB2312 编码值来查找点阵的，以“中”字为例，它的编码值是“ 0xd6 0xd0”，其中的 0xd6 表示“区码”，表示在哪一个区；其中的 0xd0 表示“位码”，表示它是这个区里的哪一个字符。每一个区有 94 个汉字。区位码从 0xa1 而不是从 0 开始，是为了兼容 ASCII码。</p>
<p>要显示“中”字， 它的 GB2312 编码是 d6d0，它是 HZK16 里第“ (0xd6-0xa1)*94+(0xd0-0xa1)”个字符。(0xd6-0xa1)表示是哪个区，(0xd0-0xa1)表示是哪个位。</p>
<p>如何获取和显示汉字”中“?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">fd_hzk16 = open(<span class="string">&quot;HZK16&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="keyword">if</span> (fd_hzk16 &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open HZK16\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(fstat(fd_hzk16, &amp;hzk_stat))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t get fstat\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line">hzkmem = (<span class="type">unsigned</span> <span class="type">char</span> *)mmap(<span class="literal">NULL</span> , hzk_stat.st_size, PROT_READ, MAP_SHARED, fd_hzk16, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (hzkmem == (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t mmap for hzk16\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下载HZK16字库，读取并且mmap字库：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/15.png" alt="img"></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/16.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">该函数在 LCD 的(x,y)位置处显示汉字字符 str， str[0]中保存区码、 str[1]中保存位码。</span><br><span class="line">第 4734 行确定该汉字属于哪个区；第 4735 行确实它是该区中哪一个汉字。</span><br><span class="line">第 4736 行确实它的字库地址（第多少个字节）：每个区中有 94 个汉字，每个汉字在字库中占据 32 字节。</span><br></pre></td></tr></table></figure>

<p>根据下图来理解字库中每个像素点是如何显示的:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/17.png" alt="img"></p>
<p>总共有十六行，因此需要一个循环 16次的大循环(第 4740 行)。</p>
<p>考虑到一行有两个字节， 在大循环中加入一个 2 次的循环用于区分是哪个字节(第 4741 行)。</p>
<p>最后使用第 3 个循环来处理一个字节中的 8 位(第 4744 行)。对于每一位，它等于 1 时对应的像素被设置为白色，它等于 0 时对应的像素被设置为黑色。需要注意的是根据 x、 y、 i、 j、 b 来计算像素坐标。</p>
<p>测试：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/18.png" alt="img"></p>
<p>注意：使用上述命令时 show_chinese.c 的编码格式必须是 ANSI(GB2312)，因为HZK16字库是按照GB2312编码的，否则编译时需要指定“ -fexec-charset&#x3D;GB2312”。</p>
<h1><span id="3-freetype-yi-zhi">3 freetype移植</span><a href="#3-freetype-yi-zhi" class="header-anchor">#</a></h1><p>FreeType库是一个完全免费（开源）的、高质量的且可移植的字体引擎。Freetype 是开源的字体引擎库， 它提供统一的接口来访问多种字体格式文件，从而实现矢量字体显示。我们只需要移植这个字体引擎，调用对应的 API 接口，提供字体文件，就可以让 freetype 库帮我们取出关键点、实现闭合曲线， 填充颜色， 达到显示矢量字体的目的。</p>
<p>这里仅移植freetype库，freetype的使用不做具体展开。可以从 <a target="_blank" rel="noopener" href="https://www.freetype.org/">https://www.freetype.org/</a> 可 以 下 载 到 “ freetype-doc-2.10.2.tar.xz”。</p>
<h2><span id="3-1-shi-liang-zi-ti">3.1 矢量字体</span><a href="#3-1-shi-liang-zi-ti" class="header-anchor">#</a></h2><p>使用点阵字库显示英文字母、汉字时， 大小固定， 如果放大缩小则会模糊甚至有锯齿出现，为了解决这个问题，引用矢量字体。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">第1步 确定关键点，</span><br><span class="line">第2步 使用数学曲线（ 贝塞尔曲线） 连接头键点，</span><br><span class="line">第3步 填充闭合区线内部空间。</span><br></pre></td></tr></table></figure>

<p>什么是关键点？以字母“ A”为例:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/19.png" alt="img"></p>
<p>再用数学曲线(比如贝塞尔曲线)将关键点都连接起来， 得到一系列的封闭的曲线:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/20.png" alt="img"></p>
<p>最后把封闭空间填满颜色，就显示出一个 A 字母:</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/21.png" alt="img"></p>
<p>如果需要放大或者缩小字体，关键点的相对位置是不变的， 只要数学曲线平滑，字体就不会变形。</p>
<h2><span id="3-2-xia-zai-freetype">3.2 下载freetype</span><a href="#3-2-xia-zai-freetype" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://freetype.org/download.html">https://freetype.org/download.html</a></p>
<p><a target="_blank" rel="noopener" href="https://download.savannah.gnu.org/releases/freetype/">https://download.savannah.gnu.org/releases/freetype/</a></p>
<p>freetype 依赖于 libpng， libpng 又依赖于 zlib，所以我们应该：先编译安装 zlib，再编译安装 libpng，最后编译安装 freetype。 但是，有些工具链里有 zlib, 那就不用编译安装 zlib.</p>
<p>下载安装libpng: <a target="_blank" rel="noopener" href="https://www.linuxfromscratch.org/blfs/view/svn/general/libpng.html">https://www.linuxfromscratch.org/blfs/view/svn/general/libpng.html</a></p>
<p>下载安装zlib: <a target="_blank" rel="noopener" href="https://www.zlib.net/fossils/">https://www.zlib.net/fossils/</a></p>
<h2><span id="3-3-bian-yi-freetype">3.3 编译freetype</span><a href="#3-3-bian-yi-freetype" class="header-anchor">#</a></h2><h3><span id="3-3-1-she-zhi-gong-ju-lian">3.3.1 设置工具链</span><a href="#3-3-1-she-zhi-gong-ju-lian" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> ARCH=arm</span><br><span class="line"><span class="built_in">export</span> CROSS_COMPILE=arm-buildroot-linux-gnueabihf-</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;main()&#123;&#125;&#x27;</span>| arm-buildroot-linux-gnueabihf-gcc -E -v -</span><br></pre></td></tr></table></figure>

<p>得到头文件的系统目录为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include</span><br><span class="line"></span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include-fixed</span><br><span class="line"> </span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/include</span><br><span class="line"></span><br><span class="line">/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/include</span><br></pre></td></tr></table></figure>

<p>库文件系统目录为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">COMPILER_PATH=/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../libexec/gcc/arm-buildroot-linux-gnueabihf/7.5.0/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../libexec/gcc/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/bin/</span><br><span class="line"></span><br><span class="line">LIBRARY_PATH=/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/lib/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/lib/:/media/cvitek/robin.lee/my_test/study/weidongshan/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib/</span><br></pre></td></tr></table></figure>

<h3><span id="3-3-2-bian-yi-zlib">3.3.2 编译zlib</span><a href="#3-3-2-bian-yi-zlib" class="header-anchor">#</a></h3><p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/22.png" alt="img"></p>
<p>编译zlib库时，.&#x2F;configure不允许传入–host参数；不支持的话需要export CC设置为你的arm工具链</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CC=arm-buildroot-linux-gnueabihf-gcc</span><br><span class="line">./configure --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">make;make install</span><br><span class="line"><span class="built_in">cd</span> tmp/lib;<span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p>将lib和头文件拷贝到工具链目录(或者不拷贝，到时候编译用-L, -I指定即可，运行时指定LIBRARY_PATH)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp include<span class="comment">/* -rf /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/include</span></span><br><span class="line"><span class="comment">cp lib/* -rfd /home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/bin/../lib/gcc/arm-buildroot-linux-gnueabihf/7.5.0/../../../../arm-buildroot-linux-gnueabihf/lib</span></span><br></pre></td></tr></table></figure>

<h3><span id="3-3-3-bian-yi-libpng">3.3.3 编译libpng</span><a href="#3-3-3-bian-yi-libpng" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure --host= arm-buildroot-linux-gnueabihf --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">cd</span> tmp/lib;<span class="built_in">ls</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/23.png" alt="img"></p>
<p>将lib和头文件拷贝到工具链目录。</p>
<h3><span id="3-3-4-bian-yi-freetype">3.3.4 编译freetype</span><a href="#3-3-4-bian-yi-freetype" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --host= arm-buildroot-linux-gnueabihf --prefix=<span class="variable">$PWD</span>/tmp</span><br><span class="line">Make</span><br><span class="line">Make  install</span><br></pre></td></tr></table></figure>

<p>注意：如果你的工具链路径不是 <code>/home/book/100ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot</code>，那么make时会出现类似如下错误。</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/24.png" alt="img"></p>
<p>修改自己工具链下的$(TOOLCHAIN)&#x2F;arm-buildroot-linux-gnueabihf&#x2F;sysroot&#x2F;usr&#x2F;lib目录下编辑libfreetype.la, 替换dependency_libs和libdir的路径。来自 &lt; <a target="_blank" rel="noopener" href="http://bbs.100ask.net/question/15908%3E">http://bbs.100ask.net/question/15908&gt;</a></p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/25.png" alt="img"></p>
<p>libfreetype库如下：</p>
<p><img src="/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/26.png" alt="img"></p>
<p>将lib和头文件拷贝到工具链目录。</p>
<h2><span id="3-4-ce-shi">3.4 测试</span><a href="#3-4-ce-shi" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc freetype_show_font.c -I /media/cvitek/robin.lee/my_test/study/weidongshan/<span class="number">100</span>ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/include/freetype2/ -L /media/cvitek/robin.lee/my_test/study/weidongshan/<span class="number">100</span>ask_imx6ull-sdk/ToolChain/arm-buildroot-linux-gnueabihf_sdk-buildroot/arm-buildroot-linux-gnueabihf/sysroot/usr/lib -lfreetype</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/fb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ft2build.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> FT_FREETYPE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> FT_GLYPH_H</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd_fb;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fb_var_screeninfo</span> <span class="title">var</span>;</span>        <span class="comment">/* Current var */</span></span><br><span class="line"><span class="type">int</span> screen_size;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">char</span> *fbmem;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> line_width;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> pixel_width;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称： lcd_put_pixel</span></span><br><span class="line"><span class="comment"> * 功能描述： 在LCD指定位置上输出指定颜色（描点）</span></span><br><span class="line"><span class="comment"> * 输入参数： x坐标，y坐标，颜色</span></span><br><span class="line"><span class="comment"> * 输出参数： 无</span></span><br><span class="line"><span class="comment"> * 返 回 值： 会</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">lcd_put_pixel</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">unsigned</span> <span class="type">int</span> color)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *pen_8 = fbmem+y*line_width+x*pixel_width;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> *pen_16;        </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> *pen_32;        </span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> red, green, blue;        </span><br><span class="line"></span><br><span class="line">    pen_16 = (<span class="type">unsigned</span> <span class="type">short</span> *)pen_8;</span><br><span class="line">    pen_32 = (<span class="type">unsigned</span> <span class="type">int</span> *)pen_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (var.bits_per_pixel) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>: &#123;</span><br><span class="line">            *pen_8 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>: &#123;</span><br><span class="line">            <span class="comment">/* 565 */</span></span><br><span class="line">            red   = (color &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            green = (color &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            blue  = (color &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">            color = ((red &gt;&gt; <span class="number">3</span>) &lt;&lt; <span class="number">11</span>) | ((green &gt;&gt; <span class="number">2</span>) &lt;&lt; <span class="number">5</span>) | (blue &gt;&gt; <span class="number">3</span>);</span><br><span class="line">            *pen_16 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32</span>: &#123;</span><br><span class="line">            *pen_32 = color;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t surport %dbpp\n&quot;</span>, var.bits_per_pixel);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**********************************************************************</span></span><br><span class="line"><span class="comment"> * 函数名称： draw_bitmap</span></span><br><span class="line"><span class="comment"> * 功能描述： 根据bitmap位图，在LCD指定位置显示汉字</span></span><br><span class="line"><span class="comment"> * 输入参数： x坐标，y坐标，位图指针</span></span><br><span class="line"><span class="comment"> * 输出参数： 无</span></span><br><span class="line"><span class="comment"> * 返 回 值： 无</span></span><br><span class="line"><span class="comment"> ***********************************************************************/</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">draw_bitmap</span><span class="params">( FT_Bitmap* bitmap, FT_Int x, FT_Int y)</span> &#123;</span><br><span class="line">    FT_Int  i, j, p, q;</span><br><span class="line">    FT_Int  x_max = x + bitmap-&gt;width;</span><br><span class="line">    FT_Int  y_max = y + bitmap-&gt;rows;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf(&quot;x = %d, y = %d\n&quot;, x, y);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (j = y, q = <span class="number">0</span>; j &lt; y_max; j++, q++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = x, p = <span class="number">0</span>; i &lt; x_max; i++, p++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; <span class="number">0</span> || j &lt; <span class="number">0</span> || i &gt;= var.xres || j &gt;= var.yres)</span><br><span class="line">            	<span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    		<span class="comment">//image[j][i] |= bitmap-&gt;buffer[q * bitmap-&gt;width + p];</span></span><br><span class="line">    		lcd_put_pixel(i, j, bitmap-&gt;buffer[q * bitmap-&gt;width + p]);</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">wchar_t</span> *chinese_str = <span class="string">L&quot;繁&quot;</span>;</span><br><span class="line">    FT_Library          library;</span><br><span class="line">    FT_Face           face;</span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line">    FT_Vector     pen;</span><br><span class="line">    FT_GlyphSlot  slot;</span><br><span class="line">    <span class="type">int</span> font_size = <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage : %s &lt;font_file&gt; [font_size]\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span>)</span><br><span class="line">        font_size = strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">    fd_fb = open(<span class="string">&quot;/dev/fb0&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd_fb &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t open /dev/fb0\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ioctl(fd_fb, FBIOGET_VSCREENINFO, &amp;var)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t get var\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    line_width  = var.xres * var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    pixel_width = var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    screen_size = var.xres * var.yres * var.bits_per_pixel / <span class="number">8</span>;</span><br><span class="line">    fbmem = (<span class="type">unsigned</span> <span class="type">char</span> *)mmap(<span class="literal">NULL</span> , screen_size, PROT_READ | PROT_WRITE, MAP_SHARED, fd_fb, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (fbmem == (<span class="type">unsigned</span> <span class="type">char</span> *)<span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t mmap\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 清屏: 全部设为黑色 */</span></span><br><span class="line">    <span class="built_in">memset</span>(fbmem, <span class="number">0</span>, screen_size);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 显示矢量字体 */</span></span><br><span class="line">    error = FT_Init_FreeType( &amp;library );                           <span class="comment">/* initialize library */</span></span><br><span class="line">    <span class="comment">/* error handling omitted */</span></span><br><span class="line">    </span><br><span class="line">    error = FT_New_Face( library, argv[<span class="number">1</span>], <span class="number">0</span>, &amp;face ); <span class="comment">/* create face object */</span></span><br><span class="line">    <span class="comment">/* error handling omitted */</span>        </span><br><span class="line">    slot = face-&gt;glyph;</span><br><span class="line"></span><br><span class="line">    FT_Set_Pixel_Sizes(face, font_size, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 确定座标:</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//pen.x = 0;</span></span><br><span class="line">    <span class="comment">//pen.y = 0;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* set transformation */</span></span><br><span class="line">    <span class="comment">//FT_Set_Transform( face, 0, &amp;pen);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* load glyph image into the slot (erase previous one) */</span></span><br><span class="line">    error = FT_Load_Char( face, chinese_str[<span class="number">0</span>], FT_LOAD_RENDER );</span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FT_Load_Char error\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    draw_bitmap( &amp;slot-&gt;bitmap,</span><br><span class="line">                 var.xres/<span class="number">2</span>,</span><br><span class="line">                 var.yres/<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/25/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81%E4%B8%8Efreetype%E7%A7%BB%E6%A4%8D/" data-id="cm0xxoge50034qsuf7jw2exbx" data-title="字符编码与freetype移植" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ini-parse配置解析功能移植" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/" class="article-date">
  <time class="dt-published" datetime="2024-05-25T08:08:09.000Z" itemprop="datePublished">2024-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/">ini_parse配置解析功能移植</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <div class="toc">

<!-- toc -->

<ul>
<li><a href="#1-ini-parse-yi-zhi">1 ini_parse移植</a><ul>
<li><a href="#1-1-xia-zai-ini-jie-xi-yuan-ma">1.1 下载ini解析源码</a></li>
<li><a href="#1-2-shi-yong-ini-parse-gong-neng">1.2 使用ini_parse功能</a><ul>
<li><a href="#1-2-1-zi-ding-yi-ini-wen-jian">1.2.1 自定义ini文件</a></li>
<li><a href="#1-2-2-zhi-chi-yu-fa-jian-ce">1.2.2 支持语法检测</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-minini-yi-zhi-shi-yong">2 minIni移植使用</a><ul>
<li><a href="#2-1-xia-zai-minini">2.1 下载minIni</a></li>
<li><a href="#2-2-te-zheng">2.2 特征</a></li>
<li><a href="#2-3-ini-wen-jian-yu-fa">2.3 INI 文件语法</a></li>
<li><a href="#2-4-minini-zhi-chi-wen-jian-xi-tong">2.4 minIni支持文件系统</a></li>
<li><a href="#2-5-minini-de-api-jie-shao">2.5 minIni的API介绍</a><ul>
<li><a href="#2-5-1-ini-gets">2.5.1 ini_gets()</a><ul>
<li><a href="#2-5-1-1-getkeystring">2.5.1.1 getkeystring</a></li>
</ul>
</li>
<li><a href="#2-5-2-ini-getl">2.5.2 ini_getl()</a></li>
<li><a href="#2-5-3-ini-puts">2.5.3 ini_puts()</a></li>
<li><a href="#2-5-4-ini-putl">2.5.4 ini_putl()</a></li>
<li><a href="#2-5-5-section-key-enumeration">2.5.5 section&#x2F;key enumeration</a></li>
<li><a href="#2-5-6-section-key-cun-zai-xing-jian-cha">2.5.6 section&#x2F;key存在性检查</a></li>
<li><a href="#2-5-7-pei-zhi-wen-jian-yue-du-da-yin">2.5.7 配置文件阅读打印</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- tocstop -->

</div>

<h1><span id="1-ini-parse-yi-zhi">1 ini_parse移植</span><a href="#1-ini-parse-yi-zhi" class="header-anchor">#</a></h1><h2><span id="1-1-xia-zai-ini-jie-xi-yuan-ma">1.1 下载ini解析源码</span><a href="#1-1-xia-zai-ini-jie-xi-yuan-ma" class="header-anchor">#</a></h2><p>源码的github地址<a target="_blank" rel="noopener" href="https://github.com/benhoyt/inih">https://github.com/benhoyt/ini</a>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/benhoyt/inih.git</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/1.png" alt="img"></p>
<h2><span id="1-2-shi-yong-ini-parse-gong-neng">1.2 使用ini_parse功能</span><a href="#1-2-shi-yong-ini-parse-gong-neng" class="header-anchor">#</a></h2><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/2.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/3.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/4.png" alt="img"></p>
<p>可以看到核心就是一个ini_parse函数。用户自定义一个callback函数去解析自己的配置ini。测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ini.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">SAMPLE_INI_CFG_S</span> &#123;</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> bus_id;</span><br><span class="line">        <span class="type">int</span> age;</span><br><span class="line">        <span class="type">char</span> name2[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> bus_id2;</span><br><span class="line">        <span class="type">int</span> age2;</span><br><span class="line">&#125; SAMPLE_INI_CFG_S;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_handler</span><span class="params">(<span class="type">void</span> *user, <span class="type">const</span> <span class="type">char</span> *section, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *value)</span> &#123;</span><br><span class="line">        SAMPLE_INI_CFG_S *cfg = (SAMPLE_INI_CFG_S *)user;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(section, <span class="string">&quot;person1&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">strcpy</span>(cfg-&gt;name, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;bus_id&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;bus_id = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;age&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;age = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">/* unknown section/name */</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(section, <span class="string">&quot;person2&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;name&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">strcpy</span>(cfg-&gt;name2, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;bus_id&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;bus_id2 = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(name, <span class="string">&quot;age&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                        cfg-&gt;age2 = atoi(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="comment">/* unknown section/name */</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* unknown section/name */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">        SAMPLE_INI_CFG_S ini_cfg;</span><br><span class="line">        <span class="type">int</span> ret = ini_parse(<span class="string">&quot;./sensor_cfg.ini&quot;</span>, parse_handler, &amp;ini_cfg);</span><br><span class="line">        <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Parse err in %d line.\n&quot;</span>, ret);</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Parse incomplete, use default cfg ./sensor_cfg.ini\n&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s, %d, %d\n&quot;</span>, ini_cfg.name, ini_cfg.bus_id, ini_cfg.age);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%s, %d, %d\n&quot;</span>, ini_cfg.name2, ini_cfg.bus_id2, ini_cfg.age2);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="1-2-1-zi-ding-yi-ini-wen-jian">1.2.1 自定义ini文件</span><a href="#1-2-1-zi-ding-yi-ini-wen-jian" class="header-anchor">#</a></h3><p>ini配置文件sensor_cfg.ini如下：</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/5.png" alt="img"></p>
<p><code>gcc test.c ini.c</code>。我的callback定义是<code>parse_handler</code>，从ini中解析section，每个section会调用一次callback，解析出所有的section。</p>
<p>运行代码:</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/6.png" alt="img"></p>
<h3><span id="1-2-2-zhi-chi-yu-fa-jian-ce">1.2.2 支持语法检测</span><a href="#1-2-2-zhi-chi-yu-fa-jian-ce" class="header-anchor">#</a></h3><p>ini_parse还支持语法检测。但ini写的不和语法规范会报错。手工制造ini语法错误，测试结果如下：</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/7.png" alt="img"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/8.png" alt="img"></p>
<h1><span id="2-minini-yi-zhi-shi-yong">2 minIni移植使用</span><a href="#2-minini-yi-zhi-shi-yong" class="header-anchor">#</a></h1><p>MiniINI 是一个用来解析 INI&#x2F;CFG 配置文件的 C++ 库，主要特点是可移植性、性能和小体积。支持上千种 INI 格式配置，易用简单。</p>
<h2><span id="2-1-xia-zai-minini">2.1 下载minIni</span><a href="#2-1-xia-zai-minini" class="header-anchor">#</a></h2><p><a target="_blank" rel="noopener" href="https://github.com/compuphase/minIni">GitHub - compuphase&#x2F;minIni: A small and portable INI file library with read&#x2F;write support</a></p>
<h2><span id="2-2-te-zheng">2.2 特征</span><a href="#2-2-te-zheng" class="header-anchor">#</a></h2><ul>
<li>minIni 支持读取senction外部的key，因此它支持不使用section的配置文件（但在其他方面与 INI 文件兼容）。</li>
<li>可以使用冒号分隔键和值;冒号等价于等号。也就是说，字符串“Name： Value”和“Name&#x3D;Value”具有相同的含义。</li>
<li>minIni 不需要标准 C&#x2F;C++ 库中的 文件 I&#x2F;O 函数，且允许通过宏配置要选择文件 I&#x2F;O 接口。</li>
<li>哈希字符 （“#”） 是分号开始注释的替代方法。允许尾随注释（即在一行上的键&#x2F;值对后面）。</li>
<li>key名称和val周围的前导和尾随空格将被忽略。</li>
<li>当写入包含注释字符（“;”或“#”）的值时，该值将自动放在双引号之间;读取值时，将删除这些引号。当设置中出现双引号本身时，这些字符将被转义。</li>
<li>支持section和key枚举。</li>
<li>您可以选择设置 minIni 将使用的行终止符（对于文本文件）。（这是编译时设置，而不是运行时设置)。</li>
<li>由于写入速度远低于闪存（SD&#x2F;MMC 卡、U 盘）中的读取速度，因此 minIni 以双倍“文件读取”为代价将“文件写入”降至最低。</li>
<li>内存占用是确定性的。没有动态内存分配。</li>
</ul>
<h2><span id="2-3-ini-wen-jian-yu-fa">2.3 INI 文件语法</span><a href="#2-3-ini-wen-jian-yu-fa" class="header-anchor">#</a></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[Network]  <span class="comment">#section</span></span><br><span class="line">hostname=My Computer  <span class="comment">#key = val</span></span><br><span class="line">address=dhcp</span><br><span class="line">dns = <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>

<h2><span id="2-4-minini-zhi-chi-wen-jian-xi-tong">2.4 minIni支持文件系统</span><a href="#2-4-minini-zhi-chi-wen-jian-xi-tong" class="header-anchor">#</a></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INI_FILETYPE                  FILE*</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_openread(filename,file)   ((*(file) = fopen((filename),<span class="string">&quot;r&quot;</span>)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_openwrite(filename,file)  ((*(file) = fopen((filename),<span class="string">&quot;w&quot;</span>)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_close(file)               (fclose(*(file)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_read(buffer,size,file)    (fgets((buffer),(size),*(file)) != NULL)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_write(buffer,file)        (fputs((buffer),*(file)) &gt;= 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_rename(source,dest)       (rename((source), (dest)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_remove(filename)          (remove(filename) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INI_FILEPOS                   fpos_t</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_tell(file,pos)            (fgetpos(*(file), (pos)) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ini_seek(file,pos)            (fsetpos(*(file), (pos)) == 0)</span></span><br></pre></td></tr></table></figure>

<h2><span id="2-5-minini-de-api-jie-shao">2.5 minIni的API介绍</span><a href="#2-5-minini-de-api-jie-shao" class="header-anchor">#</a></h2><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/9.png" alt="image-20240602144015881"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;minIni.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sizearray(a)  (sizeof(a) / sizeof((a)[0]))</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> inifile[] = <span class="string">&quot;example.ini&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> str[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span> section[<span class="number">50</span>];</span><br><span class="line">    <span class="type">long</span> n;</span><br><span class="line"></span><br><span class="line">    n = ini_gets(<span class="string">&quot;Network&quot;</span>, <span class="string">&quot;address&quot;</span>, <span class="string">&quot;dummy&quot;</span>, str, sizearray(str), inifile);</span><br><span class="line">    <span class="keyword">if</span> (n &gt;= <span class="number">0</span>) <span class="built_in">printf</span>(<span class="string">&quot;Network/address=%s&quot;</span>, str);</span><br><span class="line"></span><br><span class="line">    n = ini_getl(<span class="string">&quot;Network&quot;</span>, <span class="string">&quot;timeout&quot;</span>, <span class="number">-1</span>, inifile);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Network/timeout=%ld\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>example.ini如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Network]</span><br><span class="line">hostname=My Computer</span><br><span class="line">address=dhcp</span><br><span class="line">dns=<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">timeout=<span class="number">10</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Network/address=dhcp</span><br><span class="line">Network/timeout=10</span><br></pre></td></tr></table></figure>

<h3><span id="2-5-1-ini-gets">2.5.1 ini_gets()</span><a href="#2-5-1-ini-gets" class="header-anchor">#</a></h3><p>获取字符串类型的值.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>   <span class="title function_">ini_gets</span><span class="params">(<span class="type">const</span> mTCHAR *Section, <span class="type">const</span> mTCHAR *Key, <span class="type">const</span> mTCHAR *DefValue, mTCHAR *Buffer, <span class="type">int</span> BufferSize, <span class="type">const</span> mTCHAR *Filename)</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">参数 1 是 Section;</span></span><br><span class="line"><span class="comment">参数 2 是 Key;</span></span><br><span class="line"><span class="comment">参数 3 是获取不到值时的默认值;</span></span><br><span class="line"><span class="comment">参数 4 是用于保存目标键值的 Buffer;</span></span><br><span class="line"><span class="comment">参数 5 是 Buffer 的长度;</span></span><br><span class="line"><span class="comment">参数 6 是 INI 文件的路径;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/10.png" alt="image-20240602144722018"></p>
<p>先打开文件，然后用 <code>getkeystring() </code>找到目标键值，最后拷贝给调用者。</p>
<h4><span id="2-5-1-1-getkeystring">2.5.1.1 getkeystring</span><a href="#2-5-1-1-getkeystring" class="header-anchor">#</a></h4><p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/11.png" alt="image-20240602150058567"></p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/12.png" alt="image-20240602145619533"></p>
<ol>
<li>用 fgets 进行逐行读取，用 strrchr 找到包含 ‘[‘ 和 ‘]’ 的行，然后再用 strncasecmp 找到目标 Section 所在的行。</li>
<li>继续用 fgets 进行逐行读取，用 strrchr 找到包含 ‘&#x3D;’ 的行，然后再用 strncasecmp 找到目标 Key 所在的行。</li>
<li>用 strncpy 将目标 Key 的值拷贝给调用者。</li>
</ol>
<p>大致就是这3个关键步骤，当然还有很多其他异常处理，语法检测和边界判断的逻辑，这里不做展示。</p>
<h3><span id="2-5-2-ini-getl">2.5.2 ini_getl()</span><a href="#2-5-2-ini-getl" class="header-anchor">#</a></h3><p><code>ini_getl() </code>用于获取整型类型的值，也是间接调用<code>int_gets</code>， 最后将字符串转换成数字。</p>
<h3><span id="2-5-3-ini-puts">2.5.3 ini_puts()</span><a href="#2-5-3-ini-puts" class="header-anchor">#</a></h3><p>写出参数到ini,保存到ini。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** ini_puts()</span></span><br><span class="line"><span class="comment"> * \param Section     the name of the section to write the string in</span></span><br><span class="line"><span class="comment"> * \param Key         the name of the entry to write, or NULL to erase all keys in the section</span></span><br><span class="line"><span class="comment"> * \param Value       a pointer to the buffer the string, or NULL to erase the key</span></span><br><span class="line"><span class="comment"> * \param Filename    the name and full path of the .ini file to write to</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * \return            1 if successful, otherwise 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ini_puts</span><span class="params">(<span class="type">const</span> TCHAR *Section, <span class="type">const</span> TCHAR *Key, <span class="type">const</span> TCHAR *Value, <span class="type">const</span> TCHAR *Filename)</span></span><br><span class="line"><span class="comment">//eg:</span></span><br><span class="line"><span class="title function_">ini_putl</span><span class="params">(<span class="string">&quot;second&quot;</span>, <span class="string">&quot;age&quot;</span>, <span class="number">20</span>, inifile)</span>;</span><br><span class="line">n = ini_puts(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;alt&quot;</span>, <span class="literal">NULL</span>, inifile);<span class="comment">//当val等于NULL表示删除该key</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-5-4-ini-putl">2.5.4 ini_putl()</span><a href="#2-5-4-ini-putl" class="header-anchor">#</a></h3><p><code>ini_putl() </code>用于写出整型类型的值，也是间接调用<code>int_puts</code>， 将数字转换成字符串,然后保存字符串到ini。</p>
<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/13.png" alt="image-20240602171648913"></p>
<h3><span id="2-5-5-section-x2f-key-enumeration">2.5.5 section&#x2F;key enumeration</span><a href="#2-5-5-section-x2f-key-enumeration" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;4. Section/key enumeration, file structure follows\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (s = <span class="number">0</span>; ini_getsection(s, section, sizearray(section), inifile) &gt; <span class="number">0</span>; s++) &#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;    [%s]\n&quot;</span>, section);</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; ini_getkey(section, k, str, sizearray(str), inifile) &gt; <span class="number">0</span>; k++) &#123;</span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;\t%s\n&quot;</span>, str);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;<span class="comment">//对section和key进行枚举</span></span><br></pre></td></tr></table></figure>

<h3><span id="2-5-6-section-x2f-key-cun-zai-xing-jian-cha">2.5.6 section&#x2F;key存在性检查</span><a href="#2-5-6-section-x2f-key-cun-zai-xing-jian-cha" class="header-anchor">#</a></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* section/key presence check */</span></span><br><span class="line">assert(ini_hassection(<span class="string">&quot;first&quot;</span>, inifile));<span class="comment">//检查是否有first 段</span></span><br><span class="line">assert(!ini_hassection(<span class="string">&quot;fourth&quot;</span>, inifile));</span><br><span class="line">assert(ini_haskey(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;val&quot;</span>, inifile));<span class="comment">//检查first段是否有val这个key</span></span><br><span class="line">assert(!ini_haskey(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;test&quot;</span>, inifile));</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;5. checking presence of sections and keys passed\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3><span id="2-5-7-pei-zhi-wen-jian-yue-du-da-yin">2.5.7 配置文件阅读打印</span><a href="#2-5-7-pei-zhi-wen-jian-yue-du-da-yin" class="header-anchor">#</a></h3><p><code>ini_browse</code>用来打印出每个段的每个key的内容。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">Callback</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *section, <span class="type">const</span> <span class="type">char</span> *key, <span class="type">const</span> <span class="type">char</span> *value, <span class="type">void</span> *userdata)</span> &#123;</span><br><span class="line">	(<span class="type">void</span>)userdata; <span class="comment">/* this parameter is not used in this example */</span></span><br><span class="line">  	<span class="built_in">printf</span>(<span class="string">&quot;    [%s]\t%s=%s\n&quot;</span>, section, key, value);</span><br><span class="line">  	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* browsing through the file */</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;6. browse through all settings, file field list follows\n&quot;</span>);</span><br><span class="line">ini_browse(Callback, <span class="literal">NULL</span>, inifile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (access(filename, F_OK) != <span class="number">0</span>) &#123;</span><br><span class="line">	perror(<span class="string">&quot;open %s fail&quot;</span>, filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/14.png" alt="image-20240602173647362"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/05/25/ini-parse%E9%85%8D%E7%BD%AE%E8%A7%A3%E6%9E%90%E5%8A%9F%E8%83%BD%E7%A7%BB%E6%A4%8D/" data-id="cm0xxogdy0019qsuf6fxeftrb" data-title="ini_parse配置解析功能移植" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/7/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag">Linux设备驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Makefile/" rel="tag">Makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E6%B1%87%E7%BC%96/" rel="tag">arm汇编</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arm%E8%A3%B8%E6%9C%BA/" rel="tag">arm裸机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/boot%E5%90%AF%E5%8A%A8/" rel="tag">boot启动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ini%E8%A7%A3%E6%9E%90/" rel="tag">ini解析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="tag">linux内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%86%85%E6%A0%B8/" rel="tag">linux内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="tag">linux嵌入式环境搭建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" rel="tag">linux系统构建</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" rel="tag">mipi图像处理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uboot/" rel="tag">uboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" rel="tag">中断体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" rel="tag">字符编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" rel="tag">存储驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" rel="tag">开源插件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" rel="tag">时钟体系</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" rel="tag">裸机外设驱动</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" rel="tag">通信协议</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" style="font-size: 20px;">Linux设备驱动</a> <a href="/tags/Makefile/" style="font-size: 10px;">Makefile</a> <a href="/tags/arm%E6%B1%87%E7%BC%96/" style="font-size: 10px;">arm汇编</a> <a href="/tags/arm%E8%A3%B8%E6%9C%BA/" style="font-size: 18.18px;">arm裸机</a> <a href="/tags/boot%E5%90%AF%E5%8A%A8/" style="font-size: 16.36px;">boot启动</a> <a href="/tags/ini%E8%A7%A3%E6%9E%90/" style="font-size: 10px;">ini解析</a> <a href="/tags/linux%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" style="font-size: 10px;">linux内存管理</a> <a href="/tags/linux%E5%86%85%E6%A0%B8/" style="font-size: 15.45px;">linux内核</a> <a href="/tags/linux%E5%B5%8C%E5%85%A5%E5%BC%8F%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 17.27px;">linux嵌入式环境搭建</a> <a href="/tags/linux%E7%B3%BB%E7%BB%9F%E6%9E%84%E5%BB%BA/" style="font-size: 19.09px;">linux系统构建</a> <a href="/tags/mipi%E5%9B%BE%E5%83%8F%E5%A4%84%E7%90%86/" style="font-size: 11.82px;">mipi图像处理</a> <a href="/tags/uboot/" style="font-size: 14.55px;">uboot</a> <a href="/tags/%E4%B8%AD%E6%96%AD%E4%BD%93%E7%B3%BB/" style="font-size: 15.45px;">中断体系</a> <a href="/tags/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/" style="font-size: 10px;">字符编码</a> <a href="/tags/%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8/" style="font-size: 10.91px;">存储驱动</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%8F%92%E4%BB%B6/" style="font-size: 12.73px;">开源插件</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.64px;">数据结构</a> <a href="/tags/%E6%97%B6%E9%92%9F%E4%BD%93%E7%B3%BB/" style="font-size: 10px;">时钟体系</a> <a href="/tags/%E8%A3%B8%E6%9C%BA%E5%A4%96%E8%AE%BE%E9%A9%B1%E5%8A%A8/" style="font-size: 16.36px;">裸机外设驱动</a> <a href="/tags/%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE/" style="font-size: 15.45px;">通信协议</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/09/">September 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/08/">August 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/07/">July 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/06/">June 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/05/">May 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/04/">April 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-IIO%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-IIO子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/22/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-regmap%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-regmap子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-UART%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-UART子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/16/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-RTC%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-RTC子系统</a>
          </li>
        
          <li>
            <a href="/2024/09/01/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8-Framebuffer%E5%AD%90%E7%B3%BB%E7%BB%9F/">字符设备驱动-Framebuffer子系统</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>